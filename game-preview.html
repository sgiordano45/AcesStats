<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Preview - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 3rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.header::after {
  content: 'üîÆ';
  position: absolute;
  bottom: -40px;
  left: -40px;
  font-size: 200px;
  opacity: 0.05;
}

.header h1 {
  margin: 0;
  font-size: 3rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.header p {
  margin: 0.75rem 0 0 0;
  font-size: 1.2rem;
  opacity: 0.95;
  position: relative;
  z-index: 1;
}

/* Navigation */
.filters-nav {
  background: var(--card-bg);
  padding: 1.5rem;
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.nav-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  align-items: center;
  justify-content: center;
}

.nav-link {
  padding: 1rem 1.75rem;
  border: 2px solid var(--primary-color);
  background: white;
  color: var(--primary-color);
  text-decoration: none;
  border-radius: 12px;
  font-weight: 600;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  white-space: nowrap;
  position: relative;
  overflow: hidden;
  z-index: 1;
}

.nav-link::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: var(--primary-color);
  transform: translateX(-100%);
  transition: transform 0.3s ease;
  z-index: -1;
}

.nav-link:hover::before {
  transform: translateX(0);
}

.nav-link:hover {
  color: white;
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

/* Container */
.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem;
}

/* Matchup Header */
.matchup-header {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.matchup-header::before {
  content: "";
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.teams-display {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 3rem;
  margin: 1.5rem 0;
}

.team-info {
  text-align: center;
  flex: 1;
  max-width: 300px;
}

.team-logo {
  width: 100px !important;
  height: 100px !important;
  margin: 0 auto 1rem auto !important;
  border-radius: 50% !important;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
  display: block !important;
  border: 3px solid var(--border-color) !important;
  transition: all 0.3s ease !important;
  object-fit: contain !important;
  background: white !important;
}

.team-logo:hover {
  transform: scale(1.1) !important;
  border-color: var(--primary-color) !important;
}

.team-name {
  font-size: 2rem;
  font-weight: 800;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.team-record {
  font-size: 1.2rem;
  color: var(--text-light);
  margin-bottom: 1rem;
  font-weight: 600;
}

.vs-divider {
  font-size: 3rem;
  font-weight: 800;
  color: var(--primary-color);
  text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
}

.game-details {
  background: #f8f9fa;
  padding: 1rem 1.5rem;
  border-radius: 12px;
  margin-top: 1.5rem;
  font-size: 1.05rem;
  color: var(--text-dark);
  border: 1px solid var(--border-color);
}

/* Sections */
.section {
  background: var(--card-bg);
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  border: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

.section:hover {
  box-shadow: var(--shadow-md);
}

.section-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  padding: 1.5rem 2rem;
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-header::before {
  content: "üîÆ";
  font-size: 1.5rem;
}

.peters-preview-header {
  background: linear-gradient(135deg, #d2691e 0%, #ff8c00 100%);
  color: white;
  padding: 1.5rem 2rem;
  font-size: 1.5rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.peters-preview-header::before {
  content: "üéØ";
  font-size: 1.5rem;
}

.section-content {
  padding: 2rem;
}

/* Peters Preview */
.peters-preview-content {
  display: flex;
  gap: 2rem;
  align-items: flex-start;
}

.peters-preview-image {
  width: 150px;
  height: 150px;
  flex-shrink: 0;
  border-radius: 50%;
  overflow: hidden;
  box-shadow: var(--shadow-md);
  border: 4px solid var(--border-color);
}

.peters-preview-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.peters-preview-main {
  flex: 1;
}

.preview-text {
  font-size: 1.1rem;
  line-height: 1.8;
  color: var(--text-dark);
}

/* Odds Display */
.odds-display {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 2rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 12px;
  margin-bottom: 1.5rem;
  border: 1px solid var(--border-color);
}

.odds-item {
  text-align: center;
}

.odds-team {
  font-size: 0.9rem;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 0.5rem;
}

.odds-value {
  font-size: 1.8rem;
  font-weight: 800;
  color: var(--text-dark);
}

.odds-value.favorite {
  color: var(--primary-color);
}

/* Comparison Grids */
.comparison-grid {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 2rem;
  align-items: start;
}

.team-stats {
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid var(--border-color);
}

.team-stats h4 {
  margin: 0 0 1rem 0;
  color: var(--primary-color);
  font-size: 1.2rem;
  font-weight: 700;
  text-align: center;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--primary-color);
}

.stat-row {
  display: flex;
  justify-content: space-between;
  padding: 0.6rem 0;
  border-bottom: 1px solid var(--border-color);
}

.stat-row:last-child {
  border-bottom: none;
}

.stat-label {
  color: var(--text-light);
  font-weight: 500;
}

.stat-value {
  color: var(--text-dark);
  font-weight: 700;
}

.vs-label {
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  font-weight: 800;
  color: var(--primary-color);
  padding: 1rem;
}

/* Head to Head */
.h2h-summary {
  text-align: center;
  padding: 1.5rem;
}

.h2h-record {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text-dark);
}

/* Player Cards */
.player-card {
  background: white;
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  border: 1px solid var(--border-color);
  transition: all 0.2s ease;
}

.player-card:hover {
  box-shadow: var(--shadow-sm);
  transform: translateY(-2px);
}

.player-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.player-name {
  font-weight: 700;
  color: var(--text-dark);
  font-size: 1.1rem;
}

.player-position {
  font-size: 0.85rem;
  color: var(--text-light);
  background: #e9ecef;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
}

.player-stats {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.player-stat {
  text-align: center;
  min-width: 70px;
}

.player-stat-label {
  font-size: 0.75rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.player-stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text-dark);
}

.vs-opponent-stats {
  margin-top: 0.75rem;
  padding-top: 0.75rem;
  border-top: 1px dashed var(--border-color);
  font-size: 0.85rem;
  color: var(--text-light);
}

/* History Table */
.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
}

.history-table th,
.history-table td {
  padding: 0.875rem;
  text-align: left;
  border-bottom: 1px solid var(--border-color);
}

.history-table th {
  background: #f8f9fa;
  font-weight: 700;
  color: var(--text-dark);
}

.history-table tr:hover {
  background: #f8f9fa;
}

.winner-highlight {
  font-weight: 700;
  color: var(--primary-color);
}

/* No Data Message */
.no-data {
  text-align: center;
  padding: 2rem;
  color: var(--text-light);
  font-style: italic;
}

/* Responsive */
@media (max-width: 768px) {
  .header h1 {
    font-size: 2rem;
  }
  
  .container {
    padding: 1rem;
  }
  
  .teams-display {
    flex-direction: column;
    gap: 1.5rem;
  }
  
  .vs-divider {
    font-size: 2rem;
  }
  
  .comparison-grid {
    grid-template-columns: 1fr;
  }
  
  .vs-label {
    padding: 0.5rem;
    font-size: 1.5rem;
  }
  
  .odds-display {
    flex-direction: column;
    gap: 1rem;
  }
  
  .odds-value {
    font-size: 1.5rem;
  }
  
  .peters-preview-content {
    flex-direction: column;
    align-items: center;
  }

  .peters-preview-image {
    width: 100px;
    height: 100px;
  }

  .nav-link {
    width: 100%;
    justify-content: center;
  }

  .history-table {
    font-size: 0.85rem;
  }

  .history-table th,
  .history-table td {
    padding: 0.6rem;
  }

  .player-stats {
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .player-stat {
    min-width: 60px;
  }
}
</style>
</head>
<body>
  <div class="filters-nav">

  </div>



  <header class="header">
    <h1>Game Preview</h1>
    <p id="gameInfo">Loading game details...</p>
  </header>

  <div class="container">
    <!-- Matchup Header -->
    <div class="matchup-header">
      <div class="teams-display">
        <div class="team-info" id="awayTeamInfo">
          <img class="team-logo" id="awayTeamLogo" src="" alt="" onerror="this.style.display='none'">
          <div class="team-name" id="awayTeamName">--</div>
          <div class="team-record" id="awayTeamRecord">--</div>
        </div>
        
        <div class="vs-divider">@</div>
        
        <div class="team-info" id="homeTeamInfo">
          <img class="team-logo" id="homeTeamLogo" src="" alt="" onerror="this.style.display='none'">
          <div class="team-name" id="homeTeamName">--</div>
          <div class="team-record" id="homeTeamRecord">--</div>
        </div>
      </div>
      
      <div class="game-details" id="gameDetails">
        Loading game details...
      </div>
    </div>

    <!-- Peters Preview -->
    <div class="section">
      <div class="peters-preview-header">
        Peters Preview
      </div>
      <div class="section-content">
        <div id="petersPreviewContent">
          Loading Peters Preview...
        </div>
      </div>
    </div>

    <!-- Head to Head Record -->
    <div class="section">
      <div class="section-header">
        Head-to-Head Record
      </div>
      <div class="section-content">
        <div class="h2h-summary" id="h2hSummary">
          Loading head-to-head record...
        </div>
      </div>
    </div>

    <!-- Key Players -->
    <div class="section">
      <div class="section-header">
        Key Players
      </div>
      <div class="section-content">
        <div class="comparison-grid" id="keyPlayersComparison">
          Loading key players...
        </div>
      </div>
    </div>

    <!-- Team Comparison -->
    <div class="section">
      <div class="section-header">
        Season Statistics Comparison
      </div>
      <div class="section-content">
        <h4 style="color: var(--text-dark); font-weight: 700; margin-bottom: 1rem;">Batting Statistics</h4>
        <div class="comparison-grid" id="battingComparison">
          Loading batting comparison...
        </div>
        
        <h4 style="margin-top: 2rem; color: var(--text-dark); font-weight: 700; margin-bottom: 1rem;">Pitching Statistics</h4>
        <div class="comparison-grid" id="pitchingComparison">
          Loading pitching comparison...
        </div>
      </div>
    </div>

    <!-- Historical Matchups -->
    <div class="section">
      <div class="section-header">
        Previous Matchups
      </div>
      <div class="section-content">
        <div id="historyContent">
          Loading matchup history...
        </div>
      </div>
    </div>
  </div>

  <script type="module">
      // ========================================
      // GAME PREVIEW - 2026+ VERSION
      // Preview data now comes from game document, not previews.json
      // ========================================

      import {
        getSeasonPlayerStatsOptimized,
        getSeasonPitchingStatsOptimized,
        getSeasonGames,
        getCurrentSeason,
        getAllSeasons
      } from './firebase-data.js';

      let allGames = [];
      let playerData = [];
      let pitchingData = [];
      
      // 2026+ UPDATE: Store current game's preview data directly (no separate previewData array)
      let currentGamePreview = null;
      
      // Global variables for current game being previewed
      let targetHomeTeam = '';
      let targetAwayTeam = '';
      let targetGameDate = '';

      // Get URL parameters - support both formats
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('gameId');  // For playoff games
      const homeTeam = urlParams.get('home');  // For regular games
      const awayTeam = urlParams.get('away');  // For regular games
      const gameDate = urlParams.get('date');  // For regular games

      // Mobile menu toggle
      function toggleMobileMenu() {
        const menu = document.getElementById('mobileNavMenu');
        menu.classList.toggle('open');
      }
      window.toggleMobileMenu = toggleMobileMenu;

      // Validate we have either gameId OR (homeTeam + awayTeam + gameDate)
      const hasGameId = gameId && gameId.trim() !== '';
      const hasTeamParams = homeTeam && awayTeam && gameDate;
      
      if (!hasGameId && !hasTeamParams) {
        document.body.innerHTML = `
          <div class="container">
            <h1>Error: Missing game information</h1>
            <p>Please provide either a game ID or home/away teams with a date.</p>
            <p><a href="current-season.html">Return to current season</a></p>
          </div>
        `;
      } else {
        loadGamePreviewData();
      }

      async function loadGamePreviewData() {
        const startTime = performance.now();
        console.log('üèüÔ∏è Loading game preview data...');
        
        try {
          // Helper function for capitalizing
          const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";
          
          // Get current season from Firebase
          const currentSeasonData = await getCurrentSeason();
          const seasonId = currentSeasonData.id;
          
          console.log(`üìÖ Game season: ${seasonId}`);
          
          // Determine if we're loading by gameId or by team names
          // (targetHomeTeam, targetAwayTeam, targetGameDate are global variables)
          
          if (hasGameId) {
            console.log('Loading playoff game by ID:', gameId);
            // We'll fetch the specific game by ID from current season
            const currentSeasonGames = await getSeasonGames(seasonId);
            const playoffGame = currentSeasonGames.find(g => g.id === gameId);
            
            if (!playoffGame) {
              throw new Error(`Game with ID ${gameId} not found in current season`);
            }
            
            // Extract team names from the playoff game
            targetHomeTeam = playoffGame.homeTeamName || playoffGame["home team"] || capitalize(playoffGame.homeTeamId);
            targetAwayTeam = playoffGame.awayTeamName || playoffGame["away team"] || capitalize(playoffGame.awayTeamId);
            
            // Convert date if it's a Timestamp
            if (playoffGame.date && typeof playoffGame.date === 'object' && playoffGame.date.toDate) {
              targetGameDate = playoffGame.date.toDate().toLocaleDateString('en-US');
            } else if (playoffGame.date && typeof playoffGame.date === 'object' && playoffGame.date.seconds) {
              targetGameDate = new Date(playoffGame.date.seconds * 1000).toLocaleDateString('en-US');
            } else {
              targetGameDate = playoffGame.date || 'TBD';
            }
            
            // 2026+ UPDATE: Store preview data directly from the game document
            currentGamePreview = {
              homeOdds: playoffGame.homeOdds || null,
              awayOdds: playoffGame.awayOdds || null,
              preview: playoffGame.preview || ''
            };
            
            console.log('Found playoff game:', targetHomeTeam, 'vs', targetAwayTeam, 'on', targetGameDate);
            console.log('Preview data from game:', currentGamePreview);
          } else {
            // Use the URL parameters directly
            targetHomeTeam = homeTeam;
            targetAwayTeam = awayTeam;
            targetGameDate = gameDate;
            
            // 2026+ UPDATE: Find the game in current season to get preview data
            const currentSeasonGames = await getSeasonGames(seasonId);
            const matchingGame = currentSeasonGames.find(g => {
              const gHomeTeam = g.homeTeamName || capitalize(g.homeTeamId) || '';
              const gAwayTeam = g.awayTeamName || capitalize(g.awayTeamId) || '';
              
              // Convert game date for comparison
              let gDateStr = '';
              if (g.date && typeof g.date === 'object' && g.date.seconds) {
                gDateStr = new Date(g.date.seconds * 1000).toLocaleDateString('en-US');
              } else if (g.date) {
                gDateStr = g.date;
              }
              
              const matchesTeams = gHomeTeam === targetHomeTeam && gAwayTeam === targetAwayTeam;
              const matchesDate = gDateStr === targetGameDate || 
                                  formatDateForComparison(gDateStr) === formatDateForComparison(targetGameDate);
              
              return matchesTeams && matchesDate;
            });
            
            if (matchingGame) {
              // 2026+ UPDATE: Store preview data directly from the game document
              currentGamePreview = {
                homeOdds: matchingGame.homeOdds || null,
                awayOdds: matchingGame.awayOdds || null,
                preview: matchingGame.preview || ''
              };
              console.log('Found matching game with preview data:', currentGamePreview);
            } else {
              currentGamePreview = { homeOdds: null, awayOdds: null, preview: '' };
              console.log('No matching game found - preview data will be empty');
            }
          }
          
          // Load data in parallel - 2026+ UPDATE: removed previews.json fetch
          const [seasons, batting, pitching] = await Promise.all([
            getAllSeasons(),
            getSeasonPlayerStatsOptimized(seasonId),
            getSeasonPitchingStatsOptimized(seasonId)
          ]);
          
          console.log(`‚úÖ Found ${seasons.length} seasons`);
          
          // Load games from ALL seasons (following h2h_grid.html pattern)
          const gamePromises = seasons.map(async (season) => {
            try {
              const seasonGames = await getSeasonGames(season.id);
              
              // Map games to expected format
              return seasonGames.map(g => {
                let dateString = "";
                if (g.date && g.date.seconds) {
                  const dateObj = new Date(g.date.seconds * 1000);
                  dateString = dateObj.toLocaleDateString('en-US');
                } else if (g.date) {
                  dateString = g.date;
                }
                
                return {
                  "home team": g.homeTeamName || capitalize(g.homeTeamId) || "",
                  "away team": g.awayTeamName || capitalize(g.awayTeamId) || "",
                  "home score": g.homeScore !== undefined ? g.homeScore : null,
                  "away score": g.awayScore !== undefined ? g.awayScore : null,
                  winner: capitalize(g.winner || ""),
                  game_type: g.gameType || "Regular",
                  date: dateString,
                  year: season.year.toString(),
                  season: capitalize(season.season || ""),
                  forfeit: g.forfeit ? "Yes" : "No"
                };
              });
            } catch (err) {
              console.warn(`Could not load games for season ${season.id}:`, err);
              return [];
            }
          });
          
          const allSeasonGames = await Promise.all(gamePromises);
          allGames = allSeasonGames.flat();
          
          console.log(`‚úÖ Fetched: ${allGames.length} total games, ${batting?.length || 0} batting records, ${pitching?.length || 0} pitching records`);
          
          // ====== MAP PLAYER DATA FROM FIREBASE ======
          // Use spread operator to keep ALL Firebase fields including acesBPI
          playerData = (batting || []).map(p => ({
            ...p, // Spread all Firebase fields
            name: p.playerName || p.name || p.id,
            team: p.team || p.currentTeam || "",
            year: currentSeasonData.year.toString(),
            season: capitalize(currentSeasonData.season),
            sub: "No"
          }));
          
          // ====== MAP PITCHING DATA FROM FIREBASE ======
          pitchingData = (pitching || []).map(p => ({
            name: p.playerName || p.name || p.id,
            team: p.team || p.currentTeam || "",
            year: currentSeasonData.year.toString(),
            season: capitalize(currentSeasonData.season),
            games: Number(p.games) || 0,
            IP: parseFloat(p.inningsPitched || p.IP || 0),
            "runs allowed": Number(p.runsAllowed || 0),
            ERA: p.earnedRunAverage || p.era || 0
          }));
          
          const loadTime = performance.now() - startTime;
          console.log(`‚úÖ Data loaded in ${loadTime.toFixed(0)}ms`);
          console.log(`üìä Games: ${allGames.length}, Players: ${playerData.length}, Pitchers: ${pitchingData.length}`);
          
          // Sample data for debugging
          if (playerData.length > 0) {
            console.log('üîç Sample batting data:', playerData[0]);
            console.log('üîç Check acesBPI field:', playerData[0].acesBPI);
          }
          if (pitchingData.length > 0) {
            console.log('üîç Sample pitching data:', pitchingData[0]);
          }
          if (allGames.length > 0) {
            console.log('üîç Sample game data:', allGames[0]);
          }
          
          generateGamePreview();
          
        } catch (error) {
          console.error('‚ùå Error loading data:', error);
          console.error('Error stack:', error.stack);
          document.body.innerHTML = `
            <div class="container">
              <h1>Error loading game preview data</h1>
              <p>Please try again later.</p>
              <p><a href="current-season.html">Return to current season</a></p>
            </div>
          `;
        }
      }

      function generateGamePreview() {
        console.log('üé® Generating game preview...');
        
        // Update header
        document.getElementById('gameInfo').textContent = `${targetAwayTeam} @ ${targetHomeTeam} - ${targetGameDate}`;
        
        // Update team names and logos
        document.getElementById('awayTeamName').textContent = targetAwayTeam;
        document.getElementById('homeTeamName').textContent = targetHomeTeam;
        
        // Set team logos
        const awayLogo = document.getElementById('awayTeamLogo');
        const homeLogo = document.getElementById('homeTeamLogo');
        
        const awayLogoPath = `logos/${targetAwayTeam.toLowerCase()}.png`;
        const homeLogoPath = `logos/${targetHomeTeam.toLowerCase()}.png`;
        
        awayLogo.src = awayLogoPath;
        awayLogo.alt = `${targetAwayTeam} logo`;
        
        homeLogo.src = homeLogoPath;
        homeLogo.alt = `${targetHomeTeam} logo`;

        // Calculate current season records from Firebase games
        // Get the current season from the game date
        const gameYear = new Date(targetGameDate).getFullYear();
        const gameMonth = new Date(targetGameDate).getMonth() + 1;
        const currentSeasonName = gameMonth >= 8 ? 'Fall' : 'Spring';
        
        const currentSeasonGames = allGames.filter(g =>
          g.winner && 
          g.winner.trim() !== "" &&
          g.year === gameYear.toString() &&
          g.season === currentSeasonName
        );

        const homeRecord = calculateTeamRecord(targetHomeTeam, currentSeasonGames);
        const awayRecord = calculateTeamRecord(targetAwayTeam, currentSeasonGames);

        document.getElementById('homeTeamRecord').textContent =
          `${homeRecord.wins}-${homeRecord.losses}${homeRecord.ties > 0 ? `-${homeRecord.ties}` : ''} (${(homeRecord.winPct * 100).toFixed(1)}%)`;
        
        document.getElementById('awayTeamRecord').textContent =
          `${awayRecord.wins}-${awayRecord.losses}${awayRecord.ties > 0 ? `-${awayRecord.ties}` : ''} (${(awayRecord.winPct * 100).toFixed(1)}%)`;

        // Update game details
        document.getElementById('gameDetails').innerHTML = `
          <strong>Date:</strong> ${targetGameDate} | <strong>Type:</strong> Regular Season
        `;

        // Generate all sections
        generatePetersPreview(targetHomeTeam, targetAwayTeam);
        generateHeadToHeadRecord(targetHomeTeam, targetAwayTeam);
        generateKeyPlayers(targetHomeTeam, targetAwayTeam);
        generateBattingComparison(targetHomeTeam, targetAwayTeam);
        generatePitchingComparison(targetHomeTeam, targetAwayTeam);
        generateHistoricalMatchups(targetHomeTeam, targetAwayTeam);
        
        console.log('‚úÖ Game preview generated successfully!');
      }

      // Helper function to fix character encoding issues
      function cleanText(text) {
        if (!text) return text;
        
        return text
          .replace(/['']/g, "'")
          .replace(/[""]/g, '"')
          .replace(/√É∆í√Ü'√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬æ√É‚Äö√Ç¬¢/g, "'")
          .replace(/√É∆í√Ü'√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨¬¶"/g, '"')
          .replace(/√É∆í√Ü'√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨/g, '"')
          .replace(/√É∆í√Ü'√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨"/g, "‚Äî")
          .replace(/√É∆í√Ü'√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨"/g, "‚Äî");
      }

      // 2026+ UPDATE: generatePetersPreview now uses currentGamePreview (from game document)
      function generatePetersPreview(homeTeam, awayTeam) {
        const petersSection = document.querySelector('.section:has(.peters-preview-header)');
        
        // 2026+ UPDATE: Use currentGamePreview instead of searching previewData array
        if (!currentGamePreview || !currentGamePreview.preview || currentGamePreview.preview.trim() === '') {
          if (petersSection) {
            petersSection.style.display = 'none';
          }
          return;
        }

        if (petersSection) {
          petersSection.style.display = 'block';
        }

        // 2026+ UPDATE: Get odds directly from currentGamePreview
        const homeOdds = parseInt(currentGamePreview.homeOdds || 0);
        const awayOdds = parseInt(currentGamePreview.awayOdds || 0);
        
        let oddsHtml = '';
        if (homeOdds !== 0 || awayOdds !== 0) {
          const homeIsFavorite = homeOdds < 0 && (awayOdds > 0 || homeOdds > awayOdds);
          const awayIsFavorite = awayOdds < 0 && (homeOdds > 0 || awayOdds > homeOdds);

          oddsHtml = `
            <div class="odds-display">
              <div class="odds-item">
                <div class="odds-team">${awayTeam} (Away)</div>
                <div class="odds-value ${awayIsFavorite ? 'favorite' : ''}">${awayOdds > 0 ? '+' : ''}${awayOdds}</div>
              </div>
              <div class="odds-item">
                <div style="font-size: 1.2rem; color: #666;">Money Line</div>
              </div>
              <div class="odds-item">
                <div class="odds-team">${homeTeam} (Home)</div>
                <div class="odds-value ${homeIsFavorite ? 'favorite' : ''}">${homeOdds > 0 ? '+' : ''}${homeOdds}</div>
              </div>
            </div>
          `;
        }

        const previewHtml = `
          <div class="peters-preview-content">
            <div class="peters-preview-image" id="petersImageContainer">
              <img src="logos/peterpreview.png" alt="Peter's Preview" onerror="this.parentElement.style.display='none'">
            </div>
            <div class="peters-preview-main">
              ${oddsHtml}
              <div class="preview-text">
                ${cleanText(currentGamePreview.preview)}
              </div>
            </div>
          </div>
        `;

        document.getElementById('petersPreviewContent').innerHTML = previewHtml;
      }

      function formatDateForComparison(dateStr) {
        if (!dateStr) return '';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        return `${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`;
      }

      function calculateTeamRecord(teamName, games) {
        const teamGames = games.filter(g =>
          (g["home team"] === teamName || g["away team"] === teamName) &&
          g.winner && g.winner.trim() !== ""
        );

        let wins = 0, losses = 0, ties = 0;

        teamGames.forEach(game => {
          if (game.winner === "Tie" || game.winner.toLowerCase() === "tie") {
            ties++;
          } else if (game.winner === teamName) {
            wins++;
          } else {
            losses++;
          }
        });

        const totalDecided = wins + losses;
        const winPct = totalDecided > 0 ? wins / totalDecided : 0;

        return { wins, losses, ties, winPct };
      }

      function generateKeyPlayers(homeTeam, awayTeam) {
        // Get top players by AcesBPI for each team
        const getTopPlayers = (teamName) => {
          return playerData
            .filter(p => {
              const team = p.team || p.currentTeam || "";
              return team === teamName && p.acesBPI !== undefined && p.acesBPI !== "N/A";
            })
            .sort((a, b) => (parseFloat(b.acesBPI) || 0) - (parseFloat(a.acesBPI) || 0))
            .slice(0, 3);
        };

        const homeTopPlayers = getTopPlayers(homeTeam);
        const awayTopPlayers = getTopPlayers(awayTeam);

        function createPlayerCard(player, opponentTeam) {
          const avg = player.average !== undefined ? `.${Math.round(player.average * 1000).toString().padStart(3, '0')}` :
                      player.avg !== undefined ? `.${Math.round(player.avg * 1000).toString().padStart(3, '0')}` : 'N/A';
          const hits = player.hits || 0;
          const runs = player.runs || 0;
          const acesBPI = player.acesBPI !== undefined ? parseFloat(player.acesBPI).toFixed(2) : 'N/A';

          // Calculate vs opponent stats from historical games
          const vsOpponentGames = allGames.filter(g =>
            ((g["home team"] === player.team && g["away team"] === opponentTeam) ||
             (g["away team"] === player.team && g["home team"] === opponentTeam)) &&
            g.winner && g.winner.trim() !== ""
          );

          let vsOpponentHtml = '';
          if (vsOpponentGames.length > 0) {
            vsOpponentHtml = `
              <div class="vs-opponent-stats">
                <em>vs ${opponentTeam}: ${vsOpponentGames.length} career games</em>
              </div>
            `;
          }

          return `
            <div class="player-card">
              <div class="player-header">
                <span class="player-name">${player.name}</span>
              </div>
              <div class="player-stats">
                <div class="player-stat">
                  <span class="player-stat-label">AVG</span>
                  <span class="player-stat-value">${avg}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">Hits</span>
                  <span class="player-stat-value">${hits}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">Runs</span>
                  <span class="player-stat-value">${runs}</span>
                </div>
                <div class="player-stat">
                  <span class="player-stat-label">AcesBPI</span>
                  <span class="player-stat-value">${acesBPI}</span>
                </div>
              </div>
              ${vsOpponentHtml}
            </div>
          `;
        }

        const awayPlayersHtml = awayTopPlayers.length > 0
          ? awayTopPlayers.map(p => createPlayerCard(p, homeTeam)).join('')
          : '<div class="no-data">No qualified players found</div>';
          
        const homePlayersHtml = homeTopPlayers.length > 0
          ? homeTopPlayers.map(p => createPlayerCard(p, awayTeam)).join('')
          : '<div class="no-data">No qualified players found</div>';

        const keyPlayersHtml = `
          <div class="team-stats">
            <h4>${awayTeam} Top Players</h4>
            ${awayPlayersHtml}
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam} Top Players</h4>
            ${homePlayersHtml}
          </div>
        `;

        document.getElementById('keyPlayersComparison').innerHTML = keyPlayersHtml;
      }

      function generateHeadToHeadRecord(homeTeam, awayTeam) {
        const h2hGames = allGames.filter(g =>
          (g["home team"] === homeTeam && g["away team"] === awayTeam) ||
          (g["home team"] === awayTeam && g["away team"] === homeTeam)
        ).filter(g => g.winner && g.winner.trim() !== "");

        let homeWins = 0, awayWins = 0, ties = 0;

        h2hGames.forEach(game => {
          if (game.winner === "Tie") {
            ties++;
          } else if (game.winner === homeTeam) {
            homeWins++;
          } else if (game.winner === awayTeam) {
            awayWins++;
          }
        });

        const totalGames = homeWins + awayWins + ties;
        let recordText = "No previous matchups";
        
        if (totalGames > 0) {
          recordText = `All-time series: ${homeTeam} ${homeWins}-${awayWins}${ties > 0 ? `-${ties}` : ''} ${awayTeam} (${totalGames} games)`;
        }

        document.getElementById('h2hSummary').innerHTML = `
          <div class="h2h-record">${recordText}</div>
        `;
      }

      function generateBattingComparison(homeTeam, awayTeam) {
        const homeStats = calculateTeamBattingStats(homeTeam, playerData);
        const awayStats = calculateTeamBattingStats(awayTeam, playerData);

        const comparisonHtml = `
          <div class="team-stats">
            <h4>${awayTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team Avg</span>
              <span class="stat-value">.${awayStats.avg}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs/Game</span>
              <span class="stat-value">${awayStats.runsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Hits/Game</span>
              <span class="stat-value">${awayStats.hitsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Total Runs</span>
              <span class="stat-value">${awayStats.totalRuns}</span>
            </div>
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team Avg</span>
              <span class="stat-value">.${homeStats.avg}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs/Game</span>
              <span class="stat-value">${homeStats.runsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Hits/Game</span>
              <span class="stat-value">${homeStats.hitsPerGame}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Total Runs</span>
              <span class="stat-value">${homeStats.totalRuns}</span>
            </div>
          </div>
        `;

        document.getElementById('battingComparison').innerHTML = comparisonHtml;
      }

      function generatePitchingComparison(homeTeam, awayTeam) {
        const homeStats = calculateTeamPitchingStats(homeTeam, pitchingData);
        const awayStats = calculateTeamPitchingStats(awayTeam, pitchingData);

        const comparisonHtml = `
          <div class="team-stats">
            <h4>${awayTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team ERA</span>
              <span class="stat-value">${awayStats.era}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Innings</span>
              <span class="stat-value">${awayStats.totalIP}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs Allowed</span>
              <span class="stat-value">${awayStats.totalRunsAllowed}</span>
            </div>
          </div>

          <div class="vs-label">VS</div>

          <div class="team-stats">
            <h4>${homeTeam}</h4>
            <div class="stat-row">
              <span class="stat-label">Team ERA</span>
              <span class="stat-value">${homeStats.era}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Innings</span>
              <span class="stat-value">${homeStats.totalIP}</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Runs Allowed</span>
              <span class="stat-value">${homeStats.totalRunsAllowed}</span>
            </div>
          </div>
        `;

        document.getElementById('pitchingComparison').innerHTML = comparisonHtml;
      }

      function calculateTeamBattingStats(teamName, battingData) {
        const teamPlayers = battingData.filter(p => {
          const team = p.team || p.currentTeam || "";
          return team === teamName;
        });
        
        if (teamPlayers.length === 0) {
          return { avg: "000", runsPerGame: "0.0", hitsPerGame: "0.0", totalRuns: 0 };
        }

        const totalAtBats = teamPlayers.reduce((sum, p) => sum + (Number(p.atBats || 0)), 0);
        const totalHits = teamPlayers.reduce((sum, p) => sum + (Number(p.hits || 0)), 0);
        const totalRuns = teamPlayers.reduce((sum, p) => sum + (Number(p.runs || 0)), 0);
        const totalGames = Math.max(...teamPlayers.map(p => Number(p.games || 0)));

        const avg = totalAtBats > 0 ? Math.round((totalHits / totalAtBats) * 1000) : 0;
        const runsPerGame = totalGames > 0 ? (totalRuns / totalGames).toFixed(1) : "0.0";
        const hitsPerGame = totalGames > 0 ? (totalHits / totalGames).toFixed(1) : "0.0";

        return {
          avg: avg.toString().padStart(3, '0'),
          runsPerGame,
          hitsPerGame,
          totalRuns
        };
      }

      function calculateTeamPitchingStats(teamName, pitchingData) {
        const teamPitchers = pitchingData.filter(p => {
          const team = p.team || p.currentTeam || "";
          return team === teamName;
        });
        
        if (teamPitchers.length === 0) {
          return { era: "N/A", totalIP: "0.0", totalRunsAllowed: 0 };
        }

        const totalIP = teamPitchers.reduce((sum, p) => sum + parseFloat(p.inningsPitched || p.IP || 0), 0);
        const totalRunsAllowed = teamPitchers.reduce((sum, p) => sum + (Number(p.runsAllowed || p["runs allowed"] || 0)), 0);

        const era = totalIP > 0 ? ((totalRunsAllowed * 7) / totalIP).toFixed(2) : "N/A";

        return {
          era,
          totalIP: totalIP.toFixed(1),
          totalRunsAllowed
        };
      }

      function generateHistoricalMatchups(homeTeam, awayTeam) {
        const matchups = allGames.filter(g =>
          (g["home team"] === homeTeam && g["away team"] === awayTeam) ||
          (g["home team"] === awayTeam && g["away team"] === homeTeam)
        ).filter(g => g.winner && g.winner.trim() !== "")
        .sort((a, b) => new Date(b.date) - new Date(a.date));

        if (matchups.length === 0) {
          document.getElementById('historyContent').innerHTML =
            '<div class="no-data">No previous matchups found between these teams.</div>';
          return;
        }

        const tableHtml = `
          <table class="history-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Home Team</th>
                <th>Score</th>
                <th>Away Team</th>
                <th>Winner</th>
                <th>Season</th>
              </tr>
            </thead>
            <tbody>
              ${matchups.map(game => {
                const isWinner = (team) => game.winner === team ? 'winner-highlight' : '';
                const forfeit = game.forfeit === "Yes" ? " (Forfeit)" : "";
                
                return `
                  <tr>
                    <td>${game.date}</td>
                    <td class="${isWinner(game["home team"])}">${game["home team"]}</td>
                    <td>${game["home score"]} - ${game["away score"]}${forfeit}</td>
                    <td class="${isWinner(game["away team"])}">${game["away team"]}</td>
                    <td class="winner-highlight">${game.winner}</td>
                    <td>${game.season} ${game.year}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
          <div style="margin-top: 1rem; text-align: center; color: #666; font-size: 0.9rem;">
            Showing ${matchups.length} previous matchup${matchups.length !== 1 ? 's' : ''}
          </div>
        `;

        document.getElementById('historyContent').innerHTML = tableHtml;
      }
  </script>
  <script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
  <script src="team-colors.js"></script>
  <script src="mobile-enhancements.js"></script>
  <script src="theme-toggle.js"></script>
</body>
</html>
