<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Migrate Game Stats - One Time Fix</title>
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
    background: #1a1a2e;
    color: #eee;
  }
  .container {
    background: #16213e;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  h1 {
    color: #f59e0b;
    margin-top: 0;
  }
  .warning-box {
    background: #7f1d1d;
    border: 2px solid #ef4444;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
  }
  .info-box {
    background: #1e3a5f;
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
  }
  .success-box {
    background: #14532d;
    border: 2px solid #22c55e;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
  }
  button {
    background: #f59e0b;
    color: #1a1a2e;
    border: none;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    border-radius: 8px;
    cursor: pointer;
    margin: 10px 5px 10px 0;
  }
  button:hover {
    background: #d97706;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  button.danger {
    background: #ef4444;
  }
  button.danger:hover {
    background: #dc2626;
  }
  button.secondary {
    background: #6b7280;
  }
  #output {
    background: #0f172a;
    color: #a5f3fc;
    padding: 20px;
    border-radius: 8px;
    max-height: 500px;
    overflow-y: auto;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
    margin-top: 20px;
    border: 1px solid #334155;
  }
  select, input {
    padding: 10px 15px;
    font-size: 16px;
    border: 2px solid #334155;
    border-radius: 8px;
    background: #1e293b;
    color: #eee;
    margin-right: 10px;
  }
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin: 20px 0;
  }
  .stat-card {
    background: #1e293b;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
  }
  .stat-number {
    font-size: 28px;
    font-weight: bold;
    color: #f59e0b;
  }
  .stat-label {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 5px;
  }
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #94a3b8;
  }
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
    margin: 15px 0;
    padding: 10px;
    background: #1e293b;
    border-radius: 8px;
  }
  .checkbox-group input[type="checkbox"] {
    width: 20px;
    height: 20px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>üîß Migrate Game Stats - One Time Fix</h1>
  
  <div class="warning-box">
    <strong>‚ö†Ô∏è ONE-TIME MIGRATION SCRIPT</strong>
    <p>This script fixes existing game stats documents to use the new format:</p>
    <ul>
      <li><strong>Old:</strong> <code>/playerStats/{userId}/games/{gameId}</code></li>
      <li><strong>New:</strong> <code>/playerStats/{userId}/games/{seasonId}_{gameId}</code></li>
    </ul>
    <p>It will add the <code>seasonId</code> field and create copies with the new document ID format.</p>
  </div>

  <div class="info-box">
    <strong>What this script does:</strong>
    <ol>
      <li>Scans all documents in <code>playerStats/*/games/*</code> and <code>pitchingStats/*/games/*</code></li>
      <li>Identifies documents where the ID doesn't start with <code>{seasonId}_</code></li>
      <li>Creates new documents with format <code>{seasonId}_{originalGameId}</code></li>
      <li>Uses existing <code>seasonId</code> field from document, or falls back to target season</li>
      <li>Optionally deletes the old documents after migration</li>
    </ol>
  </div>

  <div>
    <label>Fallback Season ID (only used if document has no seasonId field):</label>
    <input type="text" id="targetSeasonId" value="2025-summer" placeholder="e.g., 2025-summer">
  </div>

  <div class="checkbox-group">
    <input type="checkbox" id="deleteOldDocs">
    <label for="deleteOldDocs" style="margin: 0;">Delete old documents after successful migration 
      <span style="color: #f59e0b; font-size: 12px;">(Note: Firestore rules may block deletes - old docs are harmless if they remain)</span>
    </label>
  </div>

  <div>
    <button onclick="scanDocuments()">üîç Scan (Preview Only)</button>
    <button onclick="runMigration()" class="danger">üöÄ Run Migration</button>
    <button onclick="clearOutput()" class="secondary">Clear Output</button>
  </div>

  <div class="stats-grid" id="statsGrid" style="display: none;">
    <div class="stat-card">
      <div class="stat-number" id="battingCount">0</div>
      <div class="stat-label">Batting Docs</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="pitchingCount">0</div>
      <div class="stat-label">Pitching Docs</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="needsMigration">0</div>
      <div class="stat-label">Need Migration</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="alreadyMigrated">0</div>
      <div class="stat-label">Already OK</div>
    </div>
  </div>

  <div id="output">Initializing Firebase...\n</div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { 
    getAuth, 
    onAuthStateChanged,
    signInWithPopup,
    GoogleAuthProvider
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import {
    getFirestore,
    collection,
    collectionGroup,
    doc,
    getDocs,
    getDoc,
    setDoc,
    deleteDoc,
    query,
    where
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyCAEWkrTcprzJ2KPPJu-vFJPvYOVU4ky20",
    authDomain: "acessoftballreference-84791.firebaseapp.com",
    projectId: "acessoftballreference-84791",
    storageBucket: "acessoftballreference-84791.firebasestorage.app",
    messagingSenderId: "777699560175",
    appId: "1:777699560175:web:4092b422e7d7116352e91a"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // Make available globally
  window.db = db;
  window.collection = collection;
  window.collectionGroup = collectionGroup;
  window.doc = doc;
  window.getDocs = getDocs;
  window.getDoc = getDoc;
  window.setDoc = setDoc;
  window.deleteDoc = deleteDoc;
  window.query = query;
  window.where = where;

  function log(message) {
    const output = document.getElementById('output');
    const timestamp = new Date().toLocaleTimeString();
    output.textContent += `[${timestamp}] ${message}\n`;
    output.scrollTop = output.scrollHeight;
  }
  window.log = log;

  function updateStats(batting, pitching, needsMig, alreadyOk) {
    document.getElementById('statsGrid').style.display = 'grid';
    document.getElementById('battingCount').textContent = batting;
    document.getElementById('pitchingCount').textContent = pitching;
    document.getElementById('needsMigration').textContent = needsMig;
    document.getElementById('alreadyMigrated').textContent = alreadyOk;
  }
  window.updateStats = updateStats;

  window.clearOutput = function() {
    document.getElementById('output').textContent = 'Output cleared.\n';
    document.getElementById('statsGrid').style.display = 'none';
  };

  // Check auth
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      log(`‚úì Signed in as: ${user.email}`);
      
      // Check if admin
      try {
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists()) {
          const userData = userDoc.data();
          const role = userData.userRole || userData.role || '';
          if (role === 'admin' || role === 'league-staff' || userData.isAdmin) {
            log(`‚úì Role: ${role || 'admin'}`);
            log('');
            log('Ready to scan. Click "Scan (Preview Only)" to see what needs migration.');
          } else {
            log(`‚úó Access denied. Role: ${role}`);
          }
        }
      } catch (err) {
        log(`Error checking permissions: ${err.message}`);
      }
    } else {
      log('Not signed in. Please sign in first at the main site.');
    }
  });

  // Scan documents
  window.scanDocuments = async function() {
    const targetSeasonId = document.getElementById('targetSeasonId').value.trim();
    if (!targetSeasonId) {
      alert('Please enter a target season ID');
      return;
    }

    log('');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log('SCANNING DOCUMENTS (Preview Only)');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log(`Target season: ${targetSeasonId}`);
    log('');

    try {
      const results = await findDocumentsToMigrate(targetSeasonId);
      
      log('');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      log('SCAN COMPLETE');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      log(`Batting documents found: ${results.battingDocs.length}`);
      log(`Pitching documents found: ${results.pitchingDocs.length}`);
      log(`Documents needing migration: ${results.needsMigration.length}`);
      log(`Documents already OK: ${results.alreadyOk.length}`);
      
      if (results.needsMigration.length > 0) {
        log('');
        log('üìã Documents to migrate:');
        results.needsMigration.forEach(d => {
          log(`   ${d.type}: ${d.path}`);
          log(`      ‚Üí New ID: ${d.newDocId}`);
        });
      }

      updateStats(
        results.battingDocs.length,
        results.pitchingDocs.length,
        results.needsMigration.length,
        results.alreadyOk.length
      );

    } catch (error) {
      log(`Error scanning: ${error.message}`);
      console.error(error);
    }
  };

  // Find documents to migrate by getting player IDs from aggregatedPlayerStats
  async function findDocumentsToMigrate(targetSeasonId) {
    const battingDocs = [];
    const pitchingDocs = [];
    const needsMigration = [];
    const alreadyOk = [];

    // Get all player IDs from aggregatedPlayerStats
    log('Getting player IDs from aggregatedPlayerStats...');
    const aggregatedRef = collection(db, 'aggregatedPlayerStats');
    const aggregatedSnap = await getDocs(aggregatedRef);
    
    const playerLegacyIds = new Set(); // Use Set to avoid duplicates
    
    aggregatedSnap.forEach(docSnap => {
      const data = docSnap.data();
      if (data.migrated) return; // Skip migrated profiles
      
      // Determine the legacyId to query for game stats
      let legacyId;
      
      if (data.isAuthUser && data.linkedPlayer) {
        // Auth user - derive legacyId from linkedPlayer name
        // "Steve Giordano" -> "steve_giordano"
        legacyId = data.linkedPlayer.toLowerCase().replace(/\./g, '').replace(/\s+/g, '_');
        log(`  Auth user: ${data.linkedPlayer} -> legacyId: ${legacyId}`);
      } else {
        // Legacy user - doc ID is the legacyId
        legacyId = docSnap.id;
      }
      
      playerLegacyIds.add(legacyId);
    });
    
    const playerIds = Array.from(playerLegacyIds);
    log(`Found ${playerIds.length} unique legacy IDs to check`);
    log('');
    
    // Check each player's game stats
    log('Scanning playerStats/*/games for each player...');
    let checkedCount = 0;
    let foundGames = 0;
    
    for (const playerId of playerIds) {
      try {
        const gamesRef = collection(db, 'playerStats', playerId, 'games');
        const gamesSnap = await getDocs(gamesRef);
        
        if (gamesSnap.size > 0) {
          log(`  ‚úì ${playerId}: ${gamesSnap.size} game(s)`);
        }
        
        gamesSnap.forEach(gameDoc => {
          const data = gameDoc.data();
          const docId = gameDoc.id;
          const path = `playerStats/${playerId}/games/${docId}`;
          
          battingDocs.push({ path, docId, playerId, data, type: 'batting' });
          foundGames++;
          
          // Check if document ID has the season prefix format (e.g., 2025-fall_)
          const hasSeasonPrefix = docId.match(/^\d{4}-(summer|fall)_/);
          
          if (!hasSeasonPrefix) {
            const seasonId = data.seasonId || targetSeasonId;
            const newDocId = `${seasonId}_${docId}`;
            
            needsMigration.push({
              type: 'batting',
              path,
              docId,
              playerId,
              data,
              seasonId,
              originalGameId: docId,
              newDocId
            });
          } else {
            alreadyOk.push({ path, type: 'batting' });
          }
        });
        
        checkedCount++;
        if (checkedCount % 50 === 0) {
          log(`  Checked ${checkedCount}/${playerIds.length} players...`);
        }
      } catch (err) {
        // Player might not have any game stats yet, that's OK
      }
    }
    
    log(`Found ${battingDocs.length} batting game documents`);
    
    // Now check pitchingStats
    log('');
    log('Scanning pitchingStats/*/games for each player...');
    checkedCount = 0;
    
    for (const playerId of playerIds) {
      try {
        const gamesRef = collection(db, 'pitchingStats', playerId, 'games');
        const gamesSnap = await getDocs(gamesRef);
        
        if (gamesSnap.size > 0) {
          log(`  ‚úì ${playerId}: ${gamesSnap.size} pitching game(s)`);
        }
        
        gamesSnap.forEach(gameDoc => {
          const data = gameDoc.data();
          const docId = gameDoc.id;
          const path = `pitchingStats/${playerId}/games/${docId}`;
          
          pitchingDocs.push({ path, docId, playerId, data, type: 'pitching' });
          
          // Check if document ID has the season prefix format
          const hasSeasonPrefix = docId.match(/^\d{4}-(summer|fall)_/);
          
          if (!hasSeasonPrefix) {
            const seasonId = data.seasonId || targetSeasonId;
            const newDocId = `${seasonId}_${docId}`;
            
            needsMigration.push({
              type: 'pitching',
              path,
              docId,
              playerId,
              data,
              seasonId,
              originalGameId: docId,
              newDocId
            });
          } else {
            alreadyOk.push({ path, type: 'pitching' });
          }
        });
        
        checkedCount++;
      } catch (err) {
        // Player might not have any pitching stats, that's OK
      }
    }
    
    log(`Found ${pitchingDocs.length} pitching game documents`);

    return { battingDocs, pitchingDocs, needsMigration, alreadyOk };
  }

  // Run migration
  window.runMigration = async function() {
    const targetSeasonId = document.getElementById('targetSeasonId').value.trim();
    const deleteOld = document.getElementById('deleteOldDocs').checked;
    
    if (!targetSeasonId) {
      alert('Please enter a target season ID');
      return;
    }

    const confirmMsg = deleteOld
      ? 'This will migrate documents AND DELETE the old ones. Are you sure?'
      : 'This will create new documents with the correct format. Old documents will be kept. Continue?';
    
    if (!confirm(confirmMsg)) return;

    log('');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log('RUNNING MIGRATION');
    log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    log(`Target season: ${targetSeasonId}`);
    log(`Delete old docs: ${deleteOld}`);
    log('');

    try {
      const results = await findDocumentsToMigrate(targetSeasonId);
      
      if (results.needsMigration.length === 0) {
        log('‚úì No documents need migration!');
        return;
      }

      let migrated = 0;
      let deleted = 0;
      let errors = 0;

      for (const item of results.needsMigration) {
        try {
          const collectionName = item.type === 'batting' ? 'playerStats' : 'pitchingStats';
          
          // Create new document with correct ID
          const newDocRef = doc(db, collectionName, item.playerId, 'games', item.newDocId);
          
          const newData = {
            ...item.data,
            seasonId: item.seasonId,
            gameId: item.originalGameId,
            gameDocId: item.newDocId,
            migratedAt: new Date().toISOString(),
            migratedFrom: item.docId
          };
          
          await setDoc(newDocRef, newData);
          log(`‚úì Created: ${collectionName}/${item.playerId}/games/${item.newDocId}`);
          migrated++;

          // Delete old document if requested
          if (deleteOld && item.docId !== item.newDocId) {
            try {
              const oldDocRef = doc(db, collectionName, item.playerId, 'games', item.docId);
              await deleteDoc(oldDocRef);
              log(`  üóëÔ∏è Deleted old: ${item.docId}`);
              deleted++;
            } catch (delErr) {
              log(`  ‚ö†Ô∏è Could not delete old doc (rules may block deletes): ${item.docId}`);
            }
          }

        } catch (err) {
          log(`‚úó Error migrating ${item.path}: ${err.message}`);
          errors++;
        }
      }

      log('');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      log('MIGRATION COMPLETE');
      log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      log(`‚úì Documents migrated: ${migrated}`);
      if (deleteOld) log(`üóëÔ∏è Old documents deleted: ${deleted}`);
      if (errors > 0) log(`‚úó Errors: ${errors}`);

    } catch (error) {
      log(`Error during migration: ${error.message}`);
      console.error(error);
    }
  };
</script>
</body>
</html>
