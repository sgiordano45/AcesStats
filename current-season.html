<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2025 Fall Season - Mountainside Aces</title>
<link rel="stylesheet" href="style.css">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
  }

  .header {
    background: linear-gradient(135deg, #ff7b7b 0%, #ff6b6b 100%);
    color: white;
    text-align: center;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }

  .header p {
    margin: 0.5rem 0 0 0;
    font-size: 1.1rem;
    opacity: 0.9;
  }

  .back-nav {
    background: rgba(255, 255, 255, 0.95);
    padding: 1rem 2rem;
    border-bottom: 1px solid #eee;
  }

  .back-nav a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    margin-right: 2rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    transition: background-color 0.3s;
  }

  .back-nav a:hover {
    background: #f8f9fa;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  .section {
    background: white;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    overflow: hidden;
  }

  .section-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem 2rem;
    font-size: 1.4rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .section-content {
    padding: 2rem;
  }

  .standings-table, .schedule-table, .bracket-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
    font-size: 0.9rem;
  }

  .standings-table th, .schedule-table th, .bracket-table th,
  .standings-table td, .schedule-table td, .bracket-table td {
    padding: 10px 8px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  .standings-table th, .schedule-table th, .bracket-table th {
    background-color: #f8f9fa;
    font-weight: bold;
    color: #333;
    font-size: 0.8rem;
    text-align: center;
  }

  .standings-table tr:nth-child(even), 
  .schedule-table tr:nth-child(even), 
  .bracket-table tr:nth-child(even) {
    background-color: #fafafa;
  }

  .standings-table tr:hover, 
  .schedule-table tr:hover, 
  .bracket-table tr:hover {
    background-color: #f0f0f0;
  }

  .team-name {
    font-weight: bold;
    color: #333;
    text-align: left !important;
  }

  .win-pct {
    font-weight: bold;
    color: #28a745;
    text-align: center;
  }

  .schedule-strength {
    text-align: center;
    font-weight: 600;
  }

  .schedule-strength.easy {
    color: #28a745;
  }

  .schedule-strength.average {
    color: #ffc107;
  }

  .schedule-strength.hard {
    color: #dc3545;
  }

  .game-date {
    white-space: nowrap;
    font-weight: 500;
  }

  .game-score {
    text-align: center;
    font-weight: bold;
    color: #495057;
  }

  .winner {
    font-weight: bold;
    color: #007bff;
  }

  .upcoming {
    background-color: #fff3cd !important;
  }

  .playoff-game {
    background-color: #d1ecf1 !important;
  }

  .bracket-section {
    margin-bottom: 2rem;
  }

  .bracket-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1rem;
    padding: 0.8rem 1rem;
    background: #f8f9fa;
    border-left: 4px solid #ff6b6b;
    border-radius: 4px;
  }

  .bracket-visual {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
  }

  .bracket-round {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
  }

  .bracket-round h4 {
    margin: 0 0 0.8rem 0;
    color: #333;
    font-size: 1rem;
  }

  .matchup {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
  }

  .matchup:last-child {
    margin-bottom: 0;
  }

  .team-in-bracket {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.3rem 0;
    border-bottom: 1px solid #eee;
  }

  .team-in-bracket:last-child {
    border-bottom: none;
  }

  .team-in-bracket.winner {
    font-weight: bold;
    color: #28a745;
  }
  .standings-table .team-name a {
  color: #667eea !important;
  text-decoration: underline;
  font-weight: bold;
}

.standings-table .team-name a:hover {
  color: #4c63d2;
  text-decoration: underline;
}
  .loading {
    text-align: center;
    padding: 2rem;
    color: #666;
    font-style: italic;
  }

  .no-data {
    text-align: center;
    padding: 2rem;
    color: #666;
  }

  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .stat-card {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    border-left: 4px solid #ff6b6b;
  }

  .stat-number {
    font-size: 1.8rem;
    font-weight: bold;
    color: #333;
  }

  .stat-label {
    font-size: 0.9rem;
    color: #666;
    margin-top: 0.2rem;
  }

  .sos-tooltip {
    position: relative;
    cursor: help;
  }

  .sos-tooltip:hover::after {
    content: "SOS = Schedule Strength (games played). Rem SOS = Remaining Schedule Strength (games left). Higher = tougher schedule";
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 11px;
    white-space: nowrap;
    z-index: 1000;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .sos-tooltip:hover::before {
    content: "";
    position: absolute;
    bottom: 93%;
    left: 50%;
    transform: translateX(-50%);
    border: 5px solid transparent;
    border-top-color: #333;
    z-index: 1001;
  }

  /* Season Leaders Styles */
  .leaders-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
  }

  .leader-category {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #28a745;
  }

  .leader-category.pitching {
    border-left-color: #dc3545;
  }

  .leader-category h4 {
    margin: 0 0 0.8rem 0;
    color: #333;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .leader-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .leader-list li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.4rem 0;
    border-bottom: 1px solid #e9ecef;
    font-size: 0.9rem;
  }

  .leader-list li:last-child {
    border-bottom: none;
  }

  .leader-rank {
    background: #667eea;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.5rem;
    flex-shrink: 0;
  }

  .leader-rank.first {
    background: #ffd700;
    color: #333;
  }

  .leader-rank.second {
    background: #c0c0c0;
    color: #333;
  }

  .leader-rank.third {
    background: #cd7f32;
    color: white;
  }

  .leader-name {
    flex: 1;
    margin-left: 0.5rem;
    font-weight: 500;
  }

  .leader-value {
    font-weight: bold;
    color: #495057;
    margin-left: 0.5rem;
  }

  .leader-team {
    font-size: 0.8rem;
    color: #6c757d;
    margin-left: 0.3rem;
  }

  .leaders-section-title {
    font-size: 1.2rem;
    font-weight: bold;
    color: #333;
    margin: 1.5rem 0 1rem 0;
    padding: 0.8rem 0;
    border-bottom: 2px solid #e9ecef;
  }

  @media (max-width: 768px) {
    .container {
      padding: 1rem;
    }

    .section-content {
      padding: 1rem;
    }

    .standings-table, .schedule-table, .bracket-table {
      font-size: 0.8rem;
    }

    .standings-table th, .schedule-table th, .bracket-table th,
    .standings-table td, .schedule-table td, .bracket-table td {
      padding: 6px 4px;
    }

    .bracket-visual {
      grid-template-columns: 1fr;
    }

    .header h1 {
      font-size: 2rem;
    }

    .leaders-grid {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .leader-list li {
      font-size: 0.85rem;
    }
  }
</style>
</head>
<body>
  <div class="back-nav">
    <a href="index.html">‚Üê Home</a>
    <a href="projections.html" class="nav-btn">üìà Season Projections</a>
    <a href="batting.html">Batting Stats</a>
    <a href="pitching.html">Pitching Stats</a>
    <a href="teams.html">Teams</a>
    <a href="players.html">Players</a>
    <a href="seasons.html">All Seasons</a>
    <a href="awards.html">Awards</a>
    <a href="leaders.html">Career Leaders</a>
    <a href="milestones.html">Batting Milestones</a>
  </div>

  <header class="header">
    <h1>üçÇ 2025 Fall Season</h1>
    <p>Current standings, schedule, results & playoff bracket</p>
  </header>

  <div class="container">
    <!-- Season Summary Stats -->
    <div class="section">
      <div class="section-header">
        üìä Season Overview
      </div>
      <div class="section-content">
        <div class="stats-summary" id="seasonSummary">
          <div class="stat-card">
            <div class="stat-number" id="totalTeams">--</div>
            <div class="stat-label">Teams</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="gamesPlayed">--</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="regularSeasonGames">--</div>
            <div class="stat-label">Regular Season</div>
          </div>
              <div style="text-align: center; margin-top: 1.5rem;">
      <a href="projections.html" style="
        display: inline-block;
        padding: 1rem 2rem;
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-weight: bold;
        font-size: 1.1rem;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
        üîÆ Project Season Outcomes
      </a>
    </div>
          <div class="stat-card">
            <div class="stat-number" id="playoffGames">--</div>
            <div class="stat-label">Playoff Games</div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Current Standings -->
    <div class="section">
      <div class="section-header">
        üèÜ Current Standings
      </div>
      <div class="section-content">
        <div id="standingsContent" class="loading">Loading standings...</div>
      </div>
    </div>

    <!-- Season Leaders -->
    <div class="section">
      <div class="section-header">
        ‚≠ê Season Leaders
      </div>
      <div class="section-content">
        <div id="leadersContent" class="loading">Loading season leaders...</div>
      </div>
    </div>

    <!-- Upcoming Schedule -->
    <div class="section">
      <div class="section-header">
        üìÖ Upcoming Schedule
      </div>
      <div class="section-content">
        <div id="scheduleContent" class="loading">Loading schedule...</div>
      </div>
    </div>

    <!-- Past Game Results -->
    <div class="section">
      <div class="section-header">
        üìã Game Results
      </div>
      <div class="section-content">
        <div id="resultsContent" class="loading">Loading results...</div>
      </div>
    </div>

    <!-- Projected Playoff Bracket -->
    <div class="section">
      <div class="section-header">
        üèüÔ∏è Playoff Bracket
      </div>
      <div class="section-content">
        <div id="bracketContent" class="loading">Loading playoff bracket...</div>
      </div>
    </div>
  </div>

  <script>
    let allGames = [];
    let playerData = [];
    let pitchingData = [];
    const currentSeason = "Fall";
    const currentYear = "2025";
    const today = new Date();

    // Load games data and initialize page
    async function loadData() {
      try {
        const [gamesResponse, playerResponse, pitchingResponse] = await Promise.all([
          fetch('games.json'),
          fetch('data.json').catch(() => ({ ok: false })),
          fetch('pitching.json').catch(() => ({ ok: false }))
        ]);
        
        if (!gamesResponse.ok) throw new Error('Failed to load games data');
        
        allGames = await gamesResponse.json();
        
        // Try to load player data, but don't fail if it's missing
        if (playerResponse.ok) {
          playerData = await playerResponse.json();
        } else {
          playerData = [];
        }
        
        // Try to load pitching data, but don't fail if it's missing
        if (pitchingResponse.ok) {
          pitchingData = await pitchingResponse.json();
        } else {
          pitchingData = [];
        }
        
        // Filter for current season
        const seasonGames = allGames.filter(g => 
          g.year === currentYear && g.season === currentSeason
        );

        const seasonPlayerData = playerData.filter(p =>
          p.year === currentYear && p.season === currentSeason && p.sub === "No"
        );

        const seasonPitchingData = pitchingData.filter(p =>
          p.year === currentYear && p.season === currentSeason
        );

        updateSeasonSummary(seasonGames);
        updateStandings(seasonGames);
        updateSeasonLeaders(seasonPlayerData, seasonPitchingData);
        updateUpcomingSchedule(seasonGames);
        updateRecentResults(seasonGames);
        updatePlayoffBracket(seasonGames);

      } catch (error) {
        console.error('Error loading data:', error);
        showError();
      }
    }

    function parseGameDate(dateStr) {
      return new Date(dateStr);
    }

    function updateSeasonSummary(games) {
      const teams = new Set();
      const completedGames = games.filter(g => 
        parseGameDate(g.date) < today && g.winner && g.winner.trim() !== ""
      );
      const regularGames = completedGames.filter(g => g.game_type === 'Regular');
      const playoffGames = completedGames.filter(g => g.game_type === 'Playoff');

      games.forEach(g => {
        teams.add(g["home team"]);
        teams.add(g["away team"]);
      });

      document.getElementById('totalTeams').textContent = teams.size;
      document.getElementById('gamesPlayed').textContent = completedGames.length;
      document.getElementById('regularSeasonGames').textContent = regularGames.length;
      document.getElementById('playoffGames').textContent = playoffGames.length;
    }

    function updateSeasonLeaders(playerData, pitchingData) {
      let leadersHtml = '';

      // Batting Leaders Section
      if (playerData.length > 0) {
        const cleanBattingData = playerData.map(p => ({
          name: p.name ? p.name.trim() : "",
          team: p.team ? p.team.trim() : "",
          games: Number(p.games) || 0,
          atBats: Number(p.atBats) || 0,
          hits: Number(p.hits) || 0,
          runs: Number(p.runs) || 0,
          walks: Number(p.walks) || 0
        })).filter(p => p.name && p.games > 0);

        const battingCategories = [
          { 
            title: 'üèÉ At Bats', 
            field: 'atBats',
            formatter: (val) => val.toString()
          },
          { 
            title: 'üéØ Hits', 
            field: 'hits',
            formatter: (val) => val.toString()
          },
          { 
            title: '‚ö° Runs', 
            field: 'runs',
            formatter: (val) => val.toString()
          },
          { 
            title: 'üëÄ Walks', 
            field: 'walks',
            formatter: (val) => val.toString()
          }
        ];

        leadersHtml += '<div class="leaders-section-title">ü•é Batting Leaders</div>';
        leadersHtml += '<div class="leaders-grid">';

        battingCategories.forEach(category => {
          const leaders = cleanBattingData
            .filter(p => p[category.field] > 0)
            .sort((a, b) => b[category.field] - a[category.field])
            .slice(0, 10);

          leadersHtml += `
            <div class="leader-category">
              <h4>${category.title}</h4>
              <ul class="leader-list">
          `;

          leaders.forEach((player, index) => {
            const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
            leadersHtml += `
              <li>
                <span class="leader-rank ${rankClass}">${index + 1}</span>
                <span class="leader-name"><a href="player.html?name=${encodeURIComponent(player.name)}">${player.name}</a></span>
                <span class="leader-team">(${player.team})</span>
                <span class="leader-value">${category.formatter(player[category.field])}</span>
              </li>
            `;
          });

          leadersHtml += '</ul></div>';
        });

        leadersHtml += '</div>';
      }

      // Pitching Leaders Section
      if (pitchingData.length > 0) {
        const cleanPitchingData = pitchingData.map(p => ({
          name: p.name ? p.name.trim() : "",
          team: p.team ? p.team.trim() : "",
          games: Number(p.games) || 0,
          IP: parseFloat(p.IP) || 0,
          runsAllowed: Number(p["runs allowed"]) || 0,
          ERA: p.ERA === "N/A" || !p.ERA || p.ERA === 0 ? "N/A" : Number(p.ERA)
        })).filter(p => p.name && p.games > 0);

        const pitchingCategories = [
          { 
            title: '‚öæ Games', 
            field: 'games',
            formatter: (val) => val.toString(),
            minQualifier: 0
          },
          { 
            title: 'üìè Innings Pitched', 
            field: 'IP',
            formatter: (val) => val.toFixed(1),
            minQualifier: 0
          },
          { 
            title: 'üî• Best ERA', 
            field: 'ERA',
            formatter: (val) => val === "N/A" ? "N/A" : val.toFixed(2),
            minQualifier: 5,
            sortOrder: 'asc'
          }
        ];

        leadersHtml += '<div class="leaders-section-title">‚öæ Pitching Leaders</div>';
        leadersHtml += '<div class="leaders-grid">';

        pitchingCategories.forEach(category => {
          let leaders = cleanPitchingData.filter(p => {
            if (category.field === 'ERA') {
              return p.IP >= category.minQualifier && p.ERA !== "N/A" && !isNaN(p.ERA);
            }
            return p[category.field] > category.minQualifier;
          });

          if (category.sortOrder === 'asc') {
            leaders = leaders.sort((a, b) => a[category.field] - b[category.field]);
          } else {
            leaders = leaders.sort((a, b) => b[category.field] - a[category.field]);
          }

          leaders = leaders.slice(0, 10);

          leadersHtml += `
            <div class="leader-category pitching">
              <h4>${category.title}</h4>
              <ul class="leader-list">
          `;

          leaders.forEach((player, index) => {
            const rankClass = index === 0 ? 'first' : index === 1 ? 'second' : index === 2 ? 'third' : '';
            leadersHtml += `
              <li>
                <span class="leader-rank ${rankClass}">${index + 1}</span>
                <span class="leader-name"><a href="pitcher.html?name=${encodeURIComponent(player.name)}">${player.name}</a></span>
                <span class="leader-team">(${player.team})</span>
                <span class="leader-value">${category.formatter(player[category.field])}</span>
              </li>
            `;
          });

          leadersHtml += '</ul></div>';
        });

        leadersHtml += '</div>';
      }

      if (leadersHtml === '') {
        leadersHtml = '<div class="no-data">No player statistics available for this season yet.</div>';
      }

      document.getElementById('leadersContent').innerHTML = leadersHtml;
    }

    function updateStandings(games) {
      const completedGames = games.filter(g => 
        parseGameDate(g.date) < today && g.winner && g.winner.trim() !== ""
      );
      const regularGames = completedGames.filter(g => g.game_type === 'Regular');
      
      if (regularGames.length === 0) {
        document.getElementById('standingsContent').innerHTML = 
          '<div class="no-data">No completed games yet this season.</div>';
        return;
      }

      const standings = calculateStandings(regularGames, games);
      const html = generateStandingsTable('Regular Season Standings', standings);
      document.getElementById('standingsContent').innerHTML = html;
    }

    // Enhanced function to calculate schedule strength
    function calculateScheduleStrength(teamName, games, allStandings) {
      const teamGames = games.filter(game => 
        (game["home team"] === teamName || game["away team"] === teamName)
      );

      if (teamGames.length === 0) return 0;

      let totalOpponentWins = 0;
      let totalOpponentLosses = 0;

      teamGames.forEach(game => {
        const opponent = game["home team"] === teamName ? game["away team"] : game["home team"];
        const oppStanding = allStandings.find(team => team.name === opponent);
        
        if (oppStanding) {
          // Calculate opponent's wins/losses excluding games against this team
          const oppGamesVsTeam = games.filter(g => 
            (g["home team"] === opponent && g["away team"] === teamName) ||
            (g["away team"] === opponent && g["home team"] === teamName)
          );

          let oppWinsExcludingTeam = oppStanding.wins;
          let oppLossesExcludingTeam = oppStanding.losses;

          oppGamesVsTeam.forEach(g => {
            if (g.winner === opponent) oppWinsExcludingTeam--;
            else if (g.winner !== "Tie" && g.winner !== "") oppLossesExcludingTeam--;
          });

          totalOpponentWins += oppWinsExcludingTeam;
          totalOpponentLosses += oppLossesExcludingTeam;
        }
      });

      const totalOpponentDecidedGames = totalOpponentWins + totalOpponentLosses;
      return totalOpponentDecidedGames > 0 ? (totalOpponentWins / totalOpponentDecidedGames) : 0;
    }

    // Function to calculate schedule strength for remaining games
    function calculateRemainingScheduleStrength(teamName, games, allStandings) {
      const remainingGames = games.filter(game => {
        const gameDate = parseGameDate(game.date);
        const isFuture = gameDate >= today;
        const noWinner = !game.winner || game.winner.trim() === "";
        const isRegularSeason = game.game_type === 'Regular';
        const teamInvolved = (game["home team"] === teamName || game["away team"] === teamName);
        
        return isFuture && noWinner && isRegularSeason && teamInvolved;
      });

      if (remainingGames.length === 0) return 0;

      let totalOpponentWinPct = 0;
      let opponentCount = 0;

      remainingGames.forEach(game => {
        const opponent = game["home team"] === teamName ? game["away team"] : game["home team"];
        const oppStanding = allStandings.find(team => team.name === opponent);
        
        if (oppStanding) {
          const oppTotalDecided = oppStanding.wins + oppStanding.losses;
          const oppWinPct = oppTotalDecided > 0 ? (oppStanding.wins / oppTotalDecided) : 0;
          
          totalOpponentWinPct += oppWinPct;
          opponentCount++;
        }
      });

      return opponentCount > 0 ? (totalOpponentWinPct / opponentCount) : 0;
    }

    function calculateStandings(games, allSeasonGames = games) {
      const teamStats = {};

      games.forEach(game => {
        const homeTeam = game["home team"];
        const awayTeam = game["away team"];
        const winner = game.winner;
        const homeScore = parseInt(game["home score"]) || 0;
        const awayScore = parseInt(game["away score"]) || 0;

        if (!teamStats[homeTeam]) {
          teamStats[homeTeam] = { 
            name: homeTeam, wins: 0, losses: 0, ties: 0, 
            runsFor: 0, runsAgainst: 0, h2h: {}
          };
        }
        if (!teamStats[awayTeam]) {
          teamStats[awayTeam] = { 
            name: awayTeam, wins: 0, losses: 0, ties: 0, 
            runsFor: 0, runsAgainst: 0, h2h: {}
          };
        }

        // Add runs
        teamStats[homeTeam].runsFor += homeScore;
        teamStats[homeTeam].runsAgainst += awayScore;
        teamStats[awayTeam].runsFor += awayScore;
        teamStats[awayTeam].runsAgainst += homeScore;

        // Initialize H2H if needed
        if (!teamStats[homeTeam].h2h[awayTeam]) {
          teamStats[homeTeam].h2h[awayTeam] = { wins: 0, losses: 0, ties: 0 };
        }
        if (!teamStats[awayTeam].h2h[homeTeam]) {
          teamStats[awayTeam].h2h[homeTeam] = { wins: 0, losses: 0, ties: 0 };
        }

        // Record results
        if (winner === "Tie") {
          teamStats[homeTeam].ties++;
          teamStats[awayTeam].ties++;
          teamStats[homeTeam].h2h[awayTeam].ties++;
          teamStats[awayTeam].h2h[homeTeam].ties++;
        } else if (winner === homeTeam) {
          teamStats[homeTeam].wins++;
          teamStats[awayTeam].losses++;
          teamStats[homeTeam].h2h[awayTeam].wins++;
          teamStats[awayTeam].h2h[homeTeam].losses++;
        } else if (winner === awayTeam) {
          teamStats[awayTeam].wins++;
          teamStats[homeTeam].losses++;
          teamStats[awayTeam].h2h[homeTeam].wins++;
          teamStats[homeTeam].h2h[awayTeam].losses++;
        }
      });

      // Calculate basic stats first
      const preliminaryStandings = Object.values(teamStats)
        .map(team => {
          const totalDecided = team.wins + team.losses;
          team.winPct = totalDecided > 0 ? (team.wins / totalDecided) : 0;
          team.runDifferential = team.runsFor - team.runsAgainst;
          return team;
        });

      // Now calculate schedule strength for each team
      const standingsWithSOS = preliminaryStandings.map(team => {
        team.scheduleStrength = calculateScheduleStrength(team.name, games, preliminaryStandings);
        team.remainingScheduleStrength = calculateRemainingScheduleStrength(team.name, allSeasonGames, preliminaryStandings);
        return team;
      });

      // Sort using original tiebreaker system (league rules)
      return standingsWithSOS.sort((a, b) => {
        // Primary: Win percentage
        if (a.winPct !== b.winPct) return b.winPct - a.winPct;
        
        // Secondary: Head-to-head record
        const h2hComp = compareHeadToHead(a, b);
        if (h2hComp !== 0) return h2hComp;
        
        // Tertiary: Runs allowed (lower is better)
        if (a.runsAgainst !== b.runsAgainst) return a.runsAgainst - b.runsAgainst;
        
        // Final: Run differential
        return b.runDifferential - a.runDifferential;
      });
    }

    function compareHeadToHead(teamA, teamB) {
      const aVsB = teamA.h2h[teamB.name];
      const bVsA = teamB.h2h[teamA.name];
      
      if (!aVsB || !bVsA) return 0;
      
      const aH2HWinPct = (aVsB.wins + aVsB.losses) > 0 ? aVsB.wins / (aVsB.wins + aVsB.losses) : 0;
      const bH2HWinPct = (bVsA.wins + bVsA.losses) > 0 ? bVsA.wins / (bVsA.wins + bVsA.losses) : 0;
      
      return bH2HWinPct - aH2HWinPct;
    }

    function formatScheduleStrength(sos) {
      const sosValue = (sos * 100).toFixed(1);
      let sosClass = 'average';
      
      if (sos < 0.45) sosClass = 'easy';
      else if (sos > 0.55) sosClass = 'hard';
      
      return {
        value: sosValue + '%',
        class: sosClass
      };
    }

    function generateStandingsTable(title, standings) {
      return `
        <div class="bracket-title">${title}</div>
        <table class="standings-table">
          <thead>
            <tr>
              <th style="width: 35px;">Rank</th>
              <th style="width: 130px; text-align: left;">Team</th>
              <th style="width: 40px;">W</th>
              <th style="width: 40px;">L</th>
              <th style="width: 40px;">T</th>
              <th style="width: 55px;">Win%</th>
              <th style="width: 40px;">RF</th>
              <th style="width: 40px;">RA</th>
              <th style="width: 50px;">Diff</th>
              <th style="width: 60px;" class="sos-tooltip">SOS</th>
              <th style="width: 60px;" class="sos-tooltip">Rem SOS</th>
              <th style="width: 50px;">Games</th>
            </tr>
          </thead>
          <tbody>
            ${standings.map((team, index) => {
              const sosFormatted = formatScheduleStrength(team.scheduleStrength);
              const remSosFormatted = formatScheduleStrength(team.remainingScheduleStrength);
              return `
                <tr>
                  <td style="text-align: center;">${index + 1}</td>
                  <td class="team-name"><a href="current-season-team.html?team=${encodeURIComponent(team.name)}">${team.name}</a></td>
                  <td style="text-align: center;">${team.wins}</td>
                  <td style="text-align: center;">${team.losses}</td>
                  <td style="text-align: center;">${team.ties}</td>
                  <td class="win-pct">${(team.winPct * 100).toFixed(1)}%</td>
                  <td style="text-align: center;">${team.runsFor}</td>
                  <td style="text-align: center;">${team.runsAgainst}</td>
                  <td style="color: ${team.runDifferential >= 0 ? '#28a745' : '#dc3545'}; text-align: center;">
                    ${team.runDifferential >= 0 ? '+' : ''}${team.runDifferential}
                  </td>
                  <td class="schedule-strength ${sosFormatted.class}">${sosFormatted.value}</td>
                  <td class="schedule-strength ${remSosFormatted.class}">${remSosFormatted.value}</td>
                  <td style="text-align: center;">${team.wins + team.losses + team.ties}</td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        <div style="margin-top: 1rem; font-size: 0.85rem; color: #666;">
          <strong>SOS:</strong> Schedule Strength - Average winning percentage of opponents faced (excluding games vs this team).<br>
          <strong>Rem SOS:</strong> Remaining Schedule Strength - Average winning percentage of remaining opponents.<br>
          <span style="color: #28a745;">Green</span> = easier schedule (below 45%), 
          <span style="color: #ffc107;">Yellow</span> = average (45-55%), 
          <span style="color: #dc3545;">Red</span> = harder schedule (above 55%)
        </div>
      `;
    }

    function updateUpcomingSchedule(games) {
      const upcomingGames = games
        .filter(g => {
          const gameDate = parseGameDate(g.date);
          const isFuture = gameDate >= today;
          const noWinner = !g.winner || g.winner.trim() === "";
          const isRegularSeason = g.game_type === 'Regular';
          return isFuture && noWinner && isRegularSeason;
        })
        .sort((a, b) => parseGameDate(a.date) - parseGameDate(b.date));

      if (upcomingGames.length === 0) {
        document.getElementById('scheduleContent').innerHTML = `
          <div class="no-data">
            <h4>No Upcoming Regular Season Games</h4>
            <p>No upcoming regular season games scheduled at this time.</p>
          </div>
        `;
        return;
      }

      const html = `
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
          <table class="schedule-table" style="margin-top: 0;">
            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
              <tr><th>Date</th><th>Home Team</th><th>vs</th><th>Away Team</th><th>Type</th><th>Preview</th></tr>
            </thead>
            <tbody>
              ${upcomingGames.map(game => `
                <tr class="upcoming">
                  <td class="game-date">${game.date}</td>
                  <td class="team-name">${game["home team"]}</td>
                  <td class="game-score">vs</td>
                  <td class="team-name">${game["away team"]}</td>
                  <td>${game.game_type}</td>
                  <td><a href="game-preview.html?home=${encodeURIComponent(game["home team"])}&away=${encodeURIComponent(game["away team"])}&date=${encodeURIComponent(game.date)}" style="color: #667eea; text-decoration: none; font-weight: 600;">üìä Preview</a></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 1rem; text-align: center; color: #666; font-size: 0.9rem;">
          Showing ${upcomingGames.length} remaining regular season game${upcomingGames.length !== 1 ? 's' : ''}
        </div>
      `;

      document.getElementById('scheduleContent').innerHTML = html;
    }

    function updateRecentResults(games) {
      const completedGames = games
        .filter(g => parseGameDate(g.date) < today && g.winner && g.winner.trim() !== "")
        .sort((a, b) => parseGameDate(b.date) - parseGameDate(a.date));

      if (completedGames.length === 0) {
        document.getElementById('resultsContent').innerHTML = 
          '<div class="no-data">No completed games yet this season.</div>';
        return;
      }

      const html = `
        <div style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
          <table class="schedule-table" style="margin-top: 0;">
            <thead style="position: sticky; top: 0; background-color: #f8f9fa; z-index: 10;">
              <tr><th>Date</th><th>Home Team</th><th>Score</th><th>Away Team</th><th>Winner</th><th>Type</th></tr>
            </thead>
            <tbody>
              ${completedGames.map(game => {
                const forfeit = game.forfeit === "Yes" ? " (Forfeit)" : "";
                let scoreDisplay = `${game["home score"]} - ${game["away score"]}`;
                
                if (game["home score"] === "W" && game["away score"] === "L") {
                  scoreDisplay = "W - L";
                } else if (game["home score"] === "L" && game["away score"] === "W") {
                  scoreDisplay = "L - W";
                }

                return `
                  <tr class="${game.game_type === 'Playoff' ? 'playoff-game' : ''}">
                    <td class="game-date">${game.date}</td>
                    <td class="team-name">${game["home team"]}</td>
                    <td class="game-score">${scoreDisplay}${forfeit}</td>
                    <td class="team-name">${game["away team"]}</td>
                    <td class="winner">${game.winner}</td>
                    <td>${game.game_type}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
        <div style="margin-top: 1rem; text-align: center; color: #666; font-size: 0.9rem;">
          Showing all ${completedGames.length} completed games (scroll to view more)
        </div>
      `;

      document.getElementById('resultsContent').innerHTML = html;
    }

    function updatePlayoffBracket(games) {
      const completedGames = games.filter(g => 
        g.winner && g.winner.trim() !== "" && parseGameDate(g.date) < today
      );
      
      const regularGames = completedGames.filter(g => g.game_type === 'Regular');
      const standings = calculateStandings(regularGames);
      
      if (standings.length < 10) {
        document.getElementById('bracketContent').innerHTML = `
          <div class="no-data">
            <h4>Projected Playoff Bracket</h4>
            <p>Need at least 10 teams to generate playoff bracket. Currently have ${standings.length} teams.</p>
          </div>
        `;
        return;
      }

      const playoffTeams = standings.slice(0, 10);
      
      const html = `
        <div class="bracket-title">Projected Double Elimination Playoff Bracket</div>
        <div class="bracket-section">
          <h4>Playoff Seeding (Top 10 Teams)</h4>
          <table class="bracket-table">
            <thead>
              <tr><th>Seed</th><th>Team</th><th>Record</th><th>Win%</th><th>SOS</th><th>Rem SOS</th><th>Run Diff</th></tr>
            </thead>
            <tbody>
              ${playoffTeams.map((team, index) => {
                const sosFormatted = formatScheduleStrength(team.scheduleStrength);
                const remSosFormatted = formatScheduleStrength(team.remainingScheduleStrength);
                return `
                  <tr>
                    <td><strong>${index + 1}</strong></td>
                    <td class="team-name">${team.name}</td>
                    <td>${team.wins}-${team.losses}${team.ties > 0 ? `-${team.ties}` : ''}</td>
                    <td class="win-pct">${(team.winPct * 100).toFixed(1)}%</td>
                    <td class="schedule-strength ${sosFormatted.class}">${sosFormatted.value}</td>
                    <td class="schedule-strength ${remSosFormatted.class}">${remSosFormatted.value}</td>
                    <td style="color: ${team.runDifferential >= 0 ? '#28a745' : '#dc3545'}">
                      ${team.runDifferential >= 0 ? '+' : ''}${team.runDifferential}
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>

        <div class="bracket-section">
          <h4>First Round Playoff Matchups</h4>
          <div class="bracket-visual">
            <div class="bracket-round">
              <h4>First Round - Game 1</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#1</strong> ${playoffTeams[0].name}</span>
                  <span>${playoffTeams[0].wins}-${playoffTeams[0].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span>Winner of <strong>8v9</strong></span>
                  <span>TBD</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  #1 vs Winner of 8v9
                </div>
              </div>
            </div>

            <div class="bracket-round">
              <h4>First Round - Game 2</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#2</strong> ${playoffTeams[1].name}</span>
                  <span>${playoffTeams[1].wins}-${playoffTeams[1].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span>Winner of <strong>7v10</strong></span>
                  <span>TBD</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  #2 vs Winner of 7v10
                </div>
              </div>
            </div>

            <div class="bracket-round">
              <h4>First Round - Game 3</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#3</strong> ${playoffTeams[2].name}</span>
                  <span>${playoffTeams[2].wins}-${playoffTeams[2].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span><strong>#6</strong> ${playoffTeams[5].name}</span>
                  <span>${playoffTeams[5].wins}-${playoffTeams[5].losses}</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  #3 vs #6
                </div>
              </div>
            </div>

            <div class="bracket-round">
              <h4>First Round - Game 4</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#4</strong> ${playoffTeams[3].name}</span>
                  <span>${playoffTeams[3].wins}-${playoffTeams[3].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span><strong>#5</strong> ${playoffTeams[4].name}</span>
                  <span>${playoffTeams[4].wins}-${playoffTeams[4].losses}</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  #4 vs #5
                </div>
              </div>
            </div>
          </div>

          <h4>Play-in Games (Determine First Round Participants)</h4>
          <div class="bracket-visual">
            <div class="bracket-round">
              <h4>Play-in Game 1</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#7</strong> ${playoffTeams[6].name}</span>
                  <span>${playoffTeams[6].wins}-${playoffTeams[6].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span><strong>#10</strong> ${playoffTeams[9].name}</span>
                  <span>${playoffTeams[9].wins}-${playoffTeams[9].losses}</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  Winner faces #2 in First Round
                </div>
              </div>
            </div>

            <div class="bracket-round">
              <h4>Play-in Game 2</h4>
              <div class="matchup">
                <div class="team-in-bracket">
                  <span><strong>#8</strong> ${playoffTeams[7].name}</span>
                  <span>${playoffTeams[7].wins}-${playoffTeams[7].losses}</span>
                </div>
                <div class="team-in-bracket">
                  <span><strong>#9</strong> ${playoffTeams[8].name}</span>
                  <span>${playoffTeams[8].wins}-${playoffTeams[8].losses}</span>
                </div>
                <div style="text-align: center; margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                  Winner faces #1 in First Round
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bracket-section">
          <div class="no-data">
            <p><em>Double elimination format: Teams are eliminated after losing 2 games. 
            Play-in games determine final bracket positioning.</em></p>
            <p><strong>Schedule Strength (SOS)</strong> is shown for reference but does not affect playoff seeding, which follows league tiebreaker rules.</p>
          </div>
        </div>
      `;

      document.getElementById('bracketContent').innerHTML = html;
    }

    function showError() {
      const errorHtml = '<div class="no-data">Error loading season data. Please try again later.</div>';
      document.getElementById('standingsContent').innerHTML = errorHtml;
      document.getElementById('leadersContent').innerHTML = errorHtml;
      document.getElementById('scheduleContent').innerHTML = errorHtml;
      document.getElementById('resultsContent').innerHTML = errorHtml;
      document.getElementById('bracketContent').innerHTML = errorHtml;
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>
