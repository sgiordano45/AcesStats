<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Current Season Team - Aces Stats</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
  }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    line-height: 1.6;
    color: var(--text-dark);
  }
  
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  /* Loading Spinner */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: '‚öæ';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0%, 100% { 
      transform: rotate(0deg) scale(1); 
    }
    50% { 
      transform: rotate(180deg) scale(1.1); 
    }
  }
  
  /* Team Header */
  .team-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 4rem 2rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 2rem;
    position: relative;
    overflow: hidden;
  }
  
  .team-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -10%;
    width: 500px;
    height: 500px;
    background: radial-gradient(circle, rgba(255,255,255,0.15) 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .team-header::after {
    content: '‚öæ';
    position: absolute;
    bottom: -30px;
    left: -30px;
    font-size: 200px;
    opacity: 0.08;
    transform: rotate(-15deg);
  }
  
  .team-logo {
    height: 120px;
    max-width: 120px;
    object-fit: contain;
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    background: rgba(255,255,255,0.15);
    padding: 1rem;
    display: none;
    transition: all 0.4s ease;
    z-index: 1;
  }
  
  .team-logo.loaded {
    display: block;
    animation: fadeInScale 0.6s ease backwards;
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  .team-info {
    flex: 1;
    z-index: 1;
  }
  
  .team-header h1 {
    margin: 0;
    font-size: 3rem;
    font-weight: 800;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    animation: fadeInUp 0.6s ease backwards 0.1s;
  }
  
  .season-info {
    font-size: 1.1rem;
    opacity: 0.95;
    margin: 1rem 0 0 0;
    font-weight: 500;
    animation: fadeInUp 0.6s ease backwards 0.2s;
  }

  .quick-stats {
    display: flex;
    gap: 2rem;
    margin-top: 1.5rem;
    animation: fadeInUp 0.6s ease backwards 0.3s;
  }

  .quick-stat {
    text-align: center;
  }

  .quick-stat-value {
    font-size: 2rem;
    font-weight: 800;
    display: block;
    color: var(--accent-color);
    text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  }

  .quick-stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    font-weight: 600;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Navigation */
  .filters-nav {
    background: var(--card-bg);
    padding: 1.5rem;
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    animation: fadeInUp 0.6s ease backwards 0.4s;
  }

  .nav-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    justify-content: center;
  }

  .nav-link {
    padding: 1rem 1.75rem;
    border: 2px solid var(--primary-color);
    background: white;
    color: var(--primary-color);
    text-decoration: none;
    border-radius: 12px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    white-space: nowrap;
    position: relative;
    overflow: hidden;
    z-index: 1;
  }

  .nav-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: -1;
  }

  .nav-link:hover::before {
    transform: translateX(0);
  }

  .nav-link:hover {
    color: white;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--secondary-color);
  }

  /* Section Styling */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    border: 1px solid var(--border-color);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInUp 0.6s ease backwards;
  }

  .section:nth-child(5) { animation-delay: 0.5s; }
  .section:nth-child(6) { animation-delay: 0.6s; }
  .section:nth-child(7) { animation-delay: 0.7s; }
  .section:nth-child(8) { animation-delay: 0.8s; }

  .section:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .section-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.5rem 2rem;
    font-size: 1.5rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.8rem;
    position: relative;
    flex-wrap: wrap;
  }

  .section-header-title {
    display: flex;
    align-items: center;
    gap: 0.8rem;
  }

  .section-header::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-color);
  }

  /* Calendar Button Styles */
  .calendar-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.5rem 1rem;
    background: rgba(255,255,255,0.2);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
    border-radius: 8px;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    backdrop-filter: blur(4px);
  }

  .calendar-btn:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-1px);
  }

  .calendar-dropdown {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 0.5rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 200px;
    overflow: hidden;
  }

  .calendar-dropdown-content {
    padding: 0.5rem;
  }

  .calendar-option {
    display: block;
    width: 100%;
    padding: 0.75rem 1rem;
    background: none;
    border: none;
    text-align: left;
    font-size: 0.9rem;
    color: var(--text-dark);
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .calendar-option:hover {
    background: #f5f5f5;
  }

  .calendar-container {
    position: relative;
  }

  /* Calendar Modal Styles */
  .calendar-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 1rem;
  }

  .calendar-modal-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    color: var(--text-dark);
  }

  .calendar-modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: #666;
  }

  .calendar-modal-content h3 {
    margin: 0 0 1rem;
    color: #333;
  }

  .calendar-url-box {
    display: flex;
    gap: 0.5rem;
    margin: 1rem 0;
  }

  .calendar-url-box input {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 0.85rem;
    font-family: monospace;
  }

  .calendar-url-box .copy-btn {
    padding: 0.75rem 1rem;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
  }

  .calendar-instructions details {
    margin-bottom: 0.5rem;
  }

  .calendar-instructions summary {
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    list-style: none;
  }

  .calendar-instructions summary::-webkit-details-marker {
    display: none;
  }

  .calendar-instructions details[open] summary {
    border-radius: 8px 8px 0 0;
  }

  .calendar-instructions ol {
    margin: 0;
    padding: 1rem 1rem 1rem 2rem;
    background: #f8f9fa;
    border-radius: 0 0 8px 8px;
  }

  .calendar-instructions li {
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .calendar-note {
    padding: 1rem;
    background: #e8f5e9;
    border-radius: 8px;
    font-size: 0.9rem;
    margin-top: 1rem;
  }

  .calendar-toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #333;
    color: white;
    padding: 1rem 1.5rem;
    border-radius: 8px;
    font-size: 0.95rem;
    opacity: 0;
    transition: all 0.3s ease;
    z-index: 10001;
  }

  .calendar-toast.show {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  @media (max-width: 600px) {
    .section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 1rem;
    }
    
    .calendar-btn {
      align-self: flex-start;
    }
    
    .calendar-dropdown {
      left: 0;
      right: auto;
    }

    .calendar-modal-content {
      padding: 1.5rem;
    }

    .calendar-url-box {
      flex-direction: column;
    }
  }

  .section-content {
    padding: 2rem;
  }

  /* Roster Grid */
  .roster-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 1.5rem;
  }

  .player-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    border-left: 4px solid var(--primary-color);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow-sm);
    position: relative;
    overflow: hidden;
  }

  .player-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .player-card:hover::before {
    opacity: 1;
  }

  .player-card::after {
    content: '‚öæ';
    position: absolute;
    bottom: -15px;
    right: -15px;
    font-size: 80px;
    opacity: 0;
    color: var(--primary-color);
    transition: all 0.4s ease;
  }

  .player-card:hover {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    transform: translateY(-6px);
    box-shadow: var(--shadow-md);
    border-left-color: var(--secondary-color);
  }

  .player-card:hover::after {
    opacity: 0.05;
    bottom: -10px;
    right: -10px;
  }

  .player-name {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
    color: var(--text-dark);
  }

  .player-name a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s ease;
  }

  .player-name a:hover {
    color: var(--primary-color);
  }

  .player-stats {
    font-size: 0.9rem;
    color: var(--text-light);
    font-weight: 500;
  }

  /* Tables */
  .stats-table, .schedule-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }

  .stats-table th, .schedule-table th,
  .stats-table td, .schedule-table td {
    padding: 14px 10px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
    transition: background-color 0.2s ease;
  }

  .stats-table th, .schedule-table th {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    font-weight: 700;
    color: var(--text-dark);
    text-align: center;
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--primary-color);
  }

  .stats-table tr:nth-child(even), 
  .schedule-table tr:nth-child(even) {
    background-color: #fafbfc;
  }

  .stats-table tr:hover, 
  .schedule-table tr:hover {
    background: linear-gradient(135deg, #f0f4f8 0%, #e9f0f7 100%);
  }

  .player-link {
    color: var(--primary-color);
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s ease;
  }

  .player-link:hover {
    color: var(--secondary-color);
    text-decoration: underline;
  }

  /* Game Results */
  .upcoming-game {
    background: linear-gradient(135deg, #fff8dc 0%, #fffacd 100%) !important;
    border-left: 4px solid var(--accent-color);
  }

  .completed-game {
    opacity: 0.85;
  }

  .win-result {
    color: #22c55e;
    font-weight: 800;
    text-shadow: 0 1px 2px rgba(34, 197, 94, 0.2);
  }

  .loss-result {
    color: #ef4444;
    font-weight: 800;
    text-shadow: 0 1px 2px rgba(239, 68, 68, 0.2);
  }

  .tie-result {
    color: #6b7280;
    font-weight: 800;
  }

  /* Loading and Empty States */
  .loading {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
    font-style: italic;
    font-size: 1.1rem;
  }

  .no-data {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--text-light);
    font-size: 1.1rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 2px dashed var(--border-color);
  }

  .table-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 12px;
  }

  .table-container::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }

  .table-container::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 12px;
  }

  .table-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    border-radius: 12px;
  }

  .table-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
  }

  /* Summary Stats Cards */
  .summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border-radius: 12px;
    padding: 1.75rem 1.25rem;
    text-align: center;
    border-left: 4px solid var(--primary-color);
    box-shadow: var(--shadow-sm);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }

  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .stat-card:hover::before {
    opacity: 1;
  }

  .stat-card:hover {
    transform: translateY(-6px);
    box-shadow: var(--shadow-md);
    border-left-color: var(--secondary-color);
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-dark);
    display: block;
    margin-bottom: 0.5rem;
  }

  .stat-label {
    font-size: 0.9rem;
    color: var(--text-light);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* Swipe Indicator */
  .swipe-indicator {
    text-align: center;
    padding: 0.75rem;
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    font-size: 0.85rem;
    font-weight: 600;
    border-bottom: 2px solid var(--accent-color);
    display: none;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .page-container {
      padding: 1rem;
    }
    
    .team-header {
      flex-direction: column;
      text-align: center;
      padding: 2.5rem 1.5rem;
    }
    
    .team-header h1 {
      font-size: 2rem;
    }

    .team-header::after {
      font-size: 150px;
      bottom: -20px;
      left: -20px;
    }

    .quick-stats {
      justify-content: center;
      flex-wrap: wrap;
    }

    .quick-stat-value {
      font-size: 1.6rem;
    }
    
    .roster-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
    }

    .section-header {
      font-size: 1.2rem;
      padding: 1.25rem 1.5rem;
    }

    .section-content {
      padding: 1.5rem;
    }

    .stats-table th,
    .stats-table td,
    .schedule-table th,
    .schedule-table td {
      padding: 10px 6px;
      font-size: 0.85rem;
    }

    .summary-stats {
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 1rem;
    }

    .stat-value {
      font-size: 1.6rem;
    }

    .swipe-indicator {
      display: block;
    }

    .nav-link {
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
    }
  }
</style>
<link rel="stylesheet" href="mobile-enhancements.css">
</head>
<body>
<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="softball-spinner"></div>
</div>

<div class="page-container">
  
  <div class="team-header">
    <img id="team-logo" class="team-logo" src="" alt="" onerror="this.style.display='none';">
    
    <div class="team-info">
      <h1><span id="team-name">Loading...</span></h1>
      <p class="season-info" id="season-info">Loading season...</p>
      <div class="quick-stats">
        <div class="quick-stat">
          <span class="quick-stat-value" id="team-record">--</span>
          <span class="quick-stat-label">Record</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="team-standing">--</span>
          <span class="quick-stat-label">Standing</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-value" id="games-remaining">--</span>
          <span class="quick-stat-label">Games Left</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="filters-nav">

  </div>

  <!-- Team Summary Stats -->
  <div class="section">
    <div class="section-header">
      üìä Season Summary
    </div>
    <div class="section-content">
      <div class="summary-stats" id="summary-stats">
        <div class="loading">Loading team statistics...</div>
      </div>
    </div>
  </div>

  <!-- Current Roster -->
  <div class="section">
    <div class="section-header">
      üë• Current Roster
    </div>
    <div class="section-content">
      <div class="roster-grid" id="roster-grid">
        <div class="loading">Loading roster...</div>
      </div>
    </div>
  </div>

  <!-- Player Stats -->
  <div class="section">
    <div class="section-header">
      üìà Player Statistics
    </div>
    <div class="section-content">
      <div class="table-container">
        <div class="swipe-indicator">‚Üê Swipe left/right to see all columns ‚Üí</div>
        <table class="stats-table" id="player-stats-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>G</th>
              <th>AB</th>
              <th>H</th>
              <th>R</th>
              <th>BB</th>
              <th>BA</th>
              <th>OBP</th>
              <th>AcesBPI</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="9" class="loading">Loading player stats...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Team Schedule -->
  <div class="section">
    <div class="section-header">
      <span class="section-header-title">üìÖ Season Schedule & Results</span>
      <div class="calendar-container" id="calendar-container"></div>
    </div>
    <div class="section-content">
      <div class="table-container">
        <div class="swipe-indicator">‚Üê Swipe left/right to see all columns ‚Üí</div>
        <table class="schedule-table" id="schedule-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Opponent</th>
              <th>H/A</th>
              <th>Score</th>
              <th>Result</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody>
            <tr><td colspan="6" class="loading">Loading schedule...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script type="module">
  console.log('üöÄ Script started - loading Firebase data...');
  
  // Hide loading overlay when page loads
  window.addEventListener('load', function() {
    setTimeout(function() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }, 800);
  });
  
  // Import Firebase helper functions
  import {
    getSeasonGames,
    getSeasonPlayerStatsOptimized,
    getSeasonPitchingStatsOptimized,
    getCurrentSeason
  } from './firebase-data.js';
    
  console.log('‚úÖ Imports successful!');

  // Mobile menu toggle
  function toggleMobileMenu() {
    const menu = document.getElementById('mobileNavMenu');
    menu.classList.toggle('open');
  }
  window.toggleMobileMenu = toggleMobileMenu;

  // Global variables
  let teamName = "";
  let allGames = [];
  let playerData = [];
  let currentSeasonData = null;
  const today = new Date();

  // Get team name from URL
  const params = new URLSearchParams(window.location.search);
  teamName = params.get("team");

  if (!teamName) {
    document.body.innerHTML = '<div class="page-container"><h1>Error: Team not specified</h1><p><a href="current-season.html">Return to current season</a></p></div>';
  } else {
    loadTeamData();
  }

  // Helper function to capitalize
  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

  async function loadTeamData() {
    try {
      console.log('üìä Loading team data from Firebase...');
      
      // Get current season
      currentSeasonData = await getCurrentSeason();
      console.log('‚úÖ Current season:', currentSeasonData);
      
      const seasonId = currentSeasonData.id;
      
      // Update season info in header
      document.getElementById("season-info").textContent = 
        `${currentSeasonData.year} ${capitalize(currentSeasonData.season)} Season Performance`;
      
      // Fetch all data
      const [games, batting, pitching] = await Promise.all([
        getSeasonGames(seasonId),
        getSeasonPlayerStatsOptimized(seasonId),
        getSeasonPitchingStatsOptimized(seasonId)
      ]);
      
      console.log(`‚úÖ Fetched: ${games?.length || 0} games, ${batting?.length || 0} batting records`);
      
      // Map games to expected format
      allGames = (games || []).map(g => {
        let dateString = "";
        if (g.date && g.date.seconds) {
          const dateObj = new Date(g.date.seconds * 1000);
          dateString = dateObj.toLocaleDateString('en-US');
        } else if (g.date) {
          dateString = g.date;
        }
        
        return {
          "home team": g.homeTeamName || capitalize(g.homeTeamId) || "",
          "away team": g.awayTeamName || capitalize(g.awayTeamId) || "",
          "home score": g.homeScore !== undefined ? g.homeScore : null,
          "away score": g.awayScore !== undefined ? g.awayScore : null,
          winner: capitalize(g.winner),
          game_type: g.gameType === "regular" ? "Regular" :
                     g.gameType === "playoff" ? "Playoff" :
                     capitalize(g.gameType) || "Regular",
          date: dateString,
          year: currentSeasonData.year.toString(),
          season: capitalize(currentSeasonData.season),
          forfeit: g.forfeit ? "Yes" : "No"
        };
      });
      
      console.log('‚úÖ Mapped games:', allGames.length);
      
      // Map batting data - filter for this specific team
      // ‚úÖ FIX #1: Add id field to playerData mapping
      playerData = (batting || [])
        .filter(p => {
          const playerTeam = p.team || p.currentTeam || "";
          return playerTeam.toLowerCase() === teamName.toLowerCase();
        })
        .map(p => ({
          id: p.id || p.playerId,  // ‚Üê CRITICAL: preserve player ID
          name: p.playerName || p.name || p.id,
          team: teamName,
          games: Number(p.games) || 0,
          atBats: Number(p.atBats) || 0,
          hits: Number(p.hits) || 0,
          runs: Number(p.runs) || 0,
          walks: Number(p.walks) || 0,
          acesBPI: p.acesBPI || "N/A",
          battingAverage: p.battingAverage || 0,
          onBasePercentage: p.onBasePercentage || 0
        }));
      
      console.log(`‚úÖ Filtered to ${playerData.length} players on team ${teamName}`);
      
      // Initialize page
      initializePage();
      
    } catch (error) {
      console.error('‚ùå Error loading team data:', error);
      document.body.innerHTML = `
        <div class="page-container">
          <h1>Error loading team data</h1>
          <p>Could not load statistics. Please try again later.</p>
          <p><a href="current-season.html">Return to current season</a></p>
        </div>
      `;
    }
  }

  function parseGameDate(dateStr) {
    return new Date(dateStr);
  }

  function initializePage() {
    // Update page elements
    document.title = `${teamName} - ${currentSeasonData.year} ${capitalize(currentSeasonData.season)} Season`;
    document.getElementById("team-name").textContent = teamName;
    
    // Load team logo
    loadTeamLogo();
    
    // Calculate team record and standings position
    updateTeamHeader();
    
    // Update all sections
    updateSummaryStats();
    updateRoster();
    updatePlayerStats();
    updateSchedule();
    
    // Initialize calendar subscription button
    initCalendarButton();
  }

  // Calendar subscription functionality
  const CALENDAR_FUNCTION_URL = 'https://us-central1-acessoftballreference-84791.cloudfunctions.net/calendar';

  function initCalendarButton() {
    const container = document.getElementById('calendar-container');
    if (!container || !teamName) return;
    
    container.innerHTML = `
      <button class="calendar-btn" id="calendarBtn">
        üóìÔ∏è Add to Calendar
      </button>
      <div class="calendar-dropdown" id="calendarDropdown" style="display: none;">
        <div class="calendar-dropdown-content">
          <button class="calendar-option" data-action="subscribe">
            üîó Subscribe (auto-updates)
          </button>
          <button class="calendar-option" data-action="download">
            ‚¨áÔ∏è Download .ics file
          </button>
          <button class="calendar-option" data-action="google">
            üìÜ Add to Google Calendar
          </button>
          <hr style="margin: 0.5rem 0; border-color: #eee;">
          <button class="calendar-option" data-action="copy">
            üìã Copy subscription URL
          </button>
        </div>
      </div>
    `;
    
    const btn = document.getElementById('calendarBtn');
    const dropdown = document.getElementById('calendarDropdown');
    
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    });
    
    // Handle dropdown options
    container.querySelectorAll('.calendar-option').forEach(opt => {
      opt.addEventListener('click', (e) => {
        e.stopPropagation();
        handleCalendarAction(opt.dataset.action);
        dropdown.style.display = 'none';
      });
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      dropdown.style.display = 'none';
    });
  }

  function getCalendarUrl() {
    return `${CALENDAR_FUNCTION_URL}?team=${encodeURIComponent(teamName)}`;
  }

  function handleCalendarAction(action) {
    const url = getCalendarUrl();
    
    switch (action) {
      case 'subscribe':
        showSubscribeModal(url);
        break;
      case 'download':
        window.open(url, '_blank');
        break;
      case 'google':
        // Use webcal:// protocol which Google Calendar handles better
        const webcalUrl = url.replace('https://', 'webcal://');
        window.open(`https://calendar.google.com/calendar/r?cid=${encodeURIComponent(webcalUrl)}`, '_blank');
        break;
      case 'copy':
        copyToClipboard(url);
        break;
    }
  }

  function showSubscribeModal(url) {
    const modal = document.createElement('div');
    modal.className = 'calendar-modal';
    modal.innerHTML = `
      <div class="calendar-modal-content">
        <button class="calendar-modal-close">&times;</button>
        <h3>üìÖ Subscribe to ${teamName} Calendar</h3>
        <p>Copy this URL and add it as a subscription in your calendar app:</p>
        
        <div class="calendar-url-box">
          <input type="text" value="${url}" readonly id="calendarUrlInput">
          <button class="copy-btn" id="copyUrlBtn">Copy</button>
        </div>
        
        <div class="calendar-instructions">
          <h4 style="margin: 1rem 0;">Instructions:</h4>
          
          <details>
            <summary><strong>üì± iPhone/iOS Calendar</strong></summary>
            <ol>
              <li>Go to Settings ‚Üí Calendar ‚Üí Accounts</li>
              <li>Tap "Add Account" ‚Üí "Other"</li>
              <li>Tap "Add Subscribed Calendar"</li>
              <li>Paste the URL above</li>
              <li>Tap "Next" then "Save"</li>
            </ol>
          </details>
          
          <details>
            <summary><strong>üìÜ Google Calendar</strong></summary>
            <ol>
              <li>Open Google Calendar on web</li>
              <li>Click the + next to "Other calendars"</li>
              <li>Select "From URL"</li>
              <li>Paste the URL above</li>
              <li>Click "Add calendar"</li>
            </ol>
          </details>
          
          <details>
            <summary><strong>üìß Outlook</strong></summary>
            <ol>
              <li>Go to Calendar view</li>
              <li>Click "Add calendar" ‚Üí "From Internet"</li>
              <li>Paste the URL above</li>
              <li>Click "OK"</li>
            </ol>
          </details>
          
          <details>
            <summary><strong>üçé Mac Calendar</strong></summary>
            <ol>
              <li>Open Calendar app</li>
              <li>File ‚Üí New Calendar Subscription</li>
              <li>Paste the URL above</li>
              <li>Click "Subscribe"</li>
            </ol>
          </details>
        </div>
        
        <p class="calendar-note">
          <strong>Note:</strong> Subscribed calendars auto-update! 
          Any schedule changes will appear automatically within an hour.
        </p>
      </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.querySelector('.calendar-modal-close').addEventListener('click', () => modal.remove());
    modal.addEventListener('click', (e) => {
      if (e.target === modal) modal.remove();
    });
    
    modal.querySelector('#copyUrlBtn').addEventListener('click', () => {
      const input = modal.querySelector('#calendarUrlInput');
      input.select();
      navigator.clipboard.writeText(input.value).then(() => {
        modal.querySelector('#copyUrlBtn').textContent = 'Copied!';
        setTimeout(() => {
          modal.querySelector('#copyUrlBtn').textContent = 'Copy';
        }, 2000);
      });
    });
  }

  async function copyToClipboard(url) {
    try {
      await navigator.clipboard.writeText(url);
      showToast('Calendar URL copied to clipboard!');
    } catch (err) {
      // Fallback
      const input = document.createElement('input');
      input.value = url;
      document.body.appendChild(input);
      input.select();
      document.execCommand('copy');
      document.body.removeChild(input);
      showToast('Calendar URL copied to clipboard!');
    }
  }

  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'calendar-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function loadTeamLogo() {
    const logoElement = document.getElementById("team-logo");
    
    logoElement.src = `logos/${teamName.toLowerCase().replace(/\s+/g, '_')}.png`;
    logoElement.alt = `${teamName} logo`;
    
    logoElement.onload = function() {
      this.classList.add('loaded');
      this.style.display = 'block';
    };
    
    logoElement.onerror = function() {
      this.style.display = 'none';
    };
  }

  function updateTeamHeader() {
    // Calculate team record
    const teamGames = allGames.filter(g => 
      (g["home team"] === teamName || g["away team"] === teamName) && 
      g.winner && g.winner.trim() !== "" &&
      parseGameDate(g.date) < today
    );
    
    let wins = 0, losses = 0, ties = 0;
    teamGames.forEach(game => {
      if (game.winner === teamName) wins++;
      else if (game.winner === "Tie") ties++;
      else losses++;
    });

    const recordText = `${wins}-${losses}` + (ties > 0 ? `-${ties}` : '');
    document.getElementById("team-record").textContent = recordText;

    // Calculate remaining games
    const upcomingGames = allGames.filter(g => {
      const gameDate = parseGameDate(g.date);
      const isFuture = gameDate >= today;
      const noWinner = !g.winner || g.winner.trim() === "";
      const teamInvolved = (g["home team"] === teamName || g["away team"] === teamName);
      const isRegular = g.game_type === 'Regular';
      
      return isFuture && noWinner && teamInvolved && isRegular;
    });

    document.getElementById("games-remaining").textContent = upcomingGames.length;

    // Calculate current standings position
    const standingsPosition = calculateTeamStandingsPosition();
    document.getElementById("team-standing").textContent = standingsPosition;
  }

  function calculateTeamStandingsPosition() {
    const completedGames = allGames.filter(g => 
      parseGameDate(g.date) < today && 
      g.winner && 
      g.winner.trim() !== "" && 
      g.game_type === 'Regular'
    );
    
    if (completedGames.length === 0) return "TBD";

    const teamStats = {};

    completedGames.forEach(game => {
      const homeTeam = game["home team"];
      const awayTeam = game["away team"];
      const winner = game.winner;
      const homeScore = parseInt(game["home score"]) || 0;
      const awayScore = parseInt(game["away score"]) || 0;

      if (!teamStats[homeTeam]) {
        teamStats[homeTeam] = { 
          name: homeTeam, wins: 0, losses: 0, ties: 0, 
          runsFor: 0, runsAgainst: 0, h2h: {}
        };
      }
      if (!teamStats[awayTeam]) {
        teamStats[awayTeam] = { 
          name: awayTeam, wins: 0, losses: 0, ties: 0, 
          runsFor: 0, runsAgainst: 0, h2h: {}
        };
      }

      teamStats[homeTeam].runsFor += homeScore;
      teamStats[homeTeam].runsAgainst += awayScore;
      teamStats[awayTeam].runsFor += awayScore;
      teamStats[awayTeam].runsAgainst += homeScore;

      if (!teamStats[homeTeam].h2h[awayTeam]) {
        teamStats[homeTeam].h2h[awayTeam] = { wins: 0, losses: 0, ties: 0 };
      }
      if (!teamStats[awayTeam].h2h[homeTeam]) {
        teamStats[awayTeam].h2h[homeTeam] = { wins: 0, losses: 0, ties: 0 };
      }

      if (winner === "Tie") {
        teamStats[homeTeam].ties++;
        teamStats[awayTeam].ties++;
        teamStats[homeTeam].h2h[awayTeam].ties++;
        teamStats[awayTeam].h2h[homeTeam].ties++;
      } else if (winner === homeTeam) {
        teamStats[homeTeam].wins++;
        teamStats[awayTeam].losses++;
        teamStats[homeTeam].h2h[awayTeam].wins++;
        teamStats[awayTeam].h2h[homeTeam].losses++;
      } else if (winner === awayTeam) {
        teamStats[awayTeam].wins++;
        teamStats[homeTeam].losses++;
        teamStats[awayTeam].h2h[homeTeam].wins++;
        teamStats[homeTeam].h2h[awayTeam].losses++;
      }
    });

    const standings = Object.values(teamStats)
      .map(team => {
        const totalDecided = team.wins + team.losses;
        team.winPct = totalDecided > 0 ? (team.wins / totalDecided) : 0;
        team.runDifferential = team.runsFor - team.runsAgainst;
        return team;
      })
      .sort((a, b) => {
        if (a.winPct !== b.winPct) return b.winPct - a.winPct;
        const h2hComp = compareHeadToHead(a, b);
        if (h2hComp !== 0) return h2hComp;
        if (a.runsAgainst !== b.runsAgainst) return a.runsAgainst - b.runsAgainst;
        return b.runDifferential - a.runDifferential;
      });

    const teamPosition = standings.findIndex(team => team.name === teamName) + 1;
    return teamPosition > 0 ? `${teamPosition}${getOrdinalSuffix(teamPosition)}` : "NR";
  }

  function compareHeadToHead(teamA, teamB) {
    const aVsB = teamA.h2h[teamB.name];
    const bVsA = teamB.h2h[teamA.name];
    
    if (!aVsB || !bVsA) return 0;
    
    const aH2HWinPct = (aVsB.wins + aVsB.losses) > 0 ? aVsB.wins / (aVsB.wins + aVsB.losses) : 0;
    const bH2HWinPct = (bVsA.wins + bVsA.losses) > 0 ? bVsA.wins / (bVsA.wins + bVsA.losses) : 0;
    
    return bH2HWinPct - aH2HWinPct;
  }

  function getOrdinalSuffix(num) {
    const j = num % 10;
    const k = num % 100;
    if (j === 1 && k !== 11) return "st";
    if (j === 2 && k !== 12) return "nd";
    if (j === 3 && k !== 13) return "rd";
    return "th";
  }

  function updateSummaryStats() {
    const element = document.getElementById("summary-stats");
    element.classList.remove('loading');
    
    let totalGames = 0, totalAB = 0, totalHits = 0, totalRuns = 0, totalWalks = 0;
    
    playerData.forEach(p => {
      totalGames += Number(p.games) || 0;
      totalAB += Number(p.atBats) || 0;
      totalHits += Number(p.hits) || 0;
      totalRuns += Number(p.runs) || 0;
      totalWalks += Number(p.walks) || 0;
    });

    const teamBA = totalAB > 0 ? (totalHits / totalAB).toFixed(3) : '.000';
    const teamOBP = (totalAB + totalWalks) > 0 ? ((totalHits + totalWalks) / (totalAB + totalWalks)).toFixed(3) : '.000';

    const teamGames = allGames.filter(g => 
      (g["home team"] === teamName || g["away team"] === teamName) && 
      g.winner && g.winner.trim() !== ""
    );

    let runsFor = 0, runsAgainst = 0;
    teamGames.forEach(game => {
      const homeScore = parseInt(game["home score"]) || 0;
      const awayScore = parseInt(game["away score"]) || 0;
      
      if (game["home team"] === teamName) {
        runsFor += homeScore;
        runsAgainst += awayScore;
      } else {
        runsFor += awayScore;
        runsAgainst += homeScore;
      }
    });

    const runDiff = runsFor - runsAgainst;

    const summaryHTML = `
      <div class="stat-card">
        <span class="stat-value">${playerData.length}</span>
        <div class="stat-label">Active Players</div>
      </div>
      <div class="stat-card">
        <span class="stat-value">${teamBA}</span>
        <div class="stat-label">Team BA</div>
      </div>
      <div class="stat-card">
        <span class="stat-value">${teamOBP}</span>
        <div class="stat-label">Team OBP</div>
      </div>
      <div class="stat-card">
        <span class="stat-value">${runsFor}</span>
        <div class="stat-label">Runs For</div>
      </div>
      <div class="stat-card">
        <span class="stat-value">${runsAgainst}</span>
        <div class="stat-label">Runs Against</div>
      </div>
      <div class="stat-card">
        <span class="stat-value" style="color: ${runDiff >= 0 ? '#22c55e' : '#ef4444'}">
          ${runDiff >= 0 ? '+' : ''}${runDiff}
        </span>
        <div class="stat-label">Run Differential</div>
      </div>
    `;

    element.innerHTML = summaryHTML;
  }

  function updateRoster() {
    const element = document.getElementById("roster-grid");
    element.classList.remove('loading');
    
    if (playerData.length === 0) {
      element.innerHTML = '<div class="no-data">No players found for current season</div>';
      return;
    }

    // ‚úÖ FIX #2: Use player.id in the link
    const rosterHTML = playerData.map(player => {
      const ba = (Number(player.atBats) || 0) > 0 ? 
        ((Number(player.hits) || 0) / (Number(player.atBats) || 0)).toFixed(3) : '.000';
      
      return `
        <div class="player-card">
          <div class="player-name">
            <a href="player.html?id=${encodeURIComponent(player.id)}">${player.name}</a>
          </div>
          <div class="player-stats">
            ${player.games}G ‚Ä¢ ${ba} BA ‚Ä¢ ${player.runs}R
          </div>
        </div>
      `;
    }).join('');

    element.innerHTML = rosterHTML;
  }

  function updatePlayerStats() {
    const tbody = document.querySelector("#player-stats-table tbody");
    tbody.classList.remove('loading');
    
    if (playerData.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="no-data">No player statistics available</td></tr>';
      return;
    }

    const sortedPlayers = [...playerData].sort((a, b) => {
      const gamesA = Number(a.games) || 0;
      const gamesB = Number(b.games) || 0;
      if (gamesB !== gamesA) return gamesB - gamesA;
      
      const baA = (Number(a.atBats) || 0) > 0 ? (Number(a.hits) || 0) / (Number(a.atBats) || 0) : 0;
      const baB = (Number(b.atBats) || 0) > 0 ? (Number(b.hits) || 0) / (Number(b.atBats) || 0) : 0;
      return baB - baA;
    });

    // ‚úÖ FIX #3: Use player.id in the link
    const statsHTML = sortedPlayers.map(player => {
      const games = Number(player.games) || 0;
      const atBats = Number(player.atBats) || 0;
      const hits = Number(player.hits) || 0;
      const runs = Number(player.runs) || 0;
      const walks = Number(player.walks) || 0;
      
      const ba = atBats > 0 ? (hits / atBats).toFixed(3) : '.000';
      const obp = (atBats + walks) > 0 ? ((hits + walks) / (atBats + walks)).toFixed(3) : '.000';
      
      const acesBPIValue = player.acesBPI;
      const acesBPI = (acesBPIValue !== "N/A" && acesBPIValue !== null && acesBPIValue !== undefined && !isNaN(acesBPIValue)) 
        ? Number(acesBPIValue).toFixed(2) 
        : "N/A";

      return `
        <tr>
          <td><a href="player.html?id=${encodeURIComponent(player.id)}" class="player-link">${player.name}</a></td>
          <td style="text-align: center;">${games}</td>
          <td style="text-align: center;">${atBats}</td>
          <td style="text-align: center;">${hits}</td>
          <td style="text-align: center;">${runs}</td>
          <td style="text-align: center;">${walks}</td>
          <td style="text-align: center; font-weight: bold;">${ba}</td>
          <td style="text-align: center; font-weight: bold;">${obp}</td>
          <td style="text-align: center;">${acesBPI}</td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = statsHTML;
  }

  function updateSchedule() {
    const tbody = document.querySelector("#schedule-table tbody");
    tbody.classList.remove('loading');
    
    const teamGames = allGames.filter(g => 
      g["home team"] === teamName || g["away team"] === teamName
    );

    if (teamGames.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="no-data">No games found for current season</td></tr>';
      return;
    }

    const sortedGames = [...teamGames].sort((a, b) => {
      return parseGameDate(a.date) - parseGameDate(b.date);
    });

    const scheduleHTML = sortedGames.map(game => {
      const isHome = game["home team"] === teamName;
      const opponent = isHome ? game["away team"] : game["home team"];
      const homeAwayText = isHome ? "vs" : "@";
      
      const gameDate = parseGameDate(game.date);
      const isPast = gameDate < today;
      const hasResult = game.winner && game.winner.trim() !== "";
      
      let scoreDisplay = "-";
      let result = "-";
      let resultClass = "";
      let rowClass = "";

      if (hasResult && isPast) {
        rowClass = "completed-game";
        const homeScore = game["home score"];
        const awayScore = game["away score"];
        
        if (homeScore === "W" || homeScore === "L") {
          scoreDisplay = isHome ? homeScore : awayScore;
        } else {
          const teamScore = isHome ? homeScore : awayScore;
          const oppScore = isHome ? awayScore : homeScore;
          scoreDisplay = `${teamScore}-${oppScore}`;
        }

        if (game.winner === teamName) {
          result = "W";
          resultClass = "win-result";
        } else if (game.winner === "Tie") {
          result = "T";
          resultClass = "tie-result";
        } else {
          result = "L";
          resultClass = "loss-result";
        }
      } else if (!isPast) {
        rowClass = "upcoming-game";
      }

      return `
        <tr class="${rowClass}">
          <td>${game.date}</td>
          <td>${opponent}</td>
          <td style="text-align: center;">${homeAwayText}</td>
          <td style="text-align: center;">${scoreDisplay}</td>
          <td style="text-align: center;" class="${resultClass}">${result}</td>
          <td style="text-align: center;">${game.game_type}</td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = scheduleHTML;
  }
</script>
<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>