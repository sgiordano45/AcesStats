<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>League Staff Admin - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<!-- SheetJS for Excel parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --staff-color: #0369a1;
    --staff-secondary: #0284c7;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
    --whatsapp-color: #25D366;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    color: var(--text-dark);
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: '‚öôÔ∏è';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }

  /* Auth Gate */
  .auth-gate {
    max-width: 500px;
    margin: 4rem auto;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .auth-gate h2 {
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .auth-gate p {
    color: var(--text-light);
    margin-bottom: 2rem;
  }

  .auth-gate a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--staff-color) 0%, var(--staff-secondary) 100%);
    color: white;
    padding: 2.5rem 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .header::after {
    content: '‚öôÔ∏è';
    position: absolute;
    bottom: -40px;
    left: -30px;
    font-size: 180px;
    opacity: 0.08;
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .role-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }

  .role-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
  }

  .header-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .nav-btn {
    padding: 0.875rem 1.5rem;
    border: 2px solid white;
    background: white;
    color: var(--staff-color);
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .nav-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    transform: translateY(-2px);
  }

  /* Container */
  .container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  /* Tab Navigation */
  .tab-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    background: var(--card-bg);
    padding: 0.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
  }

  .tab-btn {
    flex: 1;
    min-width: 120px;
    padding: 1rem 1.5rem;
    border: none;
    background: transparent;
    color: var(--text-light);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .tab-btn:hover {
    background: #f1f5f9;
    color: var(--text-dark);
  }

  .tab-btn.active {
    background: var(--staff-color);
    color: white;
  }

  .tab-btn .icon {
    font-size: 1.2rem;
  }

  /* Tab Content */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Section Cards */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .section-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-content {
    padding: 1.5rem;
  }

  /* Season Selector */
  .season-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .season-selector label {
    font-weight: 600;
  }

  .season-selector select {
    width: auto;
    min-width: 200px;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  input, select, textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--staff-color);
    box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
  }

  .hint {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .checkbox-group input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    accent-color: var(--staff-color);
  }

  .checkbox-group label {
    margin: 0;
    cursor: pointer;
  }

  /* Buttons */
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--staff-color);
    color: white;
  }

  .btn-primary:hover {
    background: var(--staff-secondary);
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #16a34a;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-secondary {
    background: #e2e8f0;
    color: var(--text-dark);
  }

  .btn-secondary:hover {
    background: #cbd5e1;
  }

  .btn-whatsapp {
    background: var(--whatsapp-color);
    color: white;
  }

  .btn-whatsapp:hover {
    background: #128C7E;
  }

  .btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  /* Item List */
  .item-list {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    max-height: 350px;
    overflow-y: auto;
  }

  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .item-row:last-child {
    border-bottom: none;
  }

  .item-row:hover {
    background: #f8fafc;
  }

  .item-row.selected {
    background: #e0f2fe;
    border-left: 3px solid var(--staff-color);
  }

  .item-info {
    flex: 1;
  }

  .item-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .item-subtitle {
    font-size: 0.85rem;
    color: var(--text-light);
  }

  .item-badges {
    display: flex;
    gap: 0.5rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-active {
    background: #dcfce7;
    color: #166534;
  }

  .badge-inactive {
    background: #f3f4f6;
    color: #6b7280;
  }

  .badge-completed {
    background: #dbeafe;
    color: #1e40af;
  }

  /* Editor Panel */
  .editor-panel {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border: 2px solid var(--border-color);
  }

  .editor-panel.active {
    border-color: var(--staff-color);
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  }

  .no-selection {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  .no-selection .icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  /* Game Editor */
  .game-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  /* Notification Tab */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 2rem;
  }

  @media (max-width: 1024px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  .preview-panel {
    position: sticky;
    top: 2rem;
  }

  .preview-phone {
    background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
    border-radius: 24px;
    padding: 1rem;
    max-width: 280px;
    margin: 0 auto;
  }

  .preview-notification {
    background: white;
    border-radius: 12px;
    padding: 1rem;
  }

  .preview-notification-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .preview-app-icon {
    width: 24px;
    height: 24px;
    background: var(--primary-color);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    color: white;
  }

  .preview-app-name {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .preview-title {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }

  .preview-body {
    font-size: 0.85rem;
    color: var(--text-light);
    line-height: 1.4;
  }

  .recipient-count {
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
    border: 2px solid #3b82f6;
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    font-weight: 600;
    color: #1e40af;
    text-align: center;
  }

  /* Recent Announcements */
  .recent-item {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .recent-item:last-child {
    border-bottom: none;
  }

  .recent-item.unsent {
    opacity: 0.6;
    background: #fef2f2;
  }

  .recent-item-header {
    display: flex;
    justify-content: space-between;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .recent-item-title {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .recent-item-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .recent-item-meta {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 0.5rem;
  }

  .unsend-btn {
    background: none;
    border: 1px solid var(--danger-color);
    color: var(--danger-color);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .unsend-btn:hover {
    background: var(--danger-color);
    color: white;
  }

  .unsent-badge {
    background: var(--danger-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
  }

  .priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .priority-normal {
    background: #dbeafe;
    color: #1e40af;
  }

  .priority-urgent {
    background: #fee2e2;
    color: #991b1b;
  }

  .priority-info {
    background: #e0f2fe;
    color: #0369a1;
  }

  /* Team Filter Chips */
  .team-filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .team-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }

  .team-chip:hover {
    border-color: var(--staff-color);
  }

  .team-chip.selected {
    background: var(--staff-color);
    border-color: var(--staff-color);
    color: white;
  }

  .team-chip input {
    display: none;
  }

  /* Cleanup Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .modal-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    background: var(--text-dark);
    color: white;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: slideUp 0.3s ease;
    min-width: 280px;
    justify-content: center;
  }

  .toast-success { background: var(--success-color); }
  .toast-error { background: var(--danger-color); }
  .toast-warning { background: var(--warning-color); color: var(--text-dark); }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
  }

  .no-recipients {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  .loading-text {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  /* ============================================ */
  /* ROSTER IMPORT TAB STYLES */
  /* ============================================ */

  /* Drop Zone */
  .drop-zone {
    border: 3px dashed var(--border-color);
    border-radius: 16px;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: #f8fafc;
  }

  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--staff-color);
    background: #e0f2fe;
  }

  .drop-zone-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .drop-zone-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 0.5rem;
  }

  .drop-zone-hint {
    font-size: 0.9rem;
    color: var(--text-light);
  }

  /* Stats Summary */
  .stats-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: white;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
    border: 2px solid var(--border-color);
  }

  .stat-card.returning {
    border-color: var(--success-color);
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
  }

  .stat-card.review {
    border-color: var(--warning-color);
    background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
  }

  .stat-card.new {
    border-color: var(--info-color);
    background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
  }

  .stat-card.missing {
    border-color: var(--danger-color);
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
  }

  .stat-number {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .stat-card.returning .stat-number { color: var(--success-color); }
  .stat-card.review .stat-number { color: var(--warning-color); }
  .stat-card.new .stat-number { color: var(--info-color); }
  .stat-card.missing .stat-number { color: var(--danger-color); }

  .stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
    font-weight: 600;
  }

  /* Progress Bar */
  .progress-bar-container {
    background: #e2e8f0;
    border-radius: 8px;
    height: 12px;
    margin-bottom: 1rem;
    overflow: hidden;
  }

  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--success-color) 0%, var(--primary-color) 100%);
    border-radius: 8px;
    transition: width 0.5s ease;
  }

  .progress-text {
    text-align: center;
    font-size: 0.9rem;
    color: var(--text-light);
    margin-bottom: 1.5rem;
  }

  /* Three Column Layout */
  .results-columns {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 1024px) {
    .results-columns {
      grid-template-columns: 1fr;
    }
  }

  .results-column {
    background: var(--card-bg);
    border-radius: 12px;
    border: 2px solid var(--border-color);
    overflow: hidden;
    max-height: 500px;
    display: flex;
    flex-direction: column;
  }

  .results-column.returning { border-color: var(--success-color); }
  .results-column.review { border-color: var(--warning-color); }
  .results-column.new { border-color: var(--info-color); }

  .column-header {
    padding: 1rem 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .results-column.returning .column-header { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); color: #166534; }
  .results-column.review .column-header { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); color: #92400e; }
  .results-column.new .column-header { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #1e40af; }

  .column-search {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .column-search input {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }

  .column-content {
    flex: 1;
    overflow-y: auto;
    padding: 0.5rem;
  }

  /* Player Cards */
  .player-card {
    background: white;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
  }

  .player-card:hover {
    box-shadow: var(--shadow-sm);
  }

  .player-card-name {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.25rem;
  }

  .player-card-details {
    font-size: 0.8rem;
    color: var(--text-light);
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .player-card-match {
    font-size: 0.75rem;
    color: var(--success-color);
    font-weight: 600;
  }

  /* Review Card */
  .review-card {
    background: white;
    border: 2px solid var(--warning-color);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .review-card-name {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 0.75rem;
    color: var(--text-dark);
  }

  .review-options {
    margin-bottom: 0.75rem;
  }

  .review-option {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 6px;
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .review-option:hover {
    background: #f8fafc;
  }

  .review-option input[type="radio"] {
    width: auto;
    margin-top: 0.25rem;
  }

  .review-option-details {
    flex: 1;
  }

  .review-option-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .review-option-meta {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .review-option-confidence {
    font-size: 0.75rem;
    font-weight: 600;
    padding: 0.15rem 0.5rem;
    border-radius: 4px;
    background: #fef3c7;
    color: #92400e;
  }

  .review-card-actions {
    display: flex;
    gap: 0.5rem;
  }

  .review-card-actions .btn {
    flex: 1;
    justify-content: center;
    padding: 0.5rem;
    font-size: 0.85rem;
  }

  /* Warnings Section */
  .warnings-section {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border: 2px solid var(--danger-color);
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .warnings-header {
    font-weight: 700;
    color: #991b1b;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .warning-item {
    font-size: 0.9rem;
    color: #991b1b;
    padding: 0.5rem 0;
    border-bottom: 1px solid #fecaca;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .warning-item:last-child {
    border-bottom: none;
  }

  /* Missing Players Section */
  .missing-section {
    background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
    border: 2px solid #f97316;
    border-radius: 12px;
    padding: 1.25rem;
    margin-bottom: 1.5rem;
  }

  .missing-header {
    font-weight: 700;
    color: #c2410c;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .missing-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .missing-player {
    background: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.85rem;
    border: 1px solid #fed7aa;
  }

  .missing-player-name {
    font-weight: 600;
  }

  .missing-player-team {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  /* Export Section */
  .export-section {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border: 2px solid var(--success-color);
    border-radius: 12px;
    padding: 1.5rem;
  }

  .export-header {
    font-weight: 700;
    color: #166534;
    font-size: 1.1rem;
    margin-bottom: 1rem;
  }

  .export-summary {
    font-size: 0.95rem;
    color: #166534;
    margin-bottom: 1rem;
    line-height: 1.6;
  }

  .export-warning {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 0.75rem;
    margin-bottom: 1rem;
    font-size: 0.9rem;
    color: #92400e;
  }

  /* Audit Log */
  .audit-section {
    margin-top: 2rem;
    border-top: 2px solid var(--border-color);
    padding-top: 1.5rem;
  }

  .audit-header {
    font-weight: 700;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .audit-log {
    max-height: 200px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.8rem;
    background: #1e293b;
    color: #94a3b8;
    padding: 1rem;
    border-radius: 8px;
  }

  .audit-entry {
    padding: 0.25rem 0;
    border-bottom: 1px solid #334155;
  }

  .audit-entry:last-child {
    border-bottom: none;
  }

  .audit-time {
    color: #64748b;
  }

  .audit-action {
    color: #22c55e;
  }

  .audit-detail {
    color: #e2e8f0;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header {
      padding: 1.5rem 1rem;
    }

    .header h1 {
      font-size: 1.5rem;
    }

    .header-content {
      flex-direction: column;
      text-align: center;
    }

    .header-buttons {
      width: 100%;
      justify-content: center;
    }

    .container {
      padding: 0 1rem;
    }

    .tab-btn {
      min-width: 80px;
      padding: 0.75rem 0.75rem;
      font-size: 0.8rem;
    }

    .tab-btn .icon {
      font-size: 1rem;
    }

    .stats-summary {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate" style="display: none;">
  <h2>üîí Access Required</h2>
  <p>You must be a League Staff member or Admin to access this page.</p>
  <a href="profile.html">‚Üê Back to Profile</a>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
  <header class="header">
    <div class="header-content">
      <div>
        <h1>‚öôÔ∏è League Staff Admin</h1>
        <p>Manage schedules, banners, notifications, and roster imports</p>
        <div class="role-badges" id="userRoleBadges"></div>
      </div>
      <div class="header-buttons">
        <a href="profile.html" class="nav-btn">‚Üê Back to Profile</a>
        <a href="index.html" class="nav-btn">üè† Home</a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="schedule" onclick="switchTab('schedule')">
        <span class="icon">üìÖ</span>
        <span class="hide-mobile">Schedule</span>
      </button>
      <button class="tab-btn" data-tab="banners" onclick="switchTab('banners')">
        <span class="icon">üì¢</span>
        <span class="hide-mobile">Banners</span>
      </button>
      <button class="tab-btn" data-tab="notifications" onclick="switchTab('notifications')">
        <span class="icon">üîî</span>
        <span class="hide-mobile">Notifications</span>
      </button>
      <button class="tab-btn" data-tab="roster" onclick="switchTab('roster')">
        <span class="icon">üìã</span>
        <span class="hide-mobile">Roster Import</span>
      </button>
    </div>

    <!-- ============================================ -->
    <!-- TAB: SCHEDULE EDITOR -->
    <!-- ============================================ -->
    <div class="tab-content active" id="tab-schedule">
      <div class="section">
        <div class="section-header">
          üìÖ League Schedule Editor
        </div>
        <div class="section-content">
          <div class="season-selector">
            <label>Season:</label>
            <select id="scheduleSeasonSelect" onchange="loadGames()">
              <option value="">Loading seasons...</option>
            </select>
            <button class="btn btn-secondary" onclick="loadGames()">üîÑ Refresh</button>
          </div>

          <div class="form-row">
            <div style="flex: 1;">
              <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Select Game to Edit:</label>
              <div class="item-list" id="gameList">
                <div class="empty-state">Select a season to load games</div>
              </div>
            </div>
          </div>

          <div class="editor-panel" id="gameEditor">
            <div class="no-selection">
              <div class="icon">üìã</div>
              <p>Select a game from the list to edit its schedule</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: BANNER MESSAGES -->
    <!-- ============================================ -->
    <div class="tab-content" id="tab-banners">
      <div class="section">
        <div class="section-header">
          üì¢ Banner Messages Manager
        </div>
        <div class="section-content">
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Manage the scrolling banner messages that appear on the home page. Messages are sorted by priority (lower numbers appear first).
          </p>
          
          <div class="btn-group" style="margin-bottom: 1.5rem; margin-top: 0;">
            <button class="btn btn-secondary" onclick="loadBanners()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="showNewBannerForm()">‚ûï Add Banner</button>
          </div>

          <div class="item-list" id="bannerList">
            <div class="empty-state">Loading banners...</div>
          </div>

          <div class="editor-panel" id="bannerEditor">
            <div class="no-selection">
              <div class="icon">üì¢</div>
              <p>Select a banner to edit or click "Add Banner" to create a new one</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: NOTIFICATIONS -->
    <!-- ============================================ -->
    <div class="tab-content" id="tab-notifications">
      <div class="main-grid">
        <div>
          <!-- Compose Notification -->
          <div class="section">
            <div class="section-header">
              ‚úèÔ∏è Compose Notification
            </div>
            <div class="section-content">
              <div class="form-group">
                <label>Title (Required)</label>
                <input type="text" id="notificationTitle" placeholder="e.g., Game Tonight!" maxlength="65" oninput="updateNotificationPreview()">
                <div class="hint"><span id="titleCharCount">0</span>/65 characters</div>
              </div>

              <div class="form-group">
                <label>Message Body (Required)</label>
                <textarea id="notificationBody" rows="3" placeholder="e.g., Don't forget! Aces vs. Bears at 6:30 PM at Memorial Field." maxlength="240" oninput="updateNotificationPreview()"></textarea>
                <div class="hint"><span id="bodyCharCount">0</span>/240 characters</div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Priority</label>
                  <select id="notificationPriority" onchange="updateNotificationPreview()">
                    <option value="normal">üì¢ Normal</option>
                    <option value="urgent">üö® Urgent</option>
                    <option value="info">‚ÑπÔ∏è Info</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Link (Optional)</label>
                  <select id="notificationLinkType" onchange="handleLinkTypeChange()">
                    <option value="">No link</option>
                    <option value="weekend-preview">Weekend Preview</option>
                    <option value="schedule">Season Schedule</option>
                    <option value="standings">Standings</option>
                    <option value="bracket">Playoff Bracket</option>
                    <option value="custom">Custom URL</option>
                  </select>
                </div>
              </div>

              <div class="form-group" id="customLinkGroup" style="display: none;">
                <label>Custom URL</label>
                <input type="text" id="notificationCustomLink" placeholder="https://...">
              </div>

              <div class="form-group">
                <label>Quick Actions</label>
                <div class="btn-group" style="margin-top: 0.5rem; margin-bottom: 1rem;">
                  <button class="btn btn-secondary" onclick="selectAllCaptains()">
                    üëë Message All Captains
                  </button>
                  <button class="btn btn-secondary" onclick="clearTeamSelection()">
                    üîÑ Clear Selection
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>Target Teams (Optional - leave empty for league-wide)</label>
                <div class="team-filter-chips" id="teamFilterChips">
                  Loading teams...
                </div>
              </div>

              <div id="recipientPreview" style="display: none;">
                <div class="recipient-count">
                  <span id="recipientCountText">0 recipients</span>
                </div>
              </div>

              <div id="captainsSelectedIndicator" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
                <span style="font-weight: 600; color: #92400e;">üëë Targeting All Captains</span>
              </div>

              <button class="btn btn-success" id="sendNotificationBtn" onclick="sendNotification()" disabled style="width: 100%; justify-content: center; padding: 1rem;">
                üì§ Send Notification
              </button>
            </div>
          </div>

          <!-- Recent Announcements -->
          <div class="section">
            <div class="section-header">
              üìã Recent Announcements
            </div>
            <div class="section-content" style="padding: 0;">
              <div id="recentAnnouncementsList">
                <div class="loading-text">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Admin Cleanup Section -->
          <div class="section" id="adminCleanupSection" style="display: none;">
            <div class="section-header" style="background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);">
              üóëÔ∏è Admin Cleanup Tools
            </div>
            <div class="section-content">
              <p style="color: var(--text-light); margin-bottom: 1rem;">
                These tools allow you to bulk delete notifications from all users. Use with caution!
              </p>
              <button class="btn btn-danger" onclick="showCleanupModal()">
                üóëÔ∏è Open Cleanup Tools
              </button>
            </div>
          </div>
        </div>

        <!-- Preview Panel -->
        <div>
          <div class="section">
            <div class="section-header">
              üì± Preview
            </div>
            <div class="section-content">
              <div class="preview-panel" id="previewPanel">
                <div class="preview-phone">
                  <div class="preview-notification">
                    <div class="preview-notification-header">
                      <div class="preview-app-icon">‚öæ</div>
                      <span class="preview-app-name">Mountainside Aces</span>
                    </div>
                    <div class="preview-title" id="previewTitle">Notification Title</div>
                    <div class="preview-body" id="previewBody">Your message will appear here...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Notification -->
          <div class="section">
            <div class="section-header">
              üß™ Test Your Setup
            </div>
            <div class="section-content">
              <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">
                Send a test notification to yourself to verify push notifications are working.
              </p>
              <button class="btn btn-secondary" id="testNotificationBtn" onclick="sendTestNotification()" style="width: 100%; justify-content: center;">
                üì≤ Send Test to Me
              </button>
              <div id="testNotificationStatus" style="margin-top: 0.5rem; font-size: 0.85rem; text-align: center;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: ROSTER IMPORT -->
    <!-- ============================================ -->
    <div class="tab-content" id="tab-roster">
      <!-- Upload Phase -->
      <div id="rosterUploadPhase">
        <div class="section">
          <div class="section-header">
            üìã Roster Import & Reconciliation
          </div>
          <div class="section-content">
            <p style="color: var(--text-light); margin-bottom: 1.5rem;">
              Upload the rec dept signup list to identify returning vs new players. Results can be pushed to Offseason Rosters for draft planning.
            </p>

            <div class="drop-zone" id="rosterDropZone">
              <div class="drop-zone-icon">üì§</div>
              <div class="drop-zone-text">Drop Excel/CSV file here</div>
              <div class="drop-zone-hint">or click to browse ‚Ä¢ Supports .xlsx, .xls, .csv</div>
              <input type="file" id="rosterFileInput" accept=".xlsx,.xls,.csv" style="display: none;">
            </div>

            <div id="filePreview" style="display: none; margin-top: 1.5rem;">
              <div class="form-group">
                <label>Name Column</label>
                <select id="nameColumnSelect">
                  <option value="">Select column containing player names...</option>
                </select>
                <div class="hint">Auto-detected: we'll look for columns named "Name", "Player", "Full Name", etc.</div>
              </div>

              <div id="previewInfo" style="background: #f8fafc; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                <strong>Preview:</strong> <span id="previewCount">0</span> names found
              </div>

              <div class="btn-group">
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeRoster()">
                  üîç Analyze Roster
                </button>
                <button class="btn btn-secondary" onclick="resetUpload()">
                  üîÑ Start Over
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Results Phase -->
      <div id="rosterResultsPhase" style="display: none;">
        <div class="section">
          <div class="section-header">
            üìä Roster Analysis Results
          </div>
          <div class="section-content">
            <!-- Stats Summary -->
            <div class="stats-summary" id="statsSummary">
              <!-- Filled by JavaScript -->
            </div>

            <!-- Progress Bar -->
            <div class="progress-bar-container">
              <div class="progress-bar" id="returningProgressBar" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">Calculating...</div>

            <!-- Season Info -->
            <div style="text-align: center; margin-bottom: 1.5rem; color: var(--text-light); font-size: 0.9rem;">
              Compared against: <strong id="comparedSeasons">Loading...</strong>
            </div>

            <!-- Warnings Section -->
            <div id="warningsSection" class="warnings-section" style="display: none;">
              <div class="warnings-header">‚ö†Ô∏è Warnings</div>
              <div id="warningsList"></div>
            </div>

            <!-- Missing Players Section -->
            <div id="missingSection" class="missing-section" style="display: none;">
              <div class="missing-header">‚ö†Ô∏è Not Signed Up (Active in last 2 seasons)</div>
              <p style="font-size: 0.9rem; color: #c2410c; margin-bottom: 0.75rem;">
                These players were active but aren't in the signup list:
              </p>
              <div class="missing-list" id="missingList"></div>
              <div class="btn-group" style="margin-top: 1rem;">
                <button class="btn btn-secondary" onclick="copyMissingPlayers()">üìã Copy Names</button>
                <button class="btn btn-secondary" onclick="downloadMissingPlayers()">üì• Download List</button>
              </div>
            </div>

            <!-- Three Column Results -->
            <div class="results-columns">
              <!-- Returning Players -->
              <div class="results-column returning">
                <div class="column-header">‚úÖ Returning (<span id="returningCount">0</span>)</div>
                <div class="column-search">
                  <input type="text" placeholder="üîç Search..." oninput="filterReturning(this.value)">
                </div>
                <div class="column-content" id="returningList">
                  <!-- Filled by JavaScript -->
                </div>
              </div>

              <!-- Needs Review -->
              <div class="results-column review">
                <div class="column-header">‚ö†Ô∏è Review (<span id="reviewCount">0</span>)</div>
                <div class="column-content" id="reviewList">
                  <!-- Filled by JavaScript -->
                </div>
              </div>

              <!-- New Players -->
              <div class="results-column new">
                <div class="column-header">üÜï New (<span id="newCount">0</span>)</div>
                <div class="column-search">
                  <input type="text" placeholder="üîç Search..." oninput="filterNew(this.value)">
                </div>
                <div class="column-content" id="newList">
                  <!-- Filled by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Bulk Actions -->
            <div class="btn-group" style="margin-bottom: 2rem; justify-content: center;">
              <button class="btn btn-success" onclick="acceptAllHighConfidence()">
                ‚úÖ Accept All 95%+ Matches
              </button>
              <button class="btn btn-secondary" onclick="markAllReviewAsNew()">
                üÜï Mark All Review as New
              </button>
            </div>

            <!-- Export Section -->
            <div class="export-section" id="exportSection">
              <div class="export-header">üì§ Push to Offseason Rosters</div>
              <div class="export-summary" id="exportSummary">
                <!-- Filled by JavaScript -->
              </div>
              <div id="exportWarning" class="export-warning" style="display: none;">
                ‚ö†Ô∏è <span id="unresolvedCount">0</span> players still need review. Please resolve them first.
              </div>
              <div class="btn-group">
                <button class="btn btn-success" id="pushToOffseasonBtn" onclick="pushToOffseason()">
                  üî• Push to Offseason Rosters
                </button>
                <button class="btn btn-secondary" onclick="downloadReport()">
                  üì• Download Report Only
                </button>
                <button class="btn btn-secondary" onclick="resetUpload()">
                  üîÑ Start Over
                </button>
              </div>
            </div>

            <!-- Audit Log -->
            <div class="audit-section">
              <div class="audit-header">üìú Audit Log</div>
              <div class="audit-log" id="auditLog">
                <div class="audit-entry">
                  <span class="audit-time">[Waiting]</span>
                  <span class="audit-detail">No actions yet</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cleanup Modal -->
<div class="modal" id="cleanupModal">
  <div class="modal-content">
    <div class="modal-header">üóëÔ∏è Notification Cleanup</div>
    <div class="form-group">
      <label>Delete by Type</label>
      <select id="cleanupOption">
        <option value="">Select option...</option>
        <option value="type-announcement">All Announcements</option>
        <option value="type-game_reminder">All Game Reminders</option>
        <option value="type-milestone">All Milestones</option>
        <option value="all">‚ö†Ô∏è ALL Notifications</option>
      </select>
    </div>
    <div class="form-group">
      <label>Or Delete by Title (exact match)</label>
      <input type="text" id="cleanupTitle" placeholder="Enter notification title...">
    </div>
    <div class="btn-group">
      <button class="btn btn-danger" onclick="runCleanup()">üóëÔ∏è Delete</button>
      <button class="btn btn-secondary" onclick="hideCleanupModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
  import { auth, hasSpecialRole } from './firebase-auth.js';
  import { db, getAllPlayerStatsOptimized } from './firebase-data.js';
  import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { 
    collection, 
    getDocs, 
    doc, 
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    addDoc,
    query,
    where,
    orderBy,
    limit,
    Timestamp,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const functions = getFunctions();

  // ========================================
  // GLOBAL STATE
  // ========================================
  let currentUser = null;
  let currentUserProfile = null;
  let allSeasons = [];
  let allTeams = [];
  let gamesCache = [];
  let bannersCache = [];
  let selectedGame = null;
  let originalGameData = null;
  let selectedBanner = null;
  let selectedTeams = [];
  let registeredUsers = [];
  let isAdmin = false;
  let isLeagueStaff = false;
  let targetingCaptains = false;

  // Roster Import State
  let uploadedNames = [];
  let existingPlayers = [];
  let matchResults = {
    returning: [],
    review: [],
    new: []
  };
  let missingPlayers = [];
  let auditLog = [];
  let targetSeasons = [];

  // ========================================
  // NICKNAME MAPPINGS
  // ========================================
  const NICKNAMES = {
    'mike': ['michael', 'mikey'],
    'bill': ['william', 'billy', 'will'],
    'bob': ['robert', 'bobby', 'rob'],
    'tom': ['thomas', 'tommy'],
    'jim': ['james', 'jimmy'],
    'steve': ['steven', 'stephen'],
    'dan': ['daniel', 'danny'],
    'joe': ['joseph', 'joey'],
    'chris': ['christopher', 'kris'],
    'matt': ['matthew'],
    'dave': ['david'],
    'nick': ['nicholas', 'nic'],
    'tony': ['anthony'],
    'ed': ['edward', 'eddie', 'ted'],
    'pete': ['peter'],
    'tim': ['timothy'],
    'ben': ['benjamin', 'benji'],
    'sam': ['samuel', 'sammy'],
    'rick': ['richard', 'ricky', 'dick'],
    'greg': ['gregory'],
    'jon': ['jonathan', 'john', 'johnny'],
    'will': ['william', 'bill', 'billy'],
    'casey': ['kc'],
    'alex': ['alexander', 'alexandra'],
    'andy': ['andrew'],
    'charlie': ['charles', 'chuck'],
    'fred': ['frederick', 'freddy'],
    'hank': ['henry'],
    'jack': ['john', 'jackson'],
    'jake': ['jacob'],
    'jerry': ['gerald', 'jeremy'],
    'josh': ['joshua'],
    'ken': ['kenneth', 'kenny'],
    'larry': ['lawrence'],
    'liz': ['elizabeth', 'beth', 'lizzy'],
    'max': ['maxwell', 'maximilian'],
    'pat': ['patrick', 'patricia'],
    'phil': ['phillip', 'philip'],
    'ray': ['raymond'],
    'ron': ['ronald', 'ronnie'],
    'ted': ['theodore', 'edward'],
    'vic': ['victor'],
    'wes': ['wesley']
  };

  // ========================================
  // INITIALIZATION
  // ========================================
  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authGate').style.display = 'block';
      return;
    }

    currentUser = user;

    try {
      // Check user roles
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        currentUserProfile = userDoc.data();
        isAdmin = currentUserProfile.isAdmin === true;
        isLeagueStaff = currentUserProfile.isLeagueStaff === true;
      }

      // Must be league staff or admin
      if (!isAdmin && !isLeagueStaff) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('authGate').style.display = 'block';
        return;
      }

      // Show main content
      document.getElementById('mainContent').style.display = 'block';

      // Show role badges
      const badges = [];
      if (isAdmin) badges.push('<span class="role-badge">üëë Admin</span>');
      if (isLeagueStaff) badges.push('<span class="role-badge">üìã League Staff</span>');
      document.getElementById('userRoleBadges').innerHTML = badges.join('');

      // Show admin sections
      if (isAdmin) {
        document.getElementById('adminCleanupSection').style.display = 'block';
      }

      // Load initial data
      await Promise.all([
        loadSeasons(),
        loadTeams(),
        loadRegisteredUsers()
      ]);

      // Load initial tab data
      loadGames();
      loadBanners();
      loadRecentAnnouncements();
      setupRosterImport();

      document.getElementById('loadingOverlay').classList.add('hidden');

    } catch (error) {
      console.error('Error initializing:', error);
      showToast('Error loading page: ' + error.message, 'error');
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  });

  // ========================================
  // TAB SWITCHING
  // ========================================

  window.switchTab = function(tabName) {
    // Update buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
      if (btn.dataset.tab === tabName) {
        btn.classList.add('active');
      }
    });

    // Update content
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    document.getElementById(`tab-${tabName}`).classList.add('active');
  };

  // ========================================
  // ROSTER IMPORT FUNCTIONS
  // ========================================

  function setupRosterImport() {
    const dropZone = document.getElementById('rosterDropZone');
    const fileInput = document.getElementById('rosterFileInput');

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFileUpload(files[0]);
      }
    });

    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFileUpload(e.target.files[0]);
      }
    });

    // Calculate target seasons (last 2)
    calculateTargetSeasons();
  }

  function calculateTargetSeasons() {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth() + 1; // 1-12

    // Determine current/upcoming season context
    // Summer is roughly May-August, Fall is September-November
    // If we're in Jan-April, we're planning for Summer, so look back at Fall and previous Summer
    // If we're in May-August, we're in Summer, look at current Summer and previous Fall
    // If we're in Sept-Dec, we're in Fall, look at current Fall and Summer
    
    if (month >= 1 && month <= 4) {
      // Planning for Summer, look at previous Fall and previous Summer
      targetSeasons = [`${year - 1}-fall`, `${year - 1}-summer`];
    } else if (month >= 5 && month <= 8) {
      // In Summer or planning for Fall, look at current Summer and previous Fall
      targetSeasons = [`${year}-summer`, `${year - 1}-fall`];
    } else {
      // In Fall or planning for next Summer, look at current Fall and current Summer
      targetSeasons = [`${year}-fall`, `${year}-summer`];
    }

    console.log('üìÖ Target seasons for comparison:', targetSeasons);
  }

  async function handleFileUpload(file) {
    addAuditEntry('upload', `File uploaded: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`);

    try {
      const data = await readFile(file);
      const workbook = XLSX.read(data, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

      if (jsonData.length < 2) {
        showToast('File appears to be empty or has no data rows', 'error');
        return;
      }

      // Get headers (first row)
      const headers = jsonData[0].map(h => String(h || '').trim());
      
      // Populate column selector
      const nameColumnSelect = document.getElementById('nameColumnSelect');
      nameColumnSelect.innerHTML = '<option value="">Select column containing player names...</option>';
      
      headers.forEach((header, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = `${header} (Column ${index + 1})`;
        nameColumnSelect.appendChild(option);
      });

      // Auto-detect name column
      const namePatterns = ['name', 'player', 'full name', 'fullname', 'player name', 'playername'];
      const autoDetectedIndex = headers.findIndex(h => 
        namePatterns.some(pattern => h.toLowerCase().includes(pattern))
      );

      if (autoDetectedIndex >= 0) {
        nameColumnSelect.value = autoDetectedIndex;
        addAuditEntry('auto-detect', `Auto-detected name column: "${headers[autoDetectedIndex]}"`);
      }

      // Store data for later
      window.uploadedFileData = jsonData;
      window.uploadedHeaders = headers;

      // Update preview
      updateFilePreview();
      document.getElementById('filePreview').style.display = 'block';

    } catch (error) {
      console.error('Error reading file:', error);
      showToast('Error reading file: ' + error.message, 'error');
      addAuditEntry('error', `File read error: ${error.message}`);
    }
  }

  function readFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(new Uint8Array(e.target.result));
      reader.onerror = (e) => reject(e);
      reader.readAsArrayBuffer(file);
    });
  }

  function updateFilePreview() {
    const nameColumnIndex = parseInt(document.getElementById('nameColumnSelect').value);
    const jsonData = window.uploadedFileData;

    if (isNaN(nameColumnIndex) || !jsonData) {
      document.getElementById('previewCount').textContent = '0';
      return;
    }

    // Extract names (skip header row)
    const names = jsonData.slice(1)
      .map(row => row[nameColumnIndex])
      .filter(name => name && String(name).trim().length > 0)
      .map(name => String(name).trim());

    uploadedNames = names;
    document.getElementById('previewCount').textContent = names.length;
    addAuditEntry('preview', `Extracted ${names.length} names from selected column`);
  }

  // Listen for column selection change
  document.getElementById('nameColumnSelect')?.addEventListener('change', updateFilePreview);

  async function analyzeRoster() {
    if (uploadedNames.length === 0) {
      showToast('Please select a column with player names', 'error');
      return;
    }

    const btn = document.getElementById('analyzeBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Analyzing...';
    addAuditEntry('analyze', `Starting analysis of ${uploadedNames.length} names`);

    try {
      // Load existing players
      showToast('Loading player database...', 'info');
      existingPlayers = await getAllPlayerStatsOptimized();
      addAuditEntry('load', `Loaded ${existingPlayers.length} players from database`);

      // Filter to recently active players (last 2 seasons)
      const recentPlayers = existingPlayers.filter(player => {
        if (!player.seasons) return false;
        const playerSeasons = Object.keys(player.seasons);
        return playerSeasons.some(s => targetSeasons.some(target => s.startsWith(target)));
      });

      addAuditEntry('filter', `Filtered to ${recentPlayers.length} players active in last 2 seasons`);

      // Match each uploaded name
      matchResults = { returning: [], review: [], new: [] };
      const warnings = [];
      const seenNames = new Set();

      for (const uploadedName of uploadedNames) {
        const normalized = normalizeName(uploadedName);

        // Check for duplicates in upload
        if (seenNames.has(normalized)) {
          warnings.push(`Duplicate in upload: "${uploadedName}"`);
          continue;
        }
        seenNames.add(normalized);

        // Find match
        const result = findBestMatch(uploadedName, recentPlayers);

        if (result.status === 'matched') {
          matchResults.returning.push(result);
        } else if (result.status === 'review') {
          matchResults.review.push(result);
        } else {
          matchResults.new.push(result);
        }
      }

      // Find missing players (in recent seasons but not in upload)
      const uploadedNormalized = new Set(uploadedNames.map(n => normalizeName(n)));
      missingPlayers = recentPlayers.filter(player => {
        const normalized = normalizeName(player.name);
        // Check if any close match exists
        return !uploadedNormalized.has(normalized) && 
               !matchResults.returning.some(m => m.match?.name === player.name);
      }).map(player => {
        // Get most recent season info
        const seasonKeys = Object.keys(player.seasons || {}).sort().reverse();
        const lastSeasonKey = seasonKeys[0] || 'Unknown';
        const lastTeam = player.seasons?.[lastSeasonKey]?.team || 'Unknown';
        return {
          name: player.name,
          lastSeason: lastSeasonKey,
          lastTeam: lastTeam
        };
      });

      addAuditEntry('complete', `Analysis complete: ${matchResults.returning.length} returning, ${matchResults.review.length} review, ${matchResults.new.length} new, ${missingPlayers.length} missing`);

      // Display results
      displayResults(warnings);

    } catch (error) {
      console.error('Error analyzing roster:', error);
      showToast('Error analyzing roster: ' + error.message, 'error');
      addAuditEntry('error', `Analysis error: ${error.message}`);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'üîç Analyze Roster';
    }
  }
  window.analyzeRoster = analyzeRoster;

  function normalizeName(name) {
    if (!name) return '';
    return String(name)
      .toLowerCase()
      .trim()
      .replace(/\s+/g, ' ')
      .replace(/[^\w\s]/g, '');
  }

  function areNicknames(name1, name2) {
    const parts1 = name1.split(' ');
    const parts2 = name2.split(' ');
    
    if (parts1.length < 2 || parts2.length < 2) return false;
    
    const first1 = parts1[0];
    const first2 = parts2[0];
    const last1 = parts1[parts1.length - 1];
    const last2 = parts2[parts2.length - 1];
    
    // Last names must match
    if (last1 !== last2) return false;
    
    // Check first names for nicknames
    if (first1 === first2) return true;
    
    for (const [nick, variants] of Object.entries(NICKNAMES)) {
      const allVariants = [nick, ...variants];
      if (allVariants.includes(first1) && allVariants.includes(first2)) {
        return true;
      }
    }
    
    return false;
  }

  function levenshteinDistance(a, b) {
    const matrix = [];
    
    for (let i = 0; i <= b.length; i++) {
      matrix[i] = [i];
    }
    for (let j = 0; j <= a.length; j++) {
      matrix[0][j] = j;
    }
    
    for (let i = 1; i <= b.length; i++) {
      for (let j = 1; j <= a.length; j++) {
        if (b.charAt(i - 1) === a.charAt(j - 1)) {
          matrix[i][j] = matrix[i - 1][j - 1];
        } else {
          matrix[i][j] = Math.min(
            matrix[i - 1][j - 1] + 1,
            matrix[i][j - 1] + 1,
            matrix[i - 1][j] + 1
          );
        }
      }
    }
    
    return matrix[b.length][a.length];
  }

  function calculateMatchScore(uploadedNorm, existingNorm) {
    if (uploadedNorm === existingNorm) return 100;
    
    if (areNicknames(uploadedNorm, existingNorm)) return 95;
    
    const distance = levenshteinDistance(uploadedNorm, existingNorm);
    const maxLen = Math.max(uploadedNorm.length, existingNorm.length);
    const similarity = ((maxLen - distance) / maxLen) * 100;
    
    // Bonus for matching last name
    const parts1 = uploadedNorm.split(' ');
    const parts2 = existingNorm.split(' ');
    if (parts1.length >= 2 && parts2.length >= 2) {
      const last1 = parts1[parts1.length - 1];
      const last2 = parts2[parts2.length - 1];
      if (last1 === last2) {
        return Math.max(similarity, Math.min(similarity + 15, 94));
      }
    }
    
    return Math.round(similarity);
  }

  function findBestMatch(uploadedName, players) {
    const normalized = normalizeName(uploadedName);
    
    const scored = players.map(player => ({
      player,
      score: calculateMatchScore(normalized, normalizeName(player.name))
    }));
    
    const matches = scored
      .filter(m => m.score >= 60)
      .sort((a, b) => b.score - a.score)
      .slice(0, 5);
    
    if (matches.length === 0) {
      return { status: 'new', uploadedName };
    }
    
    if (matches[0].score >= 95) {
      const player = matches[0].player;
      const seasonKeys = Object.keys(player.seasons || {}).sort().reverse();
      const lastSeasonKey = seasonKeys[0] || 'Unknown';
      
      return {
        status: 'matched',
        uploadedName,
        match: player,
        confidence: matches[0].score,
        lastSeason: lastSeasonKey,
        lastTeam: player.seasons?.[lastSeasonKey]?.team || 'Unknown'
      };
    }
    
    return {
      status: 'review',
      uploadedName,
      candidates: matches.map(m => {
        const seasonKeys = Object.keys(m.player.seasons || {}).sort().reverse();
        const lastSeasonKey = seasonKeys[0] || 'Unknown';
        return {
          player: m.player,
          score: m.score,
          lastSeason: lastSeasonKey,
          lastTeam: m.player.seasons?.[lastSeasonKey]?.team || 'Unknown'
        };
      })
    };
  }

  function displayResults(warnings) {
    // Switch to results phase
    document.getElementById('rosterUploadPhase').style.display = 'none';
    document.getElementById('rosterResultsPhase').style.display = 'block';

    const totalUploaded = matchResults.returning.length + matchResults.review.length + matchResults.new.length;
    const returningPercent = totalUploaded > 0 ? Math.round((matchResults.returning.length / totalUploaded) * 100) : 0;

    // Stats summary
    document.getElementById('statsSummary').innerHTML = `
      <div class="stat-card">
        <div class="stat-number">${totalUploaded}</div>
        <div class="stat-label">üì§ Uploaded</div>
      </div>
      <div class="stat-card returning">
        <div class="stat-number">${matchResults.returning.length}</div>
        <div class="stat-label">‚úÖ Returning</div>
      </div>
      <div class="stat-card review">
        <div class="stat-number">${matchResults.review.length}</div>
        <div class="stat-label">‚ö†Ô∏è Review</div>
      </div>
      <div class="stat-card new">
        <div class="stat-number">${matchResults.new.length}</div>
        <div class="stat-label">üÜï New</div>
      </div>
      <div class="stat-card missing">
        <div class="stat-number">${missingPlayers.length}</div>
        <div class="stat-label">‚ö†Ô∏è Missing</div>
      </div>
    `;

    // Progress bar
    document.getElementById('returningProgressBar').style.width = `${returningPercent}%`;
    document.getElementById('progressText').textContent = `${returningPercent}% returning players`;

    // Compared seasons
    document.getElementById('comparedSeasons').textContent = targetSeasons.join(' & ');

    // Warnings
    if (warnings.length > 0) {
      document.getElementById('warningsSection').style.display = 'block';
      document.getElementById('warningsList').innerHTML = warnings.map(w => 
        `<div class="warning-item">‚ö†Ô∏è ${w}</div>`
      ).join('');
    } else {
      document.getElementById('warningsSection').style.display = 'none';
    }

    // Missing players
    if (missingPlayers.length > 0) {
      document.getElementById('missingSection').style.display = 'block';
      document.getElementById('missingList').innerHTML = missingPlayers.map(p => `
        <div class="missing-player">
          <span class="missing-player-name">${p.name}</span>
          <span class="missing-player-team">(${p.lastTeam})</span>
        </div>
      `).join('');
    } else {
      document.getElementById('missingSection').style.display = 'none';
    }

    // Render columns
    renderReturningColumn();
    renderReviewColumn();
    renderNewColumn();
    updateExportSection();
    updateCounts();
  }

  function renderReturningColumn() {
    const container = document.getElementById('returningList');
    if (matchResults.returning.length === 0) {
      container.innerHTML = '<div class="empty-state">No returning players found</div>';
      return;
    }

    container.innerHTML = matchResults.returning.map(r => `
      <div class="player-card" data-name="${r.uploadedName.toLowerCase()}">
        <div class="player-card-name">${r.match.name}</div>
        <div class="player-card-details">
          <span>üìÖ ${r.lastSeason}</span>
          <span>üëï ${capitalize(r.lastTeam)}</span>
        </div>
        <div class="player-card-match">‚úì ${r.confidence}% match</div>
      </div>
    `).join('');
  }

  function renderReviewColumn() {
    const container = document.getElementById('reviewList');
    if (matchResults.review.length === 0) {
      container.innerHTML = '<div class="empty-state">No players need review</div>';
      return;
    }

    container.innerHTML = matchResults.review.map((r, index) => `
      <div class="review-card" data-index="${index}">
        <div class="review-card-name">"${r.uploadedName}"</div>
        <div class="review-options">
          ${r.candidates.map((c, ci) => `
            <label class="review-option">
              <input type="radio" name="review-${index}" value="match-${ci}" onchange="handleReviewSelection(${index}, 'match', ${ci})">
              <div class="review-option-details">
                <div class="review-option-name">${c.player.name}</div>
                <div class="review-option-meta">${c.lastSeason} ‚Ä¢ ${capitalize(c.lastTeam)}</div>
              </div>
              <span class="review-option-confidence">${c.score}%</span>
            </label>
          `).join('')}
          <label class="review-option">
            <input type="radio" name="review-${index}" value="new" onchange="handleReviewSelection(${index}, 'new')">
            <div class="review-option-details">
              <div class="review-option-name">üÜï This is a NEW player</div>
              <div class="review-option-meta">No match in database</div>
            </div>
          </label>
        </div>
        <div class="review-card-actions">
          <button class="btn btn-success" onclick="confirmReview(${index})" disabled id="confirm-${index}">
            ‚úì Confirm
          </button>
        </div>
      </div>
    `).join('');
  }

  function renderNewColumn() {
    const container = document.getElementById('newList');
    if (matchResults.new.length === 0) {
      container.innerHTML = '<div class="empty-state">No new players found</div>';
      return;
    }

    container.innerHTML = matchResults.new.map(r => `
      <div class="player-card" data-name="${r.uploadedName.toLowerCase()}">
        <div class="player-card-name">${r.uploadedName}</div>
        <div class="player-card-details">
          <span>üÜï New to league</span>
        </div>
      </div>
    `).join('');
  }

  function updateCounts() {
    document.getElementById('returningCount').textContent = matchResults.returning.length;
    document.getElementById('reviewCount').textContent = matchResults.review.length;
    document.getElementById('newCount').textContent = matchResults.new.length;
  }

  window.handleReviewSelection = function(index, type, matchIndex) {
    const confirmBtn = document.getElementById(`confirm-${index}`);
    confirmBtn.disabled = false;
    confirmBtn.dataset.type = type;
    confirmBtn.dataset.matchIndex = matchIndex;
  };

  window.confirmReview = function(index) {
    const confirmBtn = document.getElementById(`confirm-${index}`);
    const type = confirmBtn.dataset.type;
    const matchIndex = parseInt(confirmBtn.dataset.matchIndex);
    
    const reviewItem = matchResults.review[index];
    
    if (type === 'match') {
      const candidate = reviewItem.candidates[matchIndex];
      matchResults.returning.push({
        status: 'matched',
        uploadedName: reviewItem.uploadedName,
        match: candidate.player,
        confidence: candidate.score,
        lastSeason: candidate.lastSeason,
        lastTeam: candidate.lastTeam,
        manuallyConfirmed: true
      });
      addAuditEntry('confirm', `Confirmed: "${reviewItem.uploadedName}" ‚Üí ${candidate.player.name} (${candidate.score}%)`);
    } else {
      matchResults.new.push({
        status: 'new',
        uploadedName: reviewItem.uploadedName,
        manuallyConfirmed: true
      });
      addAuditEntry('confirm', `Confirmed as new: "${reviewItem.uploadedName}"`);
    }
    
    matchResults.review.splice(index, 1);
    
    renderReturningColumn();
    renderReviewColumn();
    renderNewColumn();
    updateCounts();
    updateExportSection();
    
    showToast('Selection confirmed!', 'success');
  };

  window.acceptAllHighConfidence = function() {
    const highConfidence = matchResults.review.filter(r => 
      r.candidates && r.candidates[0] && r.candidates[0].score >= 95
    );
    
    if (highConfidence.length === 0) {
      showToast('No 95%+ matches to accept', 'info');
      return;
    }
    
    highConfidence.forEach(r => {
      const candidate = r.candidates[0];
      matchResults.returning.push({
        status: 'matched',
        uploadedName: r.uploadedName,
        match: candidate.player,
        confidence: candidate.score,
        lastSeason: candidate.lastSeason,
        lastTeam: candidate.lastTeam,
        autoAccepted: true
      });
      addAuditEntry('auto-accept', `Auto-accepted: "${r.uploadedName}" ‚Üí ${candidate.player.name}`);
    });
    
    matchResults.review = matchResults.review.filter(r => 
      !(r.candidates && r.candidates[0] && r.candidates[0].score >= 95)
    );
    
    renderReturningColumn();
    renderReviewColumn();
    updateCounts();
    updateExportSection();
    
    showToast(`Accepted ${highConfidence.length} high-confidence matches`, 'success');
  };

  window.markAllReviewAsNew = function() {
    if (matchResults.review.length === 0) {
      showToast('No players in review', 'info');
      return;
    }
    
    if (!confirm(`Mark all ${matchResults.review.length} review items as NEW players?`)) {
      return;
    }
    
    matchResults.review.forEach(r => {
      matchResults.new.push({
        status: 'new',
        uploadedName: r.uploadedName,
        bulkMarkedNew: true
      });
      addAuditEntry('bulk-new', `Marked as new: "${r.uploadedName}"`);
    });
    
    matchResults.review = [];
    
    renderReviewColumn();
    renderNewColumn();
    updateCounts();
    updateExportSection();
    
    showToast('All review items marked as new players', 'success');
  };

  function updateExportSection() {
    const unresolvedCount = matchResults.review.length;
    
    document.getElementById('exportSummary').innerHTML = `
      <p>‚úÖ <strong>${matchResults.returning.length}</strong> returning players ‚Üí Will keep their current team assignments</p>
      <p>üÜï <strong>${matchResults.new.length}</strong> new players ‚Üí Will be added to "Unassigned" pool</p>
    `;
    
    if (unresolvedCount > 0) {
      document.getElementById('exportWarning').style.display = 'block';
      document.getElementById('unresolvedCount').textContent = unresolvedCount;
      document.getElementById('pushToOffseasonBtn').disabled = true;
    } else {
      document.getElementById('exportWarning').style.display = 'none';
      document.getElementById('pushToOffseasonBtn').disabled = false;
    }
  }

  window.filterReturning = function(searchTerm) {
    const term = searchTerm.toLowerCase();
    document.querySelectorAll('#returningList .player-card').forEach(card => {
      const name = card.dataset.name;
      card.style.display = name.includes(term) ? 'block' : 'none';
    });
  };

  window.filterNew = function(searchTerm) {
    const term = searchTerm.toLowerCase();
    document.querySelectorAll('#newList .player-card').forEach(card => {
      const name = card.dataset.name;
      card.style.display = name.includes(term) ? 'block' : 'none';
    });
  };

  window.copyMissingPlayers = function() {
    const text = missingPlayers.map(p => `${p.name} (${p.lastTeam})`).join('\n');
    navigator.clipboard.writeText(text);
    showToast('Copied to clipboard!', 'success');
    addAuditEntry('export', 'Copied missing players to clipboard');
  };

  window.downloadMissingPlayers = function() {
    const csv = 'Name,Last Team,Last Season\n' + 
      missingPlayers.map(p => `"${p.name}","${p.lastTeam}","${p.lastSeason}"`).join('\n');
    
    downloadFile(csv, 'missing-players.csv', 'text/csv');
    addAuditEntry('export', 'Downloaded missing players CSV');
  };

  window.downloadReport = function() {
    const report = {
      generatedAt: new Date().toISOString(),
      generatedBy: currentUserProfile?.displayName || currentUser?.email,
      comparedSeasons: targetSeasons,
      summary: {
        totalUploaded: matchResults.returning.length + matchResults.review.length + matchResults.new.length,
        returning: matchResults.returning.length,
        needsReview: matchResults.review.length,
        new: matchResults.new.length,
        missing: missingPlayers.length
      },
      returning: matchResults.returning.map(r => ({
        uploadedName: r.uploadedName,
        matchedTo: r.match?.name,
        confidence: r.confidence,
        lastTeam: r.lastTeam
      })),
      review: matchResults.review.map(r => ({
        uploadedName: r.uploadedName,
        topCandidate: r.candidates?.[0]?.player?.name,
        topConfidence: r.candidates?.[0]?.score
      })),
      new: matchResults.new.map(r => ({ name: r.uploadedName })),
      missing: missingPlayers,
      auditLog: auditLog
    };
    
    downloadFile(JSON.stringify(report, null, 2), 'roster-analysis-report.json', 'application/json');
    addAuditEntry('export', 'Downloaded full analysis report');
    showToast('Report downloaded!', 'success');
  };

  async function pushToOffseason() {
    if (matchResults.review.length > 0) {
      showToast('Please resolve all review items first', 'error');
      return;
    }
    
    if (!confirm(`This will update Offseason Rosters:\n\n‚Ä¢ ${matchResults.returning.length} returning players\n‚Ä¢ ${matchResults.new.length} new players to Unassigned pool\n\nContinue?`)) {
      return;
    }
    
    const btn = document.getElementById('pushToOffseasonBtn');
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Pushing...';
    
    try {
      // Build unassigned players array
      const unassignedPlayers = matchResults.new.map(r => ({
        id: r.uploadedName.toLowerCase().replace(/\s+/g, '_'),
        name: r.uploadedName,
        source: 'roster-import',
        importedAt: new Date().toISOString(),
        importedBy: currentUserProfile?.displayName || currentUser?.email,
        isNew: true
      }));
      
      // Get current offseason doc
      const offseasonRef = doc(db, 'offseasonRosters', 'current');
      const offseasonDoc = await getDoc(offseasonRef);
      
      if (offseasonDoc.exists()) {
        // Merge with existing unassigned
        const existingData = offseasonDoc.data();
        const existingUnassigned = existingData.unassignedPlayers || [];
        
        // Check for duplicates
        const existingIds = new Set(existingUnassigned.map(p => p.id));
        const newUnassigned = unassignedPlayers.filter(p => !existingIds.has(p.id));
        
        if (newUnassigned.length < unassignedPlayers.length) {
          const skipped = unassignedPlayers.length - newUnassigned.length;
          addAuditEntry('warning', `Skipped ${skipped} duplicate unassigned players`);
        }
        
        await updateDoc(offseasonRef, {
          unassignedPlayers: [...existingUnassigned, ...newUnassigned],
          lastImport: serverTimestamp(),
          lastImportBy: currentUserProfile?.displayName || currentUser?.email,
          lastImportSummary: {
            returning: matchResults.returning.length,
            newAdded: newUnassigned.length
          }
        });
      } else {
        // Create new offseason doc
        await setDoc(offseasonRef, {
          teams: {},
          unavailablePlayers: [],
          unassignedPlayers: unassignedPlayers,
          seasonType: 'fall-to-summer',
          createdAt: serverTimestamp(),
          createdBy: currentUser.uid,
          createdByName: currentUserProfile?.displayName || currentUser?.email,
          lastImport: serverTimestamp(),
          lastImportBy: currentUserProfile?.displayName || currentUser?.email,
          lastImportSummary: {
            returning: matchResults.returning.length,
            newAdded: unassignedPlayers.length
          }
        });
      }
      
      // Log the import to audit collection
      await addDoc(collection(db, 'rosterImportAudit'), {
        timestamp: serverTimestamp(),
        performedBy: currentUser.uid,
        performedByName: currentUserProfile?.displayName || currentUser?.email,
        comparedSeasons: targetSeasons,
        summary: {
          totalUploaded: matchResults.returning.length + matchResults.new.length,
          returning: matchResults.returning.length,
          new: matchResults.new.length,
          missing: missingPlayers.length
        },
        returningPlayers: matchResults.returning.map(r => ({
          name: r.match?.name,
          lastTeam: r.lastTeam
        })),
        newPlayers: matchResults.new.map(r => r.uploadedName),
        missingPlayers: missingPlayers.map(p => p.name),
        auditLog: auditLog
      });
      
      addAuditEntry('push', `Successfully pushed to offseason rosters: ${unassignedPlayers.length} new players`);
      showToast('Successfully pushed to Offseason Rosters!', 'success');
      
    } catch (error) {
      console.error('Error pushing to offseason:', error);
      showToast('Error: ' + error.message, 'error');
      addAuditEntry('error', `Push failed: ${error.message}`);
    } finally {
      btn.disabled = false;
      btn.innerHTML = 'üî• Push to Offseason Rosters';
    }
  }
  window.pushToOffseason = pushToOffseason;

  window.resetUpload = function() {
    if (matchResults.returning.length > 0 || matchResults.new.length > 0) {
      if (!confirm('This will clear all analysis results. Continue?')) {
        return;
      }
    }
    
    uploadedNames = [];
    matchResults = { returning: [], review: [], new: [] };
    missingPlayers = [];
    window.uploadedFileData = null;
    window.uploadedHeaders = null;
    
    document.getElementById('rosterUploadPhase').style.display = 'block';
    document.getElementById('rosterResultsPhase').style.display = 'none';
    document.getElementById('filePreview').style.display = 'none';
    document.getElementById('rosterFileInput').value = '';
    document.getElementById('nameColumnSelect').innerHTML = '<option value="">Select column...</option>';
    document.getElementById('previewCount').textContent = '0';
    
    addAuditEntry('reset', 'Upload reset by user');
  };

  function addAuditEntry(action, detail) {
    const timestamp = new Date().toLocaleTimeString();
    auditLog.push({ timestamp, action, detail });
    
    const logContainer = document.getElementById('auditLog');
    if (logContainer) {
      logContainer.innerHTML = auditLog.map(entry => `
        <div class="audit-entry">
          <span class="audit-time">[${entry.timestamp}]</span>
          <span class="audit-action">[${entry.action}]</span>
          <span class="audit-detail">${entry.detail}</span>
        </div>
      `).reverse().join('');
    }
  }

  function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  // ========================================
  // SEASONS & TEAMS LOADING
  // ========================================

  async function loadSeasons() {
    try {
      const seasonsSnapshot = await getDocs(collection(db, 'seasons'));
      allSeasons = seasonsSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })).sort((a, b) => {
        if (a.year !== b.year) return b.year - a.year;
        return a.season === 'fall' ? -1 : 1;
      });

      const select = document.getElementById('scheduleSeasonSelect');
      select.innerHTML = '<option value="">Select a season...</option>' +
        allSeasons.map(s => `<option value="${s.id}">${s.year} ${capitalize(s.season)}</option>`).join('');

      if (allSeasons.length > 0) {
        select.value = allSeasons[0].id;
      }
    } catch (error) {
      console.error('Error loading seasons:', error);
    }
  }

  async function loadTeams() {
    try {
      const teamsSnapshot = await getDocs(collection(db, 'teams'));
      allTeams = teamsSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      renderTeamChips();
    } catch (error) {
      console.error('Error loading teams:', error);
    }
  }

  function renderTeamChips() {
    const container = document.getElementById('teamFilterChips');
    container.innerHTML = allTeams.map(team => `
      <label class="team-chip" data-team="${team.id}">
        <input type="checkbox" onchange="toggleTeamSelection('${team.id}')">
        ${capitalize(team.name || team.id)}
      </label>
    `).join('');
  }

  async function loadRegisteredUsers() {
    try {
      const usersSnapshot = await getDocs(collection(db, 'users'));
      registeredUsers = usersSnapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      })).filter(u => u.fcmTokens && Object.keys(u.fcmTokens).length > 0);
    } catch (error) {
      console.error('Error loading users:', error);
    }
  }

  // ========================================
  // GAME FUNCTIONS
  // ========================================

  window.loadGames = async function() {
    const seasonId = document.getElementById('scheduleSeasonSelect').value;
    if (!seasonId) {
      document.getElementById('gameList').innerHTML = '<div class="empty-state">Select a season to load games</div>';
      return;
    }

    document.getElementById('gameList').innerHTML = '<div class="loading-text">Loading games...</div>';

    try {
      const gamesRef = collection(db, 'seasons', seasonId, 'games');
      const gamesSnapshot = await getDocs(gamesRef);
      
      gamesCache = gamesSnapshot.docs.map(doc => ({
        id: doc.id,
        seasonId,
        ...doc.data()
      })).sort((a, b) => {
        const dateA = a.date?.seconds || 0;
        const dateB = b.date?.seconds || 0;
        return dateA - dateB;
      });

      renderGameList();
    } catch (error) {
      console.error('Error loading games:', error);
      document.getElementById('gameList').innerHTML = '<div class="empty-state">Error loading games</div>';
    }
  };

  function renderGameList() {
    const container = document.getElementById('gameList');
    
    if (gamesCache.length === 0) {
      container.innerHTML = '<div class="empty-state">No games found for this season</div>';
      return;
    }

    container.innerHTML = gamesCache.map(game => {
      const dateStr = formatDate(game.date);
      const timeStr = formatTime(game.date);
      const status = game.status || (game.homeScore !== undefined ? 'completed' : 'scheduled');
      
      return `
        <div class="item-row ${selectedGame?.id === game.id ? 'selected' : ''}" onclick="selectGame('${game.id}')">
          <div class="item-info">
            <div class="item-title">${capitalize(game.homeTeamId || game.homeTeamName)} vs ${capitalize(game.awayTeamId || game.awayTeamName)}</div>
            <div class="item-subtitle">${dateStr} at ${timeStr}</div>
          </div>
          <div class="item-badges">
            <span class="badge badge-${status === 'completed' ? 'completed' : status === 'cancelled' ? 'inactive' : 'active'}">
              ${status}
            </span>
          </div>
        </div>
      `;
    }).join('');
  }

  window.selectGame = function(gameId) {
    selectedGame = gamesCache.find(g => g.id === gameId);
    originalGameData = { ...selectedGame };
    renderGameList();
    renderGameEditor();
  };

  function renderGameEditor() {
    const editor = document.getElementById('gameEditor');
    
    if (!selectedGame) {
      editor.innerHTML = `
        <div class="no-selection">
          <div class="icon">üìã</div>
          <p>Select a game from the list to edit its schedule</p>
        </div>
      `;
      return;
    }

    const gameDate = selectedGame.date?.seconds 
      ? new Date(selectedGame.date.seconds * 1000).toISOString().slice(0, 16)
      : '';

    editor.classList.add('active');
    editor.innerHTML = `
      <h3 style="margin-bottom: 1rem;">Edit Game: ${capitalize(selectedGame.homeTeamId)} vs ${capitalize(selectedGame.awayTeamId)}</h3>
      <div class="game-form">
        <div class="form-group">
          <label>Date & Time</label>
          <input type="datetime-local" id="editGameDate" value="${gameDate}">
        </div>
        <div class="form-group">
          <label>Status</label>
          <select id="editGameStatus">
            <option value="scheduled" ${selectedGame.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
            <option value="completed" ${selectedGame.status === 'completed' ? 'selected' : ''}>Completed</option>
            <option value="cancelled" ${selectedGame.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            <option value="postponed" ${selectedGame.status === 'postponed' ? 'selected' : ''}>Postponed</option>
          </select>
        </div>
        <div class="form-group">
          <label>Location</label>
          <input type="text" id="editGameLocation" value="${selectedGame.location || ''}" placeholder="e.g., Field A">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="editGameNotes" rows="2" placeholder="Optional notes...">${selectedGame.notes || ''}</textarea>
        </div>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveGameChanges()">üíæ Save Changes</button>
        <button class="btn btn-secondary" onclick="cancelGameEdit()">Cancel</button>
      </div>
    `;
  }

  window.saveGameChanges = async function() {
    if (!selectedGame) return;

    const dateInput = document.getElementById('editGameDate').value;
    const status = document.getElementById('editGameStatus').value;
    const location = document.getElementById('editGameLocation').value;
    const notes = document.getElementById('editGameNotes').value;

    try {
      const gameRef = doc(db, 'seasons', selectedGame.seasonId, 'games', selectedGame.id);
      
      const updates = {
        status,
        location,
        notes,
        lastModified: serverTimestamp(),
        lastModifiedBy: currentUser.uid
      };

      if (dateInput) {
        updates.date = Timestamp.fromDate(new Date(dateInput));
      }

      await updateDoc(gameRef, updates);
      
      showToast('Game updated successfully!', 'success');
      loadGames();
      
    } catch (error) {
      console.error('Error saving game:', error);
      showToast('Error saving game: ' + error.message, 'error');
    }
  };

  window.cancelGameEdit = function() {
    selectedGame = null;
    renderGameEditor();
    renderGameList();
  };

  // ========================================
  // BANNER FUNCTIONS
  // ========================================

  window.loadBanners = async function() {
    document.getElementById('bannerList').innerHTML = '<div class="loading-text">Loading...</div>';

    try {
      const bannersRef = collection(db, 'bannerMessages');
      const q = query(bannersRef, orderBy('priority', 'asc'));
      const snapshot = await getDocs(q);
      
      bannersCache = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      renderBannerList();
    } catch (error) {
      console.error('Error loading banners:', error);
      document.getElementById('bannerList').innerHTML = '<div class="empty-state">Error loading banners</div>';
    }
  };

  function renderBannerList() {
    const container = document.getElementById('bannerList');
    
    if (bannersCache.length === 0) {
      container.innerHTML = '<div class="empty-state">No banners found. Click "Add Banner" to create one.</div>';
      return;
    }

    container.innerHTML = bannersCache.map(banner => `
      <div class="item-row ${selectedBanner?.id === banner.id ? 'selected' : ''}" onclick="selectBanner('${banner.id}')">
        <div class="item-info">
          <div class="item-title">${banner.text?.substring(0, 50)}${banner.text?.length > 50 ? '...' : ''}</div>
          <div class="item-subtitle">Priority: ${banner.priority} | ${banner.active ? 'Active' : 'Inactive'}</div>
        </div>
        <div class="item-badges">
          <span class="badge badge-${banner.active ? 'active' : 'inactive'}">
            ${banner.active ? 'Active' : 'Inactive'}
          </span>
        </div>
      </div>
    `).join('');
  }

  window.selectBanner = function(bannerId) {
    selectedBanner = bannersCache.find(b => b.id === bannerId);
    renderBannerList();
    renderBannerEditor();
  };

  window.showNewBannerForm = function() {
    selectedBanner = { isNew: true, active: true, priority: 10 };
    renderBannerEditor();
  };

  function renderBannerEditor() {
    const editor = document.getElementById('bannerEditor');
    
    if (!selectedBanner) {
      editor.innerHTML = `
        <div class="no-selection">
          <div class="icon">üì¢</div>
          <p>Select a banner to edit or click "Add Banner" to create a new one</p>
        </div>
      `;
      return;
    }

    editor.classList.add('active');
    editor.innerHTML = `
      <h3 style="margin-bottom: 1rem;">${selectedBanner.isNew ? 'Create New Banner' : 'Edit Banner'}</h3>
      <div class="form-group">
        <label>Banner Text</label>
        <textarea id="editBannerText" rows="3" placeholder="Enter banner message...">${selectedBanner.text || ''}</textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Priority (lower = first)</label>
          <input type="number" id="editBannerPriority" value="${selectedBanner.priority || 10}" min="1" max="100">
        </div>
        <div class="form-group">
          <label>Link URL (optional)</label>
          <input type="text" id="editBannerLink" value="${selectedBanner.link || ''}" placeholder="https://...">
        </div>
      </div>
      <div class="checkbox-group">
        <input type="checkbox" id="editBannerActive" ${selectedBanner.active ? 'checked' : ''}>
        <label for="editBannerActive">Banner is active</label>
      </div>
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveBanner()">üíæ ${selectedBanner.isNew ? 'Create' : 'Save'}</button>
        ${!selectedBanner.isNew ? '<button class="btn btn-danger" onclick="deleteBanner()">üóëÔ∏è Delete</button>' : ''}
        <button class="btn btn-secondary" onclick="cancelBannerEdit()">Cancel</button>
      </div>
    `;
  }

  window.saveBanner = async function() {
    const text = document.getElementById('editBannerText').value.trim();
    const priority = parseInt(document.getElementById('editBannerPriority').value) || 10;
    const link = document.getElementById('editBannerLink').value.trim();
    const active = document.getElementById('editBannerActive').checked;

    if (!text) {
      showToast('Please enter banner text', 'error');
      return;
    }

    try {
      const bannerData = {
        text,
        priority,
        link: link || null,
        active,
        lastModified: serverTimestamp(),
        lastModifiedBy: currentUser.uid
      };

      if (selectedBanner.isNew) {
        bannerData.createdAt = serverTimestamp();
        bannerData.createdBy = currentUser.uid;
        await addDoc(collection(db, 'bannerMessages'), bannerData);
        showToast('Banner created!', 'success');
      } else {
        await updateDoc(doc(db, 'bannerMessages', selectedBanner.id), bannerData);
        showToast('Banner updated!', 'success');
      }

      selectedBanner = null;
      loadBanners();
      renderBannerEditor();
      
    } catch (error) {
      console.error('Error saving banner:', error);
      showToast('Error: ' + error.message, 'error');
    }
  };

  window.deleteBanner = async function() {
    if (!selectedBanner || selectedBanner.isNew) return;
    
    if (!confirm('Delete this banner?')) return;

    try {
      await deleteDoc(doc(db, 'bannerMessages', selectedBanner.id));
      showToast('Banner deleted', 'success');
      selectedBanner = null;
      loadBanners();
      renderBannerEditor();
    } catch (error) {
      console.error('Error deleting banner:', error);
      showToast('Error: ' + error.message, 'error');
    }
  };

  window.cancelBannerEdit = function() {
    selectedBanner = null;
    renderBannerEditor();
    renderBannerList();
  };

  // ========================================
  // NOTIFICATION FUNCTIONS
  // ========================================

  window.updateNotificationPreview = function() {
    const title = document.getElementById('notificationTitle').value;
    const body = document.getElementById('notificationBody').value;
    
    document.getElementById('titleCharCount').textContent = title.length;
    document.getElementById('bodyCharCount').textContent = body.length;
    
    document.getElementById('previewTitle').textContent = title || 'Notification Title';
    document.getElementById('previewBody').textContent = body || 'Your message will appear here...';
    
    if (title || body) {
      document.getElementById('previewPanel').classList.add('visible');
    }
    
    updateSendButton();
  };

  window.handleLinkTypeChange = function() {
    const linkType = document.getElementById('notificationLinkType').value;
    document.getElementById('customLinkGroup').style.display = linkType === 'custom' ? 'block' : 'none';
  };

  window.toggleTeamSelection = function(teamId) {
    const chip = document.querySelector(`.team-chip[data-team="${teamId}"]`);
    const index = selectedTeams.indexOf(teamId);
    
    if (index >= 0) {
      selectedTeams.splice(index, 1);
      chip.classList.remove('selected');
    } else {
      selectedTeams.push(teamId);
      chip.classList.add('selected');
    }
    
    targetingCaptains = false;
    document.getElementById('captainsSelectedIndicator').style.display = 'none';
    updateRecipientPreview();
    updateSendButton();
  };

  window.selectAllCaptains = function() {
    selectedTeams = [];
    document.querySelectorAll('.team-chip').forEach(chip => {
      chip.classList.remove('selected');
    });
    
    targetingCaptains = true;
    document.getElementById('captainsSelectedIndicator').style.display = 'block';
    updateRecipientPreview();
    updateSendButton();
  };

  window.clearTeamSelection = function() {
    selectedTeams = [];
    targetingCaptains = false;
    document.querySelectorAll('.team-chip').forEach(chip => {
      chip.classList.remove('selected');
    });
    document.getElementById('captainsSelectedIndicator').style.display = 'none';
    updateRecipientPreview();
    updateSendButton();
  };

  function updateRecipientPreview() {
    const preview = document.getElementById('recipientPreview');
    const countText = document.getElementById('recipientCountText');
    
    if (selectedTeams.length === 0 && !targetingCaptains) {
      preview.style.display = 'none';
      return;
    }
    
    let count = 0;
    if (targetingCaptains) {
      count = registeredUsers.filter(u => u.isCaptain).length;
    } else {
      count = registeredUsers.filter(u => selectedTeams.includes(u.linkedTeam)).length;
    }
    
    preview.style.display = 'block';
    countText.textContent = `~${count} recipients`;
  }

  function updateSendButton() {
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    const btn = document.getElementById('sendNotificationBtn');
    
    btn.disabled = !title || !body;
  }

  window.sendNotification = async function() {
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    const priority = document.getElementById('notificationPriority').value;
    const linkType = document.getElementById('notificationLinkType').value;
    const customLink = document.getElementById('notificationCustomLink').value.trim();
    
    if (!title || !body) {
      showToast('Please enter title and message', 'error');
      return;
    }
    
    const btn = document.getElementById('sendNotificationBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Sending...';
    
    try {
      const sendAnnouncementFn = httpsCallable(functions, 'sendAnnouncement');
      
      const payload = {
        title,
        body,
        priority,
        targetTeams: selectedTeams.length > 0 ? selectedTeams : null,
        targetCaptainsOnly: targetingCaptains
      };
      
      if (linkType === 'custom' && customLink) {
        payload.link = customLink;
      } else if (linkType) {
        payload.linkType = linkType;
      }
      
      const result = await sendAnnouncementFn(payload);
      
      if (result.data.success) {
        showToast(`Sent to ${result.data.recipientCount} users!`, 'success');
      } else {
        throw new Error(result.data.error || 'Unknown error');
      }
      
      // Reset form
      document.getElementById('notificationTitle').value = '';
      document.getElementById('notificationBody').value = '';
      document.getElementById('notificationPriority').value = 'normal';
      document.getElementById('notificationLinkType').value = '';
      document.getElementById('notificationCustomLink').value = '';
      document.getElementById('customLinkGroup').style.display = 'none';
      document.getElementById('previewPanel').classList.remove('visible');
      document.getElementById('titleCharCount').textContent = '0';
      document.getElementById('bodyCharCount').textContent = '0';
      document.getElementById('captainsSelectedIndicator').style.display = 'none';
      
      selectedTeams = [];
      targetingCaptains = false;
      document.querySelectorAll('.team-chip').forEach(chip => {
        chip.classList.remove('selected');
      });
      
      await loadRecentAnnouncements();
      updateSendButton();
      
    } catch (error) {
      console.error('Error sending notification:', error);
      showToast(`‚ùå ${error.message || 'Failed to send notification'}`, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
      updateSendButton();
    }
  };

  window.sendTestNotification = async function() {
    const btn = document.getElementById('testNotificationBtn');
    const status = document.getElementById('testNotificationStatus');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Sending...';
    status.textContent = '';
    
    try {
      const testNotificationFn = httpsCallable(functions, 'testNotification');
      const result = await testNotificationFn({});
      
      status.textContent = '‚úÖ Test sent! Check your notifications.';
      status.style.color = 'var(--success-color)';
      showToast('Test notification sent!', 'success');
      
    } catch (error) {
      console.error('Error sending test notification:', error);
      status.textContent = `‚ùå ${error.message || 'Failed'}`;
      status.style.color = 'var(--danger-color)';
      showToast(error.message || 'Failed to send test notification', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  window.loadRecentAnnouncements = async function() {
    const listEl = document.getElementById('recentAnnouncementsList');
    listEl.innerHTML = '<div class="loading-text">Loading...</div>';
    
    try {
      const q = query(
        collection(db, 'announcements'),
        orderBy('sentAt', 'desc'),
        limit(10)
      );
      
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        listEl.innerHTML = '<div class="no-recipients">No announcements sent yet</div>';
        return;
      }
      
      listEl.innerHTML = snapshot.docs.map(doc => {
        const data = doc.data();
        const docId = doc.id;
        const sentAt = data.sentAt?.toDate?.() 
          ? data.sentAt.toDate().toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            })
          : 'Unknown';
        
        const priorityClass = data.priority === 'urgent' 
          ? 'priority-urgent'
          : data.priority === 'info'
          ? 'priority-info'
          : 'priority-normal';
        
        const priorityLabel = data.priority === 'urgent' 
          ? 'üö® Urgent'
          : data.priority === 'info'
          ? '‚ÑπÔ∏è Info'
          : 'üì¢ Normal';
        
        const scopeLabel = data.wasFiltered === false || data.isLeagueWide
          ? 'League-wide' 
          : (data.targetTeams?.length > 0 
            ? data.targetTeams.map(t => capitalize(t)).join(', ')
            : `${data.targetedUserCount || data.recipientCount || 0} users`);
        
        const isUnsent = data.unsent === true;
        
        return `
          <div class="recent-item ${isUnsent ? 'unsent' : ''}" data-id="${docId}">
            <div class="recent-item-header">
              <div class="recent-item-title">${data.title || 'Untitled'}</div>
              <div class="recent-item-actions">
                ${isUnsent 
                  ? '<span class="unsent-badge">Recalled</span>' 
                  : `<button class="unsend-btn" onclick="unsendAnnouncement('${docId}', '${(data.title || '').replace(/'/g, "\\'")}')">üóëÔ∏è Unsend</button>`
                }
                <span class="priority-badge ${priorityClass}">${priorityLabel}</span>
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-light); line-height: 1.4; ${isUnsent ? 'text-decoration: line-through; opacity: 0.6;' : ''}">
              ${data.body?.substring(0, 100) || ''}${(data.body?.length || 0) > 100 ? '...' : ''}
            </div>
            <div class="recent-item-meta">
              ${sentAt} by ${data.sentByName || 'Unknown'} ‚Ä¢ ${data.recipientCount || 0} delivered ‚Ä¢ ${scopeLabel}
              ${isUnsent ? ` ‚Ä¢ <span style="color: var(--danger-color);">Recalled</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
    } catch (error) {
      console.error('Error loading announcements:', error);
      listEl.innerHTML = '<div class="no-recipients">Error loading announcements</div>';
    }
  };

  window.unsendAnnouncement = async function(announcementId, title) {
    if (!confirm(`Are you sure you want to unsend "${title}"?\n\nThis will remove the notification from all users' feeds.`)) {
      return;
    }
    
    const btn = document.querySelector(`[data-id="${announcementId}"] .unsend-btn`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = '‚è≥ Removing...';
    }
    
    try {
      const unsendAnnouncementFn = httpsCallable(functions, 'unsendAnnouncement');
      const result = await unsendAnnouncementFn({
        announcementId,
        title
      });
      
      if (result.data.success) {
        showToast(`Removed notification from ${result.data.deletedCount} user feeds`, 'success');
        await loadRecentAnnouncements();
      } else {
        throw new Error('Failed to unsend');
      }
      
    } catch (error) {
      console.error('Error unsending announcement:', error);
      showToast('Failed to unsend announcement: ' + error.message, 'error');
      
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è Unsend';
      }
    }
  };

  // ========================================
  // CLEANUP FUNCTIONS (Admin Only)
  // ========================================
  
  window.showCleanupModal = function() {
    document.getElementById('cleanupModal').style.display = 'flex';
    document.getElementById('cleanupOption').value = '';
    document.getElementById('cleanupTitle').value = '';
  };
  
  window.hideCleanupModal = function() {
    document.getElementById('cleanupModal').style.display = 'none';
  };
  
  window.runCleanup = async function() {
    const option = document.getElementById('cleanupOption').value;
    const title = document.getElementById('cleanupTitle').value.trim();
    
    if (!option && !title) {
      showToast('Please select an option or enter a title', 'error');
      return;
    }
    
    const confirmMsg = title 
      ? `Delete all notifications with title "${title}"?`
      : option === 'all'
      ? '‚ö†Ô∏è DELETE ALL NOTIFICATIONS FROM ALL USERS? This cannot be undone!'
      : `Delete all ${option.replace('type-', '')} notifications from all users?`;
    
    if (!confirm(confirmMsg)) {
      return;
    }
    
    try {
      const cleanupFn = httpsCallable(functions, 'cleanupNotifications');
      
      let params = {};
      if (title) {
        params.title = title;
      } else if (option === 'all') {
        params.all = true;
      } else if (option.startsWith('type-')) {
        params.type = option.replace('type-', '');
      }
      
      const result = await cleanupFn(params);
      
      if (result.data.success) {
        showToast(`Deleted ${result.data.totalDeleted} notifications from ${result.data.usersAffected} users`, 'success');
        hideCleanupModal();
        await loadRecentAnnouncements();
      }
      
    } catch (error) {
      console.error('Cleanup error:', error);
      showToast('Cleanup failed: ' + error.message, 'error');
    }
  };

  // ========================================
  // UTILITY FUNCTIONS
  // ========================================

  function formatDate(timestamp) {
    if (!timestamp?.seconds) return 'TBD';
    const d = new Date(timestamp.seconds * 1000);
    return d.toLocaleDateString('en-US', { 
      weekday: 'short', 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  }

  function formatTime(timestamp) {
    if (!timestamp?.seconds) return 'TBD';
    const d = new Date(timestamp.seconds * 1000);
    return d.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit'
    });
  }

  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†';
    toast.innerHTML = `<span>${icon}</span> ${message}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Make functions globally available
  window.showToast = showToast;
</script>

<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
<script src="theme-toggle.js"></script>
</body>
</html>
