<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>League Staff Admin - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --staff-color: #0369a1;
    --staff-secondary: #0284c7;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
    --whatsapp-color: #25D366;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    color: var(--text-dark);
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: '‚öôÔ∏è';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }

  /* Auth Gate */
  .auth-gate {
    max-width: 500px;
    margin: 4rem auto;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .auth-gate h2 {
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .auth-gate p {
    color: var(--text-light);
    margin-bottom: 2rem;
  }

  .auth-gate a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--staff-color) 0%, var(--staff-secondary) 100%);
    color: white;
    padding: 2.5rem 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .header::after {
    content: '‚öôÔ∏è';
    position: absolute;
    bottom: -40px;
    left: -30px;
    font-size: 180px;
    opacity: 0.08;
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .role-badges {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 0.75rem;
  }

  .role-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
  }

  .header-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .nav-btn {
    padding: 0.875rem 1.5rem;
    border: 2px solid white;
    background: white;
    color: var(--staff-color);
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .nav-btn:hover {
    background: var(--accent-color);
    border-color: var(--accent-color);
    transform: translateY(-2px);
  }

  /* Container */
  .container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  /* Tab Navigation */
  .tab-nav {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    flex-wrap: wrap;
    background: var(--card-bg);
    padding: 0.5rem;
    border-radius: 12px;
    box-shadow: var(--shadow-sm);
  }

  .tab-btn {
    flex: 1;
    min-width: 150px;
    padding: 1rem 1.5rem;
    border: none;
    background: transparent;
    color: var(--text-light);
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .tab-btn:hover {
    background: #f1f5f9;
    color: var(--text-dark);
  }

  .tab-btn.active {
    background: var(--staff-color);
    color: white;
  }

  .tab-btn .icon {
    font-size: 1.2rem;
  }

  /* Tab Content */
  .tab-content {
    display: none;
  }

  .tab-content.active {
    display: block;
  }

  /* Section Cards */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .section-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-content {
    padding: 1.5rem;
  }

  /* Season Selector */
  .season-selector {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .season-selector label {
    font-weight: 600;
  }

  .season-selector select {
    width: auto;
    min-width: 200px;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  input, select, textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
  }

  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--staff-color);
    box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
  }

  .hint {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  /* Checkbox Group */
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .checkbox-group input[type="checkbox"] {
    width: 1.25rem;
    height: 1.25rem;
    accent-color: var(--staff-color);
  }

  .checkbox-group label {
    margin: 0;
    cursor: pointer;
  }

  /* Buttons */
  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
  }

  .btn-primary {
    background: var(--staff-color);
    color: white;
  }

  .btn-primary:hover {
    background: var(--staff-secondary);
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #16a34a;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-secondary {
    background: #e2e8f0;
    color: var(--text-dark);
  }

  .btn-secondary:hover {
    background: #cbd5e1;
  }

  .btn-whatsapp {
    background: var(--whatsapp-color);
    color: white;
  }

  .btn-whatsapp:hover {
    background: #128C7E;
  }

  .btn-group {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  /* Item List */
  .item-list {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    max-height: 350px;
    overflow-y: auto;
  }

  .item-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.875rem 1rem;
    border-bottom: 1px solid var(--border-color);
    cursor: pointer;
    transition: background 0.2s ease;
  }

  .item-row:last-child {
    border-bottom: none;
  }

  .item-row:hover {
    background: #f8fafc;
  }

  .item-row.selected {
    background: #e0f2fe;
    border-left: 3px solid var(--staff-color);
  }

  .item-info {
    flex: 1;
  }

  .item-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .item-subtitle {
    font-size: 0.85rem;
    color: var(--text-light);
  }

  .item-badges {
    display: flex;
    gap: 0.5rem;
  }

  .badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .badge-active {
    background: #dcfce7;
    color: #166534;
  }

  .badge-inactive {
    background: #fee2e2;
    color: #991b1b;
  }

  .badge-postponed {
    background: #fef3c7;
    color: #92400e;
  }

  .badge-completed {
    background: #dbeafe;
    color: #1e40af;
  }

  .badge-scheduled {
    background: #f3e8ff;
    color: #6b21a8;
  }

  /* Editor Panel */
  .editor-panel {
    background: #f8fafc;
    border-radius: 12px;
    padding: 1.5rem;
    margin-top: 1.5rem;
    border: 2px dashed var(--border-color);
    transition: all 0.3s ease;
  }

  .editor-panel.active {
    border-style: solid;
    border-color: var(--staff-color);
    background: white;
  }

  .editor-panel h3 {
    margin: 0 0 1rem 0;
    color: var(--staff-color);
  }

  .editor-panel .no-selection {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  .editor-panel .no-selection .icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  /* Change Preview */
  .change-preview {
    background: #f0fdf4;
    border: 2px solid var(--success-color);
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
  }

  .change-preview h4 {
    margin: 0 0 0.5rem 0;
    color: var(--success-color);
  }

  .change-preview pre {
    margin: 0;
    white-space: pre-wrap;
    font-family: inherit;
    font-size: 0.9rem;
    color: var(--text-dark);
  }

  /* Original Info Box */
  .original-info {
    background: #fef3c7;
    border: 1px solid #f59e0b;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    font-size: 0.9rem;
  }

  .original-info h5 {
    margin: 0 0 0.5rem 0;
    color: #92400e;
  }

  .original-info p {
    margin: 0.25rem 0;
  }

  /* Main Layout Grid for Notifications */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 2rem;
  }

  @media (max-width: 1000px) {
    .main-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Notification Specific Styles */
  .recipient-list {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 1rem;
  }

  .recipient-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .recipient-item:last-child {
    border-bottom: none;
  }

  .recipient-info {
    flex: 1;
  }

  .recipient-name {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .recipient-team {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  .recipient-count {
    background: var(--staff-color);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .preview-panel {
    background: #f8fafc;
    border: 2px dashed var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    opacity: 0.6;
    transition: all 0.3s ease;
  }

  .preview-panel.visible {
    opacity: 1;
    border-style: solid;
    border-color: var(--staff-color);
    background: white;
  }

  .preview-phone {
    background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
    border-radius: 24px;
    padding: 1.5rem;
    max-width: 280px;
    margin: 0 auto;
    box-shadow: var(--shadow-lg);
  }

  .preview-notification {
    background: white;
    border-radius: 12px;
    padding: 1rem;
    box-shadow: var(--shadow-sm);
  }

  .preview-notification-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .preview-app-icon {
    width: 24px;
    height: 24px;
    background: var(--primary-color);
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.8rem;
  }

  .preview-app-name {
    font-size: 0.75rem;
    color: var(--text-light);
  }

  .preview-title {
    font-weight: 600;
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
  }

  .preview-body {
    font-size: 0.85rem;
    color: var(--text-light);
    line-height: 1.4;
  }

  /* Recent Announcements */
  .recent-item {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
  }

  .recent-item:last-child {
    border-bottom: none;
  }

  .recent-item.unsent {
    background: #fef2f2;
  }

  .recent-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }

  .recent-item-title {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .recent-item-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }

  .recent-item-meta {
    font-size: 0.75rem;
    color: var(--text-light);
    margin-top: 0.5rem;
  }

  .unsend-btn {
    background: none;
    border: 1px solid var(--danger-color);
    color: var(--danger-color);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .unsend-btn:hover {
    background: var(--danger-color);
    color: white;
  }

  .unsent-badge {
    background: var(--danger-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
  }

  .priority-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.7rem;
    font-weight: 600;
  }

  .priority-normal {
    background: #dbeafe;
    color: #1e40af;
  }

  .priority-urgent {
    background: #fee2e2;
    color: #991b1b;
  }

  .priority-info {
    background: #e0f2fe;
    color: #0369a1;
  }

  /* Team Filter Chips */
  .team-filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .team-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 20px;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    background: white;
  }

  .team-chip:hover {
    border-color: var(--staff-color);
  }

  .team-chip.selected {
    background: var(--staff-color);
    border-color: var(--staff-color);
    color: white;
  }

  .team-chip input {
    display: none;
  }

  /* Cleanup Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    align-items: center;
    justify-content: center;
    z-index: 10000;
  }

  .modal-content {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    max-width: 500px;
    width: 90%;
    box-shadow: var(--shadow-lg);
  }

  .modal-header {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    background: var(--text-dark);
    color: white;
    padding: 0.875rem 1.5rem;
    border-radius: 8px;
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: 0.5rem;
    animation: slideUp 0.3s ease;
    min-width: 280px;
    justify-content: center;
  }

  .toast-success { background: var(--success-color); }
  .toast-error { background: var(--danger-color); }
  .toast-warning { background: var(--warning-color); color: var(--text-dark); }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
  }

  .no-recipients {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  .loading-text {
    text-align: center;
    padding: 2rem;
    color: var(--text-light);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header {
      padding: 1.5rem 1rem;
    }

    .header h1 {
      font-size: 1.5rem;
    }

    .header-content {
      flex-direction: column;
      text-align: center;
    }

    .header-buttons {
      width: 100%;
      justify-content: center;
    }

    .container {
      padding: 0 1rem;
    }

    .tab-btn {
      min-width: 100px;
      padding: 0.75rem 1rem;
      font-size: 0.85rem;
    }

    .form-row {
      grid-template-columns: 1fr;
    }

    .btn-group {
      flex-direction: column;
    }

    .btn-group .btn {
      width: 100%;
      justify-content: center;
    }

    .toast-container {
      left: 1rem;
      right: 1rem;
      transform: none;
    }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate" style="display: none;">
  <h2>üîí Access Required</h2>
  <p>You must be a League Staff member or Admin to access this page.</p>
  <a href="profile.html">‚Üê Back to Profile</a>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
  <header class="header">
    <div class="header-content">
      <div>
        <h1>‚öôÔ∏è League Staff Admin</h1>
        <p>Manage schedules, banners, and notifications</p>
        <div class="role-badges" id="userRoleBadges"></div>
      </div>
      <div class="header-buttons">
        <a href="profile.html" class="nav-btn">‚Üê Back to Profile</a>
        <a href="index.html" class="nav-btn">üè† Home</a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="schedule" onclick="switchTab('schedule')">
        <span class="icon">üìÖ</span>
        Schedule
      </button>
      <button class="tab-btn" data-tab="banners" onclick="switchTab('banners')">
        <span class="icon">üì¢</span>
        Banners
      </button>
      <button class="tab-btn" data-tab="notifications" onclick="switchTab('notifications')">
        <span class="icon">üîî</span>
        Notifications
      </button>
    </div>

    <!-- ============================================ -->
    <!-- TAB: SCHEDULE EDITOR -->
    <!-- ============================================ -->
    <div class="tab-content active" id="tab-schedule">
      <div class="section">
        <div class="section-header">
          üìÖ League Schedule Editor
        </div>
        <div class="section-content">
          <div class="season-selector">
            <label>Season:</label>
            <select id="scheduleSeasonSelect" onchange="loadGames()">
              <option value="">Loading seasons...</option>
            </select>
            <button class="btn btn-secondary" onclick="loadGames()">üîÑ Refresh</button>
          </div>

          <div class="form-row">
            <div style="flex: 1;">
              <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Select Game to Edit:</label>
              <div class="item-list" id="gameList">
                <div class="empty-state">Select a season to load games</div>
              </div>
            </div>
          </div>

          <div class="editor-panel" id="gameEditor">
            <div class="no-selection">
              <div class="icon">üìã</div>
              <p>Select a game from the list to edit its schedule</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: BANNER MESSAGES -->
    <!-- ============================================ -->
    <div class="tab-content" id="tab-banners">
      <div class="section">
        <div class="section-header">
          üì¢ Banner Messages Manager
        </div>
        <div class="section-content">
          <p style="color: var(--text-light); margin-bottom: 1.5rem;">
            Manage the scrolling banner messages that appear on the home page. Messages are sorted by priority (lower numbers appear first).
          </p>
          
          <div class="btn-group" style="margin-bottom: 1.5rem; margin-top: 0;">
            <button class="btn btn-secondary" onclick="loadBanners()">üîÑ Refresh</button>
            <button class="btn btn-primary" onclick="showNewBannerForm()">‚ûï Add Banner</button>
          </div>

          <div class="item-list" id="bannerList">
            <div class="empty-state">Loading banners...</div>
          </div>

          <div class="editor-panel" id="bannerEditor">
            <div class="no-selection">
              <div class="icon">üì¢</div>
              <p>Select a banner to edit or click "Add Banner" to create a new one</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TAB: NOTIFICATIONS -->
    <!-- ============================================ -->
    <div class="tab-content" id="tab-notifications">
      <div class="main-grid">
        <div>
          <!-- Compose Notification -->
          <div class="section">
            <div class="section-header">
              ‚úèÔ∏è Compose Notification
            </div>
            <div class="section-content">
              <div class="form-group">
                <label>Title (Required)</label>
                <input type="text" id="notificationTitle" placeholder="e.g., Game Tonight!" maxlength="65" oninput="updateNotificationPreview()">
                <div class="hint"><span id="titleCharCount">0</span>/65 characters</div>
              </div>

              <div class="form-group">
                <label>Message Body (Required)</label>
                <textarea id="notificationBody" rows="3" placeholder="e.g., Don't forget! Aces vs. Bears at 6:30 PM at Memorial Field." maxlength="240" oninput="updateNotificationPreview()"></textarea>
                <div class="hint"><span id="bodyCharCount">0</span>/240 characters</div>
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label>Priority</label>
                  <select id="notificationPriority" onchange="updateNotificationPreview()">
                    <option value="normal">üì¢ Normal</option>
                    <option value="urgent">üö® Urgent</option>
                    <option value="info">‚ÑπÔ∏è Info</option>
                  </select>
                </div>
                <div class="form-group">
                  <label>Link (Optional)</label>
                  <select id="notificationLinkType" onchange="handleLinkTypeChange()">
                    <option value="">No link</option>
                    <option value="weekend-preview">Weekend Preview</option>
                    <option value="schedule">Season Schedule</option>
                    <option value="standings">Standings</option>
                    <option value="bracket">Playoff Bracket</option>
                    <option value="custom">Custom URL</option>
                  </select>
                </div>
              </div>

              <div class="form-group" id="customLinkGroup" style="display: none;">
                <label>Custom URL</label>
                <input type="text" id="notificationCustomLink" placeholder="https://...">
              </div>

              <div class="form-group">
                <label>Quick Actions</label>
                <div class="btn-group" style="margin-top: 0.5rem; margin-bottom: 1rem;">
                  <button class="btn btn-secondary" onclick="selectAllCaptains()">
                    üëë Message All Captains
                  </button>
                  <button class="btn btn-secondary" onclick="clearTeamSelection()">
                    üîÑ Clear Selection
                  </button>
                </div>
              </div>

              <div class="form-group">
                <label>Target Teams (Optional - leave empty for league-wide)</label>
                <div class="team-filter-chips" id="teamFilterChips">
                  Loading teams...
                </div>
              </div>

              <div id="recipientPreview" style="display: none;">
                <div class="recipient-count">
                  <span id="recipientCountText">0 recipients</span>
                </div>
              </div>

              <div id="captainsSelectedIndicator" style="display: none; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem;">
                <span style="font-weight: 600; color: #92400e;">üëë Targeting All Captains</span>
              </div>

              <button class="btn btn-success" id="sendNotificationBtn" onclick="sendNotification()" disabled style="width: 100%; justify-content: center; padding: 1rem;">
                üì§ Send Notification
              </button>
            </div>
          </div>

          <!-- Recent Announcements -->
          <div class="section">
            <div class="section-header">
              üìã Recent Announcements
            </div>
            <div class="section-content" style="padding: 0;">
              <div id="recentAnnouncementsList">
                <div class="loading-text">Loading...</div>
              </div>
            </div>
          </div>

          <!-- Admin Cleanup Section -->
          <div class="section" id="adminCleanupSection" style="display: none;">
            <div class="section-header" style="background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);">
              üóëÔ∏è Admin Cleanup Tools
            </div>
            <div class="section-content">
              <p style="color: var(--text-light); margin-bottom: 1rem;">
                These tools allow you to bulk delete notifications from all users. Use with caution!
              </p>
              <button class="btn btn-danger" onclick="showCleanupModal()">
                üóëÔ∏è Open Cleanup Tools
              </button>
            </div>
          </div>
        </div>

        <!-- Preview Panel -->
        <div>
          <div class="section">
            <div class="section-header">
              üì± Preview
            </div>
            <div class="section-content">
              <div class="preview-panel" id="previewPanel">
                <div class="preview-phone">
                  <div class="preview-notification">
                    <div class="preview-notification-header">
                      <div class="preview-app-icon">‚öæ</div>
                      <span class="preview-app-name">Mountainside Aces</span>
                    </div>
                    <div class="preview-title" id="previewTitle">Notification Title</div>
                    <div class="preview-body" id="previewBody">Your message will appear here...</div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Test Notification -->
          <div class="section">
            <div class="section-header">
              üß™ Test Your Setup
            </div>
            <div class="section-content">
              <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">
                Send a test notification to yourself to verify push notifications are working.
              </p>
              <button class="btn btn-secondary" id="testNotificationBtn" onclick="sendTestNotification()" style="width: 100%; justify-content: center;">
                üì≤ Send Test to Me
              </button>
              <div id="testNotificationStatus" style="margin-top: 0.5rem; font-size: 0.85rem; text-align: center;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Cleanup Modal -->
<div class="modal" id="cleanupModal">
  <div class="modal-content">
    <div class="modal-header">üóëÔ∏è Notification Cleanup</div>
    <div class="form-group">
      <label>Delete by Type</label>
      <select id="cleanupOption">
        <option value="">Select option...</option>
        <option value="type-announcement">All Announcements</option>
        <option value="type-game_reminder">All Game Reminders</option>
        <option value="type-milestone">All Milestones</option>
        <option value="all">‚ö†Ô∏è ALL Notifications</option>
      </select>
    </div>
    <div class="form-group">
      <label>Or Delete by Title (exact match)</label>
      <input type="text" id="cleanupTitle" placeholder="Enter notification title...">
    </div>
    <div class="btn-group">
      <button class="btn btn-danger" onclick="runCleanup()">üóëÔ∏è Delete</button>
      <button class="btn btn-secondary" onclick="hideCleanupModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
  import { auth, hasSpecialRole } from './firebase-auth.js';
  import { db } from './firebase-config.js';
  import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { 
    collection, 
    getDocs, 
    doc, 
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    addDoc,
    query,
    where,
    orderBy,
    limit,
    Timestamp,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const functions = getFunctions();

  // ========================================
  // GLOBAL STATE
  // ========================================
  let currentUser = null;
  let currentUserProfile = null;
  let allSeasons = [];
  let allTeams = [];
  let gamesCache = [];
  let bannersCache = [];
  let selectedGame = null;
  let originalGameData = null;
  let selectedBanner = null;
  let selectedTeams = [];
  let registeredUsers = [];
  let isAdmin = false;
  let isLeagueStaff = false;

  // ========================================
  // INITIALIZATION
  // ========================================
  
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authGate').style.display = 'block';
      return;
    }

    currentUser = user;

    try {
      // Check user roles
      const userDoc = await getDoc(doc(db, 'users', user.uid));
      if (userDoc.exists()) {
        currentUserProfile = userDoc.data();
        isAdmin = currentUserProfile.isAdmin === true;
        isLeagueStaff = currentUserProfile.isLeagueStaff === true;
      }

      // Must be league staff or admin
      if (!isAdmin && !isLeagueStaff) {
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('authGate').style.display = 'block';
        return;
      }

      // Show main content
      document.getElementById('mainContent').style.display = 'block';

      // Show role badges
      const badges = [];
      if (isAdmin) badges.push('<span class="role-badge">üëë Admin</span>');
      if (isLeagueStaff) badges.push('<span class="role-badge">üìã League Staff</span>');
      document.getElementById('userRoleBadges').innerHTML = badges.join('');

      // Show admin cleanup section if admin
      if (isAdmin) {
        document.getElementById('adminCleanupSection').style.display = 'block';
      }

      // Load initial data
      await Promise.all([
        loadSeasons(),
        loadTeams(),
        loadRegisteredUsers()
      ]);

      // Load tab-specific data
      await loadGames();
      await loadBanners();
      await loadRecentAnnouncements();
      renderTeamFilterChips();

      document.getElementById('loadingOverlay').classList.add('hidden');

    } catch (error) {
      console.error('Error initializing:', error);
      showToast('Error loading page', 'error');
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  });

  // ========================================
  // TAB SWITCHING
  // ========================================

  window.switchTab = function(tabName) {
    // Update tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.tab === tabName);
    });

    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.toggle('active', content.id === `tab-${tabName}`);
    });
  };

  // ========================================
  // LOAD SHARED DATA
  // ========================================

  async function loadSeasons() {
    try {
      const snapshot = await getDocs(collection(db, 'seasons'));
      allSeasons = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      
      // Sort by year descending
      allSeasons.sort((a, b) => {
        const yearA = parseInt(a.year) || 0;
        const yearB = parseInt(b.year) || 0;
        return yearB - yearA;
      });

      // Populate schedule season select
      const scheduleSelect = document.getElementById('scheduleSeasonSelect');
      scheduleSelect.innerHTML = allSeasons.map(s => 
        `<option value="${s.id}">${s.name || s.id}</option>`
      ).join('');

    } catch (error) {
      console.error('Error loading seasons:', error);
    }
  }

  async function loadTeams() {
    try {
      const snapshot = await getDocs(collection(db, 'teams'));
      allTeams = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      allTeams.sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));
    } catch (error) {
      console.error('Error loading teams:', error);
    }
  }

  async function loadRegisteredUsers() {
    try {
      const q = query(
        collection(db, 'users'),
        where('fcmToken', '!=', null)
      );
      const snapshot = await getDocs(q);
      registeredUsers = snapshot.docs.map(d => ({ uid: d.id, ...d.data() }));
    } catch (error) {
      console.error('Error loading registered users:', error);
      registeredUsers = [];
    }
  }

  // ========================================
  // SCHEDULE EDITOR FUNCTIONS
  // ========================================

  window.loadGames = async function() {
    const seasonId = document.getElementById('scheduleSeasonSelect').value;
    const listEl = document.getElementById('gameList');
    
    if (!seasonId) {
      listEl.innerHTML = '<div class="empty-state">Select a season</div>';
      return;
    }

    listEl.innerHTML = '<div class="empty-state">Loading games...</div>';

    try {
      const gamesRef = collection(db, 'seasons', seasonId, 'games');
      const q = query(gamesRef, orderBy('date', 'asc'));
      const snapshot = await getDocs(q);

      gamesCache = snapshot.docs.map(d => ({
        id: d.id,
        ...d.data()
      }));

      if (gamesCache.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No games found for this season</div>';
        return;
      }

      listEl.innerHTML = gamesCache.map((game, idx) => {
        const dateStr = formatDate(game.date);
        const timeStr = formatTime(game.date);
        const homeTeam = capitalize(game.homeTeamId || 'TBD');
        const awayTeam = capitalize(game.awayTeamId || 'TBD');
        const status = game.status || 'scheduled';
        const isManuallyEdited = game.manuallyEdited === true;

        let badgeClass = 'badge-scheduled';
        if (status === 'completed') badgeClass = 'badge-completed';
        else if (status === 'postponed') badgeClass = 'badge-postponed';
        else if (status === 'cancelled') badgeClass = 'badge-inactive';

        return `
          <div class="item-row" data-idx="${idx}" onclick="selectGame(${idx})">
            <div class="item-info">
              <div class="item-title">${awayTeam} @ ${homeTeam}</div>
              <div class="item-subtitle">${dateStr} at ${timeStr}</div>
            </div>
            <div class="item-badges">
              ${isManuallyEdited ? '<span class="badge badge-active">üîí Edited</span>' : ''}
              <span class="badge ${badgeClass}">${capitalize(status)}</span>
            </div>
          </div>
        `;
      }).join('');

    } catch (error) {
      console.error('Error loading games:', error);
      listEl.innerHTML = '<div class="empty-state">Error loading games</div>';
      showToast('Error loading games', 'error');
    }
  };

  window.selectGame = function(idx) {
    selectedGame = gamesCache[idx];
    originalGameData = { ...selectedGame };

    document.querySelectorAll('#gameList .item-row').forEach((row, i) => {
      row.classList.toggle('selected', i === idx);
    });

    renderGameEditor();
  };

  function renderGameEditor() {
    const editorEl = document.getElementById('gameEditor');
    editorEl.classList.add('active');

    const homeTeam = capitalize(selectedGame.homeTeamId || 'TBD');
    const awayTeam = capitalize(selectedGame.awayTeamId || 'TBD');

    // Format date/time for inputs
    let dateValue = '';
    let timeValue = '';
    if (selectedGame.date?.seconds) {
      const d = new Date(selectedGame.date.seconds * 1000);
      dateValue = d.toISOString().split('T')[0];
      timeValue = d.toTimeString().slice(0, 5);
    }

    // Build team options
    const teamOptions = allTeams.map(t => 
      `<option value="${t.id}">${capitalize(t.name || t.id)}</option>`
    ).join('');

    editorEl.innerHTML = `
      <h3>‚úèÔ∏è Edit Game</h3>
      
      <div class="original-info">
        <h5>üìã Original Schedule</h5>
        <p><strong>Date:</strong> ${formatDate(originalGameData.date)} at ${formatTime(originalGameData.date)}</p>
        <p><strong>Matchup:</strong> ${awayTeam} @ ${homeTeam}</p>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Game Date</label>
          <input type="date" id="gameDateInput" value="${dateValue}" onchange="updateGamePreview()">
        </div>
        <div class="form-group">
          <label>Game Time</label>
          <input type="time" id="gameTimeInput" value="${timeValue}" onchange="updateGamePreview()">
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Away Team</label>
          <select id="awayTeamSelect" onchange="updateGamePreview()">
            ${teamOptions}
          </select>
        </div>
        <div class="form-group">
          <label>Home Team</label>
          <select id="homeTeamSelect" onchange="updateGamePreview()">
            ${teamOptions}
          </select>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Status</label>
          <select id="gameStatusSelect" onchange="updateGamePreview()">
            <option value="scheduled" ${selectedGame.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
            <option value="postponed" ${selectedGame.status === 'postponed' ? 'selected' : ''}>Postponed</option>
            <option value="completed" ${selectedGame.status === 'completed' ? 'selected' : ''}>Completed</option>
            <option value="cancelled" ${selectedGame.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
          </select>
        </div>
        <div class="form-group">
          <label>Notes <span style="color: var(--text-light); font-weight: normal;">(optional)</span></label>
          <input type="text" id="changeNotes" placeholder="e.g., Rain delay, field change" onchange="updateGamePreview()">
        </div>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="manualEditCheck" ${selectedGame.manuallyEdited ? 'checked' : ''} checked>
        <label for="manualEditCheck">üîí Mark as manually edited (protects from automatic updates)</label>
      </div>
      
      <div class="change-preview" id="changePreview" style="display: none;">
        <h4>üì± WhatsApp Message Preview</h4>
        <pre id="whatsappMessage"></pre>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveGame()">üíæ Save Changes</button>
        <button class="btn btn-whatsapp" onclick="shareToWhatsApp()" id="shareBtn" disabled>
          üì≤ Share to WhatsApp
        </button>
        <button class="btn btn-secondary" onclick="clearGameSelection()">Cancel</button>
      </div>
    `;

    // Set team select values
    setTimeout(() => {
      document.getElementById('awayTeamSelect').value = selectedGame.awayTeamId || '';
      document.getElementById('homeTeamSelect').value = selectedGame.homeTeamId || '';
      updateGamePreview();
    }, 0);
  }

  window.updateGamePreview = function() {
    if (!selectedGame || !originalGameData) return;

    const newDate = document.getElementById('gameDateInput').value;
    const newTime = document.getElementById('gameTimeInput').value;
    const newAwayTeam = document.getElementById('awayTeamSelect').value;
    const newHomeTeam = document.getElementById('homeTeamSelect').value;
    const newStatus = document.getElementById('gameStatusSelect').value;
    const notes = document.getElementById('changeNotes').value.trim();

    // Check what changed
    const changes = [];
    
    const oldDate = originalGameData.date?.seconds ? new Date(originalGameData.date.seconds * 1000) : null;
    const oldDateStr = oldDate ? oldDate.toISOString().split('T')[0] : '';
    const oldTimeStr = oldDate ? oldDate.toTimeString().slice(0, 5) : '';

    if (newDate !== oldDateStr || newTime !== oldTimeStr) {
      changes.push('schedule');
    }
    if (newAwayTeam !== originalGameData.awayTeamId || newHomeTeam !== originalGameData.homeTeamId) {
      changes.push('teams');
    }
    if (newStatus !== originalGameData.status) {
      changes.push('status');
    }

    const previewEl = document.getElementById('changePreview');
    const messageEl = document.getElementById('whatsappMessage');
    const shareBtn = document.getElementById('shareBtn');

    if (changes.length === 0 && !notes) {
      previewEl.style.display = 'none';
      shareBtn.disabled = true;
      return;
    }

    previewEl.style.display = 'block';
    shareBtn.disabled = false;

    // Build WhatsApp message
    const awayTeamName = capitalize(newAwayTeam);
    const homeTeamName = capitalize(newHomeTeam);
    const newDateTime = new Date(`${newDate}T${newTime || '00:00'}`);
    const formattedDate = newDateTime.toLocaleDateString('en-US', { 
      weekday: 'long', 
      month: 'long', 
      day: 'numeric',
      year: 'numeric'
    });
    const formattedTime = newTime ? newDateTime.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit'
    }) : 'TBD';

    let message = `‚öæ *SCHEDULE UPDATE*\n\n`;
    message += `*${awayTeamName} @ ${homeTeamName}*\n\n`;

    if (newStatus === 'postponed') {
      message += `‚ö†Ô∏è *POSTPONED*\n`;
      if (notes) message += `Reason: ${notes}\n`;
      message += `\nNew date/time to be announced.\n`;
    } else if (newStatus === 'cancelled') {
      message += `‚ùå *CANCELLED*\n`;
      if (notes) message += `Reason: ${notes}\n`;
    } else {
      if (changes.includes('schedule')) {
        message += `üìÖ *New Date:* ${formattedDate}\n`;
        message += `‚è∞ *New Time:* ${formattedTime}\n`;
      } else {
        message += `üìÖ ${formattedDate}\n`;
        message += `‚è∞ ${formattedTime}\n`;
      }
      
      if (notes) {
        message += `\nüìù ${notes}\n`;
      }
    }

    message += `\n‚Äî Mountainside Aces League`;

    messageEl.textContent = message;
  };

  window.saveGame = async function() {
    if (!selectedGame) return;

    const seasonId = document.getElementById('scheduleSeasonSelect').value;
    
    const dateInput = document.getElementById('gameDateInput').value;
    const timeInput = document.getElementById('gameTimeInput').value;
    const awayTeamId = document.getElementById('awayTeamSelect').value;
    const homeTeamId = document.getElementById('homeTeamSelect').value;
    const status = document.getElementById('gameStatusSelect').value;
    const manuallyEdited = document.getElementById('manualEditCheck').checked;

    if (!dateInput || !awayTeamId || !homeTeamId) {
      showToast('Please fill in all required fields', 'warning');
      return;
    }

    try {
      const dateTimeStr = timeInput ? `${dateInput}T${timeInput}` : dateInput;
      const gameDate = new Date(dateTimeStr);

      const gameRef = doc(db, 'seasons', seasonId, 'games', selectedGame.id);
      
      await updateDoc(gameRef, {
        date: Timestamp.fromDate(gameDate),
        homeTeamId: homeTeamId,
        awayTeamId: awayTeamId,
        homeTeamName: capitalize(homeTeamId),
        awayTeamName: capitalize(awayTeamId),
        status: status,
        manuallyEdited: manuallyEdited,
        lastUpdate: serverTimestamp(),
        lastUpdatedBy: currentUserProfile?.displayName || 'League Staff'
      });

      showToast('Game saved successfully!', 'success');
      
      document.getElementById('shareBtn').disabled = false;
      
      await loadGames();

    } catch (error) {
      console.error('Error saving game:', error);
      showToast('Error saving game: ' + error.message, 'error');
    }
  };

  window.shareToWhatsApp = function() {
    const messageEl = document.getElementById('whatsappMessage');
    if (!messageEl) return;

    const message = encodeURIComponent(messageEl.textContent);
    const whatsappUrl = `https://wa.me/?text=${message}`;
    
    window.open(whatsappUrl, '_blank');
    showToast('Opening WhatsApp...', 'success');
  };

  window.clearGameSelection = function() {
    selectedGame = null;
    originalGameData = null;
    
    document.querySelectorAll('#gameList .item-row').forEach(row => {
      row.classList.remove('selected');
    });
    
    document.getElementById('gameEditor').classList.remove('active');
    document.getElementById('gameEditor').innerHTML = `
      <div class="no-selection">
        <div class="icon">üìã</div>
        <p>Select a game from the list to edit its schedule</p>
      </div>
    `;
  };

  // ========================================
  // BANNER MESSAGES FUNCTIONS
  // ========================================
  
  window.loadBanners = async function() {
    const listEl = document.getElementById('bannerList');
    listEl.innerHTML = '<div class="empty-state">Loading banners...</div>';

    try {
      const q = query(
        collection(db, 'bannerMessages'),
        orderBy('priority', 'asc')
      );
      const snapshot = await getDocs(q);

      bannersCache = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));

      if (bannersCache.length === 0) {
        listEl.innerHTML = '<div class="empty-state">No banners yet. Click "Add Banner" to create one.</div>';
        return;
      }

      listEl.innerHTML = bannersCache.map((banner, idx) => {
        const statusClass = banner.isActive ? 'badge-active' : 'badge-inactive';
        const statusText = banner.isActive ? 'Active' : 'Inactive';
        const messagePreview = (banner.message || '').substring(0, 50) + ((banner.message || '').length > 50 ? '...' : '');
        
        let dateInfo = '';
        if (banner.startDate || banner.endDate) {
          const start = banner.startDate?.toDate ? banner.startDate.toDate().toLocaleDateString() : '';
          const end = banner.endDate?.toDate ? banner.endDate.toDate().toLocaleDateString() : '';
          if (start && end) dateInfo = `${start} - ${end}`;
          else if (start) dateInfo = `From ${start}`;
          else if (end) dateInfo = `Until ${end}`;
        }
        
        return `
          <div class="item-row" data-idx="${idx}" onclick="selectBanner(${idx})">
            <div class="item-info">
              <div class="item-title">${messagePreview || '(No message)'}</div>
              <div class="item-subtitle">Priority: ${banner.priority || 0} ${dateInfo ? '‚Ä¢ ' + dateInfo : ''}</div>
            </div>
            <div class="item-badges">
              <span class="badge ${statusClass}">${statusText}</span>
            </div>
          </div>
        `;
      }).join('');

    } catch (error) {
      console.error('Error loading banners:', error);
      listEl.innerHTML = '<div class="empty-state">Error loading banners</div>';
      showToast('Error loading banners', 'error');
    }
  };

  window.selectBanner = function(idx) {
    selectedBanner = bannersCache[idx];
    
    document.querySelectorAll('#bannerList .item-row').forEach((row, i) => {
      row.classList.toggle('selected', i === idx);
    });

    renderBannerEditor(false);
  };

  window.showNewBannerForm = function() {
    selectedBanner = null;
    document.querySelectorAll('#bannerList .item-row').forEach(row => {
      row.classList.remove('selected');
    });
    renderBannerEditor(true);
  };

  function renderBannerEditor(isNew) {
    const editorEl = document.getElementById('bannerEditor');
    editorEl.classList.add('active');
    
    let startDateValue = '';
    let endDateValue = '';
    if (!isNew && selectedBanner) {
      if (selectedBanner.startDate?.toDate) {
        startDateValue = selectedBanner.startDate.toDate().toISOString().split('T')[0];
      }
      if (selectedBanner.endDate?.toDate) {
        endDateValue = selectedBanner.endDate.toDate().toISOString().split('T')[0];
      }
    }

    editorEl.innerHTML = `
      <h3>${isNew ? '‚ûï New Banner' : '‚úèÔ∏è Edit Banner'}</h3>
      
      <div class="form-group">
        <label>Banner Message</label>
        <textarea id="bannerMessageInput" placeholder="Enter the banner message text..." style="min-height: 100px;">${isNew ? '' : (selectedBanner?.message || '')}</textarea>
        <div class="hint">This text will scroll across the banner on the home page. Emojis are supported! üéâ</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Priority</label>
          <input type="number" id="bannerPriorityInput" value="${isNew ? '10' : (selectedBanner?.priority || 10)}" min="1" max="100" placeholder="1-100">
          <div class="hint">Lower numbers appear first (1 = highest priority)</div>
        </div>
        <div class="form-group">
          <div class="checkbox-group" style="margin-top: 1.75rem;">
            <input type="checkbox" id="bannerActiveCheck" ${isNew || selectedBanner?.isActive ? 'checked' : ''}>
            <label for="bannerActiveCheck">‚úÖ Banner is Active</label>
          </div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Start Date (Optional)</label>
          <input type="date" id="bannerStartDate" value="${startDateValue}">
          <div class="hint">Banner will only show on or after this date</div>
        </div>
        <div class="form-group">
          <label>End Date (Optional)</label>
          <input type="date" id="bannerEndDate" value="${endDateValue}">
          <div class="hint">Banner will stop showing after this date</div>
        </div>
      </div>
      
      <div class="btn-group">
        <button class="btn btn-success" onclick="saveBanner(${isNew})">üíæ ${isNew ? 'Create' : 'Save'}</button>
        ${!isNew ? `<button class="btn btn-danger" onclick="deleteBanner()">üóëÔ∏è Delete</button>` : ''}
        <button class="btn btn-secondary" onclick="clearBannerSelection()">Cancel</button>
      </div>
    `;
  }

  window.saveBanner = async function(isNew) {
    const message = document.getElementById('bannerMessageInput').value.trim();
    const priority = parseInt(document.getElementById('bannerPriorityInput').value) || 10;
    const isActive = document.getElementById('bannerActiveCheck').checked;
    const startDateStr = document.getElementById('bannerStartDate').value;
    const endDateStr = document.getElementById('bannerEndDate').value;

    if (!message) {
      showToast('Please enter a banner message', 'warning');
      return;
    }

    try {
      const bannerData = {
        message,
        priority,
        isActive,
        lastUpdated: serverTimestamp(),
        lastUpdatedBy: currentUser.uid
      };
      
      if (startDateStr) {
        bannerData.startDate = Timestamp.fromDate(new Date(startDateStr + 'T00:00:00'));
      } else {
        bannerData.startDate = null;
      }
      
      if (endDateStr) {
        bannerData.endDate = Timestamp.fromDate(new Date(endDateStr + 'T23:59:59'));
      } else {
        bannerData.endDate = null;
      }

      if (isNew) {
        bannerData.createdAt = serverTimestamp();
        bannerData.createdBy = currentUser.uid;
        await addDoc(collection(db, 'bannerMessages'), bannerData);
        showToast('Banner created successfully!', 'success');
      } else {
        await updateDoc(doc(db, 'bannerMessages', selectedBanner.id), bannerData);
        showToast('Banner updated successfully!', 'success');
      }

      await loadBanners();
      clearBannerSelection();

    } catch (error) {
      console.error('Error saving banner:', error);
      showToast('Error saving banner: ' + error.message, 'error');
    }
  };

  window.deleteBanner = async function() {
    if (!selectedBanner) return;
    
    if (!confirm(`Are you sure you want to delete this banner?\n\n"${selectedBanner.message?.substring(0, 50)}..."`)) {
      return;
    }

    try {
      await deleteDoc(doc(db, 'bannerMessages', selectedBanner.id));
      showToast('Banner deleted successfully!', 'success');
      await loadBanners();
      clearBannerSelection();
    } catch (error) {
      console.error('Error deleting banner:', error);
      showToast('Error deleting banner: ' + error.message, 'error');
    }
  };

  window.clearBannerSelection = function() {
    selectedBanner = null;
    document.querySelectorAll('#bannerList .item-row').forEach(row => {
      row.classList.remove('selected');
    });
    document.getElementById('bannerEditor').classList.remove('active');
    document.getElementById('bannerEditor').innerHTML = `
      <div class="no-selection">
        <div class="icon">üì¢</div>
        <p>Select a banner to edit or click "Add Banner" to create a new one</p>
      </div>
    `;
  };

  // ========================================
  // NOTIFICATION FUNCTIONS
  // ========================================

  let targetingCaptains = false;

  function renderTeamFilterChips() {
    const container = document.getElementById('teamFilterChips');
    // Filter out Kings from the team list
    const activeTeams = allTeams.filter(team => 
      team.id.toLowerCase() !== 'kings' && 
      (team.name || '').toLowerCase() !== 'kings'
    );
    container.innerHTML = activeTeams.map(team => `
      <label class="team-chip" onclick="toggleTeamFilter('${team.id}')">
        <input type="checkbox" value="${team.id}">
        ${capitalize(team.name || team.id)}
      </label>
    `).join('');
  }

  window.selectAllCaptains = function() {
    // Clear any team selections
    selectedTeams = [];
    document.querySelectorAll('.team-chip').forEach(chip => {
      chip.classList.remove('selected');
    });

    // Set targeting captains mode
    targetingCaptains = true;
    
    // Count captains
    const captains = registeredUsers.filter(u => u.isCaptain === true);
    
    // Update UI
    document.getElementById('captainsSelectedIndicator').style.display = 'block';
    document.getElementById('recipientPreview').style.display = 'block';
    document.getElementById('recipientCountText').textContent = `${captains.length} captains`;
    
    updateSendButton();
    showToast(`Targeting ${captains.length} team captains`, 'success');
  };

  window.clearTeamSelection = function() {
    selectedTeams = [];
    targetingCaptains = false;
    
    document.querySelectorAll('.team-chip').forEach(chip => {
      chip.classList.remove('selected');
    });
    
    document.getElementById('captainsSelectedIndicator').style.display = 'none';
    updateRecipientPreview();
    updateSendButton();
  };

  window.toggleTeamFilter = function(teamId) {
    // Clear captains mode if user is selecting teams
    if (targetingCaptains) {
      targetingCaptains = false;
      document.getElementById('captainsSelectedIndicator').style.display = 'none';
    }

    const idx = selectedTeams.indexOf(teamId);
    if (idx === -1) {
      selectedTeams.push(teamId);
    } else {
      selectedTeams.splice(idx, 1);
    }

    // Update chip visual state
    document.querySelectorAll('.team-chip').forEach(chip => {
      const checkbox = chip.querySelector('input');
      chip.classList.toggle('selected', selectedTeams.includes(checkbox.value));
    });

    updateRecipientPreview();
    updateSendButton();
  };

  function updateRecipientPreview() {
    const previewEl = document.getElementById('recipientPreview');
    const countEl = document.getElementById('recipientCountText');

    // Don't show standard preview if targeting captains
    if (targetingCaptains) {
      previewEl.style.display = 'none';
      return;
    }

    if (selectedTeams.length === 0) {
      // League-wide
      countEl.textContent = `${registeredUsers.length} recipients (league-wide)`;
    } else {
      // Filter by team
      const filtered = registeredUsers.filter(u => {
        const userTeam = (u.teamId || u.currentTeam || '').toLowerCase();
        return selectedTeams.some(t => t.toLowerCase() === userTeam);
      });
      countEl.textContent = `${filtered.length} recipients from ${selectedTeams.length} team(s)`;
    }
    
    previewEl.style.display = 'block';
  }

  window.updateNotificationPreview = function() {
    const title = document.getElementById('notificationTitle').value;
    const body = document.getElementById('notificationBody').value;

    document.getElementById('titleCharCount').textContent = title.length;
    document.getElementById('bodyCharCount').textContent = body.length;

    document.getElementById('previewTitle').textContent = title || 'Notification Title';
    document.getElementById('previewBody').textContent = body || 'Your message will appear here...';

    const previewPanel = document.getElementById('previewPanel');
    if (title || body) {
      previewPanel.classList.add('visible');
    } else {
      previewPanel.classList.remove('visible');
    }

    updateSendButton();
  };

  function updateSendButton() {
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    const btn = document.getElementById('sendNotificationBtn');
    
    btn.disabled = !title || !body;
  }

  window.handleLinkTypeChange = function() {
    const linkType = document.getElementById('notificationLinkType').value;
    const customGroup = document.getElementById('customLinkGroup');
    customGroup.style.display = linkType === 'custom' ? 'block' : 'none';
  };

  window.sendNotification = async function() {
    const title = document.getElementById('notificationTitle').value.trim();
    const body = document.getElementById('notificationBody').value.trim();
    const priority = document.getElementById('notificationPriority').value;
    const linkType = document.getElementById('notificationLinkType').value;
    const customLink = document.getElementById('notificationCustomLink').value.trim();

    if (!title || !body) {
      showToast('Please fill in title and message', 'warning');
      return;
    }

    const btn = document.getElementById('sendNotificationBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Sending...';

    try {
      // Determine link
      let link = '';
      switch (linkType) {
        case 'weekend-preview': link = '/weekend-preview.html'; break;
        case 'schedule': link = '/season.html'; break;
        case 'standings': link = '/season.html#standings'; break;
        case 'bracket': link = '/bracket.html'; break;
        case 'custom': link = customLink; break;
      }

      // Determine recipients
      let targetTeams = selectedTeams.length > 0 ? selectedTeams : [];
      let isLeagueWide = selectedTeams.length === 0 && !targetingCaptains;
      let isCaptainsOnly = targetingCaptains;
      
      // Get recipient IDs
      let recipientIds = [];
      if (isCaptainsOnly) {
        // Target only captains
        recipientIds = registeredUsers
          .filter(u => u.isCaptain === true)
          .map(u => u.uid);
      } else if (isLeagueWide) {
        recipientIds = registeredUsers.map(u => u.uid);
      } else {
        recipientIds = registeredUsers
          .filter(u => {
            const userTeam = (u.teamId || u.currentTeam || '').toLowerCase();
            return selectedTeams.some(t => t.toLowerCase() === userTeam);
          })
          .map(u => u.uid);
      }

      const sendAnnouncementFn = httpsCallable(functions, 'sendAnnouncement');
      const result = await sendAnnouncementFn({
        title,
        body,
        link,
        priority,
        targetTeams: isCaptainsOnly ? ['captains'] : targetTeams,
        recipientUserIds: recipientIds,
        isLeagueWide,
        isCaptainsOnly
      });
      
      showToast(`‚úÖ ${result.data.message || 'Notification sent successfully!'}`, 'success');
      
      // Clear form
      document.getElementById('notificationTitle').value = '';
      document.getElementById('notificationBody').value = '';
      document.getElementById('notificationPriority').value = 'normal';
      document.getElementById('notificationLinkType').value = '';
      document.getElementById('notificationCustomLink').value = '';
      document.getElementById('customLinkGroup').style.display = 'none';
      document.getElementById('previewPanel').classList.remove('visible');
      document.getElementById('titleCharCount').textContent = '0';
      document.getElementById('bodyCharCount').textContent = '0';
      document.getElementById('captainsSelectedIndicator').style.display = 'none';
      
      selectedTeams = [];
      targetingCaptains = false;
      document.querySelectorAll('.team-chip').forEach(chip => {
        chip.classList.remove('selected');
      });
      
      await loadRecentAnnouncements();
      updateSendButton();
      
    } catch (error) {
      console.error('Error sending notification:', error);
      showToast(`‚ùå ${error.message || 'Failed to send notification'}`, 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
      updateSendButton();
    }
  };

  window.sendTestNotification = async function() {
    const btn = document.getElementById('testNotificationBtn');
    const status = document.getElementById('testNotificationStatus');
    const originalText = btn.innerHTML;
    
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Sending...';
    status.textContent = '';
    
    try {
      const testNotificationFn = httpsCallable(functions, 'testNotification');
      const result = await testNotificationFn({});
      
      status.textContent = '‚úÖ Test sent! Check your notifications.';
      status.style.color = 'var(--success-color)';
      showToast('Test notification sent!', 'success');
      
    } catch (error) {
      console.error('Error sending test notification:', error);
      status.textContent = `‚ùå ${error.message || 'Failed'}`;
      status.style.color = 'var(--danger-color)';
      showToast(error.message || 'Failed to send test notification', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  };

  window.loadRecentAnnouncements = async function() {
    const listEl = document.getElementById('recentAnnouncementsList');
    listEl.innerHTML = '<div class="loading-text">Loading...</div>';
    
    try {
      const q = query(
        collection(db, 'announcements'),
        orderBy('sentAt', 'desc'),
        limit(10)
      );
      
      const snapshot = await getDocs(q);
      
      if (snapshot.empty) {
        listEl.innerHTML = '<div class="no-recipients">No announcements sent yet</div>';
        return;
      }
      
      listEl.innerHTML = snapshot.docs.map(doc => {
        const data = doc.data();
        const docId = doc.id;
        const sentAt = data.sentAt?.toDate?.() 
          ? data.sentAt.toDate().toLocaleString('en-US', {
              month: 'short',
              day: 'numeric',
              hour: 'numeric',
              minute: '2-digit'
            })
          : 'Unknown';
        
        const priorityClass = data.priority === 'urgent' 
          ? 'priority-urgent'
          : data.priority === 'info'
          ? 'priority-info'
          : 'priority-normal';
        
        const priorityLabel = data.priority === 'urgent' 
          ? 'üö® Urgent'
          : data.priority === 'info'
          ? '‚ÑπÔ∏è Info'
          : 'üì¢ Normal';
        
        const scopeLabel = data.wasFiltered === false || data.isLeagueWide
          ? 'League-wide' 
          : (data.targetTeams?.length > 0 
            ? data.targetTeams.map(t => capitalize(t)).join(', ')
            : `${data.targetedUserCount || data.recipientCount || 0} users`);
        
        const isUnsent = data.unsent === true;
        
        return `
          <div class="recent-item ${isUnsent ? 'unsent' : ''}" data-id="${docId}">
            <div class="recent-item-header">
              <div class="recent-item-title">${data.title || 'Untitled'}</div>
              <div class="recent-item-actions">
                ${isUnsent 
                  ? '<span class="unsent-badge">Recalled</span>' 
                  : `<button class="unsend-btn" onclick="unsendAnnouncement('${docId}', '${(data.title || '').replace(/'/g, "\\'")}')">üóëÔ∏è Unsend</button>`
                }
                <span class="priority-badge ${priorityClass}">${priorityLabel}</span>
              </div>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-light); line-height: 1.4; ${isUnsent ? 'text-decoration: line-through; opacity: 0.6;' : ''}">
              ${data.body?.substring(0, 100) || ''}${(data.body?.length || 0) > 100 ? '...' : ''}
            </div>
            <div class="recent-item-meta">
              ${sentAt} by ${data.sentByName || 'Unknown'} ‚Ä¢ ${data.recipientCount || 0} delivered ‚Ä¢ ${scopeLabel}
              ${isUnsent ? ` ‚Ä¢ <span style="color: var(--danger-color);">Recalled</span>` : ''}
            </div>
          </div>
        `;
      }).join('');
      
    } catch (error) {
      console.error('Error loading announcements:', error);
      listEl.innerHTML = '<div class="no-recipients">Error loading announcements</div>';
    }
  };

  window.unsendAnnouncement = async function(announcementId, title) {
    if (!confirm(`Are you sure you want to unsend "${title}"?\n\nThis will remove the notification from all users' feeds.`)) {
      return;
    }
    
    const btn = document.querySelector(`[data-id="${announcementId}"] .unsend-btn`);
    if (btn) {
      btn.disabled = true;
      btn.textContent = '‚è≥ Removing...';
    }
    
    try {
      const unsendAnnouncementFn = httpsCallable(functions, 'unsendAnnouncement');
      const result = await unsendAnnouncementFn({
        announcementId,
        title
      });
      
      if (result.data.success) {
        showToast(`Removed notification from ${result.data.deletedCount} user feeds`, 'success');
        await loadRecentAnnouncements();
      } else {
        throw new Error('Failed to unsend');
      }
      
    } catch (error) {
      console.error('Error unsending announcement:', error);
      showToast('Failed to unsend announcement: ' + error.message, 'error');
      
      if (btn) {
        btn.disabled = false;
        btn.textContent = 'üóëÔ∏è Unsend';
      }
    }
  };

  // ========================================
  // CLEANUP FUNCTIONS (Admin Only)
  // ========================================
  
  window.showCleanupModal = function() {
    document.getElementById('cleanupModal').style.display = 'flex';
    document.getElementById('cleanupOption').value = '';
    document.getElementById('cleanupTitle').value = '';
  };
  
  window.hideCleanupModal = function() {
    document.getElementById('cleanupModal').style.display = 'none';
  };
  
  window.runCleanup = async function() {
    const option = document.getElementById('cleanupOption').value;
    const title = document.getElementById('cleanupTitle').value.trim();
    
    if (!option && !title) {
      showToast('Please select an option or enter a title', 'error');
      return;
    }
    
    const confirmMsg = title 
      ? `Delete all notifications with title "${title}"?`
      : option === 'all'
      ? '‚ö†Ô∏è DELETE ALL NOTIFICATIONS FROM ALL USERS? This cannot be undone!'
      : `Delete all ${option.replace('type-', '')} notifications from all users?`;
    
    if (!confirm(confirmMsg)) {
      return;
    }
    
    try {
      const cleanupFn = httpsCallable(functions, 'cleanupNotifications');
      
      let params = {};
      if (title) {
        params.title = title;
      } else if (option === 'all') {
        params.all = true;
      } else if (option.startsWith('type-')) {
        params.type = option.replace('type-', '');
      }
      
      const result = await cleanupFn(params);
      
      if (result.data.success) {
        showToast(`Deleted ${result.data.totalDeleted} notifications from ${result.data.usersAffected} users`, 'success');
        hideCleanupModal();
        await loadRecentAnnouncements();
      }
      
    } catch (error) {
      console.error('Cleanup error:', error);
      showToast('Cleanup failed: ' + error.message, 'error');
    }
  };

  // ========================================
  // UTILITY FUNCTIONS
  // ========================================

  function formatDate(timestamp) {
    if (!timestamp?.seconds) return 'TBD';
    const d = new Date(timestamp.seconds * 1000);
    return d.toLocaleDateString('en-US', { 
      weekday: 'short', 
      month: 'short', 
      day: 'numeric',
      year: 'numeric'
    });
  }

  function formatTime(timestamp) {
    if (!timestamp?.seconds) return 'TBD';
    const d = new Date(timestamp.seconds * 1000);
    return d.toLocaleTimeString('en-US', { 
      hour: 'numeric', 
      minute: '2-digit'
    });
  }

  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†';
    toast.innerHTML = `<span>${icon}</span> ${message}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      toast.style.transform = 'translateY(20px)';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Make functions globally available
  window.showToast = showToast;
</script>

<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
<script src="theme-toggle.js"></script>
</body>
</html>
