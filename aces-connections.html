<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aces Connections - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
  --correct-color: #48bb78;
  --incorrect-color: #f56565;
  
  /* Connections difficulty colors */
  --yellow: #f9df6d;
  --yellow-dark: #c9a227;
  --green: #a0c35a;
  --green-dark: #6a9a23;
  --blue: #b0c4ef;
  --blue-dark: #5a7ec2;
  --purple: #ba81c5;
  --purple-dark: #8b4a9c;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.softball-spinner::before {
  content: '‚öæ';
  font-size: 60px;
  animation: spin 1.5s ease-in-out infinite;
  display: block;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Page Container */
.page-container {
  max-width: 700px;
  margin: 0 auto;
  padding: 1.5rem;
}

/* Page Header */
.page-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 2rem 1.5rem;
  border-radius: 16px;
  margin-bottom: 1.5rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.back-link {
  position: absolute;
  top: 1rem;
  left: 1rem;
  color: rgba(255,255,255,0.85);
  text-decoration: none;
  font-size: 0.85rem;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.35rem 0.75rem;
  background: rgba(255,255,255,0.15);
  border-radius: 6px;
  transition: all 0.2s ease;
  z-index: 10;
}

.back-link:hover {
  background: rgba(255,255,255,0.25);
  color: white;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.page-header h1 {
  margin: 0 0 0.5rem 0;
  font-size: 2rem;
  font-weight: 700;
  position: relative;
  z-index: 1;
}

.page-header .subtitle {
  opacity: 0.9;
  font-size: 1rem;
  margin: 0;
  position: relative;
  z-index: 1;
}

.puzzle-date {
  font-size: 1rem;
  opacity: 0.85;
  margin-top: 0.5rem;
  position: relative;
  z-index: 1;
}

/* Game Stats Bar */
.game-stats-bar {
  display: flex;
  justify-content: center;
  gap: 2rem;
  background: var(--card-bg);
  padding: 1rem;
  border-radius: 12px;
  margin-bottom: 1rem;
  box-shadow: var(--shadow-sm);
  flex-wrap: wrap;
}

.stat-item {
  text-align: center;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: 700;
  color: var(--primary-color);
}

.stat-label {
  font-size: 0.8rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* User Stats Section */
.user-stats-container {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
  box-shadow: var(--shadow-sm);
}

.user-stats-content {
  text-align: center;
}

.sign-in-prompt {
  color: var(--text-light);
  font-size: 0.9rem;
}

.sign-in-prompt a {
  color: var(--primary-color);
  font-weight: 600;
  text-decoration: none;
}

.sign-in-prompt a:hover {
  text-decoration: underline;
}

.user-greeting {
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.75rem;
}

.stats-note {
  font-size: 0.85rem;
  color: var(--text-light);
}

.lifetime-stats {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.lifetime-stat {
  text-align: center;
}

.lifetime-value {
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--primary-color);
  display: block;
}

.lifetime-label {
  font-size: 0.7rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

/* Mistakes Display */
.mistakes-section {
  text-align: center;
  margin-bottom: 1rem;
}

.mistakes-label {
  font-size: 0.8rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.mistakes-display {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
}

.mistake-dot {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: var(--primary-color);
  transition: all 0.3s ease;
}

.mistake-dot.used {
  background: #e2e8f0;
}

/* Solved Categories */
.solved-categories {
  margin-bottom: 0.5rem;
}

.solved-category {
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 0.5rem;
  text-align: center;
  animation: slideIn 0.5s ease;
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.solved-category.yellow { background: var(--yellow); }
.solved-category.green { background: var(--green); }
.solved-category.blue { background: var(--blue); }
.solved-category.purple { background: var(--purple); }

.category-title {
  font-weight: 700;
  font-size: 0.9rem;
  text-transform: uppercase;
  margin-bottom: 0.25rem;
  color: #333;
}

.category-players {
  font-size: 0.85rem;
  color: #444;
}

/* Grid Container */
.grid-container {
  background: var(--card-bg);
  padding: 1rem;
  border-radius: 12px;
  box-shadow: var(--shadow-sm);
  margin-bottom: 1rem;
}

/* Game Grid */
.game-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
}

.grid-tile {
  aspect-ratio: 1.3;
  background: #e8edf4;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  padding: 0.5rem 0.25rem;
  font-size: 0.75rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
  color: var(--text-dark);
  line-height: 1.1;
  word-break: break-word;
}

.grid-tile:hover {
  background: #d8e0eb;
  transform: translateY(-1px);
}

.grid-tile.selected {
  background: var(--primary-color);
  color: white;
  transform: scale(1.02);
}

.grid-tile.wrong {
  animation: shake 0.5s ease;
}

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-4px); }
  40%, 80% { transform: translateX(4px); }
}

/* Action Buttons */
.action-buttons {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.action-btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.action-btn.primary {
  background: var(--primary-color);
  color: white;
}

.action-btn.primary:hover {
  background: var(--secondary-color);
}

.action-btn.secondary {
  background: #e2e8f0;
  color: var(--text-dark);
}

.action-btn.secondary:hover {
  background: #cbd5e0;
}

.action-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* How To Play */
.how-to-play-section {
  background: var(--card-bg);
  border-radius: 12px;
  margin-top: 1rem;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
}

.how-to-play-header {
  padding: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  background: #f8fafc;
}

.how-to-play-header h3 {
  margin: 0;
  font-size: 0.95rem;
  color: var(--text-dark);
}

.how-to-play-toggle {
  background: none;
  border: none;
  font-size: 1rem;
  cursor: pointer;
  color: var(--text-light);
}

.how-to-play-content {
  padding: 0 1rem;
  max-height: 0;
  overflow: hidden;
  transition: all 0.3s ease;
}

.how-to-play-content.expanded {
  padding: 1rem;
  max-height: 500px;
}

.how-to-play-content ul {
  margin: 0;
  padding-left: 1.25rem;
  color: var(--text-light);
  font-size: 0.9rem;
  line-height: 1.6;
}

.how-to-play-content li {
  margin-bottom: 0.5rem;
}

.difficulty-legend {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1rem;
  font-size: 0.85rem;
}

.difficulty-item {
  display: flex;
  align-items: center;
  gap: 0.35rem;
}

.difficulty-dot {
  width: 14px;
  height: 14px;
  border-radius: 3px;
}

/* Game Over Modal */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  padding: 1rem;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  max-width: 400px;
  width: 100%;
  text-align: center;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.active .modal-content {
  transform: scale(1);
}

.modal-title {
  font-size: 1.75rem;
  margin: 0 0 1rem 0;
}

.score-display {
  font-size: 3rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 1rem;
}

.game-summary {
  display: flex;
  justify-content: center;
  gap: 2rem;
  margin-bottom: 1.5rem;
}

.summary-item {
  text-align: center;
}

.summary-value {
  font-size: 1.5rem;
  font-weight: 700;
  display: block;
}

.summary-label {
  font-size: 0.75rem;
  color: var(--text-light);
  text-transform: uppercase;
}

.share-preview {
  background: #f8fafc;
  padding: 1rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  font-family: monospace;
  font-size: 0.85rem;
  white-space: pre-line;
  text-align: left;
}

.modal-buttons {
  display: flex;
  gap: 0.5rem;
  justify-content: center;
  flex-wrap: wrap;
}

/* Toast */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  background: var(--text-dark);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: 500;
  opacity: 0;
  transition: all 0.3s ease;
  z-index: 2000;
}

.toast.show {
  transform: translateX(-50%) translateY(0);
  opacity: 1;
}

/* Responsive */
@media (max-width: 480px) {
  .page-container {
    padding: 1rem;
  }
  
  .page-header {
    padding: 1.5rem 1rem;
  }
  
  .page-header h1 {
    font-size: 1.5rem;
  }
  
  .grid-tile {
    font-size: 0.65rem;
    padding: 0.35rem;
  }
  
  .game-stats-bar {
    gap: 1rem;
  }
  
  .lifetime-stats {
    gap: 1rem;
  }
}
</style>
</head>
<body>

<nav-component></nav-component>

<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
  <p>Loading puzzle...</p>
</div>

<div class="page-container">
  <div class="page-header">
    <a href="index.html" class="back-link">‚Üê Back</a>
    <h1>üîó Aces Connections</h1>
    <p class="subtitle">Group 4 players by what they have in common</p>
    <div class="puzzle-date" id="puzzleDate"></div>
  </div>

  <!-- User Stats Section -->
  <div class="user-stats-container" id="userStatsContainer">
    <div class="user-stats-content">
      <div class="sign-in-prompt">
        <span>üîí</span>
        <a href="signin.html">Sign in</a> to track your stats across devices
      </div>
    </div>
  </div>

  <!-- Mistakes Remaining -->
  <div class="mistakes-section">
    <div class="mistakes-label">Mistakes remaining</div>
    <div class="mistakes-display" id="mistakesDisplay">
      <div class="mistake-dot"></div>
      <div class="mistake-dot"></div>
      <div class="mistake-dot"></div>
      <div class="mistake-dot"></div>
    </div>
  </div>

  <!-- Solved Categories -->
  <div class="solved-categories" id="solvedCategories"></div>

  <!-- Game Grid -->
  <div class="grid-container">
    <div class="game-grid" id="gameGrid"></div>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons">
    <button class="action-btn secondary" id="shuffleBtn" onclick="shuffleGrid()">Shuffle</button>
    <button class="action-btn secondary" id="deselectBtn" onclick="deselectAll()">Deselect All</button>
    <button class="action-btn primary" id="submitBtn" onclick="submitGuess()" disabled>Submit</button>
  </div>

  <div class="action-buttons" style="margin-top: 0.5rem;">
    <button class="action-btn secondary" id="giveUpBtn" onclick="giveUp()">Give Up</button>
    <button class="action-btn primary" id="resultsBtn" onclick="viewResults()" style="display: none;">View Results</button>
    <button class="action-btn secondary" id="shareBtn" onclick="shareResults()" style="display: none;">Share</button>
    <button class="action-btn secondary" id="answersBtn" onclick="showAnswers()" style="display: none;">Show Answers</button>
  </div>

  <!-- How To Play -->
  <div class="how-to-play-section">
    <div class="how-to-play-header" onclick="toggleHowToPlay()">
      <h3>‚ùì How to Play</h3>
      <button class="how-to-play-toggle" id="howToPlayToggle">‚ñº</button>
    </div>
    <div class="how-to-play-content" id="howToPlay">
      <ul>
        <li>Find groups of 4 Mountainside Aces players that share something in common</li>
        <li>Select 4 tiles and tap <strong>Submit</strong> to check your guess</li>
        <li>Categories can be positions, teams, seasons, awards, stats, and more</li>
        <li>You have 4 mistakes allowed - use them wisely!</li>
      </ul>
      <div class="difficulty-legend">
        <div class="difficulty-item">
          <div class="difficulty-dot" style="background: var(--yellow);"></div>
          <span>Easiest</span>
        </div>
        <div class="difficulty-item">
          <div class="difficulty-dot" style="background: var(--green);"></div>
          <span>Easy</span>
        </div>
        <div class="difficulty-item">
          <div class="difficulty-dot" style="background: var(--blue);"></div>
          <span>Medium</span>
        </div>
        <div class="difficulty-item">
          <div class="difficulty-dot" style="background: var(--purple);"></div>
          <span>Hard</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Game Over Modal -->
<div class="modal-overlay" id="gameOverModal">
  <div class="modal-content">
    <h2 class="modal-title" id="gameOverTitle">üéâ Perfect!</h2>
    <div class="score-display" id="finalScore">4/4</div>
    <div class="game-summary">
      <div class="summary-item">
        <span class="summary-value" id="correctCount">4</span>
        <span class="summary-label">Correct</span>
      </div>
      <div class="summary-item">
        <span class="summary-value" id="mistakesUsed">0</span>
        <span class="summary-label">Mistakes</span>
      </div>
      <div class="summary-item">
        <span class="summary-value" id="guessesTotal">4</span>
        <span class="summary-label">Guesses</span>
      </div>
    </div>
    <div class="share-preview" id="sharePreview"></div>
    <div class="modal-buttons">
      <button class="action-btn primary" onclick="shareResults()">Share</button>
      <button class="action-btn secondary" onclick="showAnswers()">Show Answers</button>
      <button class="action-btn secondary" onclick="closeGameOverModal()">Close</button>
    </div>
  </div>
</div>

<!-- Answers Modal -->
<div class="modal-overlay" id="answersModal">
  <div class="modal-content" style="max-width: 500px;">
    <h2 class="modal-title">üìã Today's Answers</h2>
    <div id="answersModalBody"></div>
    <div class="modal-buttons">
      <button class="action-btn secondary" onclick="closeAnswersModal()">Close</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script type="module">
import { db, doc, getDoc, getAllPlayerStatsOptimized } from './firebase-config.js';
import { setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import { onAuthChange, getCurrentUser } from './firebase-auth.js';

// ============================================
// CONFIGURATION - EDIT THIS FOR LAUNCH DATE
// ============================================
const LAUNCH_YEAR = 2025;
const LAUNCH_MONTH = 5; // 0-indexed: 5 = June
const LAUNCH_DAY = 6;

// ============================================
// STATE
// ============================================
let allPlayers = [];
let allAwards = [];
let todaysPuzzle = null;
let currentUser = null;
let userStats = null;

const gameState = {
  selected: [],
  solved: [],
  mistakes: 0,
  guessHistory: [],
  solveOrder: [],
  isComplete: false
};

// ============================================
// AWARD LOADING
// ============================================
async function getAllAwards() {
  try {
    const awardsDoc = await getDoc(doc(db, 'acesAggregates', 'awards'));
    if (awardsDoc.exists()) {
      const data = awardsDoc.data();
      return data.awards || [];
    }
  } catch (error) {
    console.error('Error loading awards:', error);
  }
  return [];
}

// ============================================
// PUZZLE GENERATION
// ============================================
function getDayNumber() {
  const launchDate = new Date(LAUNCH_YEAR, LAUNCH_MONTH, LAUNCH_DAY);
  launchDate.setHours(0, 0, 0, 0);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  return Math.floor((today - launchDate) / (1000 * 60 * 60 * 24)) + 1;
}

function seededRandom(seed) {
  const x = Math.sin(seed++) * 10000;
  return x - Math.floor(x);
}

function seededShuffle(array, seed) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(seededRandom(seed + i) * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function generateDailyPuzzle() {
  const dayNum = getDayNumber();
  const seed = dayNum * 12345;
  
  const categoryTypes = [
    createPositionCategory,
    createTeamCategory,
    createStatCategory,
    createAwardCategory,
    createNameCategory,
    createSeasonCountCategory
  ];
  
  const shuffledTypes = seededShuffle(categoryTypes, seed);
  const difficulties = ['yellow', 'green', 'blue', 'purple'];
  const categories = [];
  const usedPlayers = new Set();
  
  let attempts = 0;
  let typeIndex = 0;
  
  while (categories.length < 4 && attempts < 50) {
    const categoryFn = shuffledTypes[typeIndex % shuffledTypes.length];
    const category = categoryFn(seed + attempts, usedPlayers);
    
    if (category && category.players.length === 4) {
      category.difficulty = difficulties[categories.length];
      categories.push(category);
      category.players.forEach(p => usedPlayers.add(p));
    }
    
    attempts++;
    typeIndex++;
  }
  
  // Fallback if we don't have 4 categories
  while (categories.length < 4) {
    const fallback = createFallbackCategory(seed + categories.length * 100, usedPlayers);
    if (fallback) {
      fallback.difficulty = difficulties[categories.length];
      categories.push(fallback);
      fallback.players.forEach(p => usedPlayers.add(p));
    }
  }
  
  // Create shuffled tiles
  const allTiles = categories.flatMap(c => c.players);
  const shuffledTiles = seededShuffle(allTiles, seed + 999);
  
  return {
    dayNum,
    categories,
    tiles: shuffledTiles
  };
}

function createPositionCategory(seed, usedPlayers) {
  const positions = ['P', 'C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF'];
  const pos = positions[Math.floor(seededRandom(seed) * positions.length)];
  
  const positionPlayers = allPlayers.filter(p => 
    p.primaryPosition === pos && !usedPlayers.has(getPlayerDisplayName(p))
  );
  
  if (positionPlayers.length >= 4) {
    const selected = seededShuffle(positionPlayers, seed).slice(0, 4);
    const posFullName = {
      'P': 'Pitcher', 'C': 'Catcher', '1B': 'First Baseman', '2B': 'Second Baseman',
      '3B': 'Third Baseman', 'SS': 'Shortstop', 'LF': 'Left Fielder', 
      'CF': 'Center Fielder', 'RF': 'Right Fielder'
    };
    return {
      title: `${posFullName[pos] || pos}s`,
      players: selected.map(p => getPlayerDisplayName(p))
    };
  }
  return null;
}

function createTeamCategory(seed, usedPlayers) {
  const teamCounts = {};
  allPlayers.forEach(p => {
    const teams = p.teams || [];
    teams.forEach(t => {
      teamCounts[t] = (teamCounts[t] || 0) + 1;
    });
  });
  
  const validTeams = Object.entries(teamCounts)
    .filter(([_, count]) => count >= 6)
    .map(([team]) => team);
  
  if (validTeams.length === 0) return null;
  
  const team = validTeams[Math.floor(seededRandom(seed) * validTeams.length)];
  const teamPlayers = allPlayers.filter(p => 
    (p.teams || []).includes(team) && !usedPlayers.has(getPlayerDisplayName(p))
  );
  
  if (teamPlayers.length >= 4) {
    const selected = seededShuffle(teamPlayers, seed).slice(0, 4);
    return {
      title: `Played for ${team}`,
      players: selected.map(p => getPlayerDisplayName(p))
    };
  }
  return null;
}

function createStatCategory(seed, usedPlayers) {
  const statCategories = [
    { key: 'careerHR', title: '5+ Career Home Runs', min: 5 },
    { key: 'careerAVG', title: '.400+ Career AVG', min: 0.400 },
    { key: 'careerHits', title: '30+ Career Hits', min: 30 },
    { key: 'careerRuns', title: '25+ Career Runs', min: 25 }
  ];
  
  const cat = statCategories[Math.floor(seededRandom(seed) * statCategories.length)];
  
  const qualifiedPlayers = allPlayers.filter(p => {
    const val = p[cat.key] || 0;
    return val >= cat.min && !usedPlayers.has(getPlayerDisplayName(p));
  });
  
  if (qualifiedPlayers.length >= 4) {
    const selected = seededShuffle(qualifiedPlayers, seed).slice(0, 4);
    return {
      title: cat.title,
      players: selected.map(p => getPlayerDisplayName(p))
    };
  }
  return null;
}

function createAwardCategory(seed, usedPlayers) {
  const awardCounts = {};
  allAwards.forEach(a => {
    const award = a.award;
    if (!awardCounts[award]) awardCounts[award] = [];
    if (!usedPlayers.has(a.player)) {
      awardCounts[award].push(a.player);
    }
  });
  
  const validAwards = Object.entries(awardCounts)
    .filter(([_, players]) => players.length >= 4)
    .map(([award, players]) => ({ award, players }));
  
  if (validAwards.length === 0) return null;
  
  const selected = validAwards[Math.floor(seededRandom(seed) * validAwards.length)];
  const players = seededShuffle(selected.players, seed).slice(0, 4);
  
  return {
    title: `${selected.award} Winner`,
    players
  };
}

function createNameCategory(seed, usedPlayers) {
  const firstNames = {};
  allPlayers.forEach(p => {
    const name = getPlayerDisplayName(p);
    if (usedPlayers.has(name)) return;
    const firstName = name.split(' ')[0];
    if (!firstNames[firstName]) firstNames[firstName] = [];
    firstNames[firstName].push(name);
  });
  
  const validNames = Object.entries(firstNames)
    .filter(([_, players]) => players.length >= 4)
    .map(([name, players]) => ({ name, players }));
  
  if (validNames.length === 0) return null;
  
  const selected = validNames[Math.floor(seededRandom(seed) * validNames.length)];
  const players = seededShuffle(selected.players, seed).slice(0, 4);
  
  return {
    title: `First Name: ${selected.name}`,
    players
  };
}

function createSeasonCountCategory(seed, usedPlayers) {
  const counts = [3, 4, 5, 6];
  const count = counts[Math.floor(seededRandom(seed) * counts.length)];
  
  const players = allPlayers.filter(p => {
    const seasons = p.seasonsPlayed || 0;
    return seasons === count && !usedPlayers.has(getPlayerDisplayName(p));
  });
  
  if (players.length >= 4) {
    const selected = seededShuffle(players, seed).slice(0, 4);
    return {
      title: `Played ${count} Seasons`,
      players: selected.map(p => getPlayerDisplayName(p))
    };
  }
  return null;
}

function createFallbackCategory(seed, usedPlayers) {
  const available = allPlayers.filter(p => !usedPlayers.has(getPlayerDisplayName(p)));
  if (available.length >= 4) {
    const selected = seededShuffle(available, seed).slice(0, 4);
    return {
      title: 'Aces Players',
      players: selected.map(p => getPlayerDisplayName(p))
    };
  }
  return null;
}

function getPlayerDisplayName(player) {
  if (player.lastName && player.firstName) {
    return `${player.firstName} ${player.lastName}`;
  }
  return player.name || player.player || 'Unknown';
}

// ============================================
// GAME RENDERING
// ============================================
function renderGrid() {
  const grid = document.getElementById('gameGrid');
  const remainingTiles = todaysPuzzle.tiles.filter(t => 
    !gameState.solved.some(s => s.players.includes(t))
  );
  
  grid.innerHTML = remainingTiles.map(tile => {
    const isSelected = gameState.selected.includes(tile);
    return `
      <div class="grid-tile ${isSelected ? 'selected' : ''}" 
           onclick="toggleTile('${tile.replace(/'/g, "\\'")}')">
        ${tile}
      </div>
    `;
  }).join('');
  
  document.getElementById('submitBtn').disabled = gameState.selected.length !== 4;
}

function renderSolvedCategories() {
  const container = document.getElementById('solvedCategories');
  container.innerHTML = gameState.solved.map(cat => `
    <div class="solved-category ${cat.difficulty}">
      <div class="category-title">${cat.title}</div>
      <div class="category-players">${cat.players.join(', ')}</div>
    </div>
  `).join('');
}

function updateStats() {
  const dots = document.querySelectorAll('.mistake-dot');
  dots.forEach((dot, i) => {
    dot.classList.toggle('used', i < gameState.mistakes);
  });
}

// ============================================
// GAME LOGIC
// ============================================
window.toggleTile = function(tile) {
  if (gameState.isComplete) return;
  
  const index = gameState.selected.indexOf(tile);
  if (index > -1) {
    gameState.selected.splice(index, 1);
  } else if (gameState.selected.length < 4) {
    gameState.selected.push(tile);
  }
  renderGrid();
};

window.shuffleGrid = function() {
  const remaining = todaysPuzzle.tiles.filter(t => 
    !gameState.solved.some(s => s.players.includes(t))
  );
  
  for (let i = remaining.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
  }
  
  todaysPuzzle.tiles = [
    ...todaysPuzzle.tiles.filter(t => gameState.solved.some(s => s.players.includes(t))),
    ...remaining
  ];
  
  renderGrid();
};

window.deselectAll = function() {
  gameState.selected = [];
  renderGrid();
};

window.submitGuess = function() {
  if (gameState.selected.length !== 4 || gameState.isComplete) return;
  
  const guess = [...gameState.selected].sort();
  gameState.guessHistory.push(guess);
  
  // Check if guess matches any category
  for (const category of todaysPuzzle.categories) {
    const catPlayers = [...category.players].sort();
    if (JSON.stringify(guess) === JSON.stringify(catPlayers)) {
      // Correct!
      gameState.solved.push(category);
      gameState.solveOrder.push(category.difficulty);
      gameState.selected = [];
      
      renderSolvedCategories();
      renderGrid();
      saveGameState();
      
      if (gameState.solved.length === 4) {
        endGame(true);
      }
      return;
    }
  }
  
  // Check for "one away"
  let oneAway = false;
  for (const category of todaysPuzzle.categories) {
    const matches = gameState.selected.filter(s => category.players.includes(s));
    if (matches.length === 3) {
      oneAway = true;
      break;
    }
  }
  
  if (oneAway) {
    showToast('One away!');
  }
  
  // Incorrect
  gameState.mistakes++;
  updateStats();
  
  // Shake animation
  document.querySelectorAll('.grid-tile.selected').forEach(tile => {
    tile.classList.add('wrong');
    setTimeout(() => tile.classList.remove('wrong'), 500);
  });
  
  saveGameState();
  
  if (gameState.mistakes >= 4) {
    endGame(false);
  }
};

window.giveUp = function() {
  if (gameState.isComplete) return;
  if (!confirm('Are you sure you want to give up? This will reveal all answers.')) return;
  
  endGame(false);
};

function endGame(won) {
  gameState.isComplete = true;
  
  // Reveal unsolved categories
  if (!won) {
    todaysPuzzle.categories.forEach(cat => {
      if (!gameState.solved.some(s => s.title === cat.title)) {
        gameState.solved.push(cat);
        gameState.solveOrder.push('X'); // X for not solved
      }
    });
    renderSolvedCategories();
  }
  
  // Hide grid and gameplay buttons
  document.getElementById('gameGrid').style.display = 'none';
  document.getElementById('shuffleBtn').style.display = 'none';
  document.getElementById('deselectBtn').style.display = 'none';
  document.getElementById('submitBtn').style.display = 'none';
  document.getElementById('giveUpBtn').style.display = 'none';
  
  // Show results buttons
  document.getElementById('resultsBtn').style.display = 'inline-block';
  document.getElementById('shareBtn').style.display = 'inline-block';
  document.getElementById('answersBtn').style.display = 'inline-block';
  
  showGameOver(won);
  saveGameState();
  
  // Update lifetime stats
  if (currentUser) {
    const isPerfect = won && gameState.mistakes === 0;
    const correctCount = gameState.solveOrder.filter(d => d !== 'X').length;
    const isWin = correctCount === 4;
    updateLifetimeStats(isPerfect, isWin, correctCount, gameState.guessHistory.length);
  }
}

function showGameOver(won) {
  const correct = gameState.solveOrder.filter(d => d !== 'X').length;
  
  document.getElementById('finalScore').textContent = `${correct}/4`;
  document.getElementById('correctCount').textContent = correct;
  document.getElementById('mistakesUsed').textContent = gameState.mistakes;
  document.getElementById('guessesTotal').textContent = gameState.guessHistory.length;
  
  if (correct === 4 && gameState.mistakes === 0) {
    document.getElementById('gameOverTitle').textContent = 'üéâ Perfect!';
  } else if (correct === 4) {
    document.getElementById('gameOverTitle').textContent = '‚≠ê Great Job!';
  } else if (correct >= 2) {
    document.getElementById('gameOverTitle').textContent = 'üëç Nice Try!';
  } else {
    document.getElementById('gameOverTitle').textContent = 'üí™ Keep Practicing!';
  }
  
  updateSharePreview();
  document.getElementById('gameOverModal').classList.add('active');
}

window.viewResults = function() {
  const correct = gameState.solveOrder.filter(d => d !== 'X').length;
  
  document.getElementById('finalScore').textContent = `${correct}/4`;
  document.getElementById('correctCount').textContent = correct;
  document.getElementById('mistakesUsed').textContent = gameState.mistakes;
  document.getElementById('guessesTotal').textContent = gameState.guessHistory.length;
  
  updateSharePreview();
  document.getElementById('gameOverModal').classList.add('active');
};

window.closeGameOverModal = function() {
  document.getElementById('gameOverModal').classList.remove('active');
};

// ============================================
// SHARING
// ============================================
function updateSharePreview() {
  const emojis = { yellow: 'üü®', green: 'üü©', blue: 'üü¶', purple: 'üü™' };
  
  // Build solve order visualization
  let resultLine = '';
  gameState.solveOrder.forEach(d => {
    if (d === 'X') {
      resultLine += '‚¨õ';
    } else {
      resultLine += emojis[d];
    }
  });
  
  const correct = gameState.solveOrder.filter(d => d !== 'X').length;
  const shareText = `üîó Aces Connections #${todaysPuzzle.dayNum}\n${correct}/4 ‚Ä¢ ${gameState.mistakes} mistakes\n\n${resultLine}\n\nacessoftballreference.com/aces-connections.html`;
  
  document.getElementById('sharePreview').textContent = shareText;
}

window.shareResults = function() {
  const shareText = document.getElementById('sharePreview').textContent;
  
  if (navigator.share) {
    navigator.share({ text: shareText }).catch(() => {
      copyToClipboard(shareText);
    });
  } else {
    copyToClipboard(shareText);
  }
};

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    showToast('Results copied to clipboard!');
  }).catch(() => {
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    showToast('Results copied to clipboard!');
  });
}

// ============================================
// SHOW ANSWERS
// ============================================
window.showAnswers = function() {
  closeGameOverModal();
  
  const difficultyColors = {
    yellow: 'var(--yellow)',
    green: 'var(--green)',
    blue: 'var(--blue)',
    purple: 'var(--purple)'
  };
  
  let answerHtml = '<div style="padding: 0.5rem;">';
  
  todaysPuzzle.categories.forEach(cat => {
    const solved = gameState.solved.some(s => s.title === cat.title && gameState.solveOrder[gameState.solved.indexOf(s)] !== 'X');
    const solvedByUser = gameState.solveOrder.includes(cat.difficulty) && gameState.solveOrder[gameState.solveOrder.indexOf(cat.difficulty)] !== 'X';
    
    answerHtml += `
      <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: ${difficultyColors[cat.difficulty]}; border-radius: 8px;">
        <strong>${cat.title}</strong>
        ${solvedByUser ? '<span style="margin-left: 0.5rem;">‚úì</span>' : ''}
        <br>
        <span style="font-size: 0.85rem;">
          ${cat.players.join(', ')}
        </span>
      </div>
    `;
  });
  
  answerHtml += '</div>';
  
  document.getElementById('answersModalBody').innerHTML = answerHtml;
  document.getElementById('answersModal').classList.add('active');
};

window.closeAnswersModal = function() {
  document.getElementById('answersModal').classList.remove('active');
};

// ============================================
// HOW TO PLAY TOGGLE
// ============================================
window.toggleHowToPlay = function() {
  const section = document.getElementById('howToPlay');
  const toggle = document.getElementById('howToPlayToggle');
  section.classList.toggle('expanded');
  toggle.textContent = section.classList.contains('expanded') ? '‚ñ≤' : '‚ñº';
};

// ============================================
// TOAST
// ============================================
function showToast(message) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

// ============================================
// PERSISTENCE - LOCAL STORAGE
// ============================================
function saveGameStateLocal() {
  const saveData = {
    dayNum: todaysPuzzle.dayNum,
    selected: gameState.selected,
    solved: gameState.solved,
    mistakes: gameState.mistakes,
    guessHistory: gameState.guessHistory,
    solveOrder: gameState.solveOrder,
    isComplete: gameState.isComplete
  };
  localStorage.setItem('acesConnections', JSON.stringify(saveData));
  console.log('üíæ Game state saved to localStorage');
}

function loadGameStateLocal() {
  try {
    const saved = JSON.parse(localStorage.getItem('acesConnections'));
    if (saved && saved.dayNum === todaysPuzzle.dayNum) {
      applyLoadedGameState(saved);
      console.log('üíæ Game state loaded from localStorage');
      return true;
    }
  } catch (error) {
    console.error('Error loading from localStorage:', error);
  }
  return false;
}

// ============================================
// PERSISTENCE - FIREBASE
// ============================================
async function saveGameStateFirebase() {
  if (!currentUser) return;
  
  try {
    const gameRef = doc(db, 'acesConnectionsGames', currentUser.uid, 'dailyGames', String(todaysPuzzle.dayNum));
    await setDoc(gameRef, {
      dayNum: todaysPuzzle.dayNum,
      selected: gameState.selected,
      solved: gameState.solved,
      mistakes: gameState.mistakes,
      guessHistory: gameState.guessHistory,
      solveOrder: gameState.solveOrder,
      isComplete: gameState.isComplete,
      updatedAt: serverTimestamp()
    });
    console.log('‚òÅÔ∏è Game state saved to Firebase');
  } catch (error) {
    console.error('‚ùå Error saving to Firebase:', error);
  }
}

async function loadGameStateFirebase() {
  if (!currentUser) return false;
  
  try {
    const gameRef = doc(db, 'acesConnectionsGames', currentUser.uid, 'dailyGames', String(todaysPuzzle.dayNum));
    const gameDoc = await getDoc(gameRef);
    
    if (gameDoc.exists()) {
      const saved = gameDoc.data();
      if (saved.dayNum === todaysPuzzle.dayNum) {
        applyLoadedGameState(saved);
        console.log('‚òÅÔ∏è Game state loaded from Firebase');
        return true;
      }
    }
  } catch (error) {
    console.error('‚ùå Error loading from Firebase:', error);
  }
  return false;
}

function applyLoadedGameState(saved) {
  gameState.selected = saved.selected || [];
  gameState.solved = saved.solved || [];
  gameState.mistakes = saved.mistakes || 0;
  gameState.guessHistory = saved.guessHistory || [];
  gameState.solveOrder = saved.solveOrder || [];
  gameState.isComplete = saved.isComplete || false;
  
  if (gameState.isComplete) {
    document.getElementById('gameGrid').style.display = 'none';
    document.getElementById('shuffleBtn').style.display = 'none';
    document.getElementById('deselectBtn').style.display = 'none';
    document.getElementById('submitBtn').style.display = 'none';
    document.getElementById('giveUpBtn').style.display = 'none';
    document.getElementById('resultsBtn').style.display = 'inline-block';
    document.getElementById('shareBtn').style.display = 'inline-block';
    document.getElementById('answersBtn').style.display = 'inline-block';
  }
}

function saveGameState() {
  saveGameStateLocal();
  if (currentUser) {
    saveGameStateFirebase();
  }
}

async function loadGameState() {
  if (currentUser) {
    const loaded = await loadGameStateFirebase();
    if (loaded) return true;
  }
  return loadGameStateLocal();
}

// ============================================
// LIFETIME STATS
// ============================================
async function updateLifetimeStats(isPerfect, isWin, correct, guessesUsed) {
  if (!currentUser) return;
  
  try {
    const statsRef = doc(db, 'acesConnectionsGames', currentUser.uid);
    const statsDoc = await getDoc(statsRef);
    
    const stats = statsDoc.exists() ? statsDoc.data() : {
      gamesPlayed: 0,
      wins: 0,
      perfectGames: 0,
      totalCorrect: 0,
      totalGuesses: 0,
      currentStreak: 0,
      longestStreak: 0,
      lastPlayedPuzzle: 0
    };
    
    if (stats.lastPlayedPuzzle === todaysPuzzle.dayNum) {
      console.log('‚ÑπÔ∏è Stats already recorded for this puzzle');
      return;
    }
    
    const isConsecutive = stats.lastPlayedPuzzle === todaysPuzzle.dayNum - 1;
    const newStreak = isConsecutive ? stats.currentStreak + 1 : 1;
    
    const updatedStats = {
      gamesPlayed: stats.gamesPlayed + 1,
      wins: (stats.wins || 0) + (isWin ? 1 : 0),
      perfectGames: stats.perfectGames + (isPerfect ? 1 : 0),
      totalCorrect: stats.totalCorrect + correct,
      totalGuesses: stats.totalGuesses + guessesUsed,
      currentStreak: newStreak,
      longestStreak: Math.max(stats.longestStreak, newStreak),
      lastPlayedPuzzle: todaysPuzzle.dayNum,
      lastPlayedAt: serverTimestamp(),
      displayName: currentUser.displayName || 'Anonymous'
    };
    
    await setDoc(statsRef, updatedStats, { merge: true });
    userStats = updatedStats;
    updateUserStatsDisplay();
    
    console.log('üìä Lifetime stats updated:', updatedStats);
  } catch (error) {
    console.error('‚ùå Error updating lifetime stats:', error);
  }
}

async function loadLifetimeStats() {
  if (!currentUser) return null;
  
  try {
    const statsRef = doc(db, 'acesConnectionsGames', currentUser.uid);
    const statsDoc = await getDoc(statsRef);
    
    if (statsDoc.exists()) {
      userStats = statsDoc.data();
      console.log('üìä Lifetime stats loaded:', userStats);
      return userStats;
    }
  } catch (error) {
    console.error('‚ùå Error loading lifetime stats:', error);
  }
  return null;
}

// ============================================
// USER STATS DISPLAY
// ============================================
function updateUserStatsDisplay() {
  const container = document.getElementById('userStatsContainer');
  if (!container) return;
  
  if (!currentUser) {
    container.innerHTML = `
      <div class="user-stats-content">
        <div class="sign-in-prompt">
          <span>üîí</span>
          <a href="signin.html">Sign in</a> to track your stats across devices
        </div>
      </div>
    `;
    return;
  }
  
  if (!userStats) {
    container.innerHTML = `
      <div class="user-stats-content">
        <div class="user-greeting">üëã Welcome, ${currentUser.displayName || 'Player'}!</div>
        <div class="stats-note">Complete a puzzle to start tracking your stats.</div>
      </div>
    `;
    return;
  }
  
  const avgScore = userStats.gamesPlayed > 0 
    ? (userStats.totalCorrect / userStats.gamesPlayed).toFixed(1) 
    : '0';
  
  const wins = userStats.wins || 0;
  
  container.innerHTML = `
    <div class="user-stats-content">
      <div class="user-greeting">üëã ${currentUser.displayName || 'Player'}</div>
      <div class="lifetime-stats">
        <div class="lifetime-stat">
          <span class="lifetime-value">${userStats.gamesPlayed}</span>
          <span class="lifetime-label">Played</span>
        </div>
        <div class="lifetime-stat">
          <span class="lifetime-value">${wins}</span>
          <span class="lifetime-label">Wins</span>
        </div>
        <div class="lifetime-stat">
          <span class="lifetime-value">${userStats.perfectGames}</span>
          <span class="lifetime-label">Perfect</span>
        </div>
        <div class="lifetime-stat">
          <span class="lifetime-value">${avgScore}</span>
          <span class="lifetime-label">Avg Score</span>
        </div>
        <div class="lifetime-stat">
          <span class="lifetime-value">${userStats.currentStreak}</span>
          <span class="lifetime-label">Streak</span>
        </div>
      </div>
    </div>
  `;
}

// ============================================
// AUTH STATE HANDLING
// ============================================
function setupAuthListener() {
  onAuthChange(async (user) => {
    currentUser = user;
    console.log(user ? `‚úÖ User signed in: ${user.displayName}` : 'üë§ No user signed in');
    
    if (user && todaysPuzzle) {
      await loadLifetimeStats();
      const firebaseHasState = await loadGameStateFirebase();
      
      if (firebaseHasState) {
        renderSolvedCategories();
        renderGrid();
        updateStats();
      }
    }
    
    updateUserStatsDisplay();
  });
}

// ============================================
// INITIALIZATION
// ============================================
async function init() {
  try {
    // Check if we're before launch date (use local midnight)
    const launchDate = new Date(LAUNCH_YEAR, LAUNCH_MONTH, LAUNCH_DAY).setHours(0, 0, 0, 0);
    const now = new Date().setHours(0, 0, 0, 0);
    
    if (now < launchDate) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      const launchDateObj = new Date(LAUNCH_YEAR, LAUNCH_MONTH, LAUNCH_DAY);
      document.getElementById('puzzleDate').textContent = `Launching ${launchDateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}`;
      document.querySelector('.grid-container').innerHTML = `
        <div style="text-align: center; padding: 3rem;">
          <div style="font-size: 4rem; margin-bottom: 1rem;">üîó</div>
          <h2 style="margin: 0 0 0.5rem 0;">Coming Soon!</h2>
          <p style="color: var(--text-light); margin: 0;">The first Aces Connections puzzle will be available on launch day.</p>
        </div>
      `;
      document.querySelector('.action-buttons').style.display = 'none';
      document.querySelectorAll('.action-buttons')[1].style.display = 'none';
      return;
    }
    
    // Check for existing auth user
    currentUser = getCurrentUser();
    if (currentUser) {
      console.log(`‚úÖ User already signed in: ${currentUser.displayName}`);
    }
    
    console.log('Loading player data...');
    const rawPlayers = await getAllPlayerStatsOptimized();
    allPlayers = rawPlayers.filter(p => p.migrated !== true);
    console.log(`Loaded ${allPlayers.length} players`);
    
    allAwards = await getAllAwards();
    console.log(`Loaded ${allAwards.length} awards`);
    
    // Generate puzzle
    todaysPuzzle = generateDailyPuzzle();
    console.log('Generated puzzle:', todaysPuzzle);
    
    // Display date
    const today = new Date();
    document.getElementById('puzzleDate').textContent = 
      `Puzzle #${todaysPuzzle.dayNum} ‚Ä¢ ${today.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}`;
    
    // Load lifetime stats if user is logged in
    if (currentUser) {
      await loadLifetimeStats();
    }
    
    // Load saved state
    await loadGameState();
    
    // Update user stats display
    updateUserStatsDisplay();
    
    // Set up auth state listener
    setupAuthListener();
    
    // Render
    renderSolvedCategories();
    renderGrid();
    updateStats();
    
    // Click outside modal to close
    document.getElementById('gameOverModal').addEventListener('click', (e) => {
      if (e.target.id === 'gameOverModal') closeGameOverModal();
    });
    document.getElementById('answersModal').addEventListener('click', (e) => {
      if (e.target.id === 'answersModal') closeAnswersModal();
    });
    
    // Hide loading
    document.getElementById('loadingOverlay').classList.add('hidden');
    
  } catch (error) {
    console.error('Error initializing game:', error);
    document.getElementById('loadingOverlay').innerHTML = `
      <div style="text-align: center; padding: 2rem;">
        <p>Error loading game data</p>
        <p style="color: var(--text-light); font-size: 0.9rem;">${error.message}</p>
        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.75rem 1.5rem; cursor: pointer;">Retry</button>
      </div>
    `;
  }
}

// Start
init();
</script>

<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>
