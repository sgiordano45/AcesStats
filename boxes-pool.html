<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Boxes Pool - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --pool-color: #1e40af;
  --pool-secondary: #3b82f6;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
  --success-color: #22c55e;
  --warning-color: #f59e0b;
  --danger-color: #ef4444;
  --winner-color: #059669;
}

* { box-sizing: border-box; }

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.softball-spinner::before {
  content: 'üèà';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Auth Gate */
.auth-gate {
  max-width: 500px;
  margin: 4rem auto;
  padding: 3rem;
  background: var(--card-bg);
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  text-align: center;
  display: none;
}

.auth-gate h2 {
  color: var(--pool-color);
  margin-bottom: 1rem;
}

.auth-gate p {
  color: var(--text-light);
  margin-bottom: 2rem;
}

.auth-gate a {
  display: inline-block;
  padding: 0.75rem 2rem;
  background: var(--primary-color);
  color: white;
  text-decoration: none;
  border-radius: 8px;
  font-weight: 600;
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--pool-color) 0%, var(--pool-secondary) 100%);
  color: white;
  padding: 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.header::after {
  content: 'üèà';
  position: absolute;
  bottom: -40px;
  left: -30px;
  font-size: 180px;
  opacity: 0.08;
}

.header-content {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  z-index: 1;
  flex-wrap: wrap;
  gap: 1rem;
}

.header h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 800;
}

.pool-title {
  font-size: 1.1rem;
  opacity: 0.9;
  margin-top: 0.25rem;
}

.header-badges {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.badge-locked {
  background: var(--danger-color);
  color: white;
}

.badge-open {
  background: var(--success-color);
  color: white;
}

.badge-admin {
  background: var(--accent-color);
  color: #1a1a1a;
}

.header-buttons {
  display: flex;
  gap: 0.75rem;
}

.nav-btn {
  background: rgba(255,255,255,0.2);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.3);
}

.nav-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: translateY(-2px);
}

/* Container */
.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* Pool Selector */
.pool-selector {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  display: flex;
  gap: 1rem;
  align-items: center;
  flex-wrap: wrap;
}

.pool-selector label {
  font-weight: 600;
}

.pool-selector select {
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border: 2px solid var(--border-color);
  font-size: 1rem;
  min-width: 200px;
}

.pool-selector select:focus {
  outline: none;
  border-color: var(--pool-color);
}

/* Grid Container */
.grid-container {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 1.5rem;
  box-shadow: var(--shadow-lg);
  overflow-x: auto;
}

/* Team Labels */
.grid-wrapper {
  display: inline-block;
  min-width: fit-content;
}

.team-label-top {
  text-align: center;
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--pool-color);
  margin-bottom: 0.5rem;
  padding: 0.75rem;
  background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
  border-radius: 8px;
  margin-left: 60px;
}

.team-label-left {
  writing-mode: vertical-rl;
  text-orientation: mixed;
  transform: rotate(180deg);
  font-size: 1.25rem;
  font-weight: 800;
  color: var(--pool-color);
  padding: 0.75rem;
  background: linear-gradient(135deg, #dbeafe 0%, #eff6ff 100%);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 0.5rem;
}

.grid-with-label {
  display: flex;
  align-items: stretch;
}

/* Numbers Row */
.numbers-container {
  margin-left: 60px;  /* Same as team-label-left area */
  margin-bottom: 2px;
  padding-left: 57px;  /* Row numbers (55px) + gap (2px) */
}

.numbers-row {
  display: grid;
  grid-template-columns: repeat(10, 55px);
  gap: 2px;
  margin-left: 2px;  /* Account for grid left border */
}

.number-cell {
  background: var(--pool-color);
  color: white;
  text-align: center;
  font-weight: 700;
  font-size: 1.1rem;
  width: 55px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
}

.number-cell.row-number {
  width: 55px;
  height: 55px;
}

.number-cell.empty {
  background: transparent;
}

.number-label {
  font-size: 0.65rem;
  opacity: 0.8;
  display: block;
  margin-bottom: 2px;
}

/* Row Numbers Column */
.row-numbers-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-right: 2px;
  margin-top: 2px;  /* Account for grid top border */
}

/* The 10x10 Grid */
.boxes-grid {
  display: grid;
  grid-template-columns: repeat(10, 55px);
  grid-template-rows: repeat(10, 55px);
  gap: 2px;
  background: var(--border-color);
  border: 2px solid var(--pool-color);
  border-radius: 4px;
}

.box {
  width: 55px;
  height: 55px;
  background: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.75rem;
  text-align: center;
  padding: 2px;
  word-break: break-word;
  position: relative;
  box-sizing: border-box;
}

/* Allow tooltip to show above box on hover */
.box:hover {
  overflow: visible;
  z-index: 10;
}

/* Tooltip for full name on hover */
.box[data-fullname]:hover::after {
  content: attr(data-fullname);
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 0.4rem 0.6rem;
  border-radius: 6px;
  font-size: 0.75rem;
  white-space: nowrap;
  z-index: 100;
  pointer-events: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.box[data-fullname]:hover::before {
  content: '';
  position: absolute;
  bottom: calc(100% - 6px);
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: rgba(0, 0, 0, 0.85);
  z-index: 100;
}

.box:hover:not(.taken):not(.locked) {
  background: #dbeafe;
  transform: scale(1.05);
  z-index: 1;
  box-shadow: var(--shadow-md);
}

.box.taken {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
  cursor: default;
  font-weight: 600;
  color: var(--text-dark);
}

.box.my-box {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  border: 2px solid var(--success-color);
}

.box.winner {
  animation: pulse 2s infinite;
}

/* Quarter winner colors */
.box.winner-q1 { --winner-color-1: #ef4444; }  /* Red - 1st Quarter */
.box.winner-half { --winner-color-2: #3b82f6; }  /* Blue - Halftime */
.box.winner-q3 { --winner-color-3: #22c55e; }  /* Green - 3rd Quarter */
.box.winner-final { --winner-color-4: #f59e0b; }  /* Gold - Final */

/* Single winner backgrounds */
.box.winner-q1:not(.winner-half):not(.winner-q3):not(.winner-final) {
  background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
  border: 2px solid #ef4444;
}
.box.winner-half:not(.winner-q1):not(.winner-q3):not(.winner-final) {
  background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
  border: 2px solid #3b82f6;
}
.box.winner-q3:not(.winner-q1):not(.winner-half):not(.winner-final) {
  background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
  border: 2px solid #22c55e;
}
.box.winner-final:not(.winner-q1):not(.winner-half):not(.winner-q3) {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
}

/* Two winners - diagonal split */
.box.winner-count-2 {
  background: linear-gradient(135deg, var(--split-color-1) 50%, var(--split-color-2) 50%) !important;
  border: 2px solid #6b7280;
}

/* Three winners - thirds */
.box.winner-count-3 {
  background: linear-gradient(135deg, 
    var(--split-color-1) 33.33%, 
    var(--split-color-2) 33.33%, 
    var(--split-color-2) 66.66%, 
    var(--split-color-3) 66.66%) !important;
  border: 2px solid #6b7280;
}

/* Four winners - quarters */
.box.winner-count-4 {
  background: conic-gradient(
    from 0deg,
    #fecaca 0deg 90deg,
    #bfdbfe 90deg 180deg,
    #bbf7d0 180deg 270deg,
    #fef3c7 270deg 360deg
  ) !important;
  border: 2px solid #6b7280;
}

/* Winner indicator dots */
.winner-indicators {
  position: absolute;
  bottom: 1px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 1px;
}

.winner-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  border: 1px solid rgba(0,0,0,0.3);
}

.winner-dot.q1 { background: #ef4444; }
.winner-dot.half { background: #3b82f6; }
.winner-dot.q3 { background: #22c55e; }
.winner-dot.final { background: #f59e0b; }

/* Winner name styling */
.winner-name {
  font-size: 0.7rem;
  font-weight: 600;
  line-height: 1.2;
  max-width: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  padding: 0 2px;
  display: block;
}

/* Non-winner box text containment */
.box.taken:not(.winner) {
  overflow: hidden;
  text-overflow: ellipsis;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); }
  50% { box-shadow: 0 0 0 8px rgba(255, 215, 0, 0); }
}

.box.locked {
  cursor: not-allowed;
  opacity: 0.9;
}

.box .box-coord {
  position: absolute;
  top: 2px;
  left: 2px;
  font-size: 0.5rem;
  color: var(--text-light);
  opacity: 0.5;
}

/* Row numbers on left */
.grid-row {
  display: contents;
}

.row-numbers-column {
  display: flex;
  flex-direction: column;
  gap: 2px;
  margin-right: 0.5rem;
}

/* Admin Panel */
.admin-panel {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 1.5rem;
  margin-top: 2rem;
  box-shadow: var(--shadow-lg);
  border: 2px solid var(--accent-color);
  display: none;
}

.admin-panel.visible {
  display: block;
}

.admin-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border-color);
}

.admin-header h2 {
  margin: 0;
  color: var(--pool-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.admin-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
}

.admin-tab {
  padding: 0.75rem 1.5rem;
  background: #f1f5f9;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
}

.admin-tab:hover {
  background: #e2e8f0;
}

.admin-tab.active {
  background: var(--pool-color);
  color: white;
}

.admin-section {
  display: none;
}

.admin-section.active {
  display: block;
}

/* Form Styles */
.form-group {
  margin-bottom: 1.5rem;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--text-dark);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.2s ease;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--pool-color);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
}

@media (max-width: 600px) {
  .form-row {
    grid-template-columns: 1fr;
  }
}

/* Number Rows Editor */
.number-rows-editor {
  background: #f8fafc;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

/* Games Editor */
.games-editor {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.game-editor-item {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  border: 2px solid var(--border-color);
  transition: border-color 0.2s ease;
}

.game-editor-item:hover {
  border-color: var(--pool-color);
}

.game-editor-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid var(--border-color);
}

.game-editor-header h4 {
  margin: 0;
  color: var(--pool-color);
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.game-teams-row {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  gap: 1rem;
  align-items: center;
  margin-bottom: 1rem;
}

.game-teams-row .vs-label {
  font-weight: 700;
  color: var(--text-light);
}

.numbers-section {
  background: #f8fafc;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.numbers-section label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 0.5rem;
}

.numbers-grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 0.35rem;
}

.numbers-grid input {
  padding: 0.5rem;
  text-align: center;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-weight: 600;
  font-size: 0.9rem;
}

.numbers-grid input:focus {
  outline: none;
  border-color: var(--pool-color);
  background: #eff6ff;
}

.game-winner-section {
  background: #f8fafc;
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  border: 1px solid var(--border-color);
}

.game-winner-section h5 {
  margin: 0 0 1rem 0;
  color: var(--text-dark);
  font-size: 0.95rem;
}

.quarters-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

@media (max-width: 600px) {
  .quarters-grid {
    grid-template-columns: 1fr;
  }
}

.quarter-winner-row {
  background: white;
  border-radius: 8px;
  padding: 0.75rem;
  border-left: 4px solid var(--quarter-color);
}

.quarter-winner-row.q1 { --quarter-color: #ef4444; }
.quarter-winner-row.half { --quarter-color: #3b82f6; }
.quarter-winner-row.q3 { --quarter-color: #22c55e; }
.quarter-winner-row.final { --quarter-color: #f59e0b; }

.quarter-label {
  font-weight: 700;
  font-size: 0.8rem;
  color: var(--quarter-color);
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.quarter-label .dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--quarter-color);
}

.quarter-scores {
  display: flex;
  gap: 0.75rem;
  align-items: center;
}

.quarter-scores label {
  font-size: 0.75rem;
  color: var(--text-light);
  margin: 0;
}

.quarter-scores input {
  width: 45px;
  padding: 0.4rem;
  text-align: center;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-weight: 600;
}

.quarter-scores input:focus {
  outline: none;
  border-color: var(--quarter-color);
}

.quarter-winner-display {
  margin-top: 0.5rem;
  padding: 0.35rem 0.5rem;
  background: var(--quarter-color);
  color: white;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: 600;
}

.randomize-btn {
  background: #8b5cf6;
  color: white;
  border: none;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 600;
  transition: background 0.2s ease;
}

.randomize-btn:hover {
  background: #7c3aed;
}

.number-row-item {
  background: white;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
  border: 1px solid var(--border-color);
}

.number-row-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
}

.number-row-header h4 {
  margin: 0;
  color: var(--text-dark);
}

.number-inputs {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  gap: 0.5rem;
}

.number-inputs input {
  padding: 0.5rem;
  text-align: center;
  border: 1px solid var(--border-color);
  border-radius: 4px;
  font-weight: 600;
}

.number-inputs input:focus {
  outline: none;
  border-color: var(--pool-color);
}

/* Buttons */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: var(--pool-color);
  color: white;
}

.btn-primary:hover:not(:disabled) {
  background: #1e3a8a;
  transform: translateY(-2px);
}

.btn-success {
  background: var(--success-color);
  color: white;
}

.btn-success:hover:not(:disabled) {
  background: #16a34a;
}

.btn-danger {
  background: var(--danger-color);
  color: white;
}

.btn-danger:hover:not(:disabled) {
  background: #dc2626;
}

.btn-warning {
  background: var(--warning-color);
  color: white;
}

.btn-warning:hover:not(:disabled) {
  background: #d97706;
}

.btn-secondary {
  background: #64748b;
  color: white;
}

.btn-secondary:hover:not(:disabled) {
  background: #475569;
}

.btn-sm {
  padding: 0.5rem 1rem;
  font-size: 0.875rem;
}

/* Entries List */
.entries-list {
  max-height: 400px;
  overflow-y: auto;
  border: 1px solid var(--border-color);
  border-radius: 8px;
}

.entry-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.75rem 1rem;
  border-bottom: 1px solid var(--border-color);
}

.entry-item:last-child {
  border-bottom: none;
}

.entry-item:hover {
  background: #f8fafc;
}

.entry-info {
  display: flex;
  flex-direction: column;
}

.entry-name {
  font-weight: 600;
}

.entry-coords {
  font-size: 0.8rem;
  color: var(--text-light);
}

.entry-actions {
  display: flex;
  gap: 0.5rem;
}

/* Manual Entry Form */
.manual-entry-form {
  background: #f8fafc;
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

/* Link Type Tabs */
.link-type-tabs {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.link-type-tab {
  padding: 0.5rem 1rem;
  border: 2px solid var(--border-color);
  background: white;
  border-radius: 8px;
  cursor: pointer;
  font-size: 0.85rem;
  font-weight: 500;
  transition: all 0.2s ease;
}

.link-type-tab:hover {
  border-color: var(--pool-color);
  background: #eff6ff;
}

.link-type-tab.active {
  background: var(--pool-color);
  color: white;
  border-color: var(--pool-color);
}

/* User Search Results */
.user-search-results {
  max-height: 200px;
  overflow-y: auto;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  margin-top: 0.5rem;
  background: white;
  display: none;
}

.user-search-results.visible {
  display: block;
}

.user-search-result {
  padding: 0.75rem 1rem;
  cursor: pointer;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.user-search-result:last-child {
  border-bottom: none;
}

.user-search-result:hover {
  background: #f1f5f9;
}

.user-search-result.selected {
  background: #dbeafe;
  border-color: var(--pool-color);
}

.user-search-result .user-name {
  font-weight: 600;
}

.user-search-result .user-email {
  font-size: 0.8rem;
  color: var(--text-light);
}

.selected-user-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  background: #d1fae5;
  border: 1px solid var(--success-color);
  padding: 0.5rem 1rem;
  border-radius: 8px;
  margin-top: 0.5rem;
}

.selected-user-badge .remove-btn {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1rem;
  opacity: 0.6;
}

.selected-user-badge .remove-btn:hover {
  opacity: 1;
}

/* Legend */
.legend {
  display: flex;
  gap: 1.5rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

/* Game Tabs */
.game-tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  flex-wrap: wrap;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--border-color);
}

.game-tab {
  padding: 0.75rem 1.25rem;
  background: #f1f5f9;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.game-tab:hover {
  background: #e2e8f0;
  border-color: var(--pool-color);
}

.game-tab.active {
  background: var(--pool-color);
  color: white;
  border-color: var(--pool-color);
}

.game-tab .game-winner-badge {
  background: var(--accent-color);
  color: #1a1a1a;
  padding: 0.15rem 0.5rem;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 700;
}

/* Pre-lock Message */
.pre-lock-message {
  text-align: center;
  padding: 1.5rem;
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border-radius: 12px;
  margin-bottom: 1.5rem;
  border: 2px solid #f59e0b;
}

.pre-lock-message.hidden {
  display: none;
}

.pre-lock-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.pre-lock-message p {
  margin: 0;
  color: #92400e;
  font-weight: 600;
}

.pre-lock-message .pre-lock-subtitle {
  font-weight: 400;
  font-size: 0.9rem;
  margin-top: 0.25rem;
  opacity: 0.8;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.875rem;
}

.legend-box {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid var(--border-color);
}

.legend-box.available {
  background: white;
}

.legend-box.taken {
  background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
}

.legend-box.mine {
  background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
  border-color: var(--success-color);
}

.legend-box.winner {
  background: linear-gradient(135deg, var(--accent-color) 0%, #fbbf24 100%);
}

/* Stats */
.pool-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.stat-card {
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 12px;
  padding: 1rem;
  text-align: center;
}

.stat-value {
  font-size: 2rem;
  font-weight: 800;
  color: var(--pool-color);
}

.stat-label {
  font-size: 0.875rem;
  color: var(--text-light);
  margin-top: 0.25rem;
}

/* Toast */
.toast-container {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 9999;
}

.toast {
  background: var(--text-dark);
  color: white;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  margin-top: 0.5rem;
  box-shadow: var(--shadow-lg);
  animation: slideIn 0.3s ease;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.toast-success { background: var(--success-color); }
.toast-error { background: var(--danger-color); }
.toast-warning { background: var(--warning-color); }

@keyframes slideIn {
  from { transform: translateX(100%); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.modal-overlay.visible {
  opacity: 1;
  pointer-events: auto;
}

.modal {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  max-width: 500px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  transform: scale(0.9);
  transition: transform 0.3s ease;
}

.modal-overlay.visible .modal {
  transform: scale(1);
}

.modal h3 {
  margin: 0 0 1.5rem 0;
  color: var(--text-dark);
}

.modal-buttons {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

/* Responsive */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    text-align: center;
  }
  
  .header h1 {
    font-size: 1.5rem;
  }
  
  .container {
    padding: 1rem;
  }
  
  .grid-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  
  .boxes-grid {
    grid-template-columns: repeat(10, 40px);
    grid-template-rows: repeat(10, 40px);
  }
  
  .box {
    width: 40px;
    height: 40px;
    font-size: 0.6rem;
  }
  
  /* Hide hover tooltip on mobile - use tap instead */
  .box[data-fullname]:hover::after,
  .box[data-fullname]:hover::before {
    display: none;
  }
  
  .numbers-row {
    grid-template-columns: repeat(10, 40px);
  }
  
  .number-cell {
    width: 40px;
    height: 30px;
    font-size: 0.9rem;
  }
  
  .number-cell.row-number {
    width: 40px;
    height: 40px;
  }
  
  .numbers-container {
    margin-left: 50px;
    padding-left: 42px;
  }
  
  .team-label-top {
    margin-left: 50px;
  }
  
  .team-label-top,
  .team-label-left {
    font-size: 0.9rem;
    padding: 0.5rem;
  }
  
  .winner-indicators {
    gap: 1px;
  }
  
  .winner-dot {
    width: 5px;
    height: 5px;
  }
  
  .admin-tabs {
    flex-direction: column;
  }
  
  .admin-tab {
    width: 100%;
    text-align: center;
  }
  
  .game-tabs {
    overflow-x: auto;
    flex-wrap: nowrap;
    -webkit-overflow-scrolling: touch;
  }
  
  .game-tab {
    white-space: nowrap;
    flex-shrink: 0;
  }
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
  <p style="margin-top: 1rem; color: var(--text-light);">Loading pool...</p>
</div>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate">
  <h2>üîí Sign In Required</h2>
  <p>You need to sign in to view and participate in the boxes pool.</p>
  <a href="signin.html">Sign In</a>
</div>

<!-- Main Content -->
<div id="mainContent" style="display: none;">
  <header class="header">
    <div class="header-content">
      <div>
        <h1>üé≤ Boxes Pool</h1>
        <div class="pool-title" id="poolTitle">Select a pool to get started</div>
        <div class="header-badges">
          <span class="badge badge-open" id="poolStatusBadge">Open</span>
          <span class="badge badge-admin" id="adminBadge" style="display: none;">Admin</span>
        </div>
      </div>
      <div class="header-buttons">
        <a href="index.html" class="nav-btn">‚Üê Home</a>
        <a href="profile.html" class="nav-btn">üë§ Profile</a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Pool Selector -->
    <div class="pool-selector">
      <label for="poolSelect">Select Pool:</label>
      <select id="poolSelect">
        <option value="">Loading pools...</option>
      </select>
      <button class="btn btn-primary" onclick="loadPool()" id="loadPoolBtn">
        üîÑ Refresh
      </button>
      <button class="btn btn-success" onclick="showCreatePoolModal()" id="createPoolBtn" style="display: none;">
        ‚ûï Create Pool
      </button>
    </div>

    <!-- Pool Stats -->
    <div class="pool-stats" id="poolStats" style="display: none;">
      <div class="stat-card">
        <div class="stat-value" id="statClaimed">0</div>
        <div class="stat-label">Boxes Claimed</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statAvailable">100</div>
        <div class="stat-label">Available</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statMyBoxes">0</div>
        <div class="stat-label">My Boxes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPrizePool">$0</div>
        <div class="stat-label">Prize Pool</div>
      </div>
    </div>

    <!-- Grid Container -->
    <div class="grid-container" id="gridContainer" style="display: none;">
      
      <!-- Game Tabs (only visible when locked) -->
      <div class="game-tabs" id="gameTabs" style="display: none;">
        <!-- Game tabs will be inserted here -->
      </div>
      
      <!-- Pre-lock message -->
      <div class="pre-lock-message" id="preLockMessage">
        <div class="pre-lock-icon">üé≤</div>
        <p>Numbers will be revealed when the pool is locked!</p>
        <p class="pre-lock-subtitle">Claim your boxes now - positions are what matter.</p>
      </div>
      
      <div class="grid-wrapper">
        <!-- Top Team Label -->
        <div class="team-label-top" id="topTeamLabel">TEAM 1</div>
        
        <!-- Numbers for columns -->
        <div class="numbers-container" id="columnNumbersContainer">
          <!-- Number row will be inserted here -->
        </div>
        
        <!-- Grid with left label and row numbers -->
        <div class="grid-with-label">
          <!-- Left Team Label -->
          <div class="team-label-left" id="leftTeamLabel">TEAM 2</div>
          
          <!-- Row Numbers Column -->
          <div id="rowNumbersContainer" style="display: flex; gap: 2px;">
            <!-- Row numbers will be inserted here -->
          </div>
          
          <!-- The 10x10 Grid -->
          <div class="boxes-grid" id="boxesGrid">
            <!-- Boxes will be generated by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Legend -->
      <div class="legend">
        <div class="legend-item">
          <div class="legend-box available"></div>
          <span>Available</span>
        </div>
        <div class="legend-item">
          <div class="legend-box taken"></div>
          <span>Taken</span>
        </div>
        <div class="legend-item">
          <div class="legend-box mine"></div>
          <span>My Boxes</span>
        </div>
      </div>
      
      <!-- Winner Legend (only when locked) -->
      <div class="legend winner-legend" id="winnerLegend" style="display: none; margin-top: 0.75rem;">
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%); border-color: #ef4444;"></div>
          <span>1st Qtr</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%); border-color: #3b82f6;"></div>
          <span>Halftime</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%); border-color: #22c55e;"></div>
          <span>3rd Qtr</span>
        </div>
        <div class="legend-item">
          <div class="legend-box" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b;"></div>
          <span>Final</span>
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <div class="admin-header">
        <h2>‚öôÔ∏è Pool Management</h2>
      </div>
      
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="settings">Pool Settings</button>
        <button class="admin-tab" data-tab="games">Games</button>
        <button class="admin-tab" data-tab="entries">Manage Entries</button>
        <button class="admin-tab" data-tab="manual">Manual Entry</button>
      </div>

      <!-- Settings Tab -->
      <div class="admin-section active" id="tab-settings">
        <div class="form-row">
          <div class="form-group">
            <label>Pool Name</label>
            <input type="text" id="adminPoolName" placeholder="e.g., Thanksgiving 2025">
          </div>
          <div class="form-group">
            <label>Cost Per Box</label>
            <input type="number" id="adminCostPerBox" placeholder="e.g., 10" min="0">
          </div>
        </div>
        
        <div class="form-group">
          <label>Description</label>
          <textarea id="adminDescription" rows="3" placeholder="Pool rules, payout structure..."></textarea>
        </div>

        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
          <button class="btn btn-primary" onclick="savePoolSettings()">
            üíæ Save Settings
          </button>
          <button class="btn btn-warning" id="toggleLockBtn" onclick="togglePoolLock()">
            üîí Lock Pool
          </button>
          <button class="btn btn-danger" onclick="confirmDeletePool()">
            üóëÔ∏è Delete Pool
          </button>
        </div>
      </div>

      <!-- Games Tab -->
      <div class="admin-section" id="tab-games">
        <p style="color: var(--text-light); margin-bottom: 1rem;">
          Add games to this pool. Each game has its own teams and numbers. Numbers are revealed when the pool is locked.
        </p>
        
        <div class="games-editor" id="gamesEditor">
          <!-- Game items will be generated here -->
        </div>
        
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1.5rem;">
          <button class="btn btn-secondary" onclick="addGame()">
            ‚ûï Add Game
          </button>
          <button class="btn btn-primary" onclick="saveGames()">
            üíæ Save Games
          </button>
        </div>
      </div>

      <!-- Entries Tab -->
      <div class="admin-section" id="tab-entries">
        <p style="color: var(--text-light); margin-bottom: 1rem;">
          Manage pool entries. Remove unpaid entries or edit participant information.
        </p>
        
        <div class="form-group">
          <label>Filter Entries</label>
          <input type="text" id="entryFilter" placeholder="Search by name..." oninput="filterEntries()">
        </div>
        
        <div class="entries-list" id="entriesList">
          <div style="padding: 2rem; text-align: center; color: var(--text-light);">
            No entries yet
          </div>
        </div>
        
        <div style="margin-top: 1rem;">
          <button class="btn btn-danger" onclick="removeAllUnpaid()">
            üóëÔ∏è Remove All Unpaid
          </button>
        </div>
      </div>

      <!-- Manual Entry Tab -->
      <div class="admin-section" id="tab-manual">
        <p style="color: var(--text-light); margin-bottom: 1rem;">
          Add entries for others. Link to existing users or enter an email for future matching.
        </p>
        
        <div class="manual-entry-form">
          <!-- Link Type Selection -->
          <div class="form-group">
            <label>Entry Type</label>
            <div class="link-type-tabs">
              <button type="button" class="link-type-tab active" data-type="search" onclick="setLinkType('search')">
                üîç Search Existing User
              </button>
              <button type="button" class="link-type-tab" data-type="email" onclick="setLinkType('email')">
                ‚úâÔ∏è Enter Email (Future User)
              </button>
              <button type="button" class="link-type-tab" data-type="name" onclick="setLinkType('name')">
                üìù Name Only
              </button>
            </div>
          </div>
          
          <!-- Search Existing User -->
          <div class="form-group link-type-section" id="linkTypeSearch">
            <label>Search Users</label>
            <input type="text" id="userSearchInput" placeholder="Type to search users..." oninput="searchUsers()">
            <div class="user-search-results" id="userSearchResults"></div>
            <input type="hidden" id="selectedUserId">
            <input type="hidden" id="selectedUserName">
            <input type="hidden" id="selectedUserEmail">
          </div>
          
          <!-- Email for Future User -->
          <div class="form-group link-type-section" id="linkTypeEmail" style="display: none;">
            <label>Email Address</label>
            <input type="email" id="manualEmail" placeholder="person@example.com">
            <div class="form-group" style="margin-top: 0.75rem;">
              <label>Display Name</label>
              <input type="text" id="manualNameEmail" placeholder="Enter name...">
            </div>
            <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
              üí° When this person creates an account with this email, the box will automatically link to them.
            </p>
          </div>
          
          <!-- Name Only (no linking) -->
          <div class="form-group link-type-section" id="linkTypeName" style="display: none;">
            <label>Participant Name</label>
            <input type="text" id="manualName" placeholder="Enter name...">
            <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.5rem;">
              ‚ö†Ô∏è This entry won't be linked to any user account.
            </p>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>Paid?</label>
              <select id="manualPaid">
                <option value="true">Yes - Paid</option>
                <option value="false">No - Not Paid</option>
              </select>
            </div>
            <div class="form-group">
              <label>Select Boxes</label>
              <input type="text" id="manualCoords" placeholder="e.g., 0-0, 3-5 (or click grid)">
            </div>
          </div>
          
          <button class="btn btn-success" onclick="addManualEntry()">
            ‚ûï Add Entry
          </button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Create Pool Modal -->
<div class="modal-overlay" id="createPoolModal">
  <div class="modal">
    <h3>‚ûï Create New Pool</h3>
    
    <div class="form-group">
      <label>Pool Name</label>
      <input type="text" id="newPoolName" placeholder="e.g., Thanksgiving 2025, Super Bowl LIX">
    </div>
    
    <div class="form-group">
      <label>Cost Per Box</label>
      <input type="number" id="newCostPerBox" placeholder="10" min="0" value="10">
    </div>
    
    <div class="form-group">
      <label>Description (optional)</label>
      <textarea id="newDescription" rows="2" placeholder="Pool rules, payout structure..."></textarea>
    </div>
    
    <p style="font-size: 0.85rem; color: var(--text-light); margin-top: 1rem;">
      üí° After creating the pool, use the "Games" tab to add individual games with their teams and numbers.
    </p>
    
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="hideCreatePoolModal()">Cancel</button>
      <button class="btn btn-success" onclick="createPool()">Create Pool</button>
    </div>
  </div>
</div>

<!-- Confirm Box Modal -->
<div class="modal-overlay" id="confirmBoxModal">
  <div class="modal">
    <h3>Claim This Box?</h3>
    <p id="confirmBoxText">Are you sure you want to claim box (0, 0)?</p>
    <p style="color: var(--text-light); font-size: 0.9rem;">
      Cost: <strong id="confirmBoxCost">$10</strong>
    </p>
    <div class="modal-buttons">
      <button class="btn btn-secondary" onclick="hideConfirmBoxModal()">Cancel</button>
      <button class="btn btn-success" onclick="confirmClaimBox()">Claim Box</button>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script type="module">
  import { auth, getUserProfile, USER_ROLES } from './firebase-auth.js';
  import { db } from './firebase-config.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { 
    collection, 
    getDocs, 
    doc, 
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    addDoc,
    query,
    where,
    orderBy,
    Timestamp,
    serverTimestamp,
    arrayUnion,
    arrayRemove
  } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  // ========================================
  // GLOBAL STATE
  // ========================================
  let currentUser = null;
  let userProfile = null;
  let isAdmin = false;
  let currentPool = null;
  let selectedBoxForManual = null;
  let pendingBoxClaim = null;
  let selectedGameIndex = 0;  // Currently selected game tab

  // ========================================
  // INITIALIZATION
  // ========================================
  
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      await initializePage();
    } else {
      showAuthGate();
    }
  });

  async function initializePage() {
    try {
      // Get user profile and check role
      const profileResult = await getUserProfile(currentUser.uid);
      if (profileResult.success) {
        userProfile = profileResult.data;
      }
      
      // Check if admin or oddsmaker
      checkAdminStatus();
      
      // Load available pools
      await loadPoolsList();
      
      // Show main content
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authGate').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // Setup admin tabs
      setupAdminTabs();
      
    } catch (error) {
      console.error('Error initializing:', error);
      showToast('Error loading page', 'error');
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  }

  function checkAdminStatus() {
    if (!userProfile) {
      isAdmin = false;
      return;
    }
    
    const userRole = (userProfile.userRole || '').toLowerCase();
    
    // Check for admin or oddsmaker special role
    isAdmin = 
      userProfile.isAdmin === true ||
      userRole === 'admin' ||
      (userProfile.specialRoles && userProfile.specialRoles.oddsmaker === true);
    
    if (isAdmin) {
      document.getElementById('adminBadge').style.display = 'inline-block';
      document.getElementById('adminBadge').textContent = userProfile.specialRoles?.oddsmaker ? 'Oddsmaker' : 'Admin';
      document.getElementById('createPoolBtn').style.display = 'inline-flex';
    }
  }

  function showAuthGate() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('authGate').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
  }

  // ========================================
  // POOL MANAGEMENT
  // ========================================

  async function loadPoolsList() {
    const poolSelect = document.getElementById('poolSelect');
    
    try {
      const poolsSnap = await getDocs(
        query(collection(db, 'boxesPools'), orderBy('createdAt', 'desc'))
      );
      
      if (poolsSnap.empty) {
        poolSelect.innerHTML = '<option value="">No pools available</option>';
        return;
      }
      
      let options = '<option value="">Select a pool...</option>';
      poolsSnap.docs.forEach(doc => {
        const pool = doc.data();
        const status = pool.locked ? 'üîí' : 'üü¢';
        options += `<option value="${doc.id}">${status} ${pool.name}</option>`;
      });
      
      poolSelect.innerHTML = options;
      
      // Auto-select if only one pool or URL param
      const urlParams = new URLSearchParams(window.location.search);
      const poolId = urlParams.get('pool');
      if (poolId) {
        poolSelect.value = poolId;
        await loadPool();
      }
      
    } catch (error) {
      console.error('Error loading pools:', error);
      poolSelect.innerHTML = '<option value="">Error loading pools</option>';
    }
  }

  window.loadPool = async function() {
    const poolId = document.getElementById('poolSelect').value;
    if (!poolId) {
      document.getElementById('gridContainer').style.display = 'none';
      document.getElementById('poolStats').style.display = 'none';
      document.getElementById('adminPanel').classList.remove('visible');
      return;
    }
    
    try {
      const poolDoc = await getDoc(doc(db, 'boxesPools', poolId));
      
      if (!poolDoc.exists()) {
        showToast('Pool not found', 'error');
        return;
      }
      
      currentPool = { id: poolDoc.id, ...poolDoc.data() };
      
      // Auto-claim any pending entries for current user
      await claimPendingEntries();
      
      // Update UI
      updatePoolDisplay();
      renderGrid();
      updateStats();
      
      // Show grid
      document.getElementById('gridContainer').style.display = 'block';
      document.getElementById('poolStats').style.display = 'grid';
      
      // Show admin panel if admin
      if (isAdmin) {
        document.getElementById('adminPanel').classList.add('visible');
        populateAdminFields();
      }
      
    } catch (error) {
      console.error('Error loading pool:', error);
      showToast('Error loading pool', 'error');
    }
  };

  // Auto-claim entries that have pendingEmail matching current user's email
  // OR entries linked to user's mergedFromProfile (legacy profile)
  async function claimPendingEntries() {
    if (!currentPool || !currentUser.email) return;
    
    const userEmail = currentUser.email.toLowerCase();
    const mergedFrom = userProfile?.mergedFromProfile;
    const entries = currentPool.entries || {};
    const pendingMatches = [];
    
    // Find entries with matching pendingEmail OR mergedFromProfile
    for (const [key, entry] of Object.entries(entries)) {
      // Pending email match (not yet claimed)
      if (entry.pendingEmail && entry.pendingEmail.toLowerCase() === userEmail && !entry.userId) {
        pendingMatches.push({ key, reason: 'email' });
      }
      // Legacy profile match (entry linked to old profile ID)
      else if (mergedFrom && entry.userId === mergedFrom) {
        pendingMatches.push({ key, reason: 'migration' });
      }
    }
    
    if (pendingMatches.length === 0) return;
    
    try {
      // Update all matching entries with user's ID
      const updates = {};
      const userName = userProfile?.displayName || currentUser.displayName || currentUser.email.split('@')[0];
      
      pendingMatches.forEach(({ key }) => {
        updates[`entries.${key}.userId`] = currentUser.uid;
        updates[`entries.${key}.name`] = userName; // Update name to their actual profile name
        updates[`entries.${key}.email`] = currentUser.email;
        updates[`entries.${key}.claimedByUserAt`] = serverTimestamp();
      });
      
      await updateDoc(doc(db, 'boxesPools', currentPool.id), updates);
      
      // Update local state
      pendingMatches.forEach(({ key }) => {
        currentPool.entries[key].userId = currentUser.uid;
        currentPool.entries[key].name = userName;
      });
      
      const emailMatches = pendingMatches.filter(m => m.reason === 'email').length;
      const migrationMatches = pendingMatches.filter(m => m.reason === 'migration').length;
      
      if (emailMatches > 0 && migrationMatches > 0) {
        showToast(`üéâ ${pendingMatches.length} box(es) have been linked to your account!`, 'success');
      } else if (emailMatches > 0) {
        showToast(`üéâ ${emailMatches} box(es) have been linked to your account!`, 'success');
      } else if (migrationMatches > 0) {
        showToast(`üéâ ${migrationMatches} box(es) transferred from your old profile!`, 'success');
      }
      
    } catch (error) {
      console.error('Error claiming pending entries:', error);
      // Don't show error to user - not critical
    }
  }

  function updatePoolDisplay() {
    document.getElementById('poolTitle').textContent = currentPool.name || 'Boxes Pool';
    
    const statusBadge = document.getElementById('poolStatusBadge');
    const preLockMessage = document.getElementById('preLockMessage');
    const gameTabs = document.getElementById('gameTabs');
    const colNumbersContainer = document.getElementById('columnNumbersContainer');
    const rowNumbersContainer = document.getElementById('rowNumbersContainer');
    
    if (currentPool.locked) {
      statusBadge.textContent = 'Locked';
      statusBadge.className = 'badge badge-locked';
      preLockMessage.classList.add('hidden');
      
      // Show game tabs if there are games
      const games = currentPool.games || [];
      if (games.length > 0) {
        gameTabs.style.display = 'flex';
        renderGameTabs();
      } else {
        gameTabs.style.display = 'none';
      }
      
      // Show numbers
      colNumbersContainer.style.display = 'block';
      rowNumbersContainer.style.display = 'flex';
    } else {
      statusBadge.textContent = 'Open';
      statusBadge.className = 'badge badge-open';
      preLockMessage.classList.remove('hidden');
      gameTabs.style.display = 'none';
      
      // Hide numbers until locked
      colNumbersContainer.style.display = 'none';
      rowNumbersContainer.style.display = 'none';
    }
    
    // Update team labels based on selected game or pool defaults
    updateTeamLabels();
  }

  function renderGameTabs() {
    const gameTabs = document.getElementById('gameTabs');
    const games = currentPool.games || [];
    
    if (games.length === 0) {
      gameTabs.innerHTML = '<p style="color: var(--text-light);">No games configured</p>';
      return;
    }
    
    gameTabs.innerHTML = games.map((game, idx) => {
      const winners = game.winners || {};
      const winnerCount = Object.keys(winners).filter(q => winners[q]?.box).length;
      
      return `
        <button class="game-tab ${idx === selectedGameIndex ? 'active' : ''}" 
                onclick="selectGame(${idx})">
          üèà ${game.label || `Game ${idx + 1}`}
          ${winnerCount > 0 ? `<span class="game-winner-badge">üèÜ ${winnerCount}/4</span>` : ''}
        </button>
      `;
    }).join('');
  }

  window.selectGame = function(idx) {
    selectedGameIndex = idx;
    renderGameTabs();
    updateTeamLabels();
    renderNumbers();
    renderGrid();
  };

  function updateTeamLabels() {
    const games = currentPool.games || [];
    let team1 = 'TEAM 1';
    let team2 = 'TEAM 2';
    
    // If locked and there are games, use the selected game's teams
    if (currentPool.locked && games.length > 0 && games[selectedGameIndex]) {
      const game = games[selectedGameIndex];
      team1 = game.team1 || 'TEAM 1';
      team2 = game.team2 || 'TEAM 2';
    } else if (!currentPool.locked) {
      // Before lock, show generic labels
      team1 = '‚Üê Numbers Hidden ‚Üí';
      team2 = '‚Üë';
    }
    
    document.getElementById('topTeamLabel').textContent = team1;
    document.getElementById('leftTeamLabel').textContent = team2;
  }

  // Helper function to abbreviate names for display
  function abbreviateName(fullName) {
    if (!fullName) return '?';
    
    const parts = fullName.trim().split(/\s+/);
    
    if (parts.length === 1) {
      // Single name - show first 8 chars
      return parts[0].length > 8 ? parts[0].substring(0, 7) + '.' : parts[0];
    }
    
    // Multiple parts - show first initial + last name
    const firstName = parts[0];
    const lastName = parts[parts.length - 1];
    
    // With 55px boxes, we can fit about 9-10 chars comfortably
    // "X. LastName" format
    if (lastName.length <= 8) {
      return `${firstName.charAt(0)}. ${lastName}`;
    } else {
      // Truncate long last names
      return `${firstName.charAt(0)}. ${lastName.substring(0, 7)}`;
    }
  }

  function renderGrid() {
    const grid = document.getElementById('boxesGrid');
    const entries = currentPool.entries || {};
    const games = currentPool.games || [];
    
    // Get winners for the currently selected game
    let gameWinners = {};
    if (currentPool.locked && games.length > 0 && games[selectedGameIndex]) {
      gameWinners = games[selectedGameIndex].winners || {};
    }
    
    // Build a map of box -> which quarters won
    const winnerMap = {};
    const quarters = ['q1', 'half', 'q3', 'final'];
    quarters.forEach(quarter => {
      if (gameWinners[quarter]?.box) {
        const box = gameWinners[quarter].box;
        if (!winnerMap[box]) winnerMap[box] = [];
        winnerMap[box].push(quarter);
      }
    });
    
    // Show/hide winner legend
    const winnerLegend = document.getElementById('winnerLegend');
    if (winnerLegend) {
      winnerLegend.style.display = currentPool.locked ? 'flex' : 'none';
    }
    
    grid.innerHTML = '';
    
    for (let row = 0; row < 10; row++) {
      for (let col = 0; col < 10; col++) {
        const box = document.createElement('div');
        box.className = 'box';
        box.dataset.row = row;
        box.dataset.col = col;
        
        const key = `${row}-${col}`;
        const entry = entries[key];
        
        if (entry) {
          box.classList.add('taken');
          
          const fullName = entry.name || 'Unknown';
          const displayName = abbreviateName(fullName);
          
          // Add tooltip data attribute for hover
          box.dataset.fullname = fullName;
          
          // Check if it's my box:
          // 1. Direct userId match
          // 2. pendingEmail match
          // 3. Entry's userId matches my mergedFromProfile (legacy profile I migrated from)
          const isMyBox = entry.userId === currentUser.uid || 
                          (entry.pendingEmail && entry.pendingEmail.toLowerCase() === currentUser.email?.toLowerCase()) ||
                          (userProfile?.mergedFromProfile && entry.userId === userProfile.mergedFromProfile);
          
          if (isMyBox) {
            box.classList.add('my-box');
          }
          
          // Check if this box won any quarters
          const wonQuarters = winnerMap[key] || [];
          if (wonQuarters.length > 0) {
            box.classList.add('winner');
            box.classList.add(`winner-count-${wonQuarters.length}`);
            
            // Add individual quarter classes
            wonQuarters.forEach(q => box.classList.add(`winner-${q}`));
            
            // Set CSS variables for split colors
            const colorMap = {
              q1: '#fecaca',
              half: '#bfdbfe', 
              q3: '#bbf7d0',
              final: '#fef3c7'
            };
            
            wonQuarters.forEach((q, i) => {
              box.style.setProperty(`--split-color-${i + 1}`, colorMap[q]);
            });
            
            // Create name + indicator dots
            const nameSpan = document.createElement('span');
            nameSpan.className = 'winner-name';
            nameSpan.textContent = displayName;
            box.appendChild(nameSpan);
            
            const indicators = document.createElement('div');
            indicators.className = 'winner-indicators';
            wonQuarters.forEach(q => {
              const dot = document.createElement('div');
              dot.className = `winner-dot ${q}`;
              dot.title = q === 'q1' ? '1st Qtr' : q === 'half' ? 'Halftime' : q === 'q3' ? '3rd Qtr' : 'Final';
              indicators.appendChild(dot);
            });
            box.appendChild(indicators);
          } else {
            box.textContent = displayName;
          }
          
          // Mobile tap handler to show full name
          box.onclick = (e) => {
            if (window.innerWidth <= 768 && entry) {
              e.stopPropagation();
              showToast(fullName, 'info');
            }
          };
        }
        
        if (currentPool.locked) {
          box.classList.add('locked');
        }
        
        // Click handler for unclaimed boxes
        if (!entry && !currentPool.locked) {
          box.onclick = () => handleBoxClick(row, col);
        }
        
        grid.appendChild(box);
      }
    }
    
    // Render numbers for selected game
    renderNumbers();
  }

  function renderNumbers() {
    const colContainer = document.getElementById('columnNumbersContainer');
    const rowContainer = document.getElementById('rowNumbersContainer');
    
    // Clear existing
    colContainer.innerHTML = '';
    rowContainer.innerHTML = '';
    
    // Don't show numbers if not locked
    if (!currentPool.locked) {
      return;
    }
    
    const games = currentPool.games || [];
    
    // If no games, nothing to show
    if (games.length === 0) {
      return;
    }
    
    const game = games[selectedGameIndex];
    if (!game) return;
    
    const numbers = game.numbers || [0,1,2,3,4,5,6,7,8,9];
    const rowNumbers = game.rowNumbers || numbers;
    
    // Column numbers (single row for selected game)
    const colRow = document.createElement('div');
    colRow.className = 'numbers-row';
    
    for (let i = 0; i < 10; i++) {
      const cell = document.createElement('div');
      cell.className = 'number-cell';
      cell.textContent = numbers[i] !== undefined ? numbers[i] : '?';
      colRow.appendChild(cell);
    }
    colContainer.appendChild(colRow);
    
    // Row numbers
    const rowCol = document.createElement('div');
    rowCol.className = 'row-numbers-column';
    rowCol.style.display = 'flex';
    rowCol.style.flexDirection = 'column';
    rowCol.style.gap = '2px';
    
    for (let i = 0; i < 10; i++) {
      const cell = document.createElement('div');
      cell.className = 'number-cell row-number';
      cell.textContent = rowNumbers[i] !== undefined ? rowNumbers[i] : '?';
      rowCol.appendChild(cell);
    }
    rowContainer.appendChild(rowCol);
  }

  // Legacy function - kept for compatibility
  function renderNumberRows() {
    renderNumbers();
  }

  function updateStats() {
    const entries = currentPool.entries || {};
    const entryCount = Object.keys(entries).length;
    const userEmail = currentUser.email?.toLowerCase();
    const mergedFrom = userProfile?.mergedFromProfile;
    
    const myBoxes = Object.values(entries).filter(e => 
      e.userId === currentUser.uid || 
      (e.pendingEmail && e.pendingEmail.toLowerCase() === userEmail) ||
      (mergedFrom && e.userId === mergedFrom)
    ).length;
    const costPerBox = currentPool.costPerBox || 0;
    
    document.getElementById('statClaimed').textContent = entryCount;
    document.getElementById('statAvailable').textContent = 100 - entryCount;
    document.getElementById('statMyBoxes').textContent = myBoxes;
    document.getElementById('statPrizePool').textContent = '$' + (entryCount * costPerBox);
  }

  // ========================================
  // BOX CLAIMING
  // ========================================

  function handleBoxClick(row, col) {
    if (currentPool.locked) {
      showToast('Pool is locked', 'warning');
      return;
    }
    
    // Check if already taken
    const key = `${row}-${col}`;
    if (currentPool.entries && currentPool.entries[key]) {
      showToast('This box is already taken', 'warning');
      return;
    }
    
    // If in manual entry mode for admin
    if (isAdmin && document.getElementById('tab-manual').classList.contains('active')) {
      const coordsInput = document.getElementById('manualCoords');
      const current = coordsInput.value ? coordsInput.value + ', ' : '';
      coordsInput.value = current + key;
      return;
    }
    
    // Show confirmation modal
    pendingBoxClaim = { row, col };
    document.getElementById('confirmBoxText').textContent = 
      `Are you sure you want to claim box at row ${row}, column ${col}?`;
    document.getElementById('confirmBoxCost').textContent = 
      '$' + (currentPool.costPerBox || 0);
    document.getElementById('confirmBoxModal').classList.add('visible');
  }

  window.hideConfirmBoxModal = function() {
    document.getElementById('confirmBoxModal').classList.remove('visible');
    pendingBoxClaim = null;
  };

  window.confirmClaimBox = async function() {
    if (!pendingBoxClaim) return;
    
    const { row, col } = pendingBoxClaim;
    const key = `${row}-${col}`;
    
    try {
      // Update in Firestore
      const poolRef = doc(db, 'boxesPools', currentPool.id);
      
      await updateDoc(poolRef, {
        [`entries.${key}`]: {
          userId: currentUser.uid,
          name: userProfile?.displayName || currentUser.displayName || currentUser.email.split('@')[0],
          email: currentUser.email,
          claimedAt: serverTimestamp(),
          paid: false
        }
      });
      
      // Update local state
      if (!currentPool.entries) currentPool.entries = {};
      currentPool.entries[key] = {
        userId: currentUser.uid,
        name: userProfile?.displayName || currentUser.displayName || currentUser.email.split('@')[0]
      };
      
      // Refresh display
      renderGrid();
      updateStats();
      hideConfirmBoxModal();
      
      showToast('Box claimed successfully!', 'success');
      
    } catch (error) {
      console.error('Error claiming box:', error);
      showToast('Error claiming box', 'error');
    }
  };

  // ========================================
  // ADMIN FUNCTIONS
  // ========================================

  function setupAdminTabs() {
    document.querySelectorAll('.admin-tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));
        
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      };
    });
  }

  function populateAdminFields() {
    if (!currentPool) return;
    
    // Settings
    document.getElementById('adminPoolName').value = currentPool.name || '';
    document.getElementById('adminCostPerBox').value = currentPool.costPerBox || 0;
    document.getElementById('adminDescription').value = currentPool.description || '';
    
    // Lock button
    const lockBtn = document.getElementById('toggleLockBtn');
    if (currentPool.locked) {
      lockBtn.textContent = 'üîì Unlock Pool';
      lockBtn.className = 'btn btn-success';
    } else {
      lockBtn.textContent = 'üîí Lock Pool';
      lockBtn.className = 'btn btn-warning';
    }
    
    // Load users for manual entry search
    loadUsersForSearch();
    
    // Reset manual entry form to default state
    setLinkType('search');
    
    // Games editor
    renderGamesEditor();
    
    // Entries list
    renderEntriesList();
  }

  window.savePoolSettings = async function() {
    if (!currentPool || !isAdmin) return;
    
    try {
      await updateDoc(doc(db, 'boxesPools', currentPool.id), {
        name: document.getElementById('adminPoolName').value,
        costPerBox: parseFloat(document.getElementById('adminCostPerBox').value) || 0,
        description: document.getElementById('adminDescription').value,
        updatedAt: serverTimestamp()
      });
      
      // Reload
      await loadPool();
      showToast('Settings saved!', 'success');
      
    } catch (error) {
      console.error('Error saving settings:', error);
      showToast('Error saving settings', 'error');
    }
  };

  window.togglePoolLock = async function() {
    if (!currentPool || !isAdmin) return;
    
    try {
      await updateDoc(doc(db, 'boxesPools', currentPool.id), {
        locked: !currentPool.locked,
        updatedAt: serverTimestamp()
      });
      
      await loadPool();
      showToast(currentPool.locked ? 'Pool unlocked' : 'Pool locked', 'success');
      
    } catch (error) {
      console.error('Error toggling lock:', error);
      showToast('Error updating pool', 'error');
    }
  };

  window.confirmDeletePool = function() {
    if (!confirm('Are you sure you want to delete this pool? This cannot be undone!')) return;
    if (!confirm('Really delete? All entries will be lost!')) return;
    
    deletePool();
  };

  async function deletePool() {
    if (!currentPool || !isAdmin) return;
    
    try {
      await deleteDoc(doc(db, 'boxesPools', currentPool.id));
      currentPool = null;
      
      await loadPoolsList();
      document.getElementById('gridContainer').style.display = 'none';
      document.getElementById('poolStats').style.display = 'none';
      document.getElementById('adminPanel').classList.remove('visible');
      
      showToast('Pool deleted', 'success');
      
    } catch (error) {
      console.error('Error deleting pool:', error);
      showToast('Error deleting pool', 'error');
    }
  }

  // ========================================
  // GAMES MANAGEMENT
  // ========================================

  function renderGamesEditor() {
    const container = document.getElementById('gamesEditor');
    const games = currentPool.games || [];
    
    if (games.length === 0) {
      container.innerHTML = `
        <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 12px; border: 2px dashed var(--border-color);">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üèà</div>
          <p style="color: var(--text-light); margin: 0;">No games added yet. Click "Add Game" to get started.</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = games.map((game, idx) => {
      const winners = game.winners || {};
      const team1 = game.team1 || 'Team 1';
      const team2 = game.team2 || 'Team 2';
      
      // Helper to get winner name for a quarter
      const getWinnerName = (quarter) => {
        const box = winners[quarter]?.box;
        return box ? currentPool.entries?.[box]?.name : null;
      };
      
      return `
        <div class="game-editor-item" data-idx="${idx}">
          <div class="game-editor-header">
            <h4>
              <span>üèà</span>
              <input type="text" value="${game.label || `Game ${idx + 1}`}" 
                     class="game-label-input" 
                     style="border: none; background: transparent; font-size: 1rem; font-weight: 600; width: 200px;"
                     placeholder="Game name...">
            </h4>
            <div style="display: flex; gap: 0.5rem;">
              <button class="randomize-btn" onclick="randomizeGameNumbers(${idx})">
                üé≤ Randomize
              </button>
              <button class="btn btn-sm btn-danger" onclick="removeGame(${idx})">
                üóëÔ∏è Remove
              </button>
            </div>
          </div>
          
          <div class="game-teams-row">
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.8rem;">Team 1 (Top)</label>
              <input type="text" value="${game.team1 || ''}" 
                     class="game-team1-input" placeholder="e.g., Lions">
            </div>
            <span class="vs-label">vs</span>
            <div class="form-group" style="margin: 0;">
              <label style="font-size: 0.8rem;">Team 2 (Left)</label>
              <input type="text" value="${game.team2 || ''}" 
                     class="game-team2-input" placeholder="e.g., Bears">
            </div>
          </div>
          
          <div class="numbers-section">
            <label>${team1} Numbers (columns):</label>
            <div class="numbers-grid">
              ${[0,1,2,3,4,5,6,7,8,9].map(i => `
                <input type="number" min="0" max="9" 
                       value="${game.numbers ? game.numbers[i] : i}" 
                       class="game-col-number" data-game="${idx}" data-pos="${i}">
              `).join('')}
            </div>
          </div>
          
          <div class="numbers-section">
            <label>${team2} Numbers (rows):</label>
            <div class="numbers-grid">
              ${[0,1,2,3,4,5,6,7,8,9].map(i => `
                <input type="number" min="0" max="9" 
                       value="${game.rowNumbers ? game.rowNumbers[i] : i}" 
                       class="game-row-number" data-game="${idx}" data-pos="${i}">
              `).join('')}
            </div>
          </div>
          
          <div class="game-winner-section">
            <h5>üèÜ Winners (enter score last digits for each quarter)</h5>
            <div class="quarters-grid">
              
              <div class="quarter-winner-row q1">
                <div class="quarter-label"><span class="dot"></span> 1st Quarter</div>
                <div class="quarter-scores">
                  <label>${team1}:</label>
                  <input type="number" min="0" max="9" class="q1-score1" data-game="${idx}" 
                         value="${winners.q1?.score1 ?? ''}" placeholder="-">
                  <label>${team2}:</label>
                  <input type="number" min="0" max="9" class="q1-score2" data-game="${idx}"
                         value="${winners.q1?.score2 ?? ''}" placeholder="-">
                </div>
                ${getWinnerName('q1') ? `<div class="quarter-winner-display">üèÜ ${getWinnerName('q1')}</div>` : ''}
              </div>
              
              <div class="quarter-winner-row half">
                <div class="quarter-label"><span class="dot"></span> Halftime</div>
                <div class="quarter-scores">
                  <label>${team1}:</label>
                  <input type="number" min="0" max="9" class="half-score1" data-game="${idx}"
                         value="${winners.half?.score1 ?? ''}" placeholder="-">
                  <label>${team2}:</label>
                  <input type="number" min="0" max="9" class="half-score2" data-game="${idx}"
                         value="${winners.half?.score2 ?? ''}" placeholder="-">
                </div>
                ${getWinnerName('half') ? `<div class="quarter-winner-display">üèÜ ${getWinnerName('half')}</div>` : ''}
              </div>
              
              <div class="quarter-winner-row q3">
                <div class="quarter-label"><span class="dot"></span> 3rd Quarter</div>
                <div class="quarter-scores">
                  <label>${team1}:</label>
                  <input type="number" min="0" max="9" class="q3-score1" data-game="${idx}"
                         value="${winners.q3?.score1 ?? ''}" placeholder="-">
                  <label>${team2}:</label>
                  <input type="number" min="0" max="9" class="q3-score2" data-game="${idx}"
                         value="${winners.q3?.score2 ?? ''}" placeholder="-">
                </div>
                ${getWinnerName('q3') ? `<div class="quarter-winner-display">üèÜ ${getWinnerName('q3')}</div>` : ''}
              </div>
              
              <div class="quarter-winner-row final">
                <div class="quarter-label"><span class="dot"></span> Final</div>
                <div class="quarter-scores">
                  <label>${team1}:</label>
                  <input type="number" min="0" max="9" class="final-score1" data-game="${idx}"
                         value="${winners.final?.score1 ?? ''}" placeholder="-">
                  <label>${team2}:</label>
                  <input type="number" min="0" max="9" class="final-score2" data-game="${idx}"
                         value="${winners.final?.score2 ?? ''}" placeholder="-">
                </div>
                ${getWinnerName('final') ? `<div class="quarter-winner-display">üèÜ ${getWinnerName('final')}</div>` : ''}
              </div>
              
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  window.addGame = function() {
    if (!currentPool) return;
    
    const games = currentPool.games || [];
    games.push({
      label: `Game ${games.length + 1}`,
      team1: '',
      team2: '',
      numbers: [0,1,2,3,4,5,6,7,8,9],
      rowNumbers: [0,1,2,3,4,5,6,7,8,9],
      winners: {}  // { q1: {score1, score2, box}, half: {...}, q3: {...}, final: {...} }
    });
    currentPool.games = games;
    
    renderGamesEditor();
  };

  window.removeGame = function(idx) {
    if (!currentPool || !currentPool.games) return;
    if (!confirm('Remove this game?')) return;
    
    currentPool.games.splice(idx, 1);
    renderGamesEditor();
  };

  window.randomizeGameNumbers = function(idx) {
    const container = document.getElementById('gamesEditor');
    const gameItem = container.querySelectorAll('.game-editor-item')[idx];
    
    if (!gameItem) return;
    
    // Randomize column numbers
    const colNums = shuffle([0,1,2,3,4,5,6,7,8,9]);
    gameItem.querySelectorAll('.game-col-number').forEach((input, i) => {
      input.value = colNums[i];
    });
    
    // Randomize row numbers
    const rowNums = shuffle([0,1,2,3,4,5,6,7,8,9]);
    gameItem.querySelectorAll('.game-row-number').forEach((input, i) => {
      input.value = rowNums[i];
    });
    
    showToast('Numbers randomized! Click Save to apply.', 'success');
  };

  function shuffle(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  window.saveGames = async function() {
    if (!currentPool || !isAdmin) return;
    
    const container = document.getElementById('gamesEditor');
    const gameItems = container.querySelectorAll('.game-editor-item');
    
    const games = [];
    
    gameItems.forEach((item, idx) => {
      const label = item.querySelector('.game-label-input').value;
      const team1 = item.querySelector('.game-team1-input').value;
      const team2 = item.querySelector('.game-team2-input').value;
      const colNumbers = Array.from(item.querySelectorAll('.game-col-number')).map(i => parseInt(i.value));
      const rowNumbers = Array.from(item.querySelectorAll('.game-row-number')).map(i => parseInt(i.value));
      
      // Calculate winners for each quarter
      const winners = {};
      const quarters = ['q1', 'half', 'q3', 'final'];
      
      quarters.forEach(quarter => {
        const score1Input = item.querySelector(`.${quarter}-score1`);
        const score2Input = item.querySelector(`.${quarter}-score2`);
        
        const score1 = score1Input?.value !== '' ? parseInt(score1Input.value) : null;
        const score2 = score2Input?.value !== '' ? parseInt(score2Input.value) : null;
        
        if (score1 !== null && !isNaN(score1) && score2 !== null && !isNaN(score2)) {
          const colIdx = colNumbers.indexOf(score1);
          const rowIdx = rowNumbers.indexOf(score2);
          
          if (colIdx !== -1 && rowIdx !== -1) {
            winners[quarter] = {
              score1,
              score2,
              box: `${rowIdx}-${colIdx}`
            };
          }
        }
      });
      
      games.push({
        label,
        team1,
        team2,
        numbers: colNumbers,
        rowNumbers: rowNumbers,
        winners
      });
    });
    
    try {
      await updateDoc(doc(db, 'boxesPools', currentPool.id), {
        games,
        updatedAt: serverTimestamp()
      });
      
      currentPool.games = games;
      
      // Update displays
      updatePoolDisplay();
      renderGrid();
      renderGamesEditor();
      
      showToast('Games saved!', 'success');
      
    } catch (error) {
      console.error('Error saving games:', error);
      showToast('Error saving games', 'error');
    }
  };

  // ========================================
  // ENTRIES MANAGEMENT
  // ========================================

  function renderEntriesList() {
    const container = document.getElementById('entriesList');
    const entries = currentPool.entries || {};
    const filter = (document.getElementById('entryFilter')?.value || '').toLowerCase();
    
    const entryList = Object.entries(entries)
      .map(([key, entry]) => ({ key, ...entry }))
      .filter(e => !filter || (e.name && e.name.toLowerCase().includes(filter)))
      .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    
    if (entryList.length === 0) {
      container.innerHTML = '<div style="padding: 2rem; text-align: center; color: var(--text-light);">No entries found</div>';
      return;
    }
    
    container.innerHTML = entryList.map(entry => `
      <div class="entry-item">
        <div class="entry-info">
          <span class="entry-name">
            ${entry.name || 'Unknown'}
            ${entry.paid ? '‚úÖ' : '‚ö†Ô∏è'}
          </span>
          <span class="entry-coords">Box: ${entry.key}</span>
        </div>
        <div class="entry-actions">
          <button class="btn btn-sm ${entry.paid ? 'btn-secondary' : 'btn-success'}" 
                  onclick="togglePaid('${entry.key}')">
            ${entry.paid ? 'Mark Unpaid' : 'Mark Paid'}
          </button>
          <button class="btn btn-sm btn-danger" onclick="removeEntry('${entry.key}')">
            üóëÔ∏è
          </button>
        </div>
      </div>
    `).join('');
  }

  window.filterEntries = function() {
    renderEntriesList();
  };

  window.togglePaid = async function(key) {
    if (!currentPool || !isAdmin) return;
    
    const entry = currentPool.entries[key];
    if (!entry) return;
    
    try {
      await updateDoc(doc(db, 'boxesPools', currentPool.id), {
        [`entries.${key}.paid`]: !entry.paid
      });
      
      currentPool.entries[key].paid = !entry.paid;
      renderEntriesList();
      showToast('Entry updated', 'success');
      
    } catch (error) {
      console.error('Error updating entry:', error);
      showToast('Error updating entry', 'error');
    }
  };

  window.removeEntry = async function(key) {
    if (!currentPool || !isAdmin) return;
    if (!confirm(`Remove entry at ${key}?`)) return;
    
    try {
      // Need to delete the specific field
      const poolRef = doc(db, 'boxesPools', currentPool.id);
      const poolDoc = await getDoc(poolRef);
      const entries = poolDoc.data().entries || {};
      delete entries[key];
      
      await updateDoc(poolRef, { entries });
      
      delete currentPool.entries[key];
      renderGrid();
      updateStats();
      renderEntriesList();
      
      showToast('Entry removed', 'success');
      
    } catch (error) {
      console.error('Error removing entry:', error);
      showToast('Error removing entry', 'error');
    }
  };

  window.removeAllUnpaid = async function() {
    if (!currentPool || !isAdmin) return;
    if (!confirm('Remove ALL unpaid entries?')) return;
    
    try {
      const poolRef = doc(db, 'boxesPools', currentPool.id);
      const poolDoc = await getDoc(poolRef);
      const entries = poolDoc.data().entries || {};
      
      const paidEntries = {};
      Object.entries(entries).forEach(([key, entry]) => {
        if (entry.paid) {
          paidEntries[key] = entry;
        }
      });
      
      await updateDoc(poolRef, { entries: paidEntries });
      
      currentPool.entries = paidEntries;
      renderGrid();
      updateStats();
      renderEntriesList();
      
      showToast('Unpaid entries removed', 'success');
      
    } catch (error) {
      console.error('Error removing unpaid:', error);
      showToast('Error removing entries', 'error');
    }
  };

  // ========================================
  // MANUAL ENTRY
  // ========================================

  // Track current link type for manual entry
  let currentLinkType = 'search';
  let allUsers = []; // Cache of users for search
  
  window.setLinkType = function(type) {
    currentLinkType = type;
    
    // Update tab styling
    document.querySelectorAll('.link-type-tab').forEach(tab => {
      tab.classList.toggle('active', tab.dataset.type === type);
    });
    
    // Show/hide sections
    document.getElementById('linkTypeSearch').style.display = type === 'search' ? 'block' : 'none';
    document.getElementById('linkTypeEmail').style.display = type === 'email' ? 'block' : 'none';
    document.getElementById('linkTypeName').style.display = type === 'name' ? 'block' : 'none';
    
    // Clear selections
    clearUserSelection();
  };
  
  function clearUserSelection() {
    document.getElementById('selectedUserId').value = '';
    document.getElementById('selectedUserName').value = '';
    document.getElementById('selectedUserEmail').value = '';
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').innerHTML = '';
    document.getElementById('userSearchResults').classList.remove('visible');
  }
  
  // Load all users for search (called once when admin panel opens)
  async function loadUsersForSearch() {
    if (allUsers.length > 0) return; // Already loaded
    
    try {
      const usersSnapshot = await getDocs(collection(db, 'users'));
      allUsers = [];
      usersSnapshot.forEach(doc => {
        const data = doc.data();
        
        // Skip migrated/legacy accounts
        if (data.migrated === true) return;
        if (data.isLegacyProfile === true) return;
        
        // Skip accounts without email (likely legacy profiles)
        if (!data.email) return;
        
        allUsers.push({
          id: doc.id,
          name: data.displayName || data.name || 'Unknown',
          email: data.email || ''
        });
      });
      // Sort alphabetically
      allUsers.sort((a, b) => a.name.localeCompare(b.name));
    } catch (error) {
      console.error('Error loading users:', error);
    }
  }
  
  window.searchUsers = function() {
    const query = document.getElementById('userSearchInput').value.toLowerCase().trim();
    const resultsContainer = document.getElementById('userSearchResults');
    
    if (query.length < 2) {
      resultsContainer.classList.remove('visible');
      return;
    }
    
    const matches = allUsers.filter(u => 
      u.name.toLowerCase().includes(query) || 
      u.email.toLowerCase().includes(query)
    ).slice(0, 10); // Limit to 10 results
    
    if (matches.length === 0) {
      resultsContainer.innerHTML = '<div style="padding: 1rem; color: var(--text-light); text-align: center;">No users found</div>';
    } else {
      resultsContainer.innerHTML = matches.map(u => `
        <div class="user-search-result" onclick="selectUser('${u.id}', '${u.name.replace(/'/g, "\\'")}', '${u.email.replace(/'/g, "\\'")}')">
          <div>
            <div class="user-name">${u.name}</div>
            <div class="user-email">${u.email}</div>
          </div>
        </div>
      `).join('');
    }
    
    resultsContainer.classList.add('visible');
  };
  
  window.selectUser = function(userId, name, email) {
    document.getElementById('selectedUserId').value = userId;
    document.getElementById('selectedUserName').value = name;
    document.getElementById('selectedUserEmail').value = email;
    
    // Show selection and hide search results
    document.getElementById('userSearchInput').value = '';
    document.getElementById('userSearchResults').innerHTML = `
      <div class="selected-user-badge">
        <span>‚úÖ <strong>${name}</strong> (${email})</span>
        <button class="remove-btn" onclick="clearUserSelection()">‚úï</button>
      </div>
    `;
  };

  window.addManualEntry = async function() {
    if (!currentPool || !isAdmin) return;
    
    let name = '';
    let userId = null;
    let email = null;
    let pendingEmail = null;
    
    // Get data based on link type
    if (currentLinkType === 'search') {
      userId = document.getElementById('selectedUserId').value;
      name = document.getElementById('selectedUserName').value;
      email = document.getElementById('selectedUserEmail').value;
      
      if (!userId) {
        showToast('Please select a user from the search', 'warning');
        return;
      }
    } else if (currentLinkType === 'email') {
      pendingEmail = document.getElementById('manualEmail').value.trim().toLowerCase();
      name = document.getElementById('manualNameEmail').value.trim();
      
      if (!pendingEmail || !pendingEmail.includes('@')) {
        showToast('Please enter a valid email address', 'warning');
        return;
      }
      if (!name) {
        showToast('Please enter a display name', 'warning');
        return;
      }
    } else {
      // Name only
      name = document.getElementById('manualName').value.trim();
      if (!name) {
        showToast('Please enter a name', 'warning');
        return;
      }
    }
    
    const paid = document.getElementById('manualPaid').value === 'true';
    const coordsStr = document.getElementById('manualCoords').value.trim();
    
    if (!coordsStr) {
      showToast('Please select at least one box', 'warning');
      return;
    }
    
    // Parse coordinates
    const coords = coordsStr.split(',').map(c => c.trim()).filter(c => c);
    const validCoords = [];
    
    for (const coord of coords) {
      const match = coord.match(/^(\d+)-(\d+)$/);
      if (!match) {
        showToast(`Invalid coordinate: ${coord}`, 'warning');
        return;
      }
      const row = parseInt(match[1]);
      const col = parseInt(match[2]);
      if (row < 0 || row > 9 || col < 0 || col > 9) {
        showToast(`Coordinate out of range: ${coord}`, 'warning');
        return;
      }
      if (currentPool.entries && currentPool.entries[coord]) {
        showToast(`Box ${coord} is already taken`, 'warning');
        return;
      }
      validCoords.push(coord);
    }
    
    try {
      const updates = {};
      validCoords.forEach(key => {
        const entryData = {
          name: name,
          manual: true,
          paid: paid,
          claimedAt: serverTimestamp(),
          addedBy: currentUser.uid
        };
        
        // Add linking info based on type
        if (userId) {
          entryData.userId = userId;
          entryData.email = email;
        } else if (pendingEmail) {
          entryData.userId = null;
          entryData.pendingEmail = pendingEmail;
        } else {
          entryData.userId = null;
        }
        
        updates[`entries.${key}`] = entryData;
      });
      
      await updateDoc(doc(db, 'boxesPools', currentPool.id), updates);
      
      // Update local state
      if (!currentPool.entries) currentPool.entries = {};
      validCoords.forEach(key => {
        currentPool.entries[key] = { 
          name, 
          paid, 
          manual: true,
          userId: userId || null,
          pendingEmail: pendingEmail || null
        };
      });
      
      // Clear form
      document.getElementById('manualCoords').value = '';
      if (currentLinkType === 'search') {
        clearUserSelection();
      } else if (currentLinkType === 'email') {
        document.getElementById('manualEmail').value = '';
        document.getElementById('manualNameEmail').value = '';
      } else {
        document.getElementById('manualName').value = '';
      }
      
      renderGrid();
      updateStats();
      renderEntriesList();
      
      const linkInfo = userId ? ' (linked to user)' : pendingEmail ? ' (will link when they sign up)' : '';
      showToast(`Added ${validCoords.length} box(es) for ${name}${linkInfo}`, 'success');
      
    } catch (error) {
      console.error('Error adding manual entry:', error);
      showToast('Error adding entry', 'error');
    }
  };

  // ========================================
  // CREATE POOL
  // ========================================

  window.showCreatePoolModal = function() {
    document.getElementById('createPoolModal').classList.add('visible');
  };

  window.hideCreatePoolModal = function() {
    document.getElementById('createPoolModal').classList.remove('visible');
  };

  window.createPool = async function() {
    const name = document.getElementById('newPoolName').value.trim();
    const costPerBox = parseFloat(document.getElementById('newCostPerBox').value) || 0;
    const description = document.getElementById('newDescription').value.trim();
    
    if (!name) {
      showToast('Please enter a pool name', 'warning');
      return;
    }
    
    try {
      const docRef = await addDoc(collection(db, 'boxesPools'), {
        name,
        costPerBox,
        description,
        games: [],  // Games added separately after creation
        entries: {},
        locked: false,
        createdBy: currentUser.uid,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      
      hideCreatePoolModal();
      
      // Clear form
      document.getElementById('newPoolName').value = '';
      document.getElementById('newDescription').value = '';
      
      // Reload pools and select the new one
      await loadPoolsList();
      document.getElementById('poolSelect').value = docRef.id;
      await loadPool();
      
      showToast('Pool created! Now add games in the Games tab.', 'success');
      
    } catch (error) {
      console.error('Error creating pool:', error);
      showToast('Error creating pool', 'error');
    }
  };

  // ========================================
  // UTILITY FUNCTIONS
  // ========================================

  function showToast(message, type = 'info') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
</script>

</body>
</html>
