<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Game Tracker Review - Mountainside Aces Admin</title>
<meta name="theme-color" content="#6b21a8">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --admin-color: #6b21a8;
    --admin-secondary: #7c3aed;
    --tracker-color: #0891b2;
    --tracker-secondary: #06b6d4;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    color: var(--text-dark);
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: 'üìä';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  .loading-text {
    margin-top: 1rem;
    font-size: 1.125rem;
    color: var(--text-dark);
    font-weight: 600;
  }

  @keyframes spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }

  /* Auth Gate */
  .auth-gate {
    display: none;
    max-width: 500px;
    margin: 4rem auto;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .auth-gate h2 {
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .auth-gate p {
    color: var(--text-light);
    margin-bottom: 2rem;
  }

  .auth-gate a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--admin-color);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--tracker-color) 0%, var(--tracker-secondary) 100%);
    color: white;
    padding: 2rem 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .header::after {
    content: 'üéØ';
    position: absolute;
    bottom: -40px;
    left: -30px;
    font-size: 180px;
    opacity: 0.08;
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header h1 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .admin-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  .header-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .nav-btn {
    padding: 0.75rem 1.25rem;
    border: 2px solid white;
    background: white;
    color: var(--tracker-color);
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .nav-btn:hover {
    background: var(--accent-color);
    transform: translateY(-2px);
  }

  /* Main Content */
  .main-content {
    display: none;
  }

  .main-content.visible {
    display: block;
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
  }

  /* Info Boxes */
  .info-box, .warning-box, .error-box, .success-box {
    padding: 1rem 1.25rem;
    border-radius: 10px;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .info-box {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    border: 2px solid var(--info-color);
  }

  .warning-box {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    border: 2px solid var(--warning-color);
  }

  .error-box {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border: 2px solid var(--danger-color);
  }

  .success-box {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    border: 2px solid var(--success-color);
  }

  .hidden { display: none !important; }

  /* Section Cards */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
    overflow: hidden;
    border: 1px solid var(--border-color);
  }

  .section-header {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 1.25rem 1.5rem;
    font-size: 1.15rem;
    font-weight: 700;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .section-body {
    padding: 1.5rem;
  }

  /* Game Cards */
  .game-list {
    display: grid;
    gap: 1rem;
  }

  .game-card {
    background: var(--card-bg);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .game-card:hover {
    border-color: var(--tracker-color);
    box-shadow: var(--shadow-md);
  }

  .game-card.selected {
    border-color: var(--tracker-color);
    background: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%);
  }

  .game-card.converted {
    opacity: 0.6;
    border-color: var(--success-color);
    background: #f0fdf4;
  }

  .game-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
  }

  .game-card-teams {
    font-size: 1.1rem;
    font-weight: 700;
  }

  .game-card-score {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--tracker-color);
  }

  .game-card-meta {
    display: flex;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-light);
  }

  .game-card-status {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .status-pending {
    background: #fef3c7;
    color: #92400e;
  }

  .status-converted {
    background: #dcfce7;
    color: #166534;
  }

  /* Review Panel */
  .review-panel {
    display: none;
  }

  .review-panel.visible {
    display: block;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .review-title {
    font-size: 1.5rem;
    font-weight: 800;
  }

  .review-actions {
    display: flex;
    gap: 0.75rem;
  }

  /* Stats Table */
  .stats-table-container {
    overflow-x: auto;
    margin-bottom: 1.5rem;
  }

  .stats-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  .stats-table th,
  .stats-table td {
    padding: 0.75rem 1rem;
    text-align: center;
    border-bottom: 1px solid var(--border-color);
  }

  .stats-table th {
    background: #f8fafc;
    font-weight: 600;
    color: var(--text-light);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stats-table th:first-child,
  .stats-table td:first-child {
    text-align: left;
    font-weight: 600;
  }

  .stats-table tr:hover {
    background: #f8fafc;
  }

  .stats-table .player-name {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .stats-table .player-warning {
    color: var(--warning-color);
    font-size: 1rem;
  }

  .stats-table .player-matched {
    color: var(--success-color);
    font-size: 0.8rem;
  }

  /* Play by Play */
  .play-by-play {
    max-height: 400px;
    overflow-y: auto;
    background: #f8fafc;
    border-radius: 8px;
    padding: 1rem;
  }

  .play-item {
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-color);
    font-size: 0.9rem;
  }

  .play-item:last-child {
    border-bottom: none;
  }

  .play-inning {
    font-weight: 600;
    color: var(--tracker-color);
  }

  .play-result {
    color: var(--text-dark);
  }

  /* Buttons */
  .btn {
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.95rem;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--tracker-color);
    color: white;
  }

  .btn-primary:hover {
    background: var(--tracker-secondary);
    transform: translateY(-2px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #16a34a;
    transform: translateY(-2px);
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-danger:hover {
    background: #dc2626;
  }

  .btn-secondary {
    background: #e2e8f0;
    color: var(--text-dark);
  }

  .btn-secondary:hover {
    background: #cbd5e1;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-light);
  }

  .empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    color: var(--text-dark);
    margin-bottom: 0.5rem;
  }

  /* Player Matching */
  .match-status {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 4px;
    margin-left: 0.5rem;
  }

  .match-found {
    background: #dcfce7;
    color: #166534;
  }

  .match-missing {
    background: #fef3c7;
    color: #92400e;
  }

  /* Toast */
  .toast-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    padding: 1rem 1.5rem;
    border-radius: 10px;
    color: white;
    font-weight: 600;
    box-shadow: var(--shadow-lg);
    animation: slideIn 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toast-success { background: var(--success-color); }
  .toast-error { background: var(--danger-color); }
  .toast-warning { background: var(--warning-color); }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      text-align: center;
    }
    
    .header-buttons {
      justify-content: center;
    }
    
    .review-header {
      flex-direction: column;
      text-align: center;
    }
    
    .stats-table {
      font-size: 0.8rem;
    }
    
    .stats-table th,
    .stats-table td {
      padding: 0.5rem;
    }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
  <div class="loading-text">Loading Game Tracker Data...</div>
</div>

<!-- Auth Gate -->
<div class="auth-gate" id="authGate">
  <h2>üîí Admin Access Required</h2>
  <p>You must be signed in as an administrator to access this page.</p>
  <a href="signin.html">Sign In</a>
  <a href="index.html" style="background: var(--text-light);">Back to Home</a>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Main Content -->
<div class="main-content" id="mainContent">
  <nav-component></nav-component>
  
  <header class="header">
    <div class="header-content">
      <div>
        <h1>üéØ Game Tracker Review</h1>
        <p>Convert tracked game stats to official records</p>
        <span class="admin-badge">Admin Tool</span>
      </div>
      <div class="header-buttons">
        <a href="aggregate-stats.html" class="nav-btn">üìä Aggregator</a>
        <a href="submit-stats.html" class="nav-btn">üìù Submit Stats</a>
        <a href="index.html" class="nav-btn">üè† Home</a>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Info Messages -->
    <div class="info-box" id="infoMessage">
      <span>‚ÑπÔ∏è</span>
      <span id="infoMessageText">Select a game from the list to review and convert its tracked stats.</span>
    </div>
    <div class="warning-box hidden" id="warningMessage">
      <span>‚ö†Ô∏è</span>
      <span id="warningMessageText"></span>
    </div>
    <div class="error-box hidden" id="errorMessage">
      <span>‚ùå</span>
      <span id="errorMessageText"></span>
    </div>
    <div class="success-box hidden" id="successMessage">
      <span>‚úÖ</span>
      <span id="successMessageText"></span>
    </div>

    <!-- Filter Section -->
    <div class="section">
      <div class="section-header">
        <span>üîç</span> Filter Games
      </div>
      <div class="section-body">
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Season</label>
            <select id="seasonFilter" style="padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; min-width: 200px;">
              <option value="">Loading...</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Team</label>
            <select id="teamFilter" style="padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; min-width: 200px;">
              <option value="">All Teams</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">Status</label>
            <select id="statusFilter" style="padding: 0.75rem 1rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.95rem; min-width: 150px;">
              <option value="pending">Pending Review</option>
              <option value="converted">Already Converted</option>
              <option value="all">All</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="loadGameResults()">
            üîÑ Refresh
          </button>
        </div>
      </div>
    </div>

    <!-- Game List Section -->
    <div class="section">
      <div class="section-header">
        <span>üìã</span> Tracked Games
        <span id="gameCount" style="margin-left: auto; font-size: 0.9rem; color: var(--text-light);"></span>
      </div>
      <div class="section-body">
        <div class="game-list" id="gameList">
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <h3>No Games Found</h3>
            <p>No tracked games match your filters.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Review Panel -->
    <div class="review-panel" id="reviewPanel">
      <div class="section">
        <div class="section-header">
          <span>üìä</span> Review Stats
        </div>
        <div class="section-body">
          <div class="review-header">
            <div>
              <div class="review-title" id="reviewTitle">Game Details</div>
              <div style="color: var(--text-light); margin-top: 0.25rem;" id="reviewMeta"></div>
            </div>
            <div class="review-actions">
              <button class="btn btn-secondary" onclick="closeReview()">‚úï Close</button>
              <button class="btn btn-success" id="convertBtn" onclick="convertToOfficial()">
                ‚úÖ Convert to Official Stats
              </button>
            </div>
          </div>

          <!-- Batting Stats Table -->
          <h4 style="margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span>‚öæ</span> Batting Stats
            <span id="playerMatchSummary" style="font-size: 0.85rem; font-weight: 400; color: var(--text-light);"></span>
          </h4>
          <div class="stats-table-container">
            <table class="stats-table" id="battingStatsTable">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>AB</th>
                  <th>H</th>
                  <th>R</th>
                  <th>BB</th>
                  <th>1B</th>
                  <th>2B</th>
                  <th>3B</th>
                  <th>HR</th>
                  <th>RBI</th>
                  <th>AVG</th>
                  <th>OBP</th>
                </tr>
              </thead>
              <tbody id="battingStatsBody">
              </tbody>
            </table>
          </div>

          <!-- Play by Play -->
          <h4 style="margin: 1.5rem 0 1rem; display: flex; align-items: center; gap: 0.5rem;">
            <span>üìú</span> Play-by-Play Log
          </h4>
          <div class="play-by-play" id="playByPlay">
            <div class="empty-state" style="padding: 2rem;">
              <p>No plays recorded</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script type="module">
import { db } from './firebase-data.js';
import { getCurrentUser, onAuthChange, getUserProfile } from './firebase-auth.js';
import { getCurrentSeason, getAllTeams, getSeasonPlayerStatsOptimized } from './firebase-data.js';
import { 
  collection, 
  getDocs, 
  getDoc,
  doc, 
  setDoc,
  updateDoc,
  query, 
  where, 
  orderBy,
  serverTimestamp 
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

// Make Firebase available globally
window.db = db;
window.collection = collection;
window.getDocs = getDocs;
window.getDoc = getDoc;
window.doc = doc;
window.setDoc = setDoc;
window.updateDoc = updateDoc;
window.query = query;
window.where = where;
window.orderBy = orderBy;
window.serverTimestamp = serverTimestamp;

let currentUser = null;
let userProfile = null;
let currentSeason = null;
let allTeams = [];
let gameResults = [];
let selectedGame = null;
let rosterPlayers = [];

// ============================================
// INITIALIZATION
// ============================================

async function initializePage(user) {
  if (!user) {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('authGate').style.display = 'block';
    return;
  }

  console.log('üöÄ Initializing game tracker review for:', user.displayName);

  try {
    currentUser = user;
    
    const profileResult = await getUserProfile(user.uid);
    if (!profileResult.success) {
      throw new Error('Could not load user profile');
    }
    
    userProfile = profileResult.data;
    
    // Check admin access
    const isAdmin = userProfile.isAdmin || 
                    userProfile.userRole === 'admin' || 
                    userProfile.userType === 'league-staff' ||
                    userProfile.userRole === 'staff';
    
    if (!isAdmin) {
      document.getElementById('loadingOverlay').classList.add('hidden');
      document.getElementById('authGate').style.display = 'block';
      return;
    }

    // Load current season
    currentSeason = await getCurrentSeason();
    if (!currentSeason) {
      throw new Error('No active season found');
    }

    // Populate season filter
    const seasonFilter = document.getElementById('seasonFilter');
    seasonFilter.innerHTML = `<option value="${currentSeason.id}">${currentSeason.id}</option>`;
    
    // TODO: Could add past seasons here if needed

    // Load teams
    allTeams = await getAllTeams();
    const teamFilter = document.getElementById('teamFilter');
    teamFilter.innerHTML = '<option value="">All Teams</option>';
    allTeams.forEach(team => {
      const option = document.createElement('option');
      option.value = team.id;
      option.textContent = team.name;
      teamFilter.appendChild(option);
    });

    // Show main content
    document.getElementById('mainContent').classList.add('visible');
    document.getElementById('loadingOverlay').classList.add('hidden');

    // Load game results
    await loadGameResults();

    // Set up filter listeners
    document.getElementById('seasonFilter').addEventListener('change', loadGameResults);
    document.getElementById('teamFilter').addEventListener('change', filterGames);
    document.getElementById('statusFilter').addEventListener('change', filterGames);

  } catch (error) {
    console.error('‚ùå Error initializing page:', error);
    showMessage('error', `Error loading page: ${error.message}`);
    document.getElementById('loadingOverlay').classList.add('hidden');
  }
}

// ============================================
// LOAD GAME RESULTS
// ============================================

window.loadGameResults = async function() {
  showMessage('info', 'Loading tracked games...');
  
  try {
    const seasonId = document.getElementById('seasonFilter').value;
    
    // Query gameResults collection
    const resultsRef = collection(db, 'gameResults');
    const snapshot = await getDocs(resultsRef);
    
    gameResults = [];
    
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      // Filter by season if specified
      if (!seasonId || data.seasonId === seasonId) {
        gameResults.push({
          id: docSnap.id,
          ...data
        });
      }
    });

    // Sort by completedAt (newest first)
    gameResults.sort((a, b) => {
      const aTime = a.completedAt?.toMillis?.() || 0;
      const bTime = b.completedAt?.toMillis?.() || 0;
      return bTime - aTime;
    });

    console.log(`üìä Loaded ${gameResults.length} game results`);
    
    filterGames();
    
  } catch (error) {
    console.error('‚ùå Error loading game results:', error);
    showMessage('error', `Error loading games: ${error.message}`);
  }
};

function filterGames() {
  const teamFilter = document.getElementById('teamFilter').value;
  const statusFilter = document.getElementById('statusFilter').value;
  
  let filtered = gameResults;
  
  // Filter by team
  if (teamFilter) {
    filtered = filtered.filter(g => g.teamId === teamFilter);
  }
  
  // Filter by status
  if (statusFilter === 'pending') {
    filtered = filtered.filter(g => !g.convertedToOfficial);
  } else if (statusFilter === 'converted') {
    filtered = filtered.filter(g => g.convertedToOfficial);
  }
  
  renderGameList(filtered);
}

function renderGameList(games) {
  const container = document.getElementById('gameList');
  const countEl = document.getElementById('gameCount');
  
  countEl.textContent = `${games.length} game${games.length !== 1 ? 's' : ''}`;
  
  if (games.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <h3>No Games Found</h3>
        <p>No tracked games match your filters.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = games.map(game => {
    const isConverted = game.convertedToOfficial;
    const completedDate = game.completedAt?.toDate?.() 
      ? game.completedAt.toDate().toLocaleDateString('en-US', { 
          month: 'short', day: 'numeric', year: 'numeric',
          hour: 'numeric', minute: '2-digit'
        })
      : 'Unknown';
    
    const playerCount = game.battingStats?.length || 0;
    const playCount = game.playByPlay?.length || 0;
    
    return `
      <div class="game-card ${isConverted ? 'converted' : ''}" 
           onclick="selectGame('${game.id}')"
           data-game-id="${game.id}">
        <div class="game-card-header">
          <div class="game-card-teams">
            ${game.teamId} vs ${game.opponentName || 'Unknown'}
          </div>
          <div class="game-card-score">
            ${game.finalScore?.yourTeam || 0} - ${game.finalScore?.opponent || 0}
          </div>
        </div>
        <div class="game-card-meta">
          <span>üìÖ ${completedDate}</span>
          <span>üë• ${playerCount} players</span>
          <span>üìú ${playCount} plays</span>
          <span class="game-card-status ${isConverted ? 'status-converted' : 'status-pending'}">
            ${isConverted ? '‚úì Converted' : '‚è≥ Pending'}
          </span>
        </div>
      </div>
    `;
  }).join('');
}

// ============================================
// SELECT & REVIEW GAME
// ============================================

window.selectGame = async function(gameId) {
  selectedGame = gameResults.find(g => g.id === gameId);
  if (!selectedGame) return;
  
  // Highlight selected card
  document.querySelectorAll('.game-card').forEach(card => {
    card.classList.toggle('selected', card.dataset.gameId === gameId);
  });
  
  // Load roster for player matching
  showMessage('info', 'Loading roster for player matching...');
  
  try {
    const seasonId = selectedGame.seasonId;
    const seasonPlayers = await getSeasonPlayerStatsOptimized(seasonId);
    
    // Filter to team players
    const teamIdLower = selectedGame.teamId.toLowerCase();
    rosterPlayers = seasonPlayers.filter(p => {
      return (p.team || '').toLowerCase() === teamIdLower && !p.migrated;
    });
    
    console.log(`üìã Loaded ${rosterPlayers.length} roster players for ${selectedGame.teamId}`);
    
    renderReviewPanel();
    
  } catch (error) {
    console.error('Error loading roster:', error);
    showMessage('warning', 'Could not load roster for player matching. Conversion may require manual review.');
    renderReviewPanel();
  }
};

function renderReviewPanel() {
  const panel = document.getElementById('reviewPanel');
  panel.classList.add('visible');
  
  // Update header
  document.getElementById('reviewTitle').textContent = 
    `${selectedGame.teamId} vs ${selectedGame.opponentName || 'Unknown'}`;
  
  const completedDate = selectedGame.completedAt?.toDate?.()
    ? selectedGame.completedAt.toDate().toLocaleDateString('en-US', {
        weekday: 'long', month: 'long', day: 'numeric', year: 'numeric'
      })
    : 'Unknown date';
  
  document.getElementById('reviewMeta').innerHTML = `
    ${completedDate} ‚Ä¢ 
    Final: <strong>${selectedGame.finalScore?.yourTeam || 0} - ${selectedGame.finalScore?.opponent || 0}</strong> ‚Ä¢ 
    ${selectedGame.innings || '?'} innings ‚Ä¢ 
    Season: ${selectedGame.seasonId}
  `;
  
  // Update convert button state
  const convertBtn = document.getElementById('convertBtn');
  if (selectedGame.convertedToOfficial) {
    convertBtn.disabled = true;
    convertBtn.innerHTML = '‚úì Already Converted';
  } else {
    convertBtn.disabled = false;
    convertBtn.innerHTML = '‚úÖ Convert to Official Stats';
  }
  
  // Render batting stats with player matching
  renderBattingStats();
  
  // Render play-by-play
  renderPlayByPlay();
  
  // Scroll to review panel
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderBattingStats() {
  const tbody = document.getElementById('battingStatsBody');
  const stats = selectedGame.battingStats || [];
  
  let matchedCount = 0;
  let unmatchedCount = 0;
  
  tbody.innerHTML = stats.map(player => {
    // Try to match player to roster
    const match = findPlayerMatch(player.name || player.playerName);
    
    if (match) {
      matchedCount++;
    } else {
      unmatchedCount++;
    }
    
    const matchBadge = match 
      ? `<span class="match-status match-found">‚úì ${match.legacyId}</span>`
      : `<span class="match-status match-missing">‚ö† No match</span>`;
    
    return `
      <tr>
        <td>
          <div class="player-name">
            ${player.name || player.playerName || 'Unknown'}
            ${matchBadge}
          </div>
        </td>
        <td>${player.atBats || 0}</td>
        <td>${player.hits || 0}</td>
        <td>${player.runs || 0}</td>
        <td>${player.walks || 0}</td>
        <td>${player.singles || 0}</td>
        <td>${player.doubles || 0}</td>
        <td>${player.triples || 0}</td>
        <td>${player.homeRuns || 0}</td>
        <td>${player.rbi || 0}</td>
        <td>${(player.battingAverage || 0).toFixed(3)}</td>
        <td>${(player.onBasePercentage || 0).toFixed(3)}</td>
      </tr>
    `;
  }).join('');
  
  // Update summary
  document.getElementById('playerMatchSummary').textContent = 
    `(${matchedCount} matched, ${unmatchedCount} unmatched)`;
}

function findPlayerMatch(playerName) {
  if (!playerName) return null;
  
  const nameLower = playerName.toLowerCase().trim();
  
  // Try exact match first
  let match = rosterPlayers.find(p => {
    const rosterName = (p.name || p.playerName || '').toLowerCase().trim();
    return rosterName === nameLower;
  });
  
  if (match) {
    return {
      ...match,
      legacyId: (match.name || match.playerName || '').toLowerCase().replace(/\./g, '').replace(/\s+/g, '_')
    };
  }
  
  // Try partial match (first + last name)
  const nameParts = nameLower.split(' ');
  if (nameParts.length >= 2) {
    match = rosterPlayers.find(p => {
      const rosterName = (p.name || p.playerName || '').toLowerCase().trim();
      return rosterName.includes(nameParts[0]) && rosterName.includes(nameParts[nameParts.length - 1]);
    });
    
    if (match) {
      return {
        ...match,
        legacyId: (match.name || match.playerName || '').toLowerCase().replace(/\./g, '').replace(/\s+/g, '_')
      };
    }
  }
  
  return null;
}

function renderPlayByPlay() {
  const container = document.getElementById('playByPlay');
  const plays = selectedGame.playByPlay || [];
  
  if (plays.length === 0) {
    container.innerHTML = `
      <div class="empty-state" style="padding: 2rem;">
        <p>No plays recorded</p>
      </div>
    `;
    return;
  }
  
  // Group by inning
  const byInning = {};
  plays.forEach(play => {
    const inning = play.inning || 1;
    if (!byInning[inning]) byInning[inning] = [];
    byInning[inning].push(play);
  });
  
  container.innerHTML = Object.entries(byInning).map(([inning, inningPlays]) => `
    <div style="margin-bottom: 1rem;">
      <div class="play-inning">Inning ${inning}</div>
      ${inningPlays.map(play => `
        <div class="play-item">
          <span class="play-result">
            ${play.batter || 'Unknown'}: 
            <strong>${formatPlayResult(play.result)}</strong>
            ${play.runsScored ? ` (${play.runsScored} run${play.runsScored > 1 ? 's' : ''})` : ''}
          </span>
        </div>
      `).join('')}
    </div>
  `).join('');
}

function formatPlayResult(result) {
  const resultMap = {
    'single': 'Single',
    'double': 'Double',
    'triple': 'Triple',
    'homerun': 'Home Run',
    'walk': 'Walk',
    'out': 'Out',
    'strikeout': 'Strikeout',
    'flyout': 'Fly Out',
    'groundout': 'Ground Out',
    'error': 'Reached on Error',
    'fielders_choice': "Fielder's Choice",
    'sacrifice': 'Sacrifice'
  };
  return resultMap[result] || result || 'Unknown';
}

window.closeReview = function() {
  document.getElementById('reviewPanel').classList.remove('visible');
  selectedGame = null;
  document.querySelectorAll('.game-card').forEach(card => {
    card.classList.remove('selected');
  });
};

// ============================================
// CONVERT TO OFFICIAL STATS
// ============================================

window.convertToOfficial = async function() {
  if (!selectedGame) return;
  
  if (selectedGame.convertedToOfficial) {
    showMessage('warning', 'This game has already been converted.');
    return;
  }
  
  const stats = selectedGame.battingStats || [];
  if (stats.length === 0) {
    showMessage('error', 'No batting stats to convert.');
    return;
  }
  
  // Check for unmatched players
  const unmatched = stats.filter(p => !findPlayerMatch(p.name || p.playerName));
  
  if (unmatched.length > 0) {
    const names = unmatched.map(p => p.name || p.playerName).join(', ');
    const proceed = confirm(
      `Warning: ${unmatched.length} player(s) could not be matched to the roster:\n\n${names}\n\n` +
      `These players will be skipped during conversion.\n\nContinue anyway?`
    );
    if (!proceed) return;
  }
  
  const convertBtn = document.getElementById('convertBtn');
  convertBtn.disabled = true;
  convertBtn.innerHTML = '‚è≥ Converting...';
  
  try {
    const seasonId = selectedGame.seasonId;
    const gameId = selectedGame.gameId;
    const gameDocId = `${seasonId}_${gameId}`;
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const player of stats) {
      const match = findPlayerMatch(player.name || player.playerName);
      if (!match) {
        console.warn(`‚ö†Ô∏è Skipping unmatched player: ${player.name || player.playerName}`);
        continue;
      }
      
      try {
        const legacyId = match.legacyId;
        const battingRef = doc(db, 'playerStats', legacyId, 'games', gameDocId);
        
        await setDoc(battingRef, {
          // Identification
          gameId: gameId,
          gameDocId: gameDocId,
          playerId: legacyId,
          playerName: match.name || match.playerName,
          seasonId: seasonId,
          teamId: selectedGame.teamId,
          
          // Game Context
          gameDateFormatted: selectedGame.completedAt?.toDate?.()?.toLocaleDateString() || '',
          opponent: selectedGame.opponentName || 'Unknown',
          isHome: selectedGame.isHome || false,
          gameType: 'Regular',
          isPlayoff: false,
          
          // Batting Statistics
          atBats: player.atBats || 0,
          hits: player.hits || 0,
          runs: player.runs || 0,
          walks: player.walks || 0,
          doubles: player.doubles || 0,
          triples: player.triples || 0,
          homeRuns: player.homeRuns || 0,
          rbi: player.rbi || 0,
          strikeouts: 0, // Not tracked in current GameTracker
          stolenBases: 0,
          caughtStealing: 0,
          
          // Metadata
          submittedBy: currentUser.uid,
          submittedByName: currentUser.displayName || currentUser.email,
          submittedAt: serverTimestamp(),
          lastModified: serverTimestamp(),
          dataVersion: 1,
          sourceType: 'gameTracker',
          sourceDocId: selectedGame.id
        }, { merge: true });
        
        successCount++;
        console.log(`‚úÖ Saved stats for ${match.name || match.playerName}`);
        
      } catch (error) {
        console.error(`‚ùå Error saving stats for ${player.name}:`, error);
        errorCount++;
      }
    }
    
    // Mark gameResults as converted
    const gameResultRef = doc(db, 'gameResults', selectedGame.id);
    await updateDoc(gameResultRef, {
      convertedToOfficial: true,
      convertedAt: serverTimestamp(),
      convertedBy: currentUser.uid,
      convertedByName: currentUser.displayName || currentUser.email,
      conversionStats: {
        playersConverted: successCount,
        playersSkipped: stats.length - successCount - errorCount,
        errors: errorCount
      }
    });
    
    // Update local state
    selectedGame.convertedToOfficial = true;
    
    showMessage('success', `Successfully converted ${successCount} player stats to official records!`);
    showToast(`Converted ${successCount} player stats`, 'success');
    
    // Refresh UI
    renderReviewPanel();
    filterGames();
    
  } catch (error) {
    console.error('‚ùå Error during conversion:', error);
    showMessage('error', `Error during conversion: ${error.message}`);
    showToast('Conversion failed', 'error');
  } finally {
    convertBtn.disabled = false;
    convertBtn.innerHTML = '‚úÖ Convert to Official Stats';
  }
};

// ============================================
// UTILITY FUNCTIONS
// ============================================

function showMessage(type, text) {
  ['infoMessage', 'warningMessage', 'errorMessage', 'successMessage'].forEach(id => {
    document.getElementById(id).classList.add('hidden');
  });

  const messageMap = {
    'info': { box: 'infoMessage', text: 'infoMessageText' },
    'warning': { box: 'warningMessage', text: 'warningMessageText' },
    'error': { box: 'errorMessage', text: 'errorMessageText' },
    'success': { box: 'successMessage', text: 'successMessageText' }
  };

  if (messageMap[type]) {
    document.getElementById(messageMap[type].text).textContent = text;
    document.getElementById(messageMap[type].box).classList.remove('hidden');
  }
}

function showToast(message, type = 'success') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†';
  toast.innerHTML = `<span>${icon}</span> ${message}`;
  
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// ============================================
// AUTH INIT
// ============================================

onAuthChange((user) => {
  if (user) {
    initializePage(user);
  } else {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('authGate').style.display = 'block';
  }
});
</script>

<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="mobile-enhancements.js"></script>
</body>
</html>
