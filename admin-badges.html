<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Badge Calculator - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --admin-color: #6b21a8;
    --admin-secondary: #7c3aed;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    color: var(--text-dark);
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .loading-spinner::before {
    content: 'üèÜ';
    font-size: 80px;
    animation: bounce 1s ease-in-out infinite;
    display: block;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }

  .loading-text {
    margin-top: 1rem;
    font-size: 1.125rem;
    color: var(--text-dark);
    font-weight: 600;
  }

  /* Auth Gate */
  .auth-gate {
    max-width: 500px;
    margin: 4rem auto;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .auth-gate h2 {
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .auth-gate p {
    color: var(--text-light);
    margin-bottom: 2rem;
  }

  .auth-gate a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--admin-color) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 2.5rem 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .header::after {
    content: 'üèÜ';
    position: absolute;
    bottom: -40px;
    left: -30px;
    font-size: 180px;
    opacity: 0.08;
  }

  .header-content {
    max-width: 1200px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .admin-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  /* Container */
  .container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  /* Section Cards */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .section-header {
    background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
    color: white;
    padding: 1.25rem 1.5rem;
    font-size: 1.25rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .section-content {
    padding: 1.5rem;
  }

  /* Form Elements */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .form-group select,
  .form-group input {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s ease;
  }

  .form-group select:focus,
  .form-group input:focus {
    outline: none;
    border-color: var(--admin-color);
  }

  .form-hint {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 0.5rem;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-primary {
    background: var(--admin-color);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    background: var(--admin-secondary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #f1f5f9;
    color: var(--text-dark);
  }

  .btn-secondary:hover {
    background: #e2e8f0;
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  /* Progress/Status */
  .status-box {
    padding: 1rem 1.25rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
  }

  .status-box.info {
    background: #eff6ff;
    border: 1px solid #bfdbfe;
    color: #1e40af;
  }

  .status-box.success {
    background: #f0fdf4;
    border: 1px solid #bbf7d0;
    color: #166534;
  }

  .status-box.warning {
    background: #fefce8;
    border: 1px solid #fef08a;
    color: #854d0e;
  }

  .status-box.error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #991b1b;
  }

  .status-icon {
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .status-content {
    flex: 1;
  }

  .status-content strong {
    display: block;
    margin-bottom: 0.25rem;
  }

  /* Progress Bar */
  .progress-container {
    margin: 1.5rem 0;
  }

  .progress-bar {
    height: 12px;
    background: #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--admin-color), var(--admin-secondary));
    border-radius: 6px;
    transition: width 0.3s ease;
    width: 0%;
  }

  .progress-text {
    font-size: 0.9rem;
    color: var(--text-light);
    margin-top: 0.5rem;
    text-align: center;
  }

  /* Results Summary */
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin: 1.5rem 0;
  }

  .result-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
  }

  .result-card.gold { border-left: 4px solid #ffd700; }
  .result-card.silver { border-left: 4px solid #c0c0c0; }
  .result-card.bronze { border-left: 4px solid #cd7f32; }
  .result-card.hidden { border-left: 4px solid #6b46c1; }
  .result-card.total { border-left: 4px solid var(--admin-color); }

  .result-number {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-dark);
  }

  .result-label {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  /* Leaderboard Preview */
  .leaderboard-preview {
    margin-top: 1.5rem;
  }

  .leaderboard-preview h4 {
    font-size: 1rem;
    margin: 0 0 1rem;
    color: var(--text-dark);
  }

  .leaderboard-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 0.5rem;
  }

  .leaderboard-rank {
    font-weight: 800;
    color: var(--admin-color);
    min-width: 1.5rem;
  }

  .leaderboard-name {
    flex: 1;
    font-weight: 600;
  }

  .leaderboard-badges {
    display: flex;
    gap: 0.5rem;
    font-size: 0.85rem;
  }

  .badge-pill {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-weight: 600;
  }

  .badge-pill.gold { background: rgba(255, 215, 0, 0.2); color: #b8860b; }
  .badge-pill.silver { background: rgba(192, 192, 192, 0.3); color: #666; }
  .badge-pill.bronze { background: rgba(205, 127, 50, 0.2); color: #8b4513; }

  /* Log Output */
  .log-output {
    background: #1e293b;
    color: #e2e8f0;
    border-radius: 10px;
    padding: 1rem;
    font-family: 'Monaco', 'Consolas', monospace;
    font-size: 0.85rem;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 1rem;
  }

  .log-output .log-line {
    margin: 0.25rem 0;
    padding: 0.25rem 0;
    border-bottom: 1px solid #334155;
  }

  .log-output .log-line:last-child {
    border-bottom: none;
  }

  .log-output .log-success { color: #4ade80; }
  .log-output .log-error { color: #f87171; }
  .log-output .log-warning { color: #fbbf24; }
  .log-output .log-info { color: #60a5fa; }

  /* Responsive */
  @media (max-width: 768px) {
    .header h1 {
      font-size: 1.5rem;
    }

    .container {
      padding: 0 1rem;
    }

    .results-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading...</div>
  </div>

  <!-- Auth Gate (shown if not authorized) -->
  <div class="auth-gate" id="authGate" style="display: none;">
    <h2>üîí Admin Access Required</h2>
    <p>You must be logged in as an admin or league staff to access this page.</p>
    <a href="signin.html">Sign In</a>
  </div>

  <!-- Main Content (shown if authorized) -->
  <div id="mainContent" style="display: none;">
    <!-- Navigation placeholder -->
    <div class="filters-nav"></div>

    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <h1>üèÜ Badge Calculator</h1>
        <p>Calculate and save player achievement badges</p>
        <div class="admin-badge">Admin Tool</div>
      </div>
    </header>

    <div class="container">
      
      <!-- Calculator Section -->
      <div class="section">
        <div class="section-header">
          ‚öôÔ∏è Run Badge Calculation
        </div>
        <div class="section-content">
          
          <div class="status-box warning" id="partialDataWarning">
            <span class="status-icon">‚ö†Ô∏è</span>
            <div class="status-content">
              <strong>2025 Data is Partial</strong>
              Game-level statistics for 2025 seasons are incomplete. Not all games or players have data. Full tracking begins with 2026 Summer.
            </div>
          </div>

          <div class="form-group">
            <label for="seasonSelect">Select Season</label>
            <select id="seasonSelect">
              <option value="">Loading seasons...</option>
            </select>
            <p class="form-hint">Choose the season to calculate badges for</p>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="testModeCheckbox"> 
              Test Mode (save to playerBadges_test collection)
            </label>
            <p class="form-hint">Use test mode to preview results without overwriting production data</p>
          </div>

          <button class="btn btn-primary" id="calculateBtn" disabled>
            <span>üßÆ</span> Calculate Badges
          </button>

          <!-- Progress -->
          <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Initializing...</div>
          </div>

        </div>
      </div>

      <!-- Results Section -->
      <div class="section" id="resultsSection" style="display: none;">
        <div class="section-header">
          üìä Calculation Results
        </div>
        <div class="section-content">
          
          <div class="status-box success" id="successStatus">
            <span class="status-icon">‚úÖ</span>
            <div class="status-content">
              <strong>Badges Calculated Successfully!</strong>
              <span id="successMessage">Results saved to Firestore.</span>
            </div>
          </div>

          <div class="results-grid">
            <div class="result-card total">
              <div class="result-number" id="resultTotal">0</div>
              <div class="result-label">Total Badges</div>
            </div>
            <div class="result-card gold">
              <div class="result-number" id="resultGold">0</div>
              <div class="result-label">ü•á Gold</div>
            </div>
            <div class="result-card silver">
              <div class="result-number" id="resultSilver">0</div>
              <div class="result-label">ü•à Silver</div>
            </div>
            <div class="result-card bronze">
              <div class="result-number" id="resultBronze">0</div>
              <div class="result-label">ü•â Bronze</div>
            </div>
            <div class="result-card hidden">
              <div class="result-number" id="resultHidden">0</div>
              <div class="result-label">üîí Hidden</div>
            </div>
          </div>

          <div class="leaderboard-preview" id="leaderboardPreview">
            <h4>üèÜ Top Badge Earners</h4>
            <div id="leaderboardList"></div>
          </div>

          <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
            <a href="trophy-case.html" class="btn btn-success">
              <span>üèÜ</span> View Trophy Case
            </a>
            <button class="btn btn-secondary" onclick="location.reload()">
              <span>üîÑ</span> Run Another Calculation
            </button>
          </div>

        </div>
      </div>

      <!-- Log Section -->
      <div class="section">
        <div class="section-header">
          üìã Calculation Log
        </div>
        <div class="section-content">
          <div class="log-output" id="logOutput">
            <div class="log-line log-info">Ready to calculate badges...</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script type="module">
    import { 
      db,
      collection, 
      doc, 
      getDocs, 
      getDoc
    } from './firebase-config.js';
    import { 
      setDoc,
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { onAuthChange, getUserProfile, hasLeagueRole, isAdmin } from './firebase-auth.js';
    import { getAllSeasons } from './firebase-data.js';
    import { NavigationComponent } from './nav-component.js';
    import { BadgeCalculator, BADGE_DEFINITIONS } from './badge-calculator.js';

    // State
    let currentUser = null;
    let userProfile = null;
    let seasons = [];

    // DOM Elements
    const loadingOverlay = document.getElementById('loadingOverlay');
    const authGate = document.getElementById('authGate');
    const mainContent = document.getElementById('mainContent');
    const seasonSelect = document.getElementById('seasonSelect');
    const testModeCheckbox = document.getElementById('testModeCheckbox');
    const calculateBtn = document.getElementById('calculateBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const resultsSection = document.getElementById('resultsSection');
    const logOutput = document.getElementById('logOutput');

    // ============================================
    // AUTH & INITIALIZATION
    // ============================================

    onAuthChange(async (user) => {
      if (user) {
        currentUser = user;
        
        // getUserProfile returns { success, data } format
        const profileResult = await getUserProfile(user.uid);
        
        if (!profileResult.success) {
          authGate.style.display = 'block';
          authGate.querySelector('p').textContent = 'Could not load user profile. Please try again.';
          loadingOverlay.classList.add('hidden');
          return;
        }
        
        userProfile = profileResult.data;
        
        // Check multiple possible admin/staff indicators
        const hasAccess = 
          userProfile.isAdmin === true ||
          userProfile.role === 'admin' ||
          userProfile.userRole === 'admin' ||
          userProfile.userRole === 'league-staff' ||
          userProfile.role === 'league-staff' ||
          userProfile.userType === 'league-staff' ||
          isAdmin(userProfile) || 
          hasLeagueRole(userProfile);
        
        if (hasAccess) {
          await initializePage();
          mainContent.style.display = 'block';
        } else {
          authGate.style.display = 'block';
          authGate.querySelector('p').textContent = 'You do not have permission to access this page. Admin or League Staff role required.';
          console.log('Access denied. User profile:', userProfile);
        }
      } else {
        authGate.style.display = 'block';
      }
      loadingOverlay.classList.add('hidden');
    });

    async function initializePage() {
      log('Initializing badge calculator...', 'info');
      
      // Load seasons
      try {
        seasons = await getAllSeasons();
        seasons.sort((a, b) => b.id.localeCompare(a.id)); // Most recent first
        
        seasonSelect.innerHTML = seasons.map(s => {
          const is2025 = s.id.startsWith('2025');
          return `<option value="${s.id}">${s.year} ${capitalize(s.season)}${is2025 ? ' ‚ö†Ô∏è' : ''}${s.isActive ? ' (Current)' : ''}</option>`;
        }).join('');
        
        // Select current season by default
        const currentSeason = seasons.find(s => s.isActive);
        if (currentSeason) {
          seasonSelect.value = currentSeason.id;
        }
        
        calculateBtn.disabled = false;
        log(`Loaded ${seasons.length} seasons`, 'success');
        
      } catch (error) {
        log(`Error loading seasons: ${error.message}`, 'error');
      }

      // Update warning visibility based on selection
      seasonSelect.addEventListener('change', updateWarningVisibility);
      updateWarningVisibility();
    }

    function updateWarningVisibility() {
      const warning = document.getElementById('partialDataWarning');
      const selected = seasonSelect.value;
      if (selected && selected.startsWith('2025')) {
        warning.style.display = 'flex';
      } else {
        warning.style.display = 'none';
      }
    }

    // ============================================
    // BADGE CALCULATION
    // ============================================

    calculateBtn.addEventListener('click', async () => {
      const seasonId = seasonSelect.value;
      const testMode = testModeCheckbox.checked;
      
      if (!seasonId) {
        log('Please select a season', 'error');
        return;
      }

      // Disable button and show progress
      calculateBtn.disabled = true;
      progressContainer.style.display = 'block';
      resultsSection.style.display = 'none';
      
      log(`Starting badge calculation for ${seasonId}...`, 'info');
      log(`Test mode: ${testMode ? 'ON' : 'OFF'}`, 'info');
      
      updateProgress(10, 'Loading batting data...');

      try {
        const calculator = new BadgeCalculator(db, {
          collection,
          getDocs,
          doc,
          setDoc,
          serverTimestamp,
          testMode
        });

        // Override the calculator to add progress logging
        const originalLoadBatting = calculator.loadBattingData.bind(calculator);
        calculator.loadBattingData = async (sid) => {
          log('Loading batting data from playerStats...', 'info');
          const data = await originalLoadBatting(sid);
          log(`Found ${Object.keys(data).length} players with batting data`, 'success');
          updateProgress(30, 'Loading pitching data...');
          return data;
        };

        const originalLoadPitching = calculator.loadPitchingData.bind(calculator);
        calculator.loadPitchingData = async (sid) => {
          log('Loading pitching data from pitchingStats...', 'info');
          const data = await originalLoadPitching(sid);
          log(`Found ${Object.keys(data).length} players with pitching data`, 'success');
          updateProgress(50, 'Calculating badges...');
          return data;
        };

        // Run calculation
        const results = await calculator.calculateAllBadges(seasonId);
        
        updateProgress(80, 'Saving results to Firestore...');
        log(`Calculated ${results.badgeSummary.total} badges for ${results.leaderboard.length} players`, 'success');

        // Save results
        await calculator.saveBadgeResults(results);
        
        const collectionName = testMode ? 'playerBadges_test' : 'playerBadges';
        log(`Results saved to ${collectionName} collection`, 'success');
        
        updateProgress(100, 'Complete!');
        
        // Show results
        displayResults(results, testMode);
        
      } catch (error) {
        log(`Error: ${error.message}`, 'error');
        console.error('Badge calculation error:', error);
        updateProgress(0, 'Error occurred');
      }

      calculateBtn.disabled = false;
    });

    // ============================================
    // UI HELPERS
    // ============================================

    function updateProgress(percent, text) {
      progressFill.style.width = `${percent}%`;
      progressText.textContent = text;
    }

    function displayResults(results, testMode) {
      resultsSection.style.display = 'block';
      
      // Update summary numbers
      document.getElementById('resultTotal').textContent = results.badgeSummary.total;
      document.getElementById('resultGold').textContent = results.badgeSummary.gold;
      document.getElementById('resultSilver').textContent = results.badgeSummary.silver;
      document.getElementById('resultBronze').textContent = results.badgeSummary.bronze;
      document.getElementById('resultHidden').textContent = results.badgeSummary.hidden;
      
      // Update success message
      const collectionName = testMode ? 'playerBadges_test' : 'playerBadges';
      document.getElementById('successMessage').textContent = 
        `Results saved to ${collectionName} collection. ${results.leaderboard.length} players earned badges.`;
      
      // Show leaderboard preview
      const leaderboardList = document.getElementById('leaderboardList');
      const topPlayers = results.leaderboard.slice(0, 5);
      
      if (topPlayers.length > 0) {
        leaderboardList.innerHTML = topPlayers.map((player, i) => `
          <div class="leaderboard-item">
            <div class="leaderboard-rank">${i + 1}</div>
            <div class="leaderboard-name">${player.playerName}</div>
            <div class="leaderboard-badges">
              ${player.gold > 0 ? `<span class="badge-pill gold">ü•á${player.gold}</span>` : ''}
              ${player.silver > 0 ? `<span class="badge-pill silver">ü•à${player.silver}</span>` : ''}
              ${player.bronze > 0 ? `<span class="badge-pill bronze">ü•â${player.bronze}</span>` : ''}
            </div>
          </div>
        `).join('');
      } else {
        leaderboardList.innerHTML = '<p style="color: var(--text-light);">No badges earned yet.</p>';
      }

      // Log badge breakdown
      log('--- Badge Breakdown ---', 'info');
      const badgeCounts = {};
      Object.values(results.playerBadges).forEach(player => {
        Object.values(player.earned || {}).forEach(badge => {
          const key = badge.name || badge.badgeId;
          badgeCounts[key] = (badgeCounts[key] || 0) + 1;
        });
      });
      
      Object.entries(badgeCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([name, count]) => {
          log(`  ${name}: ${count} player${count !== 1 ? 's' : ''}`, 'info');
        });
    }

    function log(message, type = 'info') {
      const line = document.createElement('div');
      line.className = `log-line log-${type}`;
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logOutput.appendChild(line);
      logOutput.scrollTop = logOutput.scrollHeight;
    }

    function capitalize(str) {
      return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
    }
  </script>
  <script src="mobile-enhancements.js"></script>
</body>
</html>
