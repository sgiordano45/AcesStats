<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aces Historical Batting</title>
<link rel="stylesheet" href="style.css">
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { cursor: pointer; background-color: #f0f0f0; user-select: none; }
  th.asc::after { content: " ▲"; }
  th.desc::after { content: " ▼"; }
  select { margin: 5px; padding: 4px; }
  #summary { margin-bottom: 10px; font-weight: bold; }
  
  /* WAR column styling */
  .war-column { background-color: #f0f8ff; font-weight: bold; }
  .war-positive { color: #006600; }
  .war-negative { color: #cc0000; }
  .war-neutral { color: #666666; }
  
  /* Navigation styling */
  .nav-container {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-left: 30px;
    margin-top: 10px;
  }
  
  .nav-link {
    padding: 8px 15px;
    border: 1px solid #ccc;
    text-decoration: none;
    border-radius: 3px;
    white-space: nowrap;
    display: inline-block;
    background-color: #f0f0f0;
    color: #333;
  }
  
  .nav-link:hover {
    background-color: #e0e0e0;
  }
  
  .nav-link.pitching {
    background-color: #e6ffe6;
    border-color: #00aa00;
    color: #006600;
  }
  
  .nav-link.pitching:hover {
    background-color: #d4ffd4;
  }
  
  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .filters-nav {
      flex-direction: column;
      gap: 15px;
    }
    
    .filters-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    
    .nav-container {
      margin-left: 0;
      margin-top: 10px;
      justify-content: center;
    }
    
    .nav-link {
      padding: 10px 12px;
      font-size: 14px;
      text-align: center;
    }
  }
  
  @media (max-width: 480px) {
    .nav-container {
      flex-direction: column;
      align-items: stretch;
    }
    
    .nav-link {
      text-align: center;
      padding: 12px;
    }
    
    th, td {
      padding: 4px 6px;
      font-size: 0.85em;
    }
  }
</style>
</head>
<body>
<h1>Mountainside Aces Batting Stats</h1>

<div id="summary">
  <p id="totalsText"></p>
  <p id="leadersText"></p>
</div>

<div class="filters-nav">
  <div class="filters-section">
    <label for="yearFilter">Year:</label>
    <select id="yearFilter">
      <option value="All">All</option>
    </select>

    <label for="seasonFilter">Season:</label>
    <select id="seasonFilter">
      <option value="All">All</option>
    </select>
  </div>
  
  <nav class="nav-container">
    <a href="index.html" class="nav-link">Home</a>
    <a href="pitching.html" class="nav-link pitching">Pitching Stats</a>
    <a href="teams.html" class="nav-link">All Teams</a>
    <a href="players.html" class="nav-link">All Players</a>
    <a href="seasons.html" class="nav-link">All Seasons</a>
    <a href="awards.html" class="nav-link">League Awards</a>
    <a href="leaders.html" class="nav-link">Career Batting Leaders</a>
    <a href="pitching_leaders.html" class="nav-link">Career Pitching Leaders</a>
    <a href="milestones.html" class="nav-link">Batting Milestones</a>
    <a href="compare.html" class="nav-link">Player Comparison Tool</a>
  </nav>
</div>

<table id="statsTable">
  <thead>
    <tr>
      <th data-field="name">Name</th>
      <th data-field="team">Team</th>
      <th data-field="year">Year</th>
      <th data-field="season">Season</th>
      <th data-field="games">Games</th>
      <th data-field="atBats">At Bats</th>
      <th data-field="hits">Hits</th>
      <th data-field="runs">Runs</th>
      <th data-field="walks">Walks</th>
      <th data-field="AcesWar">AcesBPI</th>
      <th data-field="hittingWAR" class="war-column">Hitting WAR</th>
      <th data-field="pitchingWAR" class="war-column">Pitching WAR</th>
      <th data-field="totalWAR" class="war-column">Total WAR</th>
      <th data-field="BA">BA</th>
      <th data-field="OBP">OBP</th>
      <th data-field="Sub">Sub</th>
    </tr>
  </thead>
  <tbody>
    <!-- Rows generated dynamically -->
  </tbody>
</table>

<script src="war-calculator.js"></script>
<script>
let allData = [];
let warCalculator = null;
let pitchingData = [];
let gamesData = [];

// Load all data files
Promise.all([
  fetch("data.json").then(res => res.json()),
  fetch("pitching.json").then(res => res.json()),
  fetch("games.json").then(res => res.json())
])
.then(([batting, pitching, games]) => {
  allData = cleanData(batting);
  pitchingData = pitching;
  gamesData = games;
  
  // Initialize WAR calculator
  warCalculator = new WARCalculator(allData, pitchingData, gamesData);
  
  // Add WAR calculations to the data
  allData = warCalculator.addWARToBattingData();
  
  populateFilters();
  renderTable(allData);
  updateSummary(allData);
})
.catch(error => {
  console.error("Error loading data:", error);
  document.getElementById("statsTable").innerHTML = 
    '<p>Error loading statistics data. Please check that data files are available.</p>';
});

function cleanData(data) {
  return data.map(p => ({
    ...p,
    name: p.name ? p.name.trim() : "",
    team: p.team ? p.team.trim() : "",
    games: Number(p.games) || 0,
    atBats: Number(p.atBats) || 0,
    hits: Number(p.hits) || 0,
    runs: Number(p.runs) || 0,
    walks: Number(p.walks) || 0,
    AcesWar: p.AcesWar === "N/A" || !p.AcesWar ? "N/A" : Number(p.AcesWar)
  }));
}

function populateFilters() {
  const yearFilter = document.getElementById("yearFilter");
  const seasonFilter = document.getElementById("seasonFilter");
  
  const years = [...new Set(allData.map(p => p.year))].sort((a, b) => b - a);
  const seasons = [...new Set(allData.map(p => p.season))];
  
  years.forEach(year => {
    yearFilter.innerHTML += `<option value="${year}">${year}</option>`;
  });
  
  seasons.forEach(season => {
    seasonFilter.innerHTML += `<option value="${season}">${season}</option>`;
  });
  
  yearFilter.addEventListener("change", applyFilters);
  seasonFilter.addEventListener("change", applyFilters);
}

function applyFilters() {
  const yearFilter = document.getElementById("yearFilter").value;
  const seasonFilter = document.getElementById("seasonFilter").value;
  
  let filteredData = allData;
  
  if (yearFilter !== "All") {
    filteredData = filteredData.filter(p => p.year == yearFilter);
  }
  
  if (seasonFilter !== "All") {
    filteredData = filteredData.filter(p => p.season === seasonFilter);
  }
  
  renderTable(filteredData);
  updateSummary(filteredData);
}

function getWARColor(warValue) {
  if (warValue > 0.5) return 'war-positive';
  if (warValue < -0.5) return 'war-negative';
  return 'war-neutral';
}

function renderTable(data) {
  const tbody = document.querySelector('#statsTable tbody');
  tbody.innerHTML = "";

  data.forEach(p => {
    const acesWarDisplay = p.AcesWar === "N/A" ? "N/A" : Number(p.AcesWar).toFixed(2);
    const BA = p.atBats > 0 ? (p.hits / p.atBats).toFixed(3) : ".000";
    const OBP = (p.atBats + p.walks) > 0 
      ? ((p.hits + p.walks) / (p.atBats + p.walks)).toFixed(3) 
      : ".000";
    
    // Format WAR values with color coding
    const hittingWAR = p.hittingWAR || 0;
    const pitchingWAR = p.pitchingWAR || 0;
    const totalWAR = p.totalWAR || 0;
    
    const hittingWARClass = getWARColor(hittingWAR);
    const pitchingWARClass = getWARColor(pitchingWAR);
    const totalWARClass = getWARColor(totalWAR);

    const row = `<tr>
      <td><a href="player.html?name=${encodeURIComponent(p.name)}">${p.name}</a></td>
      <td><a href="team.html?team=${encodeURIComponent(p.team)}">${p.team}</a></td>
      <td>${p.year}</td>
      <td>${p.season}</td>
      <td>${p.games}</td>
      <td>${p.atBats}</td>
      <td>${p.hits}</td>
      <td>${p.runs}</td>
      <td>${p.walks}</td>
      <td>${acesWarDisplay}</td>
      <td class="war-column ${hittingWARClass}">${hittingWAR.toFixed(2)}</td>
      <td class="war-column ${pitchingWARClass}">${pitchingWAR.toFixed(2)}</td>
      <td class="war-column ${totalWARClass}">${totalWAR.toFixed(2)}</td>
      <td>${BA}</td>
      <td>${OBP}</td>
      <td>${isSubstitute(p) ? "Yes" : "No"}</td>
    </tr>`;
    tbody.innerHTML += row;
  });
}

function updateSummary(data) {
  if (data.length === 0) {
    document.getElementById("totalsText").textContent = "No data available for the selected filters.";
    document.getElementById("leadersText").textContent = "";
    return;
  }

  // Calculate totals
  let totals = {
    games: 0,
    atBats: 0,
    hits: 0,
    runs: 0,
    walks: 0,
  };

  data.forEach(p => {
    totals.games += p.games;
    totals.atBats += p.atBats;
    totals.hits += p.hits;
    totals.runs += p.runs;
    totals.walks += p.walks;
  });

  // Find leaders
  const qualifyingPlayers = data.filter(p => p.atBats >= 10);
  let leaders = {};
  
  // Counting stats leaders
  ["games", "atBats", "hits", "runs", "walks"].forEach(stat => {
    let maxPlayer = data.reduce((prev, curr) =>
      curr[stat] > prev[stat] ? curr : prev,
      { [stat]: -1 }
    );
    leaders[stat] = maxPlayer.name ? `${maxPlayer.name} (${maxPlayer[stat]})` : "N/A";
  });

  // WAR leaders
  let bestTotalWAR = data.reduce((prev, curr) => {
    const currWAR = curr.totalWAR || 0;
    const prevWAR = prev.totalWAR || 0;
    return currWAR > prevWAR ? curr : prev;
  }, { totalWAR: -Infinity });
  leaders.totalWAR = bestTotalWAR.name ? 
    `${bestTotalWAR.name} (${bestTotalWAR.totalWAR.toFixed(2)})` : "N/A";

  let bestHittingWAR = data.reduce((prev, curr) => {
    const currWAR = curr.hittingWAR || 0;
    const prevWAR = prev.hittingWAR || 0;
    return currWAR > prevWAR ? curr : prev;
  }, { hittingWAR: -Infinity });
  leaders.hittingWAR = bestHittingWAR.name ? 
    `${bestHittingWAR.name} (${bestHittingWAR.hittingWAR.toFixed(2)})` : "N/A";

  // Batting Average leader
  let bestBA = qualifyingPlayers.reduce((prev, curr) => {
    let currBA = curr.atBats > 0 ? curr.hits / curr.atBats : 0;
    let prevBA = prev.atBats > 0 ? prev.hits / prev.atBats : 0;
    return currBA > prevBA ? curr : prev;
  }, { atBats: 0, hits: 0 });
  leaders.BA = bestBA.name ? 
    `${bestBA.name} (${(bestBA.hits / bestBA.atBats).toFixed(3)})` : "N/A";

  // AcesBPI leader
  let bestAcesBPI = data.reduce((prev, curr) => {
    let currBPI = (curr.AcesWar !== "N/A" && !isNaN(curr.AcesWar)) ? Number(curr.AcesWar) : -Infinity;
    let prevBPI = (prev.AcesWar !== "N/A" && !isNaN(prev.AcesWar)) ? Number(prev.AcesWar) : -Infinity;
    return currBPI > prevBPI ? curr : prev;
  }, { AcesWar: -Infinity });
  leaders.AcesWar = bestAcesBPI.name ?
    `${bestAcesBPI.name} (${Number(bestAcesBPI.AcesWar).toFixed(2)})` : "N/A";

  // Update display
  document.getElementById("totalsText").innerHTML = `
    <strong>Season Totals:</strong> 
    ${totals.games} Games, ${totals.atBats} At-Bats, ${totals.hits} Hits, 
    ${totals.runs} Runs, ${totals.walks} Walks
  `;
  
  document.getElementById("leadersText").innerHTML = `
    <strong>Leaders:</strong> 
    Total WAR: ${leaders.totalWAR} | 
    Hitting WAR: ${leaders.hittingWAR} | 
    Hits: ${leaders.hits} | 
    BA: ${leaders.BA} | 
    AcesBPI: ${leaders.AcesWar}
  `;
}

function isSubstitute(player) {
  const subStatus = String(player.sub || player.Sub || "").toLowerCase().trim();
  return subStatus === "yes";
}

// Table sorting functionality
let currentSort = { field: null, ascending: true };

document.addEventListener('DOMContentLoaded', function() {
  const headers = document.querySelectorAll('#statsTable th[data-field]');
  
  headers.forEach(header => {
    header.addEventListener('click', function() {
      const field = this.getAttribute('data-field');
      sortTable(field);
    });
  });
});

function sortTable(field) {
  // Clear previous sort indicators
  document.querySelectorAll('#statsTable th').forEach(th => {
    th.classList.remove('asc', 'desc');
  });
  
  // Determine sort direction
  if (currentSort.field === field) {
    currentSort.ascending = !currentSort.ascending;
  } else {
    currentSort.ascending = false; // Default to descending for stats
  }
  currentSort.field = field;
  
  // Add sort indicator
  const header = document.querySelector(`#statsTable th[data-field="${field}"]`);
  header.classList.add(currentSort.ascending ? 'asc' : 'desc');
  
  // Get current filtered data
  const yearFilter = document.getElementById("yearFilter").value;
  const seasonFilter = document.getElementById("seasonFilter").value;
  
  let filteredData = allData;
  
  if (yearFilter !== "All") {
    filteredData = filteredData.filter(p => p.year == yearFilter);
  }
  
  if (seasonFilter !== "All") {
    filteredData = filteredData.filter(p => p.season === seasonFilter);
  }
  
  // Sort the data
  filteredData.sort((a, b) => {
    let aVal = a[field];
    let bVal = b[field];
    
    // Handle special cases
    if (field === 'AcesWar') {
      aVal = aVal === "N/A" ? -Infinity : Number(aVal);
      bVal = bVal === "N/A" ? -Infinity : Number(bVal);
    } else if (field.includes('WAR')) {
      aVal = Number(aVal) || 0;
      bVal = Number(bVal) || 0;
    } else if (typeof aVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return currentSort.ascending ? -1 : 1;
    if (aVal > bVal) return currentSort.ascending ? 1 : -1;
    return 0;
  });
  
  renderTable(filteredData);
}
</script>
</body>
</html>