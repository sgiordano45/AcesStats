<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submit Stats - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="mobile-enhancements.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 2rem 1.5rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.header h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.header p {
  margin: 0.5rem 0 0 0;
  font-size: 1rem;
  opacity: 0.95;
  position: relative;
  z-index: 1;
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

.controls-section {
  background: var(--card-bg);
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.control-group {
  margin-bottom: 1.5rem;
}

.control-group:last-child {
  margin-bottom: 0;
}

.control-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.control-group select,
.control-group input {
  width: 100%;
  max-width: 400px;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 14px;
  background: white;
  transition: all 0.2s;
}

.control-group select:focus,
.control-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.info-box {
  background: #eff6ff;
  border: 2px solid #3b82f6;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.info-box svg {
  width: 24px;
  height: 24px;
  color: #3b82f6;
  flex-shrink: 0;
}

.warning-box {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.warning-box svg {
  width: 24px;
  height: 24px;
  color: #f59e0b;
  flex-shrink: 0;
}

.error-box {
  background: #fee2e2;
  border: 2px solid #ef4444;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.error-box svg {
  width: 24px;
  height: 24px;
  color: #ef4444;
  flex-shrink: 0;
}

.success-box {
  background: #d1fae5;
  border: 2px solid #10b981;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.success-box svg {
  width: 24px;
  height: 24px;
  color: #10b981;
  flex-shrink: 0;
}

.stats-grid-container {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
  margin-bottom: 2rem;
}

.stats-grid-header {
  background: var(--primary-color);
  color: white;
  padding: 1rem 1.5rem;
  font-size: 1.25rem;
  font-weight: 700;
}

.table-scroll-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.stats-table thead th {
  background: #f8fafc;
  color: var(--text-dark);
  font-weight: 600;
  padding: 12px 8px;
  text-align: center;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: nowrap;
}

.stats-table thead th.player-col {
  text-align: left;
  position: sticky;
  left: 0;
  z-index: 20;
  background: #f8fafc;
}

.stats-table tbody td {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  text-align: center;
}

.stats-table tbody td.player-cell {
  position: sticky;
  left: 0;
  background: white;
  z-index: 5;
  text-align: left;
  font-weight: 500;
}

.stats-table tbody tr:hover td {
  background: #f8fafc;
}

.stats-table tbody tr:hover td.player-cell {
  background: #f1f5f9;
}

.stats-input {
  width: 70px;
  padding: 6px 8px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  text-align: center;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.stats-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.stats-input:disabled {
  background: #f1f5f9;
  cursor: not-allowed;
}

.checkbox-cell {
  padding: 8px;
}

.checkbox-cell input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.action-buttons {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 2rem;
}

.btn {
  padding: 0.875rem 2rem;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 4px 6px rgba(45, 80, 22, 0.3);
}

.btn-primary:hover {
  background: #234010;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(45, 80, 22, 0.4);
}

.btn-primary:disabled {
  background: #cbd5e0;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: white;
  color: var(--text-dark);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover {
  background: #f8fafc;
  border-color: var(--primary-color);
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-overlay.hidden {
  display: none;
}

.spinner {
  font-size: 48px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 1rem;
  font-size: 1.125rem;
  color: var(--text-dark);
  font-weight: 600;
}

@media (max-width: 768px) {
  .header h1 {
    font-size: 1.5rem;
  }

  .container {
    padding: 1rem;
  }

  .stats-input {
    width: 60px;
    padding: 4px 6px;
    font-size: 13px;
  }

  .stats-table thead th,
  .stats-table tbody td {
    padding: 6px 4px;
    font-size: 12px;
  }

  .action-buttons {
    flex-direction: column;
  }

  .btn {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner">‚öæ</div>
  <div class="loading-text">Loading stats submission...</div>
</div>

<div class="header">
  <h1>üìä Submit Stats</h1>
  <p>Enter game statistics for your team</p>
</div>

<div class="container">
  <div id="accessDenied" class="error-box" style="display: none;">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <div>
      <div style="font-weight: 600; color: #7f1d1d; margin-bottom: 0.25rem;">Access Denied</div>
      <div style="color: #991b1b;">You must be a Team Captain, Team Staff, League Staff, or Admin to submit stats.</div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <!-- Team Selection (Admin/League Staff only) -->
    <div id="teamSelectionSection" class="controls-section" style="display: none;">
      <div class="control-group">
        <label for="teamSelect">Select Team:</label>
        <select id="teamSelect">
          <option value="">-- Select a team --</option>
        </select>
      </div>
    </div>

    <!-- Game Information -->
    <div class="controls-section">
      <div class="control-group">
        <label for="gameDate">Game Date:</label>
        <input type="date" id="gameDate" required>
      </div>
      <div class="control-group">
        <label for="opponent">Opponent:</label>
        <input type="text" id="opponent" placeholder="e.g., Rival Team" required>
      </div>
    </div>

    <div id="infoMessage" class="info-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="infoMessageText"></div>
    </div>

    <div id="warningMessage" class="warning-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <div id="warningMessageText"></div>
    </div>

    <div id="errorMessage" class="error-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="errorMessageText"></div>
    </div>

    <div id="successMessage" class="success-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="successMessageText"></div>
    </div>

    <!-- Stats Grid -->
    <div id="statsGridContainer" class="stats-grid-container" style="display: none;">
      <div class="stats-grid-header">Team Roster - Enter Statistics</div>
      <div class="table-scroll-container">
        <table class="stats-table" id="statsTable">
          <thead>
            <tr>
              <th class="player-col">Player</th>
              <th>Played</th>
              <th>At Bats</th>
              <th>Hits</th>
              <th>Runs</th>
              <th>Walks</th>
              <th>IP</th>
              <th>Runs Allowed</th>
            </tr>
          </thead>
          <tbody id="statsTableBody">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" id="actionButtons" style="display: none;">
      <button class="btn btn-secondary" id="clearBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Clear All Stats
      </button>
      <button class="btn btn-primary" id="submitBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Submit Stats
      </button>
    </div>
  </div>
</div>

<script type="module">
import { onAuthChange, getCurrentUser, getUserProfile } from './firebase-auth.js';
import { getCurrentSeason, getAllTeams } from './firebase-data.js';
import { db, collection, doc, getDoc, query, where } from './firebase-config.js';
import { 
  updateDoc, 
  setDoc,
  increment,
  serverTimestamp,
  getDocs
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

let currentUser = null;
let userProfile = null;
let currentSeason = null;
let selectedTeam = null;
let rosterPlayers = [];
let isAdmin = false;
let isLeagueStaff = false;

// Show/hide message boxes
function showMessage(type, text) {
  // Hide all messages first
  document.getElementById('infoMessage').style.display = 'none';
  document.getElementById('warningMessage').style.display = 'none';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';

  // Show the requested message
  const messageMap = {
    'info': { box: 'infoMessage', text: 'infoMessageText' },
    'warning': { box: 'warningMessage', text: 'warningMessageText' },
    'error': { box: 'errorMessage', text: 'errorMessageText' },
    'success': { box: 'successMessage', text: 'successMessageText' }
  };

  if (messageMap[type]) {
    document.getElementById(messageMap[type].text).textContent = text;
    document.getElementById(messageMap[type].box).style.display = 'flex';
  }
}

// Check user permissions
function hasStatsSubmissionAccess(profile) {
  // Check if user is captain
  if (profile.isCaptain) {
    return { hasAccess: true, role: 'captain', teamId: profile.linkedTeam };
  }

  // Check for admin role
  if (profile.role === 'admin') {
    return { hasAccess: true, role: 'admin', teamId: null };
  }

  // Check for league staff role
  if (profile.role === 'league-staff' || profile.role === 'staff') {
    return { hasAccess: true, role: 'league-staff', teamId: null };
  }

  // Check for team staff role with linked team
  if (profile.role === 'team-staff' && profile.linkedTeam) {
    return { hasAccess: true, role: 'team-staff', teamId: profile.linkedTeam };
  }

  return { hasAccess: false };
}

// Load team roster
async function loadTeamRoster(teamId) {
  try {
    console.log('üîç Loading roster for team:', teamId);

    // Query the users collection for players on this team
    const usersRef = collection(db, 'users');
    const q = query(usersRef, where('linkedTeam', '==', teamId));
    const querySnapshot = await getDocs(q);

    const players = [];
    querySnapshot.forEach((doc) => {
      const userData = doc.data();
      if (userData.linkedPlayer) {
        players.push({
          id: doc.id,
          name: userData.linkedPlayer,
          displayName: userData.displayName || userData.linkedPlayer
        });
      }
    });

    // Sort players by name
    players.sort((a, b) => a.name.localeCompare(b.name));

    console.log(`‚úÖ Loaded ${players.length} players for team ${teamId}`);
    return players;
  } catch (error) {
    console.error('‚ùå Error loading team roster:', error);
    throw error;
  }
}

// Render stats table
function renderStatsTable(players) {
  const tbody = document.getElementById('statsTableBody');
  tbody.innerHTML = '';

  if (players.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 2rem; color: #718096;">
          No players found for this team. Players need to be linked to the team in their user profile.
        </td>
      </tr>
    `;
    return;
  }

  players.forEach((player, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="player-cell">${player.name}</td>
      <td class="checkbox-cell">
        <input type="checkbox" id="played_${index}" data-player-id="${player.id}" checked>
      </td>
      <td>
        <input type="number" class="stats-input" id="ab_${index}" data-player-id="${player.id}" 
               data-stat="atBats" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="hits_${index}" data-player-id="${player.id}" 
               data-stat="hits" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="runs_${index}" data-player-id="${player.id}" 
               data-stat="runs" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="walks_${index}" data-player-id="${player.id}" 
               data-stat="walks" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="ip_${index}" data-player-id="${player.id}" 
               data-stat="inningsPitched" min="0" step="0.1" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="ra_${index}" data-player-id="${player.id}" 
               data-stat="runsAllowed" min="0" value="0">
      </td>
    `;
    tbody.appendChild(row);

    // Add event listener to "Played" checkbox to disable/enable inputs
    const playedCheckbox = document.getElementById(`played_${index}`);
    const inputs = [
      document.getElementById(`ab_${index}`),
      document.getElementById(`hits_${index}`),
      document.getElementById(`runs_${index}`),
      document.getElementById(`walks_${index}`),
      document.getElementById(`ip_${index}`),
      document.getElementById(`ra_${index}`)
    ];

    playedCheckbox.addEventListener('change', () => {
      const isChecked = playedCheckbox.checked;
      inputs.forEach(input => {
        input.disabled = !isChecked;
        if (!isChecked) {
          input.value = '0';
        }
      });
    });
  });

  document.getElementById('statsGridContainer').style.display = 'block';
  document.getElementById('actionButtons').style.display = 'flex';
}

// Convert player name to userId format
function nameToUserId(name) {
  return name.toLowerCase().replace(/\s+/g, '_');
}

// Submit stats to Firebase
async function submitStats() {
  try {
    // Validate game info
    const gameDate = document.getElementById('gameDate').value;
    const opponent = document.getElementById('opponent').value.trim();

    if (!gameDate || !opponent) {
      showMessage('error', 'Please enter both game date and opponent.');
      return;
    }

    if (!selectedTeam) {
      showMessage('error', 'No team selected.');
      return;
    }

    // Show loading
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div style="width: 18px; height: 18px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> Submitting...';

    showMessage('info', 'Submitting stats to database...');

    // Collect all player stats
    const statsToSubmit = [];
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="played_"]');

    checkboxes.forEach((checkbox, index) => {
      if (checkbox.checked) {
        const playerId = checkbox.dataset.playerId;
        const playerName = rosterPlayers.find(p => p.id === playerId)?.name;

        const atBats = parseInt(document.getElementById(`ab_${index}`).value) || 0;
        const hits = parseInt(document.getElementById(`hits_${index}`).value) || 0;
        const runs = parseInt(document.getElementById(`runs_${index}`).value) || 0;
        const walks = parseInt(document.getElementById(`walks_${index}`).value) || 0;
        const inningsPitched = parseFloat(document.getElementById(`ip_${index}`).value) || 0;
        const runsAllowed = parseInt(document.getElementById(`ra_${index}`).value) || 0;

        // Only include if there's any stat to add
        if (atBats > 0 || hits > 0 || runs > 0 || walks > 0 || inningsPitched > 0 || runsAllowed > 0) {
          statsToSubmit.push({
            playerId,
            playerName,
            atBats,
            hits,
            runs,
            walks,
            inningsPitched,
            runsAllowed
          });
        }
      }
    });

    if (statsToSubmit.length === 0) {
      showMessage('warning', 'No stats to submit. Please enter some statistics.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
      return;
    }

    console.log('üìä Submitting stats for', statsToSubmit.length, 'players');

    // Submit each player's stats
    let successCount = 0;
    let errorCount = 0;

    for (const playerStats of statsToSubmit) {
      try {
        const userId = nameToUserId(playerStats.playerName);
        const seasonId = currentSeason.id;

        // Update batting stats if any batting data exists
        if (playerStats.atBats > 0 || playerStats.hits > 0 || playerStats.runs > 0 || playerStats.walks > 0) {
          const battingStatsRef = doc(db, 'playerStats', userId, 'seasons', seasonId);
          
          // Check if document exists
          const battingDoc = await getDoc(battingStatsRef);
          
          if (battingDoc.exists()) {
            // Update existing stats with increment
            await updateDoc(battingStatsRef, {
              atBats: increment(playerStats.atBats),
              hits: increment(playerStats.hits),
              runs: increment(playerStats.runs),
              walks: increment(playerStats.walks),
              gamesPlayed: increment(1),
              lastUpdated: serverTimestamp()
            });
          } else {
            // Create new stats document
            await setDoc(battingStatsRef, {
              playerId: userId,
              playerName: playerStats.playerName,
              seasonId: seasonId,
              atBats: playerStats.atBats,
              hits: playerStats.hits,
              runs: playerStats.runs,
              walks: playerStats.walks,
              gamesPlayed: 1,
              doubles: 0,
              triples: 0,
              homeRuns: 0,
              rbi: 0,
              strikeouts: 0,
              stolenBases: 0,
              caughtStealing: 0,
              lastUpdated: serverTimestamp()
            });
          }

          console.log(`‚úÖ Updated batting stats for ${playerStats.playerName}`);
        }

        // Update pitching stats if any pitching data exists
        if (playerStats.inningsPitched > 0 || playerStats.runsAllowed > 0) {
          const pitchingStatsRef = doc(db, 'pitchingStats', userId, 'seasons', seasonId);
          
          // Check if document exists
          const pitchingDoc = await getDoc(pitchingStatsRef);
          
          if (pitchingDoc.exists()) {
            // Update existing stats with increment
            await updateDoc(pitchingStatsRef, {
              inningsPitched: increment(playerStats.inningsPitched),
              runsAllowed: increment(playerStats.runsAllowed),
              gamesPlayed: increment(1),
              lastUpdated: serverTimestamp()
            });
          } else {
            // Create new stats document
            await setDoc(pitchingStatsRef, {
              playerId: userId,
              playerName: playerStats.playerName,
              seasonId: seasonId,
              inningsPitched: playerStats.inningsPitched,
              runsAllowed: playerStats.runsAllowed,
              gamesPlayed: 1,
              earnedRuns: 0,
              strikeouts: 0,
              walks: 0,
              hits: 0,
              wins: 0,
              losses: 0,
              saves: 0,
              lastUpdated: serverTimestamp()
            });
          }

          console.log(`‚úÖ Updated pitching stats for ${playerStats.playerName}`);
        }

        successCount++;
      } catch (error) {
        console.error(`‚ùå Error updating stats for ${playerStats.playerName}:`, error);
        errorCount++;
      }
    }

    // Show result
    if (errorCount === 0) {
      showMessage('success', `Successfully submitted stats for ${successCount} player(s)!`);
      // Clear the form
      setTimeout(() => {
        clearAllStats();
      }, 2000);
    } else {
      showMessage('warning', `Submitted stats for ${successCount} player(s), but ${errorCount} failed.`);
    }

    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;

  } catch (error) {
    console.error('‚ùå Error submitting stats:', error);
    showMessage('error', `Error submitting stats: ${error.message}`);
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = `
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Submit Stats
    `;
  }
}

// Clear all stats
function clearAllStats() {
  const inputs = document.querySelectorAll('.stats-input');
  inputs.forEach(input => input.value = '0');
  
  const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="played_"]');
  checkboxes.forEach(checkbox => checkbox.checked = true);
  
  document.getElementById('gameDate').value = '';
  document.getElementById('opponent').value = '';
  
  showMessage('info', 'All stats cleared.');
}

// Initialize the page
async function initializePage(user) {
  if (!user) {
    window.location.href = 'signin.html';
    return;
  }

  console.log('üöÄ Initializing submit-stats page for:', user.displayName);

  try {
    currentUser = user;

    // Get user profile
    const profileResult = await getUserProfile(user.uid);
    if (!profileResult.success) {
      throw new Error('Could not load user profile');
    }

    userProfile = profileResult.data;
    console.log('üë§ User profile loaded:', userProfile);

    // Check permissions
    const access = hasStatsSubmissionAccess(userProfile);
    console.log('üîê Access check:', access);

    if (!access.hasAccess) {
      document.getElementById('accessDenied').style.display = 'flex';
      document.getElementById('loadingOverlay').classList.add('hidden');
      return;
    }

    // Get current season
    currentSeason = await getCurrentSeason();
    if (!currentSeason) {
      throw new Error('No active season found');
    }

    console.log('üìÖ Current season:', currentSeason.id);

    // Show main content
    document.getElementById('mainContent').style.display = 'block';

    // Handle team selection based on role
    if (access.role === 'admin' || access.role === 'league-staff') {
      // Show team selector for admin/league staff
      isAdmin = access.role === 'admin';
      isLeagueStaff = access.role === 'league-staff';
      
      document.getElementById('teamSelectionSection').style.display = 'block';
      
      // Load all teams
      const teams = await getAllTeams();
      const teamSelect = document.getElementById('teamSelect');
      
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = team.name;
        teamSelect.appendChild(option);
      });

      // Add event listener for team selection
      teamSelect.addEventListener('change', async (e) => {
        const teamId = e.target.value;
        if (teamId) {
          selectedTeam = teamId;
          showMessage('info', 'Loading team roster...');
          try {
            rosterPlayers = await loadTeamRoster(teamId);
            renderStatsTable(rosterPlayers);
            showMessage('info', `Loaded ${rosterPlayers.length} players. Enter stats for the game.`);
          } catch (error) {
            showMessage('error', `Error loading roster: ${error.message}`);
          }
        } else {
          document.getElementById('statsGridContainer').style.display = 'none';
          document.getElementById('actionButtons').style.display = 'none';
        }
      });

    } else {
      // Captain or team staff - load their team automatically
      selectedTeam = access.teamId;
      showMessage('info', 'Loading your team roster...');
      
      try {
        rosterPlayers = await loadTeamRoster(selectedTeam);
        renderStatsTable(rosterPlayers);
        showMessage('info', `Loaded ${rosterPlayers.length} players. Enter stats for the game.`);
      } catch (error) {
        showMessage('error', `Error loading roster: ${error.message}`);
      }
    }

    // Set up event listeners
    document.getElementById('submitBtn').addEventListener('click', submitStats);
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all entered stats?')) {
        clearAllStats();
      }
    });

    // Set default game date to today
    document.getElementById('gameDate').valueAsDate = new Date();

    document.getElementById('loadingOverlay').classList.add('hidden');

  } catch (error) {
    console.error('‚ùå Error initializing page:', error);
    showMessage('error', `Error loading page: ${error.message}`);
    document.getElementById('loadingOverlay').classList.add('hidden');
  }
}

// Wait for auth state
onAuthChange((user) => {
  if (user) {
    initializePage(user);
  } else {
    window.location.href = 'signin.html';
  }
});
</script>

</body>
</html>
