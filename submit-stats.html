<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Submit Stats - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 2rem 1.5rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.header h1 {
  margin: 0;
  font-size: 2rem;
  font-weight: 800;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.header p {
  margin: 0.5rem 0 0 0;
  font-size: 1rem;
  opacity: 0.95;
  position: relative;
  z-index: 1;
}

.back-home-btn {
  position: absolute;
  top: 2rem;
  right: 2rem;
  background: rgba(255,255,255,0.2);
  color: white;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: all 0.3s ease;
  backdrop-filter: blur(10px);
  border: 2px solid rgba(255,255,255,0.3);
  z-index: 2;
}

.back-home-btn:hover {
  background: rgba(255,255,255,0.3);
  transform: translateX(-5px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem 1.5rem;
}

.controls-section {
  background: var(--card-bg);
  padding: 1.5rem;
  border-radius: 12px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
}

.control-group {
  margin-bottom: 1.5rem;
}

.control-group:last-child {
  margin-bottom: 0;
}

.control-group label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.5rem;
}

.control-group select,
.control-group input {
  width: 100%;
  max-width: 400px;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 14px;
  background: white;
  transition: all 0.2s;
}

.control-group select:focus,
.control-group input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.info-box {
  background: #eff6ff;
  border: 2px solid #3b82f6;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.info-box svg {
  width: 24px;
  height: 24px;
  color: #3b82f6;
  flex-shrink: 0;
}

.warning-box {
  background: #fef3c7;
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.warning-box svg {
  width: 24px;
  height: 24px;
  color: #f59e0b;
  flex-shrink: 0;
}

.error-box {
  background: #fee2e2;
  border: 2px solid #ef4444;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.error-box svg {
  width: 24px;
  height: 24px;
  color: #ef4444;
  flex-shrink: 0;
}

.success-box {
  background: #d1fae5;
  border: 2px solid #10b981;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.success-box svg {
  width: 24px;
  height: 24px;
  color: #10b981;
  flex-shrink: 0;
}

.edit-mode-banner {
  background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
  border: 2px solid #f59e0b;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
  display: none;
  align-items: center;
  gap: 0.75rem;
}

.edit-mode-banner svg {
  width: 24px;
  height: 24px;
  color: #d97706;
  flex-shrink: 0;
}

.edit-mode-banner .banner-content {
  flex: 1;
}

.edit-mode-banner .banner-title {
  font-weight: 700;
  color: #92400e;
  margin-bottom: 0.25rem;
}

.edit-mode-banner .banner-text {
  color: #b45309;
  font-size: 14px;
}

.stats-grid-container {
  background: var(--card-bg);
  border-radius: 12px;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-color);
  overflow: hidden;
  margin-bottom: 2rem;
}

.stats-grid-header {
  background: var(--primary-color);
  color: white;
  padding: 1rem 1.5rem;
  font-size: 1.25rem;
  font-weight: 700;
}

.table-scroll-container {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.stats-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.stats-table thead th {
  background: #f8fafc;
  color: var(--text-dark);
  font-weight: 600;
  padding: 12px 8px;
  text-align: center;
  border-bottom: 2px solid var(--border-color);
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: nowrap;
}

.stats-table thead th.player-col {
  text-align: left;
  position: sticky;
  left: 0;
  z-index: 20;
  background: #f8fafc;
}

.stats-table tbody td {
  padding: 8px;
  border-bottom: 1px solid var(--border-color);
  text-align: center;
}

.stats-table tbody td.player-cell {
  position: sticky;
  left: 0;
  background: white;
  z-index: 5;
  text-align: left;
  font-weight: 500;
}

.stats-table tbody tr:hover td {
  background: #f8fafc;
}

.stats-table tbody tr:hover td.player-cell {
  background: #f1f5f9;
}

.stats-input {
  width: 70px;
  padding: 6px 8px;
  border: 2px solid var(--border-color);
  border-radius: 6px;
  text-align: center;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
}

.stats-input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.stats-input:disabled {
  background: #f1f5f9;
  cursor: not-allowed;
}

.checkbox-cell {
  padding: 8px;
}

.checkbox-cell input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--primary-color);
}

.action-buttons {
  display: flex;
  gap: 1rem;
  justify-content: center;
  flex-wrap: wrap;
  margin-top: 2rem;
}

.btn {
  padding: 0.875rem 2rem;
  border: none;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  text-decoration: none;
}

.btn-primary {
  background: var(--primary-color);
  color: white;
  box-shadow: 0 4px 6px rgba(45, 80, 22, 0.3);
}

.btn-primary:hover {
  background: #234010;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(45, 80, 22, 0.4);
}

.btn-primary:disabled {
  background: #cbd5e0;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.btn-secondary {
  background: white;
  color: var(--text-dark);
  border: 2px solid var(--border-color);
}

.btn-secondary:hover {
  background: #f8fafc;
  border-color: var(--primary-color);
}

.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-overlay.hidden {
  display: none;
}

.spinner {
  font-size: 48px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}
/* Header */
.page-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  padding: 4rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
  color: white;
  text-align: center;
}

.page-header::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
  border-radius: 50%;
}

.page-header::after {
  content: 'üßÆ';
  position: absolute;
  bottom: -30px;
  left: -30px;
  font-size: 200px;
  opacity: 0.05;
}

.page-header h1 {
  font-size: 3.5rem;
  font-weight: 800;
  margin-bottom: 1rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  position: relative;
  z-index: 1;
}

.page-header p {
  font-size: 1.3rem;
  font-weight: 300;
  opacity: 0.9;
  position: relative;
  z-index: 1;
}

.loading-text {
  margin-top: 1rem;
  font-size: 1.125rem;
  color: var(--text-dark);
  font-weight: 600;
}

@media (max-width: 768px) {
  .header h1 {
    font-size: 1.5rem;
  }

  .back-home-btn {
    position: static;
    margin-bottom: 1rem;
    justify-content: center;
  }

  .container {
    padding: 1rem;
  }

  .stats-input {
    width: 60px;
    padding: 4px 6px;
    font-size: 13px;
  }

  .stats-table thead th,
  .stats-table tbody td {
    padding: 6px 4px;
    font-size: 12px;
  }

  .action-buttons {
    flex-direction: column;
  }

  .btn {
    width: 100%;
    justify-content: center;
  }
}
</style>
</head>
<body>

<div id="loadingOverlay" class="loading-overlay">
  <div class="spinner">üßÆ</div>
  <div class="loading-text">Loading stats submission...</div>
</div>

<div class="page-container">
<div class="header">
  <a href="profile.html" class="back-home-btn">
    <span>‚Üê</span> Back to Profile
  </a>
  <h1>Submit Stats</h1>
  <p>Enter game statistics for your team</p>
</div>

<div class="container">
  <div id="accessDenied" class="error-box" style="display: none;">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
    </svg>
    <div>
      <div style="font-weight: 600; color: #7f1d1d; margin-bottom: 0.25rem;">Access Denied</div>
      <div style="color: #991b1b;">You must be a Team Captain, Team Staff, League Staff, or Admin to submit stats.</div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <!-- Team Selection (Admin/League Staff only) -->
    <div id="teamSelectionSection" class="controls-section" style="display: none;">
      <div class="control-group">
        <label for="teamSelect">Select Team:</label>
        <select id="teamSelect">
          <option value="">-- Select a team --</option>
        </select>
      </div>
    </div>

    <!-- Game Selection -->
    <div class="controls-section">
      <div class="control-group">
        <label for="gameSelect">Select Game:</label>
        <select id="gameSelect" required>
          <option value="">-- Select a game --</option>
        </select>
      </div>
      <div id="gameDetails" style="display: none; padding: 1rem; background: #f8fafc; border-radius: 8px; margin-top: 1rem;">
        <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem 1rem; font-size: 14px;">
          <strong>Date:</strong> <span id="selectedGameDate"></span>
          <strong>Opponent:</strong> <span id="selectedGameOpponent"></span>
          <strong>Location:</strong> <span id="selectedGameLocation"></span>
        </div>
      </div>
    </div>

    <div id="infoMessage" class="info-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="infoMessageText"></div>
    </div>

    <div id="warningMessage" class="warning-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
      </svg>
      <div id="warningMessageText"></div>
    </div>

    <div id="errorMessage" class="error-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="errorMessageText"></div>
    </div>

    <div id="successMessage" class="success-box" style="display: none;">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div id="successMessageText"></div>
    </div>

    <div id="editModeBanner" class="edit-mode-banner">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      <div class="banner-content">
        <div class="banner-title">üìù EDIT MODE</div>
        <div class="banner-text" id="editModeBannerText">Existing stats have been loaded. You can edit and resubmit.</div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div id="statsGridContainer" class="stats-grid-container" style="display: none;">
      <div class="stats-grid-header">Team Roster - Enter Statistics</div>
      <div class="table-scroll-container">
        <table class="stats-table" id="statsTable">
          <thead>
            <tr>
              <th class="player-col">Player</th>
              <th>Played</th>
              <th>At Bats</th>
              <th>Hits</th>
              <th>Runs</th>
              <th>Walks</th>
              <th>IP</th>
              <th>Runs Allowed</th>
            </tr>
          </thead>
          <tbody id="statsTableBody">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons" id="actionButtons" style="display: none;">
      <button class="btn btn-secondary" id="clearBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
        </svg>
        Clear All Stats
      </button>
      <button class="btn btn-primary" id="submitBtn">
        <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        Submit Stats
      </button>
    </div>
  </div>
</div>

<script type="module">
import { onAuthChange, getCurrentUser, getUserProfile } from './firebase-auth.js';
import { getCurrentSeason, getAllTeams } from './firebase-data.js';
import { db, collection, doc, getDoc, query, where } from './firebase-config.js';
import { 
  updateDoc, 
  setDoc,
  increment,
  serverTimestamp,
  getDocs
} from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
import './nav-component.js';  // Initialize navigation

let currentUser = null;
let userProfile = null;
let currentSeason = null;
let selectedTeam = null;
let rosterPlayers = [];
let teamGames = [];
let isAdmin = false;
let isLeagueStaff = false;

// Load all games for a team (including past games)
async function getAllTeamGames(teamId, seasonId) {
  try {
    const gamesRef = collection(db, 'seasons', seasonId, 'games');
    
    console.log(`üîç Loading ALL games for team: "${teamId}" in season: ${seasonId}`);
    
    // Get ALL games for this season (same as submit-score.html)
    const allGamesSnap = await getDocs(gamesRef);
    
    const games = [];
    const teamIdLower = teamId.toLowerCase();
    
    allGamesSnap.forEach(doc => {
      const data = doc.data();
      
      // Parse game date (same logic as submit-score.html)
      let gameDate = null;
      if (data.date?.seconds) {
        // Firestore Timestamp
        gameDate = new Date(data.date.seconds * 1000);
      } else if (data.date && typeof data.date === 'string' && data.date.trim() !== '') {
        // String date (but not empty string)
        gameDate = new Date(data.date);
        // Check if date is valid
        if (isNaN(gameDate.getTime())) {
          gameDate = null;
        }
      }

      // Determine if this is a playoff game (same as submit-score.html)
      const isPlayoffGame = 
        data.game_type === 'Playoff' || 
        data.gameType === 'playoff' || 
        data.gameType === 'Playoff';

      // Handle both camelCase and space-separated field names (same as submit-score.html)
      const homeTeam = data.homeTeamName || data['home team'] || data.homeTeam || 'TBD';
      const awayTeam = data.awayTeamName || data['away team'] || data.awayTeam || 'TBD';
      
      // Check if this team is involved
      const homeTeamMatch = homeTeam.toLowerCase() === teamIdLower;
      const awayTeamMatch = awayTeam.toLowerCase() === teamIdLower;
      
      if (!homeTeamMatch && !awayTeamMatch) {
        return; // Not this team's game
      }
      
      // Determine opponent
      let opponent = 'Unknown Opponent';
      let isHome = false;
      
      if (homeTeamMatch) {
        opponent = awayTeam;
        isHome = true;
      } else {
        opponent = homeTeam;
        isHome = false;
      }
      
      // Include ALL games (no date filter for stats submission)
      games.push({
        id: doc.id,
        ...data,
        dateObj: gameDate || new Date(0), // Use epoch for games with no date
        date: data.date,
        isHome: isHome,
        opponent: opponent,
        isPlayoff: isPlayoffGame,
        gameType: data.game_type || data.gameType || 'Regular',
        round: data.round || null
      });
    });
    
    // Sort by date (most recent first)
    games.sort((a, b) => {
      const timeA = a.dateObj.getTime();
      const timeB = b.dateObj.getTime();
      return timeB - timeA; // Reverse order for most recent first
    });
    
    const playoffCount = games.filter(g => g.isPlayoff).length;
    const regularCount = games.length - playoffCount;
    
    console.log(`‚úÖ Loaded ${games.length} total games for ${teamId} (${regularCount} regular season, ${playoffCount} playoff)`);
    if (games.length > 0) {
      console.log('üìä Sample game:', {
        id: games[0].id,
        opponent: games[0].opponent,
        isHome: games[0].isHome,
        isPlayoff: games[0].isPlayoff,
        round: games[0].round
      });
    }
    return games;
  } catch (error) {
    console.error('‚ùå Error loading team games:', error);
    return [];
  }
}

// Show/hide message boxes
function showMessage(type, text) {
  // Hide all messages first
  document.getElementById('infoMessage').style.display = 'none';
  document.getElementById('warningMessage').style.display = 'none';
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';

  // Show the requested message
  const messageMap = {
    'info': { box: 'infoMessage', text: 'infoMessageText' },
    'warning': { box: 'warningMessage', text: 'warningMessageText' },
    'error': { box: 'errorMessage', text: 'errorMessageText' },
    'success': { box: 'successMessage', text: 'successMessageText' }
  };

  if (messageMap[type]) {
    document.getElementById(messageMap[type].text).textContent = text;
    document.getElementById(messageMap[type].box).style.display = 'flex';
  }
}

// Check user permissions
function hasStatsSubmissionAccess(profile) {
  // Check if user is captain
  if (profile.isCaptain) {
    return { hasAccess: true, role: 'captain', teamId: profile.linkedTeam };
  }

  // Check for admin role
  if (profile.role === 'admin') {
    return { hasAccess: true, role: 'admin', teamId: null };
  }

  // Check for league staff role
  if (profile.role === 'league-staff' || profile.role === 'staff') {
    return { hasAccess: true, role: 'league-staff', teamId: null };
  }

  // Check for team staff role with linked team
  if (profile.role === 'team-staff' && profile.linkedTeam) {
    return { hasAccess: true, role: 'team-staff', teamId: profile.linkedTeam };
  }

  return { hasAccess: false };
}

// Load team roster
async function loadTeamRoster(teamId) {
  try {
    console.log('üîç Loading roster for team:', teamId);

    // Use the same approach as roster-management.html
    // Load from aggregatedPlayerStats to get complete roster
    const { getSeasonPlayerStatsOptimized } = await import('./firebase-data.js');
    const seasonPlayers = await getSeasonPlayerStatsOptimized(currentSeason.id);
    
    // Filter for the selected team and exclude migrated players
    const filteredPlayers = seasonPlayers.filter(p => {
      return p.team === teamId && !p.migrated;
    });

    const players = filteredPlayers.map(player => {
      const name = player.name || player.playerName;
      
      // Derive legacyId for game-level stats lookups
      // Auth users: use linkedPlayer converted to legacy format
      // Legacy users: playerId is already the legacy format
      let legacyId;
      if (player.isAuthUser && player.linkedPlayer) {
        // Convert "Steve Giordano" or "John Smith Jr." to "steve_giordano" or "john_smith_jr"
        legacyId = player.linkedPlayer.toLowerCase().replace(/\./g, '').replace(/\s+/g, '_');
      } else {
        // Already a legacy ID (e.g., "steve_giordano")
        legacyId = player.playerId;
      }
      
      return {
        id: player.playerId,      // Auth ID or legacy ID (for aggregatedPlayerStats lookups)
        legacyId: legacyId,       // Legacy ID (for playerStats/games and pitchingStats/games)
        name: name,
        displayName: name,
        linkedPlayer: player.linkedPlayer || null,
        isAuthUser: player.isAuthUser || false
      };
    });

    // Sort players by name
    players.sort((a, b) => a.name.localeCompare(b.name));

    console.log(`‚úÖ Loaded ${players.length} players for team ${teamId}`);
    if (players.length > 0) {
      console.log('üìã Sample player mapping:', {
        name: players[0].name,
        id: players[0].id,
        legacyId: players[0].legacyId,
        isAuthUser: players[0].isAuthUser
      });
    }
    
    // Also load games for this team
    teamGames = await getAllTeamGames(teamId, currentSeason.id);
    populateGameDropdown();
    
    return players;
  } catch (error) {
    console.error('‚ùå Error loading team roster:', error);
    throw error;
  }
}

// Populate game dropdown
function populateGameDropdown() {
  const gameSelect = document.getElementById('gameSelect');
  
  // Clear existing options except the first one
  gameSelect.innerHTML = '<option value="">-- Select a game --</option>';
  
  if (teamGames.length === 0) {
    const option = document.createElement('option');
    option.value = '';
    option.textContent = 'No games found for this team';
    option.disabled = true;
    gameSelect.appendChild(option);
    return;
  }
  
  teamGames.forEach(game => {
    const option = document.createElement('option');
    option.value = game.id;
    
    // Format date
    let dateStr = 'Unknown Date';
    if (game.dateObj && game.dateObj.getTime() !== 0) {
      dateStr = game.dateObj.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric' 
      });
    } else if (game.dateObj && game.dateObj.getTime() === 0) {
      dateStr = 'TBD';
    }
    
    // Format game description
    const location = game.isHome ? 'vs' : '@';
    const playoffIndicator = game.isPlayoff ? 'üèÜ ' : '';
    const roundInfo = game.round ? ` (${game.round})` : '';
    
    option.textContent = `${playoffIndicator}${dateStr} ${location} ${game.opponent}${roundInfo}`;
    
    // Store game data in option for later retrieval
    option.dataset.gameData = JSON.stringify(game);
    
    gameSelect.appendChild(option);
  });
  
  console.log(`‚úÖ Populated ${teamGames.length} games in dropdown`);
}

// Render stats table
function renderStatsTable(players) {
  const tbody = document.getElementById('statsTableBody');
  tbody.innerHTML = '';

  if (players.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 2rem; color: #718096;">
          No players found for this team. Players need to be linked to the team in their user profile.
        </td>
      </tr>
    `;
    return;
  }

  players.forEach((player, index) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="player-cell">${player.name}</td>
      <td class="checkbox-cell">
        <input type="checkbox" id="played_${index}" data-player-id="${player.id}" checked>
      </td>
      <td>
        <input type="number" class="stats-input" id="ab_${index}" data-player-id="${player.id}" 
               data-stat="atBats" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="hits_${index}" data-player-id="${player.id}" 
               data-stat="hits" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="runs_${index}" data-player-id="${player.id}" 
               data-stat="runs" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="walks_${index}" data-player-id="${player.id}" 
               data-stat="walks" min="0" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="ip_${index}" data-player-id="${player.id}" 
               data-stat="inningsPitched" min="0" step="0.1" value="0">
      </td>
      <td>
        <input type="number" class="stats-input" id="ra_${index}" data-player-id="${player.id}" 
               data-stat="runsAllowed" min="0" value="0">
      </td>
    `;
    tbody.appendChild(row);

    // Add event listener to "Played" checkbox to disable/enable inputs
    const playedCheckbox = document.getElementById(`played_${index}`);
    const inputs = [
      document.getElementById(`ab_${index}`),
      document.getElementById(`hits_${index}`),
      document.getElementById(`runs_${index}`),
      document.getElementById(`walks_${index}`),
      document.getElementById(`ip_${index}`),
      document.getElementById(`ra_${index}`)
    ];

    playedCheckbox.addEventListener('change', () => {
      const isChecked = playedCheckbox.checked;
      inputs.forEach(input => {
        input.disabled = !isChecked;
        if (!isChecked) {
          input.value = '0';
        }
      });
    });
  });

  document.getElementById('statsGridContainer').style.display = 'block';
  document.getElementById('actionButtons').style.display = 'flex';
}

// Load existing stats for a game
async function loadExistingStatsForGame(gameId) {
  try {
    console.log('üîç Loading existing stats for game:', gameId);
    showMessage('info', 'Loading existing stats for this game...');
    
    const existingStats = {};
    
    // Load batting stats for all players on the roster
    // Use legacyId for Firebase paths since game stats are stored under legacy IDs
    for (const player of rosterPlayers) {
      const legacyId = player.legacyId;  // Use legacyId for game stats lookups
      const playerId = player.id;        // Keep playerId as key for existingStats object
      
      // Try to load batting stats
      try {
        const battingRef = doc(db, 'playerStats', legacyId, 'games', gameId);
        const battingDoc = await getDoc(battingRef);
        
        if (battingDoc.exists()) {
          const battingData = battingDoc.data();
          existingStats[playerId] = {
            atBats: battingData.atBats || 0,
            hits: battingData.hits || 0,
            runs: battingData.runs || 0,
            walks: battingData.walks || 0,
            inningsPitched: 0,
            runsAllowed: 0,
            hasBattingStats: true
          };
          console.log(`‚úÖ Loaded batting stats for ${player.name} (legacyId: ${legacyId})`);
        }
      } catch (error) {
        // Player doesn't have batting stats for this game yet
      }
      
      // Try to load pitching stats
      try {
        const pitchingRef = doc(db, 'pitchingStats', legacyId, 'games', gameId);
        const pitchingDoc = await getDoc(pitchingRef);
        
        if (pitchingDoc.exists()) {
          const pitchingData = pitchingDoc.data();
          if (!existingStats[playerId]) {
            existingStats[playerId] = {
              atBats: 0,
              hits: 0,
              runs: 0,
              walks: 0,
              inningsPitched: 0,
              runsAllowed: 0
            };
          }
          existingStats[playerId].inningsPitched = pitchingData.inningsPitched || 0;
          existingStats[playerId].runsAllowed = pitchingData.runsAllowed || 0;
          existingStats[playerId].hasPitchingStats = true;
          console.log(`‚úÖ Loaded pitching stats for ${player.name} (legacyId: ${legacyId})`);
        }
      } catch (error) {
        // Player doesn't have pitching stats for this game yet
      }
    }
    
    // Populate the form with existing stats
    rosterPlayers.forEach((player, index) => {
      const playerId = player.id;
      const stats = existingStats[playerId];
      
      // Get the checkbox and input elements
      const playedCheckbox = document.getElementById(`played_${index}`);
      const inputs = [
        document.getElementById(`ab_${index}`),
        document.getElementById(`hits_${index}`),
        document.getElementById(`runs_${index}`),
        document.getElementById(`walks_${index}`),
        document.getElementById(`ip_${index}`),
        document.getElementById(`ra_${index}`)
      ];
      
      if (stats) {
        // Player has existing stats - populate the form
        inputs[0].value = stats.atBats;
        inputs[1].value = stats.hits;
        inputs[2].value = stats.runs;
        inputs[3].value = stats.walks;
        inputs[4].value = stats.inningsPitched;
        inputs[5].value = stats.runsAllowed;
        
        // Keep the "played" checkbox checked and inputs enabled
        playedCheckbox.checked = true;
        inputs.forEach(input => input.disabled = false);
      } else {
        // No existing stats - reset to defaults
        inputs[0].value = '0';
        inputs[1].value = '0';
        inputs[2].value = '0';
        inputs[3].value = '0';
        inputs[4].value = '0';
        inputs[5].value = '0';
        
        // Reset checkbox to checked and enable inputs
        playedCheckbox.checked = true;
        inputs.forEach(input => input.disabled = false);
      }
    });
    
    const statsCount = Object.keys(existingStats).length;
    if (statsCount > 0) {
      // Show edit mode banner
      document.getElementById('editModeBanner').style.display = 'flex';
      document.getElementById('editModeBannerText').textContent = 
        `Loaded existing stats for ${statsCount} player(s). Edit any values and click Submit to update.`;
      showMessage('info', `‚úÖ Edit mode: Stats loaded for ${statsCount} player(s).`);
    } else {
      // Hide edit mode banner
      document.getElementById('editModeBanner').style.display = 'none';
      showMessage('info', 'No existing stats found. Enter new stats for this game.');
    }
    
    return existingStats;
    
  } catch (error) {
    console.error('‚ùå Error loading existing stats:', error);
    document.getElementById('editModeBanner').style.display = 'none';
    showMessage('warning', `Could not load existing stats: ${error.message}. You can still enter new stats.`);
    return {};
  }
}

// Convert player name to userId format (legacy ID)
// Handles periods (Jr. ‚Üí Jr) and spaces
function nameToUserId(name) {
  return name.toLowerCase().replace(/\./g, '').replace(/\s+/g, '_');
}

// Submit stats to Firebase
async function submitStats() {
  try {
    // Validate game selection
    const gameSelect = document.getElementById('gameSelect');
    const selectedGameId = gameSelect.value;

    if (!selectedGameId) {
      showMessage('error', 'Please select a game.');
      return;
    }

    // Get selected game data
    const selectedOption = gameSelect.options[gameSelect.selectedIndex];
    const gameData = JSON.parse(selectedOption.dataset.gameData);

    if (!selectedTeam) {
      showMessage('error', 'No team selected.');
      return;
    }

    // Show loading
    const submitBtn = document.getElementById('submitBtn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<div style="width: 18px; height: 18px; border: 2px solid white; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div> Submitting...';

    showMessage('info', 'Submitting stats to game-level database...');

    // Collect all player stats
    const statsToSubmit = [];
    const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="played_"]');

    checkboxes.forEach((checkbox, index) => {
      if (checkbox.checked) {
        const playerId = checkbox.dataset.playerId;
        const player = rosterPlayers.find(p => p.id === playerId);
        const playerName = player?.name;
        const legacyId = player?.legacyId;  // Get legacyId for Firebase paths

        const atBats = parseInt(document.getElementById(`ab_${index}`).value) || 0;
        const hits = parseInt(document.getElementById(`hits_${index}`).value) || 0;
        const runs = parseInt(document.getElementById(`runs_${index}`).value) || 0;
        const walks = parseInt(document.getElementById(`walks_${index}`).value) || 0;
        const inningsPitched = parseFloat(document.getElementById(`ip_${index}`).value) || 0;
        const runsAllowed = parseInt(document.getElementById(`ra_${index}`).value) || 0;

        // Only include if there's any stat to add
        if (atBats > 0 || hits > 0 || runs > 0 || walks > 0 || inningsPitched > 0 || runsAllowed > 0) {
          statsToSubmit.push({
            playerId,
            legacyId,  // Include legacyId for Firebase writes
            playerName,
            atBats,
            hits,
            runs,
            walks,
            inningsPitched,
            runsAllowed
          });
        }
      }
    });

    if (statsToSubmit.length === 0) {
      showMessage('warning', 'No stats to submit. Please enter some statistics.');
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalBtnText;
      return;
    }

    console.log('üìä Submitting game-level stats for', statsToSubmit.length, 'players');
    console.log('üéÆ Game ID:', selectedGameId);

    // Submit each player's stats to GAME-LEVEL database only
    let successCount = 0;
    let errorCount = 0;

    for (const playerStats of statsToSubmit) {
      try {
        // Use legacyId directly from player data (no conversion needed)
        const legacyId = playerStats.legacyId;
        const seasonId = currentSeason.id;
        
        console.log(`üìù Writing stats for ${playerStats.playerName} using legacyId: ${legacyId}`);

        // Format game date for display
        let gameDateFormatted = 'Unknown';
        if (gameData.dateObj) {
          gameDateFormatted = new Date(gameData.dateObj).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
          });
        }

        // Write BATTING stats to game-level database
        if (playerStats.atBats > 0 || playerStats.hits > 0 || playerStats.runs > 0 || playerStats.walks > 0) {
          const gameStatsRef = doc(db, 'playerStats', legacyId, 'games', selectedGameId);
          
          await setDoc(gameStatsRef, {
            // Game identification
            gameId: selectedGameId,
            playerId: legacyId,
            playerName: playerStats.playerName,
            seasonId: seasonId,
            teamId: selectedTeam,
            
            // Game context
            gameDate: gameData.date || null,
            gameDateFormatted: gameDateFormatted,
            opponent: gameData.opponent || 'Unknown',
            isHome: gameData.isHome || false,
            
            // Batting stats for this game
            atBats: playerStats.atBats,
            hits: playerStats.hits,
            runs: playerStats.runs,
            walks: playerStats.walks,
            doubles: 0,  // Not collected yet, placeholder for future
            triples: 0,
            homeRuns: 0,
            rbi: 0,
            strikeouts: 0,
            stolenBases: 0,
            caughtStealing: 0,
            
            // Metadata
            submittedBy: currentUser.uid,
            submittedByName: currentUser.displayName || currentUser.email,
            submittedAt: serverTimestamp(),
            lastModified: serverTimestamp(),
            dataVersion: 1  // Track schema version for future migrations
          }, { merge: true }); // Use merge in case we're updating existing game stats

          console.log(`‚úÖ Saved batting stats for ${playerStats.playerName} - Game ${selectedGameId}`);
        }

        // Write PITCHING stats to game-level database
        if (playerStats.inningsPitched > 0 || playerStats.runsAllowed > 0) {
          const gamePitchingRef = doc(db, 'pitchingStats', legacyId, 'games', selectedGameId);
          
          await setDoc(gamePitchingRef, {
            // Game identification
            gameId: selectedGameId,
            playerId: legacyId,
            playerName: playerStats.playerName,
            seasonId: seasonId,
            teamId: selectedTeam,
            
            // Game context
            gameDate: gameData.date || null,
            gameDateFormatted: gameDateFormatted,
            opponent: gameData.opponent || 'Unknown',
            isHome: gameData.isHome || false,
            
            // Pitching stats for this game
            inningsPitched: playerStats.inningsPitched,
            runsAllowed: playerStats.runsAllowed,
            earnedRuns: 0,  // Not collected yet, placeholder for future
            strikeouts: 0,
            walks: 0,
            hits: 0,
            wins: 0,
            losses: 0,
            saves: 0,
            
            // Metadata
            submittedBy: currentUser.uid,
            submittedByName: currentUser.displayName || currentUser.email,
            submittedAt: serverTimestamp(),
            lastModified: serverTimestamp(),
            dataVersion: 1
          }, { merge: true });

          console.log(`‚úÖ Saved pitching stats for ${playerStats.playerName} - Game ${selectedGameId}`);
        }

        successCount++;
      } catch (error) {
        console.error(`‚ùå Error saving stats for ${playerStats.playerName}:`, error);
        errorCount++;
      }
    }

    // Show result
    if (errorCount === 0) {
      showMessage('success', `Successfully submitted game-level stats for ${successCount} player(s)! Game ID: ${selectedGameId}`);
      console.log('‚úÖ All stats saved to game-level database');
      console.log('üìù Database paths:');
      console.log('   - /playerStats/{userId}/games/' + selectedGameId);
      console.log('   - /pitchingStats/{userId}/games/' + selectedGameId);
      
      // Clear the form after successful submission
      setTimeout(() => {
        clearAllStats();
      }, 3000);
    } else {
      showMessage('warning', `Submitted stats for ${successCount} player(s), but ${errorCount} failed.`);
    }

    submitBtn.disabled = false;
    submitBtn.innerHTML = originalBtnText;

  } catch (error) {
    console.error('‚ùå Error submitting stats:', error);
    showMessage('error', `Error submitting stats: ${error.message}`);
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.innerHTML = `
      <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Submit Stats
    `;
  }
}

// Clear all stats
function clearAllStats() {
  const inputs = document.querySelectorAll('.stats-input');
  inputs.forEach(input => input.value = '0');
  
  const checkboxes = document.querySelectorAll('input[type="checkbox"][id^="played_"]');
  checkboxes.forEach(checkbox => checkbox.checked = true);
  
  document.getElementById('gameSelect').value = '';
  document.getElementById('gameDetails').style.display = 'none';
  document.getElementById('editModeBanner').style.display = 'none';
  
  showMessage('info', 'All stats cleared.');
}

// Initialize the page
async function initializePage(user) {
  if (!user) {
    window.location.href = 'signin.html';
    return;
  }

  console.log('üöÄ Initializing submit-stats page for:', user.displayName);

  try {
    currentUser = user;

    // Get user profile
    const profileResult = await getUserProfile(user.uid);
    if (!profileResult.success) {
      throw new Error('Could not load user profile');
    }

    userProfile = profileResult.data;
    console.log('üë§ User profile loaded:', userProfile);

    // Check permissions
    const access = hasStatsSubmissionAccess(userProfile);
    console.log('üîê Access check:', access);

    if (!access.hasAccess) {
      document.getElementById('accessDenied').style.display = 'flex';
      document.getElementById('loadingOverlay').classList.add('hidden');
      return;
    }

    // Get current season
    currentSeason = await getCurrentSeason();
    if (!currentSeason) {
      throw new Error('No active season found');
    }

    console.log('üìÖ Current season:', currentSeason.id);

    // Show main content
    document.getElementById('mainContent').style.display = 'block';

    // Handle team selection based on role
    if (access.role === 'admin' || access.role === 'league-staff') {
      // Show team selector for admin/league staff
      isAdmin = access.role === 'admin';
      isLeagueStaff = access.role === 'league-staff';
      
      document.getElementById('teamSelectionSection').style.display = 'block';
      
      // Load all teams
      const teams = await getAllTeams();
      const teamSelect = document.getElementById('teamSelect');
      
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = team.name;
        teamSelect.appendChild(option);
      });

      // Add event listener for team selection
      teamSelect.addEventListener('change', async (e) => {
        const teamId = e.target.value;
        if (teamId) {
          selectedTeam = teamId;
          showMessage('info', 'Loading team roster...');
          try {
            rosterPlayers = await loadTeamRoster(teamId);
            renderStatsTable(rosterPlayers);
            showMessage('info', `Loaded ${rosterPlayers.length} players. Enter stats for the game.`);
          } catch (error) {
            showMessage('error', `Error loading roster: ${error.message}`);
          }
        } else {
          document.getElementById('statsGridContainer').style.display = 'none';
          document.getElementById('actionButtons').style.display = 'none';
        }
      });

    } else {
      // Captain or team staff - load their team automatically
      selectedTeam = access.teamId;
      showMessage('info', 'Loading your team roster...');
      
      try {
        rosterPlayers = await loadTeamRoster(selectedTeam);
        renderStatsTable(rosterPlayers);
        showMessage('info', `Loaded ${rosterPlayers.length} players. Enter stats for the game.`);
      } catch (error) {
        showMessage('error', `Error loading roster: ${error.message}`);
      }
    }

    // Set up event listeners
    document.getElementById('submitBtn').addEventListener('click', submitStats);
    document.getElementById('clearBtn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all entered stats?')) {
        clearAllStats();
      }
    });
    
    // Add game selection event listener
    document.getElementById('gameSelect').addEventListener('change', async (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      if (selectedOption.value) {
        const gameData = JSON.parse(selectedOption.dataset.gameData);
        
        // Show game details
        const gameDetails = document.getElementById('gameDetails');
        const dateStr = gameData.dateObj ? new Date(gameData.dateObj).toLocaleDateString('en-US', { 
          weekday: 'long', 
          year: 'numeric',
          month: 'long', 
          day: 'numeric' 
        }) : 'Unknown Date';
        
        document.getElementById('selectedGameDate').textContent = dateStr;
        document.getElementById('selectedGameOpponent').textContent = gameData.opponent || 'Unknown';
        document.getElementById('selectedGameLocation').textContent = gameData.isHome ? 'Home' : 'Away';
        
        gameDetails.style.display = 'block';
        
        // Load existing stats for this game
        await loadExistingStatsForGame(selectedOption.value);
      } else {
        document.getElementById('gameDetails').style.display = 'none';
        // Clear the form
        clearAllStats();
      }
    });

    document.getElementById('loadingOverlay').classList.add('hidden');

  } catch (error) {
    console.error('‚ùå Error initializing page:', error);
    showMessage('error', `Error loading page: ${error.message}`);
    document.getElementById('loadingOverlay').classList.add('hidden');
  }
}

// Wait for auth state
onAuthChange((user) => {
  if (user) {
    initializePage(user);
  } else {
    window.location.href = 'signin.html';
  }
});
</script>

</div><!-- Close page-container -->
</body>
</html>
