<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title id="pageTitle">Player Stats</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    line-height: 1.6;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
  }
  
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    opacity: 1;
    visibility: visible;
  }
  
  .loading-overlay.hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }
  
  .softball-spinner {
    text-align: center;
  }
  
  .softball-spinner::before {
    content: '‚öæ';
    font-size: 80px;
    display: block;
    animation: spin 1.5s ease-in-out infinite;
    margin-bottom: 20px;
  }
  
  .softball-spinner::after {
    content: 'Loading player statistics...';
    display: block;
    font-size: 1.2rem;
    color: #4a5568;
    font-weight: 600;
  }
  
  @keyframes spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }
  
  .page-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 2rem;
  }
  
  .player-header {
    background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
    color: white;
    padding: 3rem 2rem;
    border-radius: 16px;
    margin-bottom: 3rem;
    display: flex;
    align-items: center;
    gap: 30px;
    box-shadow: 0 12px 32px rgba(0,0,0,0.16);
    position: relative;
    overflow: hidden;
  }
  
  .player-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -10%;
    width: 400px;
    height: 400px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }
  
  .player-header::after {
    content: '‚öæ';
    position: absolute;
    bottom: -40px;
    left: -40px;
    font-size: 200px;
    opacity: 0.05;
    transform: rotate(-15deg);
  }
  
  .player-photo-container {
    position: relative;
    z-index: 1;
  }
  
  .player-photo {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 5px solid rgba(255,255,255,0.3);
    display: none;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  
  .player-photo.loaded {
    display: block;
  }
  
  .player-photo-placeholder {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    background: rgba(255,255,255,0.15);
    border: 5px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 4rem;
    color: rgba(255,255,255,0.5);
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
  }
  
  .player-photo-placeholder.hidden {
    display: none;
  }
  
  .player-photo-upload-btn {
    position: absolute;
    bottom: 5px;
    right: 5px;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
    color: white;
    border: 3px solid white;
    cursor: pointer;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    z-index: 2;
  }
  
  .player-photo-upload-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 12px rgba(0,0,0,0.4);
  }
  
  .player-photo-upload-btn.visible {
    display: flex;
  }
  
  #playerPhotoInput {
    display: none;
  }
  
  .player-info {
    flex: 1;
    z-index: 1;
  }
  
  .player-name-section {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  
  .player-number {
    background-color: rgba(255,255,255,0.25);
    padding: 10px 15px;
    border-radius: 12px;
    font-size: 1.4em;
    font-weight: 800;
    border: 2px solid rgba(255,255,255,0.3);
  }
  
  .player-name-text h1 {
    margin: 0;
    font-size: 2.8em;
    font-weight: 800;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
  }
  
  .player-nickname {
    font-size: 1.2em;
    opacity: 0.9;
    font-style: italic;
    margin-top: 5px;
  }
  
  .player-details {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
  }
  
  .player-details-row2 {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 15px;
    margin-top: 15px;
  }
  
  .detail-item {
    background-color: rgba(255,255,255,0.15);
    padding: 12px 18px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }
  
  .detail-item:hover {
    background-color: rgba(255,255,255,0.25);
    transform: translateY(-2px);
  }
  
  .detail-label {
    font-size: 0.9em;
    opacity: 0.8;
    margin-bottom: 4px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 600;
  }
  
  .detail-value {
    font-size: 1.2em;
    font-weight: 700;
  }
  
  .captain-badge {
    background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
    color: #333;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    border: 2px solid #e6c200;
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  }
  
  .captain-badge::before {
    content: "‚≠ê";
    font-size: 1.1em;
  }
  
  .master-chef-section {
    background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
    color: white;
    border-radius: 16px;
    padding: 2.5rem;
    margin-bottom: 3rem;
    box-shadow: 0 12px 32px rgba(255,107,53,0.3);
    position: relative;
    overflow: hidden;
    display: none;
  }
  
  .master-chef-section::before {
    content: "üë®‚Äçüç≥";
    position: absolute;
    top: -20px;
    right: -20px;
    font-size: 10em;
    opacity: 0.08;
    transform: rotate(15deg);
  }
  
  .master-chef-title {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  .chef-icon {
    font-size: 3em;
    background: rgba(255,255,255,0.2);
    padding: 15px;
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .master-chef-title h2 {
    margin: 0;
    font-size: 2em;
    font-weight: 800;
  }
  
  .chef-subtitle {
    font-size: 1.2em;
    opacity: 0.9;
    margin-bottom: 25px;
  }
  
  .chef-achievements {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 20px;
  }
  
  .chef-achievement {
    background: rgba(255,255,255,0.15);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    backdrop-filter: blur(10px);
  }
  
  .chef-achievement-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
    display: block;
  }
  
  .chef-achievement-title {
    font-weight: 700;
    margin-bottom: 8px;
    font-size: 1.1em;
  }
  
  .chef-achievement-desc {
    font-size: 0.95em;
    opacity: 0.85;
  }
  
  .awards-section {
    background: white;
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 3rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    border: 1px solid #e2e8f0;
  }
  
  .awards-section h2 {
    margin: 0 0 20px 0;
    color: #2d3748;
    font-size: 1.8em;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .awards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
  }
  
  .award-item {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    padding: 15px 20px;
    border-radius: 12px;
    border-left: 5px solid #2d5016;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s ease;
  }
  
  .award-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  
  .award-icon {
    width: 32px;
    height: 32px;
    flex-shrink: 0;
    object-fit: contain;
  }
  
  .award-icon.fallback {
    width: auto;
    height: auto;
    font-size: 1.8em;
  }
  
  .award-details {
    flex: 1;
  }
  
  .award-name {
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 4px;
    font-size: 1.1em;
  }
  
  .award-season {
    font-size: 0.9em;
    color: #718096;
  }
  
  .stats-section {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 3rem;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    border: 1px solid #e2e8f0;
  }
  
  .stats-section h2 {
    background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
    color: white;
    margin: 0;
    padding: 1.5rem 2rem;
    font-size: 1.6em;
    font-weight: 700;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th, td {
    padding: 14px 16px;
    text-align: center;
    border-bottom: 1px solid #e2e8f0;
  }
  
  th {
    background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
    color: white;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
  }
  
  tbody tr {
    transition: background-color 0.2s ease;
  }
  
  tbody tr:hover {
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  }
  
  .sub-yes {
    background: linear-gradient(135deg, #ffeaa7 0%, #ffd93d 100%);
    color: #d63031;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 0.85em;
    font-weight: 700;
  }
  
  .team-link {
    color: #2d5016;
    text-decoration: none;
    font-weight: 700;
    transition: all 0.2s ease;
  }
  
  .team-link:hover {
    color: #1a6b4a;
    text-decoration: underline;
  }
  
  .back-button {
    background: white;
    color: #2d5016;
    border: 2px solid #2d5016;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    margin-bottom: 2rem;
    text-decoration: none;
    display: inline-block;
    font-weight: 700;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  
  .back-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: -1;
  }
  
  .back-button:hover {
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  }
  
  .back-button:hover::before {
    transform: translateX(0);
  }
  
  /* Print Card Button */
  .print-card-button {
    background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    margin-left: 1rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(139, 69, 19, 0.3);
  }
  
  .print-card-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(139, 69, 19, 0.4);
    background: linear-gradient(135deg, #A0522D 0%, #CD853F 100%);
  }
  
  .share-card-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    cursor: pointer;
    margin-left: 1rem;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .share-card-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }
  
  .share-card-button:disabled {
    opacity: 0.7;
    cursor: wait;
  }
  
  .print-card-button::before {
    content: 'üÉè';
    font-size: 1.2em;
  }
  
  /* Baseball Card Styles - Always defined, hidden on screen */
  .baseball-card-container {
    display: none;
  }
  
  .baseball-card {
    width: 3.5in;
    height: 5in;
    margin: 0 auto;
    background-color: #f5f0e1 !important;
    border: 3px solid #8B4513;
    border-radius: 12px;
    overflow: hidden;
    font-family: 'Georgia', serif;
    position: relative;
    box-sizing: border-box;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-front {
    height: 100%;
    display: flex;
    flex-direction: column;
    position: relative;
  }
  
  .card-team-banner {
    background-color: #2d5016 !important;
    color: #ffffff !important;
    text-align: center;
    padding: 8px 10px;
    position: relative;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-team-name {
    font-size: 14px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 2px;
    margin: 0;
    color: #ffffff !important;
  }
  
  .card-league-name {
    font-size: 9px;
    margin-top: 2px;
    letter-spacing: 1px;
    color: #ffffff !important;
  }
  
  .card-photo-frame {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px;
    background-color: #f5f0e1 !important;
    position: relative;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-photo-frame::before {
    content: '';
    position: absolute;
    top: 8px;
    left: 8px;
    right: 8px;
    bottom: 8px;
    border: 2px solid #8B4513;
    border-radius: 8px;
    pointer-events: none;
  }
  
  .card-photo {
    width: 180px;
    height: 180px;
    object-fit: cover;
    border-radius: 8px;
    border: 3px solid #8B4513;
  }
  
  .card-photo-placeholder {
    width: 180px;
    height: 180px;
    background-color: #2d5016 !important;
    border-radius: 8px;
    border: 3px solid #8B4513;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 80px;
    color: rgba(255,255,255,0.3) !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-player-info {
    background-color: #2d5016 !important;
    color: #ffffff !important;
    padding: 12px 15px;
    text-align: center;
    position: relative;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-player-number {
    position: absolute;
    top: -18px;
    right: 15px;
    background-color: #ffd700 !important;
    color: #333333 !important;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 900;
    font-size: 16px;
    border: 2px solid #8B4513;
    font-family: 'Arial Black', sans-serif;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-player-name {
    font-size: 20px;
    font-weight: bold;
    margin: 0 0 4px 0;
    color: #ffffff !important;
  }
  
  .card-player-nickname {
    font-size: 11px;
    font-style: italic;
    margin-bottom: 6px;
    color: #ffffff !important;
  }
  
  .card-player-position {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #ffffff !important;
  }
  
  .card-stats-strip {
    background-color: #f5f0e1 !important;
    padding: 10px 12px;
    border-top: 2px solid #8B4513;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-stats-row {
    display: flex;
    justify-content: space-around;
    text-align: center;
  }
  
  .card-stat {
    flex: 1;
  }
  
  .card-stat-value {
    font-size: 16px;
    font-weight: bold;
    color: #2d5016 !important;
    font-family: 'Arial Black', sans-serif;
  }
  
  .card-stat-label {
    font-size: 8px;
    color: #666666 !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-top: 2px;
  }
  
  .card-footer {
    background-color: #8B4513 !important;
    color: #ffffff !important;
    text-align: center;
    padding: 6px;
    font-size: 8px;
    letter-spacing: 1px;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
  }
  
  .card-footer-year {
    font-weight: bold;
    color: #ffffff !important;
  }
  
  .card-captain-star {
    position: absolute;
    top: 8px;
    left: 8px;
    font-size: 24px;
  }
  
  /* ========================================
     Card Back Styles
     ======================================== */
  
  .card-back-page {
    page-break-before: always;
  }
  
  .card-back {
    height: 100%;
    display: flex;
    flex-direction: column;
    background-color: #f5f0e1 !important;
    font-family: 'Arial', sans-serif;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
    color-adjust: exact !important;
    box-sizing: border-box;
  }
  
  .card-back * {
    box-sizing: border-box;
  }
  
  .card-back-header {
    background-color: #2d5016 !important;
    color: #ffffff !important;
    padding: 10px 12px;
    text-align: center;
    position: relative;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .card-back-number {
    position: absolute;
    top: 8px;
    left: 10px;
    font-size: 18px;
    font-weight: 900;
    color: #ffd700 !important;
  }
  
  .card-back-name {
    font-size: 18px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: #ffffff !important;
  }
  
  .card-back-team {
    font-size: 11px;
    margin-top: 2px;
    color: #ffffff !important;
    opacity: 0.9;
  }
  
  .card-back-vitals {
    display: flex;
    justify-content: space-around;
    padding: 8px 10px;
    background-color: #e8e0cc !important;
    border-bottom: 2px solid #8B4513;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .vital-item {
    text-align: center;
  }
  
  .vital-label {
    display: block;
    font-size: 8px;
    color: #666666 !important;
    font-weight: bold;
    letter-spacing: 0.5px;
  }
  
  .vital-value {
    display: block;
    font-size: 12px;
    font-weight: bold;
    color: #2d5016 !important;
  }
  
  .card-back-stats-section {
    flex: 1;
    padding: 6px 4px;
    overflow: hidden;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
  }
  
  .card-back-stats-title {
    font-size: 9px;
    font-weight: bold;
    text-align: center;
    color: #8B4513 !important;
    letter-spacing: 1px;
    margin-bottom: 6px;
    border-bottom: 1px solid #8B4513;
    padding-bottom: 4px;
  }
  
  .card-back-stats-table {
    width: 100% !important;
    min-width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    font-size: 8px;
    table-layout: fixed !important;
    display: table;
  }
  
  .card-back-stats-table th {
    background-color: #2d5016 !important;
    color: #ffffff !important;
    padding: 4px 1px;
    font-weight: bold;
    text-align: center;
    font-size: 7px;
    letter-spacing: 0.3px;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  /* Column widths for consistent layout */
  .card-back-stats-table th:nth-child(1),
  .card-back-stats-table td:nth-child(1) { width: 14%; } /* YR/SN */
  .card-back-stats-table th:nth-child(2),
  .card-back-stats-table td:nth-child(2) { width: 13%; } /* TEAM */
  .card-back-stats-table th:nth-child(3),
  .card-back-stats-table td:nth-child(3) { width: 9%; }  /* G */
  .card-back-stats-table th:nth-child(4),
  .card-back-stats-table td:nth-child(4) { width: 11%; } /* AB */
  .card-back-stats-table th:nth-child(5),
  .card-back-stats-table td:nth-child(5) { width: 10%; } /* H */
  .card-back-stats-table th:nth-child(6),
  .card-back-stats-table td:nth-child(6) { width: 9%; }  /* R */
  .card-back-stats-table th:nth-child(7),
  .card-back-stats-table td:nth-child(7) { width: 10%; } /* BB */
  .card-back-stats-table th:nth-child(8),
  .card-back-stats-table td:nth-child(8) { width: 14%; } /* AVG */
  
  .card-back-stats-table td {
    padding: 3px 1px;
    text-align: center;
    border-bottom: 1px solid #d4c9b0;
    color: #333333 !important;
    font-size: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  
  .card-back-stats-table tbody tr:nth-child(even) {
    background-color: #ebe5d5 !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .card-back-stats-table tfoot tr {
    background-color: #d4c9b0 !important;
    font-weight: bold;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .card-back-stats-table tfoot td {
    border-top: 2px solid #8B4513;
    color: #2d5016 !important;
    font-weight: bold;
  }
  
  .card-back-footer {
    background-color: #8B4513 !important;
    color: #ffffff !important;
    padding: 6px;
    text-align: center;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }
  
  .card-back-logo {
    font-size: 9px;
    font-weight: bold;
    letter-spacing: 1px;
    color: #ffffff !important;
  }
  
  .card-back-copyright {
    font-size: 7px;
    margin-top: 2px;
    opacity: 0.8;
    color: #ffffff !important;
  }

  /* Print Styles - Show card, hide page */
  @media print {
    * {
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
      color-adjust: exact !important;
    }
    
    body {
      background: white !important;
      margin: 0 !important;
      padding: 0 !important;
    }
    
    .loading-overlay,
    .page-container,
    nav-component,
    #printTip {
      display: none !important;
    }
    
    .baseball-card-container {
      display: block !important;
      width: 100%;
      padding-top: 0.25in;
    }
    
    .baseball-card {
      box-shadow: none;
      margin-bottom: 0;
    }
    
    .card-page {
      page-break-after: always;
      page-break-inside: avoid;
    }
    
    .card-back-page {
      page-break-before: always;
    }
    
    /* Add borders around sections for structure even without backgrounds */
    .card-team-banner {
      border-bottom: 3px solid #2d5016;
      min-height: 40px;
    }
    
    .card-player-info {
      border-top: 3px solid #2d5016;
      border-bottom: 2px solid #2d5016;
      min-height: 70px;
    }
    
    .card-footer {
      border-top: 2px solid #8B4513;
    }
    
    /* White text for elements on colored backgrounds - requires "Background graphics" enabled */
    /* Team banner - white text on green background */
    .card-team-name {
      color: #ffffff !important;
    }
    
    .card-league-name {
      color: #ffffff !important;
    }
    
    /* Player info section - white text on green background */
    .card-player-name {
      color: #ffffff !important;
      font-size: 22px !important;
    }
    
    .card-player-nickname {
      color: #ffffff !important;
      display: block;
    }
    
    .card-player-position {
      color: #ffffff !important;
    }
    
    /* Footer - dark brown text */
    .card-footer {
      color: #5c3310 !important;
    }
    
    .card-footer-year {
      color: #5c3310 !important;
    }
    
    /* Number badge - keep dark */
    .card-player-number {
      color: #333333 !important;
      border: 3px solid #8B4513 !important;
    }
    
    /* Captain star */
    .card-captain-star {
      font-size: 28px !important;
    }
    
    /* Stats - bold dark green */
    .card-stat-value {
      color: #1a4010 !important;
      font-weight: 900 !important;
      font-size: 18px !important;
    }
    
    .card-stat-label {
      color: #333333 !important;
      font-weight: 600 !important;
    }
    
    /* Photo placeholder */
    .card-photo-placeholder {
      color: #2d5016 !important;
      border: 4px solid #2d5016 !important;
    }
    
    /* ========================================
       Card Back Print Styles
       ======================================== */
    
    .card-back-header {
      border-bottom: 3px solid #2d5016;
    }
    
    .card-back-name {
      color: #ffffff !important;
    }
    
    .card-back-team {
      color: #ffffff !important;
    }
    
    .card-back-number {
      color: #8B4513 !important;
    }
    
    .card-back-vitals {
      border-bottom: 2px solid #8B4513;
    }
    
    .vital-label {
      color: #666666 !important;
    }
    
    .vital-value {
      color: #1a4010 !important;
    }
    
    .card-back-stats-title {
      color: #8B4513 !important;
    }
    
    .card-back-stats-section {
      padding: 6px 3px !important;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    
    .card-back-stats-table {
      width: 100% !important;
      min-width: 100% !important;
      max-width: 100% !important;
      table-layout: fixed !important;
      display: table !important;
    }
    
    .card-back-stats-table th {
      color: #1a4010 !important;
      background-color: transparent !important;
      border-bottom: 2px solid #2d5016;
      padding: 4px 1px !important;
      font-size: 7px !important;
      box-sizing: border-box !important;
    }
    
    .card-back-stats-table td {
      color: #333333 !important;
      padding: 3px 1px !important;
      font-size: 8px !important;
      box-sizing: border-box !important;
    }
    
    .card-back-stats-table tfoot td {
      color: #1a4010 !important;
      border-top: 2px solid #8B4513;
    }
    
    .card-back-footer {
      border-top: 2px solid #8B4513;
    }
    
    .card-back-logo {
      color: #5c3310 !important;
    }
    
    .card-back-copyright {
      color: #8B4513 !important;
    }
  }
  
  @media (max-width: 768px) {
    body {
      padding: 10px;
    }
    
    .page-container {
      padding: 0 1rem;
    }
    
    .player-header {
      flex-direction: column;
      text-align: center;
      padding: 2rem 1.5rem;
    }
    
    .player-name-section {
      flex-direction: column;
      gap: 10px;
      align-items: center;
    }
    
    .player-name-text h1 {
      font-size: 2rem;
    }
    
    .player-details,
    .player-details-row2 {
      grid-template-columns: 1fr;
    }
    
    .chef-achievements {
      grid-template-columns: 1fr;
    }
    
    .awards-grid {
      grid-template-columns: 1fr;
    }
    
    .stats-section h2 {
      font-size: 1.3em;
      padding: 1rem;
    }
    
    th, td {
      padding: 10px 8px;
      font-size: 0.85em;
    }
  }
</style>
<link rel="stylesheet" href="mobile-enhancements.css">
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>

<div class="page-container">
  <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 2rem;">
    <button class="back-button" onclick="window.history.back()" style="margin-bottom: 0;">‚Üê Back</button>
    <button class="print-card-button" onclick="printBaseballCard()">üñ®Ô∏è Print Card</button>
    <button class="share-card-button" id="shareCardBtn" onclick="sharePlayerCard()">üì§ Share Card</button>
  </div>

  <div class="player-header" id="playerHeader" style="display: none;">
    <div class="player-photo-container">
      <img id="playerPhoto" class="player-photo" alt="Player Photo" onerror="this.style.display='none'; document.getElementById('playerPhotoPlaceholder').classList.remove('hidden');">
      <div id="playerPhotoPlaceholder" class="player-photo-placeholder">‚öæ</div>
      <button id="uploadPlayerPhotoBtn" class="player-photo-upload-btn" title="Upload player photo">üì∑</button>
      <input type="file" id="playerPhotoInput" accept="image/*">
    </div>
    
    <div class="player-info">
      <div class="player-name-section">
        <div id="playerNumber" class="player-number" style="display: none;">#</div>
        <div class="player-name-text">
          <h1 id="playerName">Player Name</h1>
          <div id="playerNickname" class="player-nickname" style="display: none;"></div>
        </div>
      </div>
      
      <div class="player-details" id="playerDetails"></div>
      <div class="player-details-row2" id="playerDetailsRow2"></div>
    </div>
  </div>

  <div class="master-chef-section" id="masterChefSection">
    <div class="master-chef-title">
      <div class="chef-icon">üë®‚Äçüç≥</div>
      <div>
        <h2>Master Chef Recognition</h2>
        <div class="chef-subtitle">The heart and soul of every game day feast</div>
      </div>
    </div>
    
    <div class="chef-achievements">
      <div class="chef-achievement">
        <span class="chef-achievement-icon">üçΩÔ∏è</span>
        <div class="chef-achievement-title">Every Game Chef</div>
        <div class="chef-achievement-desc">Cooks for every single game - rain or shine</div>
      </div>
      
      <div class="chef-achievement">
        <span class="chef-achievement-icon">üë®‚Äçüë¶</span>
        <div class="chef-achievement-title">Team Dad</div>
        <div class="chef-achievement-desc">Father of Andrew Streaman, supporting the next generation</div>
      </div>
      
      <div class="chef-achievement">
        <span class="chef-achievement-icon">üèÜ</span>
        <div class="chef-achievement-title">Culinary MVP</div>
        <div class="chef-achievement-desc">Keeping the team well-fed and energized</div>
      </div>
      
      <div class="chef-achievement">
        <span class="chef-achievement-icon">‚ù§Ô∏è</span>
        <div class="chef-achievement-title">Team Spirit</div>
        <div class="chef-achievement-desc">Bringing everyone together through food</div>
      </div>
    </div>
  </div>

  <div class="awards-section" id="awardsSection" style="display: none;">
    <h2>üèÖ Awards & Recognition</h2>
    <div id="awardsContent"></div>
  </div>

  <div id="statsContainer" style="display: none;">
    <div class="stats-section">
      <h2>Regular Season Stats</h2>
      <table id="regularStatsTable">
        <thead>
          <tr>
            <th>Year</th>
            <th>Season</th>
            <th>Team</th>
            <th>Games</th>
            <th>At Bats</th>
            <th>Hits</th>
            <th>Runs</th>
            <th>Walks</th>
            <th>AcesBPI</th>
            <th>BA</th>
            <th>OBP</th>
            <th>Sub</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="stats-section">
      <h2>Substitute Season Stats</h2>
      <table id="subStatsTable">
        <thead>
          <tr>
            <th>Year</th>
            <th>Season</th>
            <th>Team</th>
            <th>Games</th>
            <th>At Bats</th>
            <th>Hits</th>
            <th>Runs</th>
            <th>Walks</th>
            <th>AcesBPI</th>
            <th>BA</th>
            <th>OBP</th>
            <th>Sub</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="stats-section">
      <h2>Career Stats</h2>
      <table id="careerStatsTable">
        <thead>
          <tr>
            <th>Category</th>
            <th>Games</th>
            <th>At Bats</th>
            <th>Hits</th>
            <th>Runs</th>
            <th>Walks</th>
            <th>Avg AcesBPI</th>
            <th>BA</th>
            <th>OBP</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Baseball Card for Printing -->
<div class="baseball-card-container" id="baseballCardContainer">
  <!-- FRONT OF CARD -->
  <div class="baseball-card card-page">
    <div class="card-front">
      <div class="card-team-banner">
        <div class="card-team-name" id="cardTeamName">Team Name</div>
        <div class="card-league-name">Mountainside Aces Softball League</div>
      </div>
      
      <div class="card-photo-frame">
        <img class="card-photo" id="cardPhoto" alt="Player" style="display: none;">
        <div class="card-photo-placeholder" id="cardPhotoPlaceholder">‚öæ</div>
      </div>
      
      <div class="card-player-info">
        <div class="card-player-number" id="cardPlayerNumber" style="display: none;"></div>
        <div class="card-captain-star" id="cardCaptainStar" style="display: none;">‚≠ê</div>
        <div class="card-player-name" id="cardPlayerName">Player Name</div>
        <div class="card-player-nickname" id="cardPlayerNickname" style="display: none;"></div>
        <div class="card-player-position" id="cardPlayerPosition">Position</div>
      </div>
      
      <div class="card-stats-strip">
        <div class="card-stats-row">
          <div class="card-stat">
            <div class="card-stat-value" id="cardStatGames">0</div>
            <div class="card-stat-label">Games</div>
          </div>
          <div class="card-stat">
            <div class="card-stat-value" id="cardStatBA">.000</div>
            <div class="card-stat-label">AVG</div>
          </div>
          <div class="card-stat">
            <div class="card-stat-value" id="cardStatHits">0</div>
            <div class="card-stat-label">Hits</div>
          </div>
          <div class="card-stat">
            <div class="card-stat-value" id="cardStatRuns">0</div>
            <div class="card-stat-label">Runs</div>
          </div>
          <div class="card-stat">
            <div class="card-stat-value" id="cardStatOBP">.000</div>
            <div class="card-stat-label">OBP</div>
          </div>
        </div>
      </div>
      
      <div class="card-footer">
        <span class="card-footer-year" id="cardCareerYears">Career Years</span> ‚Ä¢ MOUNTAINSIDE ACES
      </div>
    </div>
  </div>
  
  <!-- BACK OF CARD -->
  <div class="baseball-card card-page card-back-page">
    <div class="card-back">
      <div class="card-back-header">
        <div class="card-back-number" id="cardBackNumber"></div>
        <div class="card-back-name" id="cardBackName">Player Name</div>
        <div class="card-back-team" id="cardBackTeam">Team</div>
      </div>
      
      <div class="card-back-vitals">
        <div class="vital-item">
          <span class="vital-label">POS</span>
          <span class="vital-value" id="cardBackPosition">-</span>
        </div>
        <div class="vital-item">
          <span class="vital-label">BATS</span>
          <span class="vital-value" id="cardBackBats">-</span>
        </div>
        <div class="vital-item">
          <span class="vital-label">THROWS</span>
          <span class="vital-value" id="cardBackThrows">-</span>
        </div>
        <div class="vital-item" id="cardBackCaptainVital" style="display: none;">
          <span class="vital-label">ROLE</span>
          <span class="vital-value">Captain ‚≠ê</span>
        </div>
      </div>
      
      <div class="card-back-stats-section">
        <div class="card-back-stats-title">YEAR-BY-YEAR STATISTICS</div>
        <table class="card-back-stats-table">
          <thead>
            <tr>
              <th>YR/SN</th>
              <th>TEAM</th>
              <th>G</th>
              <th>AB</th>
              <th>H</th>
              <th>R</th>
              <th>BB</th>
              <th>AVG</th>
            </tr>
          </thead>
          <tbody id="cardBackStatsBody">
          </tbody>
          <tfoot id="cardBackStatsFoot">
          </tfoot>
        </table>
      </div>
      
      <div class="card-back-footer">
        <div class="card-back-logo">‚öæ MOUNTAINSIDE ACES ‚öæ</div>
        <div class="card-back-copyright">acessoftballreference.com</div>
      </div>
    </div>
  </div>
</div>

<script>
  // Baseball card print functionality
  let baseballCardData = null;
  
  function setBaseballCardData(data) {
    baseballCardData = data;
    console.log('üìá Baseball card data set:', data);
  }
  
  function populateBaseballCard() {
    if (!baseballCardData) {
      console.warn('No baseball card data available');
      return false;
    }
    
    const { stats, info, playerName, careerStats } = baseballCardData;
    console.log('üìá Populating baseball card for:', playerName);
    
    // ========================================
    // FRONT OF CARD
    // ========================================
    
    // Player name
    document.getElementById('cardPlayerName').textContent = playerName;
    
    // Team name (from most recent season)
    const currentTeam = stats[0]?.team || 'Unknown Team';
    document.getElementById('cardTeamName').textContent = currentTeam;
    
    // Player number
    if (info?.number) {
      const numberEl = document.getElementById('cardPlayerNumber');
      numberEl.textContent = info.number;
      numberEl.style.display = 'flex';
    }
    
    // Nickname
    if (info?.nickname) {
      const nicknameEl = document.getElementById('cardPlayerNickname');
      nicknameEl.textContent = `"${info.nickname}"`;
      nicknameEl.style.display = 'block';
    }
    
    // Captain badge
    const isCaptain = info?.captain && info.captain.toLowerCase() === 'yes';
    if (isCaptain) {
      document.getElementById('cardCaptainStar').style.display = 'block';
    }
    
    // Position info
    const position = info?.position || '-';
    const bats = info?.bats || info?.batting || '-';
    const throws = info?.throws || info?.throwing || '-';
    let positionText = position;
    if (bats !== '-' || throws !== '-') {
      positionText += ` ‚Ä¢ ${bats !== '-' ? 'Bats: ' + bats : ''}${bats !== '-' && throws !== '-' ? ' / ' : ''}${throws !== '-' ? 'Throws: ' + throws : ''}`;
    }
    document.getElementById('cardPlayerPosition').textContent = positionText;
    
    // Photo - Use the same photo displayed on the page header
    const pagePhoto = document.getElementById('playerPhoto');
    if (pagePhoto && pagePhoto.src && pagePhoto.classList.contains('loaded')) {
      const photoEl = document.getElementById('cardPhoto');
      photoEl.src = pagePhoto.src;
      photoEl.style.display = 'block';
      document.getElementById('cardPhotoPlaceholder').style.display = 'none';
    } else if (info?.photo) {
      // Fallback to info.photo if page photo not available
      const photoEl = document.getElementById('cardPhoto');
      photoEl.src = info.photo;
      photoEl.style.display = 'block';
      document.getElementById('cardPhotoPlaceholder').style.display = 'none';
    }
    
    // Career years
    const regularStats = stats.filter(s => s.sub === 'No');
    const years = [...new Set(regularStats.map(s => s.year))].sort();
    const careerYearsText = years.length > 0 ? `${years[0]} - ${years[years.length - 1]}` : 'N/A';
    document.getElementById('cardCareerYears').textContent = careerYearsText;
    
    // Stats
    const totals = calculateCardTotals(regularStats);
    document.getElementById('cardStatGames').textContent = totals.games;
    document.getElementById('cardStatHits').textContent = totals.hits;
    document.getElementById('cardStatRuns').textContent = totals.runs;
    document.getElementById('cardStatBA').textContent = totals.BA.toFixed(3);
    document.getElementById('cardStatOBP').textContent = totals.OBP.toFixed(3);
    
    // ========================================
    // BACK OF CARD
    // ========================================
    
    // Header
    document.getElementById('cardBackName').textContent = playerName;
    document.getElementById('cardBackTeam').textContent = currentTeam;
    if (info?.number) {
      document.getElementById('cardBackNumber').textContent = `#${info.number}`;
    }
    
    // Vitals
    document.getElementById('cardBackPosition').textContent = position;
    document.getElementById('cardBackBats').textContent = bats;
    document.getElementById('cardBackThrows').textContent = throws;
    if (isCaptain) {
      document.getElementById('cardBackCaptainVital').style.display = 'block';
    }
    
    // Year-by-year stats table
    const statsBody = document.getElementById('cardBackStatsBody');
    const statsFoot = document.getElementById('cardBackStatsFoot');
    
    // Sort stats chronologically (oldest first for card back)
    const sortedStats = [...regularStats].sort((a, b) => {
      if (a.year !== b.year) return a.year.localeCompare(b.year);
      // Season order: Spring, Summer, Fall
      const seasonOrder = { 'Spring': 1, 'Summer': 2, 'Fall': 3 };
      return (seasonOrder[a.season] || 0) - (seasonOrder[b.season] || 0);
    });
    
    // Build table rows - each season is its own row
    let tableHTML = '';
    sortedStats.forEach(s => {
      const avg = s.atBats > 0 ? (s.hits / s.atBats).toFixed(3) : '.000';
      // Abbreviate team name if too long
      const teamAbbr = s.team.length > 5 ? s.team.substring(0, 4) + '.' : s.team;
      // Abbreviate season
      const seasonAbbr = s.season.substring(0, 2).toUpperCase(); // "Fa", "Su", "Sp"
      tableHTML += `
        <tr>
          <td>${s.year.slice(-2)}${seasonAbbr}</td>
          <td>${teamAbbr}</td>
          <td>${s.games}</td>
          <td>${s.atBats}</td>
          <td>${s.hits}</td>
          <td>${s.runs}</td>
          <td>${s.walks}</td>
          <td>${avg}</td>
        </tr>
      `;
    });
    statsBody.innerHTML = tableHTML;
    
    // Career totals footer
    const careerAvg = totals.atBats > 0 ? (totals.hits / totals.atBats).toFixed(3) : '.000';
    statsFoot.innerHTML = `
      <tr>
        <td>TOT</td>
        <td>-</td>
        <td>${totals.games}</td>
        <td>${totals.atBats}</td>
        <td>${totals.hits}</td>
        <td>${totals.runs}</td>
        <td>${totals.walks}</td>
        <td>${careerAvg}</td>
      </tr>
    `;
    
    return true;
  }
  
  function calculateCardTotals(stats) {
    let games = 0, atBats = 0, hits = 0, runs = 0, walks = 0;
    stats.forEach(s => {
      games += s.games;
      atBats += s.atBats;
      hits += s.hits;
      runs += s.runs;
      walks += s.walks;
    });
    const BA = atBats > 0 ? hits / atBats : 0;
    const OBP = atBats + walks > 0 ? (hits + walks) / (atBats + walks) : 0;
    return { games, atBats, hits, runs, walks, BA, OBP };
  }
  
  function printBaseballCard() {
    const success = populateBaseballCard();
    if (!success) {
      alert('Player data is still loading. Please wait a moment and try again.');
      return;
    }
    
    // Show a brief tip about enabling background graphics
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    const isChrome = /chrome/i.test(navigator.userAgent) && !/edg/i.test(navigator.userAgent);
    
    let tip = '';
    if (isChrome) {
      tip = 'Tip: In the print dialog, click "More settings" and check "Background graphics" for full color printing.';
    } else if (isSafari) {
      tip = 'Tip: In the print dialog, check "Print backgrounds" for full color printing.';
    } else {
      tip = 'Tip: Enable "Print backgrounds" or "Background graphics" in your print settings for full color.';
    }
    
    // Create a toast notification instead of blocking alert
    showPrintTip(tip);
    
    // Small delay to let the tip show before print dialog
    setTimeout(() => {
      window.print();
    }, 100);
  }
  
  function showPrintTip(message) {
    // Remove any existing tip
    const existingTip = document.getElementById('printTip');
    if (existingTip) existingTip.remove();
    
    const tip = document.createElement('div');
    tip.id = 'printTip';
    tip.style.cssText = `
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2d5016;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10000;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      max-width: 90%;
      text-align: center;
    `;
    tip.textContent = message;
    document.body.appendChild(tip);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
      tip.remove();
    }, 5000);
  }
  
  // ========== SHARE CARD ==========
  
  async function sharePlayerCard() {
    const shareBtn = document.getElementById('shareCardBtn');
    const originalText = shareBtn.innerHTML;
    
    try {
      shareBtn.disabled = true;
      shareBtn.innerHTML = '‚è≥ Generating...';
      
      // Populate the card
      const success = populateBaseballCard();
      if (!success) {
        alert('Player data is still loading. Please wait.');
        return;
      }
      
      const cardContainer = document.getElementById('baseballCardContainer');
      const cardFront = cardContainer.querySelector('.card-front');
      const cardBack = cardContainer.querySelector('.card-back');
      
      // IMPORTANT: Hide Firebase photo BEFORE capture to avoid CORS timeout
      const cardPhoto = document.getElementById('cardPhoto');
      const cardPlaceholder = document.getElementById('cardPhotoPlaceholder');
      let photoWasVisible = false;
      let originalPhotoSrc = '';
      
      if (cardPhoto && cardPhoto.src && cardPhoto.src.includes('firebasestorage')) {
        photoWasVisible = cardPhoto.style.display !== 'none';
        originalPhotoSrc = cardPhoto.src;
        cardPhoto.src = '';
        cardPhoto.style.display = 'none';
        if (cardPlaceholder) cardPlaceholder.style.display = 'flex';
      }
      
      // Show card container off-screen for capture
      cardContainer.style.display = 'block';
      cardContainer.style.position = 'fixed';
      cardContainer.style.left = '-9999px';
      cardContainer.style.top = '0';
      
      // Capture both sides (should be fast now without Firebase image)
      const [frontCanvas, backCanvas] = await Promise.all([
        html2canvas(cardFront, { scale: 2, backgroundColor: '#fff' }),
        html2canvas(cardBack, { scale: 2, backgroundColor: '#fff' })
      ]);
      
      // Hide container
      cardContainer.style.display = 'none';
      cardContainer.style.position = '';
      cardContainer.style.left = '';
      cardContainer.style.top = '';
      
      // Restore photo if it was visible
      if (photoWasVisible && originalPhotoSrc) {
        cardPhoto.src = originalPhotoSrc;
        cardPhoto.style.display = 'block';
        if (cardPlaceholder) cardPlaceholder.style.display = 'none';
      }
      
      // Combine side by side
      const gap = 40;
      const combined = document.createElement('canvas');
      combined.width = frontCanvas.width + backCanvas.width + gap;
      combined.height = Math.max(frontCanvas.height, backCanvas.height);
      const ctx = combined.getContext('2d');
      ctx.fillStyle = '#f0f0f0';
      ctx.fillRect(0, 0, combined.width, combined.height);
      ctx.drawImage(frontCanvas, 0, 0);
      ctx.drawImage(backCanvas, frontCanvas.width + gap, 0);
      
      // Create file
      const blob = await new Promise(r => combined.toBlob(r, 'image/png'));
      const playerName = document.getElementById('playerName')?.textContent || 'Player';
      const fileName = `${playerName.replace(/\s+/g, '-')}-player-card.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Share
      shareBtn.innerHTML = 'üì§ Sharing...';
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        await navigator.share({
          files: [file],
          title: `${playerName} - Mountainside Aces`
        });
      } else {
        // Download fallback
        const link = document.createElement('a');
        link.download = fileName;
        link.href = combined.toDataURL('image/png');
        link.click();
      }
      
    } catch (err) {
      if (err.name !== 'AbortError') {
        console.error('Share error:', err);
      }
    } finally {
      shareBtn.disabled = false;
      shareBtn.innerHTML = originalText;
    }
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script type="module">
  import {
    getPlayerStatsOptimized,
    getPlayerInfo,
    getPlayerAwards,
    seasonsObjectToArray,
    resolvePlayerName,
    getPlayerByIdentifier,
    getAllPlayerStatsOptimized,
    db
  } from './firebase-data.js';
  
  import { auth, getUserProfile } from './firebase-auth.js';
  import { uploadPlayerPhoto, deleteOldPlayerPhoto } from './firebase-storage.js';
  import { doc, getDoc, updateDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

  // Track current user and whether they can edit this player's photo
  let currentUser = null;
  let canEditPhoto = false;
  let linkedUserId = null; // The user ID that owns this player page

  const capitalize = (str) => str ? str.charAt(0).toUpperCase() + str.slice(1) : "";

  function formatPlayerName(name) {
    if (!name) return "";
    if (name.includes(' ')) {
      return name.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    if (name.includes('_')) {
      return name.split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }
    return name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();
  }

  const urlParams = new URLSearchParams(window.location.search);
  const playerId = urlParams.get('id');
  const playerName = urlParams.get('name');

  if (!playerId && !playerName) {
    document.getElementById('loadingOverlay').classList.remove('hidden');
    document.getElementById('playerName').textContent = 'No player specified';
    throw new Error('No player identifier in URL');
  }

  function hideLoadingIndicator() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.classList.add('hidden');
    }
    
    document.getElementById('playerHeader').style.display = 'flex';
    document.getElementById('statsContainer').style.display = 'block';
  }

  async function calculateTop10Rankings(playerCareerStats, displayName) {
    if (!playerCareerStats) return [];
    
    console.log('üî¢ Calculating Top 10 rankings for:', displayName);
    const allPlayerStats = await getAllPlayerStatsOptimized();
    const allPlayersArray = [];
    
    allPlayerStats.forEach(player => {
      const seasons = seasonsObjectToArray(player);
      let totalGames = 0, totalAtBats = 0, totalHits = 0, totalRuns = 0, totalWalks = 0;
      let acesWarValues = [];
      
      seasons.forEach(s => {
        totalGames += Number(s.games) || 0;
        totalAtBats += Number(s.atBats) || 0;
        totalHits += Number(s.hits) || 0;
        totalRuns += Number(s.runs) || 0;
        totalWalks += Number(s.walks) || 0;
        if (typeof s.acesBPI === 'number') {
          acesWarValues.push(s.acesBPI);
        }
      });
      
      const plateAppearances = totalAtBats + totalWalks;
      const battingAverage = totalAtBats > 0 ? totalHits / totalAtBats : 0;
      const onBasePercentage = plateAppearances > 0 ? (totalHits + totalWalks) / plateAppearances : 0;
      const avgAcesWar = acesWarValues.length > 0 ? acesWarValues.reduce((a, b) => a + b, 0) / acesWarValues.length : 0;
      
      allPlayersArray.push({
        name: player.name || player.displayName,
        totalGames,
        totalAtBats,
        totalHits,
        totalRuns,
        totalWalks,
        plateAppearances,
        battingAverage,
        onBasePercentage,
        avgAcesWar,
        acesWarValues
      });
    });
    
    const rankings = [];
    
    const categories = [
      { name: "Career Games", stat: "totalGames", format: (val) => val.toString(), minimum: 0 },
      { name: "Career At-Bats", stat: "totalAtBats", format: (val) => val.toString(), minimum: 0 },
      { name: "Career Hits", stat: "totalHits", format: (val) => val.toString(), minimum: 0 },
      { name: "Career Runs", stat: "totalRuns", format: (val) => val.toString(), minimum: 0 },
      { name: "Career Walks", stat: "totalWalks", format: (val) => val.toString(), minimum: 0 },
      { name: "Career Batting Average", stat: "battingAverage", format: (val) => val.toFixed(3), minimum: 150, minimumField: "plateAppearances" },
      { name: "Career On-Base Percentage", stat: "onBasePercentage", format: (val) => val.toFixed(3), minimum: 150, minimumField: "plateAppearances" },
      { name: "Career Average AcesBPI", stat: "avgAcesWar", format: (val) => val.toFixed(2), minimum: 0, filter: (p) => p.acesWarValues.length > 0 }
    ];
    
    categories.forEach(category => {
      let qualifyingPlayers = allPlayersArray.filter(p => {
        if (category.filter && !category.filter(p)) return false;
        if (category.minimumField) {
          return p[category.minimumField] >= category.minimum;
        }
        return p[category.stat] >= category.minimum;
      });
      
      qualifyingPlayers.sort((a, b) => b[category.stat] - a[category.stat]);
      
      const playerRank = qualifyingPlayers.findIndex(p => p.name === displayName) + 1;
      
      if (playerRank > 0 && playerRank <= 10) {
        rankings.push({
          category: category.name,
          rank: playerRank,
          value: category.format(playerCareerStats[category.stat]),
          rawValue: playerCareerStats[category.stat]
        });
      }
    });
    
    rankings.sort((a, b) => a.rank - b.rank);
    
    console.log('‚úÖ Found', rankings.length, 'Top 10 rankings');
    return rankings;
  }

  async function populateAwards(awards, displayName, careerStats) {
    const awardsSection = document.getElementById('awardsSection');
    const awardsContent = document.getElementById('awardsContent');
    
    console.log('üèÜ Populating awards for:', displayName);
    const top10Rankings = await calculateTop10Rankings(careerStats, displayName);
    
    if (awards.length === 0 && top10Rankings.length === 0) {
      console.log('‚ÑπÔ∏è No awards or Top 10 rankings to display');
      return;
    }
    
    let html = '';
    
    if (top10Rankings.length > 0) {
      html += `
        <div style="margin-bottom: 30px;">
          <h3 style="background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%); color: white; padding: 12px 18px; margin: 0 0 20px 0; border-radius: 12px; font-size: 1.3em; box-shadow: 0 4px 8px rgba(255,165,0,0.3);">
            ‚≠ê All-Time Top 10 Rankings
          </h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
      `;
      
      top10Rankings.forEach(ranking => {
        const medalEmoji = ranking.rank === 1 ? 'ü•á' : ranking.rank === 2 ? 'ü•à' : ranking.rank === 3 ? 'ü•â' : 'üèÖ';
        
        html += `
          <div style="border: 3px solid #ffa500; border-radius: 12px; padding: 20px; text-align: center; background: linear-gradient(135deg, #fff8e1 0%, #ffe0b2 100%); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: transform 0.2s ease;">
            <div style="font-size: 3em; margin-bottom: 10px;">${medalEmoji}</div>
            <div style="background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%); color: white; padding: 6px 12px; border-radius: 8px; font-weight: bold; margin-bottom: 12px; font-size: 1.1em;">
              #${ranking.rank}
            </div>
            <div style="font-size: 0.95em; color: #666; margin-bottom: 8px; font-weight: 600;">${ranking.category}</div>
            <div style="font-size: 1.3em; font-weight: bold; color: #2d5016;">${ranking.value}</div>
          </div>
        `;
      });
      
      html += '</div></div>';
    }
    
    if (awards.length > 0) {
      html += `
        <div>
          <h3 style="background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%); color: white; padding: 12px 18px; margin: 0 0 20px 0; border-radius: 12px; font-size: 1.3em; box-shadow: 0 4px 8px rgba(45,80,22,0.3);">
            üèÜ Career Awards & Honors
          </h3>
          <div class="awards-grid">
      `;
      
      const awardIcons = {
        'Team MVP': 'team_mvp.png',
        'All Aces': 'all_aces.png',
        'Gold Glove': 'gold_glove.png',
        'Team of the Year': 'team_of_the_year.png',
        'Rookie of the Year': 'rookie_of_the_year.png',
        'Most Improved Ace': 'most_improved_ace.png',
        'Comeback Player of the Year': 'comeback_player.png',
        'Slugger of the Year': 'slugger_of_the_year.png',
        'Pitcher of the Year': 'pitcher_of_the_year.png',
        'Captain of the Year': 'captain_of_the_year.png',
        'Al Pineda Good Guy Award': 'al_pineda_good_guy_award.png',
        'Iron Man Award': 'iron_man_award.png',
        'Sub of the Year': 'sub_of_the_year.png',
        'Andrew Streaman Boner Award': 'andrew_streaman_boner_award.png',
        'Erik Lund Perservenance Award': 'erik_lund_perservenance_award.png',
        'Mr. Streaman Award for Excellence': 'mr_streaman_award_for_excellence.png'
      };
      
      const fallbackEmojis = {
        'Team MVP': 'üëë',
        'All Aces': '‚≠ê',
        'Gold Glove': 'ü•á',
        'Team of the Year': 'üèÜ',
        'Rookie of the Year': 'üåü',
        'Most Improved Ace': 'üìà',
        'Comeback Player of the Year': 'üîÑ',
        'Slugger of the Year': 'üí™',
        'Pitcher of the Year': 'ü•é',
        'Captain of the Year': 'üéñÔ∏è',
        'Al Pineda Good Guy Award': 'ü§ù',
        'Iron Man Award': 'üíØ',
        'Sub of the Year': 'üÖøÔ∏è',
        'Andrew Streaman Boner Award': 'üé™',
        'Erik Lund Perservenance Award': '‚ö°',
        'Mr. Streaman Award for Excellence': 'üåü'
      };
      
      awards.forEach(award => {
        const season = award.season ? award.season.charAt(0).toUpperCase() + award.season.slice(1) : '';
        const awardType = award.category || 'Award';
        const iconFile = awardIcons[awardType];
        const fallbackEmoji = fallbackEmojis[awardType] || 'üèÜ';
        
        html += `
          <div class="award-item">
            ${iconFile ? 
              `<img src="awards/${iconFile}" alt="${awardType}" class="award-icon" onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"><span class="award-icon fallback" style="display: none;">${fallbackEmoji}</span>` :
              `<span class="award-icon fallback">${fallbackEmoji}</span>`
            }
            <div class="award-details">
              <div class="award-name">${awardType}</div>
              <div class="award-season">${award.year} ${season}</div>
            </div>
          </div>
        `;
      });
      
      html += '</div></div>';
    }
    
    awardsContent.innerHTML = html;
    awardsSection.style.display = 'block';
  }

  async function loadPlayerData() {
    const loadStartTime = performance.now();
    console.log(`‚ö° Loading data for: ${playerId ? `ID=${playerId}` : `name=${playerName}`}`);
    console.time('Total Load Time');

    try {
      console.time('Resolve Player');
      let resolvedPlayer;
      let isNewUser = false;
      
      if (playerId) {
        resolvedPlayer = await getPlayerStatsOptimized(playerId);
        
        if (!resolvedPlayer || resolvedPlayer.migrated) {
          console.warn('‚ö†Ô∏è Player ID not found in aggregatedPlayerStats or is migrated');
          
          console.log('üîç Checking users collection for new user...');
          const { getUserProfile } = await import('./firebase-auth.js');
          const userResult = await getUserProfile(playerId);
          
          if (userResult.success && userResult.data) {
            console.log('‚úÖ Found user profile:', userResult.data);
            
            if (userResult.data.linkedPlayer) {
              console.log('üîó User has linkedPlayer:', userResult.data.linkedPlayer);
              resolvedPlayer = await resolvePlayerName(userResult.data.linkedPlayer);
              
              if (resolvedPlayer) {
                console.log('‚úÖ Found player by linkedPlayer name:', resolvedPlayer.name);
              }
            }
            
            if (!resolvedPlayer) {
              console.log('üÜï Creating placeholder for new user (not yet aggregated)');
              isNewUser = true;
              resolvedPlayer = {
                id: playerId,
                name: userResult.data.displayName || userResult.data.preferredDisplayName || userResult.data.linkedPlayer || 'New User',
                currentTeam: userResult.data.linkedTeam || 'Not assigned',
                seasons: {},
                career: {
                  games: 0,
                  atBats: 0,
                  hits: 0,
                  runs: 0,
                  walks: 0,
                  battingAverage: 0,
                  onBasePercentage: 0
                }
              };
            }
          } else {
            console.log('‚ö†Ô∏è Not in users collection, trying ID as player name');
            resolvedPlayer = await resolvePlayerName(playerId);
          }
        }
      } else {
        resolvedPlayer = await resolvePlayerName(playerName);
      }
      
      console.timeEnd('Resolve Player');
      
      if (!resolvedPlayer) {
        console.error('‚ùå Could not resolve player');
        hideLoadingIndicator();
        document.getElementById('playerHeader').style.display = 'flex';
        document.getElementById('playerName').textContent = `Player "${playerName || playerId}" not found`;
        return;
      }
      
      console.log(`‚úÖ Resolved to: "${resolvedPlayer.name}" (ID: ${resolvedPlayer.id})`);
      
      if (playerName && !playerId && !isNewUser) {
        const newUrl = `${window.location.pathname}?id=${resolvedPlayer.id}`;
        window.history.replaceState({}, '', newUrl);
        console.log('üîÑ Updated URL to ID-based');
      }
      
      const displayName = resolvedPlayer.name || resolvedPlayer.displayName;
      document.getElementById('pageTitle').textContent = `${displayName} - Player Stats`;
      
      if (isNewUser) {
        const playerHeader = document.getElementById('playerHeader');
        const statsContainer = document.getElementById('statsContainer');
        
        document.getElementById('playerName').textContent = displayName;
        
        const detailsContainer = document.getElementById('playerDetails');
        detailsContainer.innerHTML = `
          <div class="detail-item">
            <div class="detail-label">Team</div>
            <div class="detail-value">${resolvedPlayer.currentTeam}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">New Player</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Career</div>
            <div class="detail-value">Pending</div>
          </div>
        `;
        
        document.getElementById('playerDetailsRow2').innerHTML = `
          <div class="detail-item">
            <div class="detail-label">Batting</div>
            <div class="detail-value">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Throwing</div>
            <div class="detail-value">-</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Position</div>
            <div class="detail-value">-</div>
          </div>
        `;
        
        document.getElementById('playerHeader').style.display = 'flex';
        
        statsContainer.innerHTML = `
          <div class="stats-section">
            <h2>Welcome to Mountainside Aces!</h2>
            <div style="padding: 3rem 2rem; text-align: center;">
              <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">‚öæ</div>
              <h3 style="font-size: 1.5rem; margin-bottom: 1rem; color: #2d3748;">No Stats Yet</h3>
              <p style="color: #718096; font-size: 1.1rem; line-height: 1.6; max-width: 600px; margin: 0 auto;">
                Your player statistics will appear here once you've been added to the roster and stats have been recorded. 
                Check back after your first game, or contact your team captain for more information.
              </p>
            </div>
          </div>
        `;
        statsContainer.style.display = 'block';
        hideLoadingIndicator();
        return;
      }
      
      console.time('Fetch Additional Data');
      const [playerInfo, playerAwards] = await Promise.all([
        getPlayerInfo(displayName).catch(() => null),
        getPlayerAwards(displayName).catch(() => [])
      ]);
      console.timeEnd('Fetch Additional Data');

      if (!resolvedPlayer.seasons || typeof resolvedPlayer.seasons !== 'object') {
        console.warn('‚ö†Ô∏è No seasons data found');
        hideLoadingIndicator();
        return;
      }

      console.time('Process Player Data');
      const allStats = [];
      const seasonsArray = seasonsObjectToArray(resolvedPlayer);
      
      seasonsArray.forEach(season => {
        let year = "";
        let seasonName = "";
        if (season.seasonId) {
          const parts = season.seasonId.split('-');
          if (parts.length >= 2) {
            year = parts[0];
            seasonName = parts[1];
          }
        }
        if (!year && season.year) year = season.year;
        if (!seasonName && season.season) seasonName = season.season;
        
        // Determine if this is a sub season
        const isSub = season.sub === 'Yes' || season.sub === 'yes' || season.sub === true;
        
        // Force N/A for sub seasons regardless of stored value
        let acesBPIValue;
        if (isSub) {
          acesBPIValue = "N/A";
        } else if (typeof season.acesBPI === 'number') {
          acesBPIValue = season.acesBPI;
        } else if (season.acesBPI === "N/A") {
          acesBPIValue = "N/A";
        } else {
          acesBPIValue = Number(season.acesBPI) || 0;
        }
        
        allStats.push({
          name: formatPlayerName(resolvedPlayer.name || resolvedPlayer.displayName || resolvedPlayer.userId),
          team: capitalize(season.team || resolvedPlayer.currentTeam || ""),
          year: year,
          season: capitalize(seasonName),
          games: Number(season.games) || 0,
          atBats: Number(season.atBats) || 0,
          hits: Number(season.hits) || 0,
          runs: Number(season.runs) || 0,
          walks: Number(season.walks) || 0,
          AcesWar: acesBPIValue,
          BA: season.battingAverage || 0,
          OBP: season.onBasePercentage || 0,
          sub: isSub ? "Yes" : "No"
        });
      });

      console.log(`‚úÖ Processed ${allStats.length} batting season records`);
      console.timeEnd('Process Player Data');

      const seasonOrder = { 'Fall': 3, 'Summer': 2, 'Spring': 1 };
      allStats.sort((a, b) => {
        if (a.year !== b.year) return b.year.localeCompare(a.year);
        const seasonA = seasonOrder[a.season] || 0;
        const seasonB = seasonOrder[b.season] || 0;
        return seasonB - seasonA;
      });

      const careerStats = {
        totalGames: resolvedPlayer.career?.games || 0,
        totalAtBats: resolvedPlayer.career?.atBats || 0,
        totalHits: resolvedPlayer.career?.hits || 0,
        totalRuns: resolvedPlayer.career?.runs || 0,
        totalWalks: resolvedPlayer.career?.walks || 0,
        battingAverage: resolvedPlayer.career?.battingAverage || 0,
        onBasePercentage: resolvedPlayer.career?.onBasePercentage || 0,
        avgAcesWar: resolvedPlayer.career?.acesBPI || 0,
        plateAppearances: (resolvedPlayer.career?.atBats || 0) + (resolvedPlayer.career?.walks || 0),
        acesWarValues: seasonsArray
          .map(s => s.acesBPI)
          .filter(v => typeof v === 'number')
      };

      const combinedData = {
        stats: allStats,
        info: playerInfo,
        awards: playerAwards,
        playerId: resolvedPlayer.id,
        playerName: displayName,
        careerStats: careerStats
      };
      
      await renderPlayerData(combinedData);
      hideLoadingIndicator();

      const loadEndTime = performance.now();
      console.timeEnd('Total Load Time');
      console.log(`üéØ Page loaded in ${(loadEndTime - loadStartTime).toFixed(0)}ms`);

    } catch (error) {
      console.error('‚ùå Error loading player data:', error);
      hideLoadingIndicator();
    }
  }

  async function renderPlayerData(playerData) {
    const { stats, info, awards, playerId, playerName, careerStats } = playerData;
    if (stats.length === 0) return;
    
    // Store data for baseball card printing
    if (typeof setBaseballCardData === 'function') {
      setBaseballCardData(playerData);
    }
    
    await populatePlayerHeader(stats, info, playerName, playerId);
    populateStatsTables(stats, playerId, careerStats);
    handleMasterChefSection(playerName);
    if ((awards && awards.length > 0) || careerStats) {
      await populateAwards(awards, playerName, careerStats);
    }
  }

  async function populatePlayerHeader(stats, info, displayName, playerId) {
    document.getElementById('playerName').textContent = displayName;
    const regularStats = stats.filter(s => s.sub === 'No');
    const years = [...new Set(regularStats.map(s => s.year))].sort();
    const totalSeasons = regularStats.length;
    const currentTeam = stats[0]?.team || 'N/A';

    const detailsContainer = document.getElementById('playerDetails');
    detailsContainer.innerHTML = `
      <div class="detail-item">
        <div class="detail-label">Team</div>
        <div class="detail-value">${currentTeam}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Career</div>
        <div class="detail-value">${years.length > 0 ? `${years[0]} - ${years[years.length - 1]}` : 'N/A'}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Total Seasons</div>
        <div class="detail-value">${totalSeasons}</div>
      </div>
    `;

    const row2Container = document.getElementById('playerDetailsRow2');
    const bats = info?.bats || info?.batting || '-';
    const throws = info?.throws || info?.throwing || '-';
    const position = info?.position || '-';

    row2Container.innerHTML = `
      <div class="detail-item">
        <div class="detail-label">Batting</div>
        <div class="detail-value">${bats}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Throwing</div>
        <div class="detail-value">${throws}</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Position</div>
        <div class="detail-value">${position}</div>
      </div>
    `;

    if (info?.number) {
      const numberElement = document.getElementById('playerNumber');
      numberElement.textContent = `#${info.number}`;
      numberElement.style.display = 'block';
    }

    if (info?.nickname) {
      const nicknameElement = document.getElementById('playerNickname');
      nicknameElement.textContent = `"${info.nickname}"`;
      nicknameElement.style.display = 'block';
    }

    if (info?.captain && info.captain.toLowerCase() === 'yes') {
      const nameSection = document.querySelector('.player-name-section');
      const captainBadge = document.createElement('div');
      captainBadge.className = 'captain-badge';
      captainBadge.textContent = 'Captain';
      nameSection.appendChild(captainBadge);
    }

    // Look for player photo in users collection
    // First try to find a user linked to this player by name
    let playerPhotoURL = null;
    const photoElement = document.getElementById('playerPhoto');
    const placeholderElement = document.getElementById('playerPhotoPlaceholder');
    
    try {
      // Try to find user by linkedPlayer matching displayName
      const usersRef = collection(db, 'users');
      const q = query(usersRef, where('linkedPlayer', '==', displayName));
      const querySnapshot = await getDocs(q);
      
      if (!querySnapshot.empty) {
        const userDoc = querySnapshot.docs[0];
        const userData = userDoc.data();
        linkedUserId = userDoc.id;
        
        console.log('üîó Found linked user for player:', displayName, 'userId:', linkedUserId);
        
        // Check for player photo first, then fall back to profile photo
        if (userData.playerPhotoURL) {
          playerPhotoURL = userData.playerPhotoURL;
          console.log('üì∏ Using playerPhotoURL:', playerPhotoURL);
        } else if (userData.profilePhotoURL) {
          playerPhotoURL = userData.profilePhotoURL;
          console.log('üì∏ Using profilePhotoURL as fallback:', playerPhotoURL);
        }
      }
      
      // Also check if playerId directly matches a user document
      if (!linkedUserId && playerId) {
        const directUserDoc = await getDoc(doc(db, 'users', playerId));
        if (directUserDoc.exists()) {
          const userData = directUserDoc.data();
          linkedUserId = playerId;
          
          if (userData.playerPhotoURL) {
            playerPhotoURL = userData.playerPhotoURL;
          } else if (userData.profilePhotoURL) {
            playerPhotoURL = userData.profilePhotoURL;
          }
        }
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Error fetching user photo:', error);
    }
    
    // Fall back to info.photo if no user photo found
    if (!playerPhotoURL && info?.photo) {
      playerPhotoURL = info.photo;
      console.log('üì∏ Using info.photo:', playerPhotoURL);
    }

    if (playerPhotoURL) {
      photoElement.src = playerPhotoURL;
      photoElement.style.display = 'block';
      photoElement.classList.add('loaded');
      placeholderElement.classList.add('hidden');
    } else {
      photoElement.style.display = 'none';
      placeholderElement.classList.remove('hidden');
    }
    
    // Check if current user can edit this player's photo
    checkPhotoEditPermission();
  }

  function populateStatsTables(stats, playerId, careerStats) {
    const regularStats = stats.filter(s => s.sub === 'No');
    const regularTbody = document.querySelector('#regularStatsTable tbody');
    regularTbody.innerHTML = regularStats.map(s => `
      <tr>
        <td>${s.year}</td>
        <td>${s.season}</td>
        <td><a href="team.html?team=${encodeURIComponent(s.team)}" class="team-link">${s.team}</a></td>
        <td>${s.games}</td>
        <td>${s.atBats}</td>
        <td>${s.hits}</td>
        <td>${s.runs}</td>
        <td>${s.walks}</td>
        <td>${typeof s.AcesWar === 'number' ? s.AcesWar.toFixed(2) : 'N/A'}</td>
        <td>${typeof s.BA === 'number' ? s.BA.toFixed(3) : 'N/A'}</td>
        <td>${typeof s.OBP === 'number' ? s.OBP.toFixed(3) : 'N/A'}</td>
        <td>${s.sub}</td>
      </tr>
    `).join('');

    const subStats = stats.filter(s => s.sub === 'Yes');
    const subTbody = document.querySelector('#subStatsTable tbody');
    if (subStats.length > 0) {
      subTbody.innerHTML = subStats.map(s => `
        <tr>
          <td>${s.year}</td>
          <td>${s.season}</td>
          <td><a href="team.html?team=${encodeURIComponent(s.team)}" class="team-link">${s.team}</a></td>
          <td>${s.games}</td>
          <td>${s.atBats}</td>
          <td>${s.hits}</td>
          <td>${s.runs}</td>
          <td>${s.walks}</td>
          <td>${typeof s.AcesWar === 'number' ? s.AcesWar.toFixed(2) : 'N/A'}</td>
          <td>${typeof s.BA === 'number' ? s.BA.toFixed(3) : 'N/A'}</td>
          <td>${typeof s.OBP === 'number' ? s.OBP.toFixed(3) : 'N/A'}</td>
          <td><span class="sub-yes">${s.sub}</span></td>
        </tr>
      `).join('');
    } else {
      subTbody.innerHTML = '<tr><td colspan="12">No substitute stats</td></tr>';
    }

    calculateCareerStats(stats, careerStats);
  }

  function calculateCareerStats(stats, careerStats) {
    const careerTbody = document.querySelector('#careerStatsTable tbody');
    const regularStats = stats.filter(s => s.sub === 'No');
    const regularTotals = calculateTotals(regularStats);
    const careerTotals = calculateTotals(stats);
    
    // Use pre-calculated avgAcesWar from Firebase if available (only for regular seasons)
    // This is the authoritative value calculated during aggregation
    const regularAvgAcesWar = careerStats?.avgAcesWar ?? regularTotals.avgAcesWar;

    careerTbody.innerHTML = `
      <tr>
        <td><strong>Regular Season</strong></td>
        <td>${regularTotals.games}</td>
        <td>${regularTotals.atBats}</td>
        <td>${regularTotals.hits}</td>
        <td>${regularTotals.runs}</td>
        <td>${regularTotals.walks}</td>
        <td>${regularAvgAcesWar.toFixed(2)}</td>
        <td>${regularTotals.BA.toFixed(3)}</td>
        <td>${regularTotals.OBP.toFixed(3)}</td>
      </tr>
      <tr>
        <td><strong>Career Total</strong></td>
        <td>${careerTotals.games}</td>
        <td>${careerTotals.atBats}</td>
        <td>${careerTotals.hits}</td>
        <td>${careerTotals.runs}</td>
        <td>${careerTotals.walks}</td>
        <td>${regularAvgAcesWar.toFixed(2)}</td>
        <td>${careerTotals.BA.toFixed(3)}</td>
        <td>${careerTotals.OBP.toFixed(3)}</td>
      </tr>
    `;
  }

  function calculateTotals(stats) {
    let games = 0, atBats = 0, hits = 0, runs = 0, walks = 0;
    let acesWarSum = 0, acesWarCount = 0;

    stats.forEach(s => {
      games += s.games;
      atBats += s.atBats;
      hits += s.hits;
      runs += s.runs;
      walks += s.walks;
      if (typeof s.AcesWar === 'number') {
        acesWarSum += s.AcesWar;
        acesWarCount++;
      }
    });

    const BA = atBats > 0 ? hits / atBats : 0;
    const OBP = atBats + walks > 0 ? (hits + walks) / (atBats + walks) : 0;
    const avgAcesWar = acesWarCount > 0 ? acesWarSum / acesWarCount : 0;

    return { games, atBats, hits, runs, walks, BA, OBP, avgAcesWar };
  }

  function handleMasterChefSection(displayName) {
    const chefSection = document.getElementById('masterChefSection');
    if (displayName === 'Mike Streaman') {
      chefSection.style.display = 'block';
      setTimeout(() => {
        chefSection.style.transition = 'transform 0.3s ease';
        chefSection.style.transform = 'scale(1.02)';
        setTimeout(() => {
          chefSection.style.transform = 'scale(1)';
        }, 200);
      }, 500);
    }
  }

  // ========================================
  // PHOTO EDIT PERMISSION & UPLOAD HANDLING
  // ========================================
  
  // Listen for auth state changes
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    console.log('üîê Auth state changed:', user ? user.uid : 'logged out');
    checkPhotoEditPermission();
  });
  
  // Check if current user can edit this player's photo
  async function checkPhotoEditPermission() {
    const uploadBtn = document.getElementById('uploadPlayerPhotoBtn');
    
    if (!currentUser || !linkedUserId) {
      canEditPhoto = false;
      uploadBtn.classList.remove('visible');
      return;
    }
    
    try {
      // User can edit if they are the linked user OR if they are an admin
      if (currentUser.uid === linkedUserId) {
        canEditPhoto = true;
        console.log('‚úÖ User can edit their own player photo');
      } else {
        // Check if current user is admin
        const currentUserDoc = await getDoc(doc(db, 'users', currentUser.uid));
        if (currentUserDoc.exists()) {
          const userData = currentUserDoc.data();
          canEditPhoto = userData.userRole === 'admin' || userData.role === 'admin';
          if (canEditPhoto) {
            console.log('‚úÖ Admin can edit any player photo');
          }
        }
      }
      
      if (canEditPhoto) {
        uploadBtn.classList.add('visible');
      } else {
        uploadBtn.classList.remove('visible');
      }
    } catch (error) {
      console.error('‚ùå Error checking photo edit permission:', error);
      canEditPhoto = false;
      uploadBtn.classList.remove('visible');
    }
  }
  
  // Setup photo upload handler
  function setupPhotoUploadHandler() {
    const uploadBtn = document.getElementById('uploadPlayerPhotoBtn');
    const photoInput = document.getElementById('playerPhotoInput');
    
    if (!uploadBtn || !photoInput) return;
    
    uploadBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (canEditPhoto) {
        photoInput.click();
      }
    });
    
    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file || !canEditPhoto || !linkedUserId) return;
      
      console.log('üì∏ Player photo selected:', file.name);
      
      // Validate file
      if (!file.type.startsWith('image/')) {
        alert('Please select an image file');
        return;
      }
      
      if (file.size > 5 * 1024 * 1024) {
        alert('Player photo must be less than 5MB');
        return;
      }
      
      // Show loading state
      uploadBtn.disabled = true;
      uploadBtn.textContent = '‚è≥';
      uploadBtn.style.cursor = 'wait';
      
      try {
        console.log('üì§ Uploading player photo for user:', linkedUserId);
        
        // Upload the photo
        const result = await uploadPlayerPhoto(file, linkedUserId, (progress) => {
          console.log(`Upload progress: ${progress.toFixed(1)}%`);
        });
        
        console.log('‚úÖ Player photo uploaded:', result.downloadURL);
        
        // Get current user doc to check for old photo
        const userDocRef = doc(db, 'users', linkedUserId);
        const userDoc = await getDoc(userDocRef);
        const userData = userDoc.data();
        
        // Delete old player photo if exists
        if (userData?.playerPhotoStoragePath) {
          try {
            await deleteOldPlayerPhoto(userData.playerPhotoStoragePath);
          } catch (error) {
            console.warn('Could not delete old player photo:', error);
          }
        }
        
        // Update user profile in Firestore
        await updateDoc(userDocRef, {
          playerPhotoURL: result.downloadURL,
          playerPhotoStoragePath: result.storagePath,
          playerPhotoUpdatedAt: new Date()
        });
        
        console.log('‚úÖ User profile updated with player photo');
        
        // Update the displayed photo
        const photoElement = document.getElementById('playerPhoto');
        const placeholderElement = document.getElementById('playerPhotoPlaceholder');
        
        photoElement.src = result.downloadURL;
        photoElement.style.display = 'block';
        photoElement.classList.add('loaded');
        placeholderElement.classList.add('hidden');
        
        // Show success feedback
        uploadBtn.textContent = '‚úÖ';
        setTimeout(() => {
          uploadBtn.textContent = 'üì∑';
          uploadBtn.disabled = false;
          uploadBtn.style.cursor = 'pointer';
        }, 2000);
        
      } catch (error) {
        console.error('‚ùå Error uploading player photo:', error);
        alert('Failed to upload player photo: ' + error.message);
        uploadBtn.textContent = 'üì∑';
        uploadBtn.disabled = false;
        uploadBtn.style.cursor = 'pointer';
      }
      
      // Reset file input
      photoInput.value = '';
    });
  }
  
  // Initialize photo upload handler when DOM is ready
  setupPhotoUploadHandler();

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadPlayerData);
  } else {
    loadPlayerData();
  }

</script>
<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>
<script src="mobile-enhancements.js"></script>
</body>
</html>