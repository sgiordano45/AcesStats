<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Your Profile - Mountainside Aces</title>
  <meta name="theme-color" content="#2d5016">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="stylesheet" href="nav-styles.css">
  
  <style>
    :root {
      --primary-color: #2d5016;
      --secondary-color: #1a6b4a;
      --accent-color: #ffd700;
      --card-bg: #ffffff;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --success-color: #10b981;
      --success-bg: #d1fae5;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      line-height: 1.6;
      color: var(--text-dark);
      min-height: 100vh;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      font-size: 60px;
      animation: spin 1.5s ease-in-out infinite;
    }
    
    .loading-text {
      margin-top: 1rem;
      color: var(--text-light);
      font-size: 1rem;
    }
    
    @keyframes spin {
      0%, 100% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      padding: 1.5rem 1rem;
      text-align: center;
      color: white;
      position: relative;
    }
    
    .header-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .header .subtitle {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    
    /* Progress Bar */
    .progress-container {
      background: white;
      padding: 1.5rem 1rem;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 400px;
      margin: 0 auto;
      position: relative;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 15%;
      right: 15%;
      height: 3px;
      background: var(--border-color);
      transform: translateY(-50%);
      z-index: 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .progress-step:hover {
      transform: scale(1.05);
    }
    
    .progress-step.disabled {
      cursor: default;
    }
    
    .progress-step.disabled:hover {
      transform: none;
    }
    
    .step-circle {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--border-color);
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1rem;
      transition: all 0.3s ease;
      border: 3px solid white;
      box-shadow: var(--shadow);
    }
    
    .progress-step.active .step-circle {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
    }
    
    .progress-step.complete .step-circle {
      background: var(--success-color);
      color: white;
    }
    
    .step-label {
      font-size: 0.7rem;
      color: var(--text-light);
      margin-top: 0.5rem;
      text-align: center;
      font-weight: 500;
      max-width: 70px;
    }
    
    .progress-step.active .step-label {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .progress-step.complete .step-label {
      color: var(--success-color);
    }
    
    /* Main Content */
    .main-content {
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Step Cards */
    .step-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      margin-bottom: 1rem;
      overflow: hidden;
      display: none;
    }
    
    .step-card.active {
      display: block;
    }
    
    .step-card-header {
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
      padding: 1.25rem;
      border-bottom: 2px solid var(--border-color);
    }
    
    .step-card-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .step-card-title .icon {
      font-size: 1.5rem;
    }
    
    .step-card-subtitle {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      margin-left: 2.25rem;
    }
    
    .step-card-body {
      padding: 1.25rem;
    }
    
    /* Field List */
    .field-list {
      margin-bottom: 1.5rem;
    }
    
    .field-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.875rem;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 0.625rem;
    }
    
    .field-item:last-child {
      margin-bottom: 0;
    }
    
    .field-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    
    .field-content {
      flex: 1;
    }
    
    .field-name {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95rem;
    }
    
    .field-description {
      color: var(--text-light);
      font-size: 0.85rem;
      margin-top: 0.125rem;
    }
    
    /* Why Box */
    .why-box {
      background: linear-gradient(135deg, #fef9c3 0%, #fef3c7 100%);
      border-left: 4px solid #f59e0b;
      padding: 1rem;
      border-radius: 0 10px 10px 0;
      margin-bottom: 1.5rem;
    }
    
    .why-box-title {
      font-weight: 700;
      color: #92400e;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.375rem;
    }
    
    .why-box-content {
      color: #78350f;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(45, 80, 22, 0.4);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: var(--text-dark);
      border: 2px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .skip-links {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    
    .skip-link {
      color: var(--text-light);
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .skip-link:hover {
      color: var(--text-dark);
      text-decoration: underline;
    }
    
    /* Completion Card */
    .completion-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 2rem 1.5rem;
      text-align: center;
      display: none;
    }
    
    .completion-card.active {
      display: block;
    }
    
    .completion-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .completion-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .completion-subtitle {
      color: var(--text-light);
      font-size: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .completion-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Already Complete Badge */
    .already-complete-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      background: var(--success-bg);
      color: #065f46;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    /* Login Required */
    .login-required {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 2rem 1.5rem;
      text-align: center;
      max-width: 400px;
      margin: 2rem auto;
    }
    
    .login-required-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .login-required h2 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .login-required p {
      color: var(--text-light);
      margin-bottom: 1.5rem;
    }
    
    /* Responsive */
    @media (min-width: 480px) {
      .header {
        padding: 2rem;
      }
      
      .header h1 {
        font-size: 1.75rem;
      }
      
      .main-content {
        padding: 1.5rem;
      }
      
      .step-card-header {
        padding: 1.5rem;
      }
      
      .step-card-body {
        padding: 1.5rem;
      }
      
      .action-buttons {
        flex-direction: row;
      }
      
      .btn {
        flex: 1;
      }
    }
    
    @media (min-width: 768px) {
      .header-icon {
        font-size: 4rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .progress-container {
        padding: 2rem;
      }
      
      .step-circle {
        width: 52px;
        height: 52px;
        font-size: 1.1rem;
      }
      
      .step-label {
        font-size: 0.8rem;
        max-width: 90px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">‚öæ</div>
    <div class="loading-text">Loading your profile...</div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-icon">‚öæ</div>
    <h1>Complete Your Profile</h1>
    <p class="subtitle">Get the most out of your Aces experience</p>
  </header>

  <!-- Progress Bar -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-step active" data-step="1" onclick="goToStep(1)">
        <div class="step-circle">1</div>
        <div class="step-label">Player Info</div>
      </div>
      <div class="progress-step" data-step="2" onclick="goToStep(2)">
        <div class="step-circle">2</div>
        <div class="step-label">Notifications</div>
      </div>
      <div class="progress-step" data-step="3" onclick="goToStep(3)">
        <div class="step-circle">3</div>
        <div class="step-label">Directory</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Login Required (shown when not authenticated) -->
    <div class="login-required" id="loginRequired" style="display: none;">
      <div class="login-required-icon">üîí</div>
      <h2>Sign In Required</h2>
      <p>Please sign in to complete your profile setup.</p>
      <a href="signin.html" class="btn btn-primary">Sign In ‚Üí</a>
    </div>

    <!-- Step 1: Player Info -->
    <div class="step-card active" id="step1">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üìã</span>
          Player Information
        </div>
        <div class="step-card-subtitle">Help your captain plan lineups and let teammates know your game</div>
      </div>
      <div class="step-card-body">
        <div id="step1AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Already filled out
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">üî¢</span>
            <div class="field-content">
              <div class="field-name">Jersey Number</div>
              <div class="field-description">Your number for the roster and stats display</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üèè</span>
            <div class="field-content">
              <div class="field-name">Bats & Throws</div>
              <div class="field-description">Right, Left, or Switch hitter / throwing arm</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">ü•é</span>
            <div class="field-content">
              <div class="field-name">Primary Position</div>
              <div class="field-description">Where you play most often (P, C, IF, OF, etc.)</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üîÑ</span>
            <div class="field-content">
              <div class="field-name">Secondary Positions</div>
              <div class="field-description">Other positions you can fill in at</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            Captains use this info when creating defensive rotations in Roster Management. Knowing everyone's positions helps build balanced lineups game-to-game.
          </div>
        </div>
        
        <div class="action-buttons">
          <a href="profile.html#tab-player-info" class="btn btn-primary" id="step1Action">
            Go to Player Info ‚Üí
          </a>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(1)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(1)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Step 2: Notifications -->
    <div class="step-card" id="step2">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üîî</span>
          Push Notifications
        </div>
        <div class="step-card-subtitle">Never miss a game or important team update</div>
      </div>
      <div class="step-card-body">
        <div id="step2AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Already enabled
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">‚è∞</span>
            <div class="field-content">
              <div class="field-name">Game Reminders</div>
              <div class="field-description">Get notified 1 hour before your games start</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">‚úã</span>
            <div class="field-content">
              <div class="field-name">RSVP Reminders</div>
              <div class="field-description">Daily nudge if you haven't RSVP'd for upcoming games</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üìÖ</span>
            <div class="field-content">
              <div class="field-name">Schedule Changes</div>
              <div class="field-description">Time, date, or field changes for your games</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üìä</span>
            <div class="field-content">
              <div class="field-name">Lineup Updates</div>
              <div class="field-description">Know when your captain posts the batting order</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            Stay in the loop without constantly checking the site. RSVP reminders help captains know who's coming, and schedule alerts make sure you don't miss last-minute field changes.
          </div>
        </div>
        
        <div class="action-buttons">
          <a href="profile.html#tab-preferences" class="btn btn-primary" id="step2Action">
            Set Up Notifications ‚Üí
          </a>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(2)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(2)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Step 3: Directory -->
    <div class="step-card" id="step3">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üìá</span>
          Aces Directory
        </div>
        <div class="step-card-subtitle">Connect with fellow Aces beyond the diamond</div>
      </div>
      <div class="step-card-body">
        <div id="step3AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Already opted in
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">üì±</span>
            <div class="field-content">
              <div class="field-name">Phone Number</div>
              <div class="field-description">Let teammates reach you for carpools, subs, etc.</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üíº</span>
            <div class="field-content">
              <div class="field-name">Occupation</div>
              <div class="field-description">What you do for work (optional)</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üõ†Ô∏è</span>
            <div class="field-content">
              <div class="field-name">Skills & Interests</div>
              <div class="field-description">Photography, carpentry, web design, etc.</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            The Aces Directory helps our community support each other. Need a plumber? Looking for a photographer for an event? Find fellow Aces with the skills you need. Only visible to signed-in members.
          </div>
        </div>
        
        <div class="action-buttons">
          <a href="profile.html#tab-directory" class="btn btn-primary" id="step3Action">
            Join the Directory ‚Üí
          </a>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(3)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(3)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Completion Card -->
    <div class="completion-card" id="completionCard">
      <div class="completion-icon">üéâ</div>
      <div class="completion-title">You're All Set!</div>
      <div class="completion-subtitle">Your profile is complete. Time to play ball!</div>
      <div class="completion-actions">
        <a href="profile.html" class="btn btn-primary">View My Profile ‚Üí</a>
        <a href="index.html" class="btn btn-secondary">Back to Home</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { onAuthChange, getUserProfile, updateUserProfile } from './firebase-auth.js';
    import { db } from './firebase-data.js';
    import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // State
    let currentStep = 1;
    let userProfile = null;
    let currentUser = null;
    let progress = {
      playerInfoComplete: false,
      notificationsComplete: false,
      directoryComplete: false,
      playerInfoDismissed: false,
      notificationsDismissed: false,
      directoryDismissed: false
    };

    // Auth state listener
    onAuthChange(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserProfile();
      } else {
        // Not logged in
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
        document.getElementById('loginRequired').style.display = 'block';
      }
    });

    // Load user profile and check existing data
    async function loadUserProfile() {
      try {
        const profileData = await getUserProfile(currentUser.uid);
        
        if (profileData) {
          userProfile = profileData;
          await checkExistingProfile();
        } else {
          userProfile = {};
        }
        
        updateUI();
        document.getElementById('loadingOverlay').classList.add('hidden');
        
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    // Check existing profile data and set progress
    async function checkExistingProfile() {
      // Load saved progress from Firebase
      const savedProgress = userProfile.profileSetupProgress || {};
      
      // Step 1: Player Info - complete if has useful captain data
      progress.playerInfoComplete = !!(
        userProfile.position || 
        userProfile.primaryPosition ||
        (userProfile.bats && userProfile.throws)
      );
      progress.playerInfoDismissed = savedProgress.playerInfoDismissed || false;

      // Step 2: Notifications - complete if enabled OR dismissed
      progress.notificationsComplete = !!(userProfile.notificationsEnabled === true);
      progress.notificationsDismissed = savedProgress.notificationsDismissed || false;

      // Step 3: Directory - complete if opted in OR dismissed
      progress.directoryComplete = !!(userProfile.directoryOptIn === true);
      progress.directoryDismissed = savedProgress.directoryDismissed || false;
      
      console.log('üìã Profile setup progress:', progress);
    }

    // Update UI based on progress
    function updateUI() {
      // Update progress bar
      updateProgressBar();
      
      // Show "already complete" badges
      if (progress.playerInfoComplete) {
        document.getElementById('step1AlreadyComplete').style.display = 'inline-flex';
        document.getElementById('step1Action').textContent = 'Review Player Info ‚Üí';
      }
      
      if (progress.notificationsComplete) {
        document.getElementById('step2AlreadyComplete').style.display = 'inline-flex';
        document.getElementById('step2Action').textContent = 'Review Notifications ‚Üí';
      }
      
      if (progress.directoryComplete) {
        document.getElementById('step3AlreadyComplete').style.display = 'inline-flex';
        document.getElementById('step3Action').textContent = 'Review Directory ‚Üí';
      }
      
      // Check if all complete
      if (isAllComplete()) {
        showCompletion();
      } else {
        // Find first incomplete step and go to it
        findAndShowFirstIncompleteStep();
      }
    }

    // Update progress bar visual state
    function updateProgressBar() {
      const steps = document.querySelectorAll('.progress-step');
      
      steps.forEach((step, index) => {
        const stepNum = index + 1;
        const isComplete = isStepComplete(stepNum);
        const isActive = stepNum === currentStep;
        
        step.classList.remove('active', 'complete');
        
        if (isComplete) {
          step.classList.add('complete');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else {
          step.querySelector('.step-circle').textContent = stepNum;
          if (isActive) {
            step.classList.add('active');
          }
        }
      });
    }

    // Check if a specific step is complete (finished or dismissed)
    function isStepComplete(stepNum) {
      switch(stepNum) {
        case 1: return progress.playerInfoComplete || progress.playerInfoDismissed;
        case 2: return progress.notificationsComplete || progress.notificationsDismissed;
        case 3: return progress.directoryComplete || progress.directoryDismissed;
        default: return false;
      }
    }

    // Check if all steps are complete
    function isAllComplete() {
      return isStepComplete(1) && isStepComplete(2) && isStepComplete(3);
    }

    // Find and show first incomplete step
    function findAndShowFirstIncompleteStep() {
      if (!isStepComplete(1)) {
        goToStep(1);
      } else if (!isStepComplete(2)) {
        goToStep(2);
      } else if (!isStepComplete(3)) {
        goToStep(3);
      } else {
        showCompletion();
      }
    }

    // Navigate to a specific step
    window.goToStep = function(stepNum) {
      currentStep = stepNum;
      
      // Hide all step cards
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Hide completion card
      document.getElementById('completionCard').classList.remove('active');
      
      // Show selected step
      document.getElementById(`step${stepNum}`).classList.add('active');
      
      // Update progress bar
      updateProgressBar();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Skip step (move to next without saving)
    window.skipStep = function(stepNum) {
      const nextStep = stepNum + 1;
      
      if (nextStep <= 3) {
        window.goToStep(nextStep);
      } else {
        // On last step, check if all complete
        if (isAllComplete()) {
          showCompletion();
        } else {
          findAndShowFirstIncompleteStep();
        }
      }
    }

    // Dismiss step permanently
    window.dismissStep = async function(stepNum) {
      if (!currentUser) return;
      
      const dismissKey = getStepDismissKey(stepNum);
      progress[dismissKey] = true;
      
      // Save to Firebase
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          profileSetupProgress: {
            ...userProfile.profileSetupProgress,
            [dismissKey]: true,
            lastUpdated: serverTimestamp()
          }
        }, { merge: true });
        
        console.log(`‚úÖ Step ${stepNum} dismissed`);
        
        // Update UI
        updateProgressBar();
        
        // Move to next step or show completion
        if (isAllComplete()) {
          await markSetupComplete();
          showCompletion();
        } else {
          window.skipStep(stepNum);
        }
        
      } catch (error) {
        console.error('Error dismissing step:', error);
      }
    }

    // Get dismiss key for a step
    function getStepDismissKey(stepNum) {
      switch(stepNum) {
        case 1: return 'playerInfoDismissed';
        case 2: return 'notificationsDismissed';
        case 3: return 'directoryDismissed';
        default: return '';
      }
    }

    // Mark setup as complete
    async function markSetupComplete() {
      if (!currentUser) return;
      
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          profileSetupProgress: {
            ...userProfile.profileSetupProgress,
            completedAt: serverTimestamp()
          }
        }, { merge: true });
        
        console.log('üéâ Profile setup marked complete');
        
      } catch (error) {
        console.error('Error marking setup complete:', error);
      }
    }

    // Show completion card
    function showCompletion() {
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      
      document.getElementById('completionCard').classList.add('active');
      
      // Update all progress steps to complete
      document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active');
        step.classList.add('complete');
        step.querySelector('.step-circle').textContent = '‚úì';
      });
    }

    // Check for return from profile page (handles ?from=player-info etc)
    function checkReturnFromProfile() {
      const urlParams = new URLSearchParams(window.location.search);
      const fromTab = urlParams.get('from');
      
      if (fromTab && currentUser) {
        // Re-check profile data since user might have updated it
        loadUserProfile();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkReturnFromProfile();
    });
  </script>
  
  <!-- Navigation Component -->
  <script type="module">
    import { NavigationComponent } from './nav-component.js';
  </script>
</body>
</html>
