<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Complete Your Profile - Mountainside Aces</title>
  <meta name="theme-color" content="#2d5016">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="nav-styles.css">
  
  <style>
    :root {
      --primary-color: #2d5016;
      --secondary-color: #1a6b4a;
      --accent-color: #ffd700;
      --card-bg: #ffffff;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --success-color: #10b981;
      --success-bg: #d1fae5;
      --warning-color: #f59e0b;
      --warning-bg: #fef3c7;
      --error-color: #ef4444;
      --error-bg: #fee2e2;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      line-height: 1.6;
      color: var(--text-dark);
      min-height: 100vh;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }
    
    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-spinner {
      font-size: 60px;
      animation: spin 1.5s ease-in-out infinite;
    }
    
    .loading-text {
      margin-top: 1rem;
      color: var(--text-light);
      font-size: 1rem;
    }
    
    @keyframes spin {
      0%, 100% { transform: rotate(0deg) scale(1); }
      50% { transform: rotate(180deg) scale(1.1); }
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      padding: 1.5rem 1rem;
      text-align: center;
      color: white;
      position: relative;
    }
    
    .header-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }
    
    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .header .subtitle {
      font-size: 0.95rem;
      opacity: 0.9;
    }
    
    /* Progress Bar - 4 Steps */
    .progress-container {
      background: white;
      padding: 1.5rem 0.5rem;
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .progress-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 500px;
      margin: 0 auto;
      position: relative;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 3px;
      background: var(--border-color);
      transform: translateY(-50%);
      z-index: 0;
    }
    
    .progress-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    
    .progress-step:hover {
      transform: scale(1.05);
    }
    
    .progress-step.disabled {
      cursor: default;
    }
    
    .progress-step.disabled:hover {
      transform: none;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border-color);
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      border: 3px solid white;
      box-shadow: var(--shadow);
    }
    
    .progress-step.active .step-circle {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
    }
    
    .progress-step.complete .step-circle {
      background: var(--success-color);
      color: white;
    }
    
    .step-label {
      font-size: 0.65rem;
      color: var(--text-light);
      margin-top: 0.4rem;
      text-align: center;
      font-weight: 500;
      max-width: 60px;
      line-height: 1.2;
    }
    
    .progress-step.active .step-label {
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .progress-step.complete .step-label {
      color: var(--success-color);
    }
    
    /* Main Content */
    .main-content {
      padding: 1rem;
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* Step Cards */
    .step-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      margin-bottom: 1rem;
      overflow: hidden;
      display: none;
    }
    
    .step-card.active {
      display: block;
    }
    
    .step-card-header {
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
      padding: 1.25rem;
      border-bottom: 2px solid var(--border-color);
    }
    
    .step-card-title {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--primary-color);
    }
    
    .step-card-title .icon {
      font-size: 1.5rem;
    }
    
    .step-card-subtitle {
      color: var(--text-light);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      margin-left: 2.25rem;
    }
    
    .step-card-body {
      padding: 1.25rem;
    }
    
    /* Field List */
    .field-list {
      margin-bottom: 1.5rem;
    }
    
    .field-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.875rem;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 0.625rem;
    }
    
    .field-item:last-child {
      margin-bottom: 0;
    }
    
    .field-icon {
      font-size: 1.25rem;
      flex-shrink: 0;
    }
    
    .field-content {
      flex: 1;
    }
    
    .field-name {
      font-weight: 600;
      color: var(--text-dark);
      font-size: 0.95rem;
    }
    
    .field-description {
      color: var(--text-light);
      font-size: 0.85rem;
      margin-top: 0.125rem;
    }
    
    /* Why Box */
    .why-box {
      background: linear-gradient(135deg, #fef9c3 0%, #fef3c7 100%);
      border-left: 4px solid #f59e0b;
      padding: 1rem;
      border-radius: 0 10px 10px 0;
      margin-bottom: 1.5rem;
    }
    
    .why-box-title {
      font-weight: 700;
      color: #92400e;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.375rem;
    }
    
    .why-box-content {
      color: #78350f;
      font-size: 0.875rem;
      line-height: 1.5;
    }
    
    /* Platform Instructions */
    .platform-instructions {
      margin-bottom: 1.5rem;
    }
    
    .platform-card {
      background: #f8fafc;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 0.75rem;
    }
    
    .platform-card.active {
      border-color: var(--primary-color);
      background: linear-gradient(135deg, rgba(45, 80, 22, 0.03) 0%, rgba(26, 107, 74, 0.03) 100%);
    }
    
    .platform-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }
    
    .platform-icon {
      font-size: 1.5rem;
    }
    
    .platform-name {
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .platform-badge {
      background: var(--primary-color);
      color: white;
      font-size: 0.7rem;
      padding: 0.2rem 0.5rem;
      border-radius: 10px;
      font-weight: 600;
    }
    
    .platform-steps {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .platform-steps li {
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
      padding: 0.375rem 0;
      font-size: 0.9rem;
      color: var(--text-dark);
    }
    
    .platform-steps li .step-num {
      background: var(--secondary-color);
      color: white;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    /* Notification Status */
    .notification-status {
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .notification-status.granted {
      background: var(--success-bg);
      border: 2px solid var(--success-color);
    }
    
    .notification-status.denied {
      background: var(--error-bg);
      border: 2px solid var(--error-color);
    }
    
    .notification-status.default {
      background: #f1f5f9;
      border: 2px solid var(--border-color);
    }
    
    .notification-status.ios-browser {
      background: var(--warning-bg);
      border: 2px solid var(--warning-color);
    }
    
    .notification-status-icon {
      font-size: 1.5rem;
    }
    
    .notification-status-text {
      flex: 1;
    }
    
    .notification-status-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .notification-status.granted .notification-status-title { color: #065f46; }
    .notification-status.denied .notification-status-title { color: #991b1b; }
    .notification-status.default .notification-status-title { color: var(--text-dark); }
    .notification-status.ios-browser .notification-status-title { color: #92400e; }
    
    .notification-status-desc {
      font-size: 0.85rem;
    }
    
    .notification-status.granted .notification-status-desc { color: #047857; }
    .notification-status.denied .notification-status-desc { color: #dc2626; }
    .notification-status.default .notification-status-desc { color: var(--text-light); }
    .notification-status.ios-browser .notification-status-desc { color: #b45309; }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem 1.5rem;
      border-radius: 12px;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      border: none;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      color: white;
      box-shadow: 0 4px 12px rgba(45, 80, 22, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(45, 80, 22, 0.4);
    }
    
    .btn-primary:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: var(--text-dark);
      border: 2px solid var(--border-color);
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
    }
    
    .skip-links {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-color);
    }
    
    .skip-link {
      color: var(--text-light);
      font-size: 0.85rem;
      text-decoration: none;
      cursor: pointer;
      transition: color 0.2s ease;
    }
    
    .skip-link:hover {
      color: var(--text-dark);
      text-decoration: underline;
    }
    
    /* Completion Card */
    .completion-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 2rem 1.5rem;
      text-align: center;
      display: none;
    }
    
    .completion-card.active {
      display: block;
    }
    
    .completion-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .completion-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .completion-subtitle {
      color: var(--text-light);
      font-size: 1rem;
      margin-bottom: 1.5rem;
    }
    
    .completion-actions {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    /* Already Complete Badge */
    .already-complete-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      background: var(--success-bg);
      color: #065f46;
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    /* Login Required */
    .login-required {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      padding: 2rem 1.5rem;
      text-align: center;
      max-width: 400px;
      margin: 2rem auto;
    }
    
    .login-required-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    
    .login-required h2 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }
    
    .login-required p {
      color: var(--text-light);
      margin-bottom: 1.5rem;
    }
    
    /* Responsive */
    @media (min-width: 480px) {
      .header {
        padding: 2rem;
      }
      
      .header h1 {
        font-size: 1.75rem;
      }
      
      .main-content {
        padding: 1.5rem;
      }
      
      .step-card-header {
        padding: 1.5rem;
      }
      
      .step-card-body {
        padding: 1.5rem;
      }
      
      .action-buttons {
        flex-direction: row;
      }
      
      .btn {
        flex: 1;
      }
      
      .step-circle {
        width: 44px;
        height: 44px;
        font-size: 1rem;
      }
      
      .step-label {
        font-size: 0.7rem;
        max-width: 70px;
      }
    }
    
    @media (min-width: 768px) {
      .header-icon {
        font-size: 4rem;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .progress-container {
        padding: 2rem 1rem;
      }
      
      .step-circle {
        width: 48px;
        height: 48px;
        font-size: 1.1rem;
      }
      
      .step-label {
        font-size: 0.75rem;
        max-width: 80px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner">‚öæ</div>
    <div class="loading-text">Loading your profile...</div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-icon">‚öæ</div>
    <h1>Complete Your Profile</h1>
    <p class="subtitle">Get the most out of your Aces experience</p>
  </header>

  <!-- Progress Bar - 4 Steps -->
  <div class="progress-container">
    <div class="progress-bar">
      <div class="progress-step active" data-step="1" onclick="goToStep(1)">
        <div class="step-circle">1</div>
        <div class="step-label">Player Info</div>
      </div>
      <div class="progress-step" data-step="2" onclick="goToStep(2)">
        <div class="step-circle">2</div>
        <div class="step-label">Install App</div>
      </div>
      <div class="progress-step" data-step="3" onclick="goToStep(3)">
        <div class="step-circle">3</div>
        <div class="step-label">Notifications</div>
      </div>
      <div class="progress-step" data-step="4" onclick="goToStep(4)">
        <div class="step-circle">4</div>
        <div class="step-label">Directory</div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Login Required (shown when not authenticated) -->
    <div class="login-required" id="loginRequired" style="display: none;">
      <div class="login-required-icon">üîí</div>
      <h2>Sign In Required</h2>
      <p>Please sign in to complete your profile setup.</p>
      <a href="signin.html" class="btn btn-primary">Sign In ‚Üí</a>
    </div>

    <!-- Step 1: Player Info -->
    <div class="step-card active" id="step1">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üìã</span>
          Player Information
        </div>
        <div class="step-card-subtitle">Help your captain plan lineups and let teammates know your game</div>
      </div>
      <div class="step-card-body">
        <div id="step1AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Already filled out
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">üî¢</span>
            <div class="field-content">
              <div class="field-name">Jersey Number</div>
              <div class="field-description">Your number for the roster and stats display</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üèè</span>
            <div class="field-content">
              <div class="field-name">Bats & Throws</div>
              <div class="field-description">Right, Left, or Switch hitter / throwing arm</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">ü•é</span>
            <div class="field-content">
              <div class="field-name">Primary Position</div>
              <div class="field-description">Where you play most often (P, C, IF, OF, etc.)</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üîÑ</span>
            <div class="field-content">
              <div class="field-name">Secondary Positions</div>
              <div class="field-description">Other positions you can fill in at</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            Captains use this info when creating defensive rotations in Roster Management. Knowing everyone's positions helps build balanced lineups game-to-game.
          </div>
        </div>
        
        <div class="action-buttons">
          <a href="profile.html#tab-player-info" class="btn btn-primary" id="step1Action">
            Go to Player Info ‚Üí
          </a>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(1)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(1)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Step 2: Install App (PWA) -->
    <div class="step-card" id="step2">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üì≤</span>
          Install the App
        </div>
        <div class="step-card-subtitle">Get the Aces app on your home screen for quick access</div>
      </div>
      <div class="step-card-body">
        <div id="step2AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì App installed
        </div>
        
        <div class="platform-instructions">
          <!-- iOS Instructions -->
          <div class="platform-card" id="iosInstructions">
            <div class="platform-header">
              <span class="platform-icon">üçé</span>
              <span class="platform-name">iPhone / iPad</span>
              <span class="platform-badge" id="iosBadge" style="display: none;">Your Device</span>
            </div>
            <ol class="platform-steps">
              <li><span class="step-num">1</span> <strong>Go to the Home Page first</strong> (button below)</li>
              <li><span class="step-num">2</span> Tap the <strong>Share</strong> button (square with arrow)</li>
              <li><span class="step-num">3</span> Scroll down and tap <strong>"Add to Home Screen"</strong></li>
              <li><span class="step-num">4</span> Tap <strong>"Add"</strong> in the top right</li>
            </ol>
            <a href="index.html" class="btn btn-secondary" style="margin-top: 0.75rem; display: inline-flex; padding: 0.75rem 1.25rem; font-size: 0.9rem;">
              üè† Open Home Page ‚Üí
            </a>
          </div>
          
          <!-- Android Instructions -->
          <div class="platform-card" id="androidInstructions">
            <div class="platform-header">
              <span class="platform-icon">ü§ñ</span>
              <span class="platform-name">Android</span>
              <span class="platform-badge" id="androidBadge" style="display: none;">Your Device</span>
            </div>
            <ol class="platform-steps">
              <li><span class="step-num">1</span> Tap the <strong>Menu</strong> (‚ãÆ) in Chrome</li>
              <li><span class="step-num">2</span> Tap <strong>"Add to Home Screen"</strong> or <strong>"Install App"</strong></li>
              <li><span class="step-num">3</span> Tap <strong>"Install"</strong> to confirm</li>
            </ol>
          </div>
          
          <!-- Desktop Chrome/Edge Instructions -->
          <div class="platform-card" id="desktopChromeInstructions">
            <div class="platform-header">
              <span class="platform-icon">üíª</span>
              <span class="platform-name">Desktop (Chrome/Edge)</span>
              <span class="platform-badge" id="desktopChromeBadge" style="display: none;">Your Device</span>
            </div>
            <ol class="platform-steps">
              <li><span class="step-num">1</span> Look for the <strong>Install</strong> icon <span style="display: inline-flex; align-items: center; gap: 2px; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">üñ•Ô∏è‚Üì</span> in the address bar</li>
              <li><span class="step-num">2</span> Click <strong>"Install"</strong> in the popup</li>
            </ol>
          </div>
          
          <!-- Desktop Safari Instructions -->
          <div class="platform-card" id="desktopSafariInstructions">
            <div class="platform-header">
              <span class="platform-icon">üß≠</span>
              <span class="platform-name">Desktop Safari</span>
              <span class="platform-badge" id="desktopSafariBadge" style="display: none;">Your Device</span>
            </div>
            <ol class="platform-steps">
              <li><span class="step-num">1</span> <strong>Go to the Home Page first</strong> (button below)</li>
              <li><span class="step-num">2</span> Click <strong>File</strong> in the menu bar</li>
              <li><span class="step-num">3</span> Select <strong>"Add to Dock"</strong></li>
            </ol>
            <a href="index.html" class="btn btn-secondary" style="margin-top: 0.75rem; display: inline-flex; padding: 0.75rem 1.25rem; font-size: 0.9rem;">
              üè† Open Home Page ‚Üí
            </a>
            <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 0.75rem; font-style: italic;">
              Note: Safari has limited PWA support. For best experience, use Chrome or the mobile app.
            </p>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            The app loads faster, works offline at the field, and is required for push notifications on iPhone. It's just a shortcut - no app store needed!
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="markAppInstalled()">
            ‚úì I've Installed the App
          </button>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(2)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(2)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Step 3: Push Notifications -->
    <div class="step-card" id="step3">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üîî</span>
          Push Notifications
        </div>
        <div class="step-card-subtitle">Get alerts on each device you use ‚Äî phone recommended!</div>
      </div>
      <div class="step-card-body">
        <div id="step3AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Notifications enabled on a device
        </div>
        
        <!-- Notification Status - dynamically updated -->
        <div class="notification-status default" id="notificationStatus">
          <span class="notification-status-icon">üîî</span>
          <div class="notification-status-text">
            <div class="notification-status-title" id="notificationStatusTitle">Checking status...</div>
            <div class="notification-status-desc" id="notificationStatusDesc">Please wait</div>
          </div>
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">‚è∞</span>
            <div class="field-content">
              <div class="field-name">Game Reminders</div>
              <div class="field-description">Get notified 1 hour before your games start</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">‚úã</span>
            <div class="field-content">
              <div class="field-name">RSVP Reminders</div>
              <div class="field-description">Daily nudge if you haven't RSVP'd for upcoming games</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üìÖ</span>
            <div class="field-content">
              <div class="field-name">Schedule Changes</div>
              <div class="field-description">Time, date, or field changes for your games</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üìä</span>
            <div class="field-content">
              <div class="field-name">Lineup Updates</div>
              <div class="field-description">Know when your captain posts the batting order</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            Stay in the loop without constantly checking the site. RSVP reminders help captains know who's coming, and schedule alerts make sure you don't miss last-minute field changes.
          </div>
        </div>
        
        <!-- Device-specific info box -->
        <div class="why-box" style="background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%); border-left-color: #3b82f6;">
          <div class="why-box-title">
            <span>üì±</span> Important: Per-Device Setup
          </div>
          <div class="why-box-content">
            <strong>Notifications must be enabled separately on each device</strong> you want to receive them on.
            <br><br>
            <strong style="color: #1e40af;">We strongly recommend enabling notifications on your phone's mobile app (PWA)</strong> - that's where you'll want game-day alerts! Complete Step 2 first if you haven't installed the app yet.
            <br><br>
            <span style="font-size: 0.85rem; color: #64748b;">You can also enable on desktop/laptop for convenience, but phone notifications are most useful when you're at the field.</span>
          </div>
        </div>
        
        <div class="action-buttons" id="notificationActions">
          <!-- Dynamically populated based on permission state -->
          <button class="btn btn-primary" id="enableNotificationsBtn" onclick="requestNotifications()">
            üîî Enable Notifications
          </button>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(3)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(3)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Step 4: Directory -->
    <div class="step-card" id="step4">
      <div class="step-card-header">
        <div class="step-card-title">
          <span class="icon">üìá</span>
          Aces Directory
        </div>
        <div class="step-card-subtitle">Connect with fellow Aces beyond the diamond</div>
      </div>
      <div class="step-card-body">
        <div id="step4AlreadyComplete" class="already-complete-badge" style="display: none;">
          ‚úì Already opted in
        </div>
        
        <div class="field-list">
          <div class="field-item">
            <span class="field-icon">üì±</span>
            <div class="field-content">
              <div class="field-name">Phone Number</div>
              <div class="field-description">Let teammates reach you for carpools, subs, etc.</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üíº</span>
            <div class="field-content">
              <div class="field-name">Occupation</div>
              <div class="field-description">What you do for work (optional)</div>
            </div>
          </div>
          <div class="field-item">
            <span class="field-icon">üõ†Ô∏è</span>
            <div class="field-content">
              <div class="field-name">Skills & Interests</div>
              <div class="field-description">Photography, carpentry, web design, etc.</div>
            </div>
          </div>
        </div>
        
        <div class="why-box">
          <div class="why-box-title">
            <span>üí°</span> Why this matters
          </div>
          <div class="why-box-content">
            The Aces Directory helps our community support each other. Need a plumber? Looking for a photographer for an event? Find fellow Aces with the skills you need. Only visible to signed-in members.
          </div>
        </div>
        
        <div class="action-buttons">
          <a href="profile.html#tab-directory" class="btn btn-primary" id="step4Action">
            Join the Directory ‚Üí
          </a>
        </div>
        
        <div class="skip-links">
          <span class="skip-link" onclick="skipStep(4)">Skip for now</span>
          <span class="skip-link" onclick="dismissStep(4)">Don't show this again</span>
        </div>
      </div>
    </div>

    <!-- Completion Card -->
    <div class="completion-card" id="completionCard">
      <div class="completion-icon">üéâ</div>
      <div class="completion-title">You're All Set!</div>
      <div class="completion-subtitle">Your profile is complete. Time to play ball!</div>
      <div class="completion-actions">
        <a href="profile.html" class="btn btn-primary">View My Profile ‚Üí</a>
        <a href="index.html" class="btn btn-secondary">Back to Home</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { onAuthChange, getUserProfile, updateUserProfile } from './firebase-auth.js';
    import { db } from './firebase-data.js';
    import { doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { requestNotificationPermission } from './firebase-messaging.js';

    // State
    let currentStep = 1;
    let userProfile = null;
    let currentUser = null;
    let progress = {
      playerInfoComplete: false,
      appInstallComplete: false,
      notificationsComplete: false,
      directoryComplete: false,
      playerInfoDismissed: false,
      appInstallDismissed: false,
      notificationsDismissed: false,
      directoryDismissed: false
    };
    
    // Platform detection
    const platform = detectPlatform();
    
    function detectPlatform() {
      const ua = navigator.userAgent;
      const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
      const isAndroid = /Android/.test(ua);
      const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                           window.navigator.standalone === true;
      const isSafari = /Safari/.test(ua) && !/Chrome/.test(ua) && !/Chromium/.test(ua);
      const isDesktopSafari = isSafari && !isIOS;
      const isDesktopChrome = !isIOS && !isAndroid && !isSafari;
      
      return {
        isIOS,
        isAndroid,
        isDesktop: !isIOS && !isAndroid,
        isDesktopSafari,
        isDesktopChrome,
        isStandalone,
        isSafari,
        isIOSBrowser: isIOS && !isStandalone
      };
    }

    // Auth state listener
    onAuthChange(async (user) => {
      if (user) {
        currentUser = user;
        await loadUserProfile();
      } else {
        // Not logged in
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.querySelectorAll('.step-card').forEach(card => card.classList.remove('active'));
        document.getElementById('loginRequired').style.display = 'block';
      }
    });

    // Load user profile and check existing data
    async function loadUserProfile() {
      try {
        const profileResult = await getUserProfile(currentUser.uid);
        
        if (profileResult.success && profileResult.data) {
          userProfile = profileResult.data;
          await checkExistingProfile();
        } else {
          userProfile = {};
        }
        
        updateUI();
        highlightCurrentPlatform();
        updateNotificationStatus();
        document.getElementById('loadingOverlay').classList.add('hidden');
        
      } catch (error) {
        console.error('Error loading profile:', error);
        document.getElementById('loadingOverlay').classList.add('hidden');
      }
    }

    // Check existing profile data and set progress
    async function checkExistingProfile() {
      const savedProgress = userProfile.profileSetupProgress || {};
      
      // Step 1: Player Info
      progress.playerInfoComplete = !!(
        userProfile.position || 
        userProfile.primaryPosition ||
        (userProfile.bats && userProfile.throws)
      );
      progress.playerInfoDismissed = savedProgress.playerInfoDismissed || false;

      // Step 2: App Install - complete if in standalone mode or marked complete
      progress.appInstallComplete = platform.isStandalone || savedProgress.appInstallComplete || false;
      progress.appInstallDismissed = savedProgress.appInstallDismissed || false;

      // Step 3: Notifications - check for actual FCM tokens
      // (notificationsEnabled flag has incorrect default in firebase-auth.js)
      progress.notificationsComplete = !!(userProfile.fcmTokens && userProfile.fcmTokens.length > 0);
      progress.notificationsDismissed = savedProgress.notificationsDismissed || false;

      // Step 4: Directory
      progress.directoryComplete = !!(userProfile.directoryOptIn === true);
      progress.directoryDismissed = savedProgress.directoryDismissed || false;
      
      console.log('üìã Profile setup progress:', progress);
    }

    // Highlight the current platform's instructions
    function highlightCurrentPlatform() {
      // Remove all active states first
      document.querySelectorAll('.platform-card').forEach(card => card.classList.remove('active'));
      document.querySelectorAll('.platform-badge').forEach(badge => badge.style.display = 'none');
      
      if (platform.isIOS) {
        document.getElementById('iosInstructions').classList.add('active');
        document.getElementById('iosBadge').style.display = 'inline';
      } else if (platform.isAndroid) {
        document.getElementById('androidInstructions').classList.add('active');
        document.getElementById('androidBadge').style.display = 'inline';
      } else if (platform.isDesktopSafari) {
        document.getElementById('desktopSafariInstructions').classList.add('active');
        document.getElementById('desktopSafariBadge').style.display = 'inline';
      } else {
        // Chrome, Edge, or other desktop browsers
        document.getElementById('desktopChromeInstructions').classList.add('active');
        document.getElementById('desktopChromeBadge').style.display = 'inline';
      }
    }

    // Update notification status UI
    function updateNotificationStatus() {
      const statusEl = document.getElementById('notificationStatus');
      const titleEl = document.getElementById('notificationStatusTitle');
      const descEl = document.getElementById('notificationStatusDesc');
      const actionsEl = document.getElementById('notificationActions');
      const enableBtn = document.getElementById('enableNotificationsBtn');
      
      // Check if notifications are supported
      if (!('Notification' in window)) {
        statusEl.className = 'notification-status denied';
        titleEl.textContent = 'Not Supported';
        descEl.textContent = 'Your browser doesn\'t support push notifications.';
        enableBtn.disabled = true;
        enableBtn.textContent = 'Not Available';
        return;
      }
      
      // iOS Safari without PWA
      if (platform.isIOSBrowser) {
        statusEl.className = 'notification-status ios-browser';
        titleEl.textContent = 'Install App First';
        descEl.textContent = 'On iPhone, you need to install the app (Step 2) before enabling notifications.';
        enableBtn.disabled = true;
        enableBtn.textContent = '‚ö†Ô∏è Complete Step 2 First';
        return;
      }
      
      // Check permission state
      const permission = Notification.permission;
      
      if (permission === 'granted') {
        statusEl.className = 'notification-status granted';
        titleEl.textContent = 'Notifications Enabled on This Device';
        descEl.textContent = 'You\'re set to receive game updates on this device! Remember to enable on your phone too if you haven\'t already.';
        actionsEl.innerHTML = `
          <a href="profile.html#tab-preferences" class="btn btn-secondary">
            ‚öôÔ∏è Manage Preferences
          </a>
          <button class="btn btn-success" onclick="window.skipStep(3)">
            ‚úì Continue
          </button>
        `;
      } else if (permission === 'denied') {
        statusEl.className = 'notification-status denied';
        titleEl.textContent = 'Notifications Blocked on This Device';
        descEl.textContent = 'You\'ve blocked notifications on this device. To enable them, update your browser settings.';
        enableBtn.textContent = 'üîß How to Unblock';
        enableBtn.onclick = showUnblockInstructions;
      } else {
        // default - not yet asked
        statusEl.className = 'notification-status default';
        titleEl.textContent = 'Enable Notifications on This Device';
        descEl.textContent = 'Allow notifications to get game reminders and team updates on this device.';
        enableBtn.disabled = false;
        enableBtn.textContent = 'üîî Enable Notifications';
      }
    }

    // Request notification permission
    window.requestNotifications = async function() {
      const enableBtn = document.getElementById('enableNotificationsBtn');
      enableBtn.disabled = true;
      enableBtn.textContent = 'Requesting...';
      
      try {
        const result = await requestNotificationPermission();
        
        if (result.success) {
          // Update local state
          progress.notificationsComplete = true;
          
          // Save to Firebase
          const userRef = doc(db, 'users', currentUser.uid);
          await setDoc(userRef, {
            notificationsEnabled: true,
            profileSetupProgress: {
              ...userProfile.profileSetupProgress,
              lastUpdated: serverTimestamp()
            }
          }, { merge: true });
          
          console.log('‚úÖ Notifications enabled');
          updateNotificationStatus();
          updateProgressBar();
        } else {
          console.log('‚ùå Notification permission denied');
          updateNotificationStatus();
        }
      } catch (error) {
        console.error('Error requesting notifications:', error);
        enableBtn.disabled = false;
        enableBtn.textContent = 'üîî Enable Notifications';
      }
    }

    // Show instructions for unblocking notifications
    function showUnblockInstructions() {
      let instructions = '';
      
      if (platform.isIOS) {
        instructions = 'Go to Settings ‚Üí Notifications ‚Üí Safari (or the app) ‚Üí Allow Notifications';
      } else if (platform.isAndroid) {
        instructions = 'Tap the lock icon in the address bar ‚Üí Site Settings ‚Üí Notifications ‚Üí Allow';
      } else {
        instructions = 'Click the lock icon in the address bar ‚Üí Site Settings ‚Üí Notifications ‚Üí Allow';
      }
      
      alert('To enable notifications:\n\n' + instructions);
    }

    // Mark app as installed
    window.markAppInstalled = async function() {
      if (!currentUser) return;
      
      progress.appInstallComplete = true;
      
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          profileSetupProgress: {
            ...userProfile.profileSetupProgress,
            appInstallComplete: true,
            lastUpdated: serverTimestamp()
          }
        }, { merge: true });
        
        console.log('‚úÖ App install marked complete');
        updateProgressBar();
        
        // Re-check notification status in case they're now in PWA
        updateNotificationStatus();
        
        // Auto-advance to next step
        window.goToStep(3);
        
      } catch (error) {
        console.error('Error marking app installed:', error);
      }
    }

    // Update UI based on progress
    function updateUI() {
      updateProgressBar();
      
      // Show "already complete" badges
      if (progress.playerInfoComplete) {
        document.getElementById('step1AlreadyComplete').style.display = 'inline-flex';
        document.getElementById('step1Action').textContent = 'Review Player Info ‚Üí';
      }
      
      if (progress.appInstallComplete) {
        document.getElementById('step2AlreadyComplete').style.display = 'inline-flex';
      }
      
      if (progress.notificationsComplete) {
        document.getElementById('step3AlreadyComplete').style.display = 'inline-flex';
      }
      
      if (progress.directoryComplete) {
        document.getElementById('step4AlreadyComplete').style.display = 'inline-flex';
        document.getElementById('step4Action').textContent = 'Review Directory ‚Üí';
      }
      
      // Check if all complete
      if (isAllComplete()) {
        showCompletion();
      } else {
        // Check for URL step parameter (e.g., ?step=2)
        const urlParams = new URLSearchParams(window.location.search);
        const requestedStep = parseInt(urlParams.get('step'), 10);
        
        if (requestedStep >= 1 && requestedStep <= 4) {
          // Go directly to requested step
          goToStep(requestedStep);
        } else {
          findAndShowFirstIncompleteStep();
        }
      }
    }

    // Update progress bar visual state
    function updateProgressBar() {
      const steps = document.querySelectorAll('.progress-step');
      
      steps.forEach((step, index) => {
        const stepNum = index + 1;
        const isComplete = isStepComplete(stepNum);
        const isActive = stepNum === currentStep;
        
        step.classList.remove('active', 'complete');
        
        if (isComplete) {
          step.classList.add('complete');
          step.querySelector('.step-circle').textContent = '‚úì';
        } else {
          step.querySelector('.step-circle').textContent = stepNum;
          if (isActive) {
            step.classList.add('active');
          }
        }
      });
    }

    // Check if a specific step is complete (finished or dismissed)
    function isStepComplete(stepNum) {
      switch(stepNum) {
        case 1: return progress.playerInfoComplete || progress.playerInfoDismissed;
        case 2: return progress.appInstallComplete || progress.appInstallDismissed;
        case 3: return progress.notificationsComplete || progress.notificationsDismissed;
        case 4: return progress.directoryComplete || progress.directoryDismissed;
        default: return false;
      }
    }

    // Check if all steps are complete
    function isAllComplete() {
      return isStepComplete(1) && isStepComplete(2) && isStepComplete(3) && isStepComplete(4);
    }

    // Find and show first incomplete step
    function findAndShowFirstIncompleteStep() {
      for (let i = 1; i <= 4; i++) {
        if (!isStepComplete(i)) {
          goToStep(i);
          return;
        }
      }
      showCompletion();
    }

    // Navigate to a specific step
    window.goToStep = function(stepNum) {
      currentStep = stepNum;
      
      // Hide all step cards
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Hide completion card
      document.getElementById('completionCard').classList.remove('active');
      
      // Show selected step
      document.getElementById(`step${stepNum}`).classList.add('active');
      
      // Update progress bar
      updateProgressBar();
      
      // If showing notifications step, refresh status
      if (stepNum === 3) {
        updateNotificationStatus();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Skip step (move to next without saving)
    window.skipStep = function(stepNum) {
      const nextStep = stepNum + 1;
      
      if (nextStep <= 4) {
        window.goToStep(nextStep);
      } else {
        if (isAllComplete()) {
          showCompletion();
        } else {
          findAndShowFirstIncompleteStep();
        }
      }
    }

    // Dismiss step permanently
    window.dismissStep = async function(stepNum) {
      if (!currentUser) return;
      
      const dismissKey = getStepDismissKey(stepNum);
      progress[dismissKey] = true;
      
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          profileSetupProgress: {
            ...userProfile.profileSetupProgress,
            [dismissKey]: true,
            lastUpdated: serverTimestamp()
          }
        }, { merge: true });
        
        console.log(`‚úÖ Step ${stepNum} dismissed`);
        
        updateProgressBar();
        
        if (isAllComplete()) {
          await markSetupComplete();
          showCompletion();
        } else {
          window.skipStep(stepNum);
        }
        
      } catch (error) {
        console.error('Error dismissing step:', error);
      }
    }

    // Get dismiss key for a step
    function getStepDismissKey(stepNum) {
      switch(stepNum) {
        case 1: return 'playerInfoDismissed';
        case 2: return 'appInstallDismissed';
        case 3: return 'notificationsDismissed';
        case 4: return 'directoryDismissed';
        default: return '';
      }
    }

    // Mark setup as complete
    async function markSetupComplete() {
      if (!currentUser) return;
      
      try {
        const userRef = doc(db, 'users', currentUser.uid);
        await setDoc(userRef, {
          profileSetupProgress: {
            ...userProfile.profileSetupProgress,
            completedAt: serverTimestamp()
          }
        }, { merge: true });
        
        console.log('üéâ Profile setup marked complete');
        
      } catch (error) {
        console.error('Error marking setup complete:', error);
      }
    }

    // Show completion card
    function showCompletion() {
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      
      document.getElementById('completionCard').classList.add('active');
      
      // Update all progress steps to complete
      document.querySelectorAll('.progress-step').forEach(step => {
        step.classList.remove('active');
        step.classList.add('complete');
        step.querySelector('.step-circle').textContent = '‚úì';
      });
    }

    // Check for return from profile page
    function checkReturnFromProfile() {
      const urlParams = new URLSearchParams(window.location.search);
      const fromTab = urlParams.get('from');
      
      if (fromTab && currentUser) {
        loadUserProfile();
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      checkReturnFromProfile();
    });
  </script>
  
  <!-- Navigation Component -->
  <script type="module">
    import { NavigationComponent } from './nav-component.js';
  </script>
</body>
</html>
