<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Submit Game Score | Mountainside Aces</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="mobile-enhancements.css">
  <style>
    .submit-score-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .submit-score-container h1 {
      color: var(--primary-color);
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: #666;
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    .auth-gate {
      text-align: center;
      padding: 3rem 1rem;
    }

    .auth-gate h2 {
      color: var(--primary-color);
      margin-bottom: 1rem;
    }

    .error-message {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .form-section {
      margin-bottom: 2rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid #e0e0e0;
    }

    .form-section:last-child {
      border-bottom: none;
    }

    .form-section h2 {
      color: var(--primary-color);
      font-size: 1.3rem;
      margin-bottom: 1rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #333;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .score-inputs {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      align-items: center;
    }

    .vs-separator {
      font-size: 1.2rem;
      font-weight: bold;
      color: #666;
      text-align: center;
      padding-top: 2rem;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin: 0;
    }

    .submit-button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 1rem 2rem;
      font-size: 1.1rem;
      font-weight: 600;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      transition: background 0.2s;
    }

    .submit-button:hover {
      background: var(--secondary-color);
    }

    .submit-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .success-message {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }

    .game-preview {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      border: 1px solid #dee2e6;
    }

    .game-preview h3 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 1.1rem;
    }

    .preview-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid #dee2e6;
    }

    .preview-row:last-child {
      border-bottom: none;
    }

    .preview-label {
      font-weight: 600;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid var(--primary-color);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 0.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
      .submit-score-container {
        margin: 1rem;
        padding: 1rem;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .score-inputs {
        grid-template-columns: 1fr;
      }

      .vs-separator {
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
  <div id="nav-placeholder"></div>

  <div class="submit-score-container">
    <!-- Auth Gate (shown when not authorized) -->
    <div id="authGate" class="auth-gate" style="display: none;">
      <h2>üîí Authorization Required</h2>
      <p>You must be signed in as a Captain, Team Staff, League Staff, or Admin to submit game scores.</p>
      <button onclick="location.href='signin.html'" class="submit-button" style="max-width: 300px; margin: 1rem auto;">
        Sign In
      </button>
    </div>

    <!-- Form (shown when authorized) -->
    <div id="scoreForm" style="display: none;">
      <h1>Submit Game Score</h1>
      <p class="subtitle">Update game results for the current season</p>

      <div id="messageArea"></div>

      <form id="submitScoreForm">
        <!-- Game Selection -->
        <div class="form-section">
          <h2>Select Game</h2>
          <div class="form-group">
            <label for="seasonSelect">Season *</label>
            <select id="seasonSelect" required>
              <option value="">Loading seasons...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="gameSelect">Game *</label>
            <select id="gameSelect" required disabled>
              <option value="">Select a season first</option>
            </select>
          </div>
        </div>

        <!-- Score Entry -->
        <div class="form-section">
          <h2>Enter Score</h2>
          <div class="score-inputs">
            <div class="form-group">
              <label for="homeScore"><span id="homeTeamLabel">Home Team</span> Score *</label>
              <input type="number" id="homeScore" min="0" required>
            </div>
            <div class="vs-separator">vs</div>
            <div class="form-group">
              <label for="awayScore"><span id="awayTeamLabel">Away Team</span> Score *</label>
              <input type="number" id="awayScore" min="0" required>
            </div>
          </div>
        </div>

        <!-- Game Details -->
        <div class="form-section">
          <h2>Game Details</h2>
          <div class="form-group checkbox-group">
            <input type="checkbox" id="forfeitCheckbox">
            <label for="forfeitCheckbox">This game was a forfeit</label>
          </div>
          <div class="form-group">
            <label for="gameNotes">Notes (Optional)</label>
            <input type="text" id="gameNotes" placeholder="Any additional details about the game">
          </div>
        </div>

        <!-- Preview -->
        <div id="gamePreview" class="game-preview" style="display: none;">
          <h3>Preview</h3>
          <div class="preview-row">
            <span class="preview-label">Home Team:</span>
            <span id="previewHome">-</span>
          </div>
          <div class="preview-row">
            <span class="preview-label">Away Team:</span>
            <span id="previewAway">-</span>
          </div>
          <div class="preview-row">
            <span class="preview-label">Score:</span>
            <span id="previewScore">-</span>
          </div>
          <div class="preview-row">
            <span class="preview-label">Winner:</span>
            <span id="previewWinner" style="font-weight: bold; color: var(--primary-color);">-</span>
          </div>
          <div class="preview-row" id="previewForfeitRow" style="display: none;">
            <span class="preview-label">Status:</span>
            <span style="color: #c33; font-weight: bold;">FORFEIT</span>
          </div>
        </div>

        <button type="submit" class="submit-button" id="submitButton">
          Submit Score
        </button>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth } from './firebase-auth.js';
    import { db } from './firebase-config.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      collection, 
      getDocs, 
      doc, 
      updateDoc,
      getDoc,
      Timestamp,
      query,
      where,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    let currentUser = null;
    let userProfile = null;
    let selectedGame = null;
    let allGames = [];

    // Check authorization on page load
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        await checkAuthorization();
      } else {
        showAuthGate();
      }
    });

    async function checkAuthorization() {
      try {
        const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
        
        if (!userDoc.exists()) {
          showError('User profile not found. Please complete your profile setup.');
          showAuthGate();
          return;
        }

        userProfile = userDoc.data();

        // Check if user has authorization
        const isAuthorized = 
          userProfile.isCaptain === true ||
          userProfile.isAdmin === true ||
          userProfile.userType === 'league-staff' ||
          userProfile.userType === 'team-staff';

        if (isAuthorized) {
          showForm();
          await loadSeasons();
        } else {
          showError('You do not have permission to submit game scores. Please contact a league administrator if you believe this is an error.');
          showAuthGate();
        }
      } catch (error) {
        console.error('Error checking authorization:', error);
        showError('Error checking authorization. Please try again.');
        showAuthGate();
      }
    }

    function showAuthGate() {
      document.getElementById('authGate').style.display = 'block';
      document.getElementById('scoreForm').style.display = 'none';
    }

    function showForm() {
      document.getElementById('authGate').style.display = 'none';
      document.getElementById('scoreForm').style.display = 'block';
    }

    function showError(message) {
      const messageArea = document.getElementById('messageArea');
      messageArea.innerHTML = `<div class="error-message">${message}</div>`;
    }

    function showSuccess(message) {
      const messageArea = document.getElementById('messageArea');
      messageArea.innerHTML = `<div class="success-message">${message}</div>`;
      setTimeout(() => {
        messageArea.innerHTML = '';
      }, 5000);
    }

    async function loadSeasons() {
      try {
        const seasonsSnapshot = await getDocs(collection(db, 'seasons'));
        const seasons = [];
        
        seasonsSnapshot.forEach(doc => {
          const data = doc.data();
          seasons.push({
            id: doc.id,
            year: data.year,
            season: data.season,
            isActive: data.isActive || false
          });
        });

        // Sort seasons (active first, then by year desc)
        seasons.sort((a, b) => {
          if (a.isActive !== b.isActive) return b.isActive ? 1 : -1;
          if (b.year !== a.year) return b.year - a.year;
          return a.season === 'spring' ? -1 : 1;
        });

        const seasonSelect = document.getElementById('seasonSelect');
        seasonSelect.innerHTML = '<option value="">Select a season</option>';
        
        seasons.forEach(season => {
          const option = document.createElement('option');
          option.value = season.id;
          option.textContent = `${season.year} ${season.season.charAt(0).toUpperCase() + season.season.slice(1)}${season.isActive ? ' (Current)' : ''}`;
          if (season.isActive) {
            option.selected = true;
          }
          seasonSelect.appendChild(option);
        });

        // Auto-load games if active season is selected
        if (seasons.some(s => s.isActive)) {
          await loadGames(seasonSelect.value);
        }

        seasonSelect.addEventListener('change', async (e) => {
          if (e.target.value) {
            await loadGames(e.target.value);
          } else {
            document.getElementById('gameSelect').innerHTML = '<option value="">Select a season first</option>';
            document.getElementById('gameSelect').disabled = true;
          }
        });

      } catch (error) {
        console.error('Error loading seasons:', error);
        showError('Error loading seasons. Please refresh the page.');
      }
    }

    async function loadGames(seasonId) {
      try {
        const gameSelect = document.getElementById('gameSelect');
        gameSelect.innerHTML = '<option value="">Loading games...</option>';
        gameSelect.disabled = true;

        const gamesSnapshot = await getDocs(collection(db, 'seasons', seasonId, 'games'));
        allGames = [];
        
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        gamesSnapshot.forEach(doc => {
          const data = doc.data();
          
          // Parse game date
          let gameDate;
          if (data.date?.seconds) {
            gameDate = new Date(data.date.seconds * 1000);
          } else if (data.date) {
            gameDate = new Date(data.date);
          }

          // Only show games that are today or in the past, and don't have scores yet
          if (gameDate <= today) {
            const hasScore = 
              (data.homeScore !== undefined && data.homeScore !== null) || 
              (data.awayScore !== undefined && data.awayScore !== null) ||
              (data.winner && data.winner.trim() !== '');

            allGames.push({
              id: doc.id,
              ...data,
              gameDate: gameDate,
              hasScore: hasScore,
              seasonId: seasonId
            });
          }
        });

        // Sort by date (most recent first)
        allGames.sort((a, b) => b.gameDate - a.gameDate);

        gameSelect.innerHTML = '<option value="">Select a game</option>';
        
        if (allGames.length === 0) {
          gameSelect.innerHTML = '<option value="">No games available for scoring</option>';
          return;
        }

        allGames.forEach((game, index) => {
          const option = document.createElement('option');
          option.value = index;
          
          const dateStr = game.gameDate.toLocaleDateString('en-US', { 
            month: 'short', 
            day: 'numeric' 
          });
          
          const homeTeam = game.homeTeamName || game.homeTeam || 'Home';
          const awayTeam = game.awayTeamName || game.awayTeam || 'Away';
          
          const statusBadge = game.hasScore ? ' ‚úì' : ' [No Score]';
          
          option.textContent = `${dateStr}: ${homeTeam} vs ${awayTeam}${statusBadge}`;
          gameSelect.appendChild(option);
        });

        gameSelect.disabled = false;

        gameSelect.addEventListener('change', (e) => {
          if (e.target.value !== '') {
            loadGameDetails(parseInt(e.target.value));
          } else {
            clearGameDetails();
          }
        });

      } catch (error) {
        console.error('Error loading games:', error);
        showError('Error loading games. Please try again.');
        gameSelect.innerHTML = '<option value="">Error loading games</option>';
      }
    }

    function loadGameDetails(gameIndex) {
      selectedGame = allGames[gameIndex];
      
      const homeTeam = selectedGame.homeTeamName || selectedGame.homeTeam || 'Home';
      const awayTeam = selectedGame.awayTeamName || selectedGame.awayTeam || 'Away';
      
      document.getElementById('homeTeamLabel').textContent = homeTeam;
      document.getElementById('awayTeamLabel').textContent = awayTeam;
      
      // Pre-fill existing scores if any
      if (selectedGame.homeScore !== undefined && selectedGame.homeScore !== null) {
        document.getElementById('homeScore').value = selectedGame.homeScore;
      } else {
        document.getElementById('homeScore').value = '';
      }
      
      if (selectedGame.awayScore !== undefined && selectedGame.awayScore !== null) {
        document.getElementById('awayScore').value = selectedGame.awayScore;
      } else {
        document.getElementById('awayScore').value = '';
      }
      
      document.getElementById('forfeitCheckbox').checked = selectedGame.forfeit || false;
      document.getElementById('gameNotes').value = '';
      
      updatePreview();
    }

    function clearGameDetails() {
      selectedGame = null;
      document.getElementById('homeTeamLabel').textContent = 'Home Team';
      document.getElementById('awayTeamLabel').textContent = 'Away Team';
      document.getElementById('homeScore').value = '';
      document.getElementById('awayScore').value = '';
      document.getElementById('forfeitCheckbox').checked = false;
      document.getElementById('gameNotes').value = '';
      document.getElementById('gamePreview').style.display = 'none';
    }

    function updatePreview() {
      if (!selectedGame) return;

      const homeScore = parseInt(document.getElementById('homeScore').value) || 0;
      const awayScore = parseInt(document.getElementById('awayScore').value) || 0;
      const isForfeit = document.getElementById('forfeitCheckbox').checked;

      const homeTeam = selectedGame.homeTeamName || selectedGame.homeTeam || 'Home';
      const awayTeam = selectedGame.awayTeamName || selectedGame.awayTeam || 'Away';

      let winner = '';
      if (homeScore > awayScore) {
        winner = homeTeam;
      } else if (awayScore > homeScore) {
        winner = awayTeam;
      } else {
        winner = 'Tie';
      }

      document.getElementById('previewHome').textContent = homeTeam;
      document.getElementById('previewAway').textContent = awayTeam;
      document.getElementById('previewScore').textContent = `${homeScore} - ${awayScore}`;
      document.getElementById('previewWinner').textContent = winner;
      document.getElementById('previewForfeitRow').style.display = isForfeit ? 'flex' : 'none';
      document.getElementById('gamePreview').style.display = 'block';
    }

    // Add event listeners for live preview
    document.getElementById('homeScore')?.addEventListener('input', updatePreview);
    document.getElementById('awayScore')?.addEventListener('input', updatePreview);
    document.getElementById('forfeitCheckbox')?.addEventListener('change', updatePreview);

    // Form submission
    document.getElementById('submitScoreForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!selectedGame) {
        showError('Please select a game first.');
        return;
      }

      const homeScore = parseInt(document.getElementById('homeScore').value);
      const awayScore = parseInt(document.getElementById('awayScore').value);
      const isForfeit = document.getElementById('forfeitCheckbox').checked;
      const notes = document.getElementById('gameNotes').value.trim();

      if (isNaN(homeScore) || isNaN(awayScore)) {
        showError('Please enter valid scores for both teams.');
        return;
      }

      if (homeScore < 0 || awayScore < 0) {
        showError('Scores cannot be negative.');
        return;
      }

      // Determine winner
      const homeTeamId = selectedGame.homeTeamId || selectedGame.homeTeam?.toLowerCase().replace(/\s+/g, '_') || null;
      const awayTeamId = selectedGame.awayTeamId || selectedGame.awayTeam?.toLowerCase().replace(/\s+/g, '_') || null;
      
      let winner = null;
      if (homeScore > awayScore) {
        winner = homeTeamId;
      } else if (awayScore > homeScore) {
        winner = awayTeamId;
      } else {
        winner = 'tie';
      }

      // Prepare update data
      const updateData = {
        homeScore: homeScore,
        awayScore: awayScore,
        winner: winner,
        status: 'completed',
        forfeit: isForfeit,
        lastScoreUpdate: Timestamp.now(),
        scoreSubmittedBy: currentUser.uid,
        scoreSubmittedByEmail: currentUser.email
      };

      if (notes) {
        updateData.gameNotes = notes;
      }

      // Confirm before submitting
      const homeTeam = selectedGame.homeTeamName || selectedGame.homeTeam || 'Home';
      const awayTeam = selectedGame.awayTeamName || selectedGame.awayTeam || 'Away';
      const confirmMessage = `Submit this score?\n\n${homeTeam}: ${homeScore}\n${awayTeam}: ${awayScore}\n${isForfeit ? '\n‚ö†Ô∏è FORFEIT' : ''}`;
      
      if (!confirm(confirmMessage)) {
        return;
      }

      // Disable submit button and show loading
      const submitButton = document.getElementById('submitButton');
      submitButton.disabled = true;
      submitButton.innerHTML = '<span class="loading-spinner"></span>Submitting...';

      try {
        const gameRef = doc(db, 'seasons', selectedGame.seasonId, 'games', selectedGame.id);
        await updateDoc(gameRef, updateData);

        showSuccess(`‚úÖ Score submitted successfully! ${homeTeam} ${homeScore} - ${awayTeam} ${awayScore}`);
        
        // Reset form
        document.getElementById('submitScoreForm').reset();
        clearGameDetails();
        
        // Reload games to reflect the update
        const seasonSelect = document.getElementById('seasonSelect');
        if (seasonSelect.value) {
          await loadGames(seasonSelect.value);
        }

      } catch (error) {
        console.error('Error submitting score:', error);
        showError(`Error submitting score: ${error.message}`);
      } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Submit Score';
      }
    });
  </script>

  <script src="navigation.js"></script>
  <script src="mobile-enhancements.js"></script>
</body>
</html>
