<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Team Stats - Aces Stats</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
    line-height: 1.6;
  }
  
  .page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
  }
  
  .team-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 3rem 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 2rem;
    position: relative;
    overflow: hidden;
  }
  
  .team-header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
  }
  
  .team-logo {
    height: 120px;
    max-width: 120px;
    object-fit: contain;
    border: 4px solid rgba(255,255,255,0.3);
    border-radius: 12px;
    background: rgba(255,255,255,0.1);
    padding: 1rem;
    display: none;
  }
  
  .team-logo.loaded {
    display: block;
  }
  
  .team-info {
    flex: 1;
  }
  
  .team-header h1 {
    margin: 0;
    font-size: 2.5rem;
    font-weight: bold;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }
  
  .team-description {
    font-size: 1.1rem;
    opacity: 0.9;
    margin: 1rem 0 0 0;
  }
  
  .summary {
    background: white;
    padding: 2rem;
    margin-bottom: 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
    position: relative;
    overflow: hidden;
  }
  
  .summary::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  }
  
  .summary h2 {
    margin: 0 0 1.5rem 0;
    color: #333;
    font-size: 1.5rem;
    font-weight: 700;
  }
  
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
  }
  
  .summary-item {
    text-align: center;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #667eea;
  }
  
  .summary-number {
    font-size: 2rem;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 0.5rem;
  }
  
  .summary-label {
    color: #666;
    font-weight: 600;
  }
  
  .filters-section {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
  }
  
  .filters-container {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: center;
    justify-content: center;
  }
  
  .filter-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .filter-group label {
    font-weight: 600;
    color: #333;
  }
  
  .filter-group select {
    padding: 0.5rem 1rem;
    border: 2px solid #e1e5e9;
    border-radius: 6px;
    background: white;
    color: #333;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  
  .filter-group select:focus {
    outline: none;
    border-color: #667eea;
  }
  
  .stats-table-container {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
    position: relative;
    margin-bottom: 2rem;
  }
  
  .stats-table-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
  }
  
  .game-results-section {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
    position: relative;
    margin-bottom: 2rem;
  }
  
  .game-results-section::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
  }
  
  .game-results-header {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 1.5rem;
    text-align: center;
  }
  
  .game-results-header h3 {
    margin: 0;
    font-size: 1.3rem;
    font-weight: 700;
  }
  
  .team-record {
    background: #f8f9fa;
    padding: 1.5rem;
    text-align: center;
    border-bottom: 1px solid #e1e5e9;
  }
  
  .team-record h4 {
    margin: 0 0 0.5rem 0;
    color: #333;
    font-size: 1.3rem;
  }
  
  .team-record p {
    margin: 0;
    color: #666;
    font-size: 1rem;
  }
  
  .games-table-container {
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
  }
  
  .games-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }
  
  .games-table th {
    position: sticky;
    top: 0;
    background: #f8f9fa;
    padding: 0.75rem 0.5rem;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    text-align: center;
    color: #333;
  }
  
  .games-table td {
    padding: 0.5rem;
    border-bottom: 1px solid #e1e5e9;
    text-align: center;
  }
  
  .games-table tbody tr:hover {
    background: #f8f9fa;
  }
  
  .result-win {
    color: #28a745;
    font-weight: bold;
  }
  
  .result-loss {
    color: #dc3545;
    font-weight: bold;
  }
  
  .result-tie {
    color: #6c757d;
    font-weight: bold;
  }
  
  table {
    border-collapse: collapse;
    width: 100%;
    margin: 0;
    background: white;
  }
  
  th, td {
    border: none;
    border-bottom: 1px solid #e1e5e9;
    padding: 1rem;
    text-align: center;
  }
  
  th {
    cursor: pointer;
    background: #667eea;
    color: white;
    font-weight: 600;
    user-select: none;
    transition: background-color 0.3s ease;
  }
  
  th:hover {
    background: #5a6fd8;
  }
  
  th.asc::after { content: " ▲"; }
  th.desc::after { content: " ▼"; }
  
  tbody tr:hover {
    background: #f8f9fa;
  }
  
  tbody tr:nth-child(even) {
    background: #fafafa;
  }
  
  tbody tr:nth-child(even):hover {
    background: #e8f4fd;
  }
  
  table a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
  }
  
  table a:hover {
    color: #4c63d2;
    text-decoration: underline;
  }
  
  .back-nav {
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
  }
  
  .back-nav a {
    padding: 0.5rem 1rem;
    border: 2px solid #667eea;
    background: white;
    color: #667eea;
    text-decoration: none;
    border-radius: 6px;
    font-weight: 600;
    margin-right: 1rem;
    transition: all 0.3s ease;
    display: inline-block;
  }
  
  .back-nav a:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
  }
  
  /* Loading state */
  .loading {
    text-align: center;
    padding: 3rem;
    color: #666;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.07);
    border: 1px solid #e1e5e9;
  }
  
  .loading::before {
    content: "⏳";
    display: block;
    font-size: 3rem;
    margin-bottom: 1rem;
    animation: spin 2s linear infinite;
  }
  
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }
  
  /* Mobile responsive adjustments */
  @media (max-width: 768px) {
    .page-container {
      padding: 1rem;
    }
    
    .team-header {
      flex-direction: column;
      text-align: center;
      padding: 2rem 1rem;
    }
    
    .team-header h1 {
      font-size: 2rem;
    }
    
    .team-logo {
      height: 80px;
      max-width: 80px;
    }
    
    .filters-container {
      flex-direction: column;
      gap: 1rem;
    }
    
    .filter-group {
      flex-direction: column;
      text-align: center;
      gap: 0.5rem;
    }
    
    .summary-grid {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
    
    th, td {
      padding: 0.75rem 0.5rem;
      font-size: 0.9em;
    }
    
    .games-table th,
    .games-table td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8rem;
    }
  }
  
  @media (max-width: 480px) {
    .back-nav a {
      display: block;
      margin: 0.25rem 0;
      text-align: center;
    }
    
    .summary-grid {
      grid-template-columns: 1fr 1fr;
    }
    
    th, td {
      padding: 0.5rem 0.25rem;
      font-size: 0.8em;
    }
  }
</style>
</head>
<body>
<div class="page-container">
  <div class="back-nav">
    <a href="teams.html">← Back to All Teams</a>
    <a href="index.html">Home</a>
    <a href="batting.html">Batting Stats</a>
    <a href="pitching.html">Pitching Stats</a>
  </div>

  <div class="team-header">
    <img id="team-logo" class="team-logo" src="" alt="" onerror="this.style.display='none';">
    
    <div class="team-info">
      <h1>Team Stats: <span id="team-name">Loading...</span></h1>
      <p class="team-description">Complete season-by-season statistics and performance history</p>
    </div>
  </div>

  <div class="summary">
    <h2>Team Overview</h2>
    <div class="summary-grid" id="summary-grid">
      <div class="loading">Loading team statistics...</div>
    </div>
  </div>

  <div class="filters-section">
    <div class="filters-container">
      <div class="filter-group">
        <label for="yearFilter">Year:</label>
        <select id="yearFilter">
          <option value="All">All Years</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="seasonFilter">Season:</label>
        <select id="seasonFilter">
          <option value="All">All Seasons</option>
        </select>
      </div>
    </div>
  </div>

  <div class="stats-table-container">
    <table id="team-stats-table">
      <thead>
        <tr>
          <th>Year</th>
          <th>Season</th>
          <th>Name</th>
          <th>Games</th>
          <th>At Bats</th>
          <th>Hits</th>
          <th>Runs</th>
          <th>Walks</th>
          <th>AcesBPI</th>
          <th>BA</th>
          <th>OBP</th>
          <th>Sub</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows generated dynamically -->
      </tbody>
    </table>
  </div>

  <div id="game-results-section" class="game-results-section" style="display: none;">
    <div class="game-results-header">
      <h3>Team Game Results</h3>
    </div>
    <div id="team-record" class="team-record">
      <!-- Team record will be inserted here -->
    </div>
    <div id="games-content" class="games-table-container">
      <!-- Games table will be inserted here -->
    </div>
  </div>
</div>

<script>
// Global variables
let allData = [];
let allGames = [];
let teamData = [];
let teamName = "";
let currentSort = { column: null, dir: "asc" };

// Get team name from URL
const params = new URLSearchParams(window.location.search);
teamName = params.get("team");

if (!teamName) {
  document.body.innerHTML = '<div class="page-container"><h1>Error: Team not specified</h1><p><a href="teams.html">Return to all teams</a></p></div>';
} else {
  loadTeamData();
}

async function loadTeamData() {
  try {
    // Load both player data and games data
    const [dataResponse, gamesResponse] = await Promise.all([
      fetch("data.json"),
      fetch("games.json")
    ]);
    
    if (!dataResponse.ok) throw new Error('Failed to load data.json');
    
    allData = await dataResponse.json();
    
    // Load games data if available
    if (gamesResponse.ok) {
      allGames = await gamesResponse.json();
      console.log('Games data loaded:', allGames.length, 'games');
    } else {
      console.warn('games.json not available');
      allGames = [];
    }
    
    // Clean and filter data for this team
    teamData = allData
      .filter(p => p.team && p.team.trim() === teamName)
      .map(p => ({
        ...p,
        name: p.name ? p.name.trim() : "",
        team: p.team ? p.team.trim() : "",
        year: p.year ? String(p.year).trim() : "",
        season: p.season ? p.season.trim() : "",
        games: Number(p.games) || 0,
        atBats: Number(p.atBats) || 0,
        hits: Number(p.hits) || 0,
        runs: Number(p.runs) || 0,
        walks: Number(p.walks) || 0,
        acesBPI: Number(p.AcesWar) || 0,
        sub: p.sub || p.Sub || ""
      }));
    
    if (teamData.length === 0) {
      document.body.innerHTML = `
        <div class="page-container">
          <h1>Team "${teamName}" not found</h1>
          <p><a href="teams.html">Return to all teams</a></p>
        </div>
      `;
      return;
    }
    
    initializePage();
    
  } catch (error) {
    console.error("Error loading team data:", error);
    document.body.innerHTML = `
      <div class="page-container">
        <h1>Error loading team data</h1>
        <p>Could not load statistics. Please check that data files are available.</p>
        <p><a href="teams.html">Return to all teams</a></p>
      </div>
    `;
  }
}

function initializePage() {
  // Update page title and team name
  document.title = `${teamName} - Team Stats`;
  document.getElementById("team-name").textContent = teamName;
  
  // Try to load team logo
  const logoElement = document.getElementById("team-logo");
  logoElement.src = `logos/${teamName.toLowerCase().replace(/\s+/g, '_')}.png`;
  logoElement.alt = `${teamName} logo`;
  logoElement.onload = function() {
    this.classList.add('loaded');
  };
  
  populateFilters();
  renderSummary();
  renderTable();
  renderGameResults();
  attachSorting();
}

function populateFilters() {
  // Get unique years and seasons
  const years = [...new Set(teamData.map(p => p.year))].sort((a, b) => b.localeCompare(a));
  const seasons = [...new Set(teamData.map(p => p.season))].sort();
  
  // Populate year filter
  const yearFilter = document.getElementById("yearFilter");
  years.forEach(year => {
    const option = document.createElement("option");
    option.value = year;
    option.textContent = year;
    yearFilter.appendChild(option);
  });
  
  // Populate season filter
  const seasonFilter = document.getElementById("seasonFilter");
  seasons.forEach(season => {
    const option = document.createElement("option");
    option.value = season;
    option.textContent = season;
    seasonFilter.appendChild(option);
  });
  
  // Add event listeners
  yearFilter.addEventListener("change", () => {
    renderTable();
    renderGameResults();
  });
  seasonFilter.addEventListener("change", () => {
    renderTable();
    renderGameResults();
  });
}

function renderSummary() {
  const uniquePlayers = new Set(teamData.map(p => p.name)).size;
  const uniqueSeasons = new Set(teamData.map(p => `${p.year} ${p.season}`)).size;
  
  // Calculate team games from games.json
  let totalTeamGames = 0;
  let gamesDisplay = "";
  let gamesLabel = "";
  
  if (allGames && allGames.length > 0) {
    const teamGames = allGames.filter(g => 
      g["home team"] === teamName || g["away team"] === teamName
    );
    
    totalTeamGames = teamGames.length;
    const regularSeasonGames = teamGames.filter(g => g.game_type === 'Regular').length;
    const playoffGames = teamGames.filter(g => g.game_type === 'Playoff').length;
    
    if (totalTeamGames > 0) {
      gamesDisplay = totalTeamGames.toString();
      if (regularSeasonGames > 0 && playoffGames > 0) {
        gamesDisplay += ` (${regularSeasonGames} Regular, ${playoffGames} Playoff)`;
      } else if (regularSeasonGames > 0) {
        gamesDisplay += ` Regular`;
      } else if (playoffGames > 0) {
        gamesDisplay += ` Playoff`;
      }
      gamesLabel = "Team Games";
    } else {
      totalTeamGames = teamData.reduce((sum, p) => sum + p.games, 0);
      gamesDisplay = totalTeamGames.toString();
      gamesLabel = "Player Games";
    }
  } else {
    totalTeamGames = teamData.reduce((sum, p) => sum + p.games, 0);
    gamesDisplay = totalTeamGames.toString();
    gamesLabel = "Player Games";
  }
  
  const totalAtBats = teamData.reduce((sum, p) => sum + p.atBats, 0);
  const totalHits = teamData.reduce((sum, p) => sum + p.hits, 0);
  const totalRuns = teamData.reduce((sum, p) => sum + p.runs, 0);
  const teamBA = totalAtBats > 0 ? (totalHits / totalAtBats).toFixed(3) : ".000";
  
  const years = [...new Set(teamData.map(p => p.year))].sort();
  const yearsActive = years.length > 1 ? `${years[0]} - ${years[years.length - 1]}` : years[0];
  
  const summaryHTML = `
    <div class="summary-item">
      <div class="summary-number">${uniquePlayers}</div>
      <div class="summary-label">Total Players</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${uniqueSeasons}</div>
      <div class="summary-label">Seasons Played</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${yearsActive}</div>
      <div class="summary-label">Years Active</div>
    </div>
    <div class="summary-item">
      <div class="summary-number" style="font-size: ${gamesDisplay.length > 8 ? '1.5rem' : '2rem'};">${gamesDisplay}</div>
      <div class="summary-label">${gamesLabel}</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${totalHits}</div>
      <div class="summary-label">Team Hits</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${teamBA}</div>
      <div class="summary-label">Team Average</div>
    </div>
  `;
  
  document.getElementById("summary-grid").innerHTML = summaryHTML;
}

function renderTable() {
  const yearFilter = document.getElementById("yearFilter").value;
  const seasonFilter = document.getElementById("seasonFilter").value;
  
  // Filter data based on selections
  let filteredData = teamData.filter(p => {
    return (yearFilter === "All" || p.year === yearFilter) &&
           (seasonFilter === "All" || p.season === seasonFilter);
  });
  
  const tbody = document.querySelector("#team-stats-table tbody");
  tbody.innerHTML = "";
  
  if (filteredData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="12">No data matches the current filters</td></tr>';
    return;
  }
  
  // Sort by year (desc), then season (Fall before Summer), then name
  filteredData.sort((a, b) => {
    if (a.year !== b.year) return b.year.localeCompare(a.year);
    if (a.season !== b.season) {
      const seasonOrder = { 'Fall': 1, 'Summer': 2 };
      return (seasonOrder[a.season] || 999) - (seasonOrder[b.season] || 999);
    }
    return a.name.localeCompare(b.name);
  });
  
  filteredData.forEach(p => {
    const BA = p.atBats > 0 ? (p.hits / p.atBats).toFixed(3) : ".000";
    const OBP = (p.atBats + p.walks) > 0 
      ? ((p.hits + p.walks) / (p.atBats + p.walks)).toFixed(3) 
      : ".000";
    
    const row = `
      <tr>
        <td>${p.year}</td>
        <td>${p.season}</td>
        <td><a href="player.html?name=${encodeURIComponent(p.name)}">${p.name}</a></td>
        <td>${p.games}</td>
        <td>${p.atBats}</td>
        <td>${p.hits}</td>
        <td>${p.runs}</td>
        <td>${p.walks}</td>
        <td>${p.acesBPI}</td>
        <td>${BA}</td>
        <td>${OBP}</td>
        <td>${p.sub || ""}</td>
      </tr>
    `;
    tbody.innerHTML += row;
  });
}

function renderGameResults() {
  if (!allGames || allGames.length === 0) {
    console.log('No games data available');
    return;
  }
  
  const yearFilter = document.getElementById("yearFilter").value;
  const seasonFilter = document.getElementById("seasonFilter").value;
  
  // Filter team games based on current filters
  let teamGames = allGames.filter(g => 
    (g["home team"] === teamName || g["away team"] === teamName) &&
    (yearFilter === "All" || g.year === yearFilter) &&
    (seasonFilter === "All" || g.season === seasonFilter)
  );
  
  if (teamGames.length === 0) {
    document.getElementById("game-results-section").style.display = "none";
    return;
  }
  
  console.log(`Found ${teamGames.length} games for ${teamName}`);
  
  // Calculate team record
  const record = calculateTeamRecord(teamGames);
  
  // Separate regular season and playoff games
  const regularGames = teamGames.filter(g => g.game_type === 'Regular');
  const playoffGames = teamGames.filter(g => g.game_type === 'Playoff');
  
  // Update team record display
  const recordHTML = `
    <h4>Team Record: ${record.wins}-${record.losses}-${record.ties} (${record.winPct}% Win Rate)</h4>
    <p>Regular Season: ${record.regular.wins}-${record.regular.losses}-${record.regular.ties} | 
       Playoffs: ${record.playoff.wins}-${record.playoff.losses}-${record.playoff.ties}</p>
  `;
  
  document.getElementById("team-record").innerHTML = recordHTML;
  
  // Generate games table
  let gamesHTML = '';
  
  if (regularGames.length > 0) {
    gamesHTML += `
      <h4 style="margin: 1rem 0 0.5rem 0; color: #333;">Regular Season Games (${regularGames.length})</h4>
      <table class="games-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Year</th>
            <th>Season</th>
            <th>Opponent</th>
            <th>H/A</th>
            <th>Score</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          ${regularGames.map(game => renderGameRow(game)).join('')}
        </tbody>
      </table>
    `;
  }
  
  if (playoffGames.length > 0) {
    gamesHTML += `
      <h4 style="margin: 1rem 0 0.5rem 0; color: #333;">Playoff Games (${playoffGames.length})</h4>
      <table class="games-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Year</th>
            <th>Season</th>
            <th>Opponent</th>
            <th>H/A</th>
            <th>Score</th>
            <th>Result</th>
          </tr>
        </thead>
        <tbody>
          ${playoffGames.map(game => renderGameRow(game)).join('')}
        </tbody>
      </table>
    `;
  }
  
  document.getElementById("games-content").innerHTML = gamesHTML;
  document.getElementById("game-results-section").style.display = "block";
}

function renderGameRow(game) {
  const isHome = game["home team"] === teamName;
  const opponent = isHome ? game["away team"] : game["home team"];
  const homeAwayText = isHome ? "vs" : "@";
  
  const homeScore = game["home score"];
  const awayScore = game["away score"];
  const forfeit = game.forfeit === "Yes" ? " (Forfeit)" : "";
  
  // Determine result
  let result = "T";
  let resultClass = "result-tie";
  
  if (game.winner === teamName) {
    result = "W";
    resultClass = "result-win";
  } else if (game.winner !== "Tie" && !game.winner.includes("Forfeit - Tie")) {
    result = "L";
    resultClass = "result-loss";
  }
  
  // Format score
  let scoreDisplay;
  if (homeScore === "W" || homeScore === "L") {
    scoreDisplay = isHome ? 
      (homeScore === "W" ? "W" : "L") : 
      (awayScore === "W" ? "W" : "L");
  } else {
    const teamScore = isHome ? homeScore : awayScore;
    const oppScore = isHome ? awayScore : homeScore;
    scoreDisplay = `${teamScore}-${oppScore}`;
  }
  
  // Create opponent link if they have a team page
  const validTeams = ['Aces', 'Bears', 'Brewers', 'Cardinals', 'Cubs', 'Dodgers', 'Giants', 'Marlins', 'Mets', 'Nationals', 'Orioles', 'Padres', 'Pirates', 'Rangers', 'Rays', 'Red Sox', 'Reds', 'Rockies', 'Tigers', 'Twins', 'White Sox', 'Yankees'];
  const opponentLink = validTeams.includes(opponent) ? 
    `<a href="team.html?team=${encodeURIComponent(opponent)}">${opponent}</a>` : 
    opponent;
  
  return `
    <tr>
      <td>${game.date || ''}</td>
      <td>${game.year}</td>
      <td>${game.season}</td>
      <td>${opponentLink}</td>
      <td>${homeAwayText}</td>
      <td>${scoreDisplay}${forfeit}</td>
      <td class="${resultClass}">${result}</td>
    </tr>
  `;
}

function calculateTeamRecord(games) {
  let wins = 0, losses = 0, ties = 0;
  let regularWins = 0, regularLosses = 0, regularTies = 0;
  let playoffWins = 0, playoffLosses = 0, playoffTies = 0;
  
  games.forEach(game => {
    const isRegular = game.game_type === 'Regular';
    
    if (game.winner === teamName) {
      wins++;
      if (isRegular) regularWins++;
      else playoffWins++;
    } else if (game.winner === "Tie" || game.winner.includes("Forfeit - Tie")) {
      ties++;
      if (isRegular) regularTies++;
      else playoffTies++;
    } else {
      losses++;
      if (isRegular) regularLosses++;
      else playoffLosses++;
    }
  });
  
  const totalDecided = wins + losses;
  const winPct = totalDecided > 0 ? (wins / totalDecided * 100).toFixed(1) : '0.0';
  
  return {
    wins,
    losses,
    ties,
    winPct,
    regular: { wins: regularWins, losses: regularLosses, ties: regularTies },
    playoff: { wins: playoffWins, losses: playoffLosses, ties: playoffTies }
  };
}

function attachSorting() {
  const headers = document.querySelectorAll("#team-stats-table th");
  headers.forEach((th, idx) => {
    th.onclick = () => sortTable(idx, th.textContent.trim());
  });
}

function sortTable(columnIndex, field) {
  const table = document.getElementById("team-stats-table");
  const rows = Array.from(table.rows).slice(1);

  let dir = currentSort.column === field && currentSort.dir === "asc" ? "desc" : "asc";
  currentSort = { column: field, dir };

  rows.sort((a, b) => {
    let x = a.cells[columnIndex].innerText.trim();
    let y = b.cells[columnIndex].innerText.trim();

    // Handle special cases
    if (field === "AcesBPI") {
      if (x === "N/A" && y !== "N/A") return 1;
      if (y === "N/A" && x !== "N/A") return -1;
      if (x === "N/A" && y === "N/A") return 0;
    }

    // Try parsing as numbers first
    let xNum = parseFloat(x.replace(/,/g, ""));
    let yNum = parseFloat(y.replace(/,/g, ""));

    if (!isNaN(xNum) && !isNaN(yNum)) {
      return dir === "asc" ? xNum - yNum : yNum - xNum;
    }

    // Fall back to string comparison
    return dir === "asc" ? x.localeCompare(y) : y.localeCompare(x);
  });

  // Re-append sorted rows
  rows.forEach(row => table.tBodies[0].appendChild(row));

  // Update sort indicators
  document.querySelectorAll("#team-stats-table th").forEach(th => th.classList.remove("asc", "desc"));
  table.rows[0].cells[columnIndex].classList.add(dir);
}

// Helper function for back navigation
function goBack() {
  if (document.referrer && document.referrer.includes(window.location.hostname)) {
    window.history.back();
  } else {
    window.location.href = 'teams.html';
  }
}
</script>
</body>
</html>
