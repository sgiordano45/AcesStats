<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mark Games as Stats Submitted - Admin Tool</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: #f5f5f5;
    }
    h1 { color: #2d5016; }
    .card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .success {
      background: #d4edda;
      border: 1px solid #28a745;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .error {
      background: #f8d7da;
      border: 1px solid #dc3545;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    button {
      background: #2d5016;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
    button:hover { background: #1a3a0d; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.secondary {
      background: #6c757d;
    }
    button.danger {
      background: #dc3545;
    }
    .game-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .game-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .game-item:last-child { border-bottom: none; }
    .game-item.has-stats { background: #d4edda; }
    .game-item.no-stats { background: #fff3cd; }
    .badge {
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
    }
    .badge.yes { background: #28a745; color: white; }
    .badge.no { background: #ffc107; color: #333; }
    .stats { margin: 1rem 0; font-size: 1.1rem; }
    .stats span { font-weight: bold; color: #2d5016; }
    #log {
      background: #1a1a1a;
      color: #0f0;
      padding: 1rem;
      border-radius: 8px;
      font-family: monospace;
      font-size: 0.85rem;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>üîß Mark Games as Stats Submitted</h1>
  
  <div class="warning">
    <strong>‚ö†Ô∏è Admin Tool</strong><br>
    This tool marks all games in a season as <code>statsSubmitted: true</code> so they don't appear in captain action items.
    Use this for seasons where stats weren't tracked via the new system.
  </div>

  <div class="card">
    <h3>1. Sign In</h3>
    <div id="authStatus">Checking authentication...</div>
  </div>

  <div class="card">
    <h3>2. Select Season</h3>
    <select id="seasonSelect" disabled>
      <option value="">-- Select Season --</option>
      <option value="2025-fall">2025-fall</option>
      <option value="2025-summer">2025-summer</option>
      <option value="2024-fall">2024-fall</option>
    </select>
    <button id="loadGamesBtn" disabled>Load Games</button>
  </div>

  <div class="card" id="gamesCard" style="display: none;">
    <h3>3. Review Games</h3>
    <div class="stats">
      Total Games: <span id="totalGames">0</span> | 
      Already Marked: <span id="markedGames">0</span> | 
      Need Update: <span id="needUpdateGames">0</span>
    </div>
    <div class="game-list" id="gameList"></div>
    <button id="markAllBtn" class="danger" disabled>Mark All as Stats Submitted</button>
    <button id="refreshBtn" class="secondary">Refresh</button>
  </div>

  <div class="card" id="logCard" style="display: none;">
    <h3>Log</h3>
    <div id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { 
      getFirestore, 
      collection, 
      getDocs, 
      doc, 
      updateDoc,
      serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBJQ2YsTN6W6xGPzUz6RkZrEcJuTVN2LEI",
      authDomain: "acessoftballreference-84791.firebaseapp.com",
      projectId: "acessoftballreference-84791",
      storageBucket: "acessoftballreference-84791.appspot.com",
      messagingSenderId: "368954715012",
      appId: "1:368954715012:web:1234567890abcdef"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let loadedGames = [];

    const authStatus = document.getElementById('authStatus');
    const seasonSelect = document.getElementById('seasonSelect');
    const loadGamesBtn = document.getElementById('loadGamesBtn');
    const gamesCard = document.getElementById('gamesCard');
    const gameList = document.getElementById('gameList');
    const markAllBtn = document.getElementById('markAllBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const logCard = document.getElementById('logCard');
    const logDiv = document.getElementById('log');

    function log(message) {
      logCard.style.display = 'block';
      const timestamp = new Date().toLocaleTimeString();
      logDiv.textContent += `[${timestamp}] ${message}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Auth state
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        authStatus.innerHTML = `<div class="success">‚úÖ Signed in as <strong>${user.email}</strong></div>`;
        seasonSelect.disabled = false;
        loadGamesBtn.disabled = false;
      } else {
        authStatus.innerHTML = `<div class="error">‚ùå Not signed in. <a href="signin.html">Sign in</a> first.</div>`;
        seasonSelect.disabled = true;
        loadGamesBtn.disabled = true;
      }
    });

    // Load games
    loadGamesBtn.addEventListener('click', async () => {
      const seasonId = seasonSelect.value;
      if (!seasonId) {
        alert('Please select a season');
        return;
      }

      loadGamesBtn.disabled = true;
      loadGamesBtn.textContent = 'Loading...';
      log(`Loading games for ${seasonId}...`);

      try {
        const gamesRef = collection(db, 'seasons', seasonId, 'games');
        const snapshot = await getDocs(gamesRef);
        
        loadedGames = [];
        snapshot.forEach(doc => {
          loadedGames.push({ id: doc.id, ...doc.data() });
        });

        log(`Found ${loadedGames.length} games`);
        renderGames();
        gamesCard.style.display = 'block';

      } catch (error) {
        log(`Error: ${error.message}`);
        alert('Error loading games: ' + error.message);
      }

      loadGamesBtn.disabled = false;
      loadGamesBtn.textContent = 'Load Games';
    });

    function renderGames() {
      const total = loadedGames.length;
      const marked = loadedGames.filter(g => g.statsSubmitted === true).length;
      const needUpdate = total - marked;

      document.getElementById('totalGames').textContent = total;
      document.getElementById('markedGames').textContent = marked;
      document.getElementById('needUpdateGames').textContent = needUpdate;

      // Sort by date descending
      loadedGames.sort((a, b) => {
        const dateA = a.date?.seconds || 0;
        const dateB = b.date?.seconds || 0;
        return dateB - dateA;
      });

      gameList.innerHTML = loadedGames.map(game => {
        const homeTeam = game.homeTeamName || game['home team'] || game.homeTeam || 'TBD';
        const awayTeam = game.awayTeamName || game['away team'] || game.awayTeam || 'TBD';
        const hasStats = game.statsSubmitted === true;
        
        let dateStr = 'TBD';
        if (game.date?.seconds) {
          dateStr = new Date(game.date.seconds * 1000).toLocaleDateString();
        } else if (game.date) {
          dateStr = new Date(game.date).toLocaleDateString();
        }

        return `
          <div class="game-item ${hasStats ? 'has-stats' : 'no-stats'}">
            <div>
              <strong>${dateStr}</strong>: ${awayTeam} @ ${homeTeam}
            </div>
            <span class="badge ${hasStats ? 'yes' : 'no'}">
              ${hasStats ? '‚úì Marked' : 'Not Marked'}
            </span>
          </div>
        `;
      }).join('');

      markAllBtn.disabled = needUpdate === 0;
      markAllBtn.textContent = needUpdate === 0 
        ? 'All Games Already Marked ‚úì' 
        : `Mark ${needUpdate} Games as Stats Submitted`;
    }

    // Mark all games
    markAllBtn.addEventListener('click', async () => {
      const seasonId = seasonSelect.value;
      const gamesToUpdate = loadedGames.filter(g => g.statsSubmitted !== true);

      if (gamesToUpdate.length === 0) {
        alert('All games are already marked!');
        return;
      }

      const confirm = window.confirm(
        `This will mark ${gamesToUpdate.length} games as statsSubmitted=true.\n\nContinue?`
      );

      if (!confirm) return;

      markAllBtn.disabled = true;
      markAllBtn.textContent = 'Updating...';
      log(`Starting update of ${gamesToUpdate.length} games...`);

      let successCount = 0;
      let errorCount = 0;

      for (const game of gamesToUpdate) {
        try {
          const gameRef = doc(db, 'seasons', seasonId, 'games', game.id);
          await updateDoc(gameRef, {
            statsSubmitted: true,
            statsSubmittedNote: 'Bulk marked via admin tool - stats not tracked in new system',
            statsSubmittedAt: serverTimestamp(),
            statsSubmittedBy: currentUser.uid
          });
          successCount++;
          log(`‚úÖ Updated: ${game.id}`);
        } catch (error) {
          errorCount++;
          log(`‚ùå Error updating ${game.id}: ${error.message}`);
        }
      }

      log(`\nComplete! Success: ${successCount}, Errors: ${errorCount}`);
      alert(`Updated ${successCount} games. ${errorCount} errors.`);

      // Refresh the list
      loadGamesBtn.click();
    });

    // Refresh button
    refreshBtn.addEventListener('click', () => {
      loadGamesBtn.click();
    });
  </script>
</body>
</html>
