<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Season Overview - Aces Stats</title>
<link rel="stylesheet" href="style.css">
<style>
  .season-header {
    background-color: #f0f0f0;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 30px;
    border-left: 4px solid #333;
  }
  
  .season-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.2em;
  }
  
  .season-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .summary-item {
    text-align: center;
    padding: 10px;
    background-color: white;
    border-radius: 5px;
    border: 1px solid #ddd;
  }
  
  .summary-number {
    font-size: 1.5em;
    font-weight: bold;
    color: #0066cc;
  }
  
  .summary-label {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;
  }
  
  .leaders-awards-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 30px;
    margin-bottom: 30px;
  }
  
  .leaders-section, .awards-section {
    background-color: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow: hidden;
  }
  
  .leaders-section h3, .awards-section h3 {
    background-color: #333;
    color: white;
    margin: 0;
    padding: 15px;
    font-size: 1.2em;
    text-align: center;
  }
  
  .leaders-table, .awards-table {
    width: 100%;
    margin: 0;
  }
  
  .leaders-table th, .leaders-table td,
  .awards-table th, .awards-table td {
    padding: 8px 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  
  .leaders-table th, .awards-table th {
    background-color: #f5f5f5;
    font-weight: bold;
  }
  
  .leaders-table tr:nth-child(even),
  .awards-table tr:nth-child(even) {
    background-color: #fafafa;
  }
  
  .stat-value {
    text-align: center;
    font-weight: bold;
  }
  
  .view-switcher {
    margin-bottom: 20px;
    text-align: center;
  }
  
  .view-switcher button {
    padding: 10px 20px;
    margin: 0 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    font-size: 16px;
  }
  
  .view-switcher button.active {
    background-color: #0066cc;
    color: white;
    border-color: #0066cc;
  }
  
  .view-switcher button:not(.active) {
    background-color: #f0f0f0;
    color: black;
  }
  
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: center; }
  th { cursor: pointer; background-color: #f0f0f0; user-select: none; }
  th.asc::after { content: " ▲"; }
  th.desc::after { content: " ▼"; }
  
  .back-nav {
    margin-bottom: 20px;
  }
  
  .back-nav a {
    padding: 8px 15px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    text-decoration: none;
    border-radius: 3px;
    margin-right: 10px;
  }
  
  .back-nav a:hover {
    background-color: #e0e0e0;
  }
  
  @media (max-width: 768px) {
    .leaders-awards-container {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
<div class="back-nav">
  <a href="seasons.html">← Back to All Seasons</a>
  <a href="index.html">Batting Stats</a>
  <a href="pitching.html">Pitching Stats</a>
</div>

<div class="season-header">
  <h1 id="seasonTitle">Season Overview</h1>
  <p id="seasonDescription">Detailed statistics and awards for the season</p>
  
  <div class="season-summary" id="seasonSummary">
    <!-- Summary items will be generated dynamically -->
  </div>
</div>

<div class="leaders-awards-container">
  <div class="leaders-section">
    <h3 id="leadersTitle">Season Leaders</h3>
    <table class="leaders-table" id="leadersTable">
      <thead>
        <tr>
          <th>Statistic</th>
          <th>Player</th>
          <th class="stat-value">Value</th>
        </tr>
      </thead>
      <tbody id="leadersTableBody">
        <!-- Leaders will be generated dynamically -->
      </tbody>
    </table>
  </div>
  
  <div class="awards-section">
    <h3>Season Awards</h3>
    <table class="awards-table">
      <thead>
        <tr>
          <th>Award</th>
          <th>Player</th>
          <th>Team</th>
        </tr>
      </thead>
      <tbody id="awardsTableBody">
        <!-- Awards will be generated dynamically -->
      </tbody>
    </table>
  </div>
</div>

<div class="view-switcher">
  <button id="battingViewBtn" onclick="switchView('batting')" class="active">Batting Stats</button>
  <button id="pitchingViewBtn" onclick="switchView('pitching')">Pitching Stats</button>
</div>

<table id="seasonStatsTable">
  <thead id="tableHead">
    <!-- Headers will be generated dynamically -->
  </thead>
  <tbody>
    <!-- Rows generated dynamically -->
  </tbody>
</table>

<script>
let currentYear = "";
let currentSeason = "";
let currentView = 'batting';
let allBattingData = [];
let allPitchingData = [];
let allAwards = [];
let seasonBattingData = [];
let seasonPitchingData = [];
let seasonAwards = [];
let currentSort = { column: null, dir: "asc" };

// Get season from URL
const params = new URLSearchParams(window.location.search);
currentYear = params.get("year");
currentSeason = params.get("season");

if (!currentYear || !currentSeason) {
  document.body.innerHTML = '<h1>Error: Season not specified</h1><p><a href="seasons.html">Return to all seasons</a></p>';
} else {
  loadSeasonData();
}

async function loadSeasonData() {
  try {
    // Load all data
    const [battingResponse, pitchingResponse, awardsResponse] = await Promise.all([
      fetch("data.json"),
      fetch("pitching.json"),
      fetch("awards.json")
    ]);
    
    if (!battingResponse.ok) throw new Error('Failed to load data.json');
    
    allBattingData = cleanBattingData(await battingResponse.json());
    allPitchingData = pitchingResponse.ok ? cleanPitchingData(await pitchingResponse.json()) : [];
    allAwards = awardsResponse.ok ? await awardsResponse.json() : [];
    
    // Filter for this season
    seasonBattingData = allBattingData.filter(p => p.year === currentYear && p.season === currentSeason);
    seasonPitchingData = allPitchingData.filter(p => p.year === currentYear && p.season === currentSeason);
    seasonAwards = allAwards.filter(a => a.Year === currentYear && a.Season === currentSeason);
    
    if (seasonBattingData.length === 0 && seasonPitchingData.length === 0) {
      document.body.innerHTML = `
        <h1>Season "${currentYear} ${currentSeason}" not found</h1>
        <p><a href="seasons.html">Return to all seasons</a></p>
      `;
      return;
    }
    
    initializePage();
    
  } catch (error) {
    console.error("Error loading season data:", error);
    document.body.innerHTML = `
      <h1>Error loading season data</h1>
      <p>Could not load statistics. Please check that data files are available.</p>
      <p><a href="seasons.html">Return to all seasons</a></p>
    `;
  }
}

function cleanBattingData(data) {
  return data.map(p => ({
    ...p,
    name: p.name ? p.name.trim() : "",
    team: p.team ? p.team.trim() : "",
    season: p.season ? p.season.trim() : "",
    year: p.year ? String(p.year).trim() : "",
    games: Number(p.games) || 0,
    atBats: Number(p.atBats) || 0,
    hits: Number(p.hits) || 0,
    runs: Number(p.runs) || 0,
    walks: Number(p.walks) || 0,
    AcesWar: p.AcesWar === "N/A" || !p.AcesWar ? "N/A" : Number(p.AcesWar),
    Sub: p.Sub || p.sub || ""
  }));
}

function cleanPitchingData(data) {
  return data.map(p => ({
    ...p,
    name: p.name ? p.name.trim() : "",
    team: p.team ? p.team.trim() : "",
    season: p.season ? p.season.trim() : "",
    year: p.year ? String(p.year).trim() : "",
    games: Number(p.games) || 0,
    IP: parseFloat(p.IP) || 0,
    runsAllowed: Number(p["runs allowed"]) || 0,
    ERA: p.ERA === "N/A" || !p.ERA ? "N/A" : Number(p.ERA)
  }));
}

function initializePage() {
  document.getElementById("seasonTitle").textContent = `${currentYear} ${currentSeason} Season`;
  
  renderSeasonSummary();
  renderAwards();
  switchView('batting');
}

function renderSeasonSummary() {
  const uniquePlayers = new Set([...seasonBattingData.map(p => p.name), ...seasonPitchingData.map(p => p.name)]);
  const uniqueTeams = new Set([...seasonBattingData.map(p => p.team), ...seasonPitchingData.map(p => p.team)].filter(t => t.toLowerCase() !== "kings"));
  
  const totalGames = seasonBattingData.reduce((sum, p) => sum + p.games, 0);
  const totalAtBats = seasonBattingData.reduce((sum, p) => sum + p.atBats, 0);
  const totalHits = seasonBattingData.reduce((sum, p) => sum + p.hits, 0);
  const leagueBA = totalAtBats > 0 ? (totalHits / totalAtBats).toFixed(3) : ".000";
  
  const summaryHTML = `
    <div class="summary-item">
      <div class="summary-number">${uniquePlayers.size}</div>
      <div class="summary-label">Players</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${uniqueTeams.size}</div>
      <div class="summary-label">Teams</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${totalGames}</div>
      <div class="summary-label">Total Games</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${leagueBA}</div>
      <div class="summary-label">League BA</div>
    </div>
    <div class="summary-item">
      <div class="summary-number">${seasonAwards.length}</div>
      <div class="summary-label">Awards</div>
    </div>
  `;
  
  document.getElementById("seasonSummary").innerHTML = summaryHTML;
}

function renderAwards() {
  const tbody = document.getElementById("awardsTableBody");
  
  if (seasonAwards.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No awards data available for this season</td></tr>';
    return;
  }
  
  // Sort awards by importance/type
  const sortedAwards = seasonAwards.sort((a, b) => {
    const order = ['Team MVP', 'All Aces', 'Gold Glove', 'Team of the Year', 'Rookie of the Year'];
    const aIndex = order.indexOf(a.Award);
    const bIndex = order.indexOf(b.Award);
    
    if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
    if (aIndex !== -1) return -1;
    if (bIndex !== -1) return 1;
    return a.Award.localeCompare(b.Award);
  });
  
  sortedAwards.forEach(award => {
    const playerLink = award.Player ? 
      `<a href="player.html?name=${encodeURIComponent(award.Player)}">${award.Player}</a>` : 
      '';
    const teamLink = award.Team ?
      `<a href="team.html?team=${encodeURIComponent(award.Team)}">${award.Team}</a>` :
      '';
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${award.Award}</strong></td>
        <td>${playerLink}</td>
        <td>${teamLink}</td>
      </tr>
    `;
  });
}

function switchView(view) {
  currentView = view;
  
  // Update button styles
  const battingBtn = document.getElementById('battingViewBtn');
  const pitchingBtn = document.getElementById('pitchingViewBtn');
  
  if (view === 'batting') {
    battingBtn.classList.add('active');
    pitchingBtn.classList.remove('active');
  } else {
    pitchingBtn.classList.add('active');
    battingBtn.classList.remove('active');
  }
  
  renderLeaders();
  renderStatsTable();
}

function renderLeaders() {
  const leadersTitle = document.getElementById('leadersTitle');
  const tbody = document.getElementById('leadersTableBody');
  
  if (currentView === 'batting') {
    leadersTitle.textContent = 'Batting Leaders';
    renderBattingLeaders(tbody);
  } else {
    leadersTitle.textContent = 'Pitching Leaders';
    renderPitchingLeaders(tbody);
  }
}

function renderBattingLeaders(tbody) {
  if (seasonBattingData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No batting data available</td></tr>';
    return;
  }
  
  const qualifyingBatters = seasonBattingData.filter(p => p.atBats >= 20);
  
  // Calculate leaders
  const leaders = {
    'Games': seasonBattingData.reduce((prev, curr) => curr.games > prev.games ? curr : prev, {games: -1}),
    'At Bats': seasonBattingData.reduce((prev, curr) => curr.atBats > prev.atBats ? curr : prev, {atBats: -1}),
    'Hits': seasonBattingData.reduce((prev, curr) => curr.hits > prev.hits ? curr : prev, {hits: -1}),
    'Runs': seasonBattingData.reduce((prev, curr) => curr.runs > prev.runs ? curr : prev, {runs: -1}),
    'Walks': seasonBattingData.reduce((prev, curr) => curr.walks > prev.walks ? curr : prev, {walks: -1}),
    'Batting Average': qualifyingBatters.reduce((prev, curr) => {
      const currBA = curr.atBats > 0 ? curr.hits / curr.atBats : 0;
      const prevBA = prev.atBats > 0 ? prev.hits / prev.atBats : 0;
      return currBA > prevBA ? curr : prev;
    }, {atBats: 0, hits: 0}),
    'AcesBPI': seasonBattingData.reduce((prev, curr) => {
      const currWAR = curr.AcesWar !== "N/A" && !isNaN(curr.AcesWar) ? Number(curr.AcesWar) : -Infinity;
      const prevWAR = prev.AcesWar !== "N/A" && !isNaN(prev.AcesWar) ? Number(prev.AcesWar) : -Infinity;
      return currWAR > prevWAR ? curr : prev;
    }, {AcesWar: -Infinity})
  };
  
  tbody.innerHTML = '';
  Object.entries(leaders).forEach(([stat, player]) => {
    if (!player.name) return;
    
    let value = '';
    switch(stat) {
      case 'Games': value = player.games; break;
      case 'At Bats': value = player.atBats; break;
      case 'Hits': value = player.hits; break;
      case 'Runs': value = player.runs; break;
      case 'Walks': value = player.walks; break;
      case 'Batting Average': value = player.atBats > 0 ? (player.hits / player.atBats).toFixed(3) : '.000'; break;
      case 'AcesBPI': value = player.AcesWar !== "N/A" ? Number(player.AcesWar).toFixed(2) : 'N/A'; break;
    }
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${stat}</strong></td>
        <td><a href="player.html?name=${encodeURIComponent(player.name)}">${player.name}</a></td>
        <td class="stat-value">${value}</td>
      </tr>
    `;
  });
}

function renderPitchingLeaders(tbody) {
  if (seasonPitchingData.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3">No pitching data available</td></tr>';
    return;
  }
  
  const qualifyingPitchers = seasonPitchingData.filter(p => p.IP >= 10);
  
  // Calculate leaders
  const leaders = {
    'Games': seasonPitchingData.reduce((prev, curr) => curr.games > prev.games ? curr : prev, {games: -1}),
    'Innings Pitched': seasonPitchingData.reduce((prev, curr) => curr.IP > prev.IP ? curr : prev, {IP: -1}),
    'Runs Allowed': seasonPitchingData.reduce((prev, curr) => curr.runsAllowed > prev.runsAllowed ? curr : prev, {runsAllowed: -1}),
    'Best ERA': qualifyingPitchers.reduce((prev, curr) => {
      const currERA = curr.ERA !== "N/A" && !isNaN(curr.ERA) ? Number(curr.ERA) : Infinity;
      const prevERA = prev.ERA !== "N/A" && !isNaN(prev.ERA) ? Number(prev.ERA) : Infinity;
      return currERA < prevERA ? curr : prev;
    }, {ERA: Infinity})
  };
  
  tbody.innerHTML = '';
  Object.entries(leaders).forEach(([stat, player]) => {
    if (!player.name) return;
    
    let value = '';
    switch(stat) {
      case 'Games': value = player.games; break;
      case 'Innings Pitched': value = player.IP.toFixed(1); break;
      case 'Runs Allowed': value = player.runsAllowed; break;
      case 'Best ERA': value = player.ERA !== "N/A" ? Number(player.ERA).toFixed(2) : 'N/A'; break;
    }
    
    tbody.innerHTML += `
      <tr>
        <td><strong>${stat}</strong></td>
        <td><a href="pitcher.html?name=${encodeURIComponent(player.name)}">${player.name}</a></td>
        <td class="stat-value">${value}</td>
      </tr>
    `;
  });
}

function renderStatsTable() {
  const tableHead = document.getElementById('tableHead');
  const tbody = document.querySelector('#seasonStatsTable tbody');
  
  if (currentView === 'batting') {
    // Batting table headers
    tableHead.innerHTML = `
      <tr>
        <th data-field="name">Name</th>
        <th data-field="team">Team</th>
        <th data-field="games">Games</th>
        <th data-field="atBats">At Bats</th>
        <th data-field="hits">Hits</th>
        <th data-field="runs">Runs</th>
        <th data-field="walks">Walks</th>
        <th data-field="AcesWar">AcesBPI</th>
        <th data-field="BA">BA</th>
        <th data-field="OBP">OBP</th>
        <th data-field="Sub">Sub</th>
      </tr>
    `;
    
    tbody.innerHTML = '';
    seasonBattingData.forEach(p => {
      const BA = p.atBats > 0 ? (p.hits / p.atBats).toFixed(3) : ".000";
      const OBP = (p.atBats + p.walks) > 0
        ? ((p.hits + p.walks) / (p.atBats + p.walks)).toFixed(3)
        : ".000";
      const AcesWar = p.AcesWar !== "N/A" && !isNaN(p.AcesWar)
        ? Number(p.AcesWar).toFixed(2)
        : "N/A";

      tbody.innerHTML += `
        <tr>
          <td><a href="player.html?name=${encodeURIComponent(p.name)}">${p.name}</a></td>
          <td><a href="team.html?team=${encodeURIComponent(p.team)}">${p.team}</a></td>
          <td>${p.games}</td>
          <td>${p.atBats}</td>
          <td>${p.hits}</td>
          <td>${p.runs}</td>
          <td>${p.walks}</td>
          <td>${AcesWar}</td>
          <td>${BA}</td>
          <td>${OBP}</td>
          <td>${p.Sub || ""}</td>
        </tr>
      `;
    });
  } else {
    // Pitching table headers
    tableHead.innerHTML = `
      <tr>
        <th data-field="name">Name</th>
        <th data-field="team">Team</th>
        <th data-field="games">Games</th>
        <th data-field="IP">Innings Pitched</th>
        <th data-field="runsAllowed">Runs Allowed</th>
        <th data-field="ERA">ERA</th>
      </tr>
    `;
    
    tbody.innerHTML = '';
    seasonPitchingData.forEach(p => {
      const ERA = p.ERA !== "N/A" && !isNaN(p.ERA)
        ? Number(p.ERA).toFixed(2)
        : "N/A";

      tbody.innerHTML += `
        <tr>
          <td><a href="pitcher.html?name=${encodeURIComponent(p.name)}">${p.name}</a></td>
          <td><a href="team.html?team=${encodeURIComponent(p.team)}">${p.team}</a></td>
          <td>${p.games}</td>
          <td>${p.IP.toFixed(1)}</td>
          <td>${p.runsAllowed}</td>
          <td>${ERA}</td>
        </tr>
      `;
    });
  }
  
  attachSorting();
}

function attachSorting() {
  const headers = document.querySelectorAll("#seasonStatsTable th");
  headers.forEach((th, idx) => {
    th.onclick = () => sortTable(idx, th.getAttribute("data-field"));
  });
}

function sortTable(columnIndex, field) {
  const table = document.getElementById("seasonStatsTable");
  const rows = Array.from(table.rows).slice(1);

  let dir = currentSort.column === field && currentSort.dir === "asc" ? "desc" : "asc";
  currentSort = { column: field, dir };

  rows.sort((a, b) => {
    let x = a.cells[columnIndex].innerText.trim();
    let y = b.cells[columnIndex].innerText.trim();

    // Handle special cases
    if (field === "AcesWar" || field === "ERA") {
      if (x === "N/A" && y !== "N/A") return 1;
      if (y === "N/A" && x !== "N/A") return -1;
      if (x === "N/A" && y === "N/A") return 0;
    }

    // Handle IP field (innings pitched can have decimals)
    if (field === "IP") {
      let xNum = parseFloat(x);
      let yNum = parseFloat(y);
      if (!isNaN(xNum) && !isNaN(yNum)) {
        return dir === "asc" ? xNum - yNum : yNum - xNum;
      }
    }

    // Try parsing as numbers first
    let xNum = parseFloat(x.replace(/,/g, ""));
    let yNum = parseFloat(y.replace(/,/g, ""));

    if (!isNaN(xNum) && !isNaN(yNum)) {
      return dir === "asc" ? xNum - yNum : yNum - xNum;
    }

    // Fall back to string comparison
    return dir === "asc" ? x.localeCompare(y) : y.localeCompare(x);
  });

  // Re-append sorted rows
  rows.forEach(row => table.tBodies[0].appendChild(row));

  // Update sort indicators
  document.querySelectorAll("#seasonStatsTable th").forEach(th => th.classList.remove("asc", "desc"));
  table.rows[0].cells[columnIndex].classList.add(dir);
}
</script>
</body>
</html>