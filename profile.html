<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Profile - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">

<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.3s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.softball-spinner::before {
  content: '‚öæ';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  padding: 3rem 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: -50px;
  right: -50px;
  width: 300px;
  height: 300px;
  background: rgba(255,255,255,0.05);
  border-radius: 50%;
}

.header-content {
  max-width: 1200px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

.profile-header-section {
  display: flex;
  align-items: center;
  gap: 2rem;
  color: white;
}

.profile-photo-container {
  position: relative;
  cursor: pointer;
}

.profile-photo {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  border: 4px solid rgba(255,255,255,0.3);
  object-fit: cover;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.profile-photo-container:hover .profile-photo {
  opacity: 0.8;
  transform: scale(1.05);
}

.profile-photo-upload-btn {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  border: 3px solid white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.profile-photo-upload-btn:hover {
  transform: scale(1.1);
  box-shadow: var(--shadow-lg);
}

#profilePhotoInput {
  display: none;
}

.profile-info {
  flex: 1;
}

.profile-info h1 {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
}

.profile-subtitle {
  font-size: 1.1rem;
  opacity: 0.9;
  display: flex;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}

.profile-badge {
  background: rgba(255,255,255,0.2);
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
}
.profile-badge#aceSince {
  display: none;
}
.profile-roles {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.75rem;
}

.role-badge {
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border: 2px solid rgba(255,255,255,0.3);
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.role-badge.admin {
  background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
  color: white;
  animation: pulse 2s ease-in-out infinite;
}

.role-badge.league-staff {
  background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
  color: white;
}

.role-badge.captain {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.role-badge.team-staff {
  background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
  color: white;
}

.role-badge.player {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.8; }
}



.back-home-btn {
      position: absolute;
      top: 2rem;
      right: 2rem;
      background: rgba(255,255,255,0.2);
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(255,255,255,0.3);
      z-index: 2;
    }

    .back-home-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateX(-5px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
/* Navigation Tabs */
.nav-tabs {
  background: white;
  box-shadow: var(--shadow-sm);
  position: sticky;
  top: 0;
  z-index: 100;
}

.nav-tabs-container {
  max-width: 1200px;
  margin: 0 auto;
  display: flex;
  overflow-x: auto;
  scrollbar-width: none;
}

.nav-tabs-container::-webkit-scrollbar {
  display: none;
}

.nav-tab {
  padding: 1.2rem 2rem;
  background: transparent;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-light);
  transition: all 0.3s ease;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.nav-tab:hover {
  color: var(--primary-color);
  background: rgba(45, 80, 22, 0.05);
}

.nav-tab.active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  background: rgba(45, 80, 22, 0.05);
}

/* Main Content */
.main-content {
  max-width: 1200px;
  margin: 2rem auto;
  padding: 0 2rem 2rem;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Cards */
.section-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-md);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.section-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid;
  border-image: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%) 1;
}

.section-header h2 {
  font-size: 1.5rem;
  color: var(--text-dark);
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.section-icon {
  font-size: 1.8rem;
}

/* Form Elements */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.5rem;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.form-label {
  font-weight: 600;
  color: var(--text-dark);
  font-size: 0.95rem;
}

.form-input,
.form-select {
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  transition: all 0.3s ease;
  font-family: inherit;
}

.form-input:focus,
.form-select:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.form-input:disabled,
.form-select:disabled {
  background: #f7fafc;
  cursor: not-allowed;
  opacity: 0.6;
}

/* Buttons */
.btn {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  font-family: inherit;
}

.btn-primary {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  box-shadow: var(--shadow-sm);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.btn-primary:active {
  transform: translateY(0);
}

.btn-secondary {
  background: white;
  color: var(--primary-color);
  border: 2px solid var(--primary-color);
}

.btn-secondary:hover {
  background: var(--primary-color);
  color: white;
}

.btn-group {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  margin-top: 1.5rem;
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.stat-box {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  padding: 1.5rem;
  border-radius: 8px;
  text-align: center;
  border: 2px solid var(--border-color);
  transition: all 0.3s ease;
}

.stat-box:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.stat-value {
  font-size: 2rem;
  font-weight: 700;
  color: var(--primary-color);
  margin-bottom: 0.5rem;
}

.stat-label {
  font-size: 0.9rem;
  color: var(--text-light);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  font-weight: 600;
}

/* Favorites Section */
.favorites-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

.favorite-card {
  background: white;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  padding: 1.25rem;
  transition: all 0.3s ease;
  position: relative;
}

.favorite-card:hover {
  border-color: var(--primary-color);
  box-shadow: var(--shadow-md);
}

.favorite-card-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.favorite-icon {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  font-size: 1.5rem;
}

.favorite-card-title {
  flex: 1;
  font-weight: 700;
  font-size: 1.1rem;
  color: var(--text-dark);
}

.remove-favorite {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--text-light);
  font-size: 1.2rem;
  padding: 0.25rem;
  line-height: 1;
  transition: color 0.3s ease;
}

.remove-favorite:hover {
  color: #dc3545;
}

.favorite-stats {
  font-size: 0.9rem;
  color: var(--text-light);
  line-height: 1.6;
}

.empty-state {
  text-align: center;
  padding: 3rem 2rem;
  color: var(--text-light);
}

.empty-state-icon {
  font-size: 4rem;
  margin-bottom: 1rem;
  opacity: 0.3;
}

.empty-state-text {
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

/* Toggle Switch */
.toggle-group {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.toggle-switch {
  position: relative;
  width: 50px;
  height: 26px;
}

.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  border-radius: 26px;
  transition: 0.4s;
}

.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  border-radius: 50%;
  transition: 0.4s;
}

.toggle-switch input:checked + .toggle-slider {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
}

.toggle-switch input:checked + .toggle-slider:before {
  transform: translateX(24px);
}

/* Quick Links */
.quick-links {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.quick-link-card {
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
  border: 2px solid var(--border-color);
  border-radius: 8px;
  padding: 1.5rem;
  text-decoration: none;
  color: var(--text-dark);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  gap: 1rem;
}

.quick-link-card:hover {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.1) 0%, rgba(26, 107, 74, 0.1) 100%);
  transform: translateX(5px);
}

.quick-link-icon {
  font-size: 2rem;
}

.quick-link-content h3 {
  font-size: 1rem;
  margin-bottom: 0.25rem;
  color: var(--primary-color);
}

.quick-link-content p {
  font-size: 0.85rem;
  color: var(--text-light);
  margin: 0;
}

/* Responsive */
@media (max-width: 768px) {
    .back-home-btn {
      top: 1rem;
      right: 1rem;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
    }
  .profile-header-section {
    flex-direction: column;
    text-align: center;
  }

  .profile-info h1 {
    font-size: 2rem;
  }

  .nav-tab {
    padding: 1rem 1.5rem;
    font-size: 0.9rem;
  }

  .main-content {
    padding: 0 1rem 1rem;
  }

  .section-card {
    padding: 1.5rem;
  }

  .form-grid {
    grid-template-columns: 1fr;
  }

  .quick-links {
    grid-template-columns: 1fr;
  }
}

/* Success Message - Fixed Toast Notification */
.success-message {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #d4edda;
  border: 1px solid #c3e6cb;
  color: #155724;
  padding: 1rem 1.5rem;
  border-radius: 8px;
  display: none;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
  z-index: 10000;
  animation: slideInRight 0.3s ease-out;
  max-width: 400px;
}

@keyframes slideInRight {
  from { 
    opacity: 0; 
    transform: translateX(400px); 
  }
  to { 
    opacity: 1; 
    transform: translateX(0); 
  }
}

.success-message.show {
  display: block;
}

/* Selection Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 10000;
  overflow-y: auto;
  padding: 2rem;
}

.modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

.modal-content {
  background: white;
  border-radius: 16px;
  max-width: 600px;
  width: 100%;
  max-height: 80vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.modal-header {
  padding: 1.5rem 2rem;
  border-bottom: 2px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
}

.modal-header h2 {
  font-size: 1.5rem;
  color: var(--text-dark);
  margin: 0;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--text-light);
  padding: 0.5rem;
  line-height: 1;
  transition: color 0.3s ease;
}

.modal-close:hover {
  color: var(--text-dark);
}

.modal-body {
  padding: 1.5rem 2rem;
  overflow-y: auto;
  flex: 1;
}

.modal-search {
  width: 100%;
  padding: 0.75rem 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  font-size: 1rem;
  margin-bottom: 1.5rem;
  font-family: inherit;
}

.modal-search:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
}

.selection-list {
  display: grid;
  gap: 0.75rem;
}

.selection-item {
  padding: 1rem;
  border: 2px solid var(--border-color);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: white;
}

.selection-item:hover {
  border-color: var(--primary-color);
  background: rgba(45, 80, 22, 0.03);
  transform: translateX(5px);
}

.selection-item.selected {
  border-color: var(--primary-color);
  background: linear-gradient(135deg, rgba(45, 80, 22, 0.05) 0%, rgba(26, 107, 74, 0.05) 100%);
}

.selection-item.disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.selection-item.disabled:hover {
  border-color: var(--border-color);
  background: white;
  transform: none;
}

.selection-item-info {
  flex: 1;
}

.selection-item-name {
  font-weight: 600;
  color: var(--text-dark);
  margin-bottom: 0.25rem;
}

.selection-item-details {
  font-size: 0.875rem;
  color: var(--text-light);
}

.selection-item-badge {
  background: var(--primary-color);
  color: white;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.modal-footer {
  padding: 1.5rem 2rem;
  border-top: 2px solid var(--border-color);
  display: flex;
  gap: 1rem;
  background: #f7fafc;
}

.modal-footer .btn {
  flex: 1;
}

/* Aces Wrapped Section */
.wrapped-promo-card {
  background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
  border-radius: 16px;
  padding: 2.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 12px 32px rgba(0,0,0,0.16);
  position: relative;
  overflow: hidden;
  color: white;
}

.wrapped-promo-card::before {
  content: 'üèÜ';
  position: absolute;
  top: -30px;
  right: -30px;
  font-size: 200px;
  opacity: 0.1;
  transform: rotate(15deg);
}

.wrapped-promo-content {
  position: relative;
  z-index: 1;
  text-align: center;
}

.wrapped-promo-title {
  font-size: 2.5rem;
  font-weight: 800;
  margin-bottom: 0.5rem;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.wrapped-promo-subtitle {
  font-size: 1.2rem;
  opacity: 0.95;
  margin-bottom: 2rem;
}

.wrapped-cta-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem 2rem;
  background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
  color: white;
  border: none;
  border-radius: 50px;
  font-size: 1.2rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  text-decoration: none;
  box-shadow: 0 4px 16px rgba(20, 184, 166, 0.4);
}

.wrapped-cta-btn:hover {
  transform: translateY(-2px) scale(1.05);
  box-shadow: 0 6px 24px rgba(20, 184, 166, 0.6);
}

.wrapped-icon {
  font-size: 1.5rem;
  animation: wrappedBounce 2s infinite;
}

@keyframes wrappedBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

@media (max-width: 768px) {
  .wrapped-promo-title {
    font-size: 2rem;
  }
  
  .wrapped-promo-subtitle {
    font-size: 1rem;
  }
  
  .wrapped-cta-btn {
    font-size: 1rem;
    padding: 0.875rem 1.5rem;
  }
}
</style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="softball-spinner"></div>
  </div>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
        <a href="index.html" class="back-home-btn hide-mobile">
          <span>‚Üê</span> Back Home
        </a>
      <div class="profile-header-section">
        <div class="profile-photo-container" id="profilePhotoContainer">
          <img src="" alt="Profile Photo" class="profile-photo" id="profilePhoto">
          <button class="profile-photo-upload-btn" id="uploadPhotoBtn" title="Upload Profile Photo">
            üì∑
          </button>
          <input type="file" id="profilePhotoInput" accept="image/*">
        </div>
        <div class="profile-info">
          <h1 id="displayName">Loading...</h1>
          <div class="profile-subtitle">
            <span id="playerName">Player Name</span>
            <span class="profile-badge" id="teamBadge">Team Name</span>
            <span class="profile-badge" id="memberSince">Member since 2024</span>
			<span class="profile-badge" id="aceSince">Ace since 2024</span>
          </div>
		  <div class="profile-roles" id="profileRoles" style="display: none; margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <!-- Role badges will be inserted here dynamically -->
          </div>
        </div>
      </div>
    </div>
  </header>
  <!-- Email Verification Banner (for unverified email/password users) -->
  <div id="verificationBanner" class="alert alert-warning" style="display: none; margin: 1rem auto; max-width: 1200px; padding: 0 2rem;">
    <div style="background: #fef3c7; border: 2px solid #f59e0b; padding: 1.25rem; border-radius: 12px;">
      <strong style="color: #92400e; font-size: 16px;">üìß Email Verification Required</strong>
      <p style="margin: 0.75rem 0; color: #92400e;">
        Please verify your email address to access all profile features and ensure account security.
      </p>
      <button class="btn btn-primary" onclick="window.location.href='verify-email.html'" style="margin-top: 0.5rem;">
        <span>Verify Email Now ‚Üí</span>
      </button>
    </div>
  </div>


  <!-- Navigation Tabs -->
  <nav class="nav-tabs">
    <div class="nav-tabs-container">
      <button class="nav-tab active" data-tab="overview">
        <span>üìä</span> Overview
      </button>
      <button class="nav-tab" data-tab="player-info">
        <span>‚öæ</span> Player Info
      </button>
      <button class="nav-tab" data-tab="favorites">
        <span>‚≠ê</span> Favorites
      </button>
      <button class="nav-tab" data-tab="preferences">
        <span>‚öôÔ∏è</span> Preferences
      </button>
      <button class="nav-tab" data-tab="directory">
        <span>üìá</span> Directory
      </button>
      <button class="nav-tab" data-tab="security">
        <span>üîí</span> Security
      </button>
      <button class="nav-tab" data-tab="games">
        <span>üéÆ</span> Games
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Overview Tab -->
    <div class="tab-content active" id="tab-overview">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üìà</span> <span id="statsHeaderTitle">Season Statistics</span></h2>
        </div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="statGames">0</div>
            <div class="stat-label">Games Played</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statAvg">.000</div>
            <div class="stat-label">Batting Average</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statHits">0</div>
            <div class="stat-label">Total Hits</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statRuns">0</div>
            <div class="stat-label">Runs Scored</div>
          </div>
		  <div class="stat-box">
            <div class="stat-value" id="statBPI">-</div>
            <div class="stat-label">Aces BPI</div>
          </div>
        </div>
      </div>

<!-- Aces Wrapped Promo -->
<div class="wrapped-promo-card" id="wrappedPromoCard" style="display: none;">
  <div class="wrapped-promo-content">
    <div class="wrapped-promo-title">üéâ Aces Wrapped 2025</div>
    <div class="wrapped-promo-subtitle">
      Relive your best moments from the 2025 season!
    </div>
    <a href="#" id="viewWrappedBtn" class="wrapped-cta-btn">
      <span class="wrapped-icon">‚öæ</span>
      <span>View My Wrapped</span>
      <span>‚Üí</span>
    </a>
  </div>
</div>

<div class="section-card" id="captainToolsSection" style="display: none;">
  <div class="section-header">
    <h2><span class="section-icon">üëë</span> Captain Tools</h2>
  </div>
  <div class="quick-links">
    <a href="roster-management.html" class="quick-link-card">
      <div class="quick-link-icon">üìã</div>
      <div class="quick-link-content">
        <h3>Roster Management</h3>
        <p>Manage team roster & RSVPs</p>
      </div>
    </a>
	<a href="manage-team.html" class="quick-link-card">
      <div class="quick-link-icon">‚öôÔ∏è</div>
      <div class="quick-link-content">
        <h3>Team Staff Management</h3>
        <p>Assign Team Staff Roles to help with RSVPs and Game Tracking</p>
      </div>
    </a>
	    <a href="photo-upload.html" class="quick-link-card">
      <div class="quick-link-icon">üì§Ô∏è</div>
      <div class="quick-link-content">
        <h3>Upload Team Photos</h3>
        <p>Add photos to the gallery</p>
      </div>
    </a>
	<a href="submit-score.html" class="quick-link-card">
      <div class="quick-link-icon">üî¢Ô∏è</div>
      <div class="quick-link-content">
        <h3>Submit Game Scores</h3>
        <p>Submit Scores After Each Game</p>
      </div>
    </a>
		<a href="submit-stats.html" class="quick-link-card">
      <div class="quick-link-icon">üßÆ</div>
      <div class="quick-link-content">
        <h3>Submit Game Stats</h3>
        <p>Submit Stats After Each Game</p>
      </div>
    </a>
  </div>
</div>

<!-- Admin Tools Section -->
<div class="section-card" id="adminToolsSection" style="display: none;">
  <div class="section-header">
    <h2><span class="section-icon">üõ°Ô∏è</span> Admin Tools</h2>
  </div>
  <div class="quick-links">
    <a href="approve-links.html" class="quick-link-card">
      <div class="quick-link-icon">üîó</div>
      <div class="quick-link-content">
        <h3>Approve Player Links</h3>
        <p id="pendingLinksAdminText">Review pending link requests</p>
      </div>
    </a>
    <a href="admin-link-players.html" class="quick-link-card">
      <div class="quick-link-icon">üë§</div>
      <div class="quick-link-content">
        <h3>Admin Link Players</h3>
        <p>Link players to accounts directly</p>
      </div>
    </a>
    <a href="admin-content.html" class="quick-link-card">
      <div class="quick-link-icon">üéõÔ∏è</div>
      <div class="quick-link-content">
        <h3>Admin Tools</h3>
        <p>Update previews, eulogies, or change game data</p>
      </div>
    </a>
    <a href="admin-roles.html" class="quick-link-card">
      <div class="quick-link-icon">üéÆ</div>
      <div class="quick-link-content">
        <h3>Admin Role Updater</h3>
        <p>Update/Change User Roles & Assign Special Roles</p>
      </div>
    </a>
  </div>
</div>



      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîó</span> Quick Links</h2>
        </div>
        <div class="quick-links">
          <a href="#" class="quick-link-card" id="linkMyStats">
            <div class="quick-link-icon">üìä</div>
            <div class="quick-link-content">
              <h3>View My Stats</h3>
              <p>Full career statistics</p>
            </div>
          </a>
          <a href="#" class="quick-link-card" id="linkMyTeam">
            <div class="quick-link-icon">üë•</div>
            <div class="quick-link-content">
              <h3>My Team</h3>
              <p>Team roster & schedule</p>
            </div>
          </a>
          <a href="favorites.html" class="quick-link-card">
            <div class="quick-link-icon">‚≠ê</div>
            <div class="quick-link-content">
              <h3>My Favorites</h3>
              <p>Track teams & players</p>
            </div>
          </a>
          <a href="roster-management.html" class="quick-link-card" id="linkRSVP">
            <div class="quick-link-icon">‚úî</div>
            <div class="quick-link-content">
              <h3>Game RSVPs</h3>
              <p>Manage availability</p>
            </div>
          </a>
		  <a href="approve-links.html" class="quick-link-card" id="linkApproveLinks" style="display: none;">
				<div class="quick-link-icon">üîó</div>
				<div class="quick-link-content">
					<h3>Approve Player Links</h3>
					<p id="pendingLinksQuickText">Review pending requests</p>
				</div>
			</a>
		  <a href="manage-team.html" class="quick-link-card" id="linkManageTeam" style="display: none;">
				<div class="quick-link-icon">‚öôÔ∏è</div>
				<div class="quick-link-content">
					<h3>Manage Team Staff</h3>
					<p id="pendingLinksQuickText">Assign Team Staff roles</p>
				</div>
			</a>
        </div>
      </div>
    </div>

    <!-- Player Info Tab -->
    <div class="tab-content" id="tab-player-info">
      <!-- NEW: Display Name Section -->
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üë§</span> Display Name</h2>
        </div>
        <div id="successMessageDisplayName" class="success-message">
          Display name updated successfully!
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          This is how your name will appear throughout the site. Leave blank to use your Google account name.
        </p>
        <form id="displayNameForm">
          <div class="form-group">
            <label class="form-label" for="preferredDisplayName">Preferred Display Name</label>
            <input type="text" id="preferredDisplayName" class="form-input" placeholder="e.g., Steve instead of Stephen">
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
              Current Google account name: <strong id="googleAccountName"></strong>
            </small>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Display Name
            </button>
            <button type="button" class="btn btn-secondary" id="clearDisplayName">
              ‚úñÔ∏è Use Google Name
            </button>
          </div>
        </form>
      </div>

      <!-- EXISTING: Player Information Section -->
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">‚öæ</span> Player Information</h2>
        </div>
        <div id="successMessagePlayerInfo" class="success-message">
          Changes saved successfully!
        </div>
        <form id="playerInfoForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="nickname">Nickname</label>
              <input type="text" id="nickname" class="form-input" placeholder="Enter nickname">
            </div>
            <div class="form-group">
              <label class="form-label" for="jerseyNumber">Jersey Number(s)</label>
              <input type="text" id="jerseyNumber" class="form-input" placeholder="e.g., 24, 42">
            </div>
            <div class="form-group">
              <label class="form-label" for="battingSide">Bats</label>
              <select id="battingSide" class="form-select">
                <option value="">Select...</option>
                <option value="right">Right</option>
                <option value="left">Left</option>
                <option value="switch">Switch</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="throwingArm">Throws</label>
              <select id="throwingArm" class="form-select">
                <option value="">Select...</option>
                <option value="right">Right</option>
                <option value="left">Left</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="primaryPosition">Primary Position</label>
              <select id="primaryPosition" class="form-select">
                <option value="">Select...</option>
                <option value="pitcher">Pitcher</option>
                <option value="catcher">Catcher</option>
                <option value="1b">First Base</option>
                <option value="2b">Second Base</option>
                <option value="3b">Third Base</option>
                <option value="ss">Shortstop</option>
                <option value="if">Infield</option>
                <option value="lf">Left Field</option>
                <option value="cf">Center Field</option>
                <option value="rf">Right Field</option>
                <option value="of">Outfield</option>
                <option value="utility">Utility</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="secondaryPositions">Secondary Positions</label>
              <input type="text" id="secondaryPositions" class="form-input" placeholder="e.g., 2B, SS, OF">
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Changes
            </button>
            <button type="button" class="btn btn-secondary" id="cancelPlayerInfo">
              ‚úñÔ∏è Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Favorites Tab -->
    <div class="tab-content" id="tab-favorites">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üèÜ</span> Favorite Teams</h2>
          <button class="btn btn-secondary" id="addFavoriteTeam">
            + Add Team
          </button>
        </div>
        <div class="favorites-grid" id="favoriteTeamsGrid">
          <!-- Will be populated dynamically -->
        </div>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">‚≠ê</span> Favorite Players (Max 10)</h2>
          <button class="btn btn-secondary" id="addFavoritePlayer">
            + Add Player
          </button>
        </div>
        <div class="favorites-grid" id="favoritePlayersGrid">
          <!-- Will be populated dynamically -->
        </div>
      </div>
    </div>

    <!-- Preferences Tab -->
    <div class="tab-content" id="tab-preferences">
<!-- Push Notifications Section -->
      <div id="successMessagePreferences" class="success-message">
  Preferences saved successfully!
</div>
	  
	  <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîî</span> Push Notifications</h2>
        </div>
        
        <div class="notification-status" style="margin-bottom: 1.5rem;">
          <p id="notification-status-text" style="color: var(--text-light); margin-bottom: 1rem;">
            Checking notification status...
          </p>
          <button id="enable-notifications-btn" class="btn btn-primary" style="display: none;">
            üîî Enable Push Notifications
          </button>
        </div>
        
        <div id="notification-preferences" style="display: none;">
          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">Game Notifications</h3>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Game Reminders (1 hour before)</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-game-reminders" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Get notified when your game is starting soon
              </small>
            </div>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">RSVP Reminders</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-rsvp-reminders" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Daily reminders if you haven't RSVP'd for upcoming games
              </small>
            </div>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Schedule Changes</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-schedule-changes" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Game time, date, or opponent changes
              </small>
            </div>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Lineup Changes</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-lineup-changes" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Batting order and fielding position updates
              </small>
            </div>
          </div>
          
          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">League Updates</h3>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">League Announcements</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-announcements" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Important league-wide announcements from admins
              </small>
            </div>
          </div>
          
          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">Score Updates</h3>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Score Updates</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-score-updates" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Get notified when games finish with final scores
              </small>
            </div>
            
            <div class="form-group" style="margin-left: 2rem;">
              <label class="toggle-group">
                <span class="form-label" style="font-size: 0.9rem; color: var(--text-light);">Final Score Only (no live updates)</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-final-score-only" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem; font-size: 0.85rem;">
                Ready for future live scoring feature
              </small>
            </div>
          </div>
          
          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">Personal Achievements</h3>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Milestones & Achievements</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-milestones" checked>
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Coming soon - Career milestones and achievements
              </small>
            </div>
          </div>
          
          <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
            <h3 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--text-dark);">Quiet Hours</h3>
            
            <div class="form-group">
              <label class="toggle-group">
                <span class="form-label">Enable Quiet Hours</span>
                <label class="toggle-switch">
                  <input type="checkbox" id="pref-quiet-hours">
                  <span class="toggle-slider"></span>
                </label>
              </label>
              <small style="color: var(--text-light); display: block; margin-top: 0.25rem; margin-left: 0.5rem;">
                Pause notifications during specified hours
              </small>
            </div>
            
            <div class="form-grid" style="margin-top: 1rem;">
              <div class="form-group">
                <label class="form-label" for="quiet-start">Start Time</label>
                <input type="time" id="quiet-start" class="form-input" value="22:00">
              </div>
              <div class="form-group">
                <label class="form-label" for="quiet-end">End Time</label>
                <input type="time" id="quiet-end" class="form-input" value="08:00">
              </div>
            </div>
          </div>
          
          <div class="btn-group" style="margin-top: 2rem;">
            <button id="save-preferences-btn" class="btn btn-primary">
              üíæ Save Notification Preferences
            </button>
          </div>
        </div>
        
        <div class="notification-actions" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
          <button id="disable-notifications-btn" class="btn btn-danger" style="display: none;">
            üîï Disable All Notifications
          </button>
        </div>
      </div>
      

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üé®</span> Display Preferences</h2>
        </div>
        <form id="displayPreferencesForm">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="defaultStatsView">Default Stats View</label>
              <select id="defaultStatsView" class="form-select">
                <option value="season">Current Season</option>
                <option value="career">Career Stats</option>
                <option value="recent">Recent Games</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="defaultSeason">Default Season</label>
              <select id="defaultSeason" class="form-select">
                <option value="current">Current Season</option>
                <option value="2025-summer">2025 Summer</option>
                <option value="2024-fall">2024 Fall</option>
                <option value="2024-summer">2024 Summer</option>
              </select>
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Preferences
            </button>
          </div>
        </form>
      </div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîê</span> Privacy</h2>
        </div>
        <form id="privacySettingsForm">
          <div class="form-group">
            <label class="toggle-group">
              <span class="form-label">Make my favorites visible to other users</span>
              <label class="toggle-switch">
                <input type="checkbox" id="publicFavorites">
                <span class="toggle-slider"></span>
              </label>
            </label>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">
              üíæ Save Privacy Settings
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Directory Tab -->
    <div class="tab-content" id="tab-directory">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üìá</span> Aces Directory</h2>
        </div>
        <div id="successMessageDirectory" class="success-message">
          Directory settings saved successfully!
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
          The Aces Directory is a member directory that allows you to connect with other Aces and utilize their skills and services when necessary. 
          You can choose to opt-in and share your contact information with other verified members.
        </p>
        
        <div class="form-group">
          <label class="toggle-container">
            <input type="checkbox" id="directoryOptIn">
            <span class="toggle-label">
              <strong>Include me in the Aces Directory</strong>
              <small style="display: block; color: var(--text-light); margin-top: 0.25rem;">
                Make my profile visible to other authenticated members
              </small>
            </span>
          </label>
        </div>

        <div id="directoryFields" style="display: none;">
          <div class="form-group">
            <label class="form-label" for="directoryPhone">
              Phone Number
              <span style="color: var(--text-light); font-weight: normal; font-size: 0.9rem;">
                (visible to authenticated members)
              </span>
            </label>
            <input 
              type="tel" 
              id="directoryPhone" 
              class="form-input" 
              placeholder="(555) 123-4567"
              autocomplete="tel"
            >
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
              Enter your preferred contact number
            </small>
          </div>

          <div class="form-group">
            <label class="form-label" for="directoryOccupation">
              Occupation / Job Title
              <span style="color: var(--text-light); font-weight: normal; font-size: 0.9rem;">
                (optional)
              </span>
            </label>
            <input 
              type="text" 
              id="directoryOccupation" 
              class="form-input" 
              placeholder="Software Engineer, Teacher, Business Owner, etc."
              maxlength="100"
            >
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
              Share what you do professionally
            </small>
          </div>

          <div class="form-group">
            <label class="form-label" for="directorySkills">
              Additional Skills / Interests
              <span style="color: var(--text-light); font-weight: normal; font-size: 0.9rem;">
                (optional)
              </span>
            </label>
            <textarea 
              id="directorySkills" 
              class="form-input" 
              placeholder="Photography, Carpentry, Web Design, Event Planning, etc."
              rows="3"
              maxlength="200"
            ></textarea>
            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
              Share any skills that might be helpful to fellow members (max 200 characters)
            </small>
          </div>

          <div class="alert alert-info" style="background: #e0f2fe; border: 2px solid #0ea5e9; padding: 1rem; border-radius: 8px; margin-top: 1.5rem;">
            <strong style="color: #0c4a6e; display: block; margin-bottom: 0.5rem;">üîí Privacy Note</strong>
            <p style="color: #0c4a6e; margin: 0; font-size: 0.9rem; line-height: 1.5;">
              Your directory information is only visible to authenticated Mountainside Aces members who are signed in. 
              You can update or remove your information at any time.
            </p>
          </div>
        </div>

        <div class="btn-group" style="margin-top: 1.5rem;">
          <button class="btn btn-primary" id="saveDirectoryBtn">
            üíæ Save Directory Settings
          </button>
          <a href="aces-directory.html" class="btn btn-secondary">
            üìá View Directory ‚Üí
          </a>
        </div>
      </div>
    </div>

    <!-- Security Tab -->
    <div class="tab-content" id="tab-security">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üîì</span> Account Security</h2>
        </div>
        <div id="successMessageSecurity" class="success-message">
          Password changed successfully!
        </div>
        <div class="form-group">
          <label class="form-label">Email Address</label>
          <input type="email" class="form-input" id="accountEmail" disabled>
        </div>
        <div class="form-group">
          <label class="form-label">Account Type</label>
          <input type="text" class="form-input" id="accountType" value="Google Sign-In" disabled>
        </div>
      </div>

<!-- Profile Photo Section -->
<div class="section-card">
  <div class="section-header">
    <h2><span class="section-icon">üì∑</span> Profile Photo</h2>
  </div>
  
  <div id="successMessagePhoto" class="success-message">
    Profile photo updated successfully!
  </div>
  
  <p style="color: var(--text-light); margin-bottom: 1.5rem; line-height: 1.6;">
    Choose which photo to display on your profile. You can upload a custom photo or use your Google account photo.
  </p>
  
  <!-- Current Photo Display -->
  <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 8px;">
    <img id="currentPhotoPreview" src="" alt="Current Photo" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid var(--border-color);">
    <div>
      <div style="font-weight: 600; color: var(--text-dark); margin-bottom: 0.25rem;">Current Photo Source</div>
      <div id="currentPhotoSource" style="color: var(--text-light); font-size: 0.9rem;">Loading...</div>
    </div>
  </div>
  
  <!-- Photo Options -->
  <div class="btn-group" style="display: flex; gap: 1rem; flex-wrap: wrap;">
    <!-- Upload Custom Photo Button -->
    <button class="btn btn-primary" id="uploadCustomPhotoBtn" style="flex: 1; min-width: 200px;">
      üì§ Upload Custom Photo
    </button>
    
    <!-- Use Google Photo Button (only for Google users) -->
    <button class="btn btn-secondary" id="useGooglePhotoBtn" style="flex: 1; min-width: 200px; display: none;">
      <span style="display: inline-block; width: 20px; height: 20px; margin-right: 8px;">
        <svg viewBox="0 0 24 24" style="width: 100%; height: 100%;">
          <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
          <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
          <path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
          <path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
        </svg>
      </span>
      Use Google Photo
    </button>
  </div>
  
  <!-- Hidden file input -->
  <input type="file" id="customPhotoInput" accept="image/*" style="display: none;">
  
  <!-- Google Photo Info (only shown for Google users) -->
  <div id="googlePhotoInfo" style="display: none; margin-top: 1rem; padding: 1rem; background: #e6f7ff; border-radius: 8px; border-left: 4px solid #1890ff;">
    <div style="display: flex; align-items: start; gap: 0.75rem;">
      <span style="font-size: 1.25rem;">‚ÑπÔ∏è</span>
      <div style="flex: 1;">
        <strong style="color: #1890ff;">Google Account Photo</strong>
        <p style="margin: 0.5rem 0 0 0; color: #4a5568; font-size: 0.9rem; line-height: 1.5;">
          Your Google account photo will automatically update here if you change it in your Google account settings.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Change Password Section -->
<div class="section-card">
  <div class="section-header">
    <h2><span class="section-icon">üîë</span> Change Password</h2>
  </div>
  
  <div id="successMessagePassword" class="success-message">
    Password changed successfully!
  </div>
  
  <!-- Email/Password Users -->
  <div id="passwordChangeForm" style="display: none;">
    <form id="changePasswordForm">
      <div class="form-group">
        <label class="form-label" for="currentPassword">Current Password</label>
        <input type="password" id="currentPassword" class="form-input" 
               placeholder="Enter current password" required>
      </div>
      <div class="form-group">
        <label class="form-label" for="newPassword">New Password</label>
        <input type="password" id="newPassword" class="form-input" 
               placeholder="Enter new password (min 6 characters)" required minlength="6">
      </div>
      <div class="form-group">
        <label class="form-label" for="confirmPassword">Confirm New Password</label>
        <input type="password" id="confirmPassword" class="form-input" 
               placeholder="Confirm new password" required>
      </div>
      <div class="btn-group">
        <button type="submit" class="btn btn-primary">
          üîë Change Password
        </button>
        <button type="button" class="btn btn-secondary" id="cancelPasswordChange">
          ‚úñÔ∏è Cancel
        </button>
      </div>
    </form>
  </div>
  
  <!-- Google Users -->
  <div id="googlePasswordMessage" style="display: none;">
    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
      Since you're signed in with Google, password changes are managed through your Google account.
    </p>
    <a href="https://myaccount.google.com/security" target="_blank" class="btn btn-primary">
      Manage Google Account Security ‚Üí
    </a>
  </div>
</div>

      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üö™</span> Sign Out</h2>
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          Sign out from your Mountainside Aces account on this device.
        </p>
        <button class="btn btn-secondary" id="signOutBtn">
          üö™ Sign Out
        </button>
      </div>
    </div>

    <!-- Games Tab -->
    <div class="tab-content" id="tab-games">
      <div class="section-card">
        <div class="section-header">
          <h2><span class="section-icon">üéÆ</span> Daily Games Stats</h2>
        </div>
        <p style="color: var(--text-light); margin-bottom: 1.5rem;">
          Track your performance across all Mountainside Aces daily games.
        </p>
        
        <!-- Games Stats Grid -->
        <div id="gamesStatsContainer">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem;">
            
            <!-- Aces Grid Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #bbf7d0;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">üéØ</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #166534;">Aces Grid</h3>
                  <a href="immaculate-grid.html" style="font-size: 0.8rem; color: #22c55e; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="gridPlayed" style="font-size: 1.5rem; font-weight: 700; color: #166534;">0</div>
                  <div style="font-size: 0.7rem; color: #4ade80; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="gridPerfect" style="font-size: 1.5rem; font-weight: 700; color: #166534;">0</div>
                  <div style="font-size: 0.7rem; color: #4ade80; text-transform: uppercase;">Perfect</div>
                </div>
                <div>
                  <div id="gridStreak" style="font-size: 1.5rem; font-weight: 700; color: #166534;">0</div>
                  <div style="font-size: 0.7rem; color: #4ade80; text-transform: uppercase;">Streak</div>
                </div>
              </div>
            </div>

            <!-- Aces Connections Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #e9d5ff;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">üîó</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #7c3aed;">Aces Connections</h3>
                  <a href="aces-connections.html" style="font-size: 0.8rem; color: #a855f7; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="connectionsPlayed" style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">0</div>
                  <div style="font-size: 0.7rem; color: #a855f7; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="connectionsWins" style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">0</div>
                  <div style="font-size: 0.7rem; color: #a855f7; text-transform: uppercase;">Perfect</div>
                </div>
                <div>
                  <div id="connectionsStreak" style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">0</div>
                  <div style="font-size: 0.7rem; color: #a855f7; text-transform: uppercase;">Streak</div>
                </div>
              </div>
            </div>

            <!-- Aces Wordle Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #f0fdf4 0%, #d1fae5 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #6ee7b7;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">üî§</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #047857;">Aces Wordle</h3>
                  <a href="aces-wordle.html" style="font-size: 0.8rem; color: #10b981; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="wordlePlayed" style="font-size: 1.5rem; font-weight: 700; color: #047857;">0</div>
                  <div style="font-size: 0.7rem; color: #10b981; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="wordleWinPct" style="font-size: 1.5rem; font-weight: 700; color: #047857;">0%</div>
                  <div style="font-size: 0.7rem; color: #10b981; text-transform: uppercase;">Win Rate</div>
                </div>
                <div>
                  <div id="wordleStreak" style="font-size: 1.5rem; font-weight: 700; color: #047857;">0</div>
                  <div style="font-size: 0.7rem; color: #10b981; text-transform: uppercase;">Streak</div>
                </div>
              </div>
            </div>

            <!-- Higher or Lower Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #fed7aa;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">‚¨ÜÔ∏è‚¨áÔ∏è</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #c2410c;">Higher or Lower</h3>
                  <a href="higher-lower.html" style="font-size: 0.8rem; color: #f97316; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="higherLowerPlayed" style="font-size: 1.5rem; font-weight: 700; color: #c2410c;">0</div>
                  <div style="font-size: 0.7rem; color: #f97316; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="higherLowerBest" style="font-size: 1.5rem; font-weight: 700; color: #c2410c;">0</div>
                  <div style="font-size: 0.7rem; color: #f97316; text-transform: uppercase;">Perfect</div>
                </div>
                <div>
                  <div id="higherLowerAvg" style="font-size: 1.5rem; font-weight: 700; color: #c2410c;">0</div>
                  <div style="font-size: 0.7rem; color: #f97316; text-transform: uppercase;">Avg Score</div>
                </div>
              </div>
            </div>

            <!-- Who Am I Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #f0fdfa 0%, #ccfbf1 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #99f6e4;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">üé≠</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #0f766e;">Who Am I?</h3>
                  <a href="who-am-i.html" style="font-size: 0.8rem; color: #14b8a6; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="whoAmIPlayed" style="font-size: 1.5rem; font-weight: 700; color: #0f766e;">0</div>
                  <div style="font-size: 0.7rem; color: #14b8a6; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="whoAmIWins" style="font-size: 1.5rem; font-weight: 700; color: #0f766e;">0</div>
                  <div style="font-size: 0.7rem; color: #14b8a6; text-transform: uppercase;">Wins</div>
                </div>
                <div>
                  <div id="whoAmIAvgScore" style="font-size: 1.5rem; font-weight: 700; color: #0f766e;">0</div>
                  <div style="font-size: 0.7rem; color: #14b8a6; text-transform: uppercase;">Avg Score</div>
                </div>
              </div>
            </div>

            <!-- Player Recall Stats -->
            <div class="game-stat-card" style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 12px; padding: 1.25rem; border: 1px solid #fecaca;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <span style="font-size: 1.5rem;">‚è±Ô∏è</span>
                <div>
                  <h3 style="margin: 0; font-size: 1.1rem; color: #b91c1c;">Player Recall</h3>
                  <a href="roster-recall.html" style="font-size: 0.8rem; color: #ef4444; text-decoration: none;">Play Now ‚Üí</a>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; text-align: center;">
                <div>
                  <div id="recallPlayed" style="font-size: 1.5rem; font-weight: 700; color: #b91c1c;">0</div>
                  <div style="font-size: 0.7rem; color: #ef4444; text-transform: uppercase;">Played</div>
                </div>
                <div>
                  <div id="recallPerfect" style="font-size: 1.5rem; font-weight: 700; color: #b91c1c;">0</div>
                  <div style="font-size: 0.7rem; color: #ef4444; text-transform: uppercase;">Perfect</div>
                </div>
                <div>
                  <div id="recallBest" style="font-size: 1.5rem; font-weight: 700; color: #b91c1c;">0</div>
                  <div style="font-size: 0.7rem; color: #ef4444; text-transform: uppercase;">Best Score</div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Games Summary Card -->
      <div class="section-card" style="margin-top: 1.5rem;">
        <div class="section-header">
          <h2><span class="section-icon">üèÜ</span> Overall Summary</h2>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 1rem; text-align: center;">
          <div style="background: #f7fafc; padding: 1.25rem; border-radius: 12px;">
            <div id="totalGamesPlayed" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">0</div>
            <div style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">Total Played</div>
          </div>
          <div style="background: #f7fafc; padding: 1.25rem; border-radius: 12px;">
            <div id="totalPerfects" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">0</div>
            <div style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">Perfect Games</div>
          </div>
          <div style="background: #f7fafc; padding: 1.25rem; border-radius: 12px;">
            <div id="longestStreak" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">0</div>
            <div style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">Best Streak</div>
          </div>
          <div style="background: #f7fafc; padding: 1.25rem; border-radius: 12px;">
            <div id="gamesPlayedToday" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">0</div>
            <div style="font-size: 0.8rem; color: var(--text-light); text-transform: uppercase;">Played Today</div>
          </div>
        </div>
      </div>

      <!-- Badges Section -->
      <div class="section-card" style="margin-top: 1.5rem;">
        <div class="section-header">
          <h2><span class="section-icon">üèÖ</span> Badges & Achievements</h2>
        </div>
        <p style="color: var(--text-light); margin-bottom: 1rem; font-size: 0.9rem;">
          Earn badges by playing games and hitting milestones. <span id="badgeCount" style="font-weight: 600;">0/37</span> unlocked.
        </p>
        <div id="badgesContainer" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
          <!-- Badges will be rendered by JavaScript -->
          <div style="color: var(--text-light); font-style: italic;">Loading badges...</div>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="section-card" style="margin-top: 1.5rem;">
        <div class="section-header">
          <h2><span class="section-icon">üéÆ</span> Quick Links</h2>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
          <a href="games.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; text-decoration: none; border-radius: 8px; font-weight: 600;">
            üéÆ All Games
          </a>
          <a href="immaculate-grid.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #f0fdf4; color: #166534; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #bbf7d0;">
            üéØ Aces Grid
          </a>
          <a href="aces-connections.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #faf5ff; color: #7c3aed; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #e9d5ff;">
            üîó Connections
          </a>
          <a href="aces-wordle.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #f0fdf4; color: #047857; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #6ee7b7;">
            üî§ Wordle
          </a>
          <a href="higher-lower.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #fff7ed; color: #c2410c; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #fed7aa;">
            ‚¨ÜÔ∏è‚¨áÔ∏è Higher/Lower
          </a>
          <a href="who-am-i.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #f0fdfa; color: #0f766e; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #99f6e4;">
            üé≠ Who Am I?
          </a>
          <a href="roster-recall.html" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #fef2f2; color: #b91c1c; text-decoration: none; border-radius: 8px; font-weight: 500; border: 1px solid #fecaca;">
            ‚è±Ô∏è Player Recall
          </a>
        </div>
      </div>
    </div>
  </main>

  <!-- Team Selection Modal -->
  <div class="modal" id="teamModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Favorite Team</h2>
        <button class="modal-close" onclick="closeTeamModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="teamSearch" placeholder="üîç Search teams...">
        <div class="selection-list" id="teamList">
          <!-- Teams will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeTeamModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmTeamBtn" disabled onclick="confirmAddTeam()">
          <span>Add Team</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Player Selection Modal -->
  <div class="modal" id="playerModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Favorite Player</h2>
        <button class="modal-close" onclick="closePlayerModal()">‚úñ</button>
      </div>
      <div class="modal-body">
        <input type="text" class="modal-search" id="playerSearch" placeholder="üîç Search players...">
        <div class="selection-list" id="playerList">
          <!-- Players will be loaded here -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePlayerModal()">Cancel</button>
        <button class="btn btn-primary" id="confirmPlayerBtn" disabled onclick="confirmAddPlayer()">
          <span>Add Player</span>
        </button>
      </div>
    </div>
  </div>

  <script type="module">
import { onAuthChange, getCurrentUser, logoutUser, getUserProfile, updateUserProfile as updateUserProfileAuth, addFavoriteTeam, addFavoritePlayer, auth } from './firebase-auth.js';
import { getCurrentSeason, getSeasonPlayerStatsOptimized, getAllTeams, getAllPlayerStatsOptimized, db, doc, getDoc } from './firebase-data.js';
import { updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
	import {   requestNotificationPermission,   updateNotificationPreferences,  removeFCMToken } from './firebase-messaging.js';
	import { uploadProfilePhoto, deleteOldProfilePhoto } from './firebase-storage.js';
	
    let currentUser = null;
    let userProfile = null;
    let selectedTeam = null;
    let selectedPlayer = null;
    let allTeams = [];
    let allPlayers = [];

    console.log('üìÑ Profile page loading...');
// Add this function to load notification preferences:
async function loadNotificationPreferences() {
  try {
    const user = auth.currentUser;
    if (!user) return;
    
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    const userData = userDoc.data();
    
    // Check notification status
    const statusText = document.getElementById('notification-status-text');
    const enableBtn = document.getElementById('enable-notifications-btn');
    const prefsSection = document.getElementById('notification-preferences');
    const disableBtn = document.getElementById('disable-notifications-btn');
    
    if (Notification.permission === 'granted' && userData?.notificationsEnabled) {
      statusText.textContent = '‚úÖ Push notifications are enabled';
      statusText.style.color = 'var(--primary-color)';
      prefsSection.style.display = 'block';
      disableBtn.style.display = 'block';
      
      // Load preferences
      const prefs = userData.notificationPreferences || {};
      document.getElementById('pref-game-reminders').checked = prefs.gameReminders?.enabled ?? true;
      document.getElementById('pref-rsvp-reminders').checked = prefs.rsvpReminders?.enabled ?? true;
      document.getElementById('pref-schedule-changes').checked = prefs.scheduleChanges?.enabled ?? true;
      document.getElementById('pref-lineup-changes').checked = prefs.lineupChanges?.enabled ?? true;
      document.getElementById('pref-score-updates').checked = prefs.scoreUpdates?.enabled ?? false;
      document.getElementById('pref-final-score-only').checked = prefs.scoreUpdates?.finalScoreOnly ?? true;
      document.getElementById('pref-milestones').checked = prefs.milestones?.enabled ?? true;
      document.getElementById('pref-quiet-hours').checked = prefs.quietHours?.enabled ?? true;
      document.getElementById('quiet-start').value = prefs.quietHours?.start || '22:00';
      document.getElementById('quiet-end').value = prefs.quietHours?.end || '08:00';
      
    } else {
      statusText.textContent = 'üîï Push notifications are disabled';
      statusText.style.color = 'var(--text-light)';
      enableBtn.style.display = 'block';
    }
    
  } catch (error) {
    console.error('Error loading notification preferences:', error);
  }
}


    // Tab switching functionality
    document.querySelectorAll('.nav-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const targetTab = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        document.getElementById(`tab-${targetTab}`).classList.add('active');
      });
    });

    // Initialize auth state
    onAuthChange(async (user) => {
      console.log('üîê Auth state changed:', user ? user.email : 'No user');
      
      if (user) {
        currentUser = user;
        try {
          await loadUserProfile(user);
		       
			const { ensureCorrectProfilePage } = await import('./firebase-auth.js');
			ensureCorrectProfilePage(userProfile, 'profile.html');

		  await loadCaptainTools();
          await loadUserStats(user);
          await showWrappedPromoIfEligible();
          await loadGamesStats(); // Load games tab stats from Firebase
        } catch (error) {
          console.error('‚ùå Error loading profile data:', error);
          alert('Error loading profile. Check console for details.');
        } finally {
          hideLoading();
        }
      } else {
        console.log('‚ö†Ô∏è No user signed in, redirecting to signin page...');
        window.location.href = 'signin.html';
      }
    });

    async function loadUserProfile(user) {
      console.log('üìã Loading user profile for:', user.uid);
      		    // Check email verification for email/password users
    const isEmailProvider = user.providerData.some(
      provider => provider.providerId === 'password'
	  	      );
          // Load notification preferences
      await loadNotificationPreferences();
    if (isEmailProvider && !user.emailVerified) {
      console.log('‚ö†Ô∏è User email not verified - showing banner');
      document.getElementById('verificationBanner').style.display = 'block';
    } else {
      document.getElementById('verificationBanner').style.display = 'none';
    }
      try {
        const result = await getUserProfile(user.uid);
        console.log('‚úÖ User profile result:', result);
        

		
		
        if (result.success && result.data) {
          userProfile = result.data;
        } else {
          console.log('‚ö†Ô∏è No profile data found');
          userProfile = null;
        }
        
        // If there's a mergedFromProfile, load that old profile data too
        let mergedProfileData = null;
        if (userProfile?.mergedFromProfile) {
          console.log('üîó Loading merged profile data from:', userProfile.mergedFromProfile);
          try {
            const { getPlayer } = await import('./firebase-data.js');
            mergedProfileData = await getPlayer(userProfile.mergedFromProfile);
            console.log('‚úÖ Merged profile data loaded:', mergedProfileData);
          } catch (error) {
            console.warn('‚ö†Ô∏è Could not load merged profile:', error);
          }
        }
        
// NEW: Determine the display name to use (preferred or Google name)
const displayName = userProfile?.preferredDisplayName || user.displayName || 'User';

// Update header - prioritize custom profile photo, fallback to Google photo
const photoElement = document.getElementById('profilePhoto');
if (userProfile?.profilePhotoURL) {
  // User has uploaded a custom profile photo
  photoElement.src = userProfile.profilePhotoURL;
  photoElement.style.display = 'block';
} else if (user.photoURL) {
  // Use Google photo if available
  photoElement.src = user.photoURL;
  photoElement.style.display = 'block';
} else {
  // No photo available - use placeholder or hide
  photoElement.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="120" height="120"%3E%3Crect fill="%232d5016" width="120" height="120"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="48" font-family="Arial"%3E' + (displayName.charAt(0).toUpperCase()) + '%3C/text%3E%3C/svg%3E';
  photoElement.style.display = 'block';
}
document.getElementById('displayName').textContent = displayName;
document.getElementById('playerName').textContent = userProfile?.linkedPlayer || 'Not linked';
document.getElementById('teamBadge').textContent = userProfile?.linkedTeam || 'No team';
document.getElementById('accountEmail').value = user.email;

// Determine account type based on provider data
let accountType = 'Email/Password';
if (user.providerData && user.providerData.length > 0) {
  const provider = user.providerData[0].providerId;
  if (provider === 'google.com') {
    accountType = 'Google Sign-In';
  } else if (provider === 'password') {
    accountType = 'Email/Password';
  }
}
document.getElementById('accountType').value = accountType;

// NEW: Update password change UI based on account type
updatePasswordChangeUI(user);


// NEW: Load the display name form
document.getElementById('preferredDisplayName').value = userProfile?.preferredDisplayName || '';
document.getElementById('googleAccountName').textContent = user.displayName || user.email;
		
		        
        
        // Calculate member since
        const createdDate = new Date(user.metadata.creationTime);
        document.getElementById('memberSince').textContent = `Member since ${createdDate.getFullYear()}`;


		// NEW: Load "Ace since" year (first year they appear in data)
		if (userProfile?.linkedPlayer) {
			await loadAceSinceYear(userProfile, mergedProfileData);
			}

			// NEW: Display role badges
			displayRoleBadges(userProfile);
		
		
        // Load player info form - prefer merged profile data, fall back to current profile
        if (userProfile) {
          const nickname = userProfile.nickname || mergedProfileData?.nickname || '';
          const jerseyNumber = userProfile.number || mergedProfileData?.number || '';
          
          // Map single letter codes to full words
          const mapBattingCode = (code) => {
            if (!code) return '';
            const upper = code.toUpperCase();
            if (upper === 'R') return 'right';
            if (upper === 'L') return 'left';
            if (upper === 'S') return 'switch';
            return code.toLowerCase();
          };
          
          const mapThrowingCode = (code) => {
            if (!code) return '';
            const upper = code.toUpperCase();
            if (upper === 'R') return 'right';
            if (upper === 'L') return 'left';
            return code.toLowerCase();
          };
          
          const mapPosition = (pos) => {
            if (!pos) return '';
            const upper = pos.toUpperCase();
            if (upper === '1B') return '1b';
            if (upper === '2B') return '2b';
            if (upper === '3B') return '3b';
            if (upper === 'SS') return 'ss';
            if (upper === 'IF') return 'if';
            if (upper === 'LF') return 'lf';
            if (upper === 'CF') return 'cf';
            if (upper === 'RF') return 'rf';
            if (upper === 'OF') return 'of';
            if (upper === 'P') return 'pitcher';
            if (upper === 'C') return 'catcher';
            if (upper === 'UTILITY' || upper === 'UTL') return 'utility';
            return pos.toLowerCase();
          };
          
          const battingSide = mapBattingCode(userProfile.bats || mergedProfileData?.bats);
          const throwingArm = mapThrowingCode(userProfile.throws || mergedProfileData?.throws);
          const primaryPosition = mapPosition(userProfile.position || mergedProfileData?.position);
          const secondaryPositions = userProfile.secondaryPositions || '';
          
          document.getElementById('nickname').value = nickname;
          document.getElementById('jerseyNumber').value = jerseyNumber;
          document.getElementById('battingSide').value = battingSide;
          document.getElementById('throwingArm').value = throwingArm;
          document.getElementById('primaryPosition').value = primaryPosition;
          document.getElementById('secondaryPositions').value = secondaryPositions;
          
          console.log('üìù Loaded player info:', { nickname, jerseyNumber, battingSide, throwingArm, primaryPosition });
          
          // Load preferences
          document.getElementById('publicFavorites').checked = userProfile.preferences?.publicFavorites ?? false;
          document.getElementById('defaultStatsView').value = userProfile.preferences?.defaultStatsView || 'season';
          document.getElementById('defaultSeason').value = userProfile.preferences?.defaultSeason || 'current';
          
          // Load directory settings
          document.getElementById('directoryOptIn').checked = userProfile.directoryOptIn ?? false;
          document.getElementById('directoryPhone').value = userProfile.directoryPhone || '';
          document.getElementById('directoryOccupation').value = userProfile.directoryOccupation || '';
          document.getElementById('directorySkills').value = userProfile.directorySkills || '';
          
          // Show/hide directory fields based on opt-in status
          const directoryFields = document.getElementById('directoryFields');
          if (userProfile.directoryOptIn) {
            directoryFields.style.display = 'block';
          } else {
            directoryFields.style.display = 'none';
          }
          
// Update quick links
// For stats link: use name-based if player is linked, otherwise use ID
const playerId = user.uid;
if (userProfile.linkedPlayer) {
  // Use name-based link if player is linked
  document.getElementById('linkMyStats').href = `player.html?name=${encodeURIComponent(userProfile.linkedPlayer)}`;
} else {
  // Use ID-based link for new users not yet linked
  document.getElementById('linkMyStats').href = `player.html?id=${encodeURIComponent(playerId)}`;
}

if (userProfile.linkedTeam) {
  document.getElementById('linkMyTeam').href = `team.html?team=${encodeURIComponent(userProfile.linkedTeam)}`;
} else {
  // Disable team link if no team assigned
  document.getElementById('linkMyTeam').style.opacity = '0.5';
  document.getElementById('linkMyTeam').style.pointerEvents = 'none';
  document.getElementById('linkMyTeam').title = 'No team assigned yet';
}
          
          // Load favorites
          loadFavorites();
          
          // Update photo source display in settings tab
          updatePhotoSourceDisplay();
        }
      } catch (error) {
        console.error('‚ùå Error loading user profile:', error);
        // Continue anyway, show default values
        const photoElement = document.getElementById('profilePhoto');
  if (user.photoURL) {
    photoElement.src = user.photoURL;
    photoElement.style.display = 'block';
  } else {
    photoElement.style.display = 'none';
  }
        document.getElementById('displayName').textContent = user.displayName || 'User';
        document.getElementById('playerName').textContent = 'Not linked';
        document.getElementById('teamBadge').textContent = 'No team';
        document.getElementById('accountEmail').value = user.email;
      }
    }

// Import password change function
import { changeUserPassword } from './firebase-auth.js';

// Show/hide password change form based on account type
function updatePasswordChangeUI(user) {
  const isEmailProvider = user.providerData.some(
    provider => provider.providerId === 'password'
  );
  
  if (isEmailProvider) {
    document.getElementById('passwordChangeForm').style.display = 'block';
    document.getElementById('googlePasswordMessage').style.display = 'none';
  } else {
    document.getElementById('passwordChangeForm').style.display = 'none';
    document.getElementById('googlePasswordMessage').style.display = 'block';
  }
}

// Handle password change form submission
document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  // Validate passwords match
  if (newPassword !== confirmPassword) {
    alert('New passwords do not match');
    return;
  }
  
  // Show loading state
  const submitBtn = e.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'üîÑ Changing Password...';
  
  try {
    const result = await changeUserPassword(currentPassword, newPassword);
    
    if (result.success) {
      // Clear form
      document.getElementById('changePasswordForm').reset();
      
      // Show success message
      showSuccessMessage('successMessagePassword');
      
      // Optional: Sign out user to re-authenticate with new password
      // Uncomment if you want to force re-login after password change
      // setTimeout(() => {
      //   alert('Password changed! Please sign in again with your new password.');
      //   logoutUser().then(() => {
      //     window.location.href = 'signin.html';
      //   });
      // }, 2000);
      
    } else {
      alert(result.message || 'Failed to change password');
    }
  } catch (error) {
    console.error('Error changing password:', error);
    alert('An error occurred while changing password');
  } finally {
    // Restore button
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
});

// Handle cancel button
document.getElementById('cancelPasswordChange').addEventListener('click', () => {
  document.getElementById('changePasswordForm').reset();
});


// NEW: Load "Ace since" year - find first year player appears in data
async function loadAceSinceYear(userProfile, mergedProfileData) {
  try {
    let earliestYear = null;
    
    console.log('üîç Checking for Ace since year...');
    console.log('üë§ User profile:', userProfile);
    console.log('üîó Merged profile:', mergedProfileData);
    
    // MAIN APPROACH: Load directly from Firebase using getPlayerStatsOptimized
    if (userProfile?.linkedPlayer) {
      console.log('üì° Loading player data from Firebase for:', userProfile.linkedPlayer);
      
      try {
        const { getPlayerStatsOptimized } = await import('./firebase-data.js');
        
        // Try multiple ID formats
        const idsToTry = [
          currentUser.uid,
          userProfile.mergedFromProfile,
          userProfile.linkedPlayer.toLowerCase().replace(/\s+/g, '_')
        ].filter(Boolean);
        
        console.log('üîÑ Trying player IDs:', idsToTry);
        
        let playerData = null;
        for (const id of idsToTry) {
          playerData = await getPlayerStatsOptimized(id);
          if (playerData?.seasons) {
            console.log(`‚úÖ Found player data for ID: ${id}`);
            console.log('üì¶ Seasons object:', playerData.seasons);
            break;
          }
        }
        
        if (playerData?.seasons) {
          const seasonKeys = Object.keys(playerData.seasons);
          console.log('üìÖ Season keys found:', seasonKeys);
          
          seasonKeys.forEach(seasonKey => {
            const year = parseInt(seasonKey.split('-')[0]);
            console.log(`  - Season: ${seasonKey} ‚Üí Year: ${year}`);
            if (!isNaN(year) && (!earliestYear || year < earliestYear)) {
              earliestYear = year;
            }
          });
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not load from Firebase:', error);
      }
    }
    
    // FALLBACK: Check profile objects (in case data is already loaded)
    if (!earliestYear && userProfile?.seasons && typeof userProfile.seasons === 'object') {
      console.log('üì¶ Checking current profile seasons...');
      const seasonKeys = Object.keys(userProfile.seasons);
      seasonKeys.forEach(seasonKey => {
        const year = parseInt(seasonKey.split('-')[0]);
        if (!isNaN(year) && (!earliestYear || year < earliestYear)) {
          earliestYear = year;
        }
      });
    }
    
    if (!earliestYear && mergedProfileData?.seasons && typeof mergedProfileData.seasons === 'object') {
      console.log('üì¶ Checking merged profile seasons...');
      const seasonKeys = Object.keys(mergedProfileData.seasons);
      seasonKeys.forEach(seasonKey => {
        const year = parseInt(seasonKey.split('-')[0]);
        if (!isNaN(year) && (!earliestYear || year < earliestYear)) {
          earliestYear = year;
        }
      });
    }
    
    console.log('üéØ Final earliest year:', earliestYear);
    
    // If we found a year, display it
    if (earliestYear) {
      const aceSinceElement = document.getElementById('aceSince');
      if (aceSinceElement) {
        aceSinceElement.textContent = `Ace since ${earliestYear}`;
        aceSinceElement.style.display = 'inline-block';
        console.log('‚úÖ Ace since year displayed:', earliestYear);
      } else {
        console.error('‚ùå Could not find #aceSince element');
      }
    } else {
      console.log('‚ö†Ô∏è No earliest year found - element will remain hidden');
    }
  } catch (error) {
    console.error('‚ùå Error in loadAceSinceYear:', error);
  }
}

// NEW: Display role badges
function displayRoleBadges(userProfile) {
  if (!userProfile) return;
  
  const rolesContainer = document.getElementById('profileRoles');
  const badges = [];
  
  // Check for admin
  if (userProfile.userRole === 'admin') {
    badges.push({ role: 'admin', label: 'üëë Admin' });
  }
  
  // Check for league staff
  if (userProfile.userRole === 'league-staff') {
    badges.push({ role: 'league-staff', label: '‚ö° League Staff' });
  }
  
  // Check for captain (either legacy or new system)
  const isCaptain = userProfile.isCaptain === true || 
                    userProfile.userRole === 'captain' ||
                    (userProfile.teamRoles && Object.values(userProfile.teamRoles).some(
                      teamRole => teamRole.role === 'captain' && teamRole.status === 'active'
                    ));
  
  if (isCaptain) {
    badges.push({ role: 'captain', label: '‚≠ê Captain' });
  }
  
  // Check for team-staff
  if (userProfile.userRole === 'team-staff' ||
      (userProfile.teamRoles && Object.values(userProfile.teamRoles).some(
        teamRole => teamRole.role === 'team-staff' && teamRole.status === 'active'
      ))) {
    badges.push({ role: 'team-staff', label: 'üõ†Ô∏è Team Staff' });
  }
  
  // Check for player (only show if no other special roles)
  if (badges.length === 0 && userProfile.linkedPlayer && userProfile.userRole === 'player') {
    badges.push({ role: 'player', label: '‚öæ Player' });
  }
  
  // Render badges
  if (badges.length > 0) {
    rolesContainer.innerHTML = badges.map(badge => 
      `<span class="role-badge ${badge.role}">${badge.label}</span>`
    ).join('');
    rolesContainer.style.display = 'flex';
  } else {
    rolesContainer.style.display = 'none';
  }
  
  console.log('‚úÖ Role badges displayed:', badges.length);
}

 async function loadUserStats(user) {
  console.log('üìä Loading user stats...');
  
  try {
    // Check if user has a linked player
    const hasLinkedPlayer = userProfile?.linkedPlayer;
    
    if (!hasLinkedPlayer) {
      console.log('üÜï New user with no linked player');
      // Show dashes instead of zeros with explanatory note
      document.getElementById('statGames').textContent = '-';
      document.getElementById('statAvg').textContent = '-';
      document.getElementById('statHits').textContent = '-';
      document.getElementById('statRuns').textContent = '-';
      document.getElementById('statBPI').textContent = '-';
	  
      // Add a small note below the stats
      const statsSection = document.querySelector('.stats-grid').parentElement;
      if (statsSection && !document.getElementById('newUserNote')) {
        const note = document.createElement('p');
        note.id = 'newUserNote';
        note.style.cssText = 'color: #718096; text-align: center; margin-top: 1rem; font-style: italic;';
        note.textContent = 'Your stats will appear here once you\'ve been added to a team roster and played your first game.';
        statsSection.appendChild(note);
      }
      return;
    }
    
    // Get the stats view preference
    const statsView = userProfile?.preferences?.defaultStatsView || 'season';
    const selectedSeason = userProfile?.preferences?.defaultSeason || 'current';
    console.log('üìà Stats view preference:', statsView);
    console.log('üìÖ Selected season:', selectedSeason);
    
    // Update the header title based on selection
    updateStatsHeaderTitle(statsView, selectedSeason);
    
    const currentSeason = await getCurrentSeason();
    console.log('üìÖ Current season:', currentSeason ? currentSeason.id : 'No current season');
    
    let playerStats = null;
    
    if (statsView === 'career') {
      // Load career stats with fallback logic
      console.log('üìä Loading career stats...');
      try {
        const { getPlayerStatsOptimized } = await import('./firebase-data.js');
        
        // Try current user ID first
        let directPlayerData = await getPlayerStatsOptimized(user.uid);
        
        // If not found, try the mergedFromProfile (legacy player ID)
        if (!directPlayerData && userProfile?.mergedFromProfile) {
          console.log('üîÑ Trying legacy profile ID:', userProfile.mergedFromProfile);
          directPlayerData = await getPlayerStatsOptimized(userProfile.mergedFromProfile);
        }
        
        // If still not found, try converting player name to legacy ID format
        if (!directPlayerData && userProfile?.linkedPlayer) {
          const legacyId = userProfile.linkedPlayer.toLowerCase().replace(/\s+/g, '_');
          console.log('üîÑ Trying name-based legacy ID:', legacyId);
          directPlayerData = await getPlayerStatsOptimized(legacyId);
        }
        
        if (directPlayerData && directPlayerData.career) {
          playerStats = directPlayerData.career;
          console.log('‚úÖ Career stats loaded:', playerStats);
        } else {
          console.warn('‚ö†Ô∏è No career stats found');
        }
      } catch (error) {
        console.warn('‚ö†Ô∏è Could not load career stats:', error);
      }
    } else {
      // Determine which season to load
      let seasonToLoad = currentSeason?.id;
      
      if (selectedSeason !== 'current') {
        seasonToLoad = selectedSeason;
      }
      
      if (!seasonToLoad) {
        console.log('‚ö†Ô∏è No season to load');
        return;
      }
      
      console.log('üìä Loading stats for season:', seasonToLoad);
      
      // Load season stats
      const stats = await getSeasonPlayerStatsOptimized(seasonToLoad);
      console.log('üìà Stats loaded:', stats.length, 'players');
      console.log('üîç Searching for player:', userProfile.linkedPlayer);
      console.log('üîó MergedFromProfile:', userProfile.mergedFromProfile);
      
      // Try multiple ways to find the player
      playerStats = stats.find(s => s.playerName === userProfile.linkedPlayer);
      
      if (!playerStats) {
        playerStats = stats.find(s => s.name === userProfile.linkedPlayer);
      }
      
      if (!playerStats) {
        const linkedPlayerLower = userProfile.linkedPlayer.toLowerCase();
        playerStats = stats.find(s =>
          s.playerName?.toLowerCase() === linkedPlayerLower ||
          s.name?.toLowerCase() === linkedPlayerLower
        );
      }
      
      if (!playerStats && userProfile.mergedFromProfile) {
        console.log('üîç Trying to find stats by merged profile ID:', userProfile.mergedFromProfile);
        playerStats = stats.find(s => s.id === userProfile.mergedFromProfile || s.playerId === userProfile.mergedFromProfile);
      }
      
      if (!playerStats) {
        console.log('üîç Trying to load stats directly using user ID:', user.uid);
        try {
          const { getPlayerStatsOptimized } = await import('./firebase-data.js');
          let directPlayerData = await getPlayerStatsOptimized(user.uid);
          
          // Fallback to legacy ID if not found
          if (!directPlayerData && userProfile?.mergedFromProfile) {
            console.log('üîÑ Trying legacy profile ID for season stats:', userProfile.mergedFromProfile);
            directPlayerData = await getPlayerStatsOptimized(userProfile.mergedFromProfile);
          }
          
          // Fallback to name-based ID if still not found
          if (!directPlayerData && userProfile?.linkedPlayer) {
            const legacyId = userProfile.linkedPlayer.toLowerCase().replace(/\s+/g, '_');
            console.log('üîÑ Trying name-based legacy ID for season stats:', legacyId);
            directPlayerData = await getPlayerStatsOptimized(legacyId);
          }
          
          if (directPlayerData) {
            console.log('‚úÖ Found player data directly:', directPlayerData);
            
            if (directPlayerData.seasons && typeof directPlayerData.seasons === 'object') {
              console.log('üì¶ Seasons object keys:', Object.keys(directPlayerData.seasons));
              
              const matchingKeys = Object.keys(directPlayerData.seasons).filter(key =>
                key.startsWith(seasonToLoad)
              );
              
              console.log('üîç Matching season keys:', matchingKeys);
              
              if (matchingKeys.length > 0) {
                const seasonKey = matchingKeys[0];
                const seasonStats = directPlayerData.seasons[seasonKey];
                
                if (seasonStats) {
                  playerStats = seasonStats;
                  console.log('‚úÖ Extracted season stats from key:', seasonKey, playerStats);
                }
              }
            }
          }
        } catch (directLoadError) {
          console.warn('‚ö†Ô∏è Could not load stats directly:', directLoadError);
        }
      }
    }
    
    if (playerStats) {
      console.log('‚úÖ Player stats found:', playerStats);
      document.getElementById('statGames').textContent = playerStats.games || 0;
      document.getElementById('statAvg').textContent = (playerStats.battingAverage || 0).toFixed(3);
      document.getElementById('statHits').textContent = playerStats.hits || 0;
      document.getElementById('statRuns').textContent = playerStats.runs || 0;
	  // Display BPI if available
		if (playerStats.acesBPI !== undefined && playerStats.acesBPI !== null) {
		document.getElementById('statBPI').textContent = playerStats.acesBPI.toFixed(1);
		} else {
			document.getElementById('statBPI').textContent = '-';
  }
    } else {
      console.log('‚ö†Ô∏è No stats found for player:', userProfile.linkedPlayer);
      
      // Set defaults to show 0s instead of leaving blank
      document.getElementById('statGames').textContent = '0';
      document.getElementById('statAvg').textContent = '.000';
      document.getElementById('statHits').textContent = '0';
      document.getElementById('statRuns').textContent = '0';
    }
  } catch (error) {
    console.error('‚ùå Error loading user stats:', error);
    // Don't block page load for stats errors
    document.getElementById('statGames').textContent = '0';
    document.getElementById('statAvg').textContent = '.000';
    document.getElementById('statHits').textContent = '0';
    document.getElementById('statRuns').textContent = '0';
	document.getElementById('statBPI').textContent = '-';
  }
}

// ========================================
// ACES WRAPPED PROMO
// Show Wrapped promo card if player has 2025 stats
// ========================================

async function showWrappedPromoIfEligible() {
  console.log('üéâ Checking Aces Wrapped eligibility...');
  
  if (!userProfile || !userProfile.linkedPlayer) {
    console.log('‚ùå No linked player - hiding wrapped promo');
    document.getElementById('wrappedPromoCard').style.display = 'none';
    return;
  }
  
  try {
    // Use the current user's UID to fetch from aggregatedPlayerStats
    // (Data is stored by UID, not by player name)
    const userId = currentUser.uid;
    console.log('üìä Fetching player data for wrapped check...', userId);
    
    // Fetch player data from aggregatedPlayerStats using user ID
    const playerRef = doc(db, 'aggregatedPlayerStats', userId);
    const playerSnap = await getDoc(playerRef);
    
    if (!playerSnap.exists() || playerSnap.data().migrated) {
      console.log('‚ùå No player data found - hiding wrapped promo');
      document.getElementById('wrappedPromoCard').style.display = 'none';
      return;
    }
    
    const playerData = playerSnap.data();
    
    if (!playerData.seasons) {
      console.log('‚ùå No season data found - hiding wrapped promo');
      document.getElementById('wrappedPromoCard').style.display = 'none';
      return;
    }
    
    // Check if player has 2025 stats (Summer or Fall)
    const has2025Stats = Object.keys(playerData.seasons).some(seasonKey => 
      seasonKey.startsWith('2025-summer') || seasonKey.startsWith('2025-fall')
    );
    
    if (has2025Stats) {
      console.log('‚úÖ Player has 2025 stats - showing wrapped promo');
      document.getElementById('wrappedPromoCard').style.display = 'block';
      
      // Setup the button link - use user ID for wrapped page
      const wrappedBtn = document.getElementById('viewWrappedBtn');
      wrappedBtn.href = `aces-wrapped.html?id=${userId}`;
    } else {
      console.log('‚ùå No 2025 stats found - hiding wrapped promo');
      document.getElementById('wrappedPromoCard').style.display = 'none';
    }
  } catch (error) {
    console.error('‚ùå Error checking wrapped eligibility:', error);
    document.getElementById('wrappedPromoCard').style.display = 'none';
  }
}

// ========================================
// CAPTAIN TOOLS LOADER
// Add this function to your profile.html <script type="module"> section
// Place it after the loadUserStats function
// ========================================

async function loadCaptainTools() {
  console.log('üëë Checking captain/admin status...');
  
  // Check if user is captain, admin, or league staff
  const isCaptain = userProfile?.isCaptain === true || 
                    userProfile?.userRole === 'captain' ||
                    (userProfile?.teamRoles && Object.values(userProfile.teamRoles).some(
                      teamRole => teamRole.role === 'captain' && teamRole.status === 'active'
                    ));
  
  const isAdmin = userProfile?.userRole === 'admin';
  const isLeagueStaff = userProfile?.userRole === 'league-staff';
  
  const hasCaptainAccess = isCaptain || isAdmin || isLeagueStaff;
  
  console.log('üîç Captain access:', hasCaptainAccess, {
    isCaptain,
    isAdmin,
    isLeagueStaff,
    userRole: userProfile?.userRole
  });
  
  if (hasCaptainAccess) {
    // Show the Quick Links item
    const quickLinkItem = document.getElementById('linkApproveLinks');
    if (quickLinkItem) {
      quickLinkItem.style.display = 'flex';
    }
    const quickLinkItem2 = document.getElementById('linkManageTeam');
    if (quickLinkItem2) {
      quickLinkItem2.style.display = 'flex';
    }
	
	
    // Show the Captain Tools section
const captainSection = document.getElementById('captainToolsSection');
if (captainSection) {
  captainSection.style.display = 'block';
}

    // Show Admin Tools section (admin only)
    if (isAdmin) {
      const adminSection = document.getElementById('adminToolsSection');
      if (adminSection) {
        adminSection.style.display = 'block';
        console.log('üõ°Ô∏è Admin tools section displayed');
      }
    }
    
    // Load pending requests count
    try {
      const { getPendingPlayerLinkRequests } = await import('./firebase-auth.js');
      
      // Get team filter if captain (not admin/league staff)
      let teamFilter = null;
      if (isCaptain && !isAdmin && !isLeagueStaff) {
        teamFilter = userProfile?.linkedTeam;
      }
      
      const result = await getPendingPlayerLinkRequests(teamFilter);
      
      if (result.success) {
        const pendingCount = result.requests.length;
        console.log('üìä Pending link requests:', pendingCount);
        
        if (pendingCount > 0) {
          // Update Quick Links text
          const quickText = document.getElementById('pendingLinksQuickText');
          if (quickText) {
            quickText.innerHTML = `<span style="color: #f59e0b; font-weight: 600;">${pendingCount} pending ${pendingCount === 1 ? 'request' : 'requests'}</span>`;
          }
          
          // Update Captain Tools section text
          const captainText = document.getElementById('pendingLinksCaptainText');
          if (captainText) {
            captainText.innerHTML = `<span style="color: #f59e0b; font-weight: 600;">${pendingCount} pending ${pendingCount === 1 ? 'request' : 'requests'} ‚ö†Ô∏è</span>`;
          }
          
          // Update Admin Tools section text
          const adminText = document.getElementById('pendingLinksAdminText');
          if (adminText) {
            adminText.innerHTML = `<span style="color: #f59e0b; font-weight: 600;">${pendingCount} pending ${pendingCount === 1 ? 'request' : 'requests'} ‚ö†Ô∏è</span>`;
          }
          
          // Add a badge to the quick link
          if (quickLinkItem && !quickLinkItem.querySelector('.pending-badge')) {
            const badge = document.createElement('div');
            badge.className = 'pending-badge';
            badge.textContent = pendingCount;
            badge.style.cssText = `
              position: absolute;
              top: 0.5rem;
              right: 0.5rem;
              background: #f59e0b;
              color: white;
              width: 24px;
              height: 24px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 12px;
              font-weight: 700;
              box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            `;
            quickLinkItem.style.position = 'relative';
            quickLinkItem.appendChild(badge);
          }
        } else {
          // No pending requests
          const quickText = document.getElementById('pendingLinksQuickText');
          if (quickText) {
            quickText.textContent = 'No pending requests ‚úì';
          }
          
          const captainText = document.getElementById('pendingLinksCaptainText');
          if (captainText) {
            captainText.textContent = 'No pending requests ‚úì';
          }
          
          const adminText = document.getElementById('pendingLinksAdminText');
          if (adminText) {
            adminText.textContent = 'No pending requests ‚úì';
          }
        }
      }
    } catch (error) {
      console.error('‚ùå Error loading pending requests:', error);
      // Don't block the page, just show default text
    }
  } else {
    console.log('‚ÑπÔ∏è User does not have captain access');
    // Hide captain tools
    const quickLinkItem = document.getElementById('linkApproveLinks');
    if (quickLinkItem) {
      quickLinkItem.style.display = 'none';
    }
    const quickLinkItem2 = document.getElementById('linkManageTeam');
    if (quickLinkItem2) {
      quickLinkItem2.style.display = 'none';
    }
	
    const captainSection = document.getElementById('captainToolsSection');
    if (captainSection) {
      captainSection.style.display = 'none';
    }
    
    // Hide admin tools
    const adminSection = document.getElementById('adminToolsSection');
    if (adminSection) {
      adminSection.style.display = 'none';
    }
  }
}

    function updateStatsHeaderTitle(statsView, selectedSeason) {
      const headerElement = document.getElementById('statsHeaderTitle');
      
      if (statsView === 'career') {
        headerElement.textContent = 'Career Statistics';
      } else if (statsView === 'recent') {
        headerElement.textContent = 'Recent Games';
      } else {
        // Season view
        if (selectedSeason === 'current') {
          headerElement.textContent = 'Current Season Statistics';
        } else {
          // Format the season name nicely
          const seasonParts = selectedSeason.split('-');
          if (seasonParts.length === 2) {
            const year = seasonParts[0];
            const season = seasonParts[1].charAt(0).toUpperCase() + seasonParts[1].slice(1);
            headerElement.textContent = `${year} ${season} Statistics`;
          } else {
            headerElement.textContent = 'Season Statistics';
          }
        }
      }
    }

    function loadFavorites() {
      // Load favorite teams
      const favoriteTeams = userProfile?.favoriteTeams || [];
      const teamsGrid = document.getElementById('favoriteTeamsGrid');
      
      if (favoriteTeams.length === 0) {
        teamsGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üèÜ</div>
            <div class="empty-state-text">No favorite teams yet</div>
            <p>Click "Add Team" to start tracking your favorites</p>
          </div>
        `;
      } else {
        teamsGrid.innerHTML = favoriteTeams.map(team => `
          <div class="favorite-card">
            <button class="remove-favorite" data-type="team" data-name="${team}">‚úñ</button>
            <div class="favorite-card-header">
              <div class="favorite-icon">üèÜ</div>
              <div class="favorite-card-title">${team}</div>
            </div>
            <div class="favorite-stats">
              <a href="team.html?team=${encodeURIComponent(team)}">View team page ‚Üí</a>
            </div>
          </div>
        `).join('');
      }
      
      // Load favorite players
      const favoritePlayers = userProfile?.favoritePlayers || [];
      const playersGrid = document.getElementById('favoritePlayersGrid');
      
      if (favoritePlayers.length === 0) {
        playersGrid.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚≠ê</div>
            <div class="empty-state-text">No favorite players yet</div>
            <p>Click "Add Player" to start tracking up to 10 favorites</p>
          </div>
        `;
      } else {
        playersGrid.innerHTML = favoritePlayers.map(player => `
          <div class="favorite-card">
            <button class="remove-favorite" data-type="player" data-name="${player}">‚úñ</button>
            <div class="favorite-card-header">
              <div class="favorite-icon">‚≠ê</div>
              <div class="favorite-card-title">${player}</div>
            </div>
            <div class="favorite-stats">
              <a href="player.html?name=${encodeURIComponent(player)}">View player stats ‚Üí</a>
            </div>
          </div>
        `).join('');
      }
      
      // Add event listeners for remove buttons
      document.querySelectorAll('.remove-favorite').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const type = e.target.dataset.type;
          const name = e.target.dataset.name;
          removeFavorite(type, name);
        });
      });
    }

    // NEW: Handle display name form submission
    document.getElementById('displayNameForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const preferredDisplayName = document.getElementById('preferredDisplayName').value.trim();
      
      try {
        const updates = {
          preferredDisplayName: preferredDisplayName || null
        };
        
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // Update the local userProfile object
        userProfile.preferredDisplayName = preferredDisplayName || null;
        
        // Update the header display name immediately
        const displayName = preferredDisplayName || currentUser.displayName || 'User';
        document.getElementById('displayName').textContent = displayName;
        
        showSuccessMessage('successMessageDisplayName');
      } catch (error) {
        console.error('Error updating display name:', error);
        alert('Error saving display name. Please try again.');
      }
    });

    // NEW: Handle clear display name button
    document.getElementById('clearDisplayName').addEventListener('click', async () => {
      document.getElementById('preferredDisplayName').value = '';
      
      try {
        const updates = {
          preferredDisplayName: null
        };
        
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // Update the local userProfile object
        userProfile.preferredDisplayName = null;
        
        // Update the header display name immediately to Google name
        const displayName = currentUser.displayName || 'User';
        document.getElementById('displayName').textContent = displayName;
        
        showSuccessMessage('successMessageDisplayName');
      } catch (error) {
        console.error('Error clearing display name:', error);
        alert('Error clearing display name. Please try again.');
      }
    });

    // Form submissions
    document.getElementById('playerInfoForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const mapToCode = (fullWord, type) => {
        if (!fullWord) return '';
        if (type === 'bats') {
          if (fullWord === 'right') return 'R';
          if (fullWord === 'left') return 'L';
          if (fullWord === 'switch') return 'S';
        }
        if (type === 'throws') {
          if (fullWord === 'right') return 'R';
          if (fullWord === 'left') return 'L';
        }
        if (type === 'position') {
          const posMap = {
            'pitcher': 'P', 'catcher': 'C', '1b': '1B', '2b': '2B',
            '3b': '3B', 'ss': 'SS', 'if': 'IF', 'lf': 'LF',
            'cf': 'CF', 'rf': 'RF', 'of': 'OF', 'utility': 'UTL'
          };
          return posMap[fullWord] || fullWord.toUpperCase();
        }
        return fullWord;
      };

      const updates = {
        nickname: document.getElementById('nickname').value,
        number: document.getElementById('jerseyNumber').value,
        bats: mapToCode(document.getElementById('battingSide').value, 'bats'),
        throws: mapToCode(document.getElementById('throwingArm').value, 'throws'),
        position: mapToCode(document.getElementById('primaryPosition').value, 'position'),
        secondaryPositions: document.getElementById('secondaryPositions').value
      };
      
      try {
        // Update the auth user profile
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        if (!result.success) {
          throw new Error('Update failed');
        }
        
        // ALSO update the merged player profile if it exists
        if (userProfile?.mergedFromProfile) {
          console.log('üîÑ Also updating merged profile:', userProfile.mergedFromProfile);
          
          try {
            const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const { db } = await import('./firebase-data.js');
            
            const playerRef = doc(db, 'users', userProfile.mergedFromProfile);
            await updateDoc(playerRef, {
              ...updates,
              updatedAt: serverTimestamp()
            });
            
            console.log('‚úÖ Merged profile updated successfully');
          } catch (mergeError) {
            console.warn('‚ö†Ô∏è Could not update merged profile:', mergeError);
            // Don't fail the whole operation if merged profile update fails
          }
        }
        
        showSuccessMessage('successMessagePlayerInfo');
      } catch (error) {
        console.error('Error updating profile:', error);
        alert('Error saving changes. Please try again.');
      }
    });

    // Handle stats view preference changes
    document.getElementById('defaultStatsView').addEventListener('change', async (e) => {
      const statsView = e.target.value;
      
      try {
        // Save preference
        const result = await updateUserProfileAuth(currentUser.uid, { 
          preferences: { 
            ...userProfile.preferences,
            defaultStatsView: statsView 
          }
        });
        
        if (result.success) {
          userProfile.preferences = userProfile.preferences || {};
          userProfile.preferences.defaultStatsView = statsView;
          
          // Reload stats with new view
          await loadUserStats(currentUser);
          showSuccessMessage('successMessagePreferences');
        }
      } catch (error) {
        console.error('Error updating stats view:', error);
      }
    });

    // Handle default season preference changes
    document.getElementById('defaultSeason').addEventListener('change', async (e) => {
      const selectedSeason = e.target.value;
      
      try {
        // Save preference
        const result = await updateUserProfileAuth(currentUser.uid, { 
          preferences: { 
            ...userProfile.preferences,
            defaultSeason: selectedSeason 
          }
        });
        
        if (result.success) {
          userProfile.preferences = userProfile.preferences || {};
          userProfile.preferences.defaultSeason = selectedSeason;
          
          // Reload stats with new season
          await loadUserStats(currentUser);
          showSuccessMessage('successMessagePreferences');
        }
      } catch (error) {
        console.error('Error updating default season:', error);
      }
    });

    // Handle Display Preferences form submission (prevent reload - fields auto-save on change)
    document.getElementById('displayPreferencesForm').addEventListener('submit', (e) => {
      e.preventDefault();
      // Fields already auto-save on change, so just show success message
      showSuccessMessage('successMessagePreferences');
    });

    // Handle Privacy Settings form submission
    document.getElementById('privacySettingsForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const publicFavorites = document.getElementById('publicFavorites').checked;
      
      try {
        const result = await updateUserProfileAuth(currentUser.uid, { 
          preferences: { 
            ...userProfile.preferences,
            publicFavorites: publicFavorites 
          }
        });
        
        if (result.success) {
          userProfile.preferences = userProfile.preferences || {};
          userProfile.preferences.publicFavorites = publicFavorites;
          showSuccessMessage('successMessagePreferences');
        }
      } catch (error) {
        console.error('Error updating privacy settings:', error);
        alert('Error saving privacy settings. Please try again.');
      }
    });

    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        const result = await logoutUser();
        if (result.success) {
          window.location.href = 'index.html';
        }
      } catch (error) {
        console.error('Error signing out:', error);
      }
    });

    // Directory opt-in toggle
    document.getElementById('directoryOptIn').addEventListener('change', (e) => {
      const directoryFields = document.getElementById('directoryFields');
      if (e.target.checked) {
        directoryFields.style.display = 'block';
      } else {
        directoryFields.style.display = 'none';
      }
    });

    // Save directory settings
    document.getElementById('saveDirectoryBtn').addEventListener('click', async () => {
      if (!currentUser) return;
      
      const optIn = document.getElementById('directoryOptIn').checked;
      const phone = document.getElementById('directoryPhone').value.trim();
      const occupation = document.getElementById('directoryOccupation').value.trim();
      const skills = document.getElementById('directorySkills').value.trim();
      
      try {
        const updates = {
          directoryOptIn: optIn,
          directoryPhone: optIn ? phone : '',
          directoryOccupation: optIn ? occupation : '',
          directorySkills: optIn ? skills : ''
        };
        
        const result = await updateUserProfileAuth(currentUser.uid, updates);
        
        if (result.success) {
          console.log('‚úÖ Directory settings saved');
          showSuccessMessage('successMessageDirectory');
          // Update local profile
          Object.assign(userProfile, updates);
        } else {
          throw new Error('Failed to save directory settings');
        }
      } catch (error) {
        console.error('‚ùå Error saving directory settings:', error);
        alert('Error saving directory settings. Please try again.');
      }
    });


    // Add favorite buttons
    document.getElementById('addFavoriteTeam').addEventListener('click', async () => {
      await openTeamModal();
    });

    document.getElementById('addFavoritePlayer').addEventListener('click', async () => {
      const favoritePlayers = userProfile?.favoritePlayers || [];
      if (favoritePlayers.length >= 10) {
        alert('You can only have up to 10 favorite players. Remove some to add more.');
        return;
      }
      await openPlayerModal();
    });

    async function removeFavorite(type, name) {
      if (!confirm(`Remove ${name} from favorites?`)) return;
      
      try {
        const field = type === 'team' ? 'favoriteTeams' : 'favoritePlayers';
        const current = userProfile[field] || [];
        const updated = current.filter(item => item !== name);
        
        const result = await updateUserProfileAuth(currentUser.uid, { [field]: updated });
        if (result.success) {
          userProfile[field] = updated;
          loadFavorites();
        } else {
          throw new Error('Update failed');
        }
      } catch (error) {
        console.error('Error removing favorite:', error);
        alert('Error removing favorite. Please try again.');
      }
    }

    function showSuccessMessage(id) {
      const msg = document.getElementById(id);
      msg.classList.add('show');
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').classList.add('hidden');
    }

    // ========================================
    // PROFILE PHOTO UPLOAD
    // ========================================
    
    // Setup profile photo upload handler
    const uploadPhotoBtn = document.getElementById('uploadPhotoBtn');
    const profilePhotoInput = document.getElementById('profilePhotoInput');
    
    if (uploadPhotoBtn && profilePhotoInput) {
      uploadPhotoBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profilePhotoInput.click();
      });
      
      profilePhotoInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('üì∏ Profile photo selected:', file.name);
        
        // Validate file
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
          alert('Profile photo must be less than 5MB');
          return;
        }
        
        // Show loading state
        uploadPhotoBtn.disabled = true;
        uploadPhotoBtn.textContent = '‚è≥';
        uploadPhotoBtn.style.cursor = 'wait';
        
        try {
          const user = auth.currentUser;
          if (!user) {
            throw new Error('Not authenticated');
          }
          
          console.log('üì§ Uploading profile photo...');
          
          // Upload the photo
          const result = await uploadProfilePhoto(file, user.uid, (progress) => {
            console.log(`Upload progress: ${progress.toFixed(1)}%`);
          });
          
          console.log('‚úÖ Profile photo uploaded:', result.downloadURL);
          
          // Delete old profile photo if exists
          if (userProfile?.profilePhotoStoragePath) {
            try {
              await deleteOldProfilePhoto(userProfile.profilePhotoStoragePath);
            } catch (error) {
              console.warn('Could not delete old photo:', error);
            }
          }
          
          // Update user profile in Firestore
          const userDocRef = doc(db, 'users', user.uid);
          await updateDoc(userDocRef, {
            profilePhotoURL: result.downloadURL,
            profilePhotoStoragePath: result.storagePath,
            profilePhotoUpdatedAt: new Date()
          });
          
          console.log('‚úÖ Profile updated in Firestore');
          
          // Update the displayed photo
          document.getElementById('profilePhoto').src = result.downloadURL;
          
          // Update local profile object
          if (userProfile) {
            userProfile.profilePhotoURL = result.downloadURL;
            userProfile.profilePhotoStoragePath = result.storagePath;
          }
          
          // Update photo source display in settings tab
          updatePhotoSourceDisplay();
          
          // Show success feedback
          uploadPhotoBtn.textContent = '‚úÖ';
          setTimeout(() => {
            uploadPhotoBtn.textContent = 'üì∑';
            uploadPhotoBtn.disabled = false;
            uploadPhotoBtn.style.cursor = 'pointer';
          }, 2000);
          
          alert('Profile photo updated successfully!');
          
        } catch (error) {
          console.error('‚ùå Error uploading profile photo:', error);
          alert('Failed to upload profile photo: ' + error.message);
          uploadPhotoBtn.textContent = 'üì∑';
          uploadPhotoBtn.disabled = false;
          uploadPhotoBtn.style.cursor = 'pointer';
        }
        
        // Reset file input
        profilePhotoInput.value = '';
      });
    }

    // ========================================
    // PHOTO SOURCE SWITCHING (Settings Tab)
    // ========================================
    
    // Setup handlers for photo source switching in Settings tab
    const uploadCustomPhotoBtn = document.getElementById('uploadCustomPhotoBtn');
    const useGooglePhotoBtn = document.getElementById('useGooglePhotoBtn');
    const customPhotoInput = document.getElementById('customPhotoInput');
    
    if (uploadCustomPhotoBtn && customPhotoInput) {
      uploadCustomPhotoBtn.addEventListener('click', () => {
        customPhotoInput.click();
      });
      
      customPhotoInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        console.log('üì∏ Custom photo selected for settings upload:', file.name);
        
        // Validate file
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }
        
        if (file.size > 5 * 1024 * 1024) {
          alert('Profile photo must be less than 5MB');
          return;
        }
        
        // Show loading state
        uploadCustomPhotoBtn.disabled = true;
        uploadCustomPhotoBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Uploading...';
        
        try {
          const user = auth.currentUser;
          if (!user) {
            throw new Error('Not authenticated');
          }
          
          console.log('üì§ Uploading custom profile photo...');
          
          // Upload the photo
          const result = await uploadProfilePhoto(file, user.uid, (progress) => {
            console.log(`Upload progress: ${progress.toFixed(1)}%`);
          });
          
          console.log('‚úÖ Custom profile photo uploaded:', result.downloadURL);
          
          // Delete old profile photo if exists
          if (userProfile?.profilePhotoStoragePath) {
            try {
              await deleteOldProfilePhoto(userProfile.profilePhotoStoragePath);
            } catch (error) {
              console.warn('Could not delete old photo:', error);
            }
          }
          
          // Update user profile in Firestore
          const userDocRef = doc(db, 'users', user.uid);
          await updateDoc(userDocRef, {
            profilePhotoURL: result.downloadURL,
            profilePhotoStoragePath: result.storagePath,
            profilePhotoUpdatedAt: new Date()
          });
          
          console.log('‚úÖ Profile updated in Firestore');
          
          // Update the displayed photos (header and settings preview)
          document.getElementById('profilePhoto').src = result.downloadURL;
          document.getElementById('currentPhotoPreview').src = result.downloadURL;
          
          // Update local profile object
          if (userProfile) {
            userProfile.profilePhotoURL = result.downloadURL;
            userProfile.profilePhotoStoragePath = result.storagePath;
          }
          
          // Update photo source display
          updatePhotoSourceDisplay();
          
          // Show success
          showSuccessMessage('successMessagePhoto');
          uploadCustomPhotoBtn.disabled = false;
          uploadCustomPhotoBtn.innerHTML = 'üì§ Upload Custom Photo';
          
        } catch (error) {
          console.error('‚ùå Error uploading custom photo:', error);
          alert('Failed to upload profile photo: ' + error.message);
          uploadCustomPhotoBtn.disabled = false;
          uploadCustomPhotoBtn.innerHTML = 'üì§ Upload Custom Photo';
        }
        
        // Reset file input
        customPhotoInput.value = '';
      });
    }
    
    if (useGooglePhotoBtn) {
      useGooglePhotoBtn.addEventListener('click', async () => {
        const user = auth.currentUser;
        if (!user) return;
        
        // Check if user actually has a Google photo
        if (!user.photoURL) {
          alert('No Google photo available for your account.');
          return;
        }
        
        if (!confirm('Switch to using your Google account photo? Your custom photo will remain saved and you can switch back anytime.')) {
          return;
        }
        
        // Show loading state
        useGooglePhotoBtn.disabled = true;
        useGooglePhotoBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Switching...';
        
        try {
          console.log('üîÑ Switching to Google photo...');
          
          // Delete custom profile photo from storage if exists
          if (userProfile?.profilePhotoStoragePath) {
            try {
              await deleteOldProfilePhoto(userProfile.profilePhotoStoragePath);
              console.log('‚úÖ Custom photo deleted from storage');
            } catch (error) {
              console.warn('Could not delete custom photo:', error);
            }
          }
          
          // Clear custom photo fields in Firestore (will fallback to Google photo)
          const userDocRef = doc(db, 'users', user.uid);
          await updateDoc(userDocRef, {
            profilePhotoURL: null,
            profilePhotoStoragePath: null,
            profilePhotoUpdatedAt: new Date()
          });
          
          console.log('‚úÖ Switched to Google photo');
          
          // Update the displayed photos (header and settings preview)
          document.getElementById('profilePhoto').src = user.photoURL;
          document.getElementById('currentPhotoPreview').src = user.photoURL;
          
          // Update local profile object
          if (userProfile) {
            userProfile.profilePhotoURL = null;
            userProfile.profilePhotoStoragePath = null;
          }
          
          // Update photo source display
          updatePhotoSourceDisplay();
          
          // Show success
          showSuccessMessage('successMessagePhoto');
          useGooglePhotoBtn.disabled = false;
          useGooglePhotoBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Use Google Photo';
          
        } catch (error) {
          console.error('‚ùå Error switching to Google photo:', error);
          alert('Failed to switch photo source: ' + error.message);
          useGooglePhotoBtn.disabled = false;
          useGooglePhotoBtn.innerHTML = '<svg viewBox="0 0 24 24" style="width: 20px; height: 20px; display: inline-block; margin-right: 8px;"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Use Google Photo';
        }
      });
    }
    
    // Function to update photo source display in settings
    function updatePhotoSourceDisplay() {
      const user = auth.currentUser;
      if (!user) return;
      
      const currentPhotoSourceEl = document.getElementById('currentPhotoSource');
      const currentPhotoPreview = document.getElementById('currentPhotoPreview');
      const useGooglePhotoBtnEl = document.getElementById('useGooglePhotoBtn');
      const googlePhotoInfo = document.getElementById('googlePhotoInfo');
      
      // Determine which photo is being used
      if (userProfile?.profilePhotoURL) {
        // Using custom uploaded photo
        currentPhotoSourceEl.innerHTML = 'üì§ Custom Uploaded Photo';
        currentPhotoPreview.src = userProfile.profilePhotoURL;
        
        // Show Google button if Google photo is available
        if (user.photoURL && useGooglePhotoBtnEl) {
          useGooglePhotoBtnEl.style.display = 'block';
        }
      } else if (user.photoURL) {
        // Using Google photo
        currentPhotoSourceEl.innerHTML = '<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; display: inline-block; margin-right: 4px; vertical-align: text-bottom;"><path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="currentColor" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="currentColor" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>Google Account Photo';
        currentPhotoPreview.src = user.photoURL;
        
        // Hide Google button since already using it
        if (useGooglePhotoBtnEl) {
          useGooglePhotoBtnEl.style.display = 'none';
        }
        
        // Show Google photo info
        if (googlePhotoInfo) {
          googlePhotoInfo.style.display = 'block';
        }
      } else {
        // No photo (using placeholder)
        currentPhotoSourceEl.textContent = 'üë§ Default Placeholder';
        const displayName = userProfile?.preferredDisplayName || user.displayName || 'User';
        currentPhotoPreview.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="80" height="80"%3E%3Crect fill="%232d5016" width="80" height="80"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="white" font-size="32" font-family="Arial"%3E' + (displayName.charAt(0).toUpperCase()) + '%3C/text%3E%3C/svg%3E';
        
        // Hide Google button
        if (useGooglePhotoBtnEl) {
          useGooglePhotoBtnEl.style.display = 'none';
        }
      }
      
      // Show/hide Google photo info based on account type
      const isGoogleUser = user.providerData?.some(p => p.providerId === 'google.com');
      if (googlePhotoInfo) {
        googlePhotoInfo.style.display = isGoogleUser ? 'block' : 'none';
      }
    }

    // ========================================
    // TEAM SELECTION MODAL
    // ========================================

    async function openTeamModal() {
      console.log('üìã Opening team modal...');
      
      // Load teams if not already loaded
      if (allTeams.length === 0) {
        try {
          allTeams = await getAllTeams();
          console.log(`‚úÖ Loaded ${allTeams.length} teams`);
        } catch (error) {
          console.error('‚ùå Error loading teams:', error);
          alert('Error loading teams. Please try again.');
          return;
        }
      }

      // Render team list
      renderTeamList(allTeams);
      
      // Show modal
      document.getElementById('teamModal').classList.add('show');
      
      // Setup search
      const searchInput = document.getElementById('teamSearch');
      searchInput.value = '';
      searchInput.addEventListener('input', handleTeamSearch);
    }

    function renderTeamList(teams) {
      const list = document.getElementById('teamList');
      list.innerHTML = '';

      const favoriteTeams = userProfile?.favoriteTeams || [];
      
      // Sort teams alphabetically
      const sortedTeams = [...teams].sort((a, b) => 
        (a.name || a.id).localeCompare(b.name || b.id)
      );

      sortedTeams.forEach(team => {
        const teamName = team.name || team.id;
        const isAlreadyFavorite = favoriteTeams.includes(teamName);
        
        const item = document.createElement('div');
        item.className = 'selection-item';
        if (isAlreadyFavorite) {
          item.classList.add('disabled');
        }
        
        item.innerHTML = `
          <div class="selection-item-info">
            <div class="selection-item-name">${teamName}</div>
            <div class="selection-item-details">${team.description || 'Team'}</div>
          </div>
          ${isAlreadyFavorite ? '<span class="selection-item-badge">Already Added</span>' : ''}
        `;
        
        if (!isAlreadyFavorite) {
          item.addEventListener('click', () => selectTeam(item, teamName));
        }
        
        list.appendChild(item);
      });
    }

    function selectTeam(element, teamName) {
      // Remove previous selection
      document.querySelectorAll('#teamList .selection-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select this one
      element.classList.add('selected');
      selectedTeam = teamName;
      
      // Enable confirm button
      document.getElementById('confirmTeamBtn').disabled = false;
      
      console.log('Selected team:', teamName);
    }

    function handleTeamSearch(e) {
      const term = e.target.value.toLowerCase();
      
      document.querySelectorAll('#teamList .selection-item').forEach(item => {
        const name = item.querySelector('.selection-item-name').textContent.toLowerCase();
        if (name.includes(term)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    async function confirmAddTeam() {
      if (!selectedTeam || !currentUser) return;
      
      const confirmBtn = document.getElementById('confirmTeamBtn');
      const btnText = confirmBtn.querySelector('span');
      confirmBtn.disabled = true;
      btnText.textContent = 'Adding...';
      
      try {
        console.log('Adding team to favorites:', selectedTeam);
        
        const result = await addFavoriteTeam(currentUser.uid, selectedTeam);
        
        if (result.success) {
          console.log('‚úÖ Team added successfully!');
          // Update local profile
          if (!userProfile.favoriteTeams) userProfile.favoriteTeams = [];
          userProfile.favoriteTeams.push(selectedTeam);
          // Reload favorites display
          loadFavorites();
          // Close modal
          closeTeamModal();
        } else {
          throw new Error('Failed to add team');
        }
        
      } catch (error) {
        console.error('Error adding team:', error);
        alert('Error adding team. Please try again.');
        confirmBtn.disabled = false;
        btnText.textContent = 'Add Team';
      }
    }

    function closeTeamModal() {
      document.getElementById('teamModal').classList.remove('show');
      selectedTeam = null;
      document.getElementById('confirmTeamBtn').disabled = true;
    }

    // ========================================
    // PLAYER SELECTION MODAL
    // ========================================

    async function openPlayerModal() {
      console.log('üìã Opening player modal...');
      
      // Load players if not already loaded
      if (allPlayers.length === 0) {
        try {
          allPlayers = await getAllPlayerStatsOptimized();
          console.log(`‚úÖ Loaded ${allPlayers.length} players`);
        } catch (error) {
          console.error('‚ùå Error loading players:', error);
          alert('Error loading players. Please try again.');
          return;
        }
      }

      // Render player list
      renderPlayerList(allPlayers);
      
      // Show modal
      document.getElementById('playerModal').classList.add('show');
      
      // Setup search
      const searchInput = document.getElementById('playerSearch');
      searchInput.value = '';
      searchInput.addEventListener('input', handlePlayerSearch);
    }

    function renderPlayerList(players) {
      const list = document.getElementById('playerList');
      list.innerHTML = '';

      const favoritePlayers = userProfile?.favoritePlayers || [];
      
      // Sort players alphabetically
      const sortedPlayers = [...players].sort((a, b) => 
        (a.name || a.playerName || a.id).localeCompare(b.name || b.playerName || b.id)
      );

      sortedPlayers.forEach(player => {
        const playerName = player.name || player.playerName || player.id;
        const isAlreadyFavorite = favoritePlayers.includes(playerName);
        
        const careerGames = player.career?.games || 0;
        const careerBA = player.career?.battingAverage 
          ? player.career.battingAverage.toFixed(3) 
          : '0.000';
        const team = player.currentTeam || 'Unknown';
        
        const item = document.createElement('div');
        item.className = 'selection-item';
        if (isAlreadyFavorite) {
          item.classList.add('disabled');
        }
        
        item.innerHTML = `
          <div class="selection-item-info">
            <div class="selection-item-name">${playerName}</div>
            <div class="selection-item-details">${team} ‚Ä¢ ${careerGames} games ‚Ä¢ BA: ${careerBA}</div>
          </div>
          ${isAlreadyFavorite ? '<span class="selection-item-badge">Already Added</span>' : ''}
        `;
        
        if (!isAlreadyFavorite) {
          item.addEventListener('click', () => selectPlayer(item, playerName));
        }
        
        list.appendChild(item);
      });
    }
document.getElementById('enable-notifications-btn')?.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    await requestNotificationPermission(user.uid);
    await loadNotificationPreferences(); // Refresh UI
    showSuccessMessage('successMessagePreferences');
  } catch (error) {
    console.error('Error enabling notifications:', error);
    alert('Failed to enable notifications. Please try again.');
  }
});

// Save notification preferences button
document.getElementById('save-preferences-btn')?.addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return;
  
  const preferences = {
    gameReminders: document.getElementById('pref-game-reminders').checked,
    rsvpReminders: document.getElementById('pref-rsvp-reminders').checked,
    scheduleChanges: document.getElementById('pref-schedule-changes').checked,
    lineupChanges: document.getElementById('pref-lineup-changes').checked,
    announcements: document.getElementById('pref-announcements').checked,
    scoreUpdates: document.getElementById('pref-score-updates').checked,
    finalScoreOnly: document.getElementById('pref-final-score-only').checked,
    milestones: document.getElementById('pref-milestones').checked,
    quietHours: {
      enabled: document.getElementById('pref-quiet-hours').checked,
      start: document.getElementById('quiet-start').value,
      end: document.getElementById('quiet-end').value
    }
  };
  
  try {
    await updateNotificationPreferences(user.uid, preferences);
    showSuccessMessage('successMessagePreferences');
  } catch (error) {
    console.error('Error saving notification preferences:', error);
    alert('Failed to save preferences. Please try again.');
  }
});

// Disable all notifications button
document.getElementById('disable-notifications-btn')?.addEventListener('click', async () => {
  if (!confirm('Are you sure you want to disable all push notifications? You can re-enable them later.')) {
    return;
  }
  
  const user = auth.currentUser;
  if (!user) return;
  
  try {
    const userDoc = await getDoc(doc(db, 'users', user.uid));
    const tokens = userDoc.data()?.fcmTokens || [];
    
    for (const token of tokens) {
      await removeFCMToken(user.uid, token);
    }
    
    await loadNotificationPreferences(); // Refresh UI
    showSuccessMessage('successMessagePreferences');
  } catch (error) {
    console.error('Error disabling notifications:', error);
    alert('Failed to disable notifications. Please try again.');
  }
});

// IMPORTANT: Call loadNotificationPreferences() when the page loads
// Add this inside your existing onAuthChange or page load function:
// await loadNotificationPreferences();



    function selectPlayer(element, playerName) {
      // Remove previous selection
      document.querySelectorAll('#playerList .selection-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select this one
      element.classList.add('selected');
      selectedPlayer = playerName;
      
      // Enable confirm button
      document.getElementById('confirmPlayerBtn').disabled = false;
      
      console.log('Selected player:', playerName);
    }

    function handlePlayerSearch(e) {
      const term = e.target.value.toLowerCase();
      
      document.querySelectorAll('#playerList .selection-item').forEach(item => {
        const name = item.querySelector('.selection-item-name').textContent.toLowerCase();
        const details = item.querySelector('.selection-item-details').textContent.toLowerCase();
        if (name.includes(term) || details.includes(term)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }

    async function confirmAddPlayer() {
      if (!selectedPlayer || !currentUser) return;
      
      const confirmBtn = document.getElementById('confirmPlayerBtn');
      const btnText = confirmBtn.querySelector('span');
      confirmBtn.disabled = true;
      btnText.textContent = 'Adding...';
      
      try {
        console.log('Adding player to favorites:', selectedPlayer);
        
        const result = await addFavoritePlayer(currentUser.uid, selectedPlayer);
        
        if (result.success) {
          console.log('‚úÖ Player added successfully!');
          // Update local profile
          if (!userProfile.favoritePlayers) userProfile.favoritePlayers = [];
          userProfile.favoritePlayers.push(selectedPlayer);
          // Reload favorites display
          loadFavorites();
          // Close modal
          closePlayerModal();
        } else {
          throw new Error('Failed to add player');
        }
        
      } catch (error) {
        console.error('Error adding player:', error);
        alert('Error adding player. Please try again.');
        confirmBtn.disabled = false;
        btnText.textContent = 'Add Player';
      }
    }

    function closePlayerModal() {
      document.getElementById('playerModal').classList.remove('show');
      selectedPlayer = null;
      document.getElementById('confirmPlayerBtn').disabled = true;
    }

    // Make functions available globally for onclick handlers
    window.closeTeamModal = closeTeamModal;
    window.confirmAddTeam = confirmAddTeam;
    window.closePlayerModal = closePlayerModal;
    window.confirmAddPlayer = confirmAddPlayer;

    // ========================================
    // GAMES TAB STATS (Firebase)
    // ========================================
    async function loadGamesStats() {
      console.log('üéÆ Loading games stats from Firebase...');
      
      if (!currentUser) {
        console.log('‚ö†Ô∏è No user logged in, cannot load games stats');
        return;
      }
      
      const userId = currentUser.uid;
      let totalPlayed = 0;
      let totalPerfects = 0;
      let longestStreak = 0;
      let playedToday = 0;
      
      const todayDayNum = getDayNumber();
      
      // Initialize stats object for badge calculation
      const allStats = {
        grid: { gamesPlayed: 0, perfectGames: 0, longestStreak: 0 },
        connections: { gamesPlayed: 0, perfectGames: 0, longestStreak: 0 },
        wordle: { gamesPlayed: 0, wins: 0, maxStreak: 0 },
        higherLower: { gamesPlayed: 0, perfectGames: 0, longestStreak: 0 },
        whoAmI: { gamesPlayed: 0, wins: 0, maxStreak: 0, hasLuckyGuess: false },
        recall: { gamesPlayed: 0, perfectGames: 0, bestScore: 0, hasSpeedDemon: false },
        dailySweep: false,
        weekWarrior: false,
        earlyBird: false,
        nightOwl: false
      };
      
      try {
        // Aces Grid Stats
        const gridRef = doc(db, 'acesGridGames', userId);
        const gridDoc = await getDoc(gridRef);
        if (gridDoc.exists()) {
          const gridStats = gridDoc.data();
          document.getElementById('gridPlayed').textContent = gridStats.gamesPlayed || 0;
          document.getElementById('gridPerfect').textContent = gridStats.perfectGames || 0;
          document.getElementById('gridStreak').textContent = gridStats.currentStreak || 0;
          totalPlayed += gridStats.gamesPlayed || 0;
          totalPerfects += gridStats.perfectGames || 0;
          longestStreak = Math.max(longestStreak, gridStats.longestStreak || 0);
          if (gridStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.grid = {
            gamesPlayed: gridStats.gamesPlayed || 0,
            perfectGames: gridStats.perfectGames || 0,
            longestStreak: gridStats.longestStreak || 0
          };
        }
      } catch (e) { console.log('Could not load grid stats:', e); }
      
      try {
        // Aces Connections Stats
        const connectionsRef = doc(db, 'acesConnectionsGames', userId);
        const connectionsDoc = await getDoc(connectionsRef);
        if (connectionsDoc.exists()) {
          const connectionsStats = connectionsDoc.data();
          document.getElementById('connectionsPlayed').textContent = connectionsStats.gamesPlayed || 0;
          document.getElementById('connectionsWins').textContent = connectionsStats.perfectGames || 0;
          document.getElementById('connectionsStreak').textContent = connectionsStats.currentStreak || 0;
          totalPlayed += connectionsStats.gamesPlayed || 0;
          totalPerfects += connectionsStats.perfectGames || 0;
          longestStreak = Math.max(longestStreak, connectionsStats.longestStreak || 0);
          if (connectionsStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.connections = {
            gamesPlayed: connectionsStats.gamesPlayed || 0,
            perfectGames: connectionsStats.perfectGames || 0,
            longestStreak: connectionsStats.longestStreak || 0
          };
        }
      } catch (e) { console.log('Could not load connections stats:', e); }
      
      try {
        // Aces Wordle Stats
        const wordleRef = doc(db, 'acesWordleGames', userId);
        const wordleDoc = await getDoc(wordleRef);
        if (wordleDoc.exists()) {
          const wordleStats = wordleDoc.data();
          document.getElementById('wordlePlayed').textContent = wordleStats.gamesPlayed || 0;
          const winPct = wordleStats.gamesPlayed > 0 
            ? Math.round((wordleStats.wins / wordleStats.gamesPlayed) * 100) 
            : 0;
          document.getElementById('wordleWinPct').textContent = winPct + '%';
          document.getElementById('wordleStreak').textContent = wordleStats.currentStreak || 0;
          totalPlayed += wordleStats.gamesPlayed || 0;
          longestStreak = Math.max(longestStreak, wordleStats.maxStreak || 0);
          if (wordleStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.wordle = {
            gamesPlayed: wordleStats.gamesPlayed || 0,
            wins: wordleStats.wins || 0,
            maxStreak: wordleStats.maxStreak || 0
          };
        }
      } catch (e) { console.log('Could not load wordle stats:', e); }
      
      try {
        // Higher or Lower Stats
        const hlRef = doc(db, 'acesHigherLowerGames', userId);
        const hlDoc = await getDoc(hlRef);
        if (hlDoc.exists()) {
          const hlStats = hlDoc.data();
          document.getElementById('higherLowerPlayed').textContent = hlStats.gamesPlayed || 0;
          document.getElementById('higherLowerBest').textContent = hlStats.perfectGames || 0;
          const avgScore = hlStats.gamesPlayed > 0 
            ? (hlStats.totalCorrect / hlStats.gamesPlayed).toFixed(1) 
            : 0;
          document.getElementById('higherLowerAvg').textContent = avgScore;
          totalPlayed += hlStats.gamesPlayed || 0;
          totalPerfects += hlStats.perfectGames || 0;
          longestStreak = Math.max(longestStreak, hlStats.longestStreak || 0);
          if (hlStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.higherLower = {
            gamesPlayed: hlStats.gamesPlayed || 0,
            perfectGames: hlStats.perfectGames || 0,
            longestStreak: hlStats.longestStreak || 0
          };
        }
      } catch (e) { console.log('Could not load higher-lower stats:', e); }
      
      try {
        // Who Am I Stats
        const whoAmIRef = doc(db, 'acesWhoAmIGames', userId);
        const whoAmIDoc = await getDoc(whoAmIRef);
        if (whoAmIDoc.exists()) {
          const whoAmIStats = whoAmIDoc.data();
          document.getElementById('whoAmIPlayed').textContent = whoAmIStats.gamesPlayed || 0;
          document.getElementById('whoAmIWins').textContent = whoAmIStats.wins || 0;
          const avgWhoAmI = whoAmIStats.gamesPlayed > 0 
            ? (whoAmIStats.totalScore / whoAmIStats.gamesPlayed).toFixed(1) 
            : 0;
          document.getElementById('whoAmIAvgScore').textContent = avgWhoAmI;
          totalPlayed += whoAmIStats.gamesPlayed || 0;
          longestStreak = Math.max(longestStreak, whoAmIStats.maxStreak || 0);
          if (whoAmIStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.whoAmI = {
            gamesPlayed: whoAmIStats.gamesPlayed || 0,
            wins: whoAmIStats.wins || 0,
            maxStreak: whoAmIStats.maxStreak || 0,
            hasLuckyGuess: whoAmIStats.hasLuckyGuess || false
          };
        }
      } catch (e) { console.log('Could not load who-am-i stats:', e); }
      
      try {
        // Player Recall Stats
        const recallRef = doc(db, 'acesRosterRecallGames', userId);
        const recallDoc = await getDoc(recallRef);
        if (recallDoc.exists()) {
          const recallStats = recallDoc.data();
          document.getElementById('recallPlayed').textContent = recallStats.gamesPlayed || 0;
          document.getElementById('recallPerfect').textContent = recallStats.perfectGames || 0;
          document.getElementById('recallBest').textContent = recallStats.bestScore || 0;
          totalPlayed += recallStats.gamesPlayed || 0;
          totalPerfects += recallStats.perfectGames || 0;
          if (recallStats.lastPlayedPuzzle === todayDayNum) playedToday++;
          // Store for badges
          allStats.recall = {
            gamesPlayed: recallStats.gamesPlayed || 0,
            perfectGames: recallStats.perfectGames || 0,
            bestScore: recallStats.bestScore || 0,
            hasSpeedDemon: recallStats.hasSpeedDemon || false
          };
        }
      } catch (e) { console.log('Could not load recall stats:', e); }
      
      // Update summary
      document.getElementById('totalGamesPlayed').textContent = totalPlayed;
      document.getElementById('totalPerfects').textContent = totalPerfects;
      document.getElementById('longestStreak').textContent = longestStreak;
      document.getElementById('gamesPlayedToday').textContent = playedToday;
      
      // Check for daily sweep (all 6 games played today)
      if (playedToday === 6) {
        allStats.dailySweep = true;
      }
      
      // Calculate and render badges
      renderBadges(allStats);
      
      console.log('‚úÖ Games stats loaded from Firebase');
    }
    
    // ========================================
    // BADGE SYSTEM
    // ========================================
    const BADGES = [
      // General badges
      { id: 'first-timer', name: 'First Timer', icon: 'üåü', description: 'Play your first game', category: 'general',
        check: (s) => (s.grid.gamesPlayed + s.connections.gamesPlayed + s.wordle.gamesPlayed + s.higherLower.gamesPlayed + s.whoAmI.gamesPlayed + s.recall.gamesPlayed) >= 1 },
      { id: 'dedicated', name: 'Dedicated', icon: 'üéØ', description: 'Play 25 total games', category: 'general',
        check: (s) => (s.grid.gamesPlayed + s.connections.gamesPlayed + s.wordle.gamesPlayed + s.higherLower.gamesPlayed + s.whoAmI.gamesPlayed + s.recall.gamesPlayed) >= 25 },
      { id: 'enthusiast', name: 'Enthusiast', icon: 'üèÖ', description: 'Play 50 total games', category: 'general',
        check: (s) => (s.grid.gamesPlayed + s.connections.gamesPlayed + s.wordle.gamesPlayed + s.higherLower.gamesPlayed + s.whoAmI.gamesPlayed + s.recall.gamesPlayed) >= 50 },
      { id: 'game-master', name: 'Game Master', icon: 'üëë', description: 'Play 100 total games', category: 'general',
        check: (s) => (s.grid.gamesPlayed + s.connections.gamesPlayed + s.wordle.gamesPlayed + s.higherLower.gamesPlayed + s.whoAmI.gamesPlayed + s.recall.gamesPlayed) >= 100 },
      
      // Aces Grid badges
      { id: 'grid-rookie', name: 'Grid Rookie', icon: 'üî≤', description: 'Complete your first grid', category: 'grid',
        check: (s) => s.grid.gamesPlayed >= 1 },
      { id: 'perfectionist', name: 'Perfectionist', icon: '‚ú®', description: 'Get your first 9/9', category: 'grid',
        check: (s) => s.grid.perfectGames >= 1 },
      { id: 'grid-expert', name: 'Grid Expert', icon: 'üíé', description: '5 perfect grids', category: 'grid',
        check: (s) => s.grid.perfectGames >= 5 },
      { id: 'grid-legend', name: 'Grid Legend', icon: 'üèÜ', description: '10 perfect grids', category: 'grid',
        check: (s) => s.grid.perfectGames >= 10 },
      { id: 'grid-streak', name: 'Grid Streak', icon: 'üî•', description: '7-day grid streak', category: 'grid',
        check: (s) => s.grid.longestStreak >= 7 },
      
      // Connections badges
      { id: 'connected', name: 'Connected', icon: 'üîó', description: 'Complete first connections', category: 'connections',
        check: (s) => s.connections.gamesPlayed >= 1 },
      { id: 'pattern-spotter', name: 'Pattern Spotter', icon: 'üß©', description: 'First perfect (no mistakes)', category: 'connections',
        check: (s) => s.connections.perfectGames >= 1 },
      { id: 'mind-reader', name: 'Mind Reader', icon: 'üß†', description: '5 perfect connections', category: 'connections',
        check: (s) => s.connections.perfectGames >= 5 },
      { id: 'connection-master', name: 'Connection Master', icon: 'üëÅÔ∏è', description: '10 perfect connections', category: 'connections',
        check: (s) => s.connections.perfectGames >= 10 },
      { id: 'link-streak', name: 'Link Streak', icon: '‚õìÔ∏è', description: '7-day connections streak', category: 'connections',
        check: (s) => s.connections.longestStreak >= 7 },
      
      // Wordle badges
      { id: 'word-rookie', name: 'Word Rookie', icon: 'üìù', description: 'Win your first wordle', category: 'wordle',
        check: (s) => s.wordle.wins >= 1 },
      { id: 'wordsmith', name: 'Wordsmith', icon: 'üìö', description: '10 wordle wins', category: 'wordle',
        check: (s) => s.wordle.wins >= 10 },
      { id: 'word-master', name: 'Word Master', icon: 'üéì', description: '25 wordle wins', category: 'wordle',
        check: (s) => s.wordle.wins >= 25 },
      { id: 'word-streak', name: 'Word Streak', icon: 'üî•', description: '7-day wordle streak', category: 'wordle',
        check: (s) => s.wordle.maxStreak >= 7 },
      
      // Higher or Lower badges
      { id: 'stat-watcher', name: 'Stat Watcher', icon: 'üìà', description: 'Complete first higher/lower', category: 'higherLower',
        check: (s) => s.higherLower.gamesPlayed >= 1 },
      { id: 'perfect-read', name: 'Perfect Read', icon: 'üíØ', description: 'Get 5/5 correct', category: 'higherLower',
        check: (s) => s.higherLower.perfectGames >= 1 },
      { id: 'numbers-whiz', name: 'Numbers Whiz', icon: 'üî¢', description: '5 perfect games', category: 'higherLower',
        check: (s) => s.higherLower.perfectGames >= 5 },
      { id: 'stat-savant', name: 'Stat Savant', icon: 'üìä', description: '10 perfect games', category: 'higherLower',
        check: (s) => s.higherLower.perfectGames >= 10 },
      { id: 'stat-streak', name: 'Stat Streak', icon: 'üî•', description: '7-day streak', category: 'higherLower',
        check: (s) => s.higherLower.longestStreak >= 7 },
      
      // Who Am I badges
      { id: 'detective', name: 'Detective', icon: 'üïµÔ∏è', description: 'Win your first Who Am I', category: 'whoAmI',
        check: (s) => s.whoAmI.wins >= 1 },
      { id: 'quick-solver', name: 'Quick Solver', icon: 'üîé', description: '5 Who Am I wins', category: 'whoAmI',
        check: (s) => s.whoAmI.wins >= 5 },
      { id: 'identity-expert', name: 'Identity Expert', icon: 'üé≠', description: '10 Who Am I wins', category: 'whoAmI',
        check: (s) => s.whoAmI.wins >= 10 },
      { id: 'mystery-streak', name: 'Mystery Streak', icon: 'üî•', description: '7-day streak', category: 'whoAmI',
        check: (s) => s.whoAmI.maxStreak >= 7 },
      
      // Player Recall badges
      { id: 'memory-start', name: 'Memory Start', icon: 'üß†', description: 'Complete first recall', category: 'recall',
        check: (s) => s.recall.gamesPlayed >= 1 },
      { id: 'total-recall', name: 'Total Recall', icon: 'üíØ', description: 'First perfect recall', category: 'recall',
        check: (s) => s.recall.perfectGames >= 1 },
      { id: 'recall-pro', name: 'Recall Pro', icon: '‚ö°', description: '5 perfect recalls', category: 'recall',
        check: (s) => s.recall.perfectGames >= 5 },
      { id: 'memory-master', name: 'Memory Master', icon: 'üèÜ', description: '10 perfect recalls', category: 'recall',
        check: (s) => s.recall.perfectGames >= 10 },
      
      // Hidden/Secret badges
      { id: 'daily-sweep', name: 'Daily Sweep', icon: 'üßπ', description: 'Complete all 6 games in one day', category: 'hidden',
        check: (s) => s.dailySweep === true, hidden: true },
      { id: 'speed-demon', name: 'Speed Demon', icon: '‚ö°', description: 'Perfect recall in under 50% of time', category: 'hidden',
        check: (s) => s.recall.hasSpeedDemon === true, hidden: true },
      { id: 'lucky-guess', name: 'Lucky Guess', icon: 'üçÄ', description: 'Win Who Am I with ‚â§2 clues', category: 'hidden',
        check: (s) => s.whoAmI.hasLuckyGuess === true, hidden: true },
      { id: 'week-warrior', name: 'Week Warrior', icon: '‚öîÔ∏è', description: 'Complete all 6 games for 7 days straight', category: 'hidden',
        check: (s) => s.weekWarrior === true, hidden: true },
      { id: 'early-bird', name: 'Early Bird', icon: 'üê¶', description: 'Play a game before 7 AM', category: 'hidden',
        check: (s) => s.earlyBird === true, hidden: true },
      { id: 'night-owl', name: 'Night Owl', icon: 'ü¶â', description: 'Play a game after 11 PM', category: 'hidden',
        check: (s) => s.nightOwl === true, hidden: true },
    ];
    
    function renderBadges(stats) {
      const container = document.getElementById('badgesContainer');
      if (!container) return;
      
      let earnedCount = 0;
      const badgeHtml = BADGES.map(badge => {
        const earned = badge.check(stats);
        if (earned) earnedCount++;
        
        const categoryColors = {
          general: { bg: '#f3f4f6', border: '#d1d5db', color: '#374151' },
          grid: { bg: '#f0fdf4', border: '#bbf7d0', color: '#166534' },
          connections: { bg: '#faf5ff', border: '#e9d5ff', color: '#7c3aed' },
          wordle: { bg: '#ecfdf5', border: '#6ee7b7', color: '#047857' },
          higherLower: { bg: '#fff7ed', border: '#fed7aa', color: '#c2410c' },
          whoAmI: { bg: '#f0fdfa', border: '#99f6e4', color: '#0f766e' },
          recall: { bg: '#fef2f2', border: '#fecaca', color: '#b91c1c' },
          hidden: { bg: '#fef3c7', border: '#fcd34d', color: '#92400e' }
        };
        
        const colors = categoryColors[badge.category] || categoryColors.general;
        
        // Hidden badges show ??? until earned
        const isHidden = badge.hidden && !earned;
        const displayName = isHidden ? '???' : badge.name;
        const displayIcon = isHidden ? '‚ùì' : badge.icon;
        const displayDesc = isHidden ? 'Secret badge - keep playing to discover!' : badge.description;
        
        return `
          <div class="badge-item" title="${displayDesc}" style="
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
            cursor: default;
            ${earned ? `
              background: ${colors.bg};
              border: 1px solid ${colors.border};
              color: ${colors.color};
            ` : isHidden ? `
              background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
              border: 1px dashed #6b7280;
              color: #9ca3af;
            ` : `
              background: #f9fafb;
              border: 1px solid #e5e7eb;
              color: #9ca3af;
              opacity: 0.6;
            `}
          ">
            <span style="font-size: 1rem; ${earned ? '' : 'filter: grayscale(100%);'}">${displayIcon}</span>
            <span>${displayName}</span>
            ${earned ? (badge.hidden ? '<span style="font-size: 0.7rem;">‚ú®</span>' : '') : (isHidden ? '' : '<span style="font-size: 0.7rem;">üîí</span>')}
          </div>
        `;
      }).join('');
      
      container.innerHTML = badgeHtml;
      
      // Update badge count
      const countEl = document.getElementById('badgeCount');
      if (countEl) {
        countEl.textContent = `${earnedCount}/${BADGES.length}`;
      }
    }
    
    // Helper to calculate day number for each game
    function getDayNumber() {
      const LAUNCH_YEAR = 2026;
      const LAUNCH_MONTH = 0; // January
      const LAUNCH_DAY = 6;  // Jan 6, 2026
      
      const start = new Date(LAUNCH_YEAR, LAUNCH_MONTH, LAUNCH_DAY).setHours(0, 0, 0, 0);
      const now = new Date().setHours(0, 0, 0, 0);
      const daysSinceLaunch = Math.floor((now - start) / (1000 * 60 * 60 * 24));
      return Math.max(1, daysSinceLaunch + 1);
    }
  </script>
  <script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
</body>
</html>
