<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="/manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Role Management - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
  :root {
    --primary-color: #2d5016;
    --secondary-color: #1a6b4a;
    --accent-color: #ffd700;
    --admin-color: #6b21a8;
    --admin-secondary: #7c3aed;
    --card-bg: #ffffff;
    --text-dark: #2d3748;
    --text-light: #718096;
    --border-color: #e2e8f0;
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
    --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
    --success-color: #22c55e;
    --warning-color: #f59e0b;
    --danger-color: #ef4444;
    --info-color: #3b82f6;
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    min-height: 100vh;
    color: var(--text-dark);
  }

  .loading-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.5s ease;
  }

  .loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  .softball-spinner::before {
    content: 'üéõÔ∏è';
    font-size: 80px;
    animation: spin 1.5s ease-in-out infinite;
  }

  @keyframes spin {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(180deg) scale(1.1); }
  }

  /* Auth Gate */
  .auth-gate {
    max-width: 500px;
    margin: 4rem auto;
    padding: 3rem;
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: var(--shadow-lg);
    text-align: center;
  }

  .auth-gate h2 {
    color: var(--danger-color);
    margin-bottom: 1rem;
  }

  .auth-gate p {
    color: var(--text-light);
    margin-bottom: 2rem;
  }

  .auth-gate a {
    display: inline-block;
    padding: 0.75rem 2rem;
    background: var(--primary-color);
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
  }

  /* Header */
  .header {
    background: linear-gradient(135deg, var(--admin-color) 0%, var(--admin-secondary) 100%);
    color: white;
    padding: 2.5rem 2rem;
    box-shadow: var(--shadow-lg);
    position: relative;
    overflow: hidden;
  }

  .header::before {
    content: '';
    position: absolute;
    top: -100px;
    right: -100px;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
  }

  .header::after {
    content: 'üë•';
    position: absolute;
    bottom: -40px;
    left: -30px;
    font-size: 180px;
    opacity: 0.08;
  }

  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .header h1 {
    margin: 0;
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
  }

  .header p {
    margin: 0;
    opacity: 0.9;
    font-size: 0.95rem;
  }

  .header-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  /* Navigation Buttons */
  .nav-btn {
    padding: 0.875rem 1.5rem;
    border: 2px solid white;
    background: white;
    color: var(--admin-color);
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .nav-btn::before {
    content: '';
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: var(--accent-color);
    transform: translateX(-100%);
    transition: transform 0.3s ease;
    z-index: -1;
  }

  .nav-btn:hover::before {
    transform: translateX(0);
  }

  .nav-btn:hover {
    color: var(--admin-color);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .admin-badge {
    display: inline-block;
    background: rgba(255,255,255,0.2);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    margin-top: 0.5rem;
  }

  /* Container */
  .container {
    max-width: 1400px;
    margin: 2rem auto;
    padding: 0 1.5rem;
  }

  /* Stats Cards */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .stat-card {
    background: var(--card-bg);
    border-radius: 12px;
    padding: 1.25rem;
    box-shadow: var(--shadow-sm);
    text-align: center;
  }

  .stat-card .stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--admin-color);
  }

  .stat-card .stat-label {
    font-size: 0.85rem;
    color: var(--text-light);
    margin-top: 0.25rem;
  }

  /* Section Cards */
  .section {
    background: var(--card-bg);
    border-radius: 16px;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-sm);
    border: 1px solid var(--border-color);
  }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
  }

  .section-header h2 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 700;
    flex: 1;
  }

  .section-header .icon {
    font-size: 1.5rem;
  }

  .section-body {
    padding: 1.5rem;
  }

  /* Search and Filter */
  .filter-bar {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
  }

  .search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
  }

  .search-box input {
    width: 100%;
    padding: 0.875rem 1rem 0.875rem 2.75rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .search-box input:focus {
    outline: none;
    border-color: var(--admin-color);
    box-shadow: 0 0 0 3px rgba(107, 33, 168, 0.1);
  }

  .search-box::before {
    content: 'üîç';
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
  }

  .filter-select {
    padding: 0.875rem 2rem 0.875rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    font-size: 0.95rem;
    background: white;
    cursor: pointer;
    min-width: 150px;
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--admin-color);
  }

  /* Users Table */
  .users-table {
    width: 100%;
    border-collapse: collapse;
  }

  .users-table th,
  .users-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
  }

  .users-table th {
    background: #f8fafc;
    font-weight: 600;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-light);
  }

  .users-table tbody tr:hover {
    background: #f8fafc;
  }

  .users-table tbody tr.selected {
    background: rgba(107, 33, 168, 0.08);
  }

  /* User Info Cell */
  .user-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--admin-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.9rem;
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-details {
    display: flex;
    flex-direction: column;
  }

  .user-name {
    font-weight: 600;
    color: var(--text-dark);
  }

  .user-email {
    font-size: 0.8rem;
    color: var(--text-light);
  }

  /* Role Badges */
  .role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    white-space: nowrap;
  }

  .role-admin { background: #fef3c7; color: #92400e; }
  .role-league-staff { background: #dbeafe; color: #1e40af; }
  .role-captain { background: #d1fae5; color: #065f46; }
  .role-team-staff { background: #e0e7ff; color: #3730a3; }
  .role-player { background: #f3f4f6; color: #374151; }
  .role-fan { background: #fce7f3; color: #9d174d; }
  .role-family { background: #fef9c3; color: #854d0e; }
  .role-photographer { background: #ccfbf1; color: #0f766e; }
  .role-oddsmaker { background: #fecaca; color: #991b1b; }

  /* Team Badge */
  .team-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.35rem 0.75rem;
    border-radius: 8px;
    font-size: 0.8rem;
    font-weight: 500;
    background: #f3f4f6;
    color: var(--text-dark);
  }

  /* Action Buttons */
  .btn {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .btn-primary {
    background: var(--admin-color);
    color: white;
  }

  .btn-primary:hover {
    background: var(--admin-secondary);
    transform: translateY(-1px);
  }

  .btn-success {
    background: var(--success-color);
    color: white;
  }

  .btn-success:hover {
    background: #16a34a;
  }

  .btn-warning {
    background: var(--warning-color);
    color: white;
  }

  .btn-danger {
    background: var(--danger-color);
    color: white;
  }

  .btn-secondary {
    background: #e2e8f0;
    color: var(--text-dark);
  }

  .btn-secondary:hover {
    background: #cbd5e1;
  }

  .btn-sm {
    padding: 0.35rem 0.75rem;
    font-size: 0.8rem;
  }

  /* Editor Panel */
  .editor-panel {
    position: fixed;
    top: 0;
    right: -500px;
    width: 100%;
    max-width: 450px;
    height: 100vh;
    background: white;
    box-shadow: -4px 0 24px rgba(0,0,0,0.15);
    z-index: 1000;
    transition: right 0.3s ease;
    display: flex;
    flex-direction: column;
  }

  .editor-panel.active {
    right: 0;
  }

  .editor-header {
    padding: 1.5rem;
    background: var(--admin-color);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .editor-header h3 {
    margin: 0;
    font-size: 1.25rem;
  }

  .editor-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    padding: 0.5rem;
    line-height: 1;
  }

  .editor-body {
    flex: 1;
    padding: 1.5rem;
    overflow-y: auto;
  }

  .editor-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
    display: flex;
    gap: 1rem;
  }

  .editor-footer .btn {
    flex: 1;
    justify-content: center;
    padding: 0.875rem;
  }

  /* Form Groups */
  .form-group {
    margin-bottom: 1.25rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-dark);
  }

  .form-group input,
  .form-group select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.2s ease;
  }

  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--admin-color);
  }

  .form-hint {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.35rem;
  }

  /* Role Selection */
  .role-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .role-option {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    border: 2px solid var(--border-color);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .role-option:hover {
    border-color: var(--admin-color);
    background: #f8fafc;
  }

  .role-option.selected {
    border-color: var(--admin-color);
    background: rgba(107, 33, 168, 0.05);
  }

  .role-option input {
    margin-right: 0.75rem;
    accent-color: var(--admin-color);
  }

  .role-option-content {
    flex: 1;
  }

  .role-option-name {
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .role-option-desc {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-top: 0.15rem;
  }

  /* User Preview in Editor */
  .user-preview {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 1.5rem;
  }

  .user-preview-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: var(--admin-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
  }

  .user-preview-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
  }

  .user-preview-info h4 {
    margin: 0 0 0.25rem 0;
    font-size: 1.1rem;
  }

  .user-preview-info p {
    margin: 0;
    font-size: 0.85rem;
    color: var(--text-light);
  }

  /* Current Roles Display */
  .current-roles {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  /* Special Roles Section */
  .special-roles-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
  }

  .special-roles-section h4 {
    margin: 0 0 1rem 0;
    font-size: 0.95rem;
    color: var(--text-dark);
  }

  .special-roles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .special-role-toggle {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .special-role-toggle:hover {
    border-color: var(--admin-color);
  }

  .special-role-toggle.active {
    border-color: var(--success-color);
    background: rgba(34, 197, 94, 0.05);
  }

  .special-role-toggle input {
    accent-color: var(--success-color);
  }

  /* Team Roles Section */
  .team-roles-section {
    margin-top: 1.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border-color);
  }

  .team-roles-section h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.95rem;
    color: var(--text-dark);
  }

  .team-roles-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .team-role-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid var(--border-color);
  }

  .team-role-row.has-role {
    background: rgba(34, 197, 94, 0.05);
    border-color: var(--success-color);
  }

  .team-role-name {
    flex: 1;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .team-role-select {
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-color);
    border-radius: 6px;
    font-size: 0.85rem;
    min-width: 140px;
  }

  .team-role-select:focus {
    outline: none;
    border-color: var(--admin-color);
  }

  .team-role-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .team-role-badge.captain {
    background: #d1fae5;
    color: #065f46;
  }

  .team-role-badge.team-staff {
    background: #e0e7ff;
    color: #3730a3;
  }

  /* Section Divider */
  .section-divider {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin: 1.5rem 0;
    color: var(--text-light);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .section-divider::before,
  .section-divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border-color);
  }

  /* Current Roles Summary */
  .current-roles-summary {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.5rem;
  }

  /* Backdrop */
  .editor-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .editor-backdrop.active {
    opacity: 1;
    visibility: visible;
  }

  /* Toast Notifications */
  .toast-container {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .toast {
    padding: 1rem 1.5rem;
    border-radius: 10px;
    color: white;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    animation: slideIn 0.3s ease;
    box-shadow: var(--shadow-lg);
  }

  .toast-success { background: var(--success-color); }
  .toast-error { background: var(--danger-color); }
  .toast-warning { background: var(--warning-color); }
  .toast-info { background: var(--info-color); }

  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-light);
  }

  .empty-state .icon {
    font-size: 3rem;
    margin-bottom: 1rem;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
  }

  .pagination button {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: white;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .pagination button:hover:not(:disabled) {
    border-color: var(--admin-color);
    color: var(--admin-color);
  }

  .pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .pagination .page-info {
    padding: 0.5rem 1rem;
    color: var(--text-light);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      text-align: center;
    }

    .header-buttons {
      justify-content: center;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .users-table {
      display: block;
      overflow-x: auto;
    }

    .filter-bar {
      flex-direction: column;
    }

    .filter-select {
      width: 100%;
    }

    .editor-panel {
      max-width: 100%;
    }

    .special-roles-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="softball-spinner"></div>
</div>

<!-- Auth Gate (shown when not authorized) -->
<div class="auth-gate" id="authGate" style="display: none;">
  <h2>üîí Access Denied</h2>
  <p>You must be an Admin or League Staff to access this page.</p>
  <a href="profile.html">‚Üê Back to Profile</a>
</div>

<!-- Main Content (hidden until authorized) -->
<div id="mainContent" style="display: none;">
  
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div>
        <h1>üë• Role Management</h1>
        <p>Assign and manage user roles across the league</p>
        <div class="admin-badge" id="userBadge">Loading...</div>
      </div>
      <div class="header-buttons">
        <a href="admin-content.html" class="nav-btn">üìä Content Admin</a>
        <a href="profile.html" class="nav-btn">üë§ Profile</a>
        <a href="index.html" class="nav-btn">üè† Home</a>
      </div>
    </div>
  </header>

  <div class="container">
    
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="totalUsers">-</div>
        <div class="stat-label">Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalAdmins">-</div>
        <div class="stat-label">Admins</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalLeagueStaff">-</div>
        <div class="stat-label">League Staff</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalCaptains">-</div>
        <div class="stat-label">Captains</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalPlayers">-</div>
        <div class="stat-label">Players</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalSpecialRoles">-</div>
        <div class="stat-label">Special Roles</div>
      </div>
      <div class="stat-card" style="opacity: 0.7;">
        <div class="stat-value" id="totalMigrated" style="color: var(--text-light);">-</div>
        <div class="stat-label">Migrated (Hidden)</div>
      </div>
    </div>

    <!-- Users Section -->
    <div class="section">
      <div class="section-header">
        <span class="icon">üë•</span>
        <h2>All Users</h2>
        <button class="btn btn-primary btn-sm" onclick="refreshUsers()">üîÑ Refresh</button>
      </div>
      <div class="section-body">
        
        <!-- Filter Bar -->
        <div class="filter-bar">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search by name or email..." oninput="filterUsers()">
          </div>
          <select class="filter-select" id="roleFilter" onchange="filterUsers()">
            <option value="all">All Roles</option>
            <option value="admin">Admin</option>
            <option value="league-staff">League Staff</option>
            <option value="captain">Captain</option>
            <option value="team-staff">Team Staff</option>
            <option value="player">Player</option>
            <option value="fan">Fan</option>
            <option value="family">Family</option>
            <option value="photographer">Photographer</option>
            <option value="oddsmaker">Oddsmaker</option>
          </select>
          <select class="filter-select" id="teamFilter" onchange="filterUsers()">
            <option value="all">All Teams</option>
          </select>
          <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: var(--text-light); cursor: pointer; white-space: nowrap;">
            <input type="checkbox" id="showMigratedToggle" onchange="loadUsers()" style="accent-color: var(--admin-color);">
            Show migrated
          </label>
        </div>

        <!-- Users Table -->
        <div style="overflow-x: auto;">
          <table class="users-table">
            <thead>
              <tr>
                <th>User</th>
                <th>League Role</th>
                <th>Team Roles</th>
                <th>Linked Player</th>
                <th>Special Roles</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" class="empty-state">
                  <div class="icon">‚è≥</div>
                  <p>Loading users...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
          <button onclick="previousPage()" id="prevBtn">‚Üê Previous</button>
          <span class="page-info" id="pageInfo">Page 1 of 1</span>
          <button onclick="nextPage()" id="nextBtn">Next ‚Üí</button>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Editor Panel -->
<div class="editor-backdrop" id="editorBackdrop" onclick="closeEditor()"></div>
<div class="editor-panel" id="editorPanel">
  <div class="editor-header">
    <h3>Edit User Role</h3>
    <button class="editor-close" onclick="closeEditor()">√ó</button>
  </div>
  <div class="editor-body" id="editorBody">
    <!-- Dynamically populated -->
  </div>
  <div class="editor-footer">
    <button class="btn btn-secondary" onclick="closeEditor()">Cancel</button>
    <button class="btn btn-success" onclick="saveUserRole()">üíæ Save Changes</button>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Navigation Component -->
<script type="module">
  import { NavigationComponent } from './nav-component.js';
</script>

<script type="module">
  import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { doc, getDoc, getDocs, updateDoc, collection, query, where, serverTimestamp, orderBy, limit, startAfter } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
  import { app, db } from './firebase-data.js';
  import { USER_ROLES, getUserProfile } from './firebase-auth.js';
  
  const auth = getAuth(app);
  
  // State
  let currentUser = null;
  let userProfile = null;
  let allUsers = [];
  let filteredUsers = [];
  let selectedUser = null;
  let currentPage = 1;
  const PAGE_SIZE = 20;
  let teams = [];
  let migratedCount = 0;

  // Special roles (these are toggleable badges, not primary roles)
  const SPECIAL_ROLES = {
      eulogist: { icon: '‚úçÔ∏è', label: 'Eulogist', desc: 'Can write team eulogies' },
      photographer: { icon: 'üì∏', label: 'Photographer', desc: 'Can upload and manage league photos' },
      oddsmaker: { icon: 'üé≤', label: 'Oddsmaker', desc: 'Can create and manage betting odds' },
      statistician: { icon: 'üìä', label: 'Statistician', desc: 'Advanced stats access and editing' },
      historian: { icon: 'üìö', label: 'Historian', desc: 'Can edit historical records' },
      umpire: { icon: '‚öñÔ∏è', label: 'Umpire', desc: 'League umpire designation' }
    };

  // League-wide roles (stored in userRole field)
  const LEAGUE_ROLES = {
    admin: { icon: 'üëë', label: 'Admin', desc: 'Full system access and control', level: 1 },
    'league-staff': { icon: '‚öôÔ∏è', label: 'League Staff', desc: 'Manage league operations', level: 2 },
    player: { icon: 'ü•é', label: 'Player', desc: 'Active league player', level: 3 },
    fan: { icon: 'üì£', label: 'Fan', desc: 'League follower without playing status', level: 4 },
    family: { icon: 'üë®‚Äçüë©‚Äçüëß', label: 'Family', desc: 'Family member of a player', level: 5 }
  };

  // Team-specific roles (stored in teamRoles field)
  const TEAM_ROLES = {
    captain: { icon: 'üéØ', label: 'Captain', desc: 'Team captain with roster management' },
    'team-staff': { icon: 'üìã', label: 'Team Staff', desc: 'Assist captain with team operations' },
    none: { icon: '‚ûñ', label: 'None', desc: 'No team role' }
  };

  // Combined for display purposes (backward compat)
  const ROLE_DEFINITIONS = {
    admin: { icon: 'üëë', label: 'Admin', desc: 'Full system access and control', level: 1 },
    'league-staff': { icon: '‚öôÔ∏è', label: 'League Staff', desc: 'Manage league operations', level: 2 },
    captain: { icon: 'üéØ', label: 'Captain', desc: 'Team captain with roster management', level: 3 },
    'team-staff': { icon: 'üìã', label: 'Team Staff', desc: 'Assist captain with team operations', level: 4 },
    player: { icon: 'ü•é', label: 'Player', desc: 'Active league player', level: 5 },
    fan: { icon: 'üì£', label: 'Fan', desc: 'League follower without playing status', level: 6 },
    family: { icon: 'üë®‚Äçüë©‚Äçüëß', label: 'Family', desc: 'Family member of a player', level: 7 }
  };

  // Initialize
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      
      try {
        const profileResult = await getUserProfile(user.uid);
        
        if (!profileResult.success) {
          showAuthGate();
          return;
        }
        
        userProfile = profileResult.data;
        
        console.log('üìã User profile loaded:', {
          userRole: userProfile.userRole,
          isAdmin: userProfile.isAdmin
        });

        // Check authorization
        const userRole = (userProfile.userRole || '').toLowerCase();
        const isAuthorized = 
          userProfile.isAdmin === true || 
          userRole === 'admin' ||
          userRole === 'league-staff';

        if (isAuthorized) {
          let badge = 'üèüÔ∏è League Staff';
          if (userProfile.isAdmin === true || userRole === 'admin') {
            badge = 'üëë Admin';
          }
          document.getElementById('userBadge').textContent = badge;
          showMainContent();
          await initialize();
        } else {
          showAuthGate();
        }
        
      } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        showAuthGate();
      }
    } else {
      window.location.href = 'signin.html?redirect=' + encodeURIComponent(window.location.pathname);
    }
  });

  function showAuthGate() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('authGate').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
  }

  function showMainContent() {
    document.getElementById('loadingOverlay').classList.add('hidden');
    document.getElementById('authGate').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
  }

  async function initialize() {
    await loadTeams();
    await loadUsers();
  }

  // Load teams for filter dropdown
  async function loadTeams() {
    try {
      const teamsSnap = await getDocs(collection(db, 'teams'));
      teams = [];
      
      teamsSnap.forEach(doc => {
        teams.push({
          id: doc.id,
          name: doc.data().teamName || doc.id
        });
      });

      // Populate team filter
      const teamFilter = document.getElementById('teamFilter');
      teams.sort((a, b) => a.name.localeCompare(b.name));
      teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team.id;
        option.textContent = capitalize(team.name);
        teamFilter.appendChild(option);
      });

    } catch (error) {
      console.error('‚ùå Error loading teams:', error);
    }
  }

  // Load all users
  async function loadUsers() {
    try {
      const showMigrated = document.getElementById('showMigratedToggle')?.checked || false;
      const usersSnap = await getDocs(collection(db, 'users'));
      allUsers = [];
      migratedCount = 0;
      
      usersSnap.forEach(doc => {
        const data = doc.data();
        
        // Skip migrated legacy profiles unless toggle is checked
        if (data.migrated === true) {
          migratedCount++;
          if (!showMigrated) {
            return;
          }
        }
        
        allUsers.push({
          id: doc.id,
          ...data
        });
      });

      console.log(`üìä Loaded ${allUsers.length} users (${migratedCount} migrated profiles ${showMigrated ? 'included' : 'hidden'})`);

      // Sort by display name
      allUsers.sort((a, b) => {
        const nameA = (a.displayName || a.preferredDisplayName || a.email || '').toLowerCase();
        const nameB = (b.displayName || b.preferredDisplayName || b.email || '').toLowerCase();
        return nameA.localeCompare(nameB);
      });

      updateStats();
      filterUsers();
      
    } catch (error) {
      console.error('‚ùå Error loading users:', error);
      showToast('Error loading users', 'error');
    }
  }

  // Update stats
  function updateStats() {
    const stats = {
      total: allUsers.length,
      admins: 0,
      leagueStaff: 0,
      captains: 0,
      players: 0,
      specialRoles: 0
    };

    allUsers.forEach(user => {
      const role = (user.userRole || '').toLowerCase();
      
      if (role === 'admin' || user.isAdmin) stats.admins++;
      else if (role === 'league-staff') stats.leagueStaff++;
      else if (role === 'player') stats.players++;

      // Count captains from teamRoles or legacy isCaptain flag
      const hasCaptainRole = user.isCaptain === true || 
        (user.teamRoles && Object.values(user.teamRoles).some(tr => tr.status === 'active' && tr.role === 'captain'));
      if (hasCaptainRole) stats.captains++;

      // Count special roles
      if (user.specialRoles && Object.values(user.specialRoles).some(v => v === true)) {
        stats.specialRoles++;
      }
    });

    document.getElementById('totalUsers').textContent = stats.total;
    document.getElementById('totalAdmins').textContent = stats.admins;
    document.getElementById('totalLeagueStaff').textContent = stats.leagueStaff;
    document.getElementById('totalCaptains').textContent = stats.captains;
    document.getElementById('totalPlayers').textContent = stats.players;
    document.getElementById('totalSpecialRoles').textContent = stats.specialRoles;
    document.getElementById('totalMigrated').textContent = migratedCount;
  }

  // Filter users
  window.filterUsers = function() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const teamFilter = document.getElementById('teamFilter').value;

    filteredUsers = allUsers.filter(user => {
      // Search filter
      const name = (user.displayName || user.preferredDisplayName || '').toLowerCase();
      const email = (user.email || '').toLowerCase();
      const matchesSearch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm);

      // Role filter
      let matchesRole = true;
      if (roleFilter !== 'all') {
        const userRole = (user.userRole || '').toLowerCase();
        
        if (roleFilter === 'photographer' || roleFilter === 'oddsmaker') {
          // Check special roles
          matchesRole = user.specialRoles?.[roleFilter] === true;
        } else if (roleFilter === 'captain') {
          // Check teamRoles for captain, or legacy isCaptain flag
          matchesRole = user.isCaptain === true ||
            (user.teamRoles && Object.values(user.teamRoles).some(tr => tr.status === 'active' && tr.role === 'captain'));
        } else if (roleFilter === 'team-staff') {
          // Check teamRoles for team-staff
          matchesRole = user.teamRoles && 
            Object.values(user.teamRoles).some(tr => tr.status === 'active' && tr.role === 'team-staff');
        } else if (roleFilter === 'admin') {
          matchesRole = userRole === 'admin' || user.isAdmin === true;
        } else {
          matchesRole = userRole === roleFilter;
        }
      }

      // Team filter
      let matchesTeam = true;
      if (teamFilter !== 'all') {
        const teamFilterLower = teamFilter.toLowerCase();
        const linkedTeamLower = (user.linkedTeam || '').toLowerCase();
        
        // Check linkedTeam (case-insensitive)
        const matchesLinkedTeam = linkedTeamLower === teamFilterLower;
        
        // Check teamRoles (case-insensitive key lookup)
        let hasTeamRole = false;
        if (user.teamRoles) {
          hasTeamRole = Object.entries(user.teamRoles).some(([teamId, tr]) => 
            teamId.toLowerCase() === teamFilterLower && tr.status === 'active'
          );
        }
        
        matchesTeam = matchesLinkedTeam || hasTeamRole;
      }

      return matchesSearch && matchesRole && matchesTeam;
    });

    currentPage = 1;
    renderUsers();
  };

  // Render users table
  function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    
    if (filteredUsers.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="empty-state">
            <div class="icon">üîç</div>
            <p>No users found matching your filters</p>
          </td>
        </tr>
      `;
      document.getElementById('pagination').style.display = 'none';
      return;
    }

    // Pagination
    const totalPages = Math.ceil(filteredUsers.length / PAGE_SIZE);
    const startIdx = (currentPage - 1) * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageUsers = filteredUsers.slice(startIdx, endIdx);

    tbody.innerHTML = pageUsers.map(user => {
      const displayName = user.preferredDisplayName || user.displayName || 'Unknown';
      const email = user.email || '';
      const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
      const leagueRole = user.userRole || 'fan';
      const linkedTeam = user.linkedTeam || '-';
      const linkedPlayer = user.linkedPlayer || '-';
      const isMigrated = user.migrated === true;

      // Get league role badge
      let leagueRoleBadgeClass = `role-${leagueRole}`;
      let leagueRoleIcon = LEAGUE_ROLES[leagueRole]?.icon || ROLE_DEFINITIONS[leagueRole]?.icon || 'üë§';
      let leagueRoleLabel = LEAGUE_ROLES[leagueRole]?.label || ROLE_DEFINITIONS[leagueRole]?.label || capitalize(leagueRole);
      
      // Build team roles badges
      const teamRolesBadges = [];
      if (user.teamRoles) {
        // Track which teams we've already processed (to avoid duplicates from case mismatch)
        const processedTeams = new Set();
        
        Object.entries(user.teamRoles).forEach(([teamId, tr]) => {
          const normalizedTeamId = teamId.toLowerCase();
          
          // Skip if we've already processed this team (handles duplicate entries from case mismatch)
          if (processedTeams.has(normalizedTeamId)) return;
          processedTeams.add(normalizedTeamId);
          
          if (tr.status === 'active' && tr.role && tr.role !== 'none') {
            const teamName = capitalize(teams.find(t => t.id.toLowerCase() === normalizedTeamId)?.name || teamId);
            const roleInfo = TEAM_ROLES[tr.role] || { icon: 'üë§', label: tr.role };
            teamRolesBadges.push(`
              <span class="role-badge role-${tr.role}" title="${roleInfo.label} of ${teamName}">${roleInfo.icon} ${teamName}</span>
            `);
          }
        });
      }
      
      // Legacy captain fallback
      if (user.isCaptain && teamRolesBadges.length === 0 && linkedTeam !== '-') {
        teamRolesBadges.push(`
          <span class="role-badge role-captain" title="Captain (legacy)">üéØ ${capitalize(linkedTeam)}</span>
        `);
      }

      // Special roles badges
      const specialRolesBadges = [];
      if (user.specialRoles) {
        Object.entries(user.specialRoles).forEach(([key, value]) => {
          if (value === true && SPECIAL_ROLES[key]) {
            specialRolesBadges.push(`
              <span class="role-badge role-${key}">${SPECIAL_ROLES[key].icon} ${SPECIAL_ROLES[key].label}</span>
            `);
          }
        });
      }

      // Migrated badge
      const migratedBadge = isMigrated ? 
        `<span class="role-badge" style="background: #fee2e2; color: #991b1b; margin-left: 0.5rem;">üì¶ Migrated ‚Üí ${user.migratedTo?.slice(0,8) || '?'}...</span>` : '';

      return `
        <tr data-user-id="${user.id}" style="${isMigrated ? 'opacity: 0.6; background: #fef2f2;' : ''}">
          <td>
            <div class="user-info">
              <div class="user-avatar" style="${isMigrated ? 'opacity: 0.5;' : ''}">
                ${user.profilePhotoURL ? `<img src="${user.profilePhotoURL}" alt="">` : initials}
              </div>
              <div class="user-details">
                <span class="user-name">${displayName}${migratedBadge}</span>
                <span class="user-email">${email || '(legacy profile)'}</span>
              </div>
            </div>
          </td>
          <td>
            <span class="role-badge ${leagueRoleBadgeClass}">${leagueRoleIcon} ${leagueRoleLabel}</span>
          </td>
          <td>
            ${teamRolesBadges.length > 0 ? teamRolesBadges.join('') : '-'}
          </td>
          <td>${linkedPlayer}</td>
          <td>${specialRolesBadges.length > 0 ? specialRolesBadges.join('') : '-'}</td>
          <td>
            ${isMigrated ? 
              '<span style="color: var(--text-light); font-size: 0.8rem;">Read-only</span>' :
              `<button class="btn btn-primary btn-sm" onclick="editUser('${user.id}')">‚úèÔ∏è Edit</button>`
            }
          </td>
        </tr>
      `;
    }).join('');

    // Update pagination
    if (totalPages > 1) {
      document.getElementById('pagination').style.display = 'flex';
      document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = currentPage === totalPages;
    } else {
      document.getElementById('pagination').style.display = 'none';
    }
  }

  // Pagination
  window.previousPage = function() {
    if (currentPage > 1) {
      currentPage--;
      renderUsers();
    }
  };

  window.nextPage = function() {
    const totalPages = Math.ceil(filteredUsers.length / PAGE_SIZE);
    if (currentPage < totalPages) {
      currentPage++;
      renderUsers();
    }
  };

  // Edit user
  window.editUser = function(userId) {
    selectedUser = allUsers.find(u => u.id === userId);
    if (!selectedUser) return;

    const displayName = selectedUser.preferredDisplayName || selectedUser.displayName || 'Unknown';
    const email = selectedUser.email || '';
    const initials = displayName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    const linkedTeam = selectedUser.linkedTeam || '';
    
    // Determine current league role (filter out captain/team-staff as those are team-specific)
    let currentLeagueRole = selectedUser.userRole || 'fan';
    if (currentLeagueRole === 'captain' || currentLeagueRole === 'team-staff') {
      // These are team roles, default league role to player if they have linkedPlayer, else fan
      currentLeagueRole = selectedUser.linkedPlayer ? 'player' : 'fan';
    }

    // Build league role options (admin, league-staff, player, fan, family)
    const leagueRoleOptions = Object.entries(LEAGUE_ROLES).map(([key, def]) => {
      const isSelected = currentLeagueRole === key;
      return `
        <label class="role-option ${isSelected ? 'selected' : ''}">
          <input type="radio" name="leagueRole" value="${key}" ${isSelected ? 'checked' : ''} onchange="updateLeagueRoleSelection(this)">
          <div class="role-option-content">
            <div class="role-option-name">${def.icon} ${def.label}</div>
            <div class="role-option-desc">${def.desc}</div>
          </div>
        </label>
      `;
    }).join('');

    // Build team roles section - show each team with dropdown
    const teamRolesHtml = teams.map(team => {
      // Check both capitalized and lowercase versions of team ID
      const teamKey = capitalize(team.id);
      const teamRole = selectedUser.teamRoles?.[teamKey] || selectedUser.teamRoles?.[team.id];
      let currentTeamRole = (teamRole?.status === 'active') ? teamRole.role : 'none';
      
      // LEGACY FALLBACK: If no teamRoles but user is captain of this team via legacy fields
      // Check both casings for linkedTeam
      const linkedTeamMatch = selectedUser.linkedTeam?.toLowerCase() === team.id.toLowerCase();
      if (currentTeamRole === 'none' && 
          selectedUser.isCaptain === true && 
          linkedTeamMatch &&
          !selectedUser.teamRoles?.[teamKey] &&
          !selectedUser.teamRoles?.[team.id]) {
        currentTeamRole = 'captain';
      }
      
      const hasRole = currentTeamRole !== 'none';
      const teamDisplayName = capitalize(team.name || team.id);
      
      return `
        <div class="team-role-row ${hasRole ? 'has-role' : ''}" data-team-id="${team.id}">
          <span class="team-role-name">üèüÔ∏è ${teamDisplayName}</span>
          <select class="team-role-select" name="teamRole_${team.id}" onchange="updateTeamRoleRow(this)">
            <option value="none" ${currentTeamRole === 'none' ? 'selected' : ''}>‚ûñ None</option>
            <option value="captain" ${currentTeamRole === 'captain' ? 'selected' : ''}>üéØ Captain</option>
            <option value="team-staff" ${currentTeamRole === 'team-staff' ? 'selected' : ''}>üìã Team Staff</option>
          </select>
        </div>
      `;
    }).join('');

    // Build special roles toggles
    const specialRolesHtml = Object.entries(SPECIAL_ROLES).map(([key, def]) => {
      const isActive = selectedUser.specialRoles?.[key] === true;
      return `
        <label class="special-role-toggle ${isActive ? 'active' : ''}">
          <input type="checkbox" name="specialRole_${key}" ${isActive ? 'checked' : ''} onchange="toggleSpecialRole(this)">
          <span>${def.icon} ${def.label}</span>
        </label>
      `;
    }).join('');

    // Build current roles summary for display
    const currentRolesBadges = [];
    
    // League role badge
    if (LEAGUE_ROLES[currentLeagueRole]) {
      currentRolesBadges.push(`<span class="role-badge role-${currentLeagueRole}">${LEAGUE_ROLES[currentLeagueRole].icon} ${LEAGUE_ROLES[currentLeagueRole].label}</span>`);
    }
    
    // Team role badges
    if (selectedUser.teamRoles) {
      // Track which teams we've already processed (to avoid duplicates from case mismatch)
      const processedTeams = new Set();
      
      Object.entries(selectedUser.teamRoles).forEach(([teamId, tr]) => {
        const normalizedTeamId = teamId.toLowerCase();
        
        // Skip if we've already processed this team
        if (processedTeams.has(normalizedTeamId)) return;
        processedTeams.add(normalizedTeamId);
        
        if (tr.status === 'active' && tr.role !== 'none') {
          const teamName = capitalize(teams.find(t => t.id.toLowerCase() === normalizedTeamId)?.name || teamId);
          const roleInfo = TEAM_ROLES[tr.role] || { icon: 'üë§', label: tr.role };
          currentRolesBadges.push(`<span class="role-badge role-${tr.role}">${roleInfo.icon} ${teamName}</span>`);
        }
      });
    }
    
    // Legacy captain check
    if (selectedUser.isCaptain && currentRolesBadges.length <= 1) {
      currentRolesBadges.push(`<span class="role-badge role-captain">üéØ Captain (legacy)</span>`);
    }
    
    // Special roles
    if (selectedUser.specialRoles) {
      Object.entries(selectedUser.specialRoles).forEach(([key, value]) => {
        if (value === true && SPECIAL_ROLES[key]) {
          currentRolesBadges.push(`<span class="role-badge role-${key}">${SPECIAL_ROLES[key].icon} ${SPECIAL_ROLES[key].label}</span>`);
        }
      });
    }

    // Linked team options for player role
    const linkedTeamOptions = teams.map(team => {
      const teamDisplayName = capitalize(team.name || team.id);
      const isSelected = linkedTeam && team.id && linkedTeam.toLowerCase() === team.id.toLowerCase();
      return `<option value="${team.id}" ${isSelected ? 'selected' : ''}>${teamDisplayName}</option>`;
    }).join('');

    document.getElementById('editorBody').innerHTML = `
      <div class="user-preview">
        <div class="user-preview-avatar">
          ${selectedUser.profilePhotoURL ? `<img src="${selectedUser.profilePhotoURL}" alt="">` : initials}
        </div>
        <div class="user-preview-info">
          <h4>${displayName}</h4>
          <p>${email}</p>
          <div class="current-roles-summary">
            ${currentRolesBadges.join('')}
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>üåê League Role</label>
        <p class="form-hint" style="margin-bottom: 0.75rem;">This is the user's league-wide role. Admin and League Staff have access across all teams.</p>
        <div class="role-options">
          ${leagueRoleOptions}
        </div>
      </div>

      <div class="form-group" id="linkedTeamGroup" style="display: ${currentLeagueRole === 'player' ? 'block' : 'none'}">
        <label>Primary Team</label>
        <select id="linkedTeamSelect">
          <option value="">-- No Team --</option>
          ${linkedTeamOptions}
        </select>
        <div class="form-hint">The player's primary team for stats and roster</div>
      </div>

      <div class="team-roles-section">
        <h4>üèüÔ∏è Team Roles</h4>
        <p class="form-hint" style="margin-bottom: 1rem;">Assign Captain or Team Staff roles for specific teams. A user can be captain of multiple teams while also having a league role.</p>
        <div class="team-roles-list">
          ${teamRolesHtml}
        </div>
      </div>

      <div class="special-roles-section">
        <h4>üè∑Ô∏è Special Roles (Badges)</h4>
        <p class="form-hint" style="margin-bottom: 1rem;">These are additional designations that can be combined with any role.</p>
        <div class="special-roles-grid">
          ${specialRolesHtml}
        </div>
      </div>
    `;

    // Show editor
    document.getElementById('editorBackdrop').classList.add('active');
    document.getElementById('editorPanel').classList.add('active');
  };

  // Update league role selection styling
  window.updateLeagueRoleSelection = function(radio) {
    document.querySelectorAll('.role-option').forEach(opt => {
      opt.classList.toggle('selected', opt.contains(radio) && radio.checked);
    });

    // Show/hide linked team select based on role
    const selectedRole = radio.value;
    const linkedTeamGroup = document.getElementById('linkedTeamGroup');
    if (selectedRole === 'player') {
      linkedTeamGroup.style.display = 'block';
    } else {
      linkedTeamGroup.style.display = 'none';
    }
  };

  // Update team role row styling
  window.updateTeamRoleRow = function(select) {
    const row = select.closest('.team-role-row');
    const hasRole = select.value !== 'none';
    row.classList.toggle('has-role', hasRole);
  };

  // Toggle special role styling
  window.toggleSpecialRole = function(checkbox) {
    const label = checkbox.closest('.special-role-toggle');
    label.classList.toggle('active', checkbox.checked);
  };

  // Close editor
  window.closeEditor = function() {
    document.getElementById('editorBackdrop').classList.remove('active');
    document.getElementById('editorPanel').classList.remove('active');
    selectedUser = null;
  };

  // Save user role
  window.saveUserRole = async function() {
    if (!selectedUser) return;

    // Get selected league role
    const selectedLeagueRole = document.querySelector('input[name="leagueRole"]:checked')?.value;
    const linkedTeam = document.getElementById('linkedTeamSelect')?.value || null;

    if (!selectedLeagueRole) {
      showToast('Please select a league role', 'warning');
      return;
    }

    // Validate linked team for players
    if (selectedLeagueRole === 'player' && !linkedTeam) {
      showToast('Please select a primary team for the player', 'warning');
      return;
    }

    try {
      const userRef = doc(db, 'users', selectedUser.id);
      
      // Collect special roles
      const specialRoles = {};
      Object.keys(SPECIAL_ROLES).forEach(key => {
        const checkbox = document.querySelector(`input[name="specialRole_${key}"]`);
        specialRoles[key] = checkbox?.checked || false;
      });

      // Collect team roles from all team dropdowns
      // IMPORTANT: Use capitalized team IDs to match existing data format
      const teamRoles = {};
      let hasCaptainRole = false;
      let firstCaptainTeam = null;
      
      // First, preserve any existing teamRoles with their original casing
      // but mark them for potential update
      const existingTeamRoles = selectedUser.teamRoles || {};
      
      teams.forEach(team => {
        const select = document.querySelector(`select[name="teamRole_${team.id}"]`);
        if (select) {
          const selectedTeamRole = select.value;
          const teamKey = capitalize(team.id); // Use capitalized key for consistency
          
          if (selectedTeamRole === 'none') {
            // Mark as inactive if previously had a role
            // Check both capitalized and lowercase versions
            const existingRole = existingTeamRoles[teamKey] || existingTeamRoles[team.id];
            if (existingRole) {
              teamRoles[teamKey] = {
                ...existingRole,
                status: 'removed',
                removedBy: currentUser.uid,
                removedAt: new Date().toISOString()
              };
            }
          } else {
            // Add or update team role with capitalized key
            const existingRole = existingTeamRoles[teamKey] || existingTeamRoles[team.id];
            teamRoles[teamKey] = {
              ...(existingRole || {}),
              role: selectedTeamRole,
              status: 'active',
              approvedBy: currentUser.uid,
              approvedAt: new Date().toISOString()
            };
            
            // Track if any captain roles
            if (selectedTeamRole === 'captain') {
              hasCaptainRole = true;
              if (!firstCaptainTeam) firstCaptainTeam = teamKey;
            }
          }
        }
      });

      // Build update object
      const updates = {
        userRole: selectedLeagueRole,
        teamRoles: teamRoles,
        specialRoles: specialRoles,
        roleUpdatedBy: currentUser.uid,
        roleUpdatedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      // Set linkedTeam (capitalized for consistency)
      if (selectedLeagueRole === 'player' && linkedTeam) {
        updates.linkedTeam = capitalize(linkedTeam);
      } else if (firstCaptainTeam) {
        // If they're a captain, use first captain team as linkedTeam (already capitalized)
        updates.linkedTeam = firstCaptainTeam;
      } else {
        // Preserve existing linkedTeam, capitalizing if present
        updates.linkedTeam = selectedUser.linkedTeam ? capitalize(selectedUser.linkedTeam) : null;
      }

      // Handle isCaptain flag for backward compatibility
      // Set to true if user is captain of ANY team
      updates.isCaptain = hasCaptainRole;

      // Handle admin flag
      if (selectedLeagueRole === 'admin') {
        updates.isAdmin = true;
      } else {
        updates.isAdmin = false;
      }

      console.log('üìù Saving user role updates:', {
        userId: selectedUser.id,
        leagueRole: selectedLeagueRole,
        linkedTeam: updates.linkedTeam,
        teamRoles: teamRoles,
        isCaptain: hasCaptainRole,
        isAdmin: selectedLeagueRole === 'admin'
      });

      await updateDoc(userRef, updates);

      showToast(`Roles updated for ${selectedUser.displayName || selectedUser.email}`, 'success');
      closeEditor();
      await loadUsers();

    } catch (error) {
      console.error('‚ùå Error saving role:', error);
      showToast('Error saving role: ' + error.message, 'error');
    }
  };

  // Refresh users
  window.refreshUsers = async function() {
    showToast('Refreshing user list...', 'info');
    await loadUsers();
    showToast('User list refreshed', 'success');
  };

  // Utility functions
  function capitalize(str) {
    if (!str) return '';
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  function showToast(message, type = 'success') {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = { success: '‚úî', error: '‚úñ', warning: '‚ö†', info: '‚Ñπ' };
    toast.innerHTML = `<span>${icons[type] || '‚Ä¢'}</span> ${message}`;
    
    container.appendChild(toast);
    
    setTimeout(() => {
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Make showToast globally available
  window.showToast = showToast;
</script>

<script src="team-colors.js"></script>
<script src="mobile-enhancements.js"></script>
</body>
</html>
