<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="/manifest.json">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Season Setup Wizard - Mountainside Aces</title>
  <meta name="theme-color" content="#2d5016">
  <style>
    :root {
      --primary-color: #2d5016;
      --secondary-color: #1a6b4a;
      --accent-color: #ffd700;
      --card-bg: #ffffff;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
      --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
      --success-color: #22c55e;
      --error-color: #ef4444;
      --warning-color: #f59e0b;
      --info-color: #3b82f6;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      min-height: 100vh;
      color: var(--text-dark);
    }

    /* Header */
    .header {
      background: linear-gradient(135deg, #2d5016 0%, #1a6b4a 100%);
      padding: 2rem;
      color: white;
      text-align: center;
    }

    .header h1 {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      opacity: 0.9;
    }

    /* Container */
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2rem;
    }

    /* Progress Steps */
    .progress-container {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow-sm);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 40px;
      right: 40px;
      height: 4px;
      background: var(--border-color);
      z-index: 0;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 1;
      flex: 1;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--border-color);
      color: var(--text-light);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      margin-bottom: 0.5rem;
      transition: all 0.3s ease;
    }

    .step.active .step-number {
      background: var(--primary-color);
      color: white;
    }

    .step.completed .step-number {
      background: var(--success-color);
      color: white;
    }

    .step-label {
      font-size: 0.85rem;
      color: var(--text-light);
      text-align: center;
    }

    .step.active .step-label {
      color: var(--primary-color);
      font-weight: 600;
    }

    /* Card */
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-md);
      margin-bottom: 1.5rem;
    }

    .card h2 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .card p {
      color: var(--text-light);
      margin-bottom: 1.5rem;
    }

    /* Form Elements */
    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--text-dark);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      transition: border-color 0.2s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--secondary-color);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .form-hint {
      font-size: 0.85rem;
      color: var(--text-light);
      margin-top: 0.25rem;
    }

    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #1a3a0d;
    }

    .btn-secondary {
      background: var(--border-color);
      color: var(--text-dark);
    }

    .btn-secondary:hover {
      background: #cbd5e0;
    }

    .btn-success {
      background: var(--success-color);
      color: white;
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      justify-content: space-between;
      margin-top: 2rem;
    }

    /* Team Selection */
    .team-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }

    .team-card {
      background: #f7fafc;
      border: 2px solid var(--border-color);
      border-radius: 12px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .team-card:hover {
      border-color: var(--secondary-color);
    }

    .team-card.selected {
      border-color: var(--primary-color);
      background: #f0fdf4;
    }

    .team-card .team-emoji {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }

    .team-card .team-name {
      font-weight: 600;
    }

    .team-card .team-check {
      color: var(--success-color);
      font-size: 1.2rem;
      margin-top: 0.5rem;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .team-card.selected .team-check {
      opacity: 1;
    }

    /* CSV Upload */
    .upload-area {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 1rem;
    }

    .upload-area:hover {
      border-color: var(--secondary-color);
      background: #f7fafc;
    }

    .upload-area.dragover {
      border-color: var(--primary-color);
      background: #f0fdf4;
    }

    .upload-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    /* Schedule Preview */
    .schedule-preview {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    .schedule-preview table {
      width: 100%;
      border-collapse: collapse;
    }

    .schedule-preview th {
      background: var(--primary-color);
      color: white;
      padding: 0.75rem;
      text-align: left;
      position: sticky;
      top: 0;
    }

    .schedule-preview td {
      padding: 0.75rem;
      border-bottom: 1px solid var(--border-color);
    }

    .schedule-preview tr:hover {
      background: #f7fafc;
    }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }

    .stat-card {
      background: #f7fafc;
      border-radius: 8px;
      padding: 1rem;
      text-align: center;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary-color);
    }

    .stat-label {
      font-size: 0.85rem;
      color: var(--text-light);
    }

    /* Alerts */
    .alert {
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
    }

    .alert.success {
      background: #f0fdf4;
      border: 1px solid var(--success-color);
      color: #166534;
    }

    .alert.error {
      background: #fef2f2;
      border: 1px solid var(--error-color);
      color: #991b1b;
    }

    .alert.warning {
      background: #fffbeb;
      border: 1px solid var(--warning-color);
      color: #92400e;
    }

    .alert.info {
      background: #eff6ff;
      border: 1px solid var(--info-color);
      color: #1e40af;
    }

    /* Summary Section */
    .summary-section {
      background: #f7fafc;
      border-radius: 12px;
      padding: 1.5rem;
      margin: 1rem 0;
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .summary-label {
      color: var(--text-light);
    }

    .summary-value {
      font-weight: 600;
    }

    /* Hidden */
    .hidden {
      display: none !important;
    }

    /* Checkbox group */
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 0.5rem;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    /* Spinner */
    .spinner {
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .progress-steps {
        flex-wrap: wrap;
        gap: 1rem;
      }

      .progress-steps::before {
        display: none;
      }

      .step {
        flex: 0 0 calc(33% - 1rem);
      }

      .btn-group {
        flex-direction: column;
      }
    }
  </style>
  <link rel="stylesheet" href="mobile-enhancements.css">
</head>
<body>
  <header class="header">
    <h1>üèÜ Season Setup Wizard</h1>
    <p>Create a new season for Mountainside Aces</p>
  </header>

  <div class="container">
    <!-- Auth Check -->
    <div id="authCheck" class="card">
      <div style="text-align: center; padding: 2rem;">
        <div class="spinner" style="font-size: 2rem;">‚öæ</div>
        <p style="margin-top: 1rem;">Checking authentication...</p>
      </div>
    </div>

    <div id="notAuthorized" class="card hidden">
      <div class="alert error">
        <strong>‚ö†Ô∏è Not Authorized</strong>
        <p>You must be signed in as an Admin or League Staff to create new seasons.</p>
      </div>
      <a href="signin.html" class="btn btn-primary">Sign In</a>
    </div>

    <!-- Main Wizard Content -->
    <div id="wizardContent" class="hidden">
      <!-- Progress Steps -->
      <div class="progress-container">
        <div class="progress-steps">
          <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-label">Season Info</div>
          </div>
          <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-label">Teams</div>
          </div>
          <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-label">Schedule</div>
          </div>
          <div class="step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-label">Review</div>
          </div>
          <div class="step" data-step="5">
            <div class="step-number">5</div>
            <div class="step-label">Publish</div>
          </div>
        </div>
      </div>

      <!-- Step 1: Season Info -->
      <div id="step1" class="card step-content">
        <h2>üìã Step 1: Season Information</h2>
        <p>Define the basic details for your new season.</p>

        <div class="form-row">
          <div class="form-group">
            <label for="seasonYear">Year</label>
            <select id="seasonYear">
              <option value="2026">2026</option>
              <option value="2027">2027</option>
              <option value="2028">2028</option>
            </select>
          </div>
          <div class="form-group">
            <label for="seasonType">Season Type</label>
            <select id="seasonType">
              <option value="">-- Select --</option>
              <option value="summer">Summer</option>
              <option value="fall">Fall</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label for="seasonName">Display Name (Optional)</label>
          <input type="text" id="seasonName" placeholder="e.g., 2026 Summer Season">
          <div class="form-hint">Leave blank to auto-generate from year and type</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="startDate">Season Start Date</label>
            <input type="date" id="startDate">
          </div>
          <div class="form-group">
            <label for="endDate">Season End Date (Estimated)</label>
            <input type="date" id="endDate">
          </div>
        </div>

        <div class="form-group">
          <label for="defaultLocation">Default Field Location</label>
          <select id="defaultLocation">
            <option value="Field of Dreams">Field of Dreams (Summer)</option>
            <option value="Deerfield School">Deerfield School (Fall)</option>
            <option value="TBD">TBD</option>
          </select>
        </div>

        <div id="seasonInfoPreview" class="summary-section hidden">
          <h4 style="margin-bottom: 1rem;">Season ID Preview</h4>
          <code id="seasonIdPreview" style="font-size: 1.2rem; color: var(--primary-color);"></code>
        </div>

        <div class="btn-group">
          <a href="offseason.html" class="btn btn-secondary">‚Üê Back to Offseason</a>
          <button class="btn btn-primary" onclick="goToStep(2)">Next: Select Teams ‚Üí</button>
        </div>
      </div>

      <!-- Step 2: Teams -->
      <div id="step2" class="card step-content hidden">
        <h2>üë• Step 2: Select Teams</h2>
        <p>Choose which teams will participate in this season.</p>

        <div style="margin-bottom: 1rem;">
          <button class="btn btn-secondary" onclick="selectAllTeams()">‚úì Select All</button>
          <button class="btn btn-secondary" onclick="deselectAllTeams()">‚úó Deselect All</button>
        </div>

        <div class="team-grid" id="teamGrid">
          <div style="text-align: center; padding: 2rem; grid-column: 1/-1;">
            <div class="spinner">‚öæ</div> Loading teams...
          </div>
        </div>

        <div id="teamCount" class="alert info hidden">
          <span id="selectedTeamCount">0</span> teams selected
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(1)">‚Üê Back</button>
          <button class="btn btn-primary" onclick="goToStep(3)" id="step2Next" disabled>Next: Import Schedule ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Schedule -->
      <div id="step3" class="card step-content hidden">
        <h2>üìÖ Step 3: Import Schedule</h2>
        <p>Upload a CSV file with your schedule or generate one automatically.</p>

        <div class="form-group">
          <label>Schedule Source</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="radio" name="scheduleSource" value="csv" checked onchange="toggleScheduleSource()">
              Upload CSV File
            </label>
            <label class="checkbox-item">
              <input type="radio" name="scheduleSource" value="generate" onchange="toggleScheduleSource()">
              Use Schedule Generator
            </label>
          </div>
        </div>

        <!-- CSV Upload -->
        <div id="csvUploadSection">
          <div class="upload-area" id="uploadArea" onclick="document.getElementById('csvFile').click()">
            <div class="upload-icon">üìÑ</div>
            <p><strong>Click to upload</strong> or drag and drop</p>
            <p style="font-size: 0.85rem; color: var(--text-light);">CSV file with columns: date, home, away, time</p>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
          </div>

          <details style="margin-top: 1rem;">
            <summary style="cursor: pointer; font-weight: 600;">üìã CSV Format Example</summary>
            <pre style="background: #f7fafc; padding: 1rem; border-radius: 8px; margin-top: 0.5rem; overflow-x: auto;">date,home,away,time
6/3/2026,White,Blue,6:00 PM
6/3/2026,Orange,Green,7:15 PM
6/3/2026,Red,Purple,8:30 PM</pre>
          </details>
        </div>

        <!-- Generator Link -->
        <div id="generatorSection" class="hidden">
          <div class="alert info">
            <p>The Schedule Generator will help you create a balanced schedule automatically.</p>
            <a href="schedule-generator.html" class="btn btn-primary" style="margin-top: 1rem;" target="_blank">
              Open Schedule Generator ‚Üí
            </a>
          </div>
          <p style="margin-top: 1rem; color: var(--text-light);">
            After generating your schedule, export it to Firebase from the generator, then return here to continue setup.
          </p>
        </div>

        <!-- Schedule Preview -->
        <div id="schedulePreview" class="hidden" style="margin-top: 1.5rem;">
          <h4 style="margin-bottom: 1rem;">üìä Schedule Preview</h4>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="totalGames">0</div>
              <div class="stat-label">Total Games</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="totalWeeks">0</div>
              <div class="stat-label">Weeks</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="gamesPerTeam">0</div>
              <div class="stat-label">Games/Team</div>
            </div>
          </div>

          <div class="schedule-preview">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Home</th>
                  <th>Away</th>
                </tr>
              </thead>
              <tbody id="scheduleTableBody"></tbody>
            </table>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(2)">‚Üê Back</button>
          <button class="btn btn-primary" onclick="goToStep(4)" id="step3Next" disabled>Next: Review ‚Üí</button>
        </div>
      </div>

      <!-- Step 4: Review -->
      <div id="step4" class="card step-content hidden">
        <h2>‚úÖ Step 4: Review & Confirm</h2>
        <p>Review all settings before creating the season.</p>

        <div class="summary-section">
          <h4 style="margin-bottom: 1rem;">Season Details</h4>
          <div class="summary-row">
            <span class="summary-label">Season ID</span>
            <span class="summary-value" id="reviewSeasonId">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Display Name</span>
            <span class="summary-value" id="reviewSeasonName">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Start Date</span>
            <span class="summary-value" id="reviewStartDate">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">End Date</span>
            <span class="summary-value" id="reviewEndDate">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Default Location</span>
            <span class="summary-value" id="reviewLocation">--</span>
          </div>
        </div>

        <div class="summary-section">
          <h4 style="margin-bottom: 1rem;">Teams (<span id="reviewTeamCount">0</span>)</h4>
          <div id="reviewTeamsList"></div>
        </div>

        <div class="summary-section">
          <h4 style="margin-bottom: 1rem;">Schedule</h4>
          <div class="summary-row">
            <span class="summary-label">Total Games</span>
            <span class="summary-value" id="reviewTotalGames">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">First Game</span>
            <span class="summary-value" id="reviewFirstGame">--</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">Last Game</span>
            <span class="summary-value" id="reviewLastGame">--</span>
          </div>
        </div>

        <div class="form-group">
          <label class="checkbox-item">
            <input type="checkbox" id="confirmReview">
            I have reviewed all settings and they are correct
          </label>
        </div>

        <div class="btn-group">
          <button class="btn btn-secondary" onclick="goToStep(3)">‚Üê Back</button>
          <button class="btn btn-success" onclick="goToStep(5)" id="step4Next" disabled>Create Season ‚Üí</button>
        </div>
      </div>

      <!-- Step 5: Publish -->
      <div id="step5" class="card step-content hidden">
        <h2>üöÄ Step 5: Create & Publish</h2>
        <p>Final step - create the season in Firebase.</p>

        <div id="publishStatus">
          <div class="alert warning">
            <strong>‚ö†Ô∏è Important</strong>
            <p>This will create a new season document and import all games. The season will NOT be set as active automatically.</p>
          </div>

          <div class="form-group">
            <label class="checkbox-item">
              <input type="checkbox" id="setActive">
              Set this season as the current active season
            </label>
            <div class="form-hint">This will deactivate any currently active season</div>
          </div>

          <button class="btn btn-success" onclick="createSeason()" id="createSeasonBtn" style="width: 100%; justify-content: center; padding: 1rem;">
            üèÜ Create Season
          </button>
        </div>

        <div id="publishProgress" class="hidden">
          <div style="text-align: center; padding: 2rem;">
            <div class="spinner" style="font-size: 3rem;">‚öæ</div>
            <p style="margin-top: 1rem;" id="progressText">Creating season...</p>
          </div>
        </div>

        <div id="publishSuccess" class="hidden">
          <div class="alert success">
            <strong>‚úÖ Season Created Successfully!</strong>
            <p id="successMessage"></p>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-value" id="finalGamesCreated">0</div>
              <div class="stat-label">Games Created</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="finalTeamsSetup">0</div>
              <div class="stat-label">Teams Setup</div>
            </div>
          </div>

          <h4 style="margin: 1.5rem 0 1rem;">Next Steps</h4>
          <ul style="margin-left: 1.5rem; color: var(--text-light);">
            <li>Review the schedule in <a href="current-season.html">Current Season</a></li>
            <li>Set up team rosters in <a href="offseason-roster.html">Roster Management</a></li>
            <li>Announce the season to players</li>
          </ul>

          <div class="btn-group" style="margin-top: 2rem;">
            <a href="offseason.html" class="btn btn-secondary">‚Üê Back to Offseason Hub</a>
            <a href="current-season.html" class="btn btn-primary">View Season ‚Üí</a>
          </div>
        </div>

        <div id="publishError" class="hidden">
          <div class="alert error">
            <strong>‚ùå Error Creating Season</strong>
            <p id="errorMessage"></p>
          </div>
          <button class="btn btn-secondary" onclick="goToStep(4)">‚Üê Back to Review</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, collection, doc, getDocs, getDoc } from './firebase-config.js';
    import { 
      setDoc, 
      addDoc, 
      updateDoc,
      writeBatch,
      serverTimestamp,
      query,
      where
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getUserProfile, USER_ROLES } from './firebase-auth.js';

    const auth = getAuth();

    // State
    let currentStep = 1;
    let currentUser = null;
    let allTeams = [];
    let selectedTeams = [];
    let scheduleData = [];
    
    const seasonConfig = {
      year: 2026,
      type: '',
      name: '',
      startDate: '',
      endDate: '',
      location: 'Field of Dreams'
    };

    // Auth check
    onAuthStateChanged(auth, async (user) => {
      document.getElementById('authCheck').classList.add('hidden');
      
      if (!user) {
        document.getElementById('notAuthorized').classList.remove('hidden');
        return;
      }

      currentUser = user;
      
      // Check if admin or league staff
      const profileResult = await getUserProfile(user.uid);
      const userRole = profileResult.success ? profileResult.data.userRole : null;
      
      if (userRole !== USER_ROLES.ADMIN && userRole !== USER_ROLES.LEAGUE_STAFF) {
        document.getElementById('notAuthorized').classList.remove('hidden');
        return;
      }

      // Show wizard
      document.getElementById('wizardContent').classList.remove('hidden');
      await loadTeams();
      setupEventListeners();
    });

    // Load teams from Firebase
    async function loadTeams() {
      try {
        const teamsSnapshot = await getDocs(collection(db, 'teams'));
        allTeams = [];
        teamsSnapshot.forEach(doc => {
          allTeams.push({ id: doc.id, ...doc.data() });
        });

        // Sort alphabetically
        allTeams.sort((a, b) => (a.name || a.id).localeCompare(b.name || b.id));

        renderTeamGrid();
      } catch (error) {
        console.error('Error loading teams:', error);
      }
    }

    function renderTeamGrid() {
      const grid = document.getElementById('teamGrid');
      const teamEmojis = {
        'White': '‚ö™', 'Blue': 'üîµ', 'Orange': 'üü†', 'Green': 'üü¢',
        'Red': 'üî¥', 'Purple': 'üü£', 'Yellow': 'üü°', 'Black': '‚ö´',
        'Gray': '‚¨ú', 'Pink': 'ü©∑'
      };

      grid.innerHTML = allTeams.map(team => {
        const name = team.name || team.id;
        const emoji = teamEmojis[name] || '‚öæ';
        return `
          <div class="team-card" data-team-id="${team.id}" onclick="toggleTeam('${team.id}')">
            <div class="team-emoji">${emoji}</div>
            <div class="team-name">${name}</div>
            <div class="team-check">‚úì</div>
          </div>
        `;
      }).join('');
    }

    window.toggleTeam = function(teamId) {
      const card = document.querySelector(`.team-card[data-team-id="${teamId}"]`);
      const index = selectedTeams.indexOf(teamId);
      
      if (index > -1) {
        selectedTeams.splice(index, 1);
        card.classList.remove('selected');
      } else {
        selectedTeams.push(teamId);
        card.classList.add('selected');
      }

      updateTeamCount();
    };

    window.selectAllTeams = function() {
      selectedTeams = allTeams.map(t => t.id);
      document.querySelectorAll('.team-card').forEach(card => card.classList.add('selected'));
      updateTeamCount();
    };

    window.deselectAllTeams = function() {
      selectedTeams = [];
      document.querySelectorAll('.team-card').forEach(card => card.classList.remove('selected'));
      updateTeamCount();
    };

    function updateTeamCount() {
      const countDiv = document.getElementById('teamCount');
      const countSpan = document.getElementById('selectedTeamCount');
      const nextBtn = document.getElementById('step2Next');

      countSpan.textContent = selectedTeams.length;
      countDiv.classList.remove('hidden');
      nextBtn.disabled = selectedTeams.length < 4;
    }

    // Event listeners
    function setupEventListeners() {
      document.getElementById('seasonYear').addEventListener('change', updateSeasonPreview);
      document.getElementById('seasonType').addEventListener('change', updateSeasonPreview);
      document.getElementById('seasonName').addEventListener('input', updateSeasonPreview);
      document.getElementById('startDate').addEventListener('change', updateSeasonPreview);
      document.getElementById('endDate').addEventListener('change', updateSeasonPreview);
      document.getElementById('defaultLocation').addEventListener('change', updateSeasonPreview);
      
      document.getElementById('confirmReview').addEventListener('change', (e) => {
        document.getElementById('step4Next').disabled = !e.target.checked;
      });

      // Drag and drop
      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
      });
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
      });
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file) handleCSVFile(file);
      });
    }

    function updateSeasonPreview() {
      seasonConfig.year = parseInt(document.getElementById('seasonYear').value);
      seasonConfig.type = document.getElementById('seasonType').value;
      seasonConfig.name = document.getElementById('seasonName').value;
      seasonConfig.startDate = document.getElementById('startDate').value;
      seasonConfig.endDate = document.getElementById('endDate').value;
      seasonConfig.location = document.getElementById('defaultLocation').value;

      if (seasonConfig.type) {
        const seasonId = `${seasonConfig.year}-${seasonConfig.type}`;
        document.getElementById('seasonIdPreview').textContent = seasonId;
        document.getElementById('seasonInfoPreview').classList.remove('hidden');

        // Auto-set default location based on season type
        if (seasonConfig.type === 'summer') {
          document.getElementById('defaultLocation').value = 'Field of Dreams';
        } else if (seasonConfig.type === 'fall') {
          document.getElementById('defaultLocation').value = 'Deerfield School';
        }
      }
    }

    window.toggleScheduleSource = function() {
      const source = document.querySelector('input[name="scheduleSource"]:checked').value;
      document.getElementById('csvUploadSection').classList.toggle('hidden', source !== 'csv');
      document.getElementById('generatorSection').classList.toggle('hidden', source !== 'generate');
    };

    window.handleCSVUpload = function(event) {
      const file = event.target.files[0];
      if (file) handleCSVFile(file);
    };

    async function handleCSVFile(file) {
      try {
        const text = await file.text();
        const lines = text.split('\n').map(line => line.trim()).filter(line => line);
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        scheduleData = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const game = {};
          headers.forEach((header, i) => {
            game[header] = values[i];
          });
          return {
            date: game.date,
            time: game.time || game['game time'] || 'TBD',
            home: game.home || game['home team'],
            away: game.away || game['away team']
          };
        }).filter(g => g.date && g.home && g.away);

        // Sort by date
        scheduleData.sort((a, b) => new Date(a.date) - new Date(b.date));

        // Display preview
        displaySchedulePreview();
        document.getElementById('step3Next').disabled = false;

      } catch (error) {
        console.error('Error parsing CSV:', error);
        alert('Error parsing CSV file. Please check the format.');
      }
    }

    function displaySchedulePreview() {
      document.getElementById('schedulePreview').classList.remove('hidden');
      
      // Stats
      document.getElementById('totalGames').textContent = scheduleData.length;
      
      const uniqueDates = [...new Set(scheduleData.map(g => g.date))];
      document.getElementById('totalWeeks').textContent = Math.ceil(uniqueDates.length / 7);
      
      const teamsInSchedule = new Set();
      scheduleData.forEach(g => {
        teamsInSchedule.add(g.home);
        teamsInSchedule.add(g.away);
      });
      const gamesPerTeam = Math.round(scheduleData.length * 2 / teamsInSchedule.size);
      document.getElementById('gamesPerTeam').textContent = gamesPerTeam;

      // Table
      const tbody = document.getElementById('scheduleTableBody');
      tbody.innerHTML = scheduleData.slice(0, 50).map(game => `
        <tr>
          <td>${new Date(game.date).toLocaleDateString()}</td>
          <td>${game.time}</td>
          <td><strong>${game.home}</strong></td>
          <td>${game.away}</td>
        </tr>
      `).join('');

      if (scheduleData.length > 50) {
        tbody.innerHTML += `<tr><td colspan="4" style="text-align: center; color: var(--text-light);">... and ${scheduleData.length - 50} more games</td></tr>`;
      }
    }

    // Navigation
    window.goToStep = function(step) {
      // Validate current step before proceeding
      if (step > currentStep) {
        if (!validateStep(currentStep)) return;
      }

      // Update step
      currentStep = step;

      // Update progress indicator
      document.querySelectorAll('.step').forEach((el, i) => {
        const stepNum = i + 1;
        el.classList.remove('active', 'completed');
        if (stepNum < currentStep) el.classList.add('completed');
        if (stepNum === currentStep) el.classList.add('active');
      });

      // Show/hide step content
      document.querySelectorAll('.step-content').forEach((el, i) => {
        el.classList.toggle('hidden', i + 1 !== currentStep);
      });

      // Populate review if step 4
      if (currentStep === 4) {
        populateReview();
      }
    };

    function validateStep(step) {
      switch(step) {
        case 1:
          if (!seasonConfig.type) {
            alert('Please select a season type');
            return false;
          }
          if (!seasonConfig.startDate) {
            alert('Please select a start date');
            return false;
          }
          return true;
        case 2:
          if (selectedTeams.length < 4) {
            alert('Please select at least 4 teams');
            return false;
          }
          return true;
        case 3:
          if (scheduleData.length === 0) {
            alert('Please upload a schedule');
            return false;
          }
          return true;
        case 4:
          if (!document.getElementById('confirmReview').checked) {
            alert('Please confirm you have reviewed the settings');
            return false;
          }
          return true;
        default:
          return true;
      }
    }

    function populateReview() {
      const seasonId = `${seasonConfig.year}-${seasonConfig.type}`;
      const displayName = seasonConfig.name || `${seasonConfig.year} ${seasonConfig.type.charAt(0).toUpperCase() + seasonConfig.type.slice(1)}`;

      document.getElementById('reviewSeasonId').textContent = seasonId;
      document.getElementById('reviewSeasonName').textContent = displayName;
      document.getElementById('reviewStartDate').textContent = new Date(seasonConfig.startDate).toLocaleDateString();
      document.getElementById('reviewEndDate').textContent = seasonConfig.endDate ? new Date(seasonConfig.endDate).toLocaleDateString() : 'TBD';
      document.getElementById('reviewLocation').textContent = seasonConfig.location;

      document.getElementById('reviewTeamCount').textContent = selectedTeams.length;
      document.getElementById('reviewTeamsList').textContent = selectedTeams.join(', ');

      document.getElementById('reviewTotalGames').textContent = scheduleData.length;
      if (scheduleData.length > 0) {
        document.getElementById('reviewFirstGame').textContent = new Date(scheduleData[0].date).toLocaleDateString();
        document.getElementById('reviewLastGame').textContent = new Date(scheduleData[scheduleData.length - 1].date).toLocaleDateString();
      }
    }

    // Create season
    window.createSeason = async function() {
      const createBtn = document.getElementById('createSeasonBtn');
      createBtn.disabled = true;

      document.getElementById('publishStatus').classList.add('hidden');
      document.getElementById('publishProgress').classList.remove('hidden');

      try {
        const seasonId = `${seasonConfig.year}-${seasonConfig.type}`;
        const displayName = seasonConfig.name || `${seasonConfig.year} ${seasonConfig.type.charAt(0).toUpperCase() + seasonConfig.type.slice(1)}`;
        const setActive = document.getElementById('setActive').checked;

        // Step 1: Create season document
        document.getElementById('progressText').textContent = 'Creating season document...';
        
        const seasonDoc = {
          year: seasonConfig.year,
          season: seasonConfig.type,
          name: displayName,
          startDate: new Date(seasonConfig.startDate),
          endDate: seasonConfig.endDate ? new Date(seasonConfig.endDate) : null,
          defaultLocation: seasonConfig.location,
          teams: selectedTeams,
          isActive: setActive,
          playoffFormat: seasonConfig.type === 'fall' ? 'single-elimination' : 'double-elimination',
          gamesPerTeam: Math.round(scheduleData.length * 2 / selectedTeams.length),
          createdAt: serverTimestamp(),
          createdBy: currentUser.uid
        };

        // If setting as active, deactivate other seasons first
        if (setActive) {
          document.getElementById('progressText').textContent = 'Deactivating previous season...';
          const activeQuery = query(collection(db, 'seasons'), where('isActive', '==', true));
          const activeSnapshot = await getDocs(activeQuery);
          
          for (const activeDoc of activeSnapshot.docs) {
            await updateDoc(doc(db, 'seasons', activeDoc.id), { isActive: false });
          }
        }

        await setDoc(doc(db, 'seasons', seasonId), seasonDoc);
        console.log('‚úÖ Season document created:', seasonId);

        // Step 2: Create games
        document.getElementById('progressText').textContent = 'Creating games (0/' + scheduleData.length + ')...';
        
        const batch = writeBatch(db);
        let gameCount = 0;

        for (const game of scheduleData) {
          const gameDate = new Date(game.date);
          const homeTeam = game.home;
          const awayTeam = game.away;
          
          // Generate game ID
          const dateStr = `${gameDate.getMonth() + 1}_${gameDate.getDate()}_${gameDate.getFullYear()}`;
          const gameId = `${dateStr}_${homeTeam.toLowerCase()}_vs_${awayTeam.toLowerCase()}`.replace(/\s+/g, '_');

          const gameDoc = {
            date: gameDate,
            time: game.time,
            homeTeam: homeTeam,
            homeTeamId: homeTeam,
            homeTeamName: homeTeam,
            awayTeam: awayTeam,
            awayTeamId: awayTeam,
            awayTeamName: awayTeam,
            location: seasonConfig.location,
            gameType: 'Regular',
            game_type: 'Regular',
            homeScore: null,
            awayScore: null,
            winner: null,
            status: 'scheduled',
            createdAt: serverTimestamp()
          };

          const gameRef = doc(db, 'seasons', seasonId, 'games', gameId);
          batch.set(gameRef, gameDoc);
          
          gameCount++;
          if (gameCount % 10 === 0) {
            document.getElementById('progressText').textContent = `Creating games (${gameCount}/${scheduleData.length})...`;
          }
        }

        await batch.commit();
        console.log('‚úÖ Games created:', gameCount);

        // Success!
        document.getElementById('publishProgress').classList.add('hidden');
        document.getElementById('publishSuccess').classList.remove('hidden');
        
        document.getElementById('successMessage').textContent = 
          `Season "${displayName}" has been created with ${gameCount} games.` +
          (setActive ? ' It is now the active season.' : '');
        
        document.getElementById('finalGamesCreated').textContent = gameCount;
        document.getElementById('finalTeamsSetup').textContent = selectedTeams.length;

      } catch (error) {
        console.error('Error creating season:', error);
        document.getElementById('publishProgress').classList.add('hidden');
        document.getElementById('publishError').classList.remove('hidden');
        document.getElementById('errorMessage').textContent = error.message;
      }
    };
  </script>
  <script src="mobile-enhancements.js"></script>
</body>
</html>
