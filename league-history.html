<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>League History - Mountainside Aces</title>
<meta name="theme-color" content="#2d5016">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="stylesheet" href="mobile-enhancements.css">
<link rel="stylesheet" href="nav-styles.css">
<style>
:root {
  --primary-color: #2d5016;
  --secondary-color: #1a6b4a;
  --accent-color: #ffd700;
  --card-bg: #ffffff;
  --text-dark: #2d3748;
  --text-light: #718096;
  --border-color: #e2e8f0;
  --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.12);
  --shadow-lg: 0 12px 32px rgba(0,0,0,0.16);
  
  /* Team Colors from team-colors.js */
  --team-black: #1a1a1a;
  --team-green: #2d7d32;
  --team-red: #d32f2f;
  --team-blue: #1976d2;
  --team-white: #ffffff;
  --team-orange: #f57c00;
  --team-silver: #757575;
  --team-purple: #7b1fa2;
  --team-gold: #CFB53B;
  --team-carolina: #4b9cd3;
  --team-army: #654321;
}

* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
  min-height: 100vh;
  line-height: 1.6;
  color: var(--text-dark);
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: opacity 0.5s ease, visibility 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  visibility: hidden;
}

.softball-spinner {
  position: relative;
}

.softball-spinner::before {
  content: 'üìú';
  font-size: 80px;
  animation: spin 1.5s ease-in-out infinite;
  display: block;
}

@keyframes spin {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

/* Page Container */
.page-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 2rem;
}

/* Page Header */
.page-header {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  text-align: center;
  padding: 4rem 2rem;
  border-radius: 16px;
  margin-bottom: 2rem;
  box-shadow: var(--shadow-lg);
  position: relative;
  overflow: hidden;
}

.page-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--accent-color) 0%, #ffed4e 100%);
}

.page-header h1 {
  font-size: 3.5rem;
  margin: 0;
  font-weight: 800;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  letter-spacing: -0.5px;
}

.page-header p {
  font-size: 1.3rem;
  margin: 1rem 0 0;
  opacity: 0.95;
  font-weight: 400;
}

/* Chart Container */
.chart-container {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2.5rem;
  box-shadow: var(--shadow-md);
  margin-bottom: 2rem;
}

.chart-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0 0 1.5rem 0;
  text-align: center;
}

.chart-subtitle {
  font-size: 1rem;
  color: var(--text-light);
  text-align: center;
  margin: -1rem 0 2rem 0;
}

/* Chart SVG Container */
.chart-svg-container {
  width: 100%;
  overflow-x: auto;
  overflow-y: visible;
  margin-bottom: 1.5rem;
}

.chart-svg {
  display: block;
  margin: 0 auto;
}

/* Timeline Container */
.timeline-container {
  background: var(--card-bg);
  border-radius: 16px;
  padding: 2.5rem;
  box-shadow: var(--shadow-md);
  margin-bottom: 2rem;
}

.timeline-title {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text-dark);
  margin: 0 0 2rem 0;
  text-align: center;
}

.timeline {
  position: relative;
  max-width: 900px;
  margin: 0 auto;
}

.timeline-item {
  display: flex;
  gap: 2rem;
  margin-bottom: 2rem;
  position: relative;
}

.timeline-item::before {
  content: '';
  position: absolute;
  left: 47px;
  top: 50px;
  width: 2px;
  height: calc(100% + 2rem);
  background: var(--border-color);
}

.timeline-item:last-child::before {
  display: none;
}

.timeline-marker {
  flex-shrink: 0;
  width: 96px;
  height: 96px;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 1rem;
  box-shadow: var(--shadow-md);
  z-index: 1;
  text-align: center;
  line-height: 1.3;
  padding: 0.5rem;
}

.timeline-content {
  flex: 1;
  background: #f8f9fa;
  padding: 1.5rem;
  border-radius: 12px;
  border-left: 4px solid var(--primary-color);
}

.timeline-season {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--primary-color);
  margin: 0 0 0.5rem 0;
}

.timeline-teams {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.team-badge {
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: 600;
  color: white !important;
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Special styling for light-colored teams */
.team-badge.light-team {
  color: #333 !important;
  border: 2px solid #999;
  text-shadow: none;
}

.team-badge.new {
  position: relative;
}

.team-badge.new::after {
  content: '‚ú®';
  font-size: 0.8rem;
}

/* Legend */
.legend-container {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  justify-content: center;
  padding: 1.5rem;
  background: #f8f9fa;
  border-radius: 12px;
  margin-top: 1.5rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-color {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.legend-label {
  font-size: 0.95rem;
  font-weight: 600;
  color: var(--text-dark);
}

/* Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1.5rem;
  margin-top: 2rem;
}

.stat-card {
  background: var(--card-bg);
  border-radius: 12px;
  padding: 1.5rem;
  box-shadow: var(--shadow-sm);
  border-left: 4px solid var(--primary-color);
}

.stat-label {
  font-size: 0.9rem;
  color: var(--text-light);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 2.5rem;
  font-weight: 800;
  color: var(--primary-color);
  line-height: 1;
}

.stat-detail {
  font-size: 0.85rem;
  color: var(--text-light);
  margin-top: 0.5rem;
}

/* Responsive */
@media (max-width: 768px) {
  .page-container {
    padding: 1rem;
  }
  
  .page-header {
    padding: 2rem 1rem;
  }
  
  .page-header h1 {
    font-size: 2.5rem;
  }
  
  .chart-container,
  .timeline-container {
    padding: 1.5rem;
  }
  
  .timeline-item {
    flex-direction: column;
    gap: 1rem;
  }
  
  .timeline-item::before {
    display: none;
  }
  
  .timeline-marker {
    width: 80px;
    height: 80px;
    font-size: 0.9rem;
  }
  
  .stats-grid {
    grid-template-columns: 1fr;
  }
}
</style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="softball-spinner"></div>
</div>

<!-- Navigation -->
<nav id="mainNavigation"></nav>

<div class="page-container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>üèÜ League History</h1>
    <p>The Evolution of Mountainside Aces Softball</p>
  </div>

  <!-- Chart Container -->
  <div class="chart-container">
    <h2 class="chart-title">League Growth Timeline</h2>
    <p class="chart-subtitle">Stacked bar chart showing teams active in each season</p>
    
    <div class="chart-svg-container">
      <svg class="chart-svg" id="historyChart" width="1200" height="500"></svg>
    </div>

    <!-- Legend -->
    <div class="legend-container" id="legendContainer"></div>
  </div>

  <!-- Summary Stats -->
  <div class="chart-container">
    <h2 class="chart-title">League Milestones</h2>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Seasons</div>
        <div class="stat-value" id="totalSeasons">‚Äî</div>
        <div class="stat-detail">Since league inception</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Teams</div>
        <div class="stat-value" id="totalTeams">‚Äî</div>
        <div class="stat-detail">All-time Aces teams</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Current Teams</div>
        <div class="stat-value" id="currentTeams">‚Äî</div>
        <div class="stat-detail">Active in latest season</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Peak Season</div>
        <div class="stat-value" id="peakSeason">‚Äî</div>
        <div class="stat-detail">Most teams simultaneously</div>
      </div>
    </div>
  </div>

  <!-- Timeline -->
  <div class="timeline-container">
    <h2 class="timeline-title">Season-by-Season Timeline</h2>
    <div class="timeline" id="timelineContainer"></div>
  </div>
</div>

<script type="module">
import { getAllSeasons, getSeasonGames } from './firebase-data.js';

// Team color mapping from team-colors.js
const teamColors = {
  'Green': '#2d7d32',
  'Gold': '#CFB53B',
  'White': '#ffffff',
  'Blue': '#1976d2',
  'Black': '#1a1a1a',
  'Red': '#d32f2f',
  'Silver': '#757575',
  'Orange': '#f57c00',
  'Purple': '#7b1fa2',
  'Army': '#654321',
  'Carolina': '#4b9cd3'
};

// Valid Aces color teams only
const validAcesTeams = ['Green', 'Gold', 'White', 'Blue', 'Black', 'Red', 'Silver', 'Orange', 'Purple', 'Army', 'Carolina'];

let seasonHistory = [];

// Hide loading overlay
window.addEventListener('load', function() {
  setTimeout(function() {
    document.getElementById('loadingOverlay').classList.add('hidden');
  }, 800);
});

// Capitalize team name
function capitalize(str) {
  if (!str) return '';
  return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
}

// Load seasons and build history from Firebase
async function loadSeasonHistory() {
  try {
    console.log('üìä Loading seasons from Firebase...');
    
    const seasons = await getAllSeasons();
    console.log(`‚úÖ Found ${seasons.length} seasons`);
    
    // Sort seasons chronologically
    seasons.sort((a, b) => {
      if (a.year !== b.year) return a.year - b.year;
      // Summer comes before Fall
      if (a.season.toLowerCase() === 'summer' && b.season.toLowerCase() === 'fall') return -1;
      if (a.season.toLowerCase() === 'fall' && b.season.toLowerCase() === 'summer') return 1;
      return 0;
    });
    
    // Load teams for each season
    for (const season of seasons) {
      const games = await getSeasonGames(season.id);
      const teamsSet = new Set();
      
      // Extract unique teams from games
      games.forEach(game => {
        const homeTeam = capitalize(game.homeTeamName || game.homeTeamId || '');
        const awayTeam = capitalize(game.awayTeamName || game.awayTeamId || '');
        
        if (homeTeam && validAcesTeams.includes(homeTeam)) {
          teamsSet.add(homeTeam);
        }
        if (awayTeam && validAcesTeams.includes(awayTeam)) {
          teamsSet.add(awayTeam);
        }
      });
      
      // Convert to array
      const teams = Array.from(teamsSet);
      
      // Create season entry
      const seasonLabel = `${season.year} ${season.season.charAt(0).toUpperCase() + season.season.slice(1)}`;
      
      seasonHistory.push({
        label: seasonLabel,
        year: season.year,
        season: season.season,
        teams: teams,
        seasonId: season.id
      });
      
      console.log(`‚úÖ ${seasonLabel}: ${teams.length} teams - ${teams.join(', ')}`);
    }
    
    console.log(`‚úÖ Built history for ${seasonHistory.length} seasons`);
    
    // Now sort teams within each season by longevity (most seasons = bottom of stack)
    seasonHistory.forEach((season, seasonIndex) => {
      // Count how many seasons each team has been in up to this point
      const teamSeasonCount = {};
      season.teams.forEach(team => {
        let count = 0;
        // Count appearances in this and all previous seasons
        for (let i = 0; i <= seasonIndex; i++) {
          if (seasonHistory[i].teams.includes(team)) {
            count++;
          }
        }
        teamSeasonCount[team] = count;
      });
      
      // Sort teams: most seasons at bottom (beginning of array), newest at top (end of array)
      season.teams.sort((a, b) => {
        const countDiff = teamSeasonCount[b] - teamSeasonCount[a];
        if (countDiff !== 0) return countDiff; // More seasons = earlier in array = bottom of stack
        return a.localeCompare(b); // Alphabetical as tiebreaker
      });
    });
    
  } catch (error) {
    console.error('‚ùå Error loading season history:', error);
  }
}

// Generate the stacked bar chart
function generateChart() {
  const svg = document.getElementById('historyChart');
  const width = 1200;
  const height = 500;
  const margin = { top: 40, right: 60, bottom: 80, left: 60 };
  const chartWidth = width - margin.left - margin.right;
  const chartHeight = height - margin.top - margin.bottom;

  // Clear existing content
  svg.innerHTML = '';

  if (seasonHistory.length === 0) {
    return;
  }

  // Calculate bar dimensions
  const barWidth = chartWidth / seasonHistory.length - 10;
  const maxTeams = Math.max(...seasonHistory.map(s => s.teams.length));

  // Create chart group
  const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
  g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
  svg.appendChild(g);

  // Draw bars for each season
  seasonHistory.forEach((season, index) => {
    const x = index * (chartWidth / seasonHistory.length) + 5;
    const teamHeight = chartHeight / maxTeams;

    // Draw stacked segments for each team
    season.teams.forEach((team, teamIndex) => {
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
      const y = chartHeight - (teamIndex + 1) * teamHeight;
      const color = teamColors[team] || '#cccccc';
      
      rect.setAttribute('x', x);
      rect.setAttribute('y', y);
      rect.setAttribute('width', barWidth);
      rect.setAttribute('height', teamHeight);
      rect.setAttribute('fill', color);
      rect.setAttribute('stroke', team === 'White' ? '#999' : 'none');
      rect.setAttribute('stroke-width', team === 'White' ? '2' : '0');
      rect.setAttribute('opacity', '0.9');
      rect.setAttribute('rx', '3');
      
      // Add hover effect
      rect.addEventListener('mouseenter', function() {
        this.setAttribute('opacity', '1');
        this.setAttribute('stroke', '#333');
        this.setAttribute('stroke-width', '2');
      });
      
      rect.addEventListener('mouseleave', function() {
        this.setAttribute('opacity', '0.9');
        this.setAttribute('stroke', team === 'White' ? '#999' : 'none');
        this.setAttribute('stroke-width', team === 'White' ? '2' : '0');
      });
      
      g.appendChild(rect);

      // Add team label inside bar segment (if space allows)
      if (teamHeight > 25) {
        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', x + barWidth / 2);
        text.setAttribute('y', y + teamHeight / 2);
        text.setAttribute('text-anchor', 'middle');
        text.setAttribute('dominant-baseline', 'middle');
        text.setAttribute('fill', team === 'White' || team === 'Gold' ? '#333' : 'white');
        text.setAttribute('font-size', '11');
        text.setAttribute('font-weight', '600');
        text.setAttribute('pointer-events', 'none');
        text.textContent = team;
        g.appendChild(text);
      }
    });

    // Add season label below bar
    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    label.setAttribute('x', x + barWidth / 2);
    label.setAttribute('y', chartHeight + 20);
    label.setAttribute('text-anchor', 'middle');
    label.setAttribute('fill', '#4a5568');
    label.setAttribute('font-size', '12');
    label.setAttribute('font-weight', '600');
    label.textContent = season.label;
    g.appendChild(label);
  });

  // Add Y-axis label
  const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
  yLabel.setAttribute('x', -chartHeight / 2);
  yLabel.setAttribute('y', -40);
  yLabel.setAttribute('text-anchor', 'middle');
  yLabel.setAttribute('transform', `rotate(-90, -${chartHeight / 2}, -40)`);
  yLabel.setAttribute('fill', '#4a5568');
  yLabel.setAttribute('font-size', '14');
  yLabel.setAttribute('font-weight', '600');
  yLabel.textContent = 'Number of Teams';
  svg.appendChild(yLabel);
}

// Generate legend
function generateLegend() {
  const container = document.getElementById('legendContainer');
  container.innerHTML = '';

  // Get all unique teams across all seasons
  const allTeams = new Set();
  seasonHistory.forEach(season => {
    season.teams.forEach(team => allTeams.add(team));
  });

  // Sort teams alphabetically
  const sortedTeams = Array.from(allTeams).sort();

  sortedTeams.forEach(team => {
    const item = document.createElement('div');
    item.className = 'legend-item';

    const colorBox = document.createElement('div');
    colorBox.className = 'legend-color';
    colorBox.style.backgroundColor = teamColors[team] || '#cccccc';
    if (team === 'White') {
      colorBox.style.border = '2px solid #999';
    }

    const label = document.createElement('span');
    label.className = 'legend-label';
    label.textContent = team;

    item.appendChild(colorBox);
    item.appendChild(label);
    container.appendChild(item);
  });
}

// Generate timeline
function generateTimeline() {
  const container = document.getElementById('timelineContainer');
  container.innerHTML = '';

  seasonHistory.forEach((season, index) => {
    const item = document.createElement('div');
    item.className = 'timeline-item';

    // Marker
    const marker = document.createElement('div');
    marker.className = 'timeline-marker';
    marker.innerHTML = `${season.teams.length}<br>Teams`;

    // Content
    const content = document.createElement('div');
    content.className = 'timeline-content';

    const seasonTitle = document.createElement('h3');
    seasonTitle.className = 'timeline-season';
    seasonTitle.textContent = season.label;

    const teamsContainer = document.createElement('div');
    teamsContainer.className = 'timeline-teams';

    season.teams.forEach((team, teamIndex) => {
      const badge = document.createElement('span');
      badge.className = 'team-badge';
      badge.style.backgroundColor = teamColors[team] || '#cccccc';
      
      // Add class for light-colored teams that need dark text
      if (team === 'White' || team === 'Gold') {
        badge.classList.add('light-team');
      }

      // Check if this is a new team
      const isNew = index === 0 || !seasonHistory[index - 1].teams.includes(team);
      if (isNew && index > 0) {
        badge.classList.add('new');
      }

      badge.textContent = team;
      teamsContainer.appendChild(badge);
    });

    content.appendChild(seasonTitle);
    content.appendChild(teamsContainer);

    item.appendChild(marker);
    item.appendChild(content);
    container.appendChild(item);
  });
}

// Generate summary stats
function generateStats() {
  const totalSeasons = seasonHistory.length;
  const allTeamsSet = new Set();
  seasonHistory.forEach(season => {
    season.teams.forEach(team => allTeamsSet.add(team));
  });
  const totalTeams = allTeamsSet.size;
  const currentTeams = seasonHistory[seasonHistory.length - 1]?.teams.length || 0;
  
  // Find peak season
  let peakCount = 0;
  let peakSeasonLabel = '';
  seasonHistory.forEach(season => {
    if (season.teams.length > peakCount) {
      peakCount = season.teams.length;
      peakSeasonLabel = season.label;
    }
  });

  document.getElementById('totalSeasons').textContent = totalSeasons;
  document.getElementById('totalTeams').textContent = totalTeams;
  document.getElementById('currentTeams').textContent = currentTeams;
  document.getElementById('peakSeason').textContent = peakSeasonLabel ? `${peakSeasonLabel} (${peakCount})` : '‚Äî';
}

// Initialize page
async function init() {
  await loadSeasonHistory();
  generateChart();
  generateLegend();
  generateTimeline();
  generateStats();
}

init();
</script>

<!-- Load navigation -->
<script type="module">
  import { NavigationComponent } from './nav-component.js';
  // Navigation auto-initializes on load!
</script>
<script src="mobile-enhancements.js"></script>

</body>
</html>
